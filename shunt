package.preload['shunt.compat'] = function(...)
-- [yue]: shunt/compat.yue
local _module_0 = { } -- shunt/compat.yue:1
local detect_host, HOST, LUA, compat_applied, apply_compat, test_compat -- shunt/compat.yue:1
detect_host = function() -- shunt/compat.yue:3
  if (collectgarbage ~= nil) then -- shunt/compat.yue:4
    return 'native' -- shunt/compat.yue:5
  else -- shunt/compat.yue:7
    return 'minecraft' -- shunt/compat.yue:7
  end -- shunt/compat.yue:4
end -- shunt/compat.yue:3
HOST = detect_host() -- shunt/compat.yue:8
_module_0["HOST"] = HOST -- shunt/compat.yue:8
LUA = 'luajit' -- shunt/compat.yue:9
_module_0["LUA"] = LUA -- shunt/compat.yue:9
compat_applied = false -- shunt/compat.yue:11
apply_compat = function() -- shunt/compat.yue:12
  compat_applied = true -- shunt/compat.yue:13
  local _obj_0 = table -- shunt/compat.yue:15
  if _obj_0.unpack == nil then -- shunt/compat.yue:15
    _obj_0.unpack = assert(unpack, 'internal error: cannot find unpack function') -- shunt/compat.yue:15
  end -- shunt/compat.yue:15
  local _obj_1 = os -- shunt/compat.yue:17
  if _obj_1.sleep == nil then -- shunt/compat.yue:17
    _obj_1.sleep = function(n_secs) -- shunt/compat.yue:17
      return os.execute("sleep " .. tostring(n_secs) .. "s") -- shunt/compat.yue:18
    end -- shunt/compat.yue:17
  end -- shunt/compat.yue:18
  local _obj_2 = os -- shunt/compat.yue:20
  if _obj_2.tmpname == nil then -- shunt/compat.yue:20
    _obj_2.tmpname = function() -- shunt/compat.yue:20
      while true do -- shunt/compat.yue:21
        local _continue_0 = false -- shunt/compat.yue:22
        repeat -- shunt/compat.yue:22
          local f = "lua_" .. tostring(('%x'):format(math.random(1, 100000))) -- shunt/compat.yue:22
          do -- shunt/compat.yue:23
            local _with_0 = io.open(f, 'r') -- shunt/compat.yue:23
            if _with_0 ~= nil then -- shunt/compat.yue:23
              _with_0:close() -- shunt/compat.yue:24
              _continue_0 = true -- shunt/compat.yue:25
              break -- shunt/compat.yue:25
            end -- shunt/compat.yue:23
          end -- shunt/compat.yue:23
          do -- shunt/compat.yue:26
            return f -- shunt/compat.yue:26
          end -- shunt/compat.yue:26
          _continue_0 = true -- shunt/compat.yue:22
        until true -- shunt/compat.yue:26
        if not _continue_0 then -- shunt/compat.yue:26
          break -- shunt/compat.yue:26
        end -- shunt/compat.yue:26
      end -- shunt/compat.yue:26
    end -- shunt/compat.yue:20
  end -- shunt/compat.yue:26
  local _obj_3 = os -- shunt/compat.yue:28
  if _obj_3.remove == nil then -- shunt/compat.yue:28
    _obj_3.remove = function(path) -- shunt/compat.yue:28
      return xpcall(function() -- shunt/compat.yue:29
        fs.delete(path) -- shunt/compat.yue:30
        return true -- shunt/compat.yue:31
      end, function(_) -- shunt/compat.yue:31
        return false -- shunt/compat.yue:33
      end) -- shunt/compat.yue:33
    end -- shunt/compat.yue:28
  end -- shunt/compat.yue:33
  local _obj_4 = os -- shunt/compat.yue:35
  if _obj_4.rename == nil then -- shunt/compat.yue:35
    _obj_4.rename = function(src, dest) -- shunt/compat.yue:35
      return fs.move(src, dest) -- shunt/compat.yue:36
    end -- shunt/compat.yue:35
  end -- shunt/compat.yue:36
  local _obj_5 = os -- shunt/compat.yue:38
  if _obj_5.exit == nil then -- shunt/compat.yue:38
    _obj_5.exit = function(code) -- shunt/compat.yue:38
      return error("EXIT(" .. tostring(code) .. ")") -- shunt/compat.yue:39
    end -- shunt/compat.yue:38
  end -- shunt/compat.yue:39
  if not (fs ~= nil) then -- shunt/compat.yue:41
    fs = { } -- shunt/compat.yue:42
  end -- shunt/compat.yue:41
  local _obj_6 = fs -- shunt/compat.yue:44
  if _obj_6.makeDir == nil then -- shunt/compat.yue:44
    _obj_6.makeDir = function(path) -- shunt/compat.yue:44
      return os.execute("mkdir -p '" .. tostring(path) .. "'") -- shunt/compat.yue:45
    end -- shunt/compat.yue:44
  end -- shunt/compat.yue:45
  local _obj_7 = fs -- shunt/compat.yue:47
  if _obj_7.getFreeSpace == nil then -- shunt/compat.yue:47
    _obj_7.getFreeSpace = function(path) -- shunt/compat.yue:47
      return 1000000 -- shunt/compat.yue:48
    end -- shunt/compat.yue:47
  end -- shunt/compat.yue:48
  local _obj_8 = fs -- shunt/compat.yue:50
  if _obj_8.getCapacity == nil then -- shunt/compat.yue:50
    _obj_8.getCapacity = function(path) -- shunt/compat.yue:50
      return 1000000 -- shunt/compat.yue:51
    end -- shunt/compat.yue:50
  end -- shunt/compat.yue:51
  local _obj_9 = fs -- shunt/compat.yue:53
  if _obj_9.list == nil then -- shunt/compat.yue:53
    _obj_9.list = function(dir) -- shunt/compat.yue:53
      assert((not dir:match("'")), "cannot list directory containing quote mark '" .. tostring(dir) .. "'") -- shunt/compat.yue:54
      local _with_0 = { } -- shunt/compat.yue:55
      local p = assert(io.popen("ls -1 '" .. tostring(dir) .. "'")) -- shunt/compat.yue:56
      local line = p:read('*l') -- shunt/compat.yue:57
      while (line ~= nil) do -- shunt/compat.yue:58
        _with_0[#_with_0 + 1] = line -- shunt/compat.yue:59
        line = p:read('*l') -- shunt/compat.yue:60
      end -- shunt/compat.yue:60
      p:close() -- shunt/compat.yue:61
      return _with_0 -- shunt/compat.yue:55
    end -- shunt/compat.yue:53
  end -- shunt/compat.yue:61
  if not (shell ~= nil) then -- shunt/compat.yue:63
    shell = { } -- shunt/compat.yue:64
  end -- shunt/compat.yue:63
  local _obj_10 = shell -- shunt/compat.yue:66
  if _obj_10.execute == nil then -- shunt/compat.yue:66
    _obj_10.execute = function(...) -- shunt/compat.yue:66
      for i = 1, select('#', ...) do -- shunt/compat.yue:67
        assert('string' == type(select(i, ...))) -- shunt/compat.yue:68
      end -- shunt/compat.yue:68
      local args -- shunt/compat.yue:70
      do -- shunt/compat.yue:70
        local _accum_0 = { } -- shunt/compat.yue:70
        local _len_0 = 1 -- shunt/compat.yue:70
        local _list_0 = { -- shunt/compat.yue:70
          LUA, -- shunt/compat.yue:70
          ... -- shunt/compat.yue:70
        } -- shunt/compat.yue:70
        for _index_0 = 1, #_list_0 do -- shunt/compat.yue:70
          local arg = _list_0[_index_0] -- shunt/compat.yue:70
          _accum_0[_len_0] = "'" .. tostring(arg) .. "'" -- shunt/compat.yue:70
          _len_0 = _len_0 + 1 -- shunt/compat.yue:70
        end -- shunt/compat.yue:70
        args = _accum_0 -- shunt/compat.yue:70
      end -- shunt/compat.yue:70
      local rc = os.execute(table.concat(args, ' ')) -- shunt/compat.yue:71
      return rc == 0 -- shunt/compat.yue:72
    end -- shunt/compat.yue:66
  end -- shunt/compat.yue:72
  local _obj_11 = bit -- shunt/compat.yue:74
  if _obj_11.blshift == nil then -- shunt/compat.yue:74
    _obj_11.blshift = bit.lshift -- shunt/compat.yue:74
  end -- shunt/compat.yue:74
  local _obj_12 = bit -- shunt/compat.yue:75
  if _obj_12.brshift == nil then -- shunt/compat.yue:75
    _obj_12.brshift = bit.rshift -- shunt/compat.yue:75
  end -- shunt/compat.yue:75
  if not (textutils ~= nil) then -- shunt/compat.yue:77
    textutils = { } -- shunt/compat.yue:78
  end -- shunt/compat.yue:77
  local is_list -- shunt/compat.yue:80
  is_list = function(t) -- shunt/compat.yue:80
    local max_key = -1 -- shunt/compat.yue:81
    for k, _ in pairs(t) do -- shunt/compat.yue:82
      if 'number' ~= type(k) then -- shunt/compat.yue:83
        return false -- shunt/compat.yue:84
      end -- shunt/compat.yue:83
      if k % 1 ~= 0 then -- shunt/compat.yue:85
        return false -- shunt/compat.yue:86
      end -- shunt/compat.yue:85
      if k > max_key then -- shunt/compat.yue:87
        max_key = k -- shunt/compat.yue:88
      end -- shunt/compat.yue:87
    end -- shunt/compat.yue:88
    return #t == max_key -- shunt/compat.yue:89
  end -- shunt/compat.yue:80
  local _obj_13 = textutils -- shunt/compat.yue:91
  if _obj_13.serialise == nil then -- shunt/compat.yue:91
    _obj_13.serialise = function(value, opts) -- shunt/compat.yue:91
      if not (opts ~= nil) then -- shunt/compat.yue:92
        error('textutils.serialise must be called with compact:true') -- shunt/compat.yue:93
      end -- shunt/compat.yue:92
      if opts.compact ~= true then -- shunt/compat.yue:94
        error('textutils.serialise must be called with compact:true') -- shunt/compat.yue:95
      end -- shunt/compat.yue:94
      if (opts.allow_repetitions ~= nil) then -- shunt/compat.yue:96
        error('textutils.serialise must not be called with allow_repetitions') -- shunt/compat.yue:97
      end -- shunt/compat.yue:96
      return table.concat((function() -- shunt/compat.yue:99
        local _with_0 = { } -- shunt/compat.yue:99
        local serialise -- shunt/compat.yue:100
        serialise = function(value) -- shunt/compat.yue:100
          local _exp_0 = type(value) -- shunt/compat.yue:101
          if 'nil' == _exp_0 then -- shunt/compat.yue:102
            _with_0[#_with_0 + 1] = 'null' -- shunt/compat.yue:103
          elseif 'boolean' == _exp_0 or 'number' == _exp_0 then -- shunt/compat.yue:104
            _with_0[#_with_0 + 1] = tostring(value) -- shunt/compat.yue:105
          elseif 'string' == _exp_0 then -- shunt/compat.yue:106
            _with_0[#_with_0 + 1] = '"' -- shunt/compat.yue:107
            _with_0[#_with_0 + 1] = value:gsub('"', '\\"') -- shunt/compat.yue:108
            _with_0[#_with_0 + 1] = '"' -- shunt/compat.yue:109
          elseif 'table' == _exp_0 then -- shunt/compat.yue:110
            if is_list(value) then -- shunt/compat.yue:111
              _with_0[#_with_0 + 1] = '[' -- shunt/compat.yue:112
              local first = true -- shunt/compat.yue:113
              for _index_0 = 1, #value do -- shunt/compat.yue:114
                local e = value[_index_0] -- shunt/compat.yue:114
                if first then -- shunt/compat.yue:115
                  first = false -- shunt/compat.yue:116
                else -- shunt/compat.yue:118
                  _with_0[#_with_0 + 1] = ',' -- shunt/compat.yue:118
                end -- shunt/compat.yue:115
                serialise(e) -- shunt/compat.yue:119
              end -- shunt/compat.yue:119
              _with_0[#_with_0 + 1] = ']' -- shunt/compat.yue:120
            else -- shunt/compat.yue:122
              _with_0[#_with_0 + 1] = '{' -- shunt/compat.yue:122
              local first = true -- shunt/compat.yue:123
              for k, v in pairs(value) do -- shunt/compat.yue:124
                if first then -- shunt/compat.yue:125
                  first = false -- shunt/compat.yue:126
                else -- shunt/compat.yue:128
                  _with_0[#_with_0 + 1] = ',' -- shunt/compat.yue:128
                end -- shunt/compat.yue:125
                serialise(k) -- shunt/compat.yue:129
                _with_0[#_with_0 + 1] = ':' -- shunt/compat.yue:130
                serialise(v) -- shunt/compat.yue:131
              end -- shunt/compat.yue:131
              _with_0[#_with_0 + 1] = '}' -- shunt/compat.yue:132
            end -- shunt/compat.yue:111
          else -- shunt/compat.yue:134
            return error("cannot serialise a " .. tostring(type(value)) .. " as json") -- shunt/compat.yue:134
          end -- shunt/compat.yue:134
        end -- shunt/compat.yue:100
        serialise(value) -- shunt/compat.yue:135
        return _with_0 -- shunt/compat.yue:99
      end)()) -- shunt/compat.yue:135
    end -- shunt/compat.yue:91
  end -- shunt/compat.yue:135
  local _obj_14 = textutils -- shunt/compat.yue:137
  if _obj_14.deserialise == nil then -- shunt/compat.yue:137
    _obj_14.deserialise = function(raw) -- shunt/compat.yue:137
      local index = 1 -- shunt/compat.yue:138
      local deserialise -- shunt/compat.yue:139
      deserialise = function() -- shunt/compat.yue:139
        do -- shunt/compat.yue:140
          local token = raw:match('^null', index) -- shunt/compat.yue:140
          if token then -- shunt/compat.yue:140
            index = index + (#token) -- shunt/compat.yue:141
            return nil -- shunt/compat.yue:142
          else -- shunt/compat.yue:143
            token = raw:match('^true', index) -- shunt/compat.yue:143
            if token then -- shunt/compat.yue:143
              index = index + (#token) -- shunt/compat.yue:144
              return true -- shunt/compat.yue:145
            else -- shunt/compat.yue:146
              token = raw:match('^false', index) -- shunt/compat.yue:146
              if token then -- shunt/compat.yue:146
                index = index + (#token) -- shunt/compat.yue:147
                return false -- shunt/compat.yue:148
              else -- shunt/compat.yue:149
                do -- shunt/compat.yue:149
                  local number = raw:match('^[0-9]+%.[0-9]+', index) -- shunt/compat.yue:149
                  if number then -- shunt/compat.yue:149
                    index = index + (#number) -- shunt/compat.yue:150
                    return tonumber(number) -- shunt/compat.yue:151
                  else -- shunt/compat.yue:152
                    number = raw:match('^[0-9]+', index) -- shunt/compat.yue:152
                    if number then -- shunt/compat.yue:152
                      index = index + (#number) -- shunt/compat.yue:153
                      return tonumber(number) -- shunt/compat.yue:154
                    else -- shunt/compat.yue:155
                      do -- shunt/compat.yue:155
                        local string = raw:match('^"([^"]*)"', index) -- shunt/compat.yue:155
                        if string then -- shunt/compat.yue:155
                          index = index + (2 + #string) -- shunt/compat.yue:156
                          return string -- shunt/compat.yue:157
                        else -- shunt/compat.yue:158
                          token = raw:match('^%[', index) -- shunt/compat.yue:158
                          if token then -- shunt/compat.yue:158
                            index = index + 1 -- shunt/compat.yue:159
                            local _with_0 = { } -- shunt/compat.yue:160
                            local first = true -- shunt/compat.yue:161
                            while not raw:match('^]', index) do -- shunt/compat.yue:162
                              if first then -- shunt/compat.yue:163
                                first = false -- shunt/compat.yue:164
                              else -- shunt/compat.yue:165
                                if raw:match('^,', index) then -- shunt/compat.yue:165
                                  index = index + 1 -- shunt/compat.yue:166
                                else -- shunt/compat.yue:168
                                  error("expected `,` at position " .. tostring(index)) -- shunt/compat.yue:168
                                end -- shunt/compat.yue:165
                              end -- shunt/compat.yue:163
                              _with_0[#_with_0 + 1] = deserialise() -- shunt/compat.yue:169
                            end -- shunt/compat.yue:169
                            index = index + 1 -- shunt/compat.yue:170
                            return _with_0 -- shunt/compat.yue:160
                          else -- shunt/compat.yue:171
                            if raw:match('^{', index) then -- shunt/compat.yue:171
                              local _with_0 = { } -- shunt/compat.yue:172
                              index = index + 1 -- shunt/compat.yue:173
                              local first = true -- shunt/compat.yue:174
                              while not raw:match('^}', index) do -- shunt/compat.yue:175
                                if first then -- shunt/compat.yue:176
                                  first = false -- shunt/compat.yue:177
                                else -- shunt/compat.yue:178
                                  if raw:match('^,', index) then -- shunt/compat.yue:178
                                    index = index + 1 -- shunt/compat.yue:179
                                  else -- shunt/compat.yue:181
                                    error("expected `,` at position " .. tostring(index)) -- shunt/compat.yue:181
                                  end -- shunt/compat.yue:178
                                end -- shunt/compat.yue:176
                                local key = deserialise() -- shunt/compat.yue:183
                                if raw:match('^:', index) then -- shunt/compat.yue:184
                                  index = index + 1 -- shunt/compat.yue:185
                                else -- shunt/compat.yue:187
                                  error("expected `:` at position " .. tostring(index)) -- shunt/compat.yue:187
                                end -- shunt/compat.yue:184
                                _with_0[key] = deserialise() -- shunt/compat.yue:188
                              end -- shunt/compat.yue:188
                              index = index + 1 -- shunt/compat.yue:189
                              return _with_0 -- shunt/compat.yue:172
                            else -- shunt/compat.yue:191
                              return error("unexpected character " .. tostring(raw:sub(index, index)) .. " at " .. tostring(index)) -- shunt/compat.yue:191
                            end -- shunt/compat.yue:171
                          end -- shunt/compat.yue:158
                        end -- shunt/compat.yue:155
                      end -- shunt/compat.yue:155
                    end -- shunt/compat.yue:152
                  end -- shunt/compat.yue:149
                end -- shunt/compat.yue:149
              end -- shunt/compat.yue:146
            end -- shunt/compat.yue:143
          end -- shunt/compat.yue:140
        end -- shunt/compat.yue:140
      end -- shunt/compat.yue:139
      local ret = deserialise() -- shunt/compat.yue:192
      if #raw ~= index - 1 then -- shunt/compat.yue:193
        error("deserialisation ended early (parsed " .. tostring(index) .. " of " .. tostring(#raw) .. ")") -- shunt/compat.yue:194
      end -- shunt/compat.yue:193
      return ret -- shunt/compat.yue:195
    end -- shunt/compat.yue:137
  end -- shunt/compat.yue:195
end -- shunt/compat.yue:12
_module_0["apply_compat"] = apply_compat -- shunt/compat.yue:195
test_compat = function() -- shunt/compat.yue:197
  if not compat_applied then -- shunt/compat.yue:198
    error('call apply_compat before testing compat') -- shunt/compat.yue:199
  end -- shunt/compat.yue:198
  local tests = { -- shunt/compat.yue:201
    { -- shunt/compat.yue:201
      name = 'os.tmpname returns a string', -- shunt/compat.yue:201
      check = function() -- shunt/compat.yue:202
        return assert('string' == type(os.tmpname())) -- shunt/compat.yue:203
      end -- shunt/compat.yue:202
    }, -- shunt/compat.yue:201
    { -- shunt/compat.yue:204
      name = 'os.remove removes files', -- shunt/compat.yue:204
      check = function() -- shunt/compat.yue:205
        local TEST_FILE = '.test_file_hj4k3h5jio' -- shunt/compat.yue:206
        do -- shunt/compat.yue:207
          local _with_0 = io.open(TEST_FILE, 'r') -- shunt/compat.yue:207
          if _with_0 ~= nil then -- shunt/compat.yue:207
            _with_0:close() -- shunt/compat.yue:208
            error("test file '" .. tostring(TEST_FILE) .. "' already exists, please remove it") -- shunt/compat.yue:209
          end -- shunt/compat.yue:207
        end -- shunt/compat.yue:207
        do -- shunt/compat.yue:210
          local _with_0 = assert(io.open(TEST_FILE, 'w+')) -- shunt/compat.yue:210
          _with_0:close() -- shunt/compat.yue:211
        end -- shunt/compat.yue:210
        do -- shunt/compat.yue:212
          local _with_0 = assert(io.open(TEST_FILE, 'r')) -- shunt/compat.yue:212
          _with_0:close() -- shunt/compat.yue:213
        end -- shunt/compat.yue:212
        os.remove(TEST_FILE) -- shunt/compat.yue:214
        local _with_0 = io.open(TEST_FILE, 'r') -- shunt/compat.yue:215
        if _with_0 ~= nil then -- shunt/compat.yue:215
          _with_0:close() -- shunt/compat.yue:216
          error("expected test file '" .. tostring(TEST_FILE) .. "' to have been removed after calling os.remove") -- shunt/compat.yue:217
        end -- shunt/compat.yue:215
        return _with_0 -- shunt/compat.yue:215
      end -- shunt/compat.yue:205
    }, -- shunt/compat.yue:204
    { -- shunt/compat.yue:218
      name = 'HOST is unchanged', -- shunt/compat.yue:218
      check = function() -- shunt/compat.yue:219
        local host = detect_host() -- shunt/compat.yue:220
        if HOST ~= host then -- shunt/compat.yue:221
          return error("host detection heuristic changed") -- shunt/compat.yue:222
        end -- shunt/compat.yue:221
      end -- shunt/compat.yue:219
    }, -- shunt/compat.yue:218
    { -- shunt/compat.yue:223
      name = 'json roundtrip', -- shunt/compat.yue:223
      check = function() -- shunt/compat.yue:224
        local case -- shunt/compat.yue:225
        case = function(value, check) -- shunt/compat.yue:225
          if check == nil then -- shunt/compat.yue:226
            check = function(v) -- shunt/compat.yue:226
              return assert(v == value, "expected " .. tostring(value) .. " but got " .. tostring(v)) -- shunt/compat.yue:227
            end -- shunt/compat.yue:226
          end -- shunt/compat.yue:227
          return check(textutils.deserialise(textutils.serialise(value, { -- shunt/compat.yue:228
            compact = true -- shunt/compat.yue:228
          }))) -- shunt/compat.yue:228
        end -- shunt/compat.yue:225
        case(nil) -- shunt/compat.yue:229
        case({ -- shunt/compat.yue:230
          '123', -- shunt/compat.yue:230
          '321' -- shunt/compat.yue:230
        }, function(v) -- shunt/compat.yue:230
          assert(v[1] == '123', "v[1] incorrect: " .. tostring(v[1])) -- shunt/compat.yue:231
          return assert(v[2] == '321', "v[2] incorrect: " .. tostring(v[2])) -- shunt/compat.yue:232
        end) -- shunt/compat.yue:230
        return case({ -- shunt/compat.yue:234
          world = 'how', -- shunt/compat.yue:234
          ['hell\\o'] = 123, -- shunt/compat.yue:235
          are = true, -- shunt/compat.yue:236
          you = false -- shunt/compat.yue:237
        }, function(v) -- shunt/compat.yue:238
          assert(v.world == 'how', "v.world incorrect: " .. tostring(v.world)) -- shunt/compat.yue:239
          assert(v['hell\\o'] == 123, "v.hello incorrect: " .. tostring(v['hell\\o'])) -- shunt/compat.yue:240
          assert(v.are == true, "v.are incorrect: " .. tostring(v.are)) -- shunt/compat.yue:241
          return assert(v.you == false, "v.you incorrect: " .. tostring(v.you)) -- shunt/compat.yue:242
        end) -- shunt/compat.yue:242
      end -- shunt/compat.yue:224
    } -- shunt/compat.yue:223
  } -- shunt/compat.yue:200
  local failed = false -- shunt/compat.yue:243
  for _index_0 = 1, #tests do -- shunt/compat.yue:244
    local test = tests[_index_0] -- shunt/compat.yue:244
xpcall(function() -- shunt/compat.yue:245
      return test.check() -- shunt/compat.yue:246
    end, function(err) -- shunt/compat.yue:246
      print("* test '" .. tostring(test.name) .. "' failed:\n  " .. tostring(err)) -- shunt/compat.yue:248
      failed = true -- shunt/compat.yue:249
    end) -- shunt/compat.yue:249
  end -- shunt/compat.yue:249
  if failed then -- shunt/compat.yue:250
    return error('some compatibility checks failed') -- shunt/compat.yue:251
  end -- shunt/compat.yue:250
end -- shunt/compat.yue:197
_module_0["test_compat"] = test_compat -- shunt/compat.yue:251
return _module_0 -- shunt/compat.yue:251
end
package.preload['shunt.quicktype'] = function(...)
-- [yue]: shunt/quicktype.yue
local _module_0 = { } -- shunt/quicktype.yue:1
local T, t_impl, is, COLLECT_STATS, type_checkers, type_checker, F, function_types, function_type, is_valid_type_spec, parse, contains, TypeSpecParser, T_PAREN_OPEN, T_PAREN_CLOSE, T_BRACE_OPEN, T_BRACE_CLOSE, T_BRACKET_OPEN, T_BRACKET_CLOSE, T_ANGLE_OPEN, T_ANGLE_CLOSE, T_TILDE, T_COMMA, T_COLON, T_BANG, T_THIN_ARROW, T_FAT_ARROW, T_DOTDOTDOT, T_QUESTION, T_PLUS, T_PIPE, T_NAME, T_PREFIXED_NAME, T_BOOLEAN, T_NUMBER, T_STRING, Lexer, Checkpoint, known_primitives, named_type, prefixed_named_type, Is, Primitive, Any, Some, Never, UserType, SingletonType, BooleanType, NumberType, StringType, Optional, Array, Tuple, Struct, Field, Set, Mapping, Function, Method, Remainder, Disjunction, Conjunction, CheckerBuilder, Label, C_PUSH, C_PUSH_METATABLE, C_POP, C_ASSERT_NON_NIL, C_ASSERT_PRIMITIVE, C_ASSERT_TABLE_LIKE, C_ASSERT_TRUTHY, C_ASSERT_LEN, C_ASSERT_EQ, C_ASSERT_NEVER, C_GET_FIELD, C_INCR, C_DECR, C_NEXT, C_JMP, C_JMP_IF_NIL, C_PUSH_CHECKER, C_PUSH_UNION_CTX, C_CLEAR_BAILING, C_SET_UNION_BAIL_TARGET, C_POP_UNION_CTX, V_NIL, checker_program_repr, LABEL_PLACEHOLDER, MAX_CHECKER_DEPTH, stack_size, stack, keys_used, num_unions, union_depths, union_bail_jumps, root_union, num_running_checkers, instruction_counts, check, user_types, declare_type, declare_singleton_type, skip_typechecking, deactivate_typechecks, stats -- shunt/quicktype.yue:1
local Symbol -- shunt/quicktype.yue:2
local repr, spec -- shunt/quicktype.yue:0
do -- shunt/quicktype.yue:0
  local _obj_0 = require('shunt.spec') -- shunt/quicktype.yue:0
  repr, spec = _obj_0.repr, _obj_0.spec -- shunt/quicktype.yue:0
end -- shunt/quicktype.yue:0
T = function(type_spec, value) -- shunt/quicktype.yue:6
  if skip_typechecking then -- shunt/quicktype.yue:7
    return -- shunt/quicktype.yue:8
  end -- shunt/quicktype.yue:7
  return t_impl(type_spec, value) -- shunt/quicktype.yue:9
end -- shunt/quicktype.yue:6
_module_0["T"] = T -- shunt/quicktype.yue:9
t_impl = function(type_spec, value) -- shunt/quicktype.yue:11
  if not (type_spec ~= nil) then -- shunt/quicktype.yue:12
    error('cannot typecheck: no type spec provided') -- shunt/quicktype.yue:13
  end -- shunt/quicktype.yue:12
  local checker = type_checker(type_spec) -- shunt/quicktype.yue:15
  local err = check(checker, value) -- shunt/quicktype.yue:16
  if (err ~= nil) then -- shunt/quicktype.yue:17
    error(err, 2) -- shunt/quicktype.yue:18
  end -- shunt/quicktype.yue:17
  return value -- shunt/quicktype.yue:19
end -- shunt/quicktype.yue:11
is = function(type_spec, value) -- shunt/quicktype.yue:21
  if not (type_spec ~= nil) then -- shunt/quicktype.yue:22
    error('cannot typecheck: no type spec provided') -- shunt/quicktype.yue:23
  end -- shunt/quicktype.yue:22
  local err -- shunt/quicktype.yue:25
xpcall(function() -- shunt/quicktype.yue:26
    return T(type_spec, value) -- shunt/quicktype.yue:27
  end, function(err2) -- shunt/quicktype.yue:27
    err = err2 -- shunt/quicktype.yue:29
  end) -- shunt/quicktype.yue:29
  return not (err ~= nil), err -- shunt/quicktype.yue:30
end -- shunt/quicktype.yue:21
_module_0["is"] = is -- shunt/quicktype.yue:30
COLLECT_STATS = false -- shunt/quicktype.yue:37
_module_0["COLLECT_STATS"] = COLLECT_STATS -- shunt/quicktype.yue:37
type_checkers = { } -- shunt/quicktype.yue:39
type_checker = function(type_spec) -- shunt/quicktype.yue:40
  local _exp_0 = type_checkers[type_spec] -- shunt/quicktype.yue:41
  if _exp_0 ~= nil then -- shunt/quicktype.yue:41
    return _exp_0 -- shunt/quicktype.yue:41
  else -- shunt/quicktype.yue:41
    do -- shunt/quicktype.yue:41
      local checker = (parse(type_spec)):checker():build() -- shunt/quicktype.yue:43
      type_checkers[type_spec] = checker -- shunt/quicktype.yue:45
      return checker -- shunt/quicktype.yue:46
    end -- shunt/quicktype.yue:46
  end -- shunt/quicktype.yue:41
end -- shunt/quicktype.yue:40
F = function(type_spec, fn) -- shunt/quicktype.yue:48
  if skip_typechecking then -- shunt/quicktype.yue:49
    return -- shunt/quicktype.yue:50
  end -- shunt/quicktype.yue:49
  if not (type_spec ~= nil) then -- shunt/quicktype.yue:51
    error('cannot typecheck: no type spec provided') -- shunt/quicktype.yue:52
  end -- shunt/quicktype.yue:51
  if 'function' ~= type(fn) then -- shunt/quicktype.yue:53
    error('cannot typecheck: no function provided') -- shunt/quicktype.yue:54
  end -- shunt/quicktype.yue:53
  local fn_type = function_type(type_spec) -- shunt/quicktype.yue:56
  local return_types = fn_type:return_checkers() -- shunt/quicktype.yue:58
  local n_return_types = #return_types -- shunt/quicktype.yue:59
  local check_returns -- shunt/quicktype.yue:60
  check_returns = function(...) -- shunt/quicktype.yue:60
    for i = 1, n_return_types do -- shunt/quicktype.yue:61
      local err = check(return_types[i], select(i, ...)) -- shunt/quicktype.yue:62
      if (err ~= nil) then -- shunt/quicktype.yue:63
        error("return value " .. tostring(i) .. " incorrect: " .. tostring(err) .. " (checking " .. tostring(fn_type) .. ")", 2) -- shunt/quicktype.yue:64
      end -- shunt/quicktype.yue:63
    end -- shunt/quicktype.yue:64
    for i = n_return_types + 1, (select('#', ...)) do -- shunt/quicktype.yue:65
      local checker = return_types[i] -- shunt/quicktype.yue:66
      if not (checker ~= nil) then -- shunt/quicktype.yue:67
        error("function returned too many values: expected " .. tostring(n_return_types) .. " but got " .. tostring(select('#', ...)) .. " (checking " .. tostring(fn_type) .. ")", 2) -- shunt/quicktype.yue:68
      end -- shunt/quicktype.yue:67
      local err = check(checker, (select(i, ...))) -- shunt/quicktype.yue:69
      if (err ~= nil) then -- shunt/quicktype.yue:70
        error("return value " .. tostring(i) .. " incorrect: " .. tostring(err) .. " (checking " .. tostring(fn_type) .. ")", 2) -- shunt/quicktype.yue:71
      end -- shunt/quicktype.yue:70
    end -- shunt/quicktype.yue:71
    return ... -- shunt/quicktype.yue:72
  end -- shunt/quicktype.yue:60
  local param_types = fn_type:param_checkers() -- shunt/quicktype.yue:74
  local n_param_types = #param_types -- shunt/quicktype.yue:75
  return function(...) -- shunt/quicktype.yue:76
    if skip_typechecking then -- shunt/quicktype.yue:77
      return fn(...) -- shunt/quicktype.yue:78
    end -- shunt/quicktype.yue:77
    for i = 1, n_param_types do -- shunt/quicktype.yue:80
      local err = check(param_types[i], (select(i, ...))) -- shunt/quicktype.yue:81
      if (err ~= nil) then -- shunt/quicktype.yue:82
        error("argument " .. tostring(i) .. " incorrect: " .. tostring(err) .. " (checking " .. tostring(fn_type) .. ")", 3) -- shunt/quicktype.yue:83
      end -- shunt/quicktype.yue:82
    end -- shunt/quicktype.yue:83
    for i = n_param_types + 1, select('#', ...) do -- shunt/quicktype.yue:84
      local checker = param_types[i] -- shunt/quicktype.yue:85
      if not (checker ~= nil) then -- shunt/quicktype.yue:86
        error("function given too many arguments: expected " .. tostring(n_param_types) .. " but got " .. tostring(select('#', ...)) .. " (checking " .. tostring(fn_type) .. ")", 3) -- shunt/quicktype.yue:87
      end -- shunt/quicktype.yue:86
      local err = check(checker, (select(i, ...))) -- shunt/quicktype.yue:88
      if (err ~= nil) then -- shunt/quicktype.yue:89
        error("argument " .. tostring(i) .. " incorrect: " .. tostring(err) .. " (checking " .. tostring(fn_type) .. ")", 3) -- shunt/quicktype.yue:90
      end -- shunt/quicktype.yue:89
    end -- shunt/quicktype.yue:90
    return check_returns(fn(...)) -- shunt/quicktype.yue:92
  end -- shunt/quicktype.yue:92
end -- shunt/quicktype.yue:48
_module_0["F"] = F -- shunt/quicktype.yue:92
function_types = { } -- shunt/quicktype.yue:94
function_type = function(type_spec) -- shunt/quicktype.yue:95
  local _exp_0 = function_types[type_spec] -- shunt/quicktype.yue:96
  if _exp_0 ~= nil then -- shunt/quicktype.yue:96
    return _exp_0 -- shunt/quicktype.yue:96
  else -- shunt/quicktype.yue:96
    do -- shunt/quicktype.yue:96
      local parsed_type = parse(type_spec) -- shunt/quicktype.yue:98
      if not (parsed_type:is(Function)) and not parsed_type:is(Method) then -- shunt/quicktype.yue:99
        error("cannot typecheck: expected a function type") -- shunt/quicktype.yue:100
      end -- shunt/quicktype.yue:99
      function_types[type_spec] = parsed_type -- shunt/quicktype.yue:102
      return parsed_type -- shunt/quicktype.yue:103
    end -- shunt/quicktype.yue:103
  end -- shunt/quicktype.yue:96
end -- shunt/quicktype.yue:95
is_valid_type_spec = function(type_spec) -- shunt/quicktype.yue:105
  local ret = true -- shunt/quicktype.yue:106
xpcall(function() -- shunt/quicktype.yue:107
    return parse(type_spec) -- shunt/quicktype.yue:108
  end, function(_) -- shunt/quicktype.yue:108
    ret = false -- shunt/quicktype.yue:110
  end) -- shunt/quicktype.yue:110
  return ret -- shunt/quicktype.yue:111
end -- shunt/quicktype.yue:105
_module_0["is_valid_type_spec"] = is_valid_type_spec -- shunt/quicktype.yue:111
parse = function(type_spec) -- shunt/quicktype.yue:113
  local type_spec_parser = TypeSpecParser(Lexer(type_spec)) -- shunt/quicktype.yue:114
  return type_spec_parser:parse() -- shunt/quicktype.yue:115
end -- shunt/quicktype.yue:113
local Parser -- shunt/quicktype.yue:117
do -- shunt/quicktype.yue:117
  local _class_0 -- shunt/quicktype.yue:117
  local _base_0 = { -- shunt/quicktype.yue:117
    parse = function(self) -- shunt/quicktype.yue:119
      return error('unimplemented') -- shunt/quicktype.yue:120
    end, -- shunt/quicktype.yue:122
    parse_repeat_separated = function(self, elem_parser, sep_token, opts) -- shunt/quicktype.yue:122
      if opts == nil then -- shunt/quicktype.yue:122
        opts = { } -- shunt/quicktype.yue:122
      end -- shunt/quicktype.yue:122
      local separator_trails_before, allow_repeated_separator = opts.separator_trails_before, opts.allow_repeated_separator -- shunt/quicktype.yue:123
      if not (separator_trails_before ~= nil) or 'table' ~= type(separator_trails_before[1]) then -- shunt/quicktype.yue:127
        separator_trails_before = { -- shunt/quicktype.yue:128
          separator_trails_before -- shunt/quicktype.yue:128
        } -- shunt/quicktype.yue:128
      end -- shunt/quicktype.yue:127
      local _with_0 = { } -- shunt/quicktype.yue:130
      _with_0[#_with_0 + 1] = elem_parser() -- shunt/quicktype.yue:131
      local tok = self.lexer:peek() -- shunt/quicktype.yue:132
      while (tok ~= nil) and tok.type == sep_token do -- shunt/quicktype.yue:133
        self.lexer:next() -- shunt/quicktype.yue:134
        if allow_repeated_separator then -- shunt/quicktype.yue:135
          self:ignore_any(sep_token) -- shunt/quicktype.yue:136
        end -- shunt/quicktype.yue:135
        tok = self.lexer:peek() -- shunt/quicktype.yue:137
        if (tok ~= nil) and contains(tok.type, separator_trails_before) then -- shunt/quicktype.yue:138
          break -- shunt/quicktype.yue:139
        end -- shunt/quicktype.yue:138
        _with_0[#_with_0 + 1] = elem_parser() -- shunt/quicktype.yue:141
        tok = self.lexer:peek() -- shunt/quicktype.yue:142
      end -- shunt/quicktype.yue:142
      return _with_0 -- shunt/quicktype.yue:130
    end, -- shunt/quicktype.yue:144
    repeat_until = function(self, elem_parser, until_tok) -- shunt/quicktype.yue:144
      local _with_0 = { } -- shunt/quicktype.yue:145
      while self.lexer:peek().type ~= until_tok do -- shunt/quicktype.yue:146
        _with_0[#_with_0 + 1] = elem_parser() -- shunt/quicktype.yue:147
      end -- shunt/quicktype.yue:147
      return _with_0 -- shunt/quicktype.yue:145
    end, -- shunt/quicktype.yue:149
    expect = function(self, expected_token) -- shunt/quicktype.yue:149
      local token = self.lexer:next() -- shunt/quicktype.yue:150
      if not (token ~= nil) then -- shunt/quicktype.yue:151
        error("unexpected EOF") -- shunt/quicktype.yue:152
      end -- shunt/quicktype.yue:151
      if token.type ~= expected_token then -- shunt/quicktype.yue:153
        error("expected " .. tostring(expected_token) .. ", got " .. tostring(token)) -- shunt/quicktype.yue:154
      end -- shunt/quicktype.yue:153
      local _exp_0 = token.value -- shunt/quicktype.yue:155
      if _exp_0 ~= nil then -- shunt/quicktype.yue:155
        return _exp_0 -- shunt/quicktype.yue:155
      else -- shunt/quicktype.yue:155
        return token.type -- shunt/quicktype.yue:155
      end -- shunt/quicktype.yue:155
    end, -- shunt/quicktype.yue:157
    ignore_any = function(self, expected_token) -- shunt/quicktype.yue:157
      local next_token = self.lexer:peek() -- shunt/quicktype.yue:158
      while (next_token ~= nil) and next_token.type == expected_token do -- shunt/quicktype.yue:159
        self:expect(expected_token) -- shunt/quicktype.yue:160
        next_token = self.lexer:peek() -- shunt/quicktype.yue:161
      end -- shunt/quicktype.yue:161
    end, -- shunt/quicktype.yue:163
    maybe = function(self, expected_token) -- shunt/quicktype.yue:163
      local token = self.lexer:peek() -- shunt/quicktype.yue:164
      if not (token ~= nil) then -- shunt/quicktype.yue:165
        return nil -- shunt/quicktype.yue:166
      end -- shunt/quicktype.yue:165
      if token.type ~= expected_token then -- shunt/quicktype.yue:167
        return nil -- shunt/quicktype.yue:168
      end -- shunt/quicktype.yue:167
      self.lexer:next() -- shunt/quicktype.yue:169
      local _exp_0 = token.value -- shunt/quicktype.yue:170
      if _exp_0 ~= nil then -- shunt/quicktype.yue:170
        return _exp_0 -- shunt/quicktype.yue:170
      else -- shunt/quicktype.yue:170
        return token.type -- shunt/quicktype.yue:170
      end -- shunt/quicktype.yue:170
    end, -- shunt/quicktype.yue:172
    select = function(self, options) -- shunt/quicktype.yue:172
      local next_token = self.lexer:peek() -- shunt/quicktype.yue:173
      if not (next_token ~= nil) then -- shunt/quicktype.yue:174
        error("unexpected EOF") -- shunt/quicktype.yue:175
      end -- shunt/quicktype.yue:174
      local i = 1 -- shunt/quicktype.yue:177
      while options[i] do -- shunt/quicktype.yue:178
        local option = options[i] -- shunt/quicktype.yue:179
        if option.token == next_token.type then -- shunt/quicktype.yue:180
          do -- shunt/quicktype.yue:181
            local action = option.action -- shunt/quicktype.yue:181
            if action then -- shunt/quicktype.yue:181
              return action() -- shunt/quicktype.yue:182
            else -- shunt/quicktype.yue:184
              return self:expect(option.token) -- shunt/quicktype.yue:184
            end -- shunt/quicktype.yue:181
          end -- shunt/quicktype.yue:181
        end -- shunt/quicktype.yue:180
        i = i + 1 -- shunt/quicktype.yue:185
      end -- shunt/quicktype.yue:185
      if (options.otherwise ~= nil) then -- shunt/quicktype.yue:187
        return options.otherwise() -- shunt/quicktype.yue:188
      end -- shunt/quicktype.yue:187
      local options_repr = table.concat((function() -- shunt/quicktype.yue:190
        local _accum_0 = { } -- shunt/quicktype.yue:190
        local _len_0 = 1 -- shunt/quicktype.yue:190
        for _index_0 = 1, #options do -- shunt/quicktype.yue:190
          local option = options[_index_0] -- shunt/quicktype.yue:190
          _accum_0[_len_0] = tostring(option.token) -- shunt/quicktype.yue:190
          _len_0 = _len_0 + 1 -- shunt/quicktype.yue:190
        end -- shunt/quicktype.yue:190
        return _accum_0 -- shunt/quicktype.yue:190
      end)(), ', ') -- shunt/quicktype.yue:190
      return error("expected one of " .. tostring(options_repr) .. ", got " .. tostring(next_token.type)) -- shunt/quicktype.yue:191
    end, -- shunt/quicktype.yue:193
    sequence = function(self, expected_tokens) -- shunt/quicktype.yue:193
      local _with_0 = { } -- shunt/quicktype.yue:194
      for _index_0 = 1, #expected_tokens do -- shunt/quicktype.yue:195
        local _des_0 = expected_tokens[_index_0] -- shunt/quicktype.yue:195
        local expected_token, action = _des_0.token, _des_0.action -- shunt/quicktype.yue:195
        if (expected_token ~= nil) then -- shunt/quicktype.yue:196
          local token = self.lexer:next() -- shunt/quicktype.yue:197
          if not (token ~= nil) then -- shunt/quicktype.yue:198
            error("unexpected EOF") -- shunt/quicktype.yue:199
          end -- shunt/quicktype.yue:198
          if token.type ~= expected_token then -- shunt/quicktype.yue:200
            error("expected " .. tostring(expected_token) .. ", got " .. tostring(token.type)) -- shunt/quicktype.yue:201
          end -- shunt/quicktype.yue:200
          do -- shunt/quicktype.yue:202
            local _exp_0 = token.value -- shunt/quicktype.yue:202
            if _exp_0 ~= nil then -- shunt/quicktype.yue:202
              _with_0[#_with_0 + 1] = _exp_0 -- shunt/quicktype.yue:202
            else -- shunt/quicktype.yue:202
              _with_0[#_with_0 + 1] = 0 -- shunt/quicktype.yue:202
            end -- shunt/quicktype.yue:202
          end -- shunt/quicktype.yue:202
        else -- shunt/quicktype.yue:203
          if (action ~= nil) then -- shunt/quicktype.yue:203
            _with_0[#_with_0 + 1] = action() -- shunt/quicktype.yue:204
          else -- shunt/quicktype.yue:206
            error("sequence element must have expected_token or action") -- shunt/quicktype.yue:206
          end -- shunt/quicktype.yue:203
        end -- shunt/quicktype.yue:196
      end -- shunt/quicktype.yue:206
      return _with_0 -- shunt/quicktype.yue:194
    end -- shunt/quicktype.yue:117
  } -- shunt/quicktype.yue:117
  if _base_0.__index == nil then -- shunt/quicktype.yue:117
    _base_0.__index = _base_0 -- shunt/quicktype.yue:117
  end -- shunt/quicktype.yue:206
  _class_0 = setmetatable({ -- shunt/quicktype.yue:117
    __init = function(self, lexer) -- shunt/quicktype.yue:118
      self.lexer = lexer -- shunt/quicktype.yue:118
    end, -- shunt/quicktype.yue:117
    __base = _base_0, -- shunt/quicktype.yue:117
    __name = "Parser" -- shunt/quicktype.yue:117
  }, { -- shunt/quicktype.yue:117
    __index = _base_0, -- shunt/quicktype.yue:117
    __call = function(cls, ...) -- shunt/quicktype.yue:117
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:117
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:117
      return _self_0 -- shunt/quicktype.yue:117
    end -- shunt/quicktype.yue:117
  }) -- shunt/quicktype.yue:117
  _base_0.__class = _class_0 -- shunt/quicktype.yue:117
  Parser = _class_0 -- shunt/quicktype.yue:117
end -- shunt/quicktype.yue:206
_module_0["Parser"] = Parser -- shunt/quicktype.yue:117
contains = function(needle, haystack) -- shunt/quicktype.yue:208
  for _index_0 = 1, #haystack do -- shunt/quicktype.yue:209
    local elem = haystack[_index_0] -- shunt/quicktype.yue:209
    if needle == elem then -- shunt/quicktype.yue:210
      return true -- shunt/quicktype.yue:211
    end -- shunt/quicktype.yue:210
  end -- shunt/quicktype.yue:211
  return false -- shunt/quicktype.yue:212
end -- shunt/quicktype.yue:208
do -- shunt/quicktype.yue:214
  local _class_0 -- shunt/quicktype.yue:214
  local _parent_0 = Parser -- shunt/quicktype.yue:214
  local _base_0 = { -- shunt/quicktype.yue:214
    parse = function(self) -- shunt/quicktype.yue:215
      local ret = self:parse_type() -- shunt/quicktype.yue:216
      if self.lexer:peek() then -- shunt/quicktype.yue:217
        error("type spec has trailing characters: '" .. tostring(self.lexer.type_spec) .. "'") -- shunt/quicktype.yue:218
      end -- shunt/quicktype.yue:217
      return ret -- shunt/quicktype.yue:219
    end, -- shunt/quicktype.yue:221
    parse_type = function(self) -- shunt/quicktype.yue:221
      if self:maybe(T_BANG) then -- shunt/quicktype.yue:222
        return Never() -- shunt/quicktype.yue:223
      end -- shunt/quicktype.yue:222
      return self:parse_type_disjunction() -- shunt/quicktype.yue:225
    end, -- shunt/quicktype.yue:227
    parse_type_disjunction = function(self) -- shunt/quicktype.yue:227
      local disjunction = self:parse_repeat_separated((function() -- shunt/quicktype.yue:228
        local _base_1 = self -- shunt/quicktype.yue:228
        local _fn_0 = _base_1.parse_type_conjunction -- shunt/quicktype.yue:228
        return _fn_0 and function(...) -- shunt/quicktype.yue:228
          return _fn_0(_base_1, ...) -- shunt/quicktype.yue:228
        end -- shunt/quicktype.yue:228
      end)(), T_PIPE) -- shunt/quicktype.yue:228
      if #disjunction == 1 then -- shunt/quicktype.yue:229
        return disjunction[1] -- shunt/quicktype.yue:230
      else -- shunt/quicktype.yue:232
        return Disjunction(disjunction) -- shunt/quicktype.yue:232
      end -- shunt/quicktype.yue:229
    end, -- shunt/quicktype.yue:234
    parse_type_conjunction = function(self) -- shunt/quicktype.yue:234
      local conjunction = self:parse_repeat_separated((function() -- shunt/quicktype.yue:235
        local _base_1 = self -- shunt/quicktype.yue:235
        local _fn_0 = _base_1.parse_optional_type -- shunt/quicktype.yue:235
        return _fn_0 and function(...) -- shunt/quicktype.yue:235
          return _fn_0(_base_1, ...) -- shunt/quicktype.yue:235
        end -- shunt/quicktype.yue:235
      end)(), T_PLUS) -- shunt/quicktype.yue:235
      if #conjunction == 1 then -- shunt/quicktype.yue:236
        return conjunction[1] -- shunt/quicktype.yue:237
      else -- shunt/quicktype.yue:239
        return Conjunction(conjunction) -- shunt/quicktype.yue:239
      end -- shunt/quicktype.yue:236
    end, -- shunt/quicktype.yue:241
    parse_optional_type = function(self) -- shunt/quicktype.yue:241
      return self:select({ -- shunt/quicktype.yue:243
        { -- shunt/quicktype.yue:243
          token = T_QUESTION, -- shunt/quicktype.yue:243
          action = function() -- shunt/quicktype.yue:244
            self:expect(T_QUESTION) -- shunt/quicktype.yue:245
            return Optional(self:parse_specific_type()) -- shunt/quicktype.yue:246
          end -- shunt/quicktype.yue:244
        }, -- shunt/quicktype.yue:243
        otherwise = function() -- shunt/quicktype.yue:247
          return self:parse_specific_type() -- shunt/quicktype.yue:248
        end -- shunt/quicktype.yue:247
      }) -- shunt/quicktype.yue:248
    end, -- shunt/quicktype.yue:250
    parse_specific_type = function(self) -- shunt/quicktype.yue:250
      return self:select({ -- shunt/quicktype.yue:252
        { -- shunt/quicktype.yue:252
          token = T_NAME, -- shunt/quicktype.yue:252
          action = (function() -- shunt/quicktype.yue:253
            local _base_1 = self -- shunt/quicktype.yue:253
            local _fn_0 = _base_1.parse_named_type -- shunt/quicktype.yue:253
            return _fn_0 and function(...) -- shunt/quicktype.yue:253
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:253
            end -- shunt/quicktype.yue:253
          end)() -- shunt/quicktype.yue:253
        }, -- shunt/quicktype.yue:252
        { -- shunt/quicktype.yue:254
          token = T_PREFIXED_NAME, -- shunt/quicktype.yue:254
          action = (function() -- shunt/quicktype.yue:255
            local _base_1 = self -- shunt/quicktype.yue:255
            local _fn_0 = _base_1.parse_prefixed_named_type -- shunt/quicktype.yue:255
            return _fn_0 and function(...) -- shunt/quicktype.yue:255
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:255
            end -- shunt/quicktype.yue:255
          end)() -- shunt/quicktype.yue:255
        }, -- shunt/quicktype.yue:254
        { -- shunt/quicktype.yue:256
          token = T_BOOLEAN, -- shunt/quicktype.yue:256
          action = (function() -- shunt/quicktype.yue:257
            local _base_1 = self -- shunt/quicktype.yue:257
            local _fn_0 = _base_1.parse_boolean_type -- shunt/quicktype.yue:257
            return _fn_0 and function(...) -- shunt/quicktype.yue:257
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:257
            end -- shunt/quicktype.yue:257
          end)() -- shunt/quicktype.yue:257
        }, -- shunt/quicktype.yue:256
        { -- shunt/quicktype.yue:258
          token = T_NUMBER, -- shunt/quicktype.yue:258
          action = (function() -- shunt/quicktype.yue:259
            local _base_1 = self -- shunt/quicktype.yue:259
            local _fn_0 = _base_1.parse_number_type -- shunt/quicktype.yue:259
            return _fn_0 and function(...) -- shunt/quicktype.yue:259
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:259
            end -- shunt/quicktype.yue:259
          end)() -- shunt/quicktype.yue:259
        }, -- shunt/quicktype.yue:258
        { -- shunt/quicktype.yue:260
          token = T_STRING, -- shunt/quicktype.yue:260
          action = (function() -- shunt/quicktype.yue:261
            local _base_1 = self -- shunt/quicktype.yue:261
            local _fn_0 = _base_1.parse_string_type -- shunt/quicktype.yue:261
            return _fn_0 and function(...) -- shunt/quicktype.yue:261
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:261
            end -- shunt/quicktype.yue:261
          end)() -- shunt/quicktype.yue:261
        }, -- shunt/quicktype.yue:260
        { -- shunt/quicktype.yue:262
          token = T_BRACKET_OPEN, -- shunt/quicktype.yue:262
          action = (function() -- shunt/quicktype.yue:263
            local _base_1 = self -- shunt/quicktype.yue:263
            local _fn_0 = _base_1.parse_array -- shunt/quicktype.yue:263
            return _fn_0 and function(...) -- shunt/quicktype.yue:263
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:263
            end -- shunt/quicktype.yue:263
          end)() -- shunt/quicktype.yue:263
        }, -- shunt/quicktype.yue:262
        { -- shunt/quicktype.yue:264
          token = T_PAREN_OPEN, -- shunt/quicktype.yue:264
          action = (function() -- shunt/quicktype.yue:265
            local _base_1 = self -- shunt/quicktype.yue:265
            local _fn_0 = _base_1.parse_tuple_or_function -- shunt/quicktype.yue:265
            return _fn_0 and function(...) -- shunt/quicktype.yue:265
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:265
            end -- shunt/quicktype.yue:265
          end)() -- shunt/quicktype.yue:265
        }, -- shunt/quicktype.yue:264
        { -- shunt/quicktype.yue:266
          token = T_TILDE, -- shunt/quicktype.yue:266
          action = (function() -- shunt/quicktype.yue:267
            local _base_1 = self -- shunt/quicktype.yue:267
            local _fn_0 = _base_1.parse_table_like -- shunt/quicktype.yue:267
            return _fn_0 and function(...) -- shunt/quicktype.yue:267
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:267
            end -- shunt/quicktype.yue:267
          end)() -- shunt/quicktype.yue:267
        }, -- shunt/quicktype.yue:266
        { -- shunt/quicktype.yue:268
          token = T_BRACE_OPEN, -- shunt/quicktype.yue:268
          action = (function() -- shunt/quicktype.yue:269
            local _base_1 = self -- shunt/quicktype.yue:269
            local _fn_0 = _base_1.parse_table -- shunt/quicktype.yue:269
            return _fn_0 and function(...) -- shunt/quicktype.yue:269
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:269
            end -- shunt/quicktype.yue:269
          end)() -- shunt/quicktype.yue:269
        } -- shunt/quicktype.yue:268
      }) -- shunt/quicktype.yue:269
    end, -- shunt/quicktype.yue:271
    parse_named_type = function(self) -- shunt/quicktype.yue:271
      return named_type(self:expect(T_NAME)) -- shunt/quicktype.yue:272
    end, -- shunt/quicktype.yue:274
    parse_prefixed_named_type = function(self) -- shunt/quicktype.yue:274
      return prefixed_named_type(self:expect(T_PREFIXED_NAME)) -- shunt/quicktype.yue:275
    end, -- shunt/quicktype.yue:277
    parse_boolean_type = function(self) -- shunt/quicktype.yue:277
      return BooleanType(self:expect(T_BOOLEAN)) -- shunt/quicktype.yue:278
    end, -- shunt/quicktype.yue:280
    parse_number_type = function(self) -- shunt/quicktype.yue:280
      return NumberType(self:expect(T_NUMBER)) -- shunt/quicktype.yue:281
    end, -- shunt/quicktype.yue:283
    parse_string_type = function(self) -- shunt/quicktype.yue:283
      return StringType(self:expect(T_STRING)) -- shunt/quicktype.yue:284
    end, -- shunt/quicktype.yue:286
    parse_array = function(self, is_table_like) -- shunt/quicktype.yue:286
      if is_table_like == nil then -- shunt/quicktype.yue:286
        is_table_like = false -- shunt/quicktype.yue:286
      end -- shunt/quicktype.yue:286
      local elem_type = self:sequence({ -- shunt/quicktype.yue:288
        { -- shunt/quicktype.yue:288
          token = T_BRACKET_OPEN -- shunt/quicktype.yue:288
        }, -- shunt/quicktype.yue:288
        { -- shunt/quicktype.yue:289
          action = (function() -- shunt/quicktype.yue:289
            local _base_1 = self -- shunt/quicktype.yue:289
            local _fn_0 = _base_1.parse_type -- shunt/quicktype.yue:289
            return _fn_0 and function(...) -- shunt/quicktype.yue:289
              return _fn_0(_base_1, ...) -- shunt/quicktype.yue:289
            end -- shunt/quicktype.yue:289
          end)() -- shunt/quicktype.yue:289
        }, -- shunt/quicktype.yue:289
        { -- shunt/quicktype.yue:290
          token = T_BRACKET_CLOSE -- shunt/quicktype.yue:290
        } -- shunt/quicktype.yue:290
      })[2] -- shunt/quicktype.yue:287
      return (Array(elem_type)):table_like(is_table_like) -- shunt/quicktype.yue:292
    end, -- shunt/quicktype.yue:294
    parse_tuple_or_function = function(self, is_table_like) -- shunt/quicktype.yue:294
      if is_table_like == nil then -- shunt/quicktype.yue:294
        is_table_like = false -- shunt/quicktype.yue:294
      end -- shunt/quicktype.yue:294
      self:expect(T_PAREN_OPEN) -- shunt/quicktype.yue:295
      local types -- shunt/quicktype.yue:296
      if self:maybe(T_PAREN_CLOSE) then -- shunt/quicktype.yue:297
        types = { } -- shunt/quicktype.yue:298
      else -- shunt/quicktype.yue:300
        types = self:sequence({ -- shunt/quicktype.yue:301
          { -- shunt/quicktype.yue:301
            action = function() -- shunt/quicktype.yue:301
              return self:parse_repeat_separated((function() -- shunt/quicktype.yue:302
                local _base_1 = self -- shunt/quicktype.yue:302
                local _fn_0 = _base_1.parse_function_io_type -- shunt/quicktype.yue:302
                return _fn_0 and function(...) -- shunt/quicktype.yue:302
                  return _fn_0(_base_1, ...) -- shunt/quicktype.yue:302
                end -- shunt/quicktype.yue:302
              end)(), T_COMMA, { -- shunt/quicktype.yue:302
                separator_trails_before = T_PAREN_CLOSE -- shunt/quicktype.yue:302
              }) -- shunt/quicktype.yue:302
            end -- shunt/quicktype.yue:301
          }, -- shunt/quicktype.yue:301
          { -- shunt/quicktype.yue:303
            token = T_PAREN_CLOSE -- shunt/quicktype.yue:303
          } -- shunt/quicktype.yue:303
        })[1] -- shunt/quicktype.yue:300
      end -- shunt/quicktype.yue:297
      local function_arrow -- shunt/quicktype.yue:304
      do -- shunt/quicktype.yue:304
        local _exp_0 = (self:maybe(T_THIN_ARROW)) -- shunt/quicktype.yue:304
        if _exp_0 ~= nil then -- shunt/quicktype.yue:304
          function_arrow = _exp_0 -- shunt/quicktype.yue:304
        else -- shunt/quicktype.yue:304
          function_arrow = self:maybe(T_FAT_ARROW) -- shunt/quicktype.yue:304
        end -- shunt/quicktype.yue:304
      end -- shunt/quicktype.yue:304
      if not (function_arrow ~= nil) then -- shunt/quicktype.yue:305
        for _index_0 = 1, #types do -- shunt/quicktype.yue:306
          local ty = types[_index_0] -- shunt/quicktype.yue:306
          if ty:is(Remainder) then -- shunt/quicktype.yue:307
            error('tuple type cannot contain varargs') -- shunt/quicktype.yue:308
          end -- shunt/quicktype.yue:307
        end -- shunt/quicktype.yue:308
        return (Tuple(types)):table_like(is_table_like) -- shunt/quicktype.yue:310
      end -- shunt/quicktype.yue:305
      if is_table_like then -- shunt/quicktype.yue:312
        local ty -- shunt/quicktype.yue:313
        if function_arrow == T_THIN_ARROW then -- shunt/quicktype.yue:314
          ty = 'functions' -- shunt/quicktype.yue:315
        else -- shunt/quicktype.yue:317
          ty = 'methods' -- shunt/quicktype.yue:317
        end -- shunt/quicktype.yue:314
        error(tostring(ty) .. " cannot be table-like") -- shunt/quicktype.yue:318
      end -- shunt/quicktype.yue:312
      do -- shunt/quicktype.yue:320
        local _max_0 = -1 -- shunt/quicktype.yue:320
        for _index_0 = 1, _max_0 < 0 and #types + _max_0 or _max_0 do -- shunt/quicktype.yue:320
          local ty = types[_index_0] -- shunt/quicktype.yue:320
          if ty:is(Remainder) then -- shunt/quicktype.yue:321
            error('varargs can only be declared at end of a param type list') -- shunt/quicktype.yue:322
          end -- shunt/quicktype.yue:321
        end -- shunt/quicktype.yue:322
      end -- shunt/quicktype.yue:322
      local last_ty = types[#types] -- shunt/quicktype.yue:324
      if (last_ty ~= nil) and last_ty:is(Remainder) then -- shunt/quicktype.yue:325
        setmetatable(types, { -- shunt/quicktype.yue:326
          __index = function(self) -- shunt/quicktype.yue:326
            return last_ty.type -- shunt/quicktype.yue:326
          end -- shunt/quicktype.yue:326
        }) -- shunt/quicktype.yue:326
        types[#types] = nil -- shunt/quicktype.yue:327
      end -- shunt/quicktype.yue:325
      if T_THIN_ARROW == function_arrow then -- shunt/quicktype.yue:330
        return Function(types, self:parse_return_type()) -- shunt/quicktype.yue:331
      elseif T_FAT_ARROW == function_arrow then -- shunt/quicktype.yue:332
        return Method(types, self:parse_return_type()) -- shunt/quicktype.yue:333
      else -- shunt/quicktype.yue:335
        return error("internal error: unknown function arrow type: " .. tostring(function_arrow)) -- shunt/quicktype.yue:335
      end -- shunt/quicktype.yue:335
    end, -- shunt/quicktype.yue:337
    parse_return_type = function(self) -- shunt/quicktype.yue:337
      return self:select({ -- shunt/quicktype.yue:339
        { -- shunt/quicktype.yue:339
          token = T_ANGLE_OPEN, -- shunt/quicktype.yue:339
          action = function() -- shunt/quicktype.yue:340
            self:expect(T_ANGLE_OPEN) -- shunt/quicktype.yue:341
            if self:maybe(T_ANGLE_CLOSE) then -- shunt/quicktype.yue:342
              return { } -- shunt/quicktype.yue:343
            end -- shunt/quicktype.yue:342
            local types = self:parse_repeat_separated((function() -- shunt/quicktype.yue:344
              local _base_1 = self -- shunt/quicktype.yue:344
              local _fn_0 = _base_1.parse_function_io_type -- shunt/quicktype.yue:344
              return _fn_0 and function(...) -- shunt/quicktype.yue:344
                return _fn_0(_base_1, ...) -- shunt/quicktype.yue:344
              end -- shunt/quicktype.yue:344
            end)(), T_COMMA, { -- shunt/quicktype.yue:344
              separator_trails_before = T_ANGLE_CLOSE -- shunt/quicktype.yue:344
            }) -- shunt/quicktype.yue:344
            self:expect(T_ANGLE_CLOSE) -- shunt/quicktype.yue:345
            do -- shunt/quicktype.yue:347
              local _max_0 = -1 -- shunt/quicktype.yue:347
              for _index_0 = 1, _max_0 < 0 and #types + _max_0 or _max_0 do -- shunt/quicktype.yue:347
                local ty = types[_index_0] -- shunt/quicktype.yue:347
                if ty:is(Remainder) then -- shunt/quicktype.yue:348
                  error('variable returns can only be declared at end of a return type list') -- shunt/quicktype.yue:349
                end -- shunt/quicktype.yue:348
              end -- shunt/quicktype.yue:349
            end -- shunt/quicktype.yue:349
            local last_ty = types[#types] -- shunt/quicktype.yue:351
            if (last_ty ~= nil) and last_ty:is(Remainder) then -- shunt/quicktype.yue:352
              setmetatable(types, { -- shunt/quicktype.yue:353
                __index = function(self) -- shunt/quicktype.yue:353
                  return last_ty.type -- shunt/quicktype.yue:353
                end -- shunt/quicktype.yue:353
              }) -- shunt/quicktype.yue:353
              types[#types] = nil -- shunt/quicktype.yue:354
            end -- shunt/quicktype.yue:352
            return types -- shunt/quicktype.yue:356
          end -- shunt/quicktype.yue:340
        }, -- shunt/quicktype.yue:339
        otherwise = function() -- shunt/quicktype.yue:357
          local ty = self:parse_function_io_type() -- shunt/quicktype.yue:358
          if ty:is(Remainder) then -- shunt/quicktype.yue:359
            return setmetatable({ }, { -- shunt/quicktype.yue:360
              __index = function(self) -- shunt/quicktype.yue:360
                return ty.type -- shunt/quicktype.yue:360
              end -- shunt/quicktype.yue:360
            }) -- shunt/quicktype.yue:360
          else -- shunt/quicktype.yue:362
            return { -- shunt/quicktype.yue:362
              ty -- shunt/quicktype.yue:362
            } -- shunt/quicktype.yue:362
          end -- shunt/quicktype.yue:359
        end -- shunt/quicktype.yue:357
      }) -- shunt/quicktype.yue:362
    end, -- shunt/quicktype.yue:364
    parse_function_io_type = function(self) -- shunt/quicktype.yue:364
      local ty = self:parse_type() -- shunt/quicktype.yue:365
      if ((self:maybe(T_DOTDOTDOT)) ~= nil) then -- shunt/quicktype.yue:366
        return Remainder(ty) -- shunt/quicktype.yue:367
      else -- shunt/quicktype.yue:369
        return ty -- shunt/quicktype.yue:369
      end -- shunt/quicktype.yue:366
    end, -- shunt/quicktype.yue:371
    parse_table_like = function(self) -- shunt/quicktype.yue:371
      self:expect(T_TILDE) -- shunt/quicktype.yue:372
      return self:select({ -- shunt/quicktype.yue:374
        { -- shunt/quicktype.yue:374
          token = T_BRACE_OPEN, -- shunt/quicktype.yue:374
          action = function() -- shunt/quicktype.yue:375
            return self:parse_table(true) -- shunt/quicktype.yue:375
          end -- shunt/quicktype.yue:375
        }, -- shunt/quicktype.yue:374
        { -- shunt/quicktype.yue:376
          token = T_BRACKET_OPEN, -- shunt/quicktype.yue:376
          action = function() -- shunt/quicktype.yue:377
            return self:parse_array(true) -- shunt/quicktype.yue:377
          end -- shunt/quicktype.yue:377
        }, -- shunt/quicktype.yue:376
        { -- shunt/quicktype.yue:378
          token = T_PAREN_OPEN, -- shunt/quicktype.yue:378
          action = function() -- shunt/quicktype.yue:379
            return self:parse_tuple_or_function(true) -- shunt/quicktype.yue:379
          end -- shunt/quicktype.yue:379
        } -- shunt/quicktype.yue:378
      }) -- shunt/quicktype.yue:379
    end, -- shunt/quicktype.yue:381
    parse_table = function(self, is_table_like) -- shunt/quicktype.yue:381
      if is_table_like == nil then -- shunt/quicktype.yue:381
        is_table_like = false -- shunt/quicktype.yue:381
      end -- shunt/quicktype.yue:381
      local table = self:sequence({ -- shunt/quicktype.yue:383
        { -- shunt/quicktype.yue:383
          token = T_BRACE_OPEN -- shunt/quicktype.yue:383
        }, -- shunt/quicktype.yue:383
        { -- shunt/quicktype.yue:384
          action = function() -- shunt/quicktype.yue:384
            return self:parse_table_content(is_table_like) -- shunt/quicktype.yue:384
          end -- shunt/quicktype.yue:384
        }, -- shunt/quicktype.yue:384
        { -- shunt/quicktype.yue:385
          token = T_BRACE_CLOSE -- shunt/quicktype.yue:385
        } -- shunt/quicktype.yue:385
      })[2] -- shunt/quicktype.yue:382
      return table -- shunt/quicktype.yue:386
    end, -- shunt/quicktype.yue:388
    parse_table_content = function(self, is_table_like) -- shunt/quicktype.yue:388
      if is_table_like == nil then -- shunt/quicktype.yue:388
        is_table_like = false -- shunt/quicktype.yue:388
      end -- shunt/quicktype.yue:388
      if ((function() -- shunt/quicktype.yue:389
        local _exp_0 = self.lexer:peek() -- shunt/quicktype.yue:389
        if _exp_0 ~= nil then -- shunt/quicktype.yue:389
          return _exp_0 -- shunt/quicktype.yue:389
        else -- shunt/quicktype.yue:389
          return { } -- shunt/quicktype.yue:389
        end -- shunt/quicktype.yue:389
      end)()).type == T_BRACE_CLOSE then -- shunt/quicktype.yue:389
        return (Struct(nil, { })):table_like(is_table_like) -- shunt/quicktype.yue:391
      end -- shunt/quicktype.yue:389
      local metatable_type -- shunt/quicktype.yue:393
      if ((self:maybe(T_ANGLE_OPEN)) ~= nil) then -- shunt/quicktype.yue:394
        self:expect(T_ANGLE_CLOSE) -- shunt/quicktype.yue:395
        self:expect(T_COLON) -- shunt/quicktype.yue:396
        metatable_type = self:parse_type() -- shunt/quicktype.yue:397
        local checkpoint = self.lexer:checkpoint() -- shunt/quicktype.yue:398
        self:maybe(T_COMMA) -- shunt/quicktype.yue:399
        if ((function() -- shunt/quicktype.yue:400
          local _exp_0 = self.lexer:peek() -- shunt/quicktype.yue:400
          if _exp_0 ~= nil then -- shunt/quicktype.yue:400
            return _exp_0 -- shunt/quicktype.yue:400
          else -- shunt/quicktype.yue:400
            return { } -- shunt/quicktype.yue:400
          end -- shunt/quicktype.yue:400
        end)()).type == T_BRACE_CLOSE then -- shunt/quicktype.yue:400
          return (Struct(metatable_type, { })):table_like(is_table_like) -- shunt/quicktype.yue:402
        end -- shunt/quicktype.yue:400
        self.lexer:restore(checkpoint) -- shunt/quicktype.yue:403
        self:expect(T_COMMA) -- shunt/quicktype.yue:404
      end -- shunt/quicktype.yue:394
      local checkpoint = self.lexer:checkpoint() -- shunt/quicktype.yue:406
      local is_struct = ((self:maybe(T_NAME)) ~= nil) and ((self:maybe(T_COLON)) ~= nil) -- shunt/quicktype.yue:407
      self.lexer:restore(checkpoint) -- shunt/quicktype.yue:408
      if is_struct then -- shunt/quicktype.yue:410
        return (Struct(metatable_type, self:parse_repeat_separated((function() -- shunt/quicktype.yue:411
          local _base_1 = self -- shunt/quicktype.yue:411
          local _fn_0 = _base_1.parse_field -- shunt/quicktype.yue:411
          return _fn_0 and function(...) -- shunt/quicktype.yue:411
            return _fn_0(_base_1, ...) -- shunt/quicktype.yue:411
          end -- shunt/quicktype.yue:411
        end)(), T_COMMA, { -- shunt/quicktype.yue:411
          separator_trails_before = T_BRACE_CLOSE -- shunt/quicktype.yue:411
        }))):table_like(is_table_like) -- shunt/quicktype.yue:412
      end -- shunt/quicktype.yue:410
      local first_type = self:parse_type() -- shunt/quicktype.yue:414
      local table_content_type = self:select({ -- shunt/quicktype.yue:416
        { -- shunt/quicktype.yue:416
          token = T_BRACE_CLOSE, -- shunt/quicktype.yue:416
          action = function() -- shunt/quicktype.yue:417
            return 'set' -- shunt/quicktype.yue:417
          end -- shunt/quicktype.yue:417
        }, -- shunt/quicktype.yue:416
        { -- shunt/quicktype.yue:418
          token = T_THIN_ARROW, -- shunt/quicktype.yue:418
          action = function() -- shunt/quicktype.yue:419
            return 'mapping' -- shunt/quicktype.yue:419
          end -- shunt/quicktype.yue:419
        } -- shunt/quicktype.yue:418
      }) -- shunt/quicktype.yue:415
      if 'set' == table_content_type then -- shunt/quicktype.yue:422
        return (Set(metatable_type, first_type)):table_like(is_table_like) -- shunt/quicktype.yue:424
      elseif 'mapping' == table_content_type then -- shunt/quicktype.yue:425
        local maps_to = self:sequence({ -- shunt/quicktype.yue:427
          { -- shunt/quicktype.yue:427
            token = T_THIN_ARROW -- shunt/quicktype.yue:427
          }, -- shunt/quicktype.yue:427
          { -- shunt/quicktype.yue:428
            action = (function() -- shunt/quicktype.yue:428
              local _base_1 = self -- shunt/quicktype.yue:428
              local _fn_0 = _base_1.parse_type -- shunt/quicktype.yue:428
              return _fn_0 and function(...) -- shunt/quicktype.yue:428
                return _fn_0(_base_1, ...) -- shunt/quicktype.yue:428
              end -- shunt/quicktype.yue:428
            end)() -- shunt/quicktype.yue:428
          } -- shunt/quicktype.yue:428
        })[2] -- shunt/quicktype.yue:426
        return (Mapping(metatable_type, first_type, maps_to)):table_like(is_table_like) -- shunt/quicktype.yue:430
      else -- shunt/quicktype.yue:432
        return error("internal error: illegal table contents type: " .. tostring(repr(table_content_type))) -- shunt/quicktype.yue:432
      end -- shunt/quicktype.yue:432
    end, -- shunt/quicktype.yue:434
    parse_field = function(self) -- shunt/quicktype.yue:434
      local name, type -- shunt/quicktype.yue:435
      do -- shunt/quicktype.yue:435
        local _obj_0 = self:sequence({ -- shunt/quicktype.yue:436
          { -- shunt/quicktype.yue:436
            token = T_NAME -- shunt/quicktype.yue:436
          }, -- shunt/quicktype.yue:436
          { -- shunt/quicktype.yue:437
            token = T_COLON -- shunt/quicktype.yue:437
          }, -- shunt/quicktype.yue:437
          { -- shunt/quicktype.yue:438
            action = (function() -- shunt/quicktype.yue:438
              local _base_1 = self -- shunt/quicktype.yue:438
              local _fn_0 = _base_1.parse_type -- shunt/quicktype.yue:438
              return _fn_0 and function(...) -- shunt/quicktype.yue:438
                return _fn_0(_base_1, ...) -- shunt/quicktype.yue:438
              end -- shunt/quicktype.yue:438
            end)() -- shunt/quicktype.yue:438
          } -- shunt/quicktype.yue:438
        }) -- shunt/quicktype.yue:435
        name, type = _obj_0[1], _obj_0[3] -- shunt/quicktype.yue:435
      end -- shunt/quicktype.yue:438
      return Field(name, type) -- shunt/quicktype.yue:439
    end -- shunt/quicktype.yue:214
  } -- shunt/quicktype.yue:214
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/quicktype.yue:439
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/quicktype.yue:214
      _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:214
    end -- shunt/quicktype.yue:214
  end -- shunt/quicktype.yue:439
  if _base_0.__index == nil then -- shunt/quicktype.yue:214
    _base_0.__index = _base_0 -- shunt/quicktype.yue:214
  end -- shunt/quicktype.yue:439
  setmetatable(_base_0, _parent_0.__base) -- shunt/quicktype.yue:214
  _class_0 = setmetatable({ -- shunt/quicktype.yue:214
    __init = function(self, ...) -- shunt/quicktype.yue:214
      return _class_0.__parent.__init(self, ...) -- shunt/quicktype.yue:214
    end, -- shunt/quicktype.yue:214
    __base = _base_0, -- shunt/quicktype.yue:214
    __name = "TypeSpecParser", -- shunt/quicktype.yue:214
    __parent = _parent_0 -- shunt/quicktype.yue:214
  }, { -- shunt/quicktype.yue:214
    __index = function(cls, name) -- shunt/quicktype.yue:214
      local val = rawget(_base_0, name) -- shunt/quicktype.yue:214
      if val == nil then -- shunt/quicktype.yue:214
        local parent = rawget(cls, "__parent") -- shunt/quicktype.yue:214
        if parent then -- shunt/quicktype.yue:214
          return parent[name] -- shunt/quicktype.yue:214
        end -- shunt/quicktype.yue:214
      else -- shunt/quicktype.yue:214
        return val -- shunt/quicktype.yue:214
      end -- shunt/quicktype.yue:214
    end, -- shunt/quicktype.yue:214
    __call = function(cls, ...) -- shunt/quicktype.yue:214
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:214
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:214
      return _self_0 -- shunt/quicktype.yue:214
    end -- shunt/quicktype.yue:214
  }) -- shunt/quicktype.yue:214
  _base_0.__class = _class_0 -- shunt/quicktype.yue:214
  if _parent_0.__inherited then -- shunt/quicktype.yue:214
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/quicktype.yue:214
  end -- shunt/quicktype.yue:214
  TypeSpecParser = _class_0 -- shunt/quicktype.yue:214
end -- shunt/quicktype.yue:439
T_PAREN_OPEN = setmetatable({ }, { -- shunt/quicktype.yue:442
  __tostring = function(self) -- shunt/quicktype.yue:442
    return "'('" -- shunt/quicktype.yue:442
  end -- shunt/quicktype.yue:442
}) -- shunt/quicktype.yue:442
T_PAREN_CLOSE = setmetatable({ }, { -- shunt/quicktype.yue:443
  __tostring = function(self) -- shunt/quicktype.yue:443
    return "')'" -- shunt/quicktype.yue:443
  end -- shunt/quicktype.yue:443
}) -- shunt/quicktype.yue:443
T_BRACE_OPEN = setmetatable({ }, { -- shunt/quicktype.yue:444
  __tostring = function(self) -- shunt/quicktype.yue:444
    return "'{'" -- shunt/quicktype.yue:444
  end -- shunt/quicktype.yue:444
}) -- shunt/quicktype.yue:444
T_BRACE_CLOSE = setmetatable({ }, { -- shunt/quicktype.yue:445
  __tostring = function(self) -- shunt/quicktype.yue:445
    return "'}'" -- shunt/quicktype.yue:445
  end -- shunt/quicktype.yue:445
}) -- shunt/quicktype.yue:445
T_BRACKET_OPEN = setmetatable({ }, { -- shunt/quicktype.yue:446
  __tostring = function(self) -- shunt/quicktype.yue:446
    return "'['" -- shunt/quicktype.yue:446
  end -- shunt/quicktype.yue:446
}) -- shunt/quicktype.yue:446
T_BRACKET_CLOSE = setmetatable({ }, { -- shunt/quicktype.yue:447
  __tostring = function(self) -- shunt/quicktype.yue:447
    return "']'" -- shunt/quicktype.yue:447
  end -- shunt/quicktype.yue:447
}) -- shunt/quicktype.yue:447
T_ANGLE_OPEN = setmetatable({ }, { -- shunt/quicktype.yue:448
  __tostring = function(self) -- shunt/quicktype.yue:448
    return '"<"' -- shunt/quicktype.yue:448
  end -- shunt/quicktype.yue:448
}) -- shunt/quicktype.yue:448
T_ANGLE_CLOSE = setmetatable({ }, { -- shunt/quicktype.yue:449
  __tostring = function(self) -- shunt/quicktype.yue:449
    return '">"' -- shunt/quicktype.yue:449
  end -- shunt/quicktype.yue:449
}) -- shunt/quicktype.yue:449
T_TILDE = setmetatable({ }, { -- shunt/quicktype.yue:450
  __tostring = function(self) -- shunt/quicktype.yue:450
    return '~' -- shunt/quicktype.yue:450
  end -- shunt/quicktype.yue:450
}) -- shunt/quicktype.yue:450
T_COMMA = setmetatable({ }, { -- shunt/quicktype.yue:451
  __tostring = function(self) -- shunt/quicktype.yue:451
    return "','" -- shunt/quicktype.yue:451
  end -- shunt/quicktype.yue:451
}) -- shunt/quicktype.yue:451
T_COLON = setmetatable({ }, { -- shunt/quicktype.yue:452
  __tostring = function(self) -- shunt/quicktype.yue:452
    return "':'" -- shunt/quicktype.yue:452
  end -- shunt/quicktype.yue:452
}) -- shunt/quicktype.yue:452
T_BANG = setmetatable({ }, { -- shunt/quicktype.yue:453
  __tostring = function(self) -- shunt/quicktype.yue:453
    return "'!'" -- shunt/quicktype.yue:453
  end -- shunt/quicktype.yue:453
}) -- shunt/quicktype.yue:453
T_THIN_ARROW = setmetatable({ }, { -- shunt/quicktype.yue:454
  __tostring = function(self) -- shunt/quicktype.yue:454
    return "'->'" -- shunt/quicktype.yue:454
  end -- shunt/quicktype.yue:454
}) -- shunt/quicktype.yue:454
T_FAT_ARROW = setmetatable({ }, { -- shunt/quicktype.yue:455
  __tostring = function(self) -- shunt/quicktype.yue:455
    return "'=>'" -- shunt/quicktype.yue:455
  end -- shunt/quicktype.yue:455
}) -- shunt/quicktype.yue:455
T_DOTDOTDOT = setmetatable({ }, { -- shunt/quicktype.yue:456
  __tostring = function(self) -- shunt/quicktype.yue:456
    return "'...'" -- shunt/quicktype.yue:456
  end -- shunt/quicktype.yue:456
}) -- shunt/quicktype.yue:456
T_QUESTION = setmetatable({ }, { -- shunt/quicktype.yue:457
  __tostring = function(self) -- shunt/quicktype.yue:457
    return "'?'" -- shunt/quicktype.yue:457
  end -- shunt/quicktype.yue:457
}) -- shunt/quicktype.yue:457
T_PLUS = setmetatable({ }, { -- shunt/quicktype.yue:458
  __tostring = function(self) -- shunt/quicktype.yue:458
    return "'+'" -- shunt/quicktype.yue:458
  end -- shunt/quicktype.yue:458
}) -- shunt/quicktype.yue:458
T_PIPE = setmetatable({ }, { -- shunt/quicktype.yue:459
  __tostring = function(self) -- shunt/quicktype.yue:459
    return "'|'" -- shunt/quicktype.yue:459
  end -- shunt/quicktype.yue:459
}) -- shunt/quicktype.yue:459
T_NAME = setmetatable({ }, { -- shunt/quicktype.yue:460
  __tostring = function(self) -- shunt/quicktype.yue:460
    return "<name>" -- shunt/quicktype.yue:460
  end -- shunt/quicktype.yue:460
}) -- shunt/quicktype.yue:460
T_PREFIXED_NAME = setmetatable({ }, { -- shunt/quicktype.yue:461
  __tostring = function(self) -- shunt/quicktype.yue:461
    return "<prefixed-name>" -- shunt/quicktype.yue:461
  end -- shunt/quicktype.yue:461
}) -- shunt/quicktype.yue:461
T_BOOLEAN = setmetatable({ }, { -- shunt/quicktype.yue:462
  __tostring = function(self) -- shunt/quicktype.yue:462
    return "<boolean>" -- shunt/quicktype.yue:462
  end -- shunt/quicktype.yue:462
}) -- shunt/quicktype.yue:462
T_NUMBER = setmetatable({ }, { -- shunt/quicktype.yue:463
  __tostring = function(self) -- shunt/quicktype.yue:463
    return "<number>" -- shunt/quicktype.yue:463
  end -- shunt/quicktype.yue:463
}) -- shunt/quicktype.yue:463
T_STRING = setmetatable({ }, { -- shunt/quicktype.yue:464
  __tostring = function(self) -- shunt/quicktype.yue:464
    return "<string>" -- shunt/quicktype.yue:464
  end -- shunt/quicktype.yue:464
}) -- shunt/quicktype.yue:464
do -- shunt/quicktype.yue:466
  local _class_0 -- shunt/quicktype.yue:466
  local _base_0 = { -- shunt/quicktype.yue:466
    peek = function(self) -- shunt/quicktype.yue:535
      if self.done then -- shunt/quicktype.yue:536
        return nil -- shunt/quicktype.yue:537
      end -- shunt/quicktype.yue:536
      if (self.peeked ~= nil) then -- shunt/quicktype.yue:539
        return self.peeked -- shunt/quicktype.yue:540
      end -- shunt/quicktype.yue:539
      self.peeked = self:tokens() -- shunt/quicktype.yue:542
      if not self.peeked then -- shunt/quicktype.yue:543
        self.done = true -- shunt/quicktype.yue:544
      end -- shunt/quicktype.yue:543
      return self.peeked -- shunt/quicktype.yue:545
    end, -- shunt/quicktype.yue:547
    next = function(self) -- shunt/quicktype.yue:547
      if self.done then -- shunt/quicktype.yue:548
        return nil -- shunt/quicktype.yue:549
      end -- shunt/quicktype.yue:548
      if (self.peeked ~= nil) then -- shunt/quicktype.yue:551
        local peeked = self.peeked -- shunt/quicktype.yue:552
        self.peeked = nil -- shunt/quicktype.yue:553
        return peeked -- shunt/quicktype.yue:554
      else -- shunt/quicktype.yue:556
        local ret = self:tokens() -- shunt/quicktype.yue:556
        if not (ret ~= nil) then -- shunt/quicktype.yue:557
          self.done = true -- shunt/quicktype.yue:558
        end -- shunt/quicktype.yue:557
        return ret -- shunt/quicktype.yue:559
      end -- shunt/quicktype.yue:551
    end, -- shunt/quicktype.yue:561
    checkpoint = function(self) -- shunt/quicktype.yue:561
      return Checkpoint(self.index, self.peeked) -- shunt/quicktype.yue:562
    end, -- shunt/quicktype.yue:564
    restore = function(self, checkpoint) -- shunt/quicktype.yue:564
      local index, peeked = checkpoint.index, checkpoint.peeked -- shunt/quicktype.yue:565
      self.index = index -- shunt/quicktype.yue:566
      self.peeked = peeked -- shunt/quicktype.yue:567
    end -- shunt/quicktype.yue:466
  } -- shunt/quicktype.yue:466
  if _base_0.__index == nil then -- shunt/quicktype.yue:466
    _base_0.__index = _base_0 -- shunt/quicktype.yue:466
  end -- shunt/quicktype.yue:567
  _class_0 = setmetatable({ -- shunt/quicktype.yue:466
    __init = function(self, type_spec) -- shunt/quicktype.yue:467
      self.type_spec = type_spec -- shunt/quicktype.yue:467
      self.index = 1 -- shunt/quicktype.yue:468
      self.done = false -- shunt/quicktype.yue:469
      self.peeked = nil -- shunt/quicktype.yue:470
      self.tokens = coroutine.wrap(function() -- shunt/quicktype.yue:471
        while self.index <= #type_spec do -- shunt/quicktype.yue:472
          local _continue_0 = false -- shunt/quicktype.yue:473
          repeat -- shunt/quicktype.yue:473
            local ty, value, bytes_consumed -- shunt/quicktype.yue:473
            do -- shunt/quicktype.yue:473
              local match = type_spec:match('^%-%-[^\r\n]*', self.index) -- shunt/quicktype.yue:473
              if match then -- shunt/quicktype.yue:473
                ty, value, bytes_consumed = nil, nil, #match -- shunt/quicktype.yue:474
              else -- shunt/quicktype.yue:475
                do -- shunt/quicktype.yue:475
                  local whitespace = type_spec:match('^[ \t\r\n]+', self.index) -- shunt/quicktype.yue:475
                  if whitespace then -- shunt/quicktype.yue:475
                    ty, value, bytes_consumed = nil, nil, #whitespace -- shunt/quicktype.yue:476
                  else -- shunt/quicktype.yue:477
                    match = type_spec:match('^%(', self.index) -- shunt/quicktype.yue:477
                    if match then -- shunt/quicktype.yue:477
                      ty, value, bytes_consumed = T_PAREN_OPEN, nil, #match -- shunt/quicktype.yue:478
                    else -- shunt/quicktype.yue:479
                      match = type_spec:match('^%)', self.index) -- shunt/quicktype.yue:479
                      if match then -- shunt/quicktype.yue:479
                        ty, value, bytes_consumed = T_PAREN_CLOSE, nil, #match -- shunt/quicktype.yue:480
                      else -- shunt/quicktype.yue:481
                        match = type_spec:match('^,', self.index) -- shunt/quicktype.yue:481
                        if match then -- shunt/quicktype.yue:481
                          ty, value, bytes_consumed = T_COMMA, nil, #match -- shunt/quicktype.yue:482
                        else -- shunt/quicktype.yue:483
                          match = type_spec:match('^{', self.index) -- shunt/quicktype.yue:483
                          if match then -- shunt/quicktype.yue:483
                            ty, value, bytes_consumed = T_BRACE_OPEN, nil, #match -- shunt/quicktype.yue:484
                          else -- shunt/quicktype.yue:485
                            match = type_spec:match('^}', self.index) -- shunt/quicktype.yue:485
                            if match then -- shunt/quicktype.yue:485
                              ty, value, bytes_consumed = T_BRACE_CLOSE, nil, #match -- shunt/quicktype.yue:486
                            else -- shunt/quicktype.yue:487
                              match = type_spec:match('^%[', self.index) -- shunt/quicktype.yue:487
                              if match then -- shunt/quicktype.yue:487
                                ty, value, bytes_consumed = T_BRACKET_OPEN, nil, #match -- shunt/quicktype.yue:488
                              else -- shunt/quicktype.yue:489
                                match = type_spec:match('^]', self.index) -- shunt/quicktype.yue:489
                                if match then -- shunt/quicktype.yue:489
                                  ty, value, bytes_consumed = T_BRACKET_CLOSE, nil, #match -- shunt/quicktype.yue:490
                                else -- shunt/quicktype.yue:491
                                  match = type_spec:match('^:', self.index) -- shunt/quicktype.yue:491
                                  if match then -- shunt/quicktype.yue:491
                                    ty, value, bytes_consumed = T_COLON, nil, #match -- shunt/quicktype.yue:492
                                  else -- shunt/quicktype.yue:493
                                    match = type_spec:match('^!', self.index) -- shunt/quicktype.yue:493
                                    if match then -- shunt/quicktype.yue:493
                                      ty, value, bytes_consumed = T_BANG, nil, #match -- shunt/quicktype.yue:494
                                    else -- shunt/quicktype.yue:495
                                      match = type_spec:match('^->', self.index) -- shunt/quicktype.yue:495
                                      if match then -- shunt/quicktype.yue:495
                                        ty, value, bytes_consumed = T_THIN_ARROW, nil, #match -- shunt/quicktype.yue:496
                                      else -- shunt/quicktype.yue:497
                                        match = type_spec:match('^=>', self.index) -- shunt/quicktype.yue:497
                                        if match then -- shunt/quicktype.yue:497
                                          ty, value, bytes_consumed = T_FAT_ARROW, nil, #match -- shunt/quicktype.yue:498
                                        else -- shunt/quicktype.yue:499
                                          match = type_spec:match('^%.%.%.', self.index) -- shunt/quicktype.yue:499
                                          if match then -- shunt/quicktype.yue:499
                                            ty, value, bytes_consumed = T_DOTDOTDOT, nil, #match -- shunt/quicktype.yue:500
                                          else -- shunt/quicktype.yue:501
                                            match = type_spec:match('^<', self.index) -- shunt/quicktype.yue:501
                                            if match then -- shunt/quicktype.yue:501
                                              ty, value, bytes_consumed = T_ANGLE_OPEN, nil, #match -- shunt/quicktype.yue:502
                                            else -- shunt/quicktype.yue:503
                                              match = type_spec:match('^>', self.index) -- shunt/quicktype.yue:503
                                              if match then -- shunt/quicktype.yue:503
                                                ty, value, bytes_consumed = T_ANGLE_CLOSE, nil, #match -- shunt/quicktype.yue:504
                                              else -- shunt/quicktype.yue:505
                                                match = type_spec:match('^?', self.index) -- shunt/quicktype.yue:505
                                                if match then -- shunt/quicktype.yue:505
                                                  ty, value, bytes_consumed = T_QUESTION, nil, #match -- shunt/quicktype.yue:506
                                                else -- shunt/quicktype.yue:507
                                                  match = type_spec:match('^+', self.index) -- shunt/quicktype.yue:507
                                                  if match then -- shunt/quicktype.yue:507
                                                    ty, value, bytes_consumed = T_PLUS, nil, #match -- shunt/quicktype.yue:508
                                                  else -- shunt/quicktype.yue:509
                                                    match = type_spec:match('^|', self.index) -- shunt/quicktype.yue:509
                                                    if match then -- shunt/quicktype.yue:509
                                                      ty, value, bytes_consumed = T_PIPE, nil, #match -- shunt/quicktype.yue:510
                                                    else -- shunt/quicktype.yue:511
                                                      match = type_spec:match('^true', self.index) -- shunt/quicktype.yue:511
                                                      if match then -- shunt/quicktype.yue:511
                                                        ty, value, bytes_consumed = T_BOOLEAN, true, #match -- shunt/quicktype.yue:512
                                                      else -- shunt/quicktype.yue:513
                                                        match = type_spec:match('^false', self.index) -- shunt/quicktype.yue:513
                                                        if match then -- shunt/quicktype.yue:513
                                                          ty, value, bytes_consumed = T_BOOLEAN, false, #match -- shunt/quicktype.yue:514
                                                        else -- shunt/quicktype.yue:515
                                                          do -- shunt/quicktype.yue:515
                                                            local prefixed_name = type_spec:match('^([a-zA-Z_][a-zA-Z0-9_]*[a-zA-Z0-9_]%.[a-zA-Z_][a-zA-Z0-9_]*[a-zA-Z0-9_])', self.index) -- shunt/quicktype.yue:515
                                                            if prefixed_name then -- shunt/quicktype.yue:515
                                                              ty, value, bytes_consumed = T_PREFIXED_NAME, prefixed_name, #prefixed_name -- shunt/quicktype.yue:516
                                                            else -- shunt/quicktype.yue:517
                                                              do -- shunt/quicktype.yue:517
                                                                local name = type_spec:match('^([a-zA-Z_][a-zA-Z0-9_-]*[a-zA-Z0-9_])', self.index) -- shunt/quicktype.yue:517
                                                                if name then -- shunt/quicktype.yue:517
                                                                  ty, value, bytes_consumed = T_NAME, name, #name -- shunt/quicktype.yue:518
                                                                else -- shunt/quicktype.yue:519
                                                                  do -- shunt/quicktype.yue:519
                                                                    local number = type_spec:match('^%-?[0-9]*%.[0-9]+', self.index) -- shunt/quicktype.yue:519
                                                                    if number then -- shunt/quicktype.yue:519
                                                                      ty, value, bytes_consumed = T_NUMBER, (assert(tonumber(number))), #number -- shunt/quicktype.yue:520
                                                                    else -- shunt/quicktype.yue:521
                                                                      number = type_spec:match('^%-?[0-9]+', self.index) -- shunt/quicktype.yue:521
                                                                      if number then -- shunt/quicktype.yue:521
                                                                        ty, value, bytes_consumed = T_NUMBER, (assert(tonumber(number))), #number -- shunt/quicktype.yue:522
                                                                      else -- shunt/quicktype.yue:523
                                                                        do -- shunt/quicktype.yue:523
                                                                          local string = type_spec:match([[^"([^"]*)"]], self.index) -- shunt/quicktype.yue:523
                                                                          if string then -- shunt/quicktype.yue:523
                                                                            ty, value, bytes_consumed = T_STRING, string, #string + 2 -- shunt/quicktype.yue:524
                                                                          else -- shunt/quicktype.yue:525
                                                                            match = type_spec:match('^~', self.index) -- shunt/quicktype.yue:525
                                                                            if match then -- shunt/quicktype.yue:525
                                                                              ty, value, bytes_consumed = T_TILDE, nil, #match -- shunt/quicktype.yue:526
                                                                            else -- shunt/quicktype.yue:528
                                                                              ty, value, bytes_consumed = error("unexpected character '" .. tostring(type_spec:sub(self.index, self.index)) .. "' in type spec '" .. tostring(type_spec) .. "'") -- shunt/quicktype.yue:528
                                                                            end -- shunt/quicktype.yue:525
                                                                          end -- shunt/quicktype.yue:523
                                                                        end -- shunt/quicktype.yue:523
                                                                      end -- shunt/quicktype.yue:521
                                                                    end -- shunt/quicktype.yue:519
                                                                  end -- shunt/quicktype.yue:519
                                                                end -- shunt/quicktype.yue:517
                                                              end -- shunt/quicktype.yue:517
                                                            end -- shunt/quicktype.yue:515
                                                          end -- shunt/quicktype.yue:515
                                                        end -- shunt/quicktype.yue:513
                                                      end -- shunt/quicktype.yue:511
                                                    end -- shunt/quicktype.yue:509
                                                  end -- shunt/quicktype.yue:507
                                                end -- shunt/quicktype.yue:505
                                              end -- shunt/quicktype.yue:503
                                            end -- shunt/quicktype.yue:501
                                          end -- shunt/quicktype.yue:499
                                        end -- shunt/quicktype.yue:497
                                      end -- shunt/quicktype.yue:495
                                    end -- shunt/quicktype.yue:493
                                  end -- shunt/quicktype.yue:491
                                end -- shunt/quicktype.yue:489
                              end -- shunt/quicktype.yue:487
                            end -- shunt/quicktype.yue:485
                          end -- shunt/quicktype.yue:483
                        end -- shunt/quicktype.yue:481
                      end -- shunt/quicktype.yue:479
                    end -- shunt/quicktype.yue:477
                  end -- shunt/quicktype.yue:475
                end -- shunt/quicktype.yue:475
              end -- shunt/quicktype.yue:473
            end -- shunt/quicktype.yue:473
            self.index = self.index + bytes_consumed -- shunt/quicktype.yue:530
            if not (ty ~= nil) then -- shunt/quicktype.yue:531
              _continue_0 = true -- shunt/quicktype.yue:532
              break -- shunt/quicktype.yue:532
            end -- shunt/quicktype.yue:531
            coroutine.yield(Symbol(ty, value)) -- shunt/quicktype.yue:533
            _continue_0 = true -- shunt/quicktype.yue:473
          until true -- shunt/quicktype.yue:533
          if not _continue_0 then -- shunt/quicktype.yue:533
            break -- shunt/quicktype.yue:533
          end -- shunt/quicktype.yue:533
        end -- shunt/quicktype.yue:533
      end) -- shunt/quicktype.yue:471
    end, -- shunt/quicktype.yue:466
    __base = _base_0, -- shunt/quicktype.yue:466
    __name = "Lexer" -- shunt/quicktype.yue:466
  }, { -- shunt/quicktype.yue:466
    __index = _base_0, -- shunt/quicktype.yue:466
    __call = function(cls, ...) -- shunt/quicktype.yue:466
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:466
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:466
      return _self_0 -- shunt/quicktype.yue:466
    end -- shunt/quicktype.yue:466
  }) -- shunt/quicktype.yue:466
  _base_0.__class = _class_0 -- shunt/quicktype.yue:466
  Lexer = _class_0 -- shunt/quicktype.yue:466
end -- shunt/quicktype.yue:567
do -- shunt/quicktype.yue:569
  local _class_0 -- shunt/quicktype.yue:569
  local _base_0 = { } -- shunt/quicktype.yue:569
  if _base_0.__index == nil then -- shunt/quicktype.yue:569
    _base_0.__index = _base_0 -- shunt/quicktype.yue:569
  end -- shunt/quicktype.yue:570
  _class_0 = setmetatable({ -- shunt/quicktype.yue:569
    __init = function(self, index, peeked) -- shunt/quicktype.yue:570
      self.index = index -- shunt/quicktype.yue:570
      self.peeked = peeked -- shunt/quicktype.yue:570
    end, -- shunt/quicktype.yue:569
    __base = _base_0, -- shunt/quicktype.yue:569
    __name = "Checkpoint" -- shunt/quicktype.yue:569
  }, { -- shunt/quicktype.yue:569
    __index = _base_0, -- shunt/quicktype.yue:569
    __call = function(cls, ...) -- shunt/quicktype.yue:569
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:569
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:569
      return _self_0 -- shunt/quicktype.yue:569
    end -- shunt/quicktype.yue:569
  }) -- shunt/quicktype.yue:569
  _base_0.__class = _class_0 -- shunt/quicktype.yue:569
  Checkpoint = _class_0 -- shunt/quicktype.yue:569
end -- shunt/quicktype.yue:570
do -- shunt/quicktype.yue:572
  local _class_0 -- shunt/quicktype.yue:572
  local _base_0 = { -- shunt/quicktype.yue:572
    __tostring = function(self) -- shunt/quicktype.yue:575
      if (self.value ~= nil) then -- shunt/quicktype.yue:576
        return tostring(self.type) .. "(" .. tostring(self.value) .. ")" -- shunt/quicktype.yue:577
      else -- shunt/quicktype.yue:579
        return tostring(self.type) -- shunt/quicktype.yue:579
      end -- shunt/quicktype.yue:576
    end -- shunt/quicktype.yue:572
  } -- shunt/quicktype.yue:572
  if _base_0.__index == nil then -- shunt/quicktype.yue:572
    _base_0.__index = _base_0 -- shunt/quicktype.yue:572
  end -- shunt/quicktype.yue:579
  _class_0 = setmetatable({ -- shunt/quicktype.yue:572
    __init = function(self, type, value) -- shunt/quicktype.yue:573
      if value == nil then -- shunt/quicktype.yue:573
        value = nil -- shunt/quicktype.yue:573
      end -- shunt/quicktype.yue:573
      self.type = type -- shunt/quicktype.yue:573
      self.value = value -- shunt/quicktype.yue:573
    end, -- shunt/quicktype.yue:572
    __base = _base_0, -- shunt/quicktype.yue:572
    __name = "Symbol" -- shunt/quicktype.yue:572
  }, { -- shunt/quicktype.yue:572
    __index = _base_0, -- shunt/quicktype.yue:572
    __call = function(cls, ...) -- shunt/quicktype.yue:572
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:572
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:572
      return _self_0 -- shunt/quicktype.yue:572
    end -- shunt/quicktype.yue:572
  }) -- shunt/quicktype.yue:572
  _base_0.__class = _class_0 -- shunt/quicktype.yue:572
  Symbol = _class_0 -- shunt/quicktype.yue:572
end -- shunt/quicktype.yue:579
_module_0["Symbol"] = Symbol -- shunt/quicktype.yue:572
known_primitives = { -- shunt/quicktype.yue:582
  ["nil"] = true, -- shunt/quicktype.yue:582
  boolean = true, -- shunt/quicktype.yue:583
  number = true, -- shunt/quicktype.yue:584
  string = true, -- shunt/quicktype.yue:585
  ["function"] = true, -- shunt/quicktype.yue:586
  table = true, -- shunt/quicktype.yue:587
  thread = true, -- shunt/quicktype.yue:588
  userdata = true -- shunt/quicktype.yue:589
} -- shunt/quicktype.yue:581
named_type = function(name) -- shunt/quicktype.yue:591
  if (known_primitives[name] ~= nil) then -- shunt/quicktype.yue:592
    return Primitive(name) -- shunt/quicktype.yue:593
  else -- shunt/quicktype.yue:594
    if name == 'any' then -- shunt/quicktype.yue:594
      return Any() -- shunt/quicktype.yue:595
    else -- shunt/quicktype.yue:596
      if name == 'some' then -- shunt/quicktype.yue:596
        return Some() -- shunt/quicktype.yue:597
      else -- shunt/quicktype.yue:598
        if not name:match('^[A-Z]') then -- shunt/quicktype.yue:598
          return error("cannot use '" .. tostring(name) .. "' as user type name: name must start with an uppercase letter") -- shunt/quicktype.yue:599
        else -- shunt/quicktype.yue:601
          return UserType(name) -- shunt/quicktype.yue:601
        end -- shunt/quicktype.yue:598
      end -- shunt/quicktype.yue:596
    end -- shunt/quicktype.yue:594
  end -- shunt/quicktype.yue:592
end -- shunt/quicktype.yue:591
prefixed_named_type = function(prefixed_name) -- shunt/quicktype.yue:603
  local prefix, name = prefixed_name:match('^([^.]+)%.([^.]*)$') -- shunt/quicktype.yue:604
  if not (prefix ~= nil) or not (name ~= nil) then -- shunt/quicktype.yue:605
    error("internal error: cannot parse prefixed name '" .. tostring(prefixed_name) .. "'") -- shunt/quicktype.yue:606
  end -- shunt/quicktype.yue:605
  if (known_primitives[prefix] ~= nil) then -- shunt/quicktype.yue:607
    error("cannot use '" .. tostring(prefix) .. "' as type-prefix: must not be a primitive") -- shunt/quicktype.yue:608
  end -- shunt/quicktype.yue:607
  if not prefix:match('^[a-z]') then -- shunt/quicktype.yue:609
    error("cannot use '" .. tostring(prefix) .. "' as type-prefix: must start with a lowercase letter") -- shunt/quicktype.yue:610
  end -- shunt/quicktype.yue:609
  if not name:match('^[A-Z]') then -- shunt/quicktype.yue:611
    error("cannot use '" .. tostring(name) .. "' as disambiguated type name: must start with an uppercase letter") -- shunt/quicktype.yue:612
  end -- shunt/quicktype.yue:611
  return UserType(prefixed_name) -- shunt/quicktype.yue:613
end -- shunt/quicktype.yue:603
do -- shunt/quicktype.yue:615
  local _class_0 -- shunt/quicktype.yue:615
  local _base_0 = { -- shunt/quicktype.yue:615
    is = function(self, ty) -- shunt/quicktype.yue:616
      return getmetatable(self).__class.__name == ty.__base.__class.__name -- shunt/quicktype.yue:617
    end -- shunt/quicktype.yue:615
  } -- shunt/quicktype.yue:615
  if _base_0.__index == nil then -- shunt/quicktype.yue:615
    _base_0.__index = _base_0 -- shunt/quicktype.yue:615
  end -- shunt/quicktype.yue:617
  _class_0 = setmetatable({ -- shunt/quicktype.yue:615
    __init = function() end, -- shunt/quicktype.yue:615
    __base = _base_0, -- shunt/quicktype.yue:615
    __name = "Is" -- shunt/quicktype.yue:615
  }, { -- shunt/quicktype.yue:615
    __index = _base_0, -- shunt/quicktype.yue:615
    __call = function(cls, ...) -- shunt/quicktype.yue:615
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:615
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:615
      return _self_0 -- shunt/quicktype.yue:615
    end -- shunt/quicktype.yue:615
  }) -- shunt/quicktype.yue:615
  _base_0.__class = _class_0 -- shunt/quicktype.yue:615
  Is = _class_0 -- shunt/quicktype.yue:615
end -- shunt/quicktype.yue:617
do -- shunt/quicktype.yue:619
  local _class_0 -- shunt/quicktype.yue:619
  local _base_0 = { -- shunt/quicktype.yue:619
    __tostring = function(self) -- shunt/quicktype.yue:622
      return self.name -- shunt/quicktype.yue:622
    end, -- shunt/quicktype.yue:624
    checker = function(self, checker_builder) -- shunt/quicktype.yue:624
      if checker_builder == nil then -- shunt/quicktype.yue:624
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:624
      end -- shunt/quicktype.yue:624
      checker_builder:add(C_ASSERT_PRIMITIVE, self.name) -- shunt/quicktype.yue:626
      return checker_builder -- shunt/quicktype.yue:625
    end -- shunt/quicktype.yue:619
  } -- shunt/quicktype.yue:619
  local _list_0 = { -- shunt/quicktype.yue:619
    Is -- shunt/quicktype.yue:619
  } -- shunt/quicktype.yue:619
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:626
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:619
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:619
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:626
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:619
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:619
      end -- shunt/quicktype.yue:619
    end -- shunt/quicktype.yue:626
  end -- shunt/quicktype.yue:626
  if _base_0.__index == nil then -- shunt/quicktype.yue:619
    _base_0.__index = _base_0 -- shunt/quicktype.yue:619
  end -- shunt/quicktype.yue:626
  _class_0 = setmetatable({ -- shunt/quicktype.yue:619
    __init = function(self, name) -- shunt/quicktype.yue:620
      self.name = name -- shunt/quicktype.yue:620
    end, -- shunt/quicktype.yue:619
    __base = _base_0, -- shunt/quicktype.yue:619
    __name = "Primitive" -- shunt/quicktype.yue:619
  }, { -- shunt/quicktype.yue:619
    __index = _base_0, -- shunt/quicktype.yue:619
    __call = function(cls, ...) -- shunt/quicktype.yue:619
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:619
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:619
      return _self_0 -- shunt/quicktype.yue:619
    end -- shunt/quicktype.yue:619
  }) -- shunt/quicktype.yue:619
  _base_0.__class = _class_0 -- shunt/quicktype.yue:619
  Primitive = _class_0 -- shunt/quicktype.yue:619
end -- shunt/quicktype.yue:626
do -- shunt/quicktype.yue:628
  local _class_0 -- shunt/quicktype.yue:628
  local _base_0 = { -- shunt/quicktype.yue:628
    __tostring = function(self) -- shunt/quicktype.yue:629
      return 'any' -- shunt/quicktype.yue:630
    end, -- shunt/quicktype.yue:632
    checker = function(self, checker_builder) -- shunt/quicktype.yue:632
      if checker_builder == nil then -- shunt/quicktype.yue:632
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:632
      end -- shunt/quicktype.yue:632
      return checker_builder -- shunt/quicktype.yue:633
    end -- shunt/quicktype.yue:628
  } -- shunt/quicktype.yue:628
  local _list_0 = { -- shunt/quicktype.yue:628
    Is -- shunt/quicktype.yue:628
  } -- shunt/quicktype.yue:628
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:633
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:628
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:628
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:633
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:628
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:628
      end -- shunt/quicktype.yue:628
    end -- shunt/quicktype.yue:633
  end -- shunt/quicktype.yue:633
  if _base_0.__index == nil then -- shunt/quicktype.yue:628
    _base_0.__index = _base_0 -- shunt/quicktype.yue:628
  end -- shunt/quicktype.yue:633
  _class_0 = setmetatable({ -- shunt/quicktype.yue:628
    __init = function() end, -- shunt/quicktype.yue:628
    __base = _base_0, -- shunt/quicktype.yue:628
    __name = "Any" -- shunt/quicktype.yue:628
  }, { -- shunt/quicktype.yue:628
    __index = _base_0, -- shunt/quicktype.yue:628
    __call = function(cls, ...) -- shunt/quicktype.yue:628
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:628
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:628
      return _self_0 -- shunt/quicktype.yue:628
    end -- shunt/quicktype.yue:628
  }) -- shunt/quicktype.yue:628
  _base_0.__class = _class_0 -- shunt/quicktype.yue:628
  Any = _class_0 -- shunt/quicktype.yue:628
end -- shunt/quicktype.yue:633
do -- shunt/quicktype.yue:635
  local _class_0 -- shunt/quicktype.yue:635
  local _base_0 = { -- shunt/quicktype.yue:635
    __tostring = function(self) -- shunt/quicktype.yue:636
      return 'some' -- shunt/quicktype.yue:637
    end, -- shunt/quicktype.yue:639
    checker = function(self, checker_builder) -- shunt/quicktype.yue:639
      if checker_builder == nil then -- shunt/quicktype.yue:639
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:639
      end -- shunt/quicktype.yue:639
      checker_builder:add(C_ASSERT_NON_NIL) -- shunt/quicktype.yue:641
      return checker_builder -- shunt/quicktype.yue:640
    end -- shunt/quicktype.yue:635
  } -- shunt/quicktype.yue:635
  local _list_0 = { -- shunt/quicktype.yue:635
    Is -- shunt/quicktype.yue:635
  } -- shunt/quicktype.yue:635
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:641
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:635
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:635
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:641
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:635
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:635
      end -- shunt/quicktype.yue:635
    end -- shunt/quicktype.yue:641
  end -- shunt/quicktype.yue:641
  if _base_0.__index == nil then -- shunt/quicktype.yue:635
    _base_0.__index = _base_0 -- shunt/quicktype.yue:635
  end -- shunt/quicktype.yue:641
  _class_0 = setmetatable({ -- shunt/quicktype.yue:635
    __init = function() end, -- shunt/quicktype.yue:635
    __base = _base_0, -- shunt/quicktype.yue:635
    __name = "Some" -- shunt/quicktype.yue:635
  }, { -- shunt/quicktype.yue:635
    __index = _base_0, -- shunt/quicktype.yue:635
    __call = function(cls, ...) -- shunt/quicktype.yue:635
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:635
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:635
      return _self_0 -- shunt/quicktype.yue:635
    end -- shunt/quicktype.yue:635
  }) -- shunt/quicktype.yue:635
  _base_0.__class = _class_0 -- shunt/quicktype.yue:635
  Some = _class_0 -- shunt/quicktype.yue:635
end -- shunt/quicktype.yue:641
do -- shunt/quicktype.yue:643
  local _class_0 -- shunt/quicktype.yue:643
  local _base_0 = { -- shunt/quicktype.yue:643
    __tostring = function(self) -- shunt/quicktype.yue:644
      return '!' -- shunt/quicktype.yue:645
    end, -- shunt/quicktype.yue:647
    checker = function(self, checker_builder) -- shunt/quicktype.yue:647
      if checker_builder == nil then -- shunt/quicktype.yue:647
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:647
      end -- shunt/quicktype.yue:647
      checker_builder:add(C_ASSERT_NEVER) -- shunt/quicktype.yue:649
      return checker_builder -- shunt/quicktype.yue:648
    end -- shunt/quicktype.yue:643
  } -- shunt/quicktype.yue:643
  local _list_0 = { -- shunt/quicktype.yue:643
    Is -- shunt/quicktype.yue:643
  } -- shunt/quicktype.yue:643
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:649
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:643
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:643
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:649
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:643
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:643
      end -- shunt/quicktype.yue:643
    end -- shunt/quicktype.yue:649
  end -- shunt/quicktype.yue:649
  if _base_0.__index == nil then -- shunt/quicktype.yue:643
    _base_0.__index = _base_0 -- shunt/quicktype.yue:643
  end -- shunt/quicktype.yue:649
  _class_0 = setmetatable({ -- shunt/quicktype.yue:643
    __init = function() end, -- shunt/quicktype.yue:643
    __base = _base_0, -- shunt/quicktype.yue:643
    __name = "Never" -- shunt/quicktype.yue:643
  }, { -- shunt/quicktype.yue:643
    __index = _base_0, -- shunt/quicktype.yue:643
    __call = function(cls, ...) -- shunt/quicktype.yue:643
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:643
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:643
      return _self_0 -- shunt/quicktype.yue:643
    end -- shunt/quicktype.yue:643
  }) -- shunt/quicktype.yue:643
  _base_0.__class = _class_0 -- shunt/quicktype.yue:643
  Never = _class_0 -- shunt/quicktype.yue:643
end -- shunt/quicktype.yue:649
do -- shunt/quicktype.yue:651
  local _class_0 -- shunt/quicktype.yue:651
  local _base_0 = { -- shunt/quicktype.yue:651
    __tostring = function(self) -- shunt/quicktype.yue:654
      return self.name -- shunt/quicktype.yue:654
    end, -- shunt/quicktype.yue:656
    checker = function(self, checker_builder) -- shunt/quicktype.yue:656
      if checker_builder == nil then -- shunt/quicktype.yue:656
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:656
      end -- shunt/quicktype.yue:656
      local parsed_user_type = user_types[self.name] -- shunt/quicktype.yue:658
      if not (parsed_user_type ~= nil) or checker_builder:already_building(self) then -- shunt/quicktype.yue:659
        checker_builder:add(C_PUSH_CHECKER, self.name) -- shunt/quicktype.yue:660
      else -- shunt/quicktype.yue:662
        checker_builder:push_building(self) -- shunt/quicktype.yue:662
        parsed_user_type:checker(checker_builder) -- shunt/quicktype.yue:663
        checker_builder:pop_building(self) -- shunt/quicktype.yue:664
      end -- shunt/quicktype.yue:659
      return checker_builder -- shunt/quicktype.yue:657
    end -- shunt/quicktype.yue:651
  } -- shunt/quicktype.yue:651
  local _list_0 = { -- shunt/quicktype.yue:651
    Is -- shunt/quicktype.yue:651
  } -- shunt/quicktype.yue:651
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:664
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:651
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:651
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:664
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:651
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:651
      end -- shunt/quicktype.yue:651
    end -- shunt/quicktype.yue:664
  end -- shunt/quicktype.yue:664
  if _base_0.__index == nil then -- shunt/quicktype.yue:651
    _base_0.__index = _base_0 -- shunt/quicktype.yue:651
  end -- shunt/quicktype.yue:664
  _class_0 = setmetatable({ -- shunt/quicktype.yue:651
    __init = function(self, name) -- shunt/quicktype.yue:652
      self.name = name -- shunt/quicktype.yue:652
    end, -- shunt/quicktype.yue:651
    __base = _base_0, -- shunt/quicktype.yue:651
    __name = "UserType" -- shunt/quicktype.yue:651
  }, { -- shunt/quicktype.yue:651
    __index = _base_0, -- shunt/quicktype.yue:651
    __call = function(cls, ...) -- shunt/quicktype.yue:651
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:651
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:651
      return _self_0 -- shunt/quicktype.yue:651
    end -- shunt/quicktype.yue:651
  }) -- shunt/quicktype.yue:651
  _base_0.__class = _class_0 -- shunt/quicktype.yue:651
  UserType = _class_0 -- shunt/quicktype.yue:651
end -- shunt/quicktype.yue:664
do -- shunt/quicktype.yue:666
  local _class_0 -- shunt/quicktype.yue:666
  local _base_0 = { -- shunt/quicktype.yue:666
    __tostring = function(self) -- shunt/quicktype.yue:669
      return self.name -- shunt/quicktype.yue:669
    end, -- shunt/quicktype.yue:671
    checker = function(self, checker_builder) -- shunt/quicktype.yue:671
      if checker_builder == nil then -- shunt/quicktype.yue:671
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:671
      end -- shunt/quicktype.yue:671
      checker_builder:add(C_ASSERT_EQ, self.value) -- shunt/quicktype.yue:673
      return checker_builder -- shunt/quicktype.yue:672
    end -- shunt/quicktype.yue:666
  } -- shunt/quicktype.yue:666
  local _list_0 = { -- shunt/quicktype.yue:666
    Is -- shunt/quicktype.yue:666
  } -- shunt/quicktype.yue:666
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:673
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:666
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:666
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:673
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:666
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:666
      end -- shunt/quicktype.yue:666
    end -- shunt/quicktype.yue:673
  end -- shunt/quicktype.yue:673
  if _base_0.__index == nil then -- shunt/quicktype.yue:666
    _base_0.__index = _base_0 -- shunt/quicktype.yue:666
  end -- shunt/quicktype.yue:673
  _class_0 = setmetatable({ -- shunt/quicktype.yue:666
    __init = function(self, name, value) -- shunt/quicktype.yue:667
      self.name = name -- shunt/quicktype.yue:667
      self.value = value -- shunt/quicktype.yue:667
    end, -- shunt/quicktype.yue:666
    __base = _base_0, -- shunt/quicktype.yue:666
    __name = "SingletonType" -- shunt/quicktype.yue:666
  }, { -- shunt/quicktype.yue:666
    __index = _base_0, -- shunt/quicktype.yue:666
    __call = function(cls, ...) -- shunt/quicktype.yue:666
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:666
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:666
      return _self_0 -- shunt/quicktype.yue:666
    end -- shunt/quicktype.yue:666
  }) -- shunt/quicktype.yue:666
  _base_0.__class = _class_0 -- shunt/quicktype.yue:666
  SingletonType = _class_0 -- shunt/quicktype.yue:666
end -- shunt/quicktype.yue:673
do -- shunt/quicktype.yue:675
  local _class_0 -- shunt/quicktype.yue:675
  local _base_0 = { -- shunt/quicktype.yue:675
    __tostring = function(self) -- shunt/quicktype.yue:678
      return tostring(self.value) -- shunt/quicktype.yue:679
    end, -- shunt/quicktype.yue:681
    checker = function(self, checker_builder) -- shunt/quicktype.yue:681
      if checker_builder == nil then -- shunt/quicktype.yue:681
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:681
      end -- shunt/quicktype.yue:681
      checker_builder:add(C_ASSERT_PRIMITIVE, 'boolean') -- shunt/quicktype.yue:683
      checker_builder:add(C_ASSERT_EQ, self.value) -- shunt/quicktype.yue:684
      return checker_builder -- shunt/quicktype.yue:682
    end -- shunt/quicktype.yue:675
  } -- shunt/quicktype.yue:675
  local _list_0 = { -- shunt/quicktype.yue:675
    Is -- shunt/quicktype.yue:675
  } -- shunt/quicktype.yue:675
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:684
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:675
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:675
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:684
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:675
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:675
      end -- shunt/quicktype.yue:675
    end -- shunt/quicktype.yue:684
  end -- shunt/quicktype.yue:684
  if _base_0.__index == nil then -- shunt/quicktype.yue:675
    _base_0.__index = _base_0 -- shunt/quicktype.yue:675
  end -- shunt/quicktype.yue:684
  _class_0 = setmetatable({ -- shunt/quicktype.yue:675
    __init = function(self, value) -- shunt/quicktype.yue:676
      self.value = value -- shunt/quicktype.yue:676
    end, -- shunt/quicktype.yue:675
    __base = _base_0, -- shunt/quicktype.yue:675
    __name = "BooleanType" -- shunt/quicktype.yue:675
  }, { -- shunt/quicktype.yue:675
    __index = _base_0, -- shunt/quicktype.yue:675
    __call = function(cls, ...) -- shunt/quicktype.yue:675
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:675
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:675
      return _self_0 -- shunt/quicktype.yue:675
    end -- shunt/quicktype.yue:675
  }) -- shunt/quicktype.yue:675
  _base_0.__class = _class_0 -- shunt/quicktype.yue:675
  BooleanType = _class_0 -- shunt/quicktype.yue:675
end -- shunt/quicktype.yue:684
do -- shunt/quicktype.yue:686
  local _class_0 -- shunt/quicktype.yue:686
  local _base_0 = { -- shunt/quicktype.yue:686
    __tostring = function(self) -- shunt/quicktype.yue:689
      return tostring(self.value) -- shunt/quicktype.yue:690
    end, -- shunt/quicktype.yue:692
    checker = function(self, checker_builder) -- shunt/quicktype.yue:692
      if checker_builder == nil then -- shunt/quicktype.yue:692
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:692
      end -- shunt/quicktype.yue:692
      checker_builder:add(C_ASSERT_PRIMITIVE, 'number') -- shunt/quicktype.yue:694
      checker_builder:add(C_ASSERT_EQ, self.value) -- shunt/quicktype.yue:695
      return checker_builder -- shunt/quicktype.yue:693
    end -- shunt/quicktype.yue:686
  } -- shunt/quicktype.yue:686
  local _list_0 = { -- shunt/quicktype.yue:686
    Is -- shunt/quicktype.yue:686
  } -- shunt/quicktype.yue:686
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:695
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:686
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:686
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:695
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:686
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:686
      end -- shunt/quicktype.yue:686
    end -- shunt/quicktype.yue:695
  end -- shunt/quicktype.yue:695
  if _base_0.__index == nil then -- shunt/quicktype.yue:686
    _base_0.__index = _base_0 -- shunt/quicktype.yue:686
  end -- shunt/quicktype.yue:695
  _class_0 = setmetatable({ -- shunt/quicktype.yue:686
    __init = function(self, value) -- shunt/quicktype.yue:687
      self.value = value -- shunt/quicktype.yue:687
    end, -- shunt/quicktype.yue:686
    __base = _base_0, -- shunt/quicktype.yue:686
    __name = "NumberType" -- shunt/quicktype.yue:686
  }, { -- shunt/quicktype.yue:686
    __index = _base_0, -- shunt/quicktype.yue:686
    __call = function(cls, ...) -- shunt/quicktype.yue:686
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:686
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:686
      return _self_0 -- shunt/quicktype.yue:686
    end -- shunt/quicktype.yue:686
  }) -- shunt/quicktype.yue:686
  _base_0.__class = _class_0 -- shunt/quicktype.yue:686
  NumberType = _class_0 -- shunt/quicktype.yue:686
end -- shunt/quicktype.yue:695
do -- shunt/quicktype.yue:697
  local _class_0 -- shunt/quicktype.yue:697
  local _base_0 = { -- shunt/quicktype.yue:697
    __tostring = function(self) -- shunt/quicktype.yue:700
      return "\"" .. tostring(self.content) .. "\"" -- shunt/quicktype.yue:701
    end, -- shunt/quicktype.yue:703
    checker = function(self, checker_builder) -- shunt/quicktype.yue:703
      if checker_builder == nil then -- shunt/quicktype.yue:703
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:703
      end -- shunt/quicktype.yue:703
      checker_builder:add(C_ASSERT_PRIMITIVE, 'string') -- shunt/quicktype.yue:705
      checker_builder:add(C_ASSERT_EQ, self.content) -- shunt/quicktype.yue:706
      return checker_builder -- shunt/quicktype.yue:704
    end -- shunt/quicktype.yue:697
  } -- shunt/quicktype.yue:697
  local _list_0 = { -- shunt/quicktype.yue:697
    Is -- shunt/quicktype.yue:697
  } -- shunt/quicktype.yue:697
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:706
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:697
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:697
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:706
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:697
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:697
      end -- shunt/quicktype.yue:697
    end -- shunt/quicktype.yue:706
  end -- shunt/quicktype.yue:706
  if _base_0.__index == nil then -- shunt/quicktype.yue:697
    _base_0.__index = _base_0 -- shunt/quicktype.yue:697
  end -- shunt/quicktype.yue:706
  _class_0 = setmetatable({ -- shunt/quicktype.yue:697
    __init = function(self, content) -- shunt/quicktype.yue:698
      self.content = content -- shunt/quicktype.yue:698
    end, -- shunt/quicktype.yue:697
    __base = _base_0, -- shunt/quicktype.yue:697
    __name = "StringType" -- shunt/quicktype.yue:697
  }, { -- shunt/quicktype.yue:697
    __index = _base_0, -- shunt/quicktype.yue:697
    __call = function(cls, ...) -- shunt/quicktype.yue:697
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:697
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:697
      return _self_0 -- shunt/quicktype.yue:697
    end -- shunt/quicktype.yue:697
  }) -- shunt/quicktype.yue:697
  _base_0.__class = _class_0 -- shunt/quicktype.yue:697
  StringType = _class_0 -- shunt/quicktype.yue:697
end -- shunt/quicktype.yue:706
do -- shunt/quicktype.yue:708
  local _class_0 -- shunt/quicktype.yue:708
  local _base_0 = { -- shunt/quicktype.yue:708
    __tostring = function(self) -- shunt/quicktype.yue:711
      return "?" .. tostring(self.inner_type) -- shunt/quicktype.yue:712
    end, -- shunt/quicktype.yue:714
    checker = function(self, checker_builder) -- shunt/quicktype.yue:714
      if checker_builder == nil then -- shunt/quicktype.yue:714
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:714
      end -- shunt/quicktype.yue:714
      local inner_skip_target = checker_builder:add_with_unresolved_target(C_JMP_IF_NIL) -- shunt/quicktype.yue:716
      self.inner_type:checker(checker_builder) -- shunt/quicktype.yue:717
      inner_skip_target:resolve_here() -- shunt/quicktype.yue:718
      return checker_builder -- shunt/quicktype.yue:715
    end -- shunt/quicktype.yue:708
  } -- shunt/quicktype.yue:708
  local _list_0 = { -- shunt/quicktype.yue:708
    Is -- shunt/quicktype.yue:708
  } -- shunt/quicktype.yue:708
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:718
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:708
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:708
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:718
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:708
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:708
      end -- shunt/quicktype.yue:708
    end -- shunt/quicktype.yue:718
  end -- shunt/quicktype.yue:718
  if _base_0.__index == nil then -- shunt/quicktype.yue:708
    _base_0.__index = _base_0 -- shunt/quicktype.yue:708
  end -- shunt/quicktype.yue:718
  _class_0 = setmetatable({ -- shunt/quicktype.yue:708
    __init = function(self, inner_type) -- shunt/quicktype.yue:709
      self.inner_type = inner_type -- shunt/quicktype.yue:709
    end, -- shunt/quicktype.yue:708
    __base = _base_0, -- shunt/quicktype.yue:708
    __name = "Optional" -- shunt/quicktype.yue:708
  }, { -- shunt/quicktype.yue:708
    __index = _base_0, -- shunt/quicktype.yue:708
    __call = function(cls, ...) -- shunt/quicktype.yue:708
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:708
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:708
      return _self_0 -- shunt/quicktype.yue:708
    end -- shunt/quicktype.yue:708
  }) -- shunt/quicktype.yue:708
  _base_0.__class = _class_0 -- shunt/quicktype.yue:708
  Optional = _class_0 -- shunt/quicktype.yue:708
end -- shunt/quicktype.yue:718
do -- shunt/quicktype.yue:720
  local _class_0 -- shunt/quicktype.yue:720
  local _base_0 = { -- shunt/quicktype.yue:720
    table_like = function(self, _table_like) -- shunt/quicktype.yue:724
      self._table_like = _table_like -- shunt/quicktype.yue:724
      return self -- shunt/quicktype.yue:725
    end, -- shunt/quicktype.yue:727
    __tostring = function(self) -- shunt/quicktype.yue:727
      return "[" .. tostring(self.elem_type) .. "]" -- shunt/quicktype.yue:728
    end, -- shunt/quicktype.yue:730
    checker = function(self, checker_builder) -- shunt/quicktype.yue:730
      if checker_builder == nil then -- shunt/quicktype.yue:730
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:730
      end -- shunt/quicktype.yue:730
      if self._table_like then -- shunt/quicktype.yue:731
        error("table-like arrays are not supported") -- shunt/quicktype.yue:732
      end -- shunt/quicktype.yue:731
      checker_builder:add(C_ASSERT_PRIMITIVE, 'table') -- shunt/quicktype.yue:734
      checker_builder:add(C_PUSH, 1) -- shunt/quicktype.yue:735
      local loop_start = checker_builder:add_labelled(C_GET_FIELD) -- shunt/quicktype.yue:737
      local loop_exit_target = checker_builder:add_with_unresolved_target(C_JMP_IF_NIL) -- shunt/quicktype.yue:739
      self.elem_type:checker(checker_builder) -- shunt/quicktype.yue:740
      checker_builder:add(C_POP) -- shunt/quicktype.yue:741
      checker_builder:add(C_INCR) -- shunt/quicktype.yue:742
      checker_builder:add(C_JMP, loop_start.index) -- shunt/quicktype.yue:743
      loop_exit_target:resolve_here() -- shunt/quicktype.yue:745
      checker_builder:add(C_POP) -- shunt/quicktype.yue:746
      checker_builder:add(C_DECR) -- shunt/quicktype.yue:747
      checker_builder:add(C_ASSERT_LEN) -- shunt/quicktype.yue:748
      checker_builder:add(C_POP) -- shunt/quicktype.yue:749
      return checker_builder -- shunt/quicktype.yue:733
    end -- shunt/quicktype.yue:720
  } -- shunt/quicktype.yue:720
  local _list_0 = { -- shunt/quicktype.yue:720
    Is -- shunt/quicktype.yue:720
  } -- shunt/quicktype.yue:720
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:749
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:720
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:720
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:749
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:720
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:720
      end -- shunt/quicktype.yue:720
    end -- shunt/quicktype.yue:749
  end -- shunt/quicktype.yue:749
  if _base_0.__index == nil then -- shunt/quicktype.yue:720
    _base_0.__index = _base_0 -- shunt/quicktype.yue:720
  end -- shunt/quicktype.yue:749
  _class_0 = setmetatable({ -- shunt/quicktype.yue:720
    __init = function(self, elem_type) -- shunt/quicktype.yue:721
      self.elem_type = elem_type -- shunt/quicktype.yue:721
      self._table_like = false -- shunt/quicktype.yue:722
    end, -- shunt/quicktype.yue:720
    __base = _base_0, -- shunt/quicktype.yue:720
    __name = "Array" -- shunt/quicktype.yue:720
  }, { -- shunt/quicktype.yue:720
    __index = _base_0, -- shunt/quicktype.yue:720
    __call = function(cls, ...) -- shunt/quicktype.yue:720
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:720
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:720
      return _self_0 -- shunt/quicktype.yue:720
    end -- shunt/quicktype.yue:720
  }) -- shunt/quicktype.yue:720
  _base_0.__class = _class_0 -- shunt/quicktype.yue:720
  Array = _class_0 -- shunt/quicktype.yue:720
end -- shunt/quicktype.yue:749
do -- shunt/quicktype.yue:751
  local _class_0 -- shunt/quicktype.yue:751
  local _base_0 = { -- shunt/quicktype.yue:751
    table_like = function(self, _table_like) -- shunt/quicktype.yue:755
      self._table_like = _table_like -- shunt/quicktype.yue:755
      return self -- shunt/quicktype.yue:756
    end, -- shunt/quicktype.yue:758
    __tostring = function(self) -- shunt/quicktype.yue:758
      local elem_type_reprs -- shunt/quicktype.yue:759
      do -- shunt/quicktype.yue:759
        local _accum_0 = { } -- shunt/quicktype.yue:759
        local _len_0 = 1 -- shunt/quicktype.yue:759
        local _list_0 = self.elem_types -- shunt/quicktype.yue:759
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:759
          local elem_type = _list_0[_index_0] -- shunt/quicktype.yue:759
          _accum_0[_len_0] = tostring(elem_type) -- shunt/quicktype.yue:759
          _len_0 = _len_0 + 1 -- shunt/quicktype.yue:759
        end -- shunt/quicktype.yue:759
        elem_type_reprs = _accum_0 -- shunt/quicktype.yue:759
      end -- shunt/quicktype.yue:759
      return "(" .. tostring(table.concat(elem_type_reprs, ', ')) .. ")" -- shunt/quicktype.yue:760
    end, -- shunt/quicktype.yue:762
    checker = function(self, checker_builder) -- shunt/quicktype.yue:762
      if checker_builder == nil then -- shunt/quicktype.yue:762
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:762
      end -- shunt/quicktype.yue:762
      if self._table_like then -- shunt/quicktype.yue:763
        error("table-like arrays are not supported") -- shunt/quicktype.yue:764
      end -- shunt/quicktype.yue:763
      checker_builder:add(C_ASSERT_PRIMITIVE, 'table') -- shunt/quicktype.yue:766
      for i = 1, #self.elem_types do -- shunt/quicktype.yue:768
        checker_builder:add(C_PUSH, i) -- shunt/quicktype.yue:769
        checker_builder:add(C_GET_FIELD) -- shunt/quicktype.yue:770
        self.elem_types[i]:checker(checker_builder) -- shunt/quicktype.yue:771
        checker_builder:add(C_POP) -- shunt/quicktype.yue:772
        checker_builder:add(C_POP) -- shunt/quicktype.yue:773
      end -- shunt/quicktype.yue:773
      return checker_builder -- shunt/quicktype.yue:765
    end -- shunt/quicktype.yue:751
  } -- shunt/quicktype.yue:751
  local _list_0 = { -- shunt/quicktype.yue:751
    Is -- shunt/quicktype.yue:751
  } -- shunt/quicktype.yue:751
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:773
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:751
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:751
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:773
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:751
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:751
      end -- shunt/quicktype.yue:751
    end -- shunt/quicktype.yue:773
  end -- shunt/quicktype.yue:773
  if _base_0.__index == nil then -- shunt/quicktype.yue:751
    _base_0.__index = _base_0 -- shunt/quicktype.yue:751
  end -- shunt/quicktype.yue:773
  _class_0 = setmetatable({ -- shunt/quicktype.yue:751
    __init = function(self, elem_types) -- shunt/quicktype.yue:752
      self.elem_types = elem_types -- shunt/quicktype.yue:752
      self._table_like = false -- shunt/quicktype.yue:753
    end, -- shunt/quicktype.yue:751
    __base = _base_0, -- shunt/quicktype.yue:751
    __name = "Tuple" -- shunt/quicktype.yue:751
  }, { -- shunt/quicktype.yue:751
    __index = _base_0, -- shunt/quicktype.yue:751
    __call = function(cls, ...) -- shunt/quicktype.yue:751
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:751
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:751
      return _self_0 -- shunt/quicktype.yue:751
    end -- shunt/quicktype.yue:751
  }) -- shunt/quicktype.yue:751
  _base_0.__class = _class_0 -- shunt/quicktype.yue:751
  Tuple = _class_0 -- shunt/quicktype.yue:751
end -- shunt/quicktype.yue:773
do -- shunt/quicktype.yue:775
  local _class_0 -- shunt/quicktype.yue:775
  local _base_0 = { -- shunt/quicktype.yue:775
    table_like = function(self, _table_like) -- shunt/quicktype.yue:779
      self._table_like = _table_like -- shunt/quicktype.yue:779
      return self -- shunt/quicktype.yue:780
    end, -- shunt/quicktype.yue:782
    __tostring = function(self) -- shunt/quicktype.yue:782
      local field_reprs -- shunt/quicktype.yue:783
      do -- shunt/quicktype.yue:783
        local _accum_0 = { } -- shunt/quicktype.yue:783
        local _len_0 = 1 -- shunt/quicktype.yue:783
        local _list_0 = self.fields -- shunt/quicktype.yue:783
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:783
          local field = _list_0[_index_0] -- shunt/quicktype.yue:783
          _accum_0[_len_0] = tostring(field) -- shunt/quicktype.yue:783
          _len_0 = _len_0 + 1 -- shunt/quicktype.yue:783
        end -- shunt/quicktype.yue:783
        field_reprs = _accum_0 -- shunt/quicktype.yue:783
      end -- shunt/quicktype.yue:783
      return "{" .. tostring(table.concat(field_reprs, ', ')) .. "}" -- shunt/quicktype.yue:784
    end, -- shunt/quicktype.yue:786
    checker = function(self, checker_builder) -- shunt/quicktype.yue:786
      if checker_builder == nil then -- shunt/quicktype.yue:786
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:786
      end -- shunt/quicktype.yue:786
      if self._table_like then -- shunt/quicktype.yue:788
        checker_builder:add(C_ASSERT_TABLE_LIKE) -- shunt/quicktype.yue:789
      else -- shunt/quicktype.yue:791
        checker_builder:add(C_ASSERT_PRIMITIVE, 'table') -- shunt/quicktype.yue:791
      end -- shunt/quicktype.yue:788
      if (self.metatable_type ~= nil) then -- shunt/quicktype.yue:793
        checker_builder:add(C_PUSH_METATABLE) -- shunt/quicktype.yue:794
        self.metatable_type:checker(checker_builder) -- shunt/quicktype.yue:795
        checker_builder:add(C_POP) -- shunt/quicktype.yue:796
      end -- shunt/quicktype.yue:793
      local _list_0 = self.fields -- shunt/quicktype.yue:797
      for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:797
        local field = _list_0[_index_0] -- shunt/quicktype.yue:797
        checker_builder:add(C_PUSH, field.name) -- shunt/quicktype.yue:798
        checker_builder:add(C_GET_FIELD) -- shunt/quicktype.yue:799
        field:checker(checker_builder) -- shunt/quicktype.yue:800
        checker_builder:add(C_POP) -- shunt/quicktype.yue:801
        checker_builder:add(C_POP) -- shunt/quicktype.yue:802
      end -- shunt/quicktype.yue:802
      return checker_builder -- shunt/quicktype.yue:787
    end -- shunt/quicktype.yue:775
  } -- shunt/quicktype.yue:775
  local _list_0 = { -- shunt/quicktype.yue:775
    Is -- shunt/quicktype.yue:775
  } -- shunt/quicktype.yue:775
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:802
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:775
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:775
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:802
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:775
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:775
      end -- shunt/quicktype.yue:775
    end -- shunt/quicktype.yue:802
  end -- shunt/quicktype.yue:802
  if _base_0.__index == nil then -- shunt/quicktype.yue:775
    _base_0.__index = _base_0 -- shunt/quicktype.yue:775
  end -- shunt/quicktype.yue:802
  _class_0 = setmetatable({ -- shunt/quicktype.yue:775
    __init = function(self, metatable_type, fields) -- shunt/quicktype.yue:776
      self.metatable_type = metatable_type -- shunt/quicktype.yue:776
      self.fields = fields -- shunt/quicktype.yue:776
      self._table_like = false -- shunt/quicktype.yue:777
    end, -- shunt/quicktype.yue:775
    __base = _base_0, -- shunt/quicktype.yue:775
    __name = "Struct" -- shunt/quicktype.yue:775
  }, { -- shunt/quicktype.yue:775
    __index = _base_0, -- shunt/quicktype.yue:775
    __call = function(cls, ...) -- shunt/quicktype.yue:775
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:775
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:775
      return _self_0 -- shunt/quicktype.yue:775
    end -- shunt/quicktype.yue:775
  }) -- shunt/quicktype.yue:775
  _base_0.__class = _class_0 -- shunt/quicktype.yue:775
  Struct = _class_0 -- shunt/quicktype.yue:775
end -- shunt/quicktype.yue:802
do -- shunt/quicktype.yue:804
  local _class_0 -- shunt/quicktype.yue:804
  local _base_0 = { -- shunt/quicktype.yue:804
    __tostring = function(self) -- shunt/quicktype.yue:807
      return tostring(self.name) .. ": " .. tostring(self.type) -- shunt/quicktype.yue:808
    end, -- shunt/quicktype.yue:810
    checker = function(self, checker_builder) -- shunt/quicktype.yue:810
      if checker_builder == nil then -- shunt/quicktype.yue:810
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:810
      end -- shunt/quicktype.yue:810
      return self.type:checker(checker_builder) -- shunt/quicktype.yue:811
    end -- shunt/quicktype.yue:804
  } -- shunt/quicktype.yue:804
  local _list_0 = { -- shunt/quicktype.yue:804
    Is -- shunt/quicktype.yue:804
  } -- shunt/quicktype.yue:804
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:811
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:804
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:804
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:811
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:804
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:804
      end -- shunt/quicktype.yue:804
    end -- shunt/quicktype.yue:811
  end -- shunt/quicktype.yue:811
  if _base_0.__index == nil then -- shunt/quicktype.yue:804
    _base_0.__index = _base_0 -- shunt/quicktype.yue:804
  end -- shunt/quicktype.yue:811
  _class_0 = setmetatable({ -- shunt/quicktype.yue:804
    __init = function(self, name, type) -- shunt/quicktype.yue:805
      self.name = name -- shunt/quicktype.yue:805
      self.type = type -- shunt/quicktype.yue:805
    end, -- shunt/quicktype.yue:804
    __base = _base_0, -- shunt/quicktype.yue:804
    __name = "Field" -- shunt/quicktype.yue:804
  }, { -- shunt/quicktype.yue:804
    __index = _base_0, -- shunt/quicktype.yue:804
    __call = function(cls, ...) -- shunt/quicktype.yue:804
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:804
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:804
      return _self_0 -- shunt/quicktype.yue:804
    end -- shunt/quicktype.yue:804
  }) -- shunt/quicktype.yue:804
  _base_0.__class = _class_0 -- shunt/quicktype.yue:804
  Field = _class_0 -- shunt/quicktype.yue:804
end -- shunt/quicktype.yue:811
do -- shunt/quicktype.yue:813
  local _class_0 -- shunt/quicktype.yue:813
  local _base_0 = { -- shunt/quicktype.yue:813
    table_like = function(self, _table_like) -- shunt/quicktype.yue:817
      self._table_like = _table_like -- shunt/quicktype.yue:817
      return self -- shunt/quicktype.yue:818
    end, -- shunt/quicktype.yue:820
    __tostring = function(self) -- shunt/quicktype.yue:820
      return "{" .. tostring(self.elem_type) .. "}" -- shunt/quicktype.yue:821
    end, -- shunt/quicktype.yue:823
    checker = function(self, checker_builder) -- shunt/quicktype.yue:823
      if checker_builder == nil then -- shunt/quicktype.yue:823
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:823
      end -- shunt/quicktype.yue:823
      if self._table_like then -- shunt/quicktype.yue:824
        error("table-like arrays are not supported") -- shunt/quicktype.yue:825
      end -- shunt/quicktype.yue:824
      checker_builder:add(C_ASSERT_PRIMITIVE, 'table') -- shunt/quicktype.yue:827
      if (self.metatable_type ~= nil) then -- shunt/quicktype.yue:829
        checker_builder:add(C_PUSH_METATABLE) -- shunt/quicktype.yue:830
        self.metatable_type:checker(checker_builder) -- shunt/quicktype.yue:831
        checker_builder:add(C_POP) -- shunt/quicktype.yue:832
      end -- shunt/quicktype.yue:829
      checker_builder:add(C_PUSH, V_NIL) -- shunt/quicktype.yue:834
      checker_builder:add(C_NEXT) -- shunt/quicktype.yue:835
      local loop_start_label = checker_builder:add_with_unresolved_target(C_JMP_IF_NIL) -- shunt/quicktype.yue:837
      checker_builder:add(C_ASSERT_TRUTHY) -- shunt/quicktype.yue:838
      checker_builder:add(C_POP) -- shunt/quicktype.yue:839
      self.elem_type:checker(checker_builder) -- shunt/quicktype.yue:840
      checker_builder:add(C_NEXT) -- shunt/quicktype.yue:842
      checker_builder:add(C_JMP, loop_start_label.index) -- shunt/quicktype.yue:843
      loop_start_label:resolve_here() -- shunt/quicktype.yue:845
      checker_builder:add(C_POP) -- shunt/quicktype.yue:846
      checker_builder:add(C_POP) -- shunt/quicktype.yue:847
      return checker_builder -- shunt/quicktype.yue:826
    end -- shunt/quicktype.yue:813
  } -- shunt/quicktype.yue:813
  local _list_0 = { -- shunt/quicktype.yue:813
    Is -- shunt/quicktype.yue:813
  } -- shunt/quicktype.yue:813
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:847
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:813
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:813
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:847
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:813
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:813
      end -- shunt/quicktype.yue:813
    end -- shunt/quicktype.yue:847
  end -- shunt/quicktype.yue:847
  if _base_0.__index == nil then -- shunt/quicktype.yue:813
    _base_0.__index = _base_0 -- shunt/quicktype.yue:813
  end -- shunt/quicktype.yue:847
  _class_0 = setmetatable({ -- shunt/quicktype.yue:813
    __init = function(self, metatable_type, elem_type) -- shunt/quicktype.yue:814
      self.metatable_type = metatable_type -- shunt/quicktype.yue:814
      self.elem_type = elem_type -- shunt/quicktype.yue:814
      self._table_like = false -- shunt/quicktype.yue:815
    end, -- shunt/quicktype.yue:813
    __base = _base_0, -- shunt/quicktype.yue:813
    __name = "Set" -- shunt/quicktype.yue:813
  }, { -- shunt/quicktype.yue:813
    __index = _base_0, -- shunt/quicktype.yue:813
    __call = function(cls, ...) -- shunt/quicktype.yue:813
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:813
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:813
      return _self_0 -- shunt/quicktype.yue:813
    end -- shunt/quicktype.yue:813
  }) -- shunt/quicktype.yue:813
  _base_0.__class = _class_0 -- shunt/quicktype.yue:813
  Set = _class_0 -- shunt/quicktype.yue:813
end -- shunt/quicktype.yue:847
do -- shunt/quicktype.yue:849
  local _class_0 -- shunt/quicktype.yue:849
  local _base_0 = { -- shunt/quicktype.yue:849
    table_like = function(self, _table_like) -- shunt/quicktype.yue:853
      self._table_like = _table_like -- shunt/quicktype.yue:853
      return self -- shunt/quicktype.yue:854
    end, -- shunt/quicktype.yue:856
    __tostring = function(self) -- shunt/quicktype.yue:856
      return "{" .. tostring(self.in_type) .. " -> " .. tostring(self.out_type) .. "}" -- shunt/quicktype.yue:857
    end, -- shunt/quicktype.yue:859
    checker = function(self, checker_builder) -- shunt/quicktype.yue:859
      if checker_builder == nil then -- shunt/quicktype.yue:859
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:859
      end -- shunt/quicktype.yue:859
      if self._table_like then -- shunt/quicktype.yue:860
        error("table-like arrays are not supported") -- shunt/quicktype.yue:861
      end -- shunt/quicktype.yue:860
      checker_builder:add(C_ASSERT_PRIMITIVE, 'table') -- shunt/quicktype.yue:863
      if (self.metatable_type ~= nil) then -- shunt/quicktype.yue:865
        checker_builder:add(C_PUSH_METATABLE) -- shunt/quicktype.yue:866
        self.metatable_type:checker(checker_builder) -- shunt/quicktype.yue:867
        checker_builder:add(C_POP) -- shunt/quicktype.yue:868
      end -- shunt/quicktype.yue:865
      checker_builder:add(C_PUSH, V_NIL) -- shunt/quicktype.yue:870
      checker_builder:add(C_NEXT) -- shunt/quicktype.yue:871
      local loop_start_label = checker_builder:add_with_unresolved_target(C_JMP_IF_NIL) -- shunt/quicktype.yue:873
      self.out_type:checker(checker_builder) -- shunt/quicktype.yue:875
      checker_builder:add(C_POP) -- shunt/quicktype.yue:876
      self.in_type:checker(checker_builder) -- shunt/quicktype.yue:877
      checker_builder:add(C_NEXT) -- shunt/quicktype.yue:879
      checker_builder:add(C_JMP, loop_start_label.index) -- shunt/quicktype.yue:880
      loop_start_label:resolve_here() -- shunt/quicktype.yue:882
      checker_builder:add(C_POP) -- shunt/quicktype.yue:883
      checker_builder:add(C_POP) -- shunt/quicktype.yue:884
      return checker_builder -- shunt/quicktype.yue:862
    end -- shunt/quicktype.yue:849
  } -- shunt/quicktype.yue:849
  local _list_0 = { -- shunt/quicktype.yue:849
    Is -- shunt/quicktype.yue:849
  } -- shunt/quicktype.yue:849
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:884
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:849
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:849
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:884
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:849
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:849
      end -- shunt/quicktype.yue:849
    end -- shunt/quicktype.yue:884
  end -- shunt/quicktype.yue:884
  if _base_0.__index == nil then -- shunt/quicktype.yue:849
    _base_0.__index = _base_0 -- shunt/quicktype.yue:849
  end -- shunt/quicktype.yue:884
  _class_0 = setmetatable({ -- shunt/quicktype.yue:849
    __init = function(self, metatable_type, in_type, out_type) -- shunt/quicktype.yue:850
      self.metatable_type = metatable_type -- shunt/quicktype.yue:850
      self.in_type = in_type -- shunt/quicktype.yue:850
      self.out_type = out_type -- shunt/quicktype.yue:850
      self._table_like = false -- shunt/quicktype.yue:851
    end, -- shunt/quicktype.yue:849
    __base = _base_0, -- shunt/quicktype.yue:849
    __name = "Mapping" -- shunt/quicktype.yue:849
  }, { -- shunt/quicktype.yue:849
    __index = _base_0, -- shunt/quicktype.yue:849
    __call = function(cls, ...) -- shunt/quicktype.yue:849
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:849
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:849
      return _self_0 -- shunt/quicktype.yue:849
    end -- shunt/quicktype.yue:849
  }) -- shunt/quicktype.yue:849
  _base_0.__class = _class_0 -- shunt/quicktype.yue:849
  Mapping = _class_0 -- shunt/quicktype.yue:849
end -- shunt/quicktype.yue:884
do -- shunt/quicktype.yue:886
  local _class_0 -- shunt/quicktype.yue:886
  local _base_0 = { -- shunt/quicktype.yue:886
    param_checkers = function(self) -- shunt/quicktype.yue:893
      do -- shunt/quicktype.yue:894
        local param_checkers = self._param_checkers -- shunt/quicktype.yue:894
        if param_checkers then -- shunt/quicktype.yue:894
          return param_checkers -- shunt/quicktype.yue:895
        end -- shunt/quicktype.yue:894
      end -- shunt/quicktype.yue:894
      local param_checkers -- shunt/quicktype.yue:896
      do -- shunt/quicktype.yue:896
        local _with_0 = setmetatable({ }, { }) -- shunt/quicktype.yue:896
        local _list_0 = self.param_types -- shunt/quicktype.yue:897
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:897
          local param_type = _list_0[_index_0] -- shunt/quicktype.yue:897
          _with_0[#_with_0 + 1] = param_type:checker():build() -- shunt/quicktype.yue:898
        end -- shunt/quicktype.yue:898
        if (getmetatable(self.param_types) ~= nil) then -- shunt/quicktype.yue:899
          do -- shunt/quicktype.yue:900
            local remainder_type = self.remainder_param_type -- shunt/quicktype.yue:900
            if remainder_type then -- shunt/quicktype.yue:900
              local remainder_type_checker = remainder_type:checker():build() -- shunt/quicktype.yue:901
              getmetatable(_with_0).__index = function(self) -- shunt/quicktype.yue:902
                return remainder_type_checker -- shunt/quicktype.yue:902
              end -- shunt/quicktype.yue:902
            end -- shunt/quicktype.yue:900
          end -- shunt/quicktype.yue:900
        end -- shunt/quicktype.yue:899
        param_checkers = _with_0 -- shunt/quicktype.yue:896
      end -- shunt/quicktype.yue:896
      self._param_checkers = param_checkers -- shunt/quicktype.yue:903
      return param_checkers -- shunt/quicktype.yue:904
    end, -- shunt/quicktype.yue:906
    return_checkers = function(self) -- shunt/quicktype.yue:906
      do -- shunt/quicktype.yue:907
        local return_checkers = self._return_checkers -- shunt/quicktype.yue:907
        if return_checkers then -- shunt/quicktype.yue:907
          return return_checkers -- shunt/quicktype.yue:908
        end -- shunt/quicktype.yue:907
      end -- shunt/quicktype.yue:907
      local return_checkers -- shunt/quicktype.yue:909
      do -- shunt/quicktype.yue:909
        local _with_0 = setmetatable({ }, { }) -- shunt/quicktype.yue:909
        local _list_0 = self.return_types -- shunt/quicktype.yue:910
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:910
          local return_type = _list_0[_index_0] -- shunt/quicktype.yue:910
          _with_0[#_with_0 + 1] = return_type:checker():build() -- shunt/quicktype.yue:911
        end -- shunt/quicktype.yue:911
        if (getmetatable(self.return_types) ~= nil) then -- shunt/quicktype.yue:912
          do -- shunt/quicktype.yue:913
            local remainder_type = self.remainder_return_type -- shunt/quicktype.yue:913
            if remainder_type then -- shunt/quicktype.yue:913
              local remainder_type_checker = remainder_type:checker():build() -- shunt/quicktype.yue:914
              getmetatable(_with_0).__index = function(self) -- shunt/quicktype.yue:915
                return remainder_type_checker -- shunt/quicktype.yue:915
              end -- shunt/quicktype.yue:915
            end -- shunt/quicktype.yue:913
          end -- shunt/quicktype.yue:913
        end -- shunt/quicktype.yue:912
        return_checkers = _with_0 -- shunt/quicktype.yue:909
      end -- shunt/quicktype.yue:909
      self._return_checkers = return_checkers -- shunt/quicktype.yue:916
      return return_checkers -- shunt/quicktype.yue:917
    end, -- shunt/quicktype.yue:919
    __tostring = function(self) -- shunt/quicktype.yue:919
      return table.concat((function() -- shunt/quicktype.yue:920
        local _with_0 = { } -- shunt/quicktype.yue:920
        _with_0[#_with_0 + 1] = '(' -- shunt/quicktype.yue:921
        local first_param = true -- shunt/quicktype.yue:922
        local _list_0 = self.param_types -- shunt/quicktype.yue:923
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:923
          local param_type = _list_0[_index_0] -- shunt/quicktype.yue:923
          if not first_param then -- shunt/quicktype.yue:924
            _with_0[#_with_0 + 1] = ", " -- shunt/quicktype.yue:925
          end -- shunt/quicktype.yue:924
          first_param = false -- shunt/quicktype.yue:926
          _with_0[#_with_0 + 1] = tostring(param_type) -- shunt/quicktype.yue:928
        end -- shunt/quicktype.yue:928
        if (self.remainder_param_type ~= nil) then -- shunt/quicktype.yue:929
          if not first_param then -- shunt/quicktype.yue:930
            _with_0[#_with_0 + 1] = ', ' -- shunt/quicktype.yue:931
          end -- shunt/quicktype.yue:930
          _with_0[#_with_0 + 1] = tostring(self.remainder_param_type) -- shunt/quicktype.yue:932
          _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:933
        end -- shunt/quicktype.yue:929
        _with_0[#_with_0 + 1] = ') -> ' -- shunt/quicktype.yue:934
        if #self.return_types == 1 then -- shunt/quicktype.yue:935
          if (self.remainder_return_type ~= nil) then -- shunt/quicktype.yue:936
            _with_0[#_with_0 + 1] = tostring(self.remainder_return_type) -- shunt/quicktype.yue:937
            _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:938
          else -- shunt/quicktype.yue:940
            _with_0[#_with_0 + 1] = tostring(self.return_types[1]) -- shunt/quicktype.yue:940
          end -- shunt/quicktype.yue:936
        else -- shunt/quicktype.yue:942
          _with_0[#_with_0 + 1] = '<' -- shunt/quicktype.yue:942
          local first_ret = true -- shunt/quicktype.yue:943
          local _list_1 = self.return_types -- shunt/quicktype.yue:944
          for _index_0 = 1, #_list_1 do -- shunt/quicktype.yue:944
            local return_type = _list_1[_index_0] -- shunt/quicktype.yue:944
            if not first_ret then -- shunt/quicktype.yue:945
              _with_0[#_with_0 + 1] = ", " -- shunt/quicktype.yue:946
            end -- shunt/quicktype.yue:945
            first_ret = false -- shunt/quicktype.yue:947
            _with_0[#_with_0 + 1] = tostring(return_type) -- shunt/quicktype.yue:948
          end -- shunt/quicktype.yue:948
          if (self.remainder_return_type ~= nil) then -- shunt/quicktype.yue:949
            if not first_ret then -- shunt/quicktype.yue:950
              _with_0[#_with_0 + 1] = ', ' -- shunt/quicktype.yue:951
            end -- shunt/quicktype.yue:950
            _with_0[#_with_0 + 1] = tostring(self.remainder_return_type) -- shunt/quicktype.yue:952
            _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:953
          end -- shunt/quicktype.yue:949
          _with_0[#_with_0 + 1] = '>' -- shunt/quicktype.yue:954
        end -- shunt/quicktype.yue:935
        return _with_0 -- shunt/quicktype.yue:920
      end)()) -- shunt/quicktype.yue:954
    end, -- shunt/quicktype.yue:956
    checker = function(self, checker_builder) -- shunt/quicktype.yue:956
      if checker_builder == nil then -- shunt/quicktype.yue:956
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:956
      end -- shunt/quicktype.yue:956
      checker_builder:add(C_ASSERT_PRIMITIVE, 'function') -- shunt/quicktype.yue:958
      return checker_builder -- shunt/quicktype.yue:957
    end -- shunt/quicktype.yue:886
  } -- shunt/quicktype.yue:886
  local _list_0 = { -- shunt/quicktype.yue:886
    Is -- shunt/quicktype.yue:886
  } -- shunt/quicktype.yue:886
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:958
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:886
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:886
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:958
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:886
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:886
      end -- shunt/quicktype.yue:886
    end -- shunt/quicktype.yue:958
  end -- shunt/quicktype.yue:958
  if _base_0.__index == nil then -- shunt/quicktype.yue:886
    _base_0.__index = _base_0 -- shunt/quicktype.yue:886
  end -- shunt/quicktype.yue:958
  _class_0 = setmetatable({ -- shunt/quicktype.yue:886
    __init = function(self, param_types, return_types) -- shunt/quicktype.yue:887
      self.param_types = param_types -- shunt/quicktype.yue:887
      self.return_types = return_types -- shunt/quicktype.yue:887
      do -- shunt/quicktype.yue:888
        local _obj_0 = getmetatable(param_types) -- shunt/quicktype.yue:888
        if _obj_0 ~= nil then -- shunt/quicktype.yue:888
          do -- shunt/quicktype.yue:888
            local _obj_1 = _obj_0.__index -- shunt/quicktype.yue:888
            if _obj_1 ~= nil then -- shunt/quicktype.yue:888
              self.remainder_param_type = _obj_1() -- shunt/quicktype.yue:888
            end -- shunt/quicktype.yue:888
          end -- shunt/quicktype.yue:888
        end -- shunt/quicktype.yue:888
      end -- shunt/quicktype.yue:888
      do -- shunt/quicktype.yue:889
        local _obj_0 = getmetatable(return_types) -- shunt/quicktype.yue:889
        if _obj_0 ~= nil then -- shunt/quicktype.yue:889
          do -- shunt/quicktype.yue:889
            local _obj_1 = _obj_0.__index -- shunt/quicktype.yue:889
            if _obj_1 ~= nil then -- shunt/quicktype.yue:889
              self.remainder_return_type = _obj_1() -- shunt/quicktype.yue:889
            end -- shunt/quicktype.yue:889
          end -- shunt/quicktype.yue:889
        end -- shunt/quicktype.yue:889
      end -- shunt/quicktype.yue:889
      self._param_checkers = nil -- shunt/quicktype.yue:890
      self._return_checkers = nil -- shunt/quicktype.yue:891
    end, -- shunt/quicktype.yue:886
    __base = _base_0, -- shunt/quicktype.yue:886
    __name = "Function" -- shunt/quicktype.yue:886
  }, { -- shunt/quicktype.yue:886
    __index = _base_0, -- shunt/quicktype.yue:886
    __call = function(cls, ...) -- shunt/quicktype.yue:886
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:886
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:886
      return _self_0 -- shunt/quicktype.yue:886
    end -- shunt/quicktype.yue:886
  }) -- shunt/quicktype.yue:886
  _base_0.__class = _class_0 -- shunt/quicktype.yue:886
  Function = _class_0 -- shunt/quicktype.yue:886
end -- shunt/quicktype.yue:958
do -- shunt/quicktype.yue:960
  local _class_0 -- shunt/quicktype.yue:960
  local _parent_0 = Function -- shunt/quicktype.yue:960
  local _base_0 = { -- shunt/quicktype.yue:960
    __tostring = function(self) -- shunt/quicktype.yue:964
      return table.concat((function() -- shunt/quicktype.yue:965
        local _with_0 = { } -- shunt/quicktype.yue:965
        _with_0[#_with_0 + 1] = '(' -- shunt/quicktype.yue:966
        local first_param = true -- shunt/quicktype.yue:967
        do -- shunt/quicktype.yue:968
          local _list_0 = self.param_types -- shunt/quicktype.yue:968
          for _index_0 = 2, #_list_0 do -- shunt/quicktype.yue:968
            local param_type = _list_0[_index_0] -- shunt/quicktype.yue:968
            if not first_param then -- shunt/quicktype.yue:969
              _with_0[#_with_0 + 1] = ", " -- shunt/quicktype.yue:970
            end -- shunt/quicktype.yue:969
            first_param = false -- shunt/quicktype.yue:971
            _with_0[#_with_0 + 1] = tostring(param_type) -- shunt/quicktype.yue:973
          end -- shunt/quicktype.yue:973
        end -- shunt/quicktype.yue:973
        if (self.remainder_param_type ~= nil) then -- shunt/quicktype.yue:974
          if not first_param then -- shunt/quicktype.yue:975
            _with_0[#_with_0 + 1] = ', ' -- shunt/quicktype.yue:976
          end -- shunt/quicktype.yue:975
          _with_0[#_with_0 + 1] = tostring(self.remainder_param_type) -- shunt/quicktype.yue:977
          _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:978
        end -- shunt/quicktype.yue:974
        _with_0[#_with_0 + 1] = ') => ' -- shunt/quicktype.yue:979
        if #self.return_types == 1 then -- shunt/quicktype.yue:980
          if (self.remainder_return_type ~= nil) then -- shunt/quicktype.yue:981
            _with_0[#_with_0 + 1] = tostring(self.remainder_return_type) -- shunt/quicktype.yue:982
            _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:983
          else -- shunt/quicktype.yue:985
            _with_0[#_with_0 + 1] = tostring(self.return_types[1]) -- shunt/quicktype.yue:985
          end -- shunt/quicktype.yue:981
        else -- shunt/quicktype.yue:987
          _with_0[#_with_0 + 1] = '<' -- shunt/quicktype.yue:987
          local first_ret = true -- shunt/quicktype.yue:988
          local _list_0 = self.return_types -- shunt/quicktype.yue:989
          for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:989
            local return_type = _list_0[_index_0] -- shunt/quicktype.yue:989
            if not first_ret then -- shunt/quicktype.yue:990
              _with_0[#_with_0 + 1] = ", " -- shunt/quicktype.yue:991
            end -- shunt/quicktype.yue:990
            first_ret = false -- shunt/quicktype.yue:992
            _with_0[#_with_0 + 1] = tostring(return_type) -- shunt/quicktype.yue:993
          end -- shunt/quicktype.yue:993
          if (self.remainder_return_type ~= nil) then -- shunt/quicktype.yue:994
            if not first_ret then -- shunt/quicktype.yue:995
              _with_0[#_with_0 + 1] = ', ' -- shunt/quicktype.yue:996
            end -- shunt/quicktype.yue:995
            _with_0[#_with_0 + 1] = tostring(self.remainder_return_type) -- shunt/quicktype.yue:997
            _with_0[#_with_0 + 1] = '...' -- shunt/quicktype.yue:998
          end -- shunt/quicktype.yue:994
          _with_0[#_with_0 + 1] = '>' -- shunt/quicktype.yue:999
        end -- shunt/quicktype.yue:980
        return _with_0 -- shunt/quicktype.yue:965
      end)()) -- shunt/quicktype.yue:999
    end -- shunt/quicktype.yue:960
  } -- shunt/quicktype.yue:960
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/quicktype.yue:999
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/quicktype.yue:960
      _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:960
    end -- shunt/quicktype.yue:960
  end -- shunt/quicktype.yue:999
  if _base_0.__index == nil then -- shunt/quicktype.yue:960
    _base_0.__index = _base_0 -- shunt/quicktype.yue:960
  end -- shunt/quicktype.yue:999
  setmetatable(_base_0, _parent_0.__base) -- shunt/quicktype.yue:960
  _class_0 = setmetatable({ -- shunt/quicktype.yue:960
    __init = function(self, param_types, return_types) -- shunt/quicktype.yue:961
      return _class_0.__parent.__init(self, (function() -- shunt/quicktype.yue:962
        local _tab_0 = { -- shunt/quicktype.yue:962
          Some() -- shunt/quicktype.yue:962
        } -- shunt/quicktype.yue:962
        local _idx_0 = 1 -- shunt/quicktype.yue:962
        for _key_0, _value_0 in pairs(param_types) do -- shunt/quicktype.yue:962
          if _idx_0 == _key_0 then -- shunt/quicktype.yue:962
            _tab_0[#_tab_0 + 1] = _value_0 -- shunt/quicktype.yue:962
            _idx_0 = _idx_0 + 1 -- shunt/quicktype.yue:962
          else -- shunt/quicktype.yue:962
            _tab_0[_key_0] = _value_0 -- shunt/quicktype.yue:962
          end -- shunt/quicktype.yue:962
        end -- shunt/quicktype.yue:962
        return _tab_0 -- shunt/quicktype.yue:962
      end)(), return_types) -- shunt/quicktype.yue:962
    end, -- shunt/quicktype.yue:960
    __base = _base_0, -- shunt/quicktype.yue:960
    __name = "Method", -- shunt/quicktype.yue:960
    __parent = _parent_0 -- shunt/quicktype.yue:960
  }, { -- shunt/quicktype.yue:960
    __index = function(cls, name) -- shunt/quicktype.yue:960
      local val = rawget(_base_0, name) -- shunt/quicktype.yue:960
      if val == nil then -- shunt/quicktype.yue:960
        local parent = rawget(cls, "__parent") -- shunt/quicktype.yue:960
        if parent then -- shunt/quicktype.yue:960
          return parent[name] -- shunt/quicktype.yue:960
        end -- shunt/quicktype.yue:960
      else -- shunt/quicktype.yue:960
        return val -- shunt/quicktype.yue:960
      end -- shunt/quicktype.yue:960
    end, -- shunt/quicktype.yue:960
    __call = function(cls, ...) -- shunt/quicktype.yue:960
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:960
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:960
      return _self_0 -- shunt/quicktype.yue:960
    end -- shunt/quicktype.yue:960
  }) -- shunt/quicktype.yue:960
  _base_0.__class = _class_0 -- shunt/quicktype.yue:960
  if _parent_0.__inherited then -- shunt/quicktype.yue:960
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/quicktype.yue:960
  end -- shunt/quicktype.yue:960
  Method = _class_0 -- shunt/quicktype.yue:960
end -- shunt/quicktype.yue:999
do -- shunt/quicktype.yue:1001
  local _class_0 -- shunt/quicktype.yue:1001
  local _base_0 = { -- shunt/quicktype.yue:1001
    __tostring = function(self) -- shunt/quicktype.yue:1004
      return tostring(self.type) .. "..." -- shunt/quicktype.yue:1005
    end, -- shunt/quicktype.yue:1007
    checker = function(self, checker_builder) -- shunt/quicktype.yue:1007
      if checker_builder == nil then -- shunt/quicktype.yue:1007
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:1007
      end -- shunt/quicktype.yue:1007
      return error('internal error: Remainder unresolved in AST') -- shunt/quicktype.yue:1008
    end -- shunt/quicktype.yue:1001
  } -- shunt/quicktype.yue:1001
  local _list_0 = { -- shunt/quicktype.yue:1001
    Is -- shunt/quicktype.yue:1001
  } -- shunt/quicktype.yue:1001
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1008
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:1001
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:1001
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:1008
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:1001
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:1001
      end -- shunt/quicktype.yue:1001
    end -- shunt/quicktype.yue:1008
  end -- shunt/quicktype.yue:1008
  if _base_0.__index == nil then -- shunt/quicktype.yue:1001
    _base_0.__index = _base_0 -- shunt/quicktype.yue:1001
  end -- shunt/quicktype.yue:1008
  _class_0 = setmetatable({ -- shunt/quicktype.yue:1001
    __init = function(self, type) -- shunt/quicktype.yue:1002
      self.type = type -- shunt/quicktype.yue:1002
    end, -- shunt/quicktype.yue:1001
    __base = _base_0, -- shunt/quicktype.yue:1001
    __name = "Remainder" -- shunt/quicktype.yue:1001
  }, { -- shunt/quicktype.yue:1001
    __index = _base_0, -- shunt/quicktype.yue:1001
    __call = function(cls, ...) -- shunt/quicktype.yue:1001
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:1001
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:1001
      return _self_0 -- shunt/quicktype.yue:1001
    end -- shunt/quicktype.yue:1001
  }) -- shunt/quicktype.yue:1001
  _base_0.__class = _class_0 -- shunt/quicktype.yue:1001
  Remainder = _class_0 -- shunt/quicktype.yue:1001
end -- shunt/quicktype.yue:1008
do -- shunt/quicktype.yue:1010
  local _class_0 -- shunt/quicktype.yue:1010
  local _base_0 = { -- shunt/quicktype.yue:1010
    __tostring = function(self) -- shunt/quicktype.yue:1015
      return table.concat((function() -- shunt/quicktype.yue:1016
        local _accum_0 = { } -- shunt/quicktype.yue:1016
        local _len_0 = 1 -- shunt/quicktype.yue:1016
        local _list_0 = self.types -- shunt/quicktype.yue:1016
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1016
          local ty = _list_0[_index_0] -- shunt/quicktype.yue:1016
          _accum_0[_len_0] = tostring(ty) -- shunt/quicktype.yue:1016
          _len_0 = _len_0 + 1 -- shunt/quicktype.yue:1016
        end -- shunt/quicktype.yue:1016
        return _accum_0 -- shunt/quicktype.yue:1016
      end)(), '|') -- shunt/quicktype.yue:1016
    end, -- shunt/quicktype.yue:1018
    checker = function(self, checker_builder) -- shunt/quicktype.yue:1018
      if checker_builder == nil then -- shunt/quicktype.yue:1018
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:1018
      end -- shunt/quicktype.yue:1018
      checker_builder:add(C_PUSH_UNION_CTX, self) -- shunt/quicktype.yue:1020
      local next_variant_jump = checker_builder:add_with_unresolved_target(C_SET_UNION_BAIL_TARGET) -- shunt/quicktype.yue:1021
      self.types[1]:checker(checker_builder) -- shunt/quicktype.yue:1022
      local ok_jumps = { } -- shunt/quicktype.yue:1024
      do -- shunt/quicktype.yue:1025
        local _list_0 = self.types -- shunt/quicktype.yue:1025
        for _index_0 = 2, #_list_0 do -- shunt/quicktype.yue:1025
          local ty = _list_0[_index_0] -- shunt/quicktype.yue:1025
          ok_jumps[#ok_jumps + 1] = checker_builder:add_with_unresolved_target(C_JMP) -- shunt/quicktype.yue:1026
          next_variant_jump:resolve_here() -- shunt/quicktype.yue:1028
          checker_builder:add(C_CLEAR_BAILING) -- shunt/quicktype.yue:1029
          next_variant_jump = checker_builder:add_with_unresolved_target(C_SET_UNION_BAIL_TARGET) -- shunt/quicktype.yue:1030
          ty:checker(checker_builder) -- shunt/quicktype.yue:1031
        end -- shunt/quicktype.yue:1031
      end -- shunt/quicktype.yue:1031
      next_variant_jump:resolve_here() -- shunt/quicktype.yue:1033
      for _index_0 = 1, #ok_jumps do -- shunt/quicktype.yue:1034
        local ok_jump = ok_jumps[_index_0] -- shunt/quicktype.yue:1034
        ok_jump:resolve_here() -- shunt/quicktype.yue:1035
      end -- shunt/quicktype.yue:1035
      checker_builder:add(C_POP_UNION_CTX) -- shunt/quicktype.yue:1036
      return checker_builder -- shunt/quicktype.yue:1019
    end -- shunt/quicktype.yue:1010
  } -- shunt/quicktype.yue:1010
  local _list_0 = { -- shunt/quicktype.yue:1010
    Is -- shunt/quicktype.yue:1010
  } -- shunt/quicktype.yue:1010
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1036
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:1010
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:1010
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:1036
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:1010
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:1010
      end -- shunt/quicktype.yue:1010
    end -- shunt/quicktype.yue:1036
  end -- shunt/quicktype.yue:1036
  if _base_0.__index == nil then -- shunt/quicktype.yue:1010
    _base_0.__index = _base_0 -- shunt/quicktype.yue:1010
  end -- shunt/quicktype.yue:1036
  _class_0 = setmetatable({ -- shunt/quicktype.yue:1010
    __init = function(self, types) -- shunt/quicktype.yue:1011
      self.types = types -- shunt/quicktype.yue:1011
      if #self.types <= 1 then -- shunt/quicktype.yue:1012
        return error('internal error: disjunction has too few elements') -- shunt/quicktype.yue:1013
      end -- shunt/quicktype.yue:1012
    end, -- shunt/quicktype.yue:1010
    __base = _base_0, -- shunt/quicktype.yue:1010
    __name = "Disjunction" -- shunt/quicktype.yue:1010
  }, { -- shunt/quicktype.yue:1010
    __index = _base_0, -- shunt/quicktype.yue:1010
    __call = function(cls, ...) -- shunt/quicktype.yue:1010
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:1010
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:1010
      return _self_0 -- shunt/quicktype.yue:1010
    end -- shunt/quicktype.yue:1010
  }) -- shunt/quicktype.yue:1010
  _base_0.__class = _class_0 -- shunt/quicktype.yue:1010
  Disjunction = _class_0 -- shunt/quicktype.yue:1010
end -- shunt/quicktype.yue:1036
do -- shunt/quicktype.yue:1038
  local _class_0 -- shunt/quicktype.yue:1038
  local _base_0 = { -- shunt/quicktype.yue:1038
    __tostring = function(self) -- shunt/quicktype.yue:1041
      return table.concat((function() -- shunt/quicktype.yue:1042
        local _accum_0 = { } -- shunt/quicktype.yue:1042
        local _len_0 = 1 -- shunt/quicktype.yue:1042
        local _list_0 = self.types -- shunt/quicktype.yue:1042
        for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1042
          local ty = _list_0[_index_0] -- shunt/quicktype.yue:1042
          _accum_0[_len_0] = tostring(ty) -- shunt/quicktype.yue:1042
          _len_0 = _len_0 + 1 -- shunt/quicktype.yue:1042
        end -- shunt/quicktype.yue:1042
        return _accum_0 -- shunt/quicktype.yue:1042
      end)(), '+') -- shunt/quicktype.yue:1042
    end, -- shunt/quicktype.yue:1044
    checker = function(self, checker_builder) -- shunt/quicktype.yue:1044
      if checker_builder == nil then -- shunt/quicktype.yue:1044
        checker_builder = CheckerBuilder() -- shunt/quicktype.yue:1044
      end -- shunt/quicktype.yue:1044
      local _list_0 = self.types -- shunt/quicktype.yue:1046
      for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1046
        local ty = _list_0[_index_0] -- shunt/quicktype.yue:1046
        ty:checker(checker_builder) -- shunt/quicktype.yue:1047
      end -- shunt/quicktype.yue:1047
      return checker_builder -- shunt/quicktype.yue:1045
    end -- shunt/quicktype.yue:1038
  } -- shunt/quicktype.yue:1038
  local _list_0 = { -- shunt/quicktype.yue:1038
    Is -- shunt/quicktype.yue:1038
  } -- shunt/quicktype.yue:1038
  for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1047
    local _item_0 = _list_0[_index_0] -- shunt/quicktype.yue:1038
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/quicktype.yue:1038
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/quicktype.yue:1047
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/quicktype.yue:1038
        _base_0[_key_0] = _val_0 -- shunt/quicktype.yue:1038
      end -- shunt/quicktype.yue:1038
    end -- shunt/quicktype.yue:1047
  end -- shunt/quicktype.yue:1047
  if _base_0.__index == nil then -- shunt/quicktype.yue:1038
    _base_0.__index = _base_0 -- shunt/quicktype.yue:1038
  end -- shunt/quicktype.yue:1047
  _class_0 = setmetatable({ -- shunt/quicktype.yue:1038
    __init = function(self, types) -- shunt/quicktype.yue:1039
      self.types = types -- shunt/quicktype.yue:1039
    end, -- shunt/quicktype.yue:1038
    __base = _base_0, -- shunt/quicktype.yue:1038
    __name = "Conjunction" -- shunt/quicktype.yue:1038
  }, { -- shunt/quicktype.yue:1038
    __index = _base_0, -- shunt/quicktype.yue:1038
    __call = function(cls, ...) -- shunt/quicktype.yue:1038
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:1038
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:1038
      return _self_0 -- shunt/quicktype.yue:1038
    end -- shunt/quicktype.yue:1038
  }) -- shunt/quicktype.yue:1038
  _base_0.__class = _class_0 -- shunt/quicktype.yue:1038
  Conjunction = _class_0 -- shunt/quicktype.yue:1038
end -- shunt/quicktype.yue:1047
do -- shunt/quicktype.yue:1049
  local _class_0 -- shunt/quicktype.yue:1049
  local _base_0 = { -- shunt/quicktype.yue:1049
    add = function(self, op, arg) -- shunt/quicktype.yue:1054
      if arg == nil then -- shunt/quicktype.yue:1054
        arg = '_' -- shunt/quicktype.yue:1054
      end -- shunt/quicktype.yue:1054
      do -- shunt/quicktype.yue:1055
        local _obj_0 = self.instructions -- shunt/quicktype.yue:1055
        _obj_0[#_obj_0 + 1] = op -- shunt/quicktype.yue:1055
      end -- shunt/quicktype.yue:1055
      do -- shunt/quicktype.yue:1056
        local _obj_0 = self.instructions -- shunt/quicktype.yue:1056
        _obj_0[#_obj_0 + 1] = arg -- shunt/quicktype.yue:1056
      end -- shunt/quicktype.yue:1056
    end, -- shunt/quicktype.yue:1058
    add_labelled = function(self, op, arg) -- shunt/quicktype.yue:1058
      if arg == nil then -- shunt/quicktype.yue:1058
        arg = '_' -- shunt/quicktype.yue:1058
      end -- shunt/quicktype.yue:1058
      local label = self:make_label() -- shunt/quicktype.yue:1059
      self:add(op, arg) -- shunt/quicktype.yue:1060
      return label -- shunt/quicktype.yue:1061
    end, -- shunt/quicktype.yue:1063
    add_with_unresolved_target = function(self, op) -- shunt/quicktype.yue:1063
      local label = self:make_label() -- shunt/quicktype.yue:1064
      self:add(op, LABEL_PLACEHOLDER) -- shunt/quicktype.yue:1065
      return label -- shunt/quicktype.yue:1066
    end, -- shunt/quicktype.yue:1068
    make_label = function(self) -- shunt/quicktype.yue:1068
      return Label(self.instructions) -- shunt/quicktype.yue:1069
    end, -- shunt/quicktype.yue:1071
    build = function(self) -- shunt/quicktype.yue:1071
      self:validate() -- shunt/quicktype.yue:1072
      return self.instructions -- shunt/quicktype.yue:1073
    end, -- shunt/quicktype.yue:1075
    validate = function(self) -- shunt/quicktype.yue:1075
      local _list_0 = self.instructions -- shunt/quicktype.yue:1076
      for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1076
        local instruction = _list_0[_index_0] -- shunt/quicktype.yue:1076
        if instruction == LABEL_PLACEHOLDER then -- shunt/quicktype.yue:1077
          error("unresolved placeholder in check program:\n" .. tostring(repr(self.instructions))) -- shunt/quicktype.yue:1078
        end -- shunt/quicktype.yue:1077
      end -- shunt/quicktype.yue:1078
    end, -- shunt/quicktype.yue:1080
    already_building = function(self, user_type) -- shunt/quicktype.yue:1080
      local _list_0 = self.user_type_stack -- shunt/quicktype.yue:1081
      for _index_0 = 1, #_list_0 do -- shunt/quicktype.yue:1081
        local user_type_being_checked = _list_0[_index_0] -- shunt/quicktype.yue:1081
        if user_type.name == user_type_being_checked.name then -- shunt/quicktype.yue:1082
          return true -- shunt/quicktype.yue:1083
        end -- shunt/quicktype.yue:1082
      end -- shunt/quicktype.yue:1083
      return false -- shunt/quicktype.yue:1084
    end, -- shunt/quicktype.yue:1086
    push_building = function(self, user_type) -- shunt/quicktype.yue:1086
      do -- shunt/quicktype.yue:1087
        local _obj_0 = self.user_type_stack -- shunt/quicktype.yue:1087
        _obj_0[#_obj_0 + 1] = user_type -- shunt/quicktype.yue:1087
      end -- shunt/quicktype.yue:1087
    end, -- shunt/quicktype.yue:1089
    pop_building = function(self, user_type) -- shunt/quicktype.yue:1089
      if self.user_type_stack[#self.user_type_stack] ~= user_type then -- shunt/quicktype.yue:1090
        error("internal error: user type stack mismanaged, expected " .. tostring(user_type.name) .. " at the top of " .. tostring(repr(self.user_type_stack))) -- shunt/quicktype.yue:1091
      end -- shunt/quicktype.yue:1090
      self.user_type_stack[#self.user_type_stack] = nil -- shunt/quicktype.yue:1092
    end -- shunt/quicktype.yue:1049
  } -- shunt/quicktype.yue:1049
  if _base_0.__index == nil then -- shunt/quicktype.yue:1049
    _base_0.__index = _base_0 -- shunt/quicktype.yue:1049
  end -- shunt/quicktype.yue:1092
  _class_0 = setmetatable({ -- shunt/quicktype.yue:1049
    __init = function(self) -- shunt/quicktype.yue:1050
      self.instructions = { } -- shunt/quicktype.yue:1051
      self.user_type_stack = { } -- shunt/quicktype.yue:1052
    end, -- shunt/quicktype.yue:1049
    __base = _base_0, -- shunt/quicktype.yue:1049
    __name = "CheckerBuilder" -- shunt/quicktype.yue:1049
  }, { -- shunt/quicktype.yue:1049
    __index = _base_0, -- shunt/quicktype.yue:1049
    __call = function(cls, ...) -- shunt/quicktype.yue:1049
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:1049
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:1049
      return _self_0 -- shunt/quicktype.yue:1049
    end -- shunt/quicktype.yue:1049
  }) -- shunt/quicktype.yue:1049
  _base_0.__class = _class_0 -- shunt/quicktype.yue:1049
  CheckerBuilder = _class_0 -- shunt/quicktype.yue:1049
end -- shunt/quicktype.yue:1092
do -- shunt/quicktype.yue:1094
  local _class_0 -- shunt/quicktype.yue:1094
  local _base_0 = { -- shunt/quicktype.yue:1094
    resolve_here = function(self) -- shunt/quicktype.yue:1098
      self.instructions[self.index + 1] = #self.instructions + 1 -- shunt/quicktype.yue:1099
    end -- shunt/quicktype.yue:1094
  } -- shunt/quicktype.yue:1094
  if _base_0.__index == nil then -- shunt/quicktype.yue:1094
    _base_0.__index = _base_0 -- shunt/quicktype.yue:1094
  end -- shunt/quicktype.yue:1099
  _class_0 = setmetatable({ -- shunt/quicktype.yue:1094
    __init = function(self, instructions) -- shunt/quicktype.yue:1095
      self.instructions = instructions -- shunt/quicktype.yue:1095
      self.index = #self.instructions + 1 -- shunt/quicktype.yue:1096
    end, -- shunt/quicktype.yue:1094
    __base = _base_0, -- shunt/quicktype.yue:1094
    __name = "Label" -- shunt/quicktype.yue:1094
  }, { -- shunt/quicktype.yue:1094
    __index = _base_0, -- shunt/quicktype.yue:1094
    __call = function(cls, ...) -- shunt/quicktype.yue:1094
      local _self_0 = setmetatable({ }, _base_0) -- shunt/quicktype.yue:1094
      cls.__init(_self_0, ...) -- shunt/quicktype.yue:1094
      return _self_0 -- shunt/quicktype.yue:1094
    end -- shunt/quicktype.yue:1094
  }) -- shunt/quicktype.yue:1094
  _base_0.__class = _class_0 -- shunt/quicktype.yue:1094
  Label = _class_0 -- shunt/quicktype.yue:1094
end -- shunt/quicktype.yue:1099
C_PUSH = setmetatable({ }, { -- shunt/quicktype.yue:1101
  __tostring = function(self) -- shunt/quicktype.yue:1101
    return '<push>' -- shunt/quicktype.yue:1101
  end -- shunt/quicktype.yue:1101
}) -- shunt/quicktype.yue:1101
C_PUSH_METATABLE = setmetatable({ }, { -- shunt/quicktype.yue:1102
  __tostring = function(self) -- shunt/quicktype.yue:1102
    return '<push-metatable>' -- shunt/quicktype.yue:1102
  end -- shunt/quicktype.yue:1102
}) -- shunt/quicktype.yue:1102
C_POP = setmetatable({ }, { -- shunt/quicktype.yue:1103
  __tostring = function(self) -- shunt/quicktype.yue:1103
    return '<pop>' -- shunt/quicktype.yue:1103
  end -- shunt/quicktype.yue:1103
}) -- shunt/quicktype.yue:1103
C_ASSERT_NON_NIL = setmetatable({ }, { -- shunt/quicktype.yue:1104
  __tostring = function(self) -- shunt/quicktype.yue:1104
    return '<assert-non-nil>' -- shunt/quicktype.yue:1104
  end -- shunt/quicktype.yue:1104
}) -- shunt/quicktype.yue:1104
C_ASSERT_PRIMITIVE = setmetatable({ }, { -- shunt/quicktype.yue:1105
  __tostring = function(self) -- shunt/quicktype.yue:1105
    return '<assert-primitive>' -- shunt/quicktype.yue:1105
  end -- shunt/quicktype.yue:1105
}) -- shunt/quicktype.yue:1105
C_ASSERT_TABLE_LIKE = setmetatable({ }, { -- shunt/quicktype.yue:1106
  __tostring = function(self) -- shunt/quicktype.yue:1106
    return '<assert-table-like>' -- shunt/quicktype.yue:1106
  end -- shunt/quicktype.yue:1106
}) -- shunt/quicktype.yue:1106
C_ASSERT_TRUTHY = setmetatable({ }, { -- shunt/quicktype.yue:1107
  __tostring = function(self) -- shunt/quicktype.yue:1107
    return '<assert-truthy>' -- shunt/quicktype.yue:1107
  end -- shunt/quicktype.yue:1107
}) -- shunt/quicktype.yue:1107
C_ASSERT_LEN = setmetatable({ }, { -- shunt/quicktype.yue:1108
  __tostring = function(self) -- shunt/quicktype.yue:1108
    return '<assert-len>' -- shunt/quicktype.yue:1108
  end -- shunt/quicktype.yue:1108
}) -- shunt/quicktype.yue:1108
C_ASSERT_EQ = setmetatable({ }, { -- shunt/quicktype.yue:1109
  __tostring = function(self) -- shunt/quicktype.yue:1109
    return '<assert-eq>' -- shunt/quicktype.yue:1109
  end -- shunt/quicktype.yue:1109
}) -- shunt/quicktype.yue:1109
C_ASSERT_NEVER = setmetatable({ }, { -- shunt/quicktype.yue:1110
  __tostring = function(self) -- shunt/quicktype.yue:1110
    return '<assert-never>' -- shunt/quicktype.yue:1110
  end -- shunt/quicktype.yue:1110
}) -- shunt/quicktype.yue:1110
C_GET_FIELD = setmetatable({ }, { -- shunt/quicktype.yue:1111
  __tostring = function(self) -- shunt/quicktype.yue:1111
    return '<field>' -- shunt/quicktype.yue:1111
  end -- shunt/quicktype.yue:1111
}) -- shunt/quicktype.yue:1111
C_INCR = setmetatable({ }, { -- shunt/quicktype.yue:1112
  __tostring = function(self) -- shunt/quicktype.yue:1112
    return '<incr>' -- shunt/quicktype.yue:1112
  end -- shunt/quicktype.yue:1112
}) -- shunt/quicktype.yue:1112
C_DECR = setmetatable({ }, { -- shunt/quicktype.yue:1113
  __tostring = function(self) -- shunt/quicktype.yue:1113
    return '<decr>' -- shunt/quicktype.yue:1113
  end -- shunt/quicktype.yue:1113
}) -- shunt/quicktype.yue:1113
C_NEXT = setmetatable({ }, { -- shunt/quicktype.yue:1114
  __tostring = function(self) -- shunt/quicktype.yue:1114
    return '<next>' -- shunt/quicktype.yue:1114
  end -- shunt/quicktype.yue:1114
}) -- shunt/quicktype.yue:1114
C_JMP = setmetatable({ }, { -- shunt/quicktype.yue:1115
  __tostring = function(self) -- shunt/quicktype.yue:1115
    return '<jmp>' -- shunt/quicktype.yue:1115
  end -- shunt/quicktype.yue:1115
}) -- shunt/quicktype.yue:1115
C_JMP_IF_NIL = setmetatable({ }, { -- shunt/quicktype.yue:1116
  __tostring = function(self) -- shunt/quicktype.yue:1116
    return '<jnil>' -- shunt/quicktype.yue:1116
  end -- shunt/quicktype.yue:1116
}) -- shunt/quicktype.yue:1116
C_PUSH_CHECKER = setmetatable({ }, { -- shunt/quicktype.yue:1117
  __tostring = function(self) -- shunt/quicktype.yue:1117
    return '<push-checker>' -- shunt/quicktype.yue:1117
  end -- shunt/quicktype.yue:1117
}) -- shunt/quicktype.yue:1117
C_PUSH_UNION_CTX = setmetatable({ }, { -- shunt/quicktype.yue:1118
  __tostring = function(self) -- shunt/quicktype.yue:1118
    return '<push-union-ctx>' -- shunt/quicktype.yue:1118
  end -- shunt/quicktype.yue:1118
}) -- shunt/quicktype.yue:1118
C_CLEAR_BAILING = setmetatable({ }, { -- shunt/quicktype.yue:1119
  __tostring = function(self) -- shunt/quicktype.yue:1119
    return '<clear-bailing>' -- shunt/quicktype.yue:1119
  end -- shunt/quicktype.yue:1119
}) -- shunt/quicktype.yue:1119
C_SET_UNION_BAIL_TARGET = setmetatable({ }, { -- shunt/quicktype.yue:1120
  __tostring = function(self) -- shunt/quicktype.yue:1120
    return '<set-union-bail-target>' -- shunt/quicktype.yue:1120
  end -- shunt/quicktype.yue:1120
}) -- shunt/quicktype.yue:1120
C_POP_UNION_CTX = setmetatable({ }, { -- shunt/quicktype.yue:1121
  __tostring = function(self) -- shunt/quicktype.yue:1121
    return '<pop-union-ctx>' -- shunt/quicktype.yue:1121
  end -- shunt/quicktype.yue:1121
}) -- shunt/quicktype.yue:1121
V_NIL = setmetatable({ }, { -- shunt/quicktype.yue:1122
  __tostring = function(self) -- shunt/quicktype.yue:1122
    return 'nil' -- shunt/quicktype.yue:1122
  end -- shunt/quicktype.yue:1122
}) -- shunt/quicktype.yue:1122
checker_program_repr = function(checker) -- shunt/quicktype.yue:1124
  return table.concat((function() -- shunt/quicktype.yue:1125
    local _accum_0 = { } -- shunt/quicktype.yue:1125
    local _len_0 = 1 -- shunt/quicktype.yue:1125
    for i = 1, #checker, 2 do -- shunt/quicktype.yue:1125
      _accum_0[_len_0] = tostring(i) .. ":\t" .. tostring(repr(checker[i])) .. "\t" .. tostring(checker[i + 1]) -- shunt/quicktype.yue:1125
      _len_0 = _len_0 + 1 -- shunt/quicktype.yue:1125
    end -- shunt/quicktype.yue:1125
    return _accum_0 -- shunt/quicktype.yue:1125
  end)(), '\n\t') -- shunt/quicktype.yue:1125
end -- shunt/quicktype.yue:1124
LABEL_PLACEHOLDER = setmetatable({ }, { -- shunt/quicktype.yue:1127
  __tostring = function(self) -- shunt/quicktype.yue:1127
    return '<LABEL-PLACEHOLDER>' -- shunt/quicktype.yue:1127
  end -- shunt/quicktype.yue:1127
}) -- shunt/quicktype.yue:1127
MAX_CHECKER_DEPTH = 1000 -- shunt/quicktype.yue:1129
_module_0["MAX_CHECKER_DEPTH"] = MAX_CHECKER_DEPTH -- shunt/quicktype.yue:1129
stack_size = 0 -- shunt/quicktype.yue:1130
stack = { } -- shunt/quicktype.yue:1131
keys_used = { } -- shunt/quicktype.yue:1132
num_unions = 0 -- shunt/quicktype.yue:1133
union_depths = { } -- shunt/quicktype.yue:1134
union_bail_jumps = { } -- shunt/quicktype.yue:1135
root_union = nil -- shunt/quicktype.yue:1136
num_running_checkers = 0 -- shunt/quicktype.yue:1137
instruction_counts = { } -- shunt/quicktype.yue:1138
check = function(check_prog, value, root) -- shunt/quicktype.yue:1163
  if root == nil then -- shunt/quicktype.yue:1163
    root = true -- shunt/quicktype.yue:1163
  end -- shunt/quicktype.yue:1163
  if root then -- shunt/quicktype.yue:1170
    stack_size = 1 -- shunt/quicktype.yue:1172
    stack[1] = value -- shunt/quicktype.yue:1173
    num_running_checkers = 1 -- shunt/quicktype.yue:1174
    root_union = 0 -- shunt/quicktype.yue:1175
    num_unions = 0 -- shunt/quicktype.yue:1176
    local initial_unions = 0 -- shunt/quicktype.yue:1177
  end -- shunt/quicktype.yue:1170
  local initial_stack_size = stack_size -- shunt/quicktype.yue:1178
  local initial_num_running_checkers = num_running_checkers -- shunt/quicktype.yue:1179
  local initial_unions = num_unions -- shunt/quicktype.yue:1180
  if num_running_checkers >= MAX_CHECKER_DEPTH then -- shunt/quicktype.yue:1182
    return "type checker recursed too many times (" .. tostring(num_running_checkers) .. " times). If this is okay, increase the MAX_CHECKER_DEPTH" -- shunt/quicktype.yue:1183
  end -- shunt/quicktype.yue:1182
  do -- shunt/quicktype.yue:1187
    local pc -- shunt/quicktype.yue:1188
    local bailing = false -- shunt/quicktype.yue:1189
    pc = -1 -- shunt/quicktype.yue:1191
    while true do -- shunt/quicktype.yue:1192
      pc = pc + 2 -- shunt/quicktype.yue:1193
      local instruction = check_prog[pc] -- shunt/quicktype.yue:1194
      if instruction == nil then -- shunt/quicktype.yue:1195
        break -- shunt/quicktype.yue:1196
      end -- shunt/quicktype.yue:1195
      if COLLECT_STATS then -- shunt/quicktype.yue:1198
        do -- shunt/quicktype.yue:1199
          local v = instruction_counts[instruction] -- shunt/quicktype.yue:1199
          if v then -- shunt/quicktype.yue:1199
            instruction_counts[instruction] = v + 1 -- shunt/quicktype.yue:1200
          else -- shunt/quicktype.yue:1202
            instruction_counts[instruction] = 1 -- shunt/quicktype.yue:1202
          end -- shunt/quicktype.yue:1199
        end -- shunt/quicktype.yue:1199
      end -- shunt/quicktype.yue:1198
      if C_PUSH == instruction then -- shunt/quicktype.yue:1208
        local arg = check_prog[pc + 1] -- shunt/quicktype.yue:1209
        if arg == V_NIL then -- shunt/quicktype.yue:1210
          arg = nil -- shunt/quicktype.yue:1211
        end -- shunt/quicktype.yue:1210
        stack_size = stack_size + 1 -- shunt/quicktype.yue:1212
        stack[stack_size] = arg -- shunt/quicktype.yue:1213
      elseif C_PUSH_METATABLE == instruction then -- shunt/quicktype.yue:1214
        local mt = getmetatable(stack[stack_size]) -- shunt/quicktype.yue:1215
        stack_size = stack_size + 1 -- shunt/quicktype.yue:1216
        stack[stack_size] = mt -- shunt/quicktype.yue:1217
        keys_used[stack_size] = '<>' -- shunt/quicktype.yue:1218
      elseif C_POP == instruction then -- shunt/quicktype.yue:1219
        stack[stack_size] = nil -- shunt/quicktype.yue:1220
        keys_used[stack_size] = nil -- shunt/quicktype.yue:1221
        stack_size = stack_size - 1 -- shunt/quicktype.yue:1222
      elseif C_ASSERT_NON_NIL == instruction then -- shunt/quicktype.yue:1223
        if stack[stack_size] == nil then -- shunt/quicktype.yue:1224
          local msg -- shunt/quicktype.yue:1225
          if num_unions == 0 then -- shunt/quicktype.yue:1225
            local pretty_key_parts = { } -- shunt/quicktype.yue:1225
            for i = 1, stack_size do -- shunt/quicktype.yue:1225
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1225
            end -- shunt/quicktype.yue:1225
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1225
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1225
              msg = "incorrect type: expected some but got nil" .. ' ' .. pretty_key -- shunt/quicktype.yue:1225
            else -- shunt/quicktype.yue:1225
              msg = "incorrect type: expected some but got nil" -- shunt/quicktype.yue:1225
            end -- shunt/quicktype.yue:1225
          else -- shunt/quicktype.yue:1225
            msg = nil -- shunt/quicktype.yue:1225
          end -- shunt/quicktype.yue:1225
          local new_size -- shunt/quicktype.yue:1225
          do -- shunt/quicktype.yue:1225
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1225
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1225
              new_size = _exp_0 -- shunt/quicktype.yue:1225
            else -- shunt/quicktype.yue:1225
              new_size = 0 -- shunt/quicktype.yue:1225
            end -- shunt/quicktype.yue:1225
          end -- shunt/quicktype.yue:1225
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1225
            stack[i] = nil -- shunt/quicktype.yue:1225
          end -- shunt/quicktype.yue:1225
          stack_size = new_size -- shunt/quicktype.yue:1225
          if num_unions == initial_unions then -- shunt/quicktype.yue:1225
            return msg -- shunt/quicktype.yue:1225
          end -- shunt/quicktype.yue:1225
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1225
          bailing = true -- shunt/quicktype.yue:1225
        end -- shunt/quicktype.yue:1224
      elseif C_ASSERT_PRIMITIVE == instruction then -- shunt/quicktype.yue:1226
        local ty = type(stack[stack_size]) -- shunt/quicktype.yue:1227
        local arg = check_prog[pc + 1] -- shunt/quicktype.yue:1228
        if ty ~= arg then -- shunt/quicktype.yue:1229
          local msg -- shunt/quicktype.yue:1230
          if num_unions == 0 then -- shunt/quicktype.yue:1230
            local pretty_key_parts = { } -- shunt/quicktype.yue:1230
            for i = 1, stack_size do -- shunt/quicktype.yue:1230
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1230
            end -- shunt/quicktype.yue:1230
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1230
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1230
              msg = "incorrect type: expected " .. tostring(arg) .. " but got " .. tostring(ty) .. " (" .. tostring(repr(stack[stack_size])) .. ")" .. ' ' .. pretty_key -- shunt/quicktype.yue:1230
            else -- shunt/quicktype.yue:1230
              msg = "incorrect type: expected " .. tostring(arg) .. " but got " .. tostring(ty) .. " (" .. tostring(repr(stack[stack_size])) .. ")" -- shunt/quicktype.yue:1230
            end -- shunt/quicktype.yue:1230
          else -- shunt/quicktype.yue:1230
            msg = nil -- shunt/quicktype.yue:1230
          end -- shunt/quicktype.yue:1230
          local new_size -- shunt/quicktype.yue:1230
          do -- shunt/quicktype.yue:1230
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1230
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1230
              new_size = _exp_0 -- shunt/quicktype.yue:1230
            else -- shunt/quicktype.yue:1230
              new_size = 0 -- shunt/quicktype.yue:1230
            end -- shunt/quicktype.yue:1230
          end -- shunt/quicktype.yue:1230
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1230
            stack[i] = nil -- shunt/quicktype.yue:1230
          end -- shunt/quicktype.yue:1230
          stack_size = new_size -- shunt/quicktype.yue:1230
          if num_unions == initial_unions then -- shunt/quicktype.yue:1230
            return msg -- shunt/quicktype.yue:1230
          end -- shunt/quicktype.yue:1230
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1230
          bailing = true -- shunt/quicktype.yue:1230
        end -- shunt/quicktype.yue:1229
      elseif C_ASSERT_TABLE_LIKE == instruction then -- shunt/quicktype.yue:1231
        value = stack[stack_size] -- shunt/quicktype.yue:1232
        local ty = type(value) -- shunt/quicktype.yue:1233
        if 'table' ~= ty and 'string' ~= ty and (not (getmetatable(value) ~= nil) or not (getmetatable(value).__index ~= nil)) then -- shunt/quicktype.yue:1234
          local msg -- shunt/quicktype.yue:1237
          if num_unions == 0 then -- shunt/quicktype.yue:1237
            local pretty_key_parts = { } -- shunt/quicktype.yue:1237
            for i = 1, stack_size do -- shunt/quicktype.yue:1237
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1237
            end -- shunt/quicktype.yue:1237
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1237
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1237
              msg = "incorrect type: expected indexable but got " .. tostring(ty) .. ' ' .. pretty_key -- shunt/quicktype.yue:1237
            else -- shunt/quicktype.yue:1237
              msg = "incorrect type: expected indexable but got " .. tostring(ty) -- shunt/quicktype.yue:1237
            end -- shunt/quicktype.yue:1237
          else -- shunt/quicktype.yue:1237
            msg = nil -- shunt/quicktype.yue:1237
          end -- shunt/quicktype.yue:1237
          local new_size -- shunt/quicktype.yue:1237
          do -- shunt/quicktype.yue:1237
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1237
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1237
              new_size = _exp_0 -- shunt/quicktype.yue:1237
            else -- shunt/quicktype.yue:1237
              new_size = 0 -- shunt/quicktype.yue:1237
            end -- shunt/quicktype.yue:1237
          end -- shunt/quicktype.yue:1237
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1237
            stack[i] = nil -- shunt/quicktype.yue:1237
          end -- shunt/quicktype.yue:1237
          stack_size = new_size -- shunt/quicktype.yue:1237
          if num_unions == initial_unions then -- shunt/quicktype.yue:1237
            return msg -- shunt/quicktype.yue:1237
          end -- shunt/quicktype.yue:1237
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1237
          bailing = true -- shunt/quicktype.yue:1237
        end -- shunt/quicktype.yue:1234
      elseif C_ASSERT_TRUTHY == instruction then -- shunt/quicktype.yue:1238
        if not stack[stack_size] then -- shunt/quicktype.yue:1239
          local msg -- shunt/quicktype.yue:1240
          if num_unions == 0 then -- shunt/quicktype.yue:1240
            local pretty_key_parts = { } -- shunt/quicktype.yue:1240
            for i = 1, stack_size do -- shunt/quicktype.yue:1240
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1240
            end -- shunt/quicktype.yue:1240
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1240
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1240
              msg = "incorrect type: expected a truthy value but got " .. tostring(stack[stack_size]) .. ' ' .. pretty_key -- shunt/quicktype.yue:1240
            else -- shunt/quicktype.yue:1240
              msg = "incorrect type: expected a truthy value but got " .. tostring(stack[stack_size]) -- shunt/quicktype.yue:1240
            end -- shunt/quicktype.yue:1240
          else -- shunt/quicktype.yue:1240
            msg = nil -- shunt/quicktype.yue:1240
          end -- shunt/quicktype.yue:1240
          local new_size -- shunt/quicktype.yue:1240
          do -- shunt/quicktype.yue:1240
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1240
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1240
              new_size = _exp_0 -- shunt/quicktype.yue:1240
            else -- shunt/quicktype.yue:1240
              new_size = 0 -- shunt/quicktype.yue:1240
            end -- shunt/quicktype.yue:1240
          end -- shunt/quicktype.yue:1240
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1240
            stack[i] = nil -- shunt/quicktype.yue:1240
          end -- shunt/quicktype.yue:1240
          stack_size = new_size -- shunt/quicktype.yue:1240
          if num_unions == initial_unions then -- shunt/quicktype.yue:1240
            return msg -- shunt/quicktype.yue:1240
          end -- shunt/quicktype.yue:1240
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1240
          bailing = true -- shunt/quicktype.yue:1240
        end -- shunt/quicktype.yue:1239
      elseif C_ASSERT_LEN == instruction then -- shunt/quicktype.yue:1241
        local actual_len = #stack[stack_size - 1] -- shunt/quicktype.yue:1242
        local counted_len = stack[stack_size] -- shunt/quicktype.yue:1243
        if counted_len ~= actual_len then -- shunt/quicktype.yue:1244
          local msg -- shunt/quicktype.yue:1245
          if num_unions == 0 then -- shunt/quicktype.yue:1245
            local pretty_key_parts = { } -- shunt/quicktype.yue:1245
            for i = 1, stack_size do -- shunt/quicktype.yue:1245
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1245
            end -- shunt/quicktype.yue:1245
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1245
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1245
              msg = "incorrect type: expected array but got table (" .. tostring(repr(stack[stack_size])) .. ")" .. ' ' .. pretty_key -- shunt/quicktype.yue:1245
            else -- shunt/quicktype.yue:1245
              msg = "incorrect type: expected array but got table (" .. tostring(repr(stack[stack_size])) .. ")" -- shunt/quicktype.yue:1245
            end -- shunt/quicktype.yue:1245
          else -- shunt/quicktype.yue:1245
            msg = nil -- shunt/quicktype.yue:1245
          end -- shunt/quicktype.yue:1245
          local new_size -- shunt/quicktype.yue:1245
          do -- shunt/quicktype.yue:1245
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1245
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1245
              new_size = _exp_0 -- shunt/quicktype.yue:1245
            else -- shunt/quicktype.yue:1245
              new_size = 0 -- shunt/quicktype.yue:1245
            end -- shunt/quicktype.yue:1245
          end -- shunt/quicktype.yue:1245
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1245
            stack[i] = nil -- shunt/quicktype.yue:1245
          end -- shunt/quicktype.yue:1245
          stack_size = new_size -- shunt/quicktype.yue:1245
          if num_unions == initial_unions then -- shunt/quicktype.yue:1245
            return msg -- shunt/quicktype.yue:1245
          end -- shunt/quicktype.yue:1245
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1245
          bailing = true -- shunt/quicktype.yue:1245
        end -- shunt/quicktype.yue:1244
      elseif C_ASSERT_EQ == instruction then -- shunt/quicktype.yue:1246
        if stack[stack_size] ~= check_prog[pc + 1] then -- shunt/quicktype.yue:1247
          local msg -- shunt/quicktype.yue:1248
          if num_unions == 0 then -- shunt/quicktype.yue:1248
            local pretty_key_parts = { } -- shunt/quicktype.yue:1248
            for i = 1, stack_size do -- shunt/quicktype.yue:1248
              pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1248
            end -- shunt/quicktype.yue:1248
            if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1248
              local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1248
              msg = "incorrect type: expected " .. tostring(type(check_prog[pc + 1])) .. " " .. tostring(repr(check_prog[pc + 1])) .. " but got " .. tostring(repr(stack[stack_size])) .. ' ' .. pretty_key -- shunt/quicktype.yue:1248
            else -- shunt/quicktype.yue:1248
              msg = "incorrect type: expected " .. tostring(type(check_prog[pc + 1])) .. " " .. tostring(repr(check_prog[pc + 1])) .. " but got " .. tostring(repr(stack[stack_size])) -- shunt/quicktype.yue:1248
            end -- shunt/quicktype.yue:1248
          else -- shunt/quicktype.yue:1248
            msg = nil -- shunt/quicktype.yue:1248
          end -- shunt/quicktype.yue:1248
          local new_size -- shunt/quicktype.yue:1248
          do -- shunt/quicktype.yue:1248
            local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1248
            if _exp_0 ~= nil then -- shunt/quicktype.yue:1248
              new_size = _exp_0 -- shunt/quicktype.yue:1248
            else -- shunt/quicktype.yue:1248
              new_size = 0 -- shunt/quicktype.yue:1248
            end -- shunt/quicktype.yue:1248
          end -- shunt/quicktype.yue:1248
          for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1248
            stack[i] = nil -- shunt/quicktype.yue:1248
          end -- shunt/quicktype.yue:1248
          stack_size = new_size -- shunt/quicktype.yue:1248
          if num_unions == initial_unions then -- shunt/quicktype.yue:1248
            return msg -- shunt/quicktype.yue:1248
          end -- shunt/quicktype.yue:1248
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1248
          bailing = true -- shunt/quicktype.yue:1248
        end -- shunt/quicktype.yue:1247
      elseif C_ASSERT_NEVER == instruction then -- shunt/quicktype.yue:1249
        local msg -- shunt/quicktype.yue:1250
        if num_unions == 0 then -- shunt/quicktype.yue:1250
          local pretty_key_parts = { } -- shunt/quicktype.yue:1250
          for i = 1, stack_size do -- shunt/quicktype.yue:1250
            pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1250
          end -- shunt/quicktype.yue:1250
          if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1250
            local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1250
            msg = 'never expected a value here' .. ' ' .. pretty_key -- shunt/quicktype.yue:1250
          else -- shunt/quicktype.yue:1250
            msg = 'never expected a value here' -- shunt/quicktype.yue:1250
          end -- shunt/quicktype.yue:1250
        else -- shunt/quicktype.yue:1250
          msg = nil -- shunt/quicktype.yue:1250
        end -- shunt/quicktype.yue:1250
        local new_size -- shunt/quicktype.yue:1250
        do -- shunt/quicktype.yue:1250
          local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1250
          if _exp_0 ~= nil then -- shunt/quicktype.yue:1250
            new_size = _exp_0 -- shunt/quicktype.yue:1250
          else -- shunt/quicktype.yue:1250
            new_size = 0 -- shunt/quicktype.yue:1250
          end -- shunt/quicktype.yue:1250
        end -- shunt/quicktype.yue:1250
        for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1250
          stack[i] = nil -- shunt/quicktype.yue:1250
        end -- shunt/quicktype.yue:1250
        stack_size = new_size -- shunt/quicktype.yue:1250
        if num_unions == initial_unions then -- shunt/quicktype.yue:1250
          return msg -- shunt/quicktype.yue:1250
        end -- shunt/quicktype.yue:1250
        pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1250
        bailing = true -- shunt/quicktype.yue:1250
      elseif C_GET_FIELD == instruction then -- shunt/quicktype.yue:1251
        stack_size = stack_size + 1 -- shunt/quicktype.yue:1252
        stack[stack_size] = stack[stack_size - 2][stack[stack_size - 1]] -- shunt/quicktype.yue:1253
        keys_used[stack_size] = stack[stack_size - 1] -- shunt/quicktype.yue:1254
      elseif C_INCR == instruction then -- shunt/quicktype.yue:1255
        stack[stack_size] = stack[stack_size] + 1 -- shunt/quicktype.yue:1256
      elseif C_DECR == instruction then -- shunt/quicktype.yue:1257
        stack[stack_size] = stack[stack_size] - 1 -- shunt/quicktype.yue:1258
      elseif C_NEXT == instruction then -- shunt/quicktype.yue:1259
        local tab = stack[stack_size - 1] -- shunt/quicktype.yue:1260
        local idx = stack[stack_size] -- shunt/quicktype.yue:1261
        local next_idx -- shunt/quicktype.yue:1262
        next_idx, value = next(tab, idx) -- shunt/quicktype.yue:1262
        stack[stack_size] = next_idx -- shunt/quicktype.yue:1263
        stack_size = stack_size + 1 -- shunt/quicktype.yue:1264
        stack[stack_size] = value -- shunt/quicktype.yue:1265
      elseif C_JMP == instruction then -- shunt/quicktype.yue:1266
        pc = check_prog[pc + 1] - 2 -- shunt/quicktype.yue:1267
      elseif C_JMP_IF_NIL == instruction then -- shunt/quicktype.yue:1268
        if not (stack[stack_size] ~= nil) then -- shunt/quicktype.yue:1269
          pc = check_prog[pc + 1] - 2 -- shunt/quicktype.yue:1270
        end -- shunt/quicktype.yue:1269
      elseif C_PUSH_CHECKER == instruction then -- shunt/quicktype.yue:1271
        local arg = check_prog[pc + 1] -- shunt/quicktype.yue:1272
        local checker = type_checkers[arg] -- shunt/quicktype.yue:1273
        if not (checker ~= nil) then -- shunt/quicktype.yue:1274
          return "cannot typecheck: type " .. tostring(arg) .. " not defined" -- shunt/quicktype.yue:1275
        end -- shunt/quicktype.yue:1274
        if #checker == 2 and #check_prog == 2 then -- shunt/quicktype.yue:1276
          local ccmd, carg = checker[1], checker[2] -- shunt/quicktype.yue:1278
          if check_prog[pc] == ccmd and arg == carg then -- shunt/quicktype.yue:1279
            return "cannot typecheck: type " .. tostring(arg) .. " not defined" -- shunt/quicktype.yue:1280
          end -- shunt/quicktype.yue:1279
        end -- shunt/quicktype.yue:1276
        num_running_checkers = num_running_checkers + 1 -- shunt/quicktype.yue:1282
        local err = check(checker, nil, false) -- shunt/quicktype.yue:1283
        num_running_checkers = num_running_checkers - 1 -- shunt/quicktype.yue:1284
        if (err ~= nil) then -- shunt/quicktype.yue:1286
          if num_unions == 0 then -- shunt/quicktype.yue:1287
            return err -- shunt/quicktype.yue:1288
          end -- shunt/quicktype.yue:1287
          bailing = true -- shunt/quicktype.yue:1290
          pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1291
        end -- shunt/quicktype.yue:1286
      elseif C_CLEAR_BAILING == instruction then -- shunt/quicktype.yue:1292
        bailing = false -- shunt/quicktype.yue:1293
      elseif C_SET_UNION_BAIL_TARGET == instruction then -- shunt/quicktype.yue:1294
        union_bail_jumps[num_unions] = check_prog[pc + 1] -- shunt/quicktype.yue:1295
      elseif C_PUSH_UNION_CTX == instruction then -- shunt/quicktype.yue:1296
        num_unions = num_unions + 1 -- shunt/quicktype.yue:1297
        union_depths[num_unions] = #stack -- shunt/quicktype.yue:1298
        if num_unions == 1 then -- shunt/quicktype.yue:1299
          root_union = check_prog[pc + 1] -- shunt/quicktype.yue:1300
        end -- shunt/quicktype.yue:1299
      elseif C_POP_UNION_CTX == instruction then -- shunt/quicktype.yue:1301
        union_bail_jumps[num_unions] = nil -- shunt/quicktype.yue:1302
        union_depths[num_unions] = nil -- shunt/quicktype.yue:1303
        num_unions = num_unions - 1 -- shunt/quicktype.yue:1304
        local tmp_root_union = root_union -- shunt/quicktype.yue:1306
        if num_unions == 0 then -- shunt/quicktype.yue:1307
          root_union = nil -- shunt/quicktype.yue:1308
        end -- shunt/quicktype.yue:1307
        if bailing then -- shunt/quicktype.yue:1309
          if num_unions == 0 then -- shunt/quicktype.yue:1310
            local msg -- shunt/quicktype.yue:1311
            if num_unions == 0 then -- shunt/quicktype.yue:1311
              local pretty_key_parts = { } -- shunt/quicktype.yue:1311
              for i = 1, stack_size do -- shunt/quicktype.yue:1311
                pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1311
              end -- shunt/quicktype.yue:1311
              if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1311
                local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1311
                msg = "incorrect type: expected " .. tostring(tmp_root_union) .. " but got " .. tostring(type(stack[stack_size])) .. " (" .. tostring(repr(stack[stack_size])) .. ")" .. ' ' .. pretty_key -- shunt/quicktype.yue:1311
              else -- shunt/quicktype.yue:1311
                msg = "incorrect type: expected " .. tostring(tmp_root_union) .. " but got " .. tostring(type(stack[stack_size])) .. " (" .. tostring(repr(stack[stack_size])) .. ")" -- shunt/quicktype.yue:1311
              end -- shunt/quicktype.yue:1311
            else -- shunt/quicktype.yue:1311
              msg = nil -- shunt/quicktype.yue:1311
            end -- shunt/quicktype.yue:1311
            local new_size -- shunt/quicktype.yue:1311
            do -- shunt/quicktype.yue:1311
              local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1311
              if _exp_0 ~= nil then -- shunt/quicktype.yue:1311
                new_size = _exp_0 -- shunt/quicktype.yue:1311
              else -- shunt/quicktype.yue:1311
                new_size = 0 -- shunt/quicktype.yue:1311
              end -- shunt/quicktype.yue:1311
            end -- shunt/quicktype.yue:1311
            for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1311
              stack[i] = nil -- shunt/quicktype.yue:1311
            end -- shunt/quicktype.yue:1311
            stack_size = new_size -- shunt/quicktype.yue:1311
            if num_unions == initial_unions then -- shunt/quicktype.yue:1311
              return msg -- shunt/quicktype.yue:1311
            end -- shunt/quicktype.yue:1311
            pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1311
            bailing = true -- shunt/quicktype.yue:1311
          else -- shunt/quicktype.yue:1313
            local msg -- shunt/quicktype.yue:1313
            if num_unions == 0 then -- shunt/quicktype.yue:1313
              local pretty_key_parts = { } -- shunt/quicktype.yue:1313
              for i = 1, stack_size do -- shunt/quicktype.yue:1313
                pretty_key_parts[#pretty_key_parts + 1] = keys_used[i] -- shunt/quicktype.yue:1313
              end -- shunt/quicktype.yue:1313
              if #pretty_key_parts > 0 then -- shunt/quicktype.yue:1313
                local pretty_key = "(at field ." .. tostring(table.concat(pretty_key_parts, ".")) .. ")" -- shunt/quicktype.yue:1313
                msg = nil .. ' ' .. pretty_key -- shunt/quicktype.yue:1313
              else -- shunt/quicktype.yue:1313
                msg = nil -- shunt/quicktype.yue:1313
              end -- shunt/quicktype.yue:1313
            else -- shunt/quicktype.yue:1313
              msg = nil -- shunt/quicktype.yue:1313
            end -- shunt/quicktype.yue:1313
            local new_size -- shunt/quicktype.yue:1313
            do -- shunt/quicktype.yue:1313
              local _exp_0 = union_depths[num_unions] -- shunt/quicktype.yue:1313
              if _exp_0 ~= nil then -- shunt/quicktype.yue:1313
                new_size = _exp_0 -- shunt/quicktype.yue:1313
              else -- shunt/quicktype.yue:1313
                new_size = 0 -- shunt/quicktype.yue:1313
              end -- shunt/quicktype.yue:1313
            end -- shunt/quicktype.yue:1313
            for i = new_size + 1, stack_size do -- shunt/quicktype.yue:1313
              stack[i] = nil -- shunt/quicktype.yue:1313
            end -- shunt/quicktype.yue:1313
            stack_size = new_size -- shunt/quicktype.yue:1313
            if num_unions == initial_unions then -- shunt/quicktype.yue:1313
              return msg -- shunt/quicktype.yue:1313
            end -- shunt/quicktype.yue:1313
            pc = union_bail_jumps[num_unions] - 2 -- shunt/quicktype.yue:1313
            bailing = true -- shunt/quicktype.yue:1313
          end -- shunt/quicktype.yue:1310
        end -- shunt/quicktype.yue:1309
      else -- shunt/quicktype.yue:1315
        error("internal error: illegal type-checker VM instruction " .. tostring(check_prog[pc]) .. "@" .. tostring(pc)) -- shunt/quicktype.yue:1315
      end -- shunt/quicktype.yue:1315
    end -- shunt/quicktype.yue:1315
    local ending_stack_size = stack_size -- shunt/quicktype.yue:1319
    if root then -- shunt/quicktype.yue:1320
      stack[1] = nil -- shunt/quicktype.yue:1322
      stack_size = 0 -- shunt/quicktype.yue:1323
    end -- shunt/quicktype.yue:1320
    if num_running_checkers ~= initial_num_running_checkers then -- shunt/quicktype.yue:1324
      error("internal error: checker depth incorrectly handled: expected " .. tostring(initial_num_running_checkers) .. " but got " .. tostring(num_running_checkers)) -- shunt/quicktype.yue:1325
    end -- shunt/quicktype.yue:1324
    if ending_stack_size ~= initial_stack_size then -- shunt/quicktype.yue:1326
      error("internal error: value stack incorrectly handled (" .. tostring(repr(check_prog)) .. ")") -- shunt/quicktype.yue:1327
    end -- shunt/quicktype.yue:1326
  end -- shunt/quicktype.yue:1187
  return nil -- shunt/quicktype.yue:1328
end -- shunt/quicktype.yue:1163
user_types = { } -- shunt/quicktype.yue:1330
declare_type = function(name, type_spec) -- shunt/quicktype.yue:1331
  if not (name ~= nil) then -- shunt/quicktype.yue:1332
    error("declare_type requires a name") -- shunt/quicktype.yue:1333
  end -- shunt/quicktype.yue:1332
  if 'string' ~= type(name) then -- shunt/quicktype.yue:1334
    error("declare_type requires a string name") -- shunt/quicktype.yue:1335
  end -- shunt/quicktype.yue:1334
  if not (type_spec ~= nil) then -- shunt/quicktype.yue:1336
    error("declare_type requires a type_spec") -- shunt/quicktype.yue:1337
  end -- shunt/quicktype.yue:1336
  if 'string' ~= type(type_spec) then -- shunt/quicktype.yue:1338
    error("declare_type requires a string type_spec") -- shunt/quicktype.yue:1339
  end -- shunt/quicktype.yue:1338
  local prefix, unprefixed_name = name:match('^([^.]+)%.([^.]*)$') -- shunt/quicktype.yue:1341
  if unprefixed_name == nil then -- shunt/quicktype.yue:1342
    unprefixed_name = name -- shunt/quicktype.yue:1342
  end -- shunt/quicktype.yue:1342
  if (prefix ~= nil) then -- shunt/quicktype.yue:1344
    if (known_primitives[prefix] ~= nil) then -- shunt/quicktype.yue:1345
      error("cannot use '" .. tostring(prefix) .. "' as type-prefix: must not be a primitive") -- shunt/quicktype.yue:1346
    end -- shunt/quicktype.yue:1345
    if not prefix:match('^[a-z]') then -- shunt/quicktype.yue:1347
      error("cannot use '" .. tostring(prefix) .. "' as type-prefix: must start with a lowercase letter") -- shunt/quicktype.yue:1348
    end -- shunt/quicktype.yue:1347
  end -- shunt/quicktype.yue:1344
  if #unprefixed_name < 2 then -- shunt/quicktype.yue:1350
    error("cannot declare type '" .. tostring(unprefixed_name) .. "': name too short") -- shunt/quicktype.yue:1351
  end -- shunt/quicktype.yue:1350
  if not (unprefixed_name:sub(1, 1)):match('^[A-Z_]$') then -- shunt/quicktype.yue:1352
    error("cannot declare type '" .. tostring(unprefixed_name) .. "': user types must start with uppercase or '_'") -- shunt/quicktype.yue:1353
  end -- shunt/quicktype.yue:1352
  if not unprefixed_name:match('^[a-zA-Z0-9_-]*[a-zA-Z0-9_]$') then -- shunt/quicktype.yue:1354
    error("cannot declare type '" .. tostring(unprefixed_name) .. "': not a valid identifier") -- shunt/quicktype.yue:1355
  end -- shunt/quicktype.yue:1354
  if (user_types[name] ~= nil) then -- shunt/quicktype.yue:1357
    error("cannot redefine type '" .. tostring(unprefixed_name) .. "'") -- shunt/quicktype.yue:1358
  end -- shunt/quicktype.yue:1357
  local parsed_type = parse(type_spec) -- shunt/quicktype.yue:1359
  user_types[name] = parsed_type -- shunt/quicktype.yue:1360
  type_checkers[name] = parsed_type:checker():build() -- shunt/quicktype.yue:1361
end -- shunt/quicktype.yue:1331
_module_0["declare_type"] = declare_type -- shunt/quicktype.yue:1361
declare_type('Self', 'some') -- shunt/quicktype.yue:1363
declare_singleton_type = function(value) -- shunt/quicktype.yue:1365
  if not (value ~= nil) then -- shunt/quicktype.yue:1366
    error("declare_singleton_type requires a value") -- shunt/quicktype.yue:1367
  end -- shunt/quicktype.yue:1366
  if 'table' ~= type(value) then -- shunt/quicktype.yue:1368
    error("declare_singleton_type requires a table value") -- shunt/quicktype.yue:1369
  end -- shunt/quicktype.yue:1368
  local name = tostring(value) -- shunt/quicktype.yue:1371
  if #name < 2 then -- shunt/quicktype.yue:1372
    error("cannot declare type '" .. tostring(name) .. "': name too short") -- shunt/quicktype.yue:1373
  end -- shunt/quicktype.yue:1372
  if not (name:sub(1, 1)):match('^[A-Z_]$') then -- shunt/quicktype.yue:1374
    error("cannot declare type '" .. tostring(name) .. "': user types must start with an uppercase letter or '_'") -- shunt/quicktype.yue:1375
  end -- shunt/quicktype.yue:1374
  if not name:match('^[a-zA-Z0-9_-]*[a-zA-Z0-9_]$') then -- shunt/quicktype.yue:1376
    error("cannot declare type '" .. tostring(name) .. "': not a valid identifier") -- shunt/quicktype.yue:1377
  end -- shunt/quicktype.yue:1376
  if (user_types[name] ~= nil) then -- shunt/quicktype.yue:1378
    error("cannot redefine type '" .. tostring(name) .. "'") -- shunt/quicktype.yue:1379
  end -- shunt/quicktype.yue:1378
  local ty = SingletonType(name, value) -- shunt/quicktype.yue:1381
  user_types[name] = ty -- shunt/quicktype.yue:1382
  type_checkers[name] = ty:checker():build() -- shunt/quicktype.yue:1383
end -- shunt/quicktype.yue:1365
_module_0["declare_singleton_type"] = declare_singleton_type -- shunt/quicktype.yue:1383
skip_typechecking = false -- shunt/quicktype.yue:1385
deactivate_typechecks = function() -- shunt/quicktype.yue:1386
  skip_typechecking = true -- shunt/quicktype.yue:1387
end -- shunt/quicktype.yue:1386
_module_0["deactivate_typechecks"] = deactivate_typechecks -- shunt/quicktype.yue:1387
stats = function() -- shunt/quicktype.yue:1389
  local stats_arr -- shunt/quicktype.yue:1390
  do -- shunt/quicktype.yue:1390
    local _accum_0 = { } -- shunt/quicktype.yue:1390
    local _len_0 = 1 -- shunt/quicktype.yue:1390
    for instruction, count in pairs(instruction_counts) do -- shunt/quicktype.yue:1390
      _accum_0[_len_0] = { -- shunt/quicktype.yue:1390
        instruction = instruction, -- shunt/quicktype.yue:1390
        count = count -- shunt/quicktype.yue:1390
      } -- shunt/quicktype.yue:1390
      _len_0 = _len_0 + 1 -- shunt/quicktype.yue:1390
    end -- shunt/quicktype.yue:1390
    stats_arr = _accum_0 -- shunt/quicktype.yue:1390
  end -- shunt/quicktype.yue:1390
  table.sort(stats_arr, function(a, b) -- shunt/quicktype.yue:1391
    return a.count > b.count -- shunt/quicktype.yue:1391
  end) -- shunt/quicktype.yue:1391
  return stats_arr -- shunt/quicktype.yue:1392
end -- shunt/quicktype.yue:1389
_module_0["stats"] = stats -- shunt/quicktype.yue:1392
spec(function() -- shunt/quicktype.yue:1394
  local describe, it, matchers -- shunt/quicktype.yue:0
  do -- shunt/quicktype.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/quicktype.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/quicktype.yue:0
  end -- shunt/quicktype.yue:0
  local anything, contains_value, deep_eq, each_value, eq, errors, has_fields, ge, gt, len, match, matches, no_errors = matchers.anything, matchers.contains_value, matchers.deep_eq, matchers.each_value, matchers.eq, matchers.errors, matchers.has_fields, matchers.ge, matchers.gt, matchers.len, matchers.match, matchers.matches, matchers.no_errors -- shunt/quicktype.yue:1399
  describe('Lexer', function() -- shunt/quicktype.yue:1401
    local tokens -- shunt/quicktype.yue:1402
    tokens = function(raw) -- shunt/quicktype.yue:1402
      assert(raw) -- shunt/quicktype.yue:1403
      local _with_0 = { } -- shunt/quicktype.yue:1404
      for token in (Lexer(raw)).tokens do -- shunt/quicktype.yue:1405
        _with_0[#_with_0 + 1] = token -- shunt/quicktype.yue:1406
      end -- shunt/quicktype.yue:1406
      return _with_0 -- shunt/quicktype.yue:1404
    end -- shunt/quicktype.yue:1402
    it('emits simple types', function() -- shunt/quicktype.yue:1408
      local simple_types = { -- shunt/quicktype.yue:1410
        type(nil), -- shunt/quicktype.yue:1410
        type(false), -- shunt/quicktype.yue:1411
        type(0), -- shunt/quicktype.yue:1412
        type(""), -- shunt/quicktype.yue:1413
        type(function() end), -- shunt/quicktype.yue:1414
        type(coroutine.create(function() end)), -- shunt/quicktype.yue:1415
        'any', -- shunt/quicktype.yue:1416
        'some' -- shunt/quicktype.yue:1417
      } -- shunt/quicktype.yue:1409
      for _index_0 = 1, #simple_types do -- shunt/quicktype.yue:1418
        local simple_type = simple_types[_index_0] -- shunt/quicktype.yue:1418
        require('shunt.spec')._expect_that([=[(tokens simple_type)]=], (tokens(simple_type)), (deep_eq({ -- shunt/quicktype.yue:1419
          Symbol(T_NAME, simple_type) -- shunt/quicktype.yue:1419
        })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1419)) -- shunt/quicktype.yue:1419
      end -- shunt/quicktype.yue:1421
    end) -- shunt/quicktype.yue:1408
    it('emits prefixed simple type', function() -- shunt/quicktype.yue:1423
      return require('shunt.spec')._expect_that([=[(tokens 'prefixed.Name')]=], (tokens('prefixed.Name')), (deep_eq({ -- shunt/quicktype.yue:1424
        Symbol(T_PREFIXED_NAME, 'prefixed.Name') -- shunt/quicktype.yue:1424
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1424)) -- shunt/quicktype.yue:1426
    end) -- shunt/quicktype.yue:1423
    it('emits the never type', function() -- shunt/quicktype.yue:1428
      return require('shunt.spec')._expect_that([=[(tokens '!')]=], (tokens('!')), (deep_eq({ -- shunt/quicktype.yue:1429
        Symbol(T_BANG) -- shunt/quicktype.yue:1429
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1429)) -- shunt/quicktype.yue:1431
    end) -- shunt/quicktype.yue:1428
    it('emits boolean types', function() -- shunt/quicktype.yue:1433
      return require('shunt.spec')._expect_that([=[(tokens 'true false')]=], (tokens('true false')), (deep_eq({ -- shunt/quicktype.yue:1434
        Symbol(T_BOOLEAN, true), -- shunt/quicktype.yue:1434
        Symbol(T_BOOLEAN, false) -- shunt/quicktype.yue:1434
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1434)) -- shunt/quicktype.yue:1436
    end) -- shunt/quicktype.yue:1433
    it('emits number types', function() -- shunt/quicktype.yue:1438
      return require('shunt.spec')._expect_that([=[(tokens '123 456.654 .789 -123 -456.654 -.789')]=], (tokens('123 456.654 .789 -123 -456.654 -.789')), (deep_eq({ -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, 123), -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, 456.654), -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, .789), -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, -123), -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, -456.654), -- shunt/quicktype.yue:1439
        Symbol(T_NUMBER, -.789) -- shunt/quicktype.yue:1439
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1439)) -- shunt/quicktype.yue:1446
    end) -- shunt/quicktype.yue:1438
    it('emits string types', function() -- shunt/quicktype.yue:1448
      return require('shunt.spec')._expect_that([=[(tokens '"hello" "world"')]=], (tokens('"hello" "world"')), (deep_eq({ -- shunt/quicktype.yue:1449
        Symbol(T_STRING, 'hello'), -- shunt/quicktype.yue:1449
        Symbol(T_STRING, 'world') -- shunt/quicktype.yue:1449
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1449)) -- shunt/quicktype.yue:1452
    end) -- shunt/quicktype.yue:1448
    it('emits strucural tokens', function() -- shunt/quicktype.yue:1454
      return require('shunt.spec')._expect_that([==[(tokens '(),{}[]:->=>...?+|~')]==], (tokens('(),{}[]:->=>...?+|~')), (deep_eq({ -- shunt/quicktype.yue:1455
        Symbol(T_PAREN_OPEN), -- shunt/quicktype.yue:1455
        Symbol(T_PAREN_CLOSE), -- shunt/quicktype.yue:1455
        Symbol(T_COMMA), -- shunt/quicktype.yue:1455
        Symbol(T_BRACE_OPEN), -- shunt/quicktype.yue:1455
        Symbol(T_BRACE_CLOSE), -- shunt/quicktype.yue:1455
        Symbol(T_BRACKET_OPEN), -- shunt/quicktype.yue:1455
        Symbol(T_BRACKET_CLOSE), -- shunt/quicktype.yue:1455
        Symbol(T_COLON), -- shunt/quicktype.yue:1455
        Symbol(T_THIN_ARROW), -- shunt/quicktype.yue:1455
        Symbol(T_FAT_ARROW), -- shunt/quicktype.yue:1455
        Symbol(T_DOTDOTDOT), -- shunt/quicktype.yue:1455
        Symbol(T_QUESTION), -- shunt/quicktype.yue:1455
        Symbol(T_PLUS), -- shunt/quicktype.yue:1455
        Symbol(T_PIPE), -- shunt/quicktype.yue:1455
        Symbol(T_TILDE) -- shunt/quicktype.yue:1455
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1455)) -- shunt/quicktype.yue:1471
    end) -- shunt/quicktype.yue:1454
    it('ignores whitespace', function() -- shunt/quicktype.yue:1473
      return require('shunt.spec')._expect_that([=[(tokens ' (\tstr_ing\r)\n-> str-ing ')]=], (tokens(' (\tstr_ing\r)\n-> str-ing ')), (deep_eq({ -- shunt/quicktype.yue:1474
        Symbol(T_PAREN_OPEN), -- shunt/quicktype.yue:1474
        Symbol(T_NAME, "str_ing"), -- shunt/quicktype.yue:1474
        Symbol(T_PAREN_CLOSE), -- shunt/quicktype.yue:1474
        Symbol(T_THIN_ARROW), -- shunt/quicktype.yue:1474
        Symbol(T_NAME, "str-ing") -- shunt/quicktype.yue:1474
      })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1474)) -- shunt/quicktype.yue:1480
    end) -- shunt/quicktype.yue:1473
    it('ignores comments', function() -- shunt/quicktype.yue:1482
      return require('shunt.spec')._expect_that([=[(tokens '-- hello\n--world!')]=], (tokens('-- hello\n--world!')), (deep_eq({ })), tostring("shunt/quicktype.yue") .. ":" .. tostring(1483)) -- shunt/quicktype.yue:1483
    end) -- shunt/quicktype.yue:1482
    it('rejects unexpected characters', function() -- shunt/quicktype.yue:1485
      return require('shunt.spec')._expect_that([=[(-> tokens '*')]=], (function() -- shunt/quicktype.yue:1486
        return tokens('*') -- shunt/quicktype.yue:1486
      end), (errors(matches([[unexpected character '%*']]))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1486)) -- shunt/quicktype.yue:1486
    end) -- shunt/quicktype.yue:1485
    return describe(':peek', function() -- shunt/quicktype.yue:1488
      it('matches :next', function() -- shunt/quicktype.yue:1489
        local lexer = Lexer('()'); -- shunt/quicktype.yue:1490
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_PAREN_OPEN))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1491)); -- shunt/quicktype.yue:1491
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_PAREN_OPEN))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1492)); -- shunt/quicktype.yue:1492
        require('shunt.spec')._assert_that([=[lexer\next!]=], lexer:next(), (deep_eq(Symbol(T_PAREN_OPEN))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1493)); -- shunt/quicktype.yue:1493
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_PAREN_CLOSE))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1494)); -- shunt/quicktype.yue:1494
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_PAREN_CLOSE))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1495)); -- shunt/quicktype.yue:1495
        return require('shunt.spec')._assert_that([=[lexer\next!]=], lexer:next(), (deep_eq(Symbol(T_PAREN_CLOSE))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1496)) -- shunt/quicktype.yue:1496
      end) -- shunt/quicktype.yue:1489
      return it('returns nil at EOF', function() -- shunt/quicktype.yue:1498
        local lexer = Lexer(''); -- shunt/quicktype.yue:1499
        require('shunt.spec')._expect_that([=[lexer\peek!]=], lexer:peek(), (eq(nil)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1500)); -- shunt/quicktype.yue:1500
        return require('shunt.spec')._expect_that([=[lexer\peek!]=], lexer:peek(), (eq(nil)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1501)) -- shunt/quicktype.yue:1501
      end) -- shunt/quicktype.yue:1501
    end) -- shunt/quicktype.yue:1501
  end) -- shunt/quicktype.yue:1401
  describe('TypeSpecParser', function() -- shunt/quicktype.yue:1503
    describe('run on simple types', function() -- shunt/quicktype.yue:1504
      it('accepts primitives', function() -- shunt/quicktype.yue:1505
        require('shunt.spec')._expect_that([=[(parse 'nil')]=], (parse('nil')), (deep_eq(Primitive(type(nil)))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1506)); -- shunt/quicktype.yue:1506
        require('shunt.spec')._expect_that([=[(parse 'number')]=], (parse('number')), (deep_eq(Primitive(type(0)))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1507)); -- shunt/quicktype.yue:1507
        require('shunt.spec')._expect_that([=[(parse 'number')]=], (parse('number')), (deep_eq(Primitive(type(0.0)))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1508)); -- shunt/quicktype.yue:1508
        require('shunt.spec')._expect_that([=[(parse 'string')]=], (parse('string')), (deep_eq(Primitive(type("")))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1509)); -- shunt/quicktype.yue:1509
        require('shunt.spec')._expect_that([=[(parse 'table')]=], (parse('table')), (deep_eq(Primitive(type({ })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1510)); -- shunt/quicktype.yue:1510
        require('shunt.spec')._expect_that([=[(parse 'function')]=], (parse('function')), (deep_eq(Primitive(type(function() end)))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1511)); -- shunt/quicktype.yue:1511
        require('shunt.spec')._expect_that([=[(parse 'thread')]=], (parse('thread')), (deep_eq(Primitive(type(coroutine.create(function() end))))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1512)); -- shunt/quicktype.yue:1512
        require('shunt.spec')._expect_that([=[(parse 'userdata')]=], (parse('userdata')), (deep_eq(Primitive('userdata'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1513)); -- shunt/quicktype.yue:1513
        require('shunt.spec')._expect_that([=[(parse 'any')]=], (parse('any')), (deep_eq(Any())), tostring("shunt/quicktype.yue") .. ":" .. tostring(1514)); -- shunt/quicktype.yue:1514
        require('shunt.spec')._expect_that([=[(parse 'some')]=], (parse('some')), (deep_eq(Some())), tostring("shunt/quicktype.yue") .. ":" .. tostring(1515)); -- shunt/quicktype.yue:1515
        return require('shunt.spec')._expect_that([=[(parse '!')]=], (parse('!')), (deep_eq(Never())), tostring("shunt/quicktype.yue") .. ":" .. tostring(1516)) -- shunt/quicktype.yue:1516
      end) -- shunt/quicktype.yue:1505
      it('accepts user types', function() -- shunt/quicktype.yue:1518
        return require('shunt.spec')._expect_that([=[(parse 'UserType')]=], (parse('UserType')), (deep_eq(UserType('UserType'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1519)) -- shunt/quicktype.yue:1519
      end) -- shunt/quicktype.yue:1518
      it('accepts prefixed user types', function() -- shunt/quicktype.yue:1521
        return require('shunt.spec')._expect_that([=[(parse 'prefixed.UserType')]=], (parse('prefixed.UserType')), (deep_eq(UserType('prefixed.UserType'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1522)) -- shunt/quicktype.yue:1522
      end) -- shunt/quicktype.yue:1521
      it('accepts boolean types', function() -- shunt/quicktype.yue:1524
        require('shunt.spec')._expect_that([=[(parse 'true')]=], (parse('true')), (deep_eq(BooleanType(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1525)); -- shunt/quicktype.yue:1525
        return require('shunt.spec')._expect_that([=[(parse 'false')]=], (parse('false')), (deep_eq(BooleanType(false))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1526)) -- shunt/quicktype.yue:1526
      end) -- shunt/quicktype.yue:1524
      it('accepts number types', function() -- shunt/quicktype.yue:1528
        return require('shunt.spec')._expect_that([=[(parse '123')]=], (parse('123')), (deep_eq(NumberType(123))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1529)) -- shunt/quicktype.yue:1529
      end) -- shunt/quicktype.yue:1528
      it('accepts string types', function() -- shunt/quicktype.yue:1531
        return require('shunt.spec')._expect_that([=[(parse '"hello"')]=], (parse('"hello"')), (deep_eq(StringType('hello'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1532)) -- shunt/quicktype.yue:1532
      end) -- shunt/quicktype.yue:1531
      it('rejects unknown primitives', function() -- shunt/quicktype.yue:1534
        return require('shunt.spec')._expect_that([=[(-> parse 'user')]=], (function() -- shunt/quicktype.yue:1535
          return parse('user') -- shunt/quicktype.yue:1535
        end), (errors(matches([[cannot use 'user' as user type name: name must start with an uppercase letter]]))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1535)) -- shunt/quicktype.yue:1535
      end) -- shunt/quicktype.yue:1534
      it('rejects malformed prefixed identifiers', function() -- shunt/quicktype.yue:1537
        require('shunt.spec')._expect_that([=[(-> parse 'foo.')]=], (function() -- shunt/quicktype.yue:1538
          return parse('foo.') -- shunt/quicktype.yue:1538
        end), (errors(matches('foo'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1538)); -- shunt/quicktype.yue:1538
        require('shunt.spec')._expect_that([=[(-> parse '.Bar')]=], (function() -- shunt/quicktype.yue:1539
          return parse('.Bar') -- shunt/quicktype.yue:1539
        end), (errors(matches("unexpected character '%.'"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1539)); -- shunt/quicktype.yue:1539
        require('shunt.spec')._expect_that([=[(-> parse 'Foo.bar')]=], (function() -- shunt/quicktype.yue:1540
          return parse('Foo.bar') -- shunt/quicktype.yue:1540
        end), (errors(matches("cannot use 'Foo' as type%-prefix: must start with a lowercase letter"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1540)); -- shunt/quicktype.yue:1540
        require('shunt.spec')._expect_that([=[(-> parse 'foo.bar')]=], (function() -- shunt/quicktype.yue:1541
          return parse('foo.bar') -- shunt/quicktype.yue:1541
        end), (errors(matches("cannot use 'bar' as disambiguated type name: must start with an uppercase letter"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1541)); -- shunt/quicktype.yue:1541
        return require('shunt.spec')._expect_that([=[(-> parse 'number.Bar')]=], (function() -- shunt/quicktype.yue:1542
          return parse('number.Bar') -- shunt/quicktype.yue:1542
        end), (errors(matches("cannot use 'number' as type%-prefix: must not be a primitive"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1542)) -- shunt/quicktype.yue:1542
      end) -- shunt/quicktype.yue:1537
      it('rejects incomplete types', function() -- shunt/quicktype.yue:1544
        return require('shunt.spec')._expect_that([=[(-> parse '[')]=], (function() -- shunt/quicktype.yue:1545
          return parse('[') -- shunt/quicktype.yue:1545
        end), (errors(matches([[unexpected EOF]]))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1545)) -- shunt/quicktype.yue:1545
      end) -- shunt/quicktype.yue:1544
      return it('rejects inputs with trailing errors', function() -- shunt/quicktype.yue:1547
        return require('shunt.spec')._expect_that([=[(-> parse 'string]')]=], (function() -- shunt/quicktype.yue:1548
          return parse('string]') -- shunt/quicktype.yue:1548
        end), (errors(matches('type spec has trailing characters'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1548)) -- shunt/quicktype.yue:1548
      end) -- shunt/quicktype.yue:1548
    end) -- shunt/quicktype.yue:1504
    return describe('run on composite types', function() -- shunt/quicktype.yue:1550
      it('accepts optional', function() -- shunt/quicktype.yue:1551
        require('shunt.spec')._expect_that([=[(parse '?nil')]=], (parse('?nil')), (deep_eq(Optional(Primitive('nil')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1552)); -- shunt/quicktype.yue:1552
        require('shunt.spec')._expect_that([=[(parse '?string')]=], (parse('?string')), (deep_eq(Optional(Primitive('string')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1553)); -- shunt/quicktype.yue:1553
        return require('shunt.spec')._expect_that([=[(parse '?() -> nil')]=], (parse('?() -> nil')), (deep_eq(Optional(Function({ }, { -- shunt/quicktype.yue:1554
          Primitive('nil') -- shunt/quicktype.yue:1554
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1554)) -- shunt/quicktype.yue:1554
      end) -- shunt/quicktype.yue:1551
      it('accepts arrays', function() -- shunt/quicktype.yue:1556
        require('shunt.spec')._expect_that([=[(parse '[string]')]=], (parse('[string]')), (deep_eq(Array(Primitive('string')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1557)); -- shunt/quicktype.yue:1557
        require('shunt.spec')._expect_that([=[(parse '[[string]]')]=], (parse('[[string]]')), (deep_eq(Array(Array(Primitive('string'))))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1558)); -- shunt/quicktype.yue:1558
        return require('shunt.spec')._expect_that([=[(parse '~[string]')]=], (parse('~[string]')), (deep_eq((Array(Primitive('string'))):table_like(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1559)) -- shunt/quicktype.yue:1560
      end) -- shunt/quicktype.yue:1556
      it('accepts tuples', function() -- shunt/quicktype.yue:1562
        require('shunt.spec')._expect_that([=[(parse '()')]=], (parse('()')), (deep_eq(Tuple({ }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1563)); -- shunt/quicktype.yue:1563
        require('shunt.spec')._expect_that([=[(parse '(nil,)')]=], (parse('(nil,)')), (deep_eq(Tuple({ -- shunt/quicktype.yue:1564
          Primitive('nil') -- shunt/quicktype.yue:1564
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1564)); -- shunt/quicktype.yue:1564
        require('shunt.spec')._expect_that([=[(parse '(nil, number)')]=], (parse('(nil, number)')), (deep_eq(Tuple({ -- shunt/quicktype.yue:1565
          (Primitive('nil')), -- shunt/quicktype.yue:1565
          Primitive('number') -- shunt/quicktype.yue:1565
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1565)); -- shunt/quicktype.yue:1565
        require('shunt.spec')._expect_that([=[(parse '((nil, number), string, (User, table))')]=], (parse('((nil, number), string, (User, table))')), (deep_eq(Tuple({ -- shunt/quicktype.yue:1566
          Tuple({ -- shunt/quicktype.yue:1566
            (Primitive('nil')), -- shunt/quicktype.yue:1566
            (Primitive('number')) -- shunt/quicktype.yue:1566
          }), -- shunt/quicktype.yue:1566
          Primitive('string'), -- shunt/quicktype.yue:1566
          Tuple({ -- shunt/quicktype.yue:1566
            (UserType('User')), -- shunt/quicktype.yue:1566
            (Primitive('table')) -- shunt/quicktype.yue:1566
          }) -- shunt/quicktype.yue:1566
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1566)); -- shunt/quicktype.yue:1566
        return require('shunt.spec')._expect_that([=[(parse '~()')]=], (parse('~()')), (deep_eq((Tuple({ })):table_like(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1572)) -- shunt/quicktype.yue:1573
      end) -- shunt/quicktype.yue:1562
      it('accepts sets', function() -- shunt/quicktype.yue:1575
        require('shunt.spec')._expect_that([=[(parse '{string}')]=], (parse('{string}')), (deep_eq(Set(nil, Primitive('string')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1576)); -- shunt/quicktype.yue:1576
        require('shunt.spec')._expect_that([=[(parse '{{string}}')]=], (parse('{{string}}')), (deep_eq(Set(nil, Set(nil, Primitive('string'))))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1577)); -- shunt/quicktype.yue:1577
        require('shunt.spec')._expect_that([=[(parse '{<>: {}, string}')]=], (parse('{<>: {}, string}')), (deep_eq(Set((Struct(nil, { })), Primitive('string')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1578)); -- shunt/quicktype.yue:1578
        return require('shunt.spec')._expect_that([=[(parse '~{string}')]=], (parse('~{string}')), (deep_eq((Set(nil, Primitive('string'))):table_like(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1580)) -- shunt/quicktype.yue:1581
      end) -- shunt/quicktype.yue:1575
      it('accepts mappings', function() -- shunt/quicktype.yue:1583
        require('shunt.spec')._expect_that([=[(parse '{boolean -> number}')]=], (parse('{boolean -> number}')), (deep_eq(Mapping(nil, (Primitive('boolean')), Primitive('number')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1584)); -- shunt/quicktype.yue:1584
        require('shunt.spec')._expect_that([=[(parse '{{boolean -> number} -> {string -> thread}}')]=], (parse('{{boolean -> number} -> {string -> thread}}')), (deep_eq(Mapping(nil, (Mapping(nil, (Primitive('boolean')), Primitive('number'))), Mapping(nil, (Primitive('string')), Primitive('thread'))))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1585)); -- shunt/quicktype.yue:1585
        require('shunt.spec')._expect_that([=[(parse '{<>: {}, boolean -> number}')]=], (parse('{<>: {}, boolean -> number}')), (deep_eq(Mapping((Struct(nil, { })), (Primitive('boolean')), Primitive('number')))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1586)); -- shunt/quicktype.yue:1586
        return require('shunt.spec')._expect_that([=[(parse '~{boolean -> number}')]=], (parse('~{boolean -> number}')), (deep_eq((Mapping(nil, (Primitive('boolean')), Primitive('number'))):table_like(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1588)) -- shunt/quicktype.yue:1589
      end) -- shunt/quicktype.yue:1583
      it('accepts structs', function() -- shunt/quicktype.yue:1591
        require('shunt.spec')._expect_that([=[(parse '{}')]=], (parse('{}')), (deep_eq(Struct(nil, { }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1592)); -- shunt/quicktype.yue:1592
        require('shunt.spec')._expect_that([=[(parse '{field: boolean}')]=], (parse('{field: boolean}')), (deep_eq(Struct(nil, { -- shunt/quicktype.yue:1593
          Field('field', Primitive('boolean')) -- shunt/quicktype.yue:1593
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1593)); -- shunt/quicktype.yue:1593
        require('shunt.spec')._expect_that([=[(parse '{field: boolean,}')]=], (parse('{field: boolean,}')), (deep_eq(Struct(nil, { -- shunt/quicktype.yue:1595
          Field('field', Primitive('boolean')) -- shunt/quicktype.yue:1595
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1595)); -- shunt/quicktype.yue:1595
        require('shunt.spec')._expect_that([=[(parse '{field1: number, field2: string}')]=], (parse('{field1: number, field2: string}')), (deep_eq(Struct(nil, { -- shunt/quicktype.yue:1597
          Field('field1', Primitive('number')), -- shunt/quicktype.yue:1597
          Field('field2', Primitive('string')) -- shunt/quicktype.yue:1597
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1597)); -- shunt/quicktype.yue:1597
        require('shunt.spec')._expect_that([=[(parse '{outer1: {inner1: boolean}, outer2: {inner2: boolean}}')]=], (parse('{outer1: {inner1: boolean}, outer2: {inner2: boolean}}')), (deep_eq(Struct(nil, { -- shunt/quicktype.yue:1600
          Field('outer1', Struct(nil, { -- shunt/quicktype.yue:1600
            Field('inner1', Primitive('boolean')) -- shunt/quicktype.yue:1600
          })), -- shunt/quicktype.yue:1600
          Field('outer2', Struct(nil, { -- shunt/quicktype.yue:1600
            Field('inner2', Primitive('boolean')) -- shunt/quicktype.yue:1600
          })) -- shunt/quicktype.yue:1600
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1600)); -- shunt/quicktype.yue:1600
        require('shunt.spec')._expect_that([=[(parse '{<>: {}}')]=], (parse('{<>: {}}')), (deep_eq(Struct((Struct(nil, { })), { }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1605)); -- shunt/quicktype.yue:1605
        require('shunt.spec')._expect_that([=[(parse '{<>: {},}')]=], (parse('{<>: {},}')), (deep_eq(Struct((Struct(nil, { })), { }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1606)); -- shunt/quicktype.yue:1606
        require('shunt.spec')._expect_that([=[(parse '{<>: {<>: {__tostring: function}}}')]=], (parse('{<>: {<>: {__tostring: function}}}')), (deep_eq((function() -- shunt/quicktype.yue:1607
          return Struct((Struct((Struct(nil, { -- shunt/quicktype.yue:1607
            Field('__tostring', Primitive('function')) -- shunt/quicktype.yue:1607
          })), { })), { }) -- shunt/quicktype.yue:1607
        end)())), tostring("shunt/quicktype.yue") .. ":" .. tostring(1607)); -- shunt/quicktype.yue:1607
        return require('shunt.spec')._expect_that([=[(parse '~{}')]=], (parse('~{}')), (deep_eq((Struct(nil, { })):table_like(true))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1610)) -- shunt/quicktype.yue:1611
      end) -- shunt/quicktype.yue:1591
      it('accepts functions', function() -- shunt/quicktype.yue:1613
        require('shunt.spec')._expect_that([=[(parse '() -> <>')]=], (parse('() -> <>')), (deep_eq(Function({ }, { }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1614)); -- shunt/quicktype.yue:1614
        require('shunt.spec')._expect_that([=[(parse '() -> nil')]=], (parse('() -> nil')), (deep_eq(Function({ }, { -- shunt/quicktype.yue:1615
          Primitive('nil') -- shunt/quicktype.yue:1615
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1615)); -- shunt/quicktype.yue:1615
        require('shunt.spec')._expect_that([=[(parse '(string) -> number')]=], (parse('(string) -> number')), (deep_eq(Function({ -- shunt/quicktype.yue:1616
          Primitive('string') -- shunt/quicktype.yue:1616
        }, { -- shunt/quicktype.yue:1616
          Primitive('number') -- shunt/quicktype.yue:1616
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1616)); -- shunt/quicktype.yue:1616
        require('shunt.spec')._expect_that([=[(parse '(number, string) -> number')]=], (parse('(number, string) -> number')), (deep_eq(Function({ -- shunt/quicktype.yue:1617
          (Primitive('number')), -- shunt/quicktype.yue:1617
          (Primitive('string')) -- shunt/quicktype.yue:1617
        }, { -- shunt/quicktype.yue:1617
          Primitive('number') -- shunt/quicktype.yue:1617
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1617)); -- shunt/quicktype.yue:1617
        require('shunt.spec')._expect_that([=[(parse '(string) -> (number) -> boolean')]=], (parse('(string) -> (number) -> boolean')), (deep_eq(Function({ -- shunt/quicktype.yue:1618
          Primitive('string') -- shunt/quicktype.yue:1618
        }, { -- shunt/quicktype.yue:1618
          Function({ -- shunt/quicktype.yue:1618
            Primitive('number') -- shunt/quicktype.yue:1618
          }, { -- shunt/quicktype.yue:1618
            Primitive('boolean') -- shunt/quicktype.yue:1618
          }) -- shunt/quicktype.yue:1618
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1618)); -- shunt/quicktype.yue:1618
        require('shunt.spec')._expect_that([=[(parse '() -> <string>')]=], (parse('() -> <string>')), (deep_eq(Function({ }, { -- shunt/quicktype.yue:1619
          (Primitive('string')) -- shunt/quicktype.yue:1619
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1619)); -- shunt/quicktype.yue:1619
        require('shunt.spec')._expect_that([=[(parse '() -> <string,>')]=], (parse('() -> <string,>')), (deep_eq(Function({ }, { -- shunt/quicktype.yue:1620
          Primitive('string') -- shunt/quicktype.yue:1620
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1620)); -- shunt/quicktype.yue:1620
        require('shunt.spec')._expect_that([=[(parse '() -> <string, boolean>')]=], (parse('() -> <string, boolean>')), (deep_eq(Function({ }, { -- shunt/quicktype.yue:1621
          (Primitive('string')), -- shunt/quicktype.yue:1621
          (Primitive('boolean')) -- shunt/quicktype.yue:1621
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1621)); -- shunt/quicktype.yue:1621
        require('shunt.spec')._expect_that([=[(parse '(string...) -> number...')]=], (parse('(string...) -> number...')), (deep_eq(Function(setmetatable({ }, { -- shunt/quicktype.yue:1623
          __index = function(self) -- shunt/quicktype.yue:1623
            return Primitive('string') -- shunt/quicktype.yue:1623
          end -- shunt/quicktype.yue:1623
        }), setmetatable({ }, { -- shunt/quicktype.yue:1623
          __index = function(self) -- shunt/quicktype.yue:1623
            return Primitive('number') -- shunt/quicktype.yue:1623
          end -- shunt/quicktype.yue:1623
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1623)); -- shunt/quicktype.yue:1623
        require('shunt.spec')._expect_that([=[(parse '(string...) -> <number...>')]=], (parse('(string...) -> <number...>')), (deep_eq(Function(setmetatable({ }, { -- shunt/quicktype.yue:1624
          __index = function(self) -- shunt/quicktype.yue:1624
            return Primitive('string') -- shunt/quicktype.yue:1624
          end -- shunt/quicktype.yue:1624
        }), setmetatable({ }, { -- shunt/quicktype.yue:1624
          __index = function(self) -- shunt/quicktype.yue:1624
            return Primitive('number') -- shunt/quicktype.yue:1624
          end -- shunt/quicktype.yue:1624
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1624)); -- shunt/quicktype.yue:1624
        require('shunt.spec')._expect_that([=[(parse '(boolean, string...) -> <thread, number...>')]=], (parse('(boolean, string...) -> <thread, number...>')), (deep_eq(Function(setmetatable({ -- shunt/quicktype.yue:1625
          (Primitive('boolean')), -- shunt/quicktype.yue:1625
        }, { -- shunt/quicktype.yue:1625
          __index = function(self) -- shunt/quicktype.yue:1625
            return Primitive('string') -- shunt/quicktype.yue:1625
          end -- shunt/quicktype.yue:1625
        }), setmetatable({ -- shunt/quicktype.yue:1625
          (Primitive('thread')), -- shunt/quicktype.yue:1625
        }, { -- shunt/quicktype.yue:1625
          __index = function(self) -- shunt/quicktype.yue:1625
            return Primitive('number') -- shunt/quicktype.yue:1625
          end -- shunt/quicktype.yue:1625
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1625)); -- shunt/quicktype.yue:1625
        require('shunt.spec')._expect_that([=[(parse '() -> [string]...')]=], (parse('() -> [string]...')), (deep_eq(Function({ }, setmetatable({ }, { -- shunt/quicktype.yue:1626
          __index = function(self) -- shunt/quicktype.yue:1626
            return Array(Primitive('string')) -- shunt/quicktype.yue:1626
          end -- shunt/quicktype.yue:1626
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1626)); -- shunt/quicktype.yue:1626
        return require('shunt.spec')._expect_that([=[(-> parse '~() -> <>')]=], (function() -- shunt/quicktype.yue:1628
          return parse('~() -> <>') -- shunt/quicktype.yue:1628
        end), (errors(matches('functions cannot be table%-like'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1628)) -- shunt/quicktype.yue:1628
      end) -- shunt/quicktype.yue:1613
      it('accepts methods', function() -- shunt/quicktype.yue:1630
        require('shunt.spec')._expect_that([==[(parse '() => <>')]==], (parse('() => <>')), (deep_eq(Method({ }, { }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1631)); -- shunt/quicktype.yue:1631
        require('shunt.spec')._expect_that([==[(parse '() => nil')]==], (parse('() => nil')), (deep_eq(Method({ }, { -- shunt/quicktype.yue:1632
          Primitive('nil') -- shunt/quicktype.yue:1632
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1632)); -- shunt/quicktype.yue:1632
        require('shunt.spec')._expect_that([==[(parse '(string) => number')]==], (parse('(string) => number')), (deep_eq(Method({ -- shunt/quicktype.yue:1633
          Primitive('string') -- shunt/quicktype.yue:1633
        }, { -- shunt/quicktype.yue:1633
          Primitive('number') -- shunt/quicktype.yue:1633
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1633)); -- shunt/quicktype.yue:1633
        require('shunt.spec')._expect_that([==[(parse '(number, string) => number')]==], (parse('(number, string) => number')), (deep_eq(Method({ -- shunt/quicktype.yue:1634
          (Primitive('number')), -- shunt/quicktype.yue:1634
          (Primitive('string')) -- shunt/quicktype.yue:1634
        }, { -- shunt/quicktype.yue:1634
          Primitive('number') -- shunt/quicktype.yue:1634
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1634)); -- shunt/quicktype.yue:1634
        require('shunt.spec')._expect_that([==[(parse '(string) => (number) => boolean')]==], (parse('(string) => (number) => boolean')), (deep_eq(Method({ -- shunt/quicktype.yue:1635
          Primitive('string') -- shunt/quicktype.yue:1635
        }, { -- shunt/quicktype.yue:1635
          Method({ -- shunt/quicktype.yue:1635
            Primitive('number') -- shunt/quicktype.yue:1635
          }, { -- shunt/quicktype.yue:1635
            Primitive('boolean') -- shunt/quicktype.yue:1635
          }) -- shunt/quicktype.yue:1635
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1635)); -- shunt/quicktype.yue:1635
        require('shunt.spec')._expect_that([==[(parse '() => <string>')]==], (parse('() => <string>')), (deep_eq(Method({ }, { -- shunt/quicktype.yue:1636
          (Primitive('string')) -- shunt/quicktype.yue:1636
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1636)); -- shunt/quicktype.yue:1636
        require('shunt.spec')._expect_that([==[(parse '() => <string,>')]==], (parse('() => <string,>')), (deep_eq(Method({ }, { -- shunt/quicktype.yue:1637
          Primitive('string') -- shunt/quicktype.yue:1637
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1637)); -- shunt/quicktype.yue:1637
        require('shunt.spec')._expect_that([==[(parse '() => <string, boolean>')]==], (parse('() => <string, boolean>')), (deep_eq(Method({ }, { -- shunt/quicktype.yue:1638
          (Primitive('string')), -- shunt/quicktype.yue:1638
          (Primitive('boolean')) -- shunt/quicktype.yue:1638
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1638)); -- shunt/quicktype.yue:1638
        require('shunt.spec')._expect_that([==[(parse '(string...) => number...')]==], (parse('(string...) => number...')), (deep_eq(Method(setmetatable({ }, { -- shunt/quicktype.yue:1640
          __index = function(self) -- shunt/quicktype.yue:1640
            return Primitive('string') -- shunt/quicktype.yue:1640
          end -- shunt/quicktype.yue:1640
        }), setmetatable({ }, { -- shunt/quicktype.yue:1640
          __index = function(self) -- shunt/quicktype.yue:1640
            return Primitive('number') -- shunt/quicktype.yue:1640
          end -- shunt/quicktype.yue:1640
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1640)); -- shunt/quicktype.yue:1640
        require('shunt.spec')._expect_that([==[(parse '(string...) => <number...>')]==], (parse('(string...) => <number...>')), (deep_eq(Method(setmetatable({ }, { -- shunt/quicktype.yue:1641
          __index = function(self) -- shunt/quicktype.yue:1641
            return Primitive('string') -- shunt/quicktype.yue:1641
          end -- shunt/quicktype.yue:1641
        }), setmetatable({ }, { -- shunt/quicktype.yue:1641
          __index = function(self) -- shunt/quicktype.yue:1641
            return Primitive('number') -- shunt/quicktype.yue:1641
          end -- shunt/quicktype.yue:1641
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1641)); -- shunt/quicktype.yue:1641
        require('shunt.spec')._expect_that([==[(parse '(boolean, string...) => <thread, number...>')]==], (parse('(boolean, string...) => <thread, number...>')), (deep_eq(Method(setmetatable({ -- shunt/quicktype.yue:1642
          (Primitive('boolean')), -- shunt/quicktype.yue:1642
        }, { -- shunt/quicktype.yue:1642
          __index = function(self) -- shunt/quicktype.yue:1642
            return Primitive('string') -- shunt/quicktype.yue:1642
          end -- shunt/quicktype.yue:1642
        }), setmetatable({ -- shunt/quicktype.yue:1642
          (Primitive('thread')), -- shunt/quicktype.yue:1642
        }, { -- shunt/quicktype.yue:1642
          __index = function(self) -- shunt/quicktype.yue:1642
            return Primitive('number') -- shunt/quicktype.yue:1642
          end -- shunt/quicktype.yue:1642
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1642)); -- shunt/quicktype.yue:1642
        require('shunt.spec')._expect_that([==[(parse '() => [string]...')]==], (parse('() => [string]...')), (deep_eq(Method({ }, setmetatable({ }, { -- shunt/quicktype.yue:1643
          __index = function(self) -- shunt/quicktype.yue:1643
            return Array(Primitive('string')) -- shunt/quicktype.yue:1643
          end -- shunt/quicktype.yue:1643
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1643)); -- shunt/quicktype.yue:1643
        return require('shunt.spec')._expect_that([==[(-> parse '~() => <>')]==], (function() -- shunt/quicktype.yue:1645
          return parse('~() => <>') -- shunt/quicktype.yue:1645
        end), (errors(matches('methods cannot be table%-like'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1645)) -- shunt/quicktype.yue:1645
      end) -- shunt/quicktype.yue:1630
      it('accepts conjunctions', function() -- shunt/quicktype.yue:1647
        return require('shunt.spec')._expect_that([=[(parse '[string]+{number->string}+table+function')]=], (parse('[string]+{number->string}+table+function')), (deep_eq(Conjunction({ -- shunt/quicktype.yue:1648
          Array(Primitive('string')), -- shunt/quicktype.yue:1648
          Mapping(nil, (Primitive('number')), Primitive('string')), -- shunt/quicktype.yue:1648
          Primitive('table'), -- shunt/quicktype.yue:1648
          Primitive('function') -- shunt/quicktype.yue:1648
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1648)) -- shunt/quicktype.yue:1652
      end) -- shunt/quicktype.yue:1647
      it('accepts disjunctions', function() -- shunt/quicktype.yue:1654
        require('shunt.spec')._expect_that([=[(parse '[string]|{number->string}|table|function')]=], (parse('[string]|{number->string}|table|function')), (deep_eq(Disjunction({ -- shunt/quicktype.yue:1655
          Array(Primitive('string')), -- shunt/quicktype.yue:1655
          Mapping(nil, (Primitive('number')), Primitive('string')), -- shunt/quicktype.yue:1655
          Primitive('table'), -- shunt/quicktype.yue:1655
          Primitive('function') -- shunt/quicktype.yue:1655
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1655)); -- shunt/quicktype.yue:1655
        return require('shunt.spec')._expect_that([=[(parse '{string|number}')]=], (parse('{string|number}')), (deep_eq(Set(nil, Disjunction({ -- shunt/quicktype.yue:1660
          Primitive('string'), -- shunt/quicktype.yue:1660
          Primitive('number') -- shunt/quicktype.yue:1660
        })))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1660)) -- shunt/quicktype.yue:1662
      end) -- shunt/quicktype.yue:1654
      return it('gives precedence to conjunctions', function() -- shunt/quicktype.yue:1664
        require('shunt.spec')._expect_that([=[(parse 'string+number|boolean')]=], (parse('string+number|boolean')), (deep_eq(Disjunction({ -- shunt/quicktype.yue:1665
          Conjunction({ -- shunt/quicktype.yue:1665
            Primitive('string'), -- shunt/quicktype.yue:1665
            Primitive('number') -- shunt/quicktype.yue:1665
          }), -- shunt/quicktype.yue:1665
          Primitive('boolean') -- shunt/quicktype.yue:1665
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1665)); -- shunt/quicktype.yue:1665
        return require('shunt.spec')._expect_that([=[(parse 'string|number+boolean')]=], (parse('string|number+boolean')), (deep_eq(Disjunction({ -- shunt/quicktype.yue:1670
          Primitive('string'), -- shunt/quicktype.yue:1670
          Conjunction({ -- shunt/quicktype.yue:1670
            Primitive('number'), -- shunt/quicktype.yue:1670
            Primitive('boolean') -- shunt/quicktype.yue:1670
          }) -- shunt/quicktype.yue:1670
        }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1670)) -- shunt/quicktype.yue:1674
      end) -- shunt/quicktype.yue:1674
    end) -- shunt/quicktype.yue:1674
  end) -- shunt/quicktype.yue:1503
  describe('T', function() -- shunt/quicktype.yue:1676
    it('requires two arguments', function() -- shunt/quicktype.yue:1677
      return require('shunt.spec')._expect_that([=[(-> T!)]=], (function() -- shunt/quicktype.yue:1678
        return T() -- shunt/quicktype.yue:1678
      end), (errors(matches('cannot typecheck: no type spec provided'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1678)) -- shunt/quicktype.yue:1678
    end) -- shunt/quicktype.yue:1677
    it('returns its second argument', function() -- shunt/quicktype.yue:1680
      local value = { }; -- shunt/quicktype.yue:1681
      return require('shunt.spec')._expect_that([=[(T '{}', value)]=], (T('{}', value)), (eq(value)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1682)) -- shunt/quicktype.yue:1682
    end) -- shunt/quicktype.yue:1680
    it('checks primitives', function() -- shunt/quicktype.yue:1684
      require('shunt.spec')._expect_that([=[(-> T 'nil', nil)]=], (function() -- shunt/quicktype.yue:1685
        return T('nil', nil) -- shunt/quicktype.yue:1685
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1685)); -- shunt/quicktype.yue:1685
      require('shunt.spec')._expect_that([=[(-> T 'number', 123)]=], (function() -- shunt/quicktype.yue:1686
        return T('number', 123) -- shunt/quicktype.yue:1686
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1686)); -- shunt/quicktype.yue:1686
      require('shunt.spec')._expect_that([=[(-> T 'string', 'some-string')]=], (function() -- shunt/quicktype.yue:1687
        return T('string', 'some-string') -- shunt/quicktype.yue:1687
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1687)); -- shunt/quicktype.yue:1687
      require('shunt.spec')._expect_that([=[(-> T 'nil', 123)]=], (function() -- shunt/quicktype.yue:1689
        return T('nil', 123) -- shunt/quicktype.yue:1689
      end), (errors(matches('incorrect type: expected nil but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1689)); -- shunt/quicktype.yue:1689
      require('shunt.spec')._expect_that([=[(-> T 'number', nil)]=], (function() -- shunt/quicktype.yue:1690
        return T('number', nil) -- shunt/quicktype.yue:1690
      end), (errors(matches('incorrect type: expected number but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1690)); -- shunt/quicktype.yue:1690
      return require('shunt.spec')._expect_that([=[(-> T 'string', 123)]=], (function() -- shunt/quicktype.yue:1691
        return T('string', 123) -- shunt/quicktype.yue:1691
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1691)) -- shunt/quicktype.yue:1691
    end) -- shunt/quicktype.yue:1684
    it('checks any', function() -- shunt/quicktype.yue:1693
      local values = { -- shunt/quicktype.yue:1695
        123, -- shunt/quicktype.yue:1695
        'str', -- shunt/quicktype.yue:1696
        { }, -- shunt/quicktype.yue:1697
        function() end, -- shunt/quicktype.yue:1698
        coroutine.create(function() end) -- shunt/quicktype.yue:1699
      } -- shunt/quicktype.yue:1694
      for _index_0 = 1, #values do -- shunt/quicktype.yue:1700
        local value = values[_index_0] -- shunt/quicktype.yue:1700
        require('shunt.spec')._expect_that([=[(-> T 'any', value)]=], (function() -- shunt/quicktype.yue:1701
          return T('any', value) -- shunt/quicktype.yue:1701
        end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1701)) -- shunt/quicktype.yue:1701
      end -- shunt/quicktype.yue:1701
      return require('shunt.spec')._expect_that([=[(-> T 'any', nil)]=], (function() -- shunt/quicktype.yue:1702
        return T('any', nil) -- shunt/quicktype.yue:1702
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1702)) -- shunt/quicktype.yue:1702
    end) -- shunt/quicktype.yue:1693
    it('checks some', function() -- shunt/quicktype.yue:1704
      local values = { -- shunt/quicktype.yue:1706
        123, -- shunt/quicktype.yue:1706
        'str', -- shunt/quicktype.yue:1707
        { }, -- shunt/quicktype.yue:1708
        function() end, -- shunt/quicktype.yue:1709
        coroutine.create(function() end) -- shunt/quicktype.yue:1710
      } -- shunt/quicktype.yue:1705
      for _index_0 = 1, #values do -- shunt/quicktype.yue:1711
        local value = values[_index_0] -- shunt/quicktype.yue:1711
        require('shunt.spec')._expect_that([=[(-> T 'some', value)]=], (function() -- shunt/quicktype.yue:1712
          return T('some', value) -- shunt/quicktype.yue:1712
        end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1712)) -- shunt/quicktype.yue:1712
      end -- shunt/quicktype.yue:1712
      return require('shunt.spec')._expect_that([=[(-> T 'some', nil)]=], (function() -- shunt/quicktype.yue:1713
        return T('some', nil) -- shunt/quicktype.yue:1713
      end), (errors(matches("incorrect type: expected some but got nil"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1713)) -- shunt/quicktype.yue:1713
    end) -- shunt/quicktype.yue:1704
    it('rejects never', function() -- shunt/quicktype.yue:1715
      return require('shunt.spec')._expect_that([=[(-> T '!', 123)]=], (function() -- shunt/quicktype.yue:1716
        return T('!', 123) -- shunt/quicktype.yue:1716
      end), (errors(matches('never expected a value here'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1716)) -- shunt/quicktype.yue:1716
    end) -- shunt/quicktype.yue:1715
    it('rejects nonexistent types', function() -- shunt/quicktype.yue:1718
      require('shunt.spec')._expect_that([=[(-> T 'IDoNotExist', 123)]=], (function() -- shunt/quicktype.yue:1719
        return T('IDoNotExist', 123) -- shunt/quicktype.yue:1719
      end), (errors(matches('cannot typecheck: type IDoNotExist not defined'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1719)) -- shunt/quicktype.yue:1719
      declare_type('ChildDoesNotExist', 'IDoNotExist'); -- shunt/quicktype.yue:1721
      return require('shunt.spec')._expect_that([=[(-> T 'ChildDoesNotExist', 123)]=], (function() -- shunt/quicktype.yue:1722
        return T('ChildDoesNotExist', 123) -- shunt/quicktype.yue:1722
      end), (errors(matches('cannot typecheck: type IDoNotExist not defined'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1722)) -- shunt/quicktype.yue:1722
    end) -- shunt/quicktype.yue:1718
    it('checks boolean types', function() -- shunt/quicktype.yue:1724
      require('shunt.spec')._expect_that([=[(-> T 'true', true)]=], (function() -- shunt/quicktype.yue:1725
        return T('true', true) -- shunt/quicktype.yue:1725
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1725)); -- shunt/quicktype.yue:1725
      require('shunt.spec')._expect_that([=[(-> T 'true', false)]=], (function() -- shunt/quicktype.yue:1726
        return T('true', false) -- shunt/quicktype.yue:1726
      end), (errors(matches('incorrect type: expected boolean true but got false'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1726)); -- shunt/quicktype.yue:1726
      require('shunt.spec')._expect_that([=[(-> T 'true', nil)]=], (function() -- shunt/quicktype.yue:1727
        return T('true', nil) -- shunt/quicktype.yue:1727
      end), (errors(matches('incorrect type: expected boolean but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1727)); -- shunt/quicktype.yue:1727
      require('shunt.spec')._expect_that([=[(-> T 'false', false)]=], (function() -- shunt/quicktype.yue:1729
        return T('false', false) -- shunt/quicktype.yue:1729
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1729)); -- shunt/quicktype.yue:1729
      require('shunt.spec')._expect_that([=[(-> T 'false', true)]=], (function() -- shunt/quicktype.yue:1730
        return T('false', true) -- shunt/quicktype.yue:1730
      end), (errors(matches('incorrect type: expected boolean false but got true'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1730)); -- shunt/quicktype.yue:1730
      return require('shunt.spec')._expect_that([=[(-> T 'false', nil)]=], (function() -- shunt/quicktype.yue:1731
        return T('false', nil) -- shunt/quicktype.yue:1731
      end), (errors(matches('incorrect type: expected boolean but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1731)) -- shunt/quicktype.yue:1731
    end) -- shunt/quicktype.yue:1724
    it('checks number types', function() -- shunt/quicktype.yue:1733
      require('shunt.spec')._expect_that([=[(-> T '123', 123)]=], (function() -- shunt/quicktype.yue:1734
        return T('123', 123) -- shunt/quicktype.yue:1734
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1734)); -- shunt/quicktype.yue:1734
      require('shunt.spec')._expect_that([=[(-> T '123', 0)]=], (function() -- shunt/quicktype.yue:1735
        return T('123', 0) -- shunt/quicktype.yue:1735
      end), (errors(matches("incorrect type: expected number 123"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1735)); -- shunt/quicktype.yue:1735
      return require('shunt.spec')._expect_that([=[(-> T '123', {})]=], (function() -- shunt/quicktype.yue:1736
        return T('123', { }) -- shunt/quicktype.yue:1736
      end), (errors(matches("incorrect type: expected number but got table"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1736)) -- shunt/quicktype.yue:1736
    end) -- shunt/quicktype.yue:1733
    it('checks string types', function() -- shunt/quicktype.yue:1738
      require('shunt.spec')._expect_that([=[(-> T '"hello"', 'hello')]=], (function() -- shunt/quicktype.yue:1739
        return T('"hello"', 'hello') -- shunt/quicktype.yue:1739
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1739)); -- shunt/quicktype.yue:1739
      return require('shunt.spec')._expect_that([=[(-> T '"hello"', 'world')]=], (function() -- shunt/quicktype.yue:1740
        return T('"hello"', 'world') -- shunt/quicktype.yue:1740
      end), (errors(matches("incorrect type: expected string 'hello'"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1740)) -- shunt/quicktype.yue:1740
    end) -- shunt/quicktype.yue:1738
    it('checks singleton types', function() -- shunt/quicktype.yue:1742
      local make_singleton -- shunt/quicktype.yue:1743
      make_singleton = function(name) -- shunt/quicktype.yue:1743
        return setmetatable({ }, { -- shunt/quicktype.yue:1743
          __tostring = function(self) -- shunt/quicktype.yue:1743
            return name -- shunt/quicktype.yue:1743
          end -- shunt/quicktype.yue:1743
        }) -- shunt/quicktype.yue:1743
      end -- shunt/quicktype.yue:1743
      local SINGLETON = make_singleton('Singleton') -- shunt/quicktype.yue:1744
      declare_singleton_type(SINGLETON); -- shunt/quicktype.yue:1745
      require('shunt.spec')._expect_that([=[(-> T 'Singleton', SINGLETON)]=], (function() -- shunt/quicktype.yue:1747
        return T('Singleton', SINGLETON) -- shunt/quicktype.yue:1747
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1747)); -- shunt/quicktype.yue:1747
      require('shunt.spec')._expect_that([=[(-> T 'Singleton', nil)]=], (function() -- shunt/quicktype.yue:1749
        return T('Singleton', nil) -- shunt/quicktype.yue:1749
      end), (errors(matches("incorrect type: expected table Singleton"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1749)); -- shunt/quicktype.yue:1749
      require('shunt.spec')._expect_that([=[(-> T 'Singleton', {})]=], (function() -- shunt/quicktype.yue:1750
        return T('Singleton', { }) -- shunt/quicktype.yue:1750
      end), (errors(matches("incorrect type: expected table Singleton"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1750)); -- shunt/quicktype.yue:1750
      return require('shunt.spec')._expect_that([=[(-> T 'Singleton', make_singleton 'Singleton')]=], (function() -- shunt/quicktype.yue:1751
        return T('Singleton', make_singleton('Singleton')) -- shunt/quicktype.yue:1751
      end), (errors(matches("incorrect type: expected table Singleton"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1751)) -- shunt/quicktype.yue:1751
    end) -- shunt/quicktype.yue:1742
    it('checks optionals', function() -- shunt/quicktype.yue:1753
      require('shunt.spec')._expect_that([=[(-> T '?number', nil)]=], (function() -- shunt/quicktype.yue:1754
        return T('?number', nil) -- shunt/quicktype.yue:1754
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1754)); -- shunt/quicktype.yue:1754
      require('shunt.spec')._expect_that([=[(-> T '?number', 123)]=], (function() -- shunt/quicktype.yue:1755
        return T('?number', 123) -- shunt/quicktype.yue:1755
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1755)); -- shunt/quicktype.yue:1755
      require('shunt.spec')._expect_that([=[(-> T '?number', 'str')]=], (function() -- shunt/quicktype.yue:1756
        return T('?number', 'str') -- shunt/quicktype.yue:1756
      end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1756)); -- shunt/quicktype.yue:1756
      return require('shunt.spec')._expect_that([=[(-> T '?(number)', 'str')]=], (function() -- shunt/quicktype.yue:1757
        return T('?(number)', 'str') -- shunt/quicktype.yue:1757
      end), (errors(matches('incorrect type: expected table but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1757)) -- shunt/quicktype.yue:1757
    end) -- shunt/quicktype.yue:1753
    it('checks arrays', function() -- shunt/quicktype.yue:1759
      require('shunt.spec')._expect_that([=[(-> T '[number]', {})]=], (function() -- shunt/quicktype.yue:1760
        return T('[number]', { }) -- shunt/quicktype.yue:1760
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1760)); -- shunt/quicktype.yue:1760
      require('shunt.spec')._expect_that([=[(-> T '[number]', {123, 312})]=], (function() -- shunt/quicktype.yue:1761
        return T('[number]', { -- shunt/quicktype.yue:1761
          123, -- shunt/quicktype.yue:1761
          312 -- shunt/quicktype.yue:1761
        }) -- shunt/quicktype.yue:1761
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1761)); -- shunt/quicktype.yue:1761
      require('shunt.spec')._expect_that([=[(-> T '[[number]]', {{123}, {312}})]=], (function() -- shunt/quicktype.yue:1762
        return T('[[number]]', { -- shunt/quicktype.yue:1762
          { -- shunt/quicktype.yue:1762
            123 -- shunt/quicktype.yue:1762
          }, -- shunt/quicktype.yue:1762
          { -- shunt/quicktype.yue:1762
            312 -- shunt/quicktype.yue:1762
          } -- shunt/quicktype.yue:1762
        }) -- shunt/quicktype.yue:1762
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1762)); -- shunt/quicktype.yue:1762
      require('shunt.spec')._expect_that([=[(-> T '[string]', 123)]=], (function() -- shunt/quicktype.yue:1764
        return T('[string]', 123) -- shunt/quicktype.yue:1764
      end), (errors(matches('incorrect type: expected table but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1764)); -- shunt/quicktype.yue:1764
      require('shunt.spec')._expect_that([=[(-> T '[[number]]', {{123}, {'asdf'}})]=], (function() -- shunt/quicktype.yue:1765
        return T('[[number]]', { -- shunt/quicktype.yue:1765
          { -- shunt/quicktype.yue:1765
            123 -- shunt/quicktype.yue:1765
          }, -- shunt/quicktype.yue:1765
          { -- shunt/quicktype.yue:1765
            'asdf' -- shunt/quicktype.yue:1765
          } -- shunt/quicktype.yue:1765
        }) -- shunt/quicktype.yue:1765
      end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1765)) -- shunt/quicktype.yue:1765
      local hybrid = { -- shunt/quicktype.yue:1767
        123, -- shunt/quicktype.yue:1767
        456, -- shunt/quicktype.yue:1767
        789, -- shunt/quicktype.yue:1767
        field = 'a' -- shunt/quicktype.yue:1767
      } -- shunt/quicktype.yue:1767
      if #hybrid ~= 3 then -- shunt/quicktype.yue:1768
        return require('shunt.spec')._expect_that([=[(-> T '[string]', hybrid)]=], (function() -- shunt/quicktype.yue:1769
          return T('[string]', hybrid) -- shunt/quicktype.yue:1769
        end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1769)) -- shunt/quicktype.yue:1769
      else -- shunt/quicktype.yue:1771
        return require('shunt.spec')._expect_that([=[(-> T '[string]', hybrid)]=], (function() -- shunt/quicktype.yue:1771
          return T('[string]', hybrid) -- shunt/quicktype.yue:1771
        end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1771)) -- shunt/quicktype.yue:1771
      end -- shunt/quicktype.yue:1768
    end) -- shunt/quicktype.yue:1759
    it('checks tuples', function() -- shunt/quicktype.yue:1773
      require('shunt.spec')._expect_that([=[(-> T '()', {})]=], (function() -- shunt/quicktype.yue:1774
        return T('()', { }) -- shunt/quicktype.yue:1774
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1774)); -- shunt/quicktype.yue:1774
      require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', {123, true, 'hello'})]=], (function() -- shunt/quicktype.yue:1775
        return T('(number, boolean, string)', { -- shunt/quicktype.yue:1775
          123, -- shunt/quicktype.yue:1775
          true, -- shunt/quicktype.yue:1775
          'hello' -- shunt/quicktype.yue:1775
        }) -- shunt/quicktype.yue:1775
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1775)); -- shunt/quicktype.yue:1775
      require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', {123, true, 'hello', coroutine.create ->})]=], (function() -- shunt/quicktype.yue:1776
        return T('(number, boolean, string)', { -- shunt/quicktype.yue:1776
          123, -- shunt/quicktype.yue:1776
          true, -- shunt/quicktype.yue:1776
          'hello', -- shunt/quicktype.yue:1776
          coroutine.create(function() end) -- shunt/quicktype.yue:1776
        }) -- shunt/quicktype.yue:1776
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1776)); -- shunt/quicktype.yue:1776
      require('shunt.spec')._expect_that([=[(-> T '((number, boolean), (string, thread))', {{123, true}, {'hello', coroutine.create ->}})]=], (function() -- shunt/quicktype.yue:1777
        return T('((number, boolean), (string, thread))', { -- shunt/quicktype.yue:1777
          { -- shunt/quicktype.yue:1777
            123, -- shunt/quicktype.yue:1777
            true -- shunt/quicktype.yue:1777
          }, -- shunt/quicktype.yue:1777
          { -- shunt/quicktype.yue:1777
            'hello', -- shunt/quicktype.yue:1777
            coroutine.create(function() end) -- shunt/quicktype.yue:1777
          } -- shunt/quicktype.yue:1777
        }) -- shunt/quicktype.yue:1777
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1777)); -- shunt/quicktype.yue:1777
      require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', nil)]=], (function() -- shunt/quicktype.yue:1779
        return T('(number, boolean, string)', nil) -- shunt/quicktype.yue:1779
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1779)); -- shunt/quicktype.yue:1779
      require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', {})]=], (function() -- shunt/quicktype.yue:1780
        return T('(number, boolean, string)', { }) -- shunt/quicktype.yue:1780
      end), (errors(matches('incorrect type: expected number but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1780)); -- shunt/quicktype.yue:1780
      require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', {123})]=], (function() -- shunt/quicktype.yue:1781
        return T('(number, boolean, string)', { -- shunt/quicktype.yue:1781
          123 -- shunt/quicktype.yue:1781
        }) -- shunt/quicktype.yue:1781
      end), (errors(matches('incorrect type: expected boolean but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1781)); -- shunt/quicktype.yue:1781
      return require('shunt.spec')._expect_that([=[(-> T '(number, boolean, string)', {'interloper'})]=], (function() -- shunt/quicktype.yue:1782
        return T('(number, boolean, string)', { -- shunt/quicktype.yue:1782
          'interloper' -- shunt/quicktype.yue:1782
        }) -- shunt/quicktype.yue:1782
      end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1782)) -- shunt/quicktype.yue:1782
    end) -- shunt/quicktype.yue:1773
    it('checks sets', function() -- shunt/quicktype.yue:1784
      require('shunt.spec')._expect_that([=[(-> T '{number}', {})]=], (function() -- shunt/quicktype.yue:1785
        return T('{number}', { }) -- shunt/quicktype.yue:1785
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1785)); -- shunt/quicktype.yue:1785
      require('shunt.spec')._expect_that([=[(-> T '{number}', {[123]: true, [321]: {}})]=], (function() -- shunt/quicktype.yue:1786
        return T('{number}', { -- shunt/quicktype.yue:1786
          [123] = true, -- shunt/quicktype.yue:1786
          [321] = { } -- shunt/quicktype.yue:1786
        }) -- shunt/quicktype.yue:1786
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1786)); -- shunt/quicktype.yue:1786
      require('shunt.spec')._expect_that([=[(-> T '{{number}}', {[{123}]: true})]=], (function() -- shunt/quicktype.yue:1787
        return T('{{number}}', { -- shunt/quicktype.yue:1787
          [{ -- shunt/quicktype.yue:1787
            123 -- shunt/quicktype.yue:1787
          }] = true -- shunt/quicktype.yue:1787
        }) -- shunt/quicktype.yue:1787
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1787)); -- shunt/quicktype.yue:1787
      require('shunt.spec')._expect_that([=[(-> T '{<>: {}, number}', <>: {})]=], (function() -- shunt/quicktype.yue:1788
        return T('{<>: {}, number}', setmetatable({ }, { })) -- shunt/quicktype.yue:1788
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1788)); -- shunt/quicktype.yue:1788
      require('shunt.spec')._expect_that([=[(-> T '{number}', nil)]=], (function() -- shunt/quicktype.yue:1790
        return T('{number}', nil) -- shunt/quicktype.yue:1790
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1790)); -- shunt/quicktype.yue:1790
      require('shunt.spec')._expect_that([=[(-> T '{number}', {[123]: false})]=], (function() -- shunt/quicktype.yue:1791
        return T('{number}', { -- shunt/quicktype.yue:1791
          [123] = false -- shunt/quicktype.yue:1791
        }) -- shunt/quicktype.yue:1791
      end), (errors(matches('incorrect type: expected a truthy value but got false'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1791)); -- shunt/quicktype.yue:1791
      require('shunt.spec')._expect_that([=[(-> T '{{number}}', {[{['asdf']: true}]: true})]=], (function() -- shunt/quicktype.yue:1792
        return T('{{number}}', { -- shunt/quicktype.yue:1792
          [{ -- shunt/quicktype.yue:1792
            ['asdf'] = true -- shunt/quicktype.yue:1792
          }] = true -- shunt/quicktype.yue:1792
        }) -- shunt/quicktype.yue:1792
      end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1792)); -- shunt/quicktype.yue:1792
      return require('shunt.spec')._expect_that([=[(-> T '{<>: {}, number}', {})]=], (function() -- shunt/quicktype.yue:1793
        return T('{<>: {}, number}', { }) -- shunt/quicktype.yue:1793
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1793)) -- shunt/quicktype.yue:1793
    end) -- shunt/quicktype.yue:1784
    it('checks mappings', function() -- shunt/quicktype.yue:1795
      require('shunt.spec')._expect_that([=[(-> T '{string -> number}', {})]=], (function() -- shunt/quicktype.yue:1796
        return T('{string -> number}', { }) -- shunt/quicktype.yue:1796
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1796)); -- shunt/quicktype.yue:1796
      require('shunt.spec')._expect_that([=[(-> T '{number -> string}', {'hello', [10]: 'world'})]=], (function() -- shunt/quicktype.yue:1797
        return T('{number -> string}', { -- shunt/quicktype.yue:1797
          'hello', -- shunt/quicktype.yue:1797
          [10] = 'world' -- shunt/quicktype.yue:1797
        }) -- shunt/quicktype.yue:1797
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1797)); -- shunt/quicktype.yue:1797
      require('shunt.spec')._expect_that([=[(-> T '{{boolean -> number} -> {string -> thread}}', {[{[true]: 123}]: {asdf: coroutine.create ->}})]=], (function() -- shunt/quicktype.yue:1798
        return T('{{boolean -> number} -> {string -> thread}}', { -- shunt/quicktype.yue:1798
          [{ -- shunt/quicktype.yue:1798
            [true] = 123 -- shunt/quicktype.yue:1798
          }] = { -- shunt/quicktype.yue:1798
            asdf = coroutine.create(function() end) -- shunt/quicktype.yue:1798
          } -- shunt/quicktype.yue:1798
        }) -- shunt/quicktype.yue:1798
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1798)); -- shunt/quicktype.yue:1798
      require('shunt.spec')._expect_that([=[(-> T '{<>: {}, string -> number}', <>: {})]=], (function() -- shunt/quicktype.yue:1799
        return T('{<>: {}, string -> number}', setmetatable({ }, { })) -- shunt/quicktype.yue:1799
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1799)); -- shunt/quicktype.yue:1799
      require('shunt.spec')._expect_that([=[(-> T '{number -> string}', nil)]=], (function() -- shunt/quicktype.yue:1801
        return T('{number -> string}', nil) -- shunt/quicktype.yue:1801
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1801)); -- shunt/quicktype.yue:1801
      require('shunt.spec')._expect_that([=[(-> T '{number -> string}', {123})]=], (function() -- shunt/quicktype.yue:1802
        return T('{number -> string}', { -- shunt/quicktype.yue:1802
          123 -- shunt/quicktype.yue:1802
        }) -- shunt/quicktype.yue:1802
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1802)); -- shunt/quicktype.yue:1802
      require('shunt.spec')._expect_that([=[(-> T '{number -> string}', {'hello', 'world', 'foo', 'bar', 'baz', 123})]=], (function() -- shunt/quicktype.yue:1803
        return T('{number -> string}', { -- shunt/quicktype.yue:1803
          'hello', -- shunt/quicktype.yue:1803
          'world', -- shunt/quicktype.yue:1803
          'foo', -- shunt/quicktype.yue:1803
          'bar', -- shunt/quicktype.yue:1803
          'baz', -- shunt/quicktype.yue:1803
          123 -- shunt/quicktype.yue:1803
        }) -- shunt/quicktype.yue:1803
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1803)); -- shunt/quicktype.yue:1803
      return require('shunt.spec')._expect_that([=[(-> T '{<>: {}, string -> number}', {})]=], (function() -- shunt/quicktype.yue:1804
        return T('{<>: {}, string -> number}', { }) -- shunt/quicktype.yue:1804
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1804)) -- shunt/quicktype.yue:1804
    end) -- shunt/quicktype.yue:1795
    it('checks structs', function() -- shunt/quicktype.yue:1806
      require('shunt.spec')._expect_that([=[(-> T '{}', {})]=], (function() -- shunt/quicktype.yue:1807
        return T('{}', { }) -- shunt/quicktype.yue:1807
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1807)); -- shunt/quicktype.yue:1807
      require('shunt.spec')._expect_that([=[(-> T '{}', {123})]=], (function() -- shunt/quicktype.yue:1808
        return T('{}', { -- shunt/quicktype.yue:1808
          123 -- shunt/quicktype.yue:1808
        }) -- shunt/quicktype.yue:1808
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1808)); -- shunt/quicktype.yue:1808
      require('shunt.spec')._expect_that([=[(-> T '{}', {hello: 123})]=], (function() -- shunt/quicktype.yue:1809
        return T('{}', { -- shunt/quicktype.yue:1809
          hello = 123 -- shunt/quicktype.yue:1809
        }) -- shunt/quicktype.yue:1809
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1809)); -- shunt/quicktype.yue:1809
      require('shunt.spec')._expect_that([=[(-> T '{hello: string}', {hello: 'hello'})]=], (function() -- shunt/quicktype.yue:1810
        return T('{hello: string}', { -- shunt/quicktype.yue:1810
          hello = 'hello' -- shunt/quicktype.yue:1810
        }) -- shunt/quicktype.yue:1810
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1810)); -- shunt/quicktype.yue:1810
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}}', {hello: world: 'world'})]=], (function() -- shunt/quicktype.yue:1811
        return T('{hello: {world: string}}', { -- shunt/quicktype.yue:1811
          hello = { -- shunt/quicktype.yue:1811
            world = 'world' -- shunt/quicktype.yue:1811
          } -- shunt/quicktype.yue:1811
        }) -- shunt/quicktype.yue:1811
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1811)); -- shunt/quicktype.yue:1811
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}, foo: boolean}', hello: {world:'asdf'}, foo: true)]=], (function() -- shunt/quicktype.yue:1812
        return T('{hello: {world: string}, foo: boolean}', { -- shunt/quicktype.yue:1812
          hello = { -- shunt/quicktype.yue:1812
            world = 'asdf' -- shunt/quicktype.yue:1812
          }, -- shunt/quicktype.yue:1812
          foo = true -- shunt/quicktype.yue:1812
        }) -- shunt/quicktype.yue:1812
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1812)); -- shunt/quicktype.yue:1812
      require('shunt.spec')._expect_that([=[(-> T '{<>: {}}', <>: {})]=], (function() -- shunt/quicktype.yue:1813
        return T('{<>: {}}', setmetatable({ }, { })) -- shunt/quicktype.yue:1813
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1813)); -- shunt/quicktype.yue:1813
      require('shunt.spec')._expect_that([=[(-> T '{}', 132)]=], (function() -- shunt/quicktype.yue:1815
        return T('{}', 132) -- shunt/quicktype.yue:1815
      end), (errors(matches('incorrect type: expected table but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1815)); -- shunt/quicktype.yue:1815
      require('shunt.spec')._expect_that([=[(-> T '{hello: string}', {})]=], (function() -- shunt/quicktype.yue:1816
        return T('{hello: string}', { }) -- shunt/quicktype.yue:1816
      end), (errors(matches('incorrect type: expected string but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1816)); -- shunt/quicktype.yue:1816
      require('shunt.spec')._expect_that([=[(-> T '{hello: string}', hello: 123)]=], (function() -- shunt/quicktype.yue:1817
        return T('{hello: string}', { -- shunt/quicktype.yue:1817
          hello = 123 -- shunt/quicktype.yue:1817
        }) -- shunt/quicktype.yue:1817
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1817)); -- shunt/quicktype.yue:1817
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}}', hello: 123)]=], (function() -- shunt/quicktype.yue:1818
        return T('{hello: {world: string}}', { -- shunt/quicktype.yue:1818
          hello = 123 -- shunt/quicktype.yue:1818
        }) -- shunt/quicktype.yue:1818
      end), (errors(matches('incorrect type: expected table but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1818)); -- shunt/quicktype.yue:1818
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}}', hello: {})]=], (function() -- shunt/quicktype.yue:1819
        return T('{hello: {world: string}}', { -- shunt/quicktype.yue:1819
          hello = { } -- shunt/quicktype.yue:1819
        }) -- shunt/quicktype.yue:1819
      end), (errors(matches('incorrect type: expected string but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1819)); -- shunt/quicktype.yue:1819
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}}', hello: world: 123)]=], (function() -- shunt/quicktype.yue:1820
        return T('{hello: {world: string}}', { -- shunt/quicktype.yue:1820
          hello = { -- shunt/quicktype.yue:1820
            world = 123 -- shunt/quicktype.yue:1820
          } -- shunt/quicktype.yue:1820
        }) -- shunt/quicktype.yue:1820
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1820)); -- shunt/quicktype.yue:1820
      require('shunt.spec')._expect_that([=[(-> T '{hello: {world: string}, foo: boolean}', hello: {world:'asdf'}, foo: 123)]=], (function() -- shunt/quicktype.yue:1821
        return T('{hello: {world: string}, foo: boolean}', { -- shunt/quicktype.yue:1821
          hello = { -- shunt/quicktype.yue:1821
            world = 'asdf' -- shunt/quicktype.yue:1821
          }, -- shunt/quicktype.yue:1821
          foo = 123 -- shunt/quicktype.yue:1821
        }) -- shunt/quicktype.yue:1821
      end), (errors(matches('incorrect type: expected boolean but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1821)); -- shunt/quicktype.yue:1821
      return require('shunt.spec')._expect_that([=[(-> T '{<>: {}}', {})]=], (function() -- shunt/quicktype.yue:1822
        return T('{<>: {}}', { }) -- shunt/quicktype.yue:1822
      end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1822)) -- shunt/quicktype.yue:1822
    end) -- shunt/quicktype.yue:1806
    it('checks table-likes', function() -- shunt/quicktype.yue:1824
      return require('shunt.spec')._expect_that([=[(-> T '~{char: function}', '')]=], (function() -- shunt/quicktype.yue:1829
        return T('~{char: function}', '') -- shunt/quicktype.yue:1829
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1829)) -- shunt/quicktype.yue:1829
    end) -- shunt/quicktype.yue:1824
    it('checks functions', function() -- shunt/quicktype.yue:1831
      require('shunt.spec')._expect_that([=[(-> T '() -> nil', ->)]=], (function() -- shunt/quicktype.yue:1832
        return T('() -> nil', function() end) -- shunt/quicktype.yue:1832
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1832)); -- shunt/quicktype.yue:1832
      require('shunt.spec')._expect_that([=[(-> T '() -> nil', -> nil)]=], (function() -- shunt/quicktype.yue:1833
        return T('() -> nil', function() -- shunt/quicktype.yue:1833
          return nil -- shunt/quicktype.yue:1833
        end) -- shunt/quicktype.yue:1833
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1833)); -- shunt/quicktype.yue:1833
      return require('shunt.spec')._expect_that([=[(-> T '() -> nil', {})]=], (function() -- shunt/quicktype.yue:1834
        return T('() -> nil', { }) -- shunt/quicktype.yue:1834
      end), (errors(matches('incorrect type: expected function but got table'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1834)) -- shunt/quicktype.yue:1834
    end) -- shunt/quicktype.yue:1831
    it('checks conjunctions', function() -- shunt/quicktype.yue:1836
      require('shunt.spec')._expect_that([=[(-> T '[string]+{number}', {'a', 'b', 'c'})]=], (function() -- shunt/quicktype.yue:1837
        return T('[string]+{number}', { -- shunt/quicktype.yue:1837
          'a', -- shunt/quicktype.yue:1837
          'b', -- shunt/quicktype.yue:1837
          'c' -- shunt/quicktype.yue:1837
        }) -- shunt/quicktype.yue:1837
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1837)); -- shunt/quicktype.yue:1837
      require('shunt.spec')._expect_that([=[(-> T 'string+number', 123)]=], (function() -- shunt/quicktype.yue:1839
        return T('string+number', 123) -- shunt/quicktype.yue:1839
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1839)); -- shunt/quicktype.yue:1839
      return require('shunt.spec')._expect_that([=[(-> T 'string+number', 'hello')]=], (function() -- shunt/quicktype.yue:1840
        return T('string+number', 'hello') -- shunt/quicktype.yue:1840
      end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1840)) -- shunt/quicktype.yue:1840
    end) -- shunt/quicktype.yue:1836
    it('checks disjunctions', function() -- shunt/quicktype.yue:1842
      require('shunt.spec')._expect_that([=[(-> T 'string|number', 'hello')]=], (function() -- shunt/quicktype.yue:1843
        return T('string|number', 'hello') -- shunt/quicktype.yue:1843
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1843)); -- shunt/quicktype.yue:1843
      require('shunt.spec')._expect_that([=[(-> T 'string|number', 123)]=], (function() -- shunt/quicktype.yue:1844
        return T('string|number', 123) -- shunt/quicktype.yue:1844
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1844)); -- shunt/quicktype.yue:1844
      return require('shunt.spec')._expect_that([=[(-> T 'string|number', true)]=], (function() -- shunt/quicktype.yue:1845
        return T('string|number', true) -- shunt/quicktype.yue:1845
      end), (errors(matches('incorrect type: expected string|number but got boolean'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1845)) -- shunt/quicktype.yue:1845
    end) -- shunt/quicktype.yue:1842
    it('checks nested inline disjunctions', function() -- shunt/quicktype.yue:1847
      require('shunt.spec')._expect_that([=[(-> T 'number|{string|number}|string', 'hello')]=], (function() -- shunt/quicktype.yue:1848
        return T('number|{string|number}|string', 'hello') -- shunt/quicktype.yue:1848
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1848)); -- shunt/quicktype.yue:1848
      require('shunt.spec')._expect_that([=[(-> T 'number|{string|number}|string', {hello: true})]=], (function() -- shunt/quicktype.yue:1849
        return T('number|{string|number}|string', { -- shunt/quicktype.yue:1849
          hello = true -- shunt/quicktype.yue:1849
        }) -- shunt/quicktype.yue:1849
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1849)); -- shunt/quicktype.yue:1849
      require('shunt.spec')._expect_that([=[(-> T 'number|{string|number}|string', {[1]: true})]=], (function() -- shunt/quicktype.yue:1850
        return T('number|{string|number}|string', { -- shunt/quicktype.yue:1850
          [1] = true -- shunt/quicktype.yue:1850
        }) -- shunt/quicktype.yue:1850
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1850)); -- shunt/quicktype.yue:1850
      return require('shunt.spec')._expect_that([=[(-> T 'number|{string|number}|string', ->)]=], (function() -- shunt/quicktype.yue:1851
        return T('number|{string|number}|string', function() end) -- shunt/quicktype.yue:1851
      end), (errors(matches('incorrect type: expected number|{string|number}|string but got function'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1851)) -- shunt/quicktype.yue:1851
    end) -- shunt/quicktype.yue:1847
    return it('checks nested recursive disjunctions', function() -- shunt/quicktype.yue:1853
      declare_type('InnerDisjunction', 'string|number'); -- shunt/quicktype.yue:1854
      require('shunt.spec')._expect_that([=[(-> T 'boolean|InnerDisjunction|function', true)]=], (function() -- shunt/quicktype.yue:1855
        return T('boolean|InnerDisjunction|function', true) -- shunt/quicktype.yue:1855
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1855)); -- shunt/quicktype.yue:1855
      require('shunt.spec')._expect_that([=[(-> T 'boolean|InnerDisjunction|function', 'hello')]=], (function() -- shunt/quicktype.yue:1856
        return T('boolean|InnerDisjunction|function', 'hello') -- shunt/quicktype.yue:1856
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1856)); -- shunt/quicktype.yue:1856
      require('shunt.spec')._expect_that([=[(-> T 'boolean|InnerDisjunction|function', 123)]=], (function() -- shunt/quicktype.yue:1857
        return T('boolean|InnerDisjunction|function', 123) -- shunt/quicktype.yue:1857
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1857)); -- shunt/quicktype.yue:1857
      require('shunt.spec')._expect_that([=[(-> T 'boolean|InnerDisjunction|function', ->)]=], (function() -- shunt/quicktype.yue:1858
        return T('boolean|InnerDisjunction|function', function() end) -- shunt/quicktype.yue:1858
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1858)); -- shunt/quicktype.yue:1858
      return require('shunt.spec')._expect_that([=[(-> T 'boolean|InnerDisjunction|function', {})]=], (function() -- shunt/quicktype.yue:1860
        return T('boolean|InnerDisjunction|function', { }) -- shunt/quicktype.yue:1860
      end), (errors(matches('incorrect type: expected boolean|InnerDisjunction|function but got table'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1860)) -- shunt/quicktype.yue:1860
    end) -- shunt/quicktype.yue:1860
  end) -- shunt/quicktype.yue:1676
  describe('is', function() -- shunt/quicktype.yue:1862
    it('requires two arguments', function() -- shunt/quicktype.yue:1863
      return require('shunt.spec')._expect_that([=[(-> is!)]=], (function() -- shunt/quicktype.yue:1864
        return is() -- shunt/quicktype.yue:1864
      end), (errors(matches('cannot typecheck: no type spec provided'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1864)) -- shunt/quicktype.yue:1864
    end) -- shunt/quicktype.yue:1863
    it('returns correctly in matching case', function() -- shunt/quicktype.yue:1866
      local ok, err = is('string', 'asdf'); -- shunt/quicktype.yue:1867
      require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1868)); -- shunt/quicktype.yue:1868
      return require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1869)) -- shunt/quicktype.yue:1869
    end) -- shunt/quicktype.yue:1866
    return it('returns correctly in non-matching case', function() -- shunt/quicktype.yue:1871
      local ok, err = is('nil', 'asdf'); -- shunt/quicktype.yue:1872
      require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1873)); -- shunt/quicktype.yue:1873
      return require('shunt.spec')._expect_that([=[err]=], err, (matches('incorrect type')), tostring("shunt/quicktype.yue") .. ":" .. tostring(1874)) -- shunt/quicktype.yue:1874
    end) -- shunt/quicktype.yue:1874
  end) -- shunt/quicktype.yue:1862
  describe('declare_type', function() -- shunt/quicktype.yue:1876
    it('requires two arguments', function() -- shunt/quicktype.yue:1877
      require('shunt.spec')._expect_that([=[(-> declare_type!)]=], (function() -- shunt/quicktype.yue:1878
        return declare_type() -- shunt/quicktype.yue:1878
      end), (errors(matches('declare_type requires a name'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1878)); -- shunt/quicktype.yue:1878
      require('shunt.spec')._expect_that([=[(-> declare_type 'TwoArgs')]=], (function() -- shunt/quicktype.yue:1879
        return declare_type('TwoArgs') -- shunt/quicktype.yue:1879
      end), (errors(matches('declare_type requires a type_spec'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1879)); -- shunt/quicktype.yue:1879
      require('shunt.spec')._expect_that([=[(-> declare_type 123, 'string')]=], (function() -- shunt/quicktype.yue:1880
        return declare_type(123, 'string') -- shunt/quicktype.yue:1880
      end), (errors(matches('declare_type requires a string name'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1880)); -- shunt/quicktype.yue:1880
      return require('shunt.spec')._expect_that([=[(-> declare_type 'TwoArgs', 123)]=], (function() -- shunt/quicktype.yue:1881
        return declare_type('TwoArgs', 123) -- shunt/quicktype.yue:1881
      end), (errors(matches('declare_type requires a string type_spec'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1881)) -- shunt/quicktype.yue:1881
    end) -- shunt/quicktype.yue:1877
    it('rejects false primitives', function() -- shunt/quicktype.yue:1883
      return require('shunt.spec')._expect_that([=[(-> declare_type 'user', 'string')]=], (function() -- shunt/quicktype.yue:1884
        return declare_type('user', 'string') -- shunt/quicktype.yue:1884
      end), (errors(matches('user types must start with uppercase'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1884)) -- shunt/quicktype.yue:1884
    end) -- shunt/quicktype.yue:1883
    it('rejects redefinition', function() -- shunt/quicktype.yue:1886
      declare_type('AlreadyDefined', 'number'); -- shunt/quicktype.yue:1887
      return require('shunt.spec')._expect_that([=[(-> declare_type 'AlreadyDefined', 'string')]=], (function() -- shunt/quicktype.yue:1888
        return declare_type('AlreadyDefined', 'string') -- shunt/quicktype.yue:1888
      end), (errors(matches([[cannot redefine type 'AlreadyDefined']]))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1888)) -- shunt/quicktype.yue:1888
    end) -- shunt/quicktype.yue:1886
    it('supports non-recursive types', function() -- shunt/quicktype.yue:1890
      declare_type('NonRecursive', '[string]'); -- shunt/quicktype.yue:1891
      require('shunt.spec')._expect_that([=[(-> T '[NonRecursive]', {{'hello'}})]=], (function() -- shunt/quicktype.yue:1892
        return T('[NonRecursive]', { -- shunt/quicktype.yue:1892
          { -- shunt/quicktype.yue:1892
            'hello' -- shunt/quicktype.yue:1892
          } -- shunt/quicktype.yue:1892
        }) -- shunt/quicktype.yue:1892
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1892)) -- shunt/quicktype.yue:1892
      declare_type('prefixed.NonRecursive', '[string]'); -- shunt/quicktype.yue:1894
      return require('shunt.spec')._expect_that([=[(-> T '[prefixed.NonRecursive]', {{'hello'}})]=], (function() -- shunt/quicktype.yue:1895
        return T('[prefixed.NonRecursive]', { -- shunt/quicktype.yue:1895
          { -- shunt/quicktype.yue:1895
            'hello' -- shunt/quicktype.yue:1895
          } -- shunt/quicktype.yue:1895
        }) -- shunt/quicktype.yue:1895
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1895)) -- shunt/quicktype.yue:1895
    end) -- shunt/quicktype.yue:1890
    return it('supports recursive types', function() -- shunt/quicktype.yue:1897
      declare_type('Recursive', '[?Recursive]'); -- shunt/quicktype.yue:1898
      require('shunt.spec')._expect_that([=[(-> T 'Recursive', {{{{{nil}}}}})]=], (function() -- shunt/quicktype.yue:1899
        return T('Recursive', { -- shunt/quicktype.yue:1899
          { -- shunt/quicktype.yue:1899
            { -- shunt/quicktype.yue:1899
              { -- shunt/quicktype.yue:1899
                { -- shunt/quicktype.yue:1899
                  nil -- shunt/quicktype.yue:1899
                } -- shunt/quicktype.yue:1899
              } -- shunt/quicktype.yue:1899
            } -- shunt/quicktype.yue:1899
          } -- shunt/quicktype.yue:1899
        }) -- shunt/quicktype.yue:1899
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1899)); -- shunt/quicktype.yue:1899
      require('shunt.spec')._expect_that([=[(-> T 'Recursive', {{{{{'asdf'}}}}})]=], (function() -- shunt/quicktype.yue:1900
        return T('Recursive', { -- shunt/quicktype.yue:1900
          { -- shunt/quicktype.yue:1900
            { -- shunt/quicktype.yue:1900
              { -- shunt/quicktype.yue:1900
                { -- shunt/quicktype.yue:1900
                  'asdf' -- shunt/quicktype.yue:1900
                } -- shunt/quicktype.yue:1900
              } -- shunt/quicktype.yue:1900
            } -- shunt/quicktype.yue:1900
          } -- shunt/quicktype.yue:1900
        }) -- shunt/quicktype.yue:1900
      end), (errors(matches('incorrect type: expected table but got string'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1900)) -- shunt/quicktype.yue:1900
      declare_type('MutuallyRecursive1', '?MutuallyRecursive2') -- shunt/quicktype.yue:1902
      declare_type('MutuallyRecursive2', 'MutuallyRecursive1'); -- shunt/quicktype.yue:1903
      require('shunt.spec')._expect_that([=[(-> T 'MutuallyRecursive1', nil)]=], (function() -- shunt/quicktype.yue:1904
        return T('MutuallyRecursive1', nil) -- shunt/quicktype.yue:1904
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1904)); -- shunt/quicktype.yue:1904
      return require('shunt.spec')._expect_that([=[(-> T 'MutuallyRecursive1', 'asdf')]=], (function() -- shunt/quicktype.yue:1905
        return T('MutuallyRecursive1', 'asdf') -- shunt/quicktype.yue:1905
      end), (errors(matches('type checker recursed too many times'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1905)) -- shunt/quicktype.yue:1905
    end) -- shunt/quicktype.yue:1905
  end) -- shunt/quicktype.yue:1876
  describe('declare_singleton_type', function() -- shunt/quicktype.yue:1907
    it('requires a valid name', function() -- shunt/quicktype.yue:1908
      require('shunt.spec')._expect_that([=[declare_singleton_type]=], declare_singleton_type, (errors(matches('requires a value'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1909)); -- shunt/quicktype.yue:1909
      require('shunt.spec')._expect_that([=[(-> declare_singleton_type {})]=], (function() -- shunt/quicktype.yue:1911
        return declare_singleton_type({ }) -- shunt/quicktype.yue:1911
      end), (errors(matches("user types must start with an uppercase letter"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1911)); -- shunt/quicktype.yue:1911
      require('shunt.spec')._expect_that([==[(-> declare_singleton_type <tostring>: => 'Has space')]==], (function() -- shunt/quicktype.yue:1912
        return declare_singleton_type(setmetatable({ }, { -- shunt/quicktype.yue:1912
          __tostring = function(self) -- shunt/quicktype.yue:1912
            return 'Has space' -- shunt/quicktype.yue:1912
          end -- shunt/quicktype.yue:1912
        })) -- shunt/quicktype.yue:1912
      end), (errors(matches("cannot declare type 'Has space': not a valid identifier"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1912)); -- shunt/quicktype.yue:1912
      return require('shunt.spec')._expect_that([==[(-> declare_singleton_type <tostring>: => 'SingletonTable')]==], (function() -- shunt/quicktype.yue:1913
        return declare_singleton_type(setmetatable({ }, { -- shunt/quicktype.yue:1913
          __tostring = function(self) -- shunt/quicktype.yue:1913
            return 'SingletonTable' -- shunt/quicktype.yue:1913
          end -- shunt/quicktype.yue:1913
        })) -- shunt/quicktype.yue:1913
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1913)) -- shunt/quicktype.yue:1913
    end) -- shunt/quicktype.yue:1908
    it('requires a unique name', function() -- shunt/quicktype.yue:1915
      local NAME = 'UniqueSingleton' -- shunt/quicktype.yue:1916
      declare_singleton_type(setmetatable({ }, { -- shunt/quicktype.yue:1917
        __tostring = function(self) -- shunt/quicktype.yue:1917
          return NAME -- shunt/quicktype.yue:1917
        end -- shunt/quicktype.yue:1917
      })); -- shunt/quicktype.yue:1917
      return require('shunt.spec')._expect_that([==[(-> declare_singleton_type <tostring>: => NAME)]==], (function() -- shunt/quicktype.yue:1918
        return declare_singleton_type(setmetatable({ }, { -- shunt/quicktype.yue:1918
          __tostring = function(self) -- shunt/quicktype.yue:1918
            return NAME -- shunt/quicktype.yue:1918
          end -- shunt/quicktype.yue:1918
        })) -- shunt/quicktype.yue:1918
      end), (errors(matches("cannot redefine type '" .. tostring(NAME) .. "'"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1918)) -- shunt/quicktype.yue:1918
    end) -- shunt/quicktype.yue:1915
    return it('rejects primitives', function() -- shunt/quicktype.yue:1920
      require('shunt.spec')._expect_that([=[(-> declare_singleton_type 123)]=], (function() -- shunt/quicktype.yue:1921
        return declare_singleton_type(123) -- shunt/quicktype.yue:1921
      end), (errors(matches('declare_singleton_type requires a table value'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1921)); -- shunt/quicktype.yue:1921
      return require('shunt.spec')._expect_that([=[(-> declare_singleton_type 'hello')]=], (function() -- shunt/quicktype.yue:1922
        return declare_singleton_type('hello') -- shunt/quicktype.yue:1922
      end), (errors(matches('declare_singleton_type requires a table value'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1922)) -- shunt/quicktype.yue:1922
    end) -- shunt/quicktype.yue:1922
  end) -- shunt/quicktype.yue:1907
  describe('F', function() -- shunt/quicktype.yue:1924
    it('requires two arguments', function() -- shunt/quicktype.yue:1925
      require('shunt.spec')._expect_that([=[(-> F!)]=], (function() -- shunt/quicktype.yue:1926
        return F() -- shunt/quicktype.yue:1926
      end), (errors(matches('cannot typecheck: no type spec provided'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1926)); -- shunt/quicktype.yue:1926
      require('shunt.spec')._expect_that([=[(-> F '() -> nil')]=], (function() -- shunt/quicktype.yue:1927
        return F('() -> nil') -- shunt/quicktype.yue:1927
      end), (errors(matches('cannot typecheck: no function provided'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1927)); -- shunt/quicktype.yue:1927
      return require('shunt.spec')._expect_that([=[(-> F '() -> nil', 'interloper')]=], (function() -- shunt/quicktype.yue:1928
        return F('() -> nil', 'interloper') -- shunt/quicktype.yue:1928
      end), (errors(matches('cannot typecheck: no function provided'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1928)) -- shunt/quicktype.yue:1928
    end) -- shunt/quicktype.yue:1925
    it('returns its second argument', function() -- shunt/quicktype.yue:1930
      local f = F('(number, number) -> number', function(a, b) -- shunt/quicktype.yue:1931
        return a + b -- shunt/quicktype.yue:1931
      end); -- shunt/quicktype.yue:1931
      return require('shunt.spec')._expect_that([=[(f 1, 2)]=], (f(1, 2)), (eq(3)), tostring("shunt/quicktype.yue") .. ":" .. tostring(1932)) -- shunt/quicktype.yue:1932
    end) -- shunt/quicktype.yue:1930
    it('accepts none returns', function() -- shunt/quicktype.yue:1934
      return require('shunt.spec')._expect_that([=[(-> (F '() -> <>', ->)!)]=], (function() -- shunt/quicktype.yue:1935
        return (F('() -> <>', function() end))() -- shunt/quicktype.yue:1935
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1935)) -- shunt/quicktype.yue:1935
    end) -- shunt/quicktype.yue:1934
    it('accepts nil returns', function() -- shunt/quicktype.yue:1937
      return require('shunt.spec')._expect_that([=[(-> (F '() -> nil', -> nil)!)]=], (function() -- shunt/quicktype.yue:1938
        return (F('() -> nil', function() -- shunt/quicktype.yue:1938
          return nil -- shunt/quicktype.yue:1938
        end))() -- shunt/quicktype.yue:1938
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1938)) -- shunt/quicktype.yue:1938
    end) -- shunt/quicktype.yue:1937
    it('accepts absent optional arguments', function() -- shunt/quicktype.yue:1940
      return require('shunt.spec')._expect_that([=[(-> (F '() -> ?string', ->)!)]=], (function() -- shunt/quicktype.yue:1941
        return (F('() -> ?string', function() end))() -- shunt/quicktype.yue:1941
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1941)) -- shunt/quicktype.yue:1941
    end) -- shunt/quicktype.yue:1940
    it('accepts remainder arguments', function() -- shunt/quicktype.yue:1943
      require('shunt.spec')._expect_that([=[(-> (F '(string...) -> nil', ->)!)]=], (function() -- shunt/quicktype.yue:1944
        return (F('(string...) -> nil', function() end))() -- shunt/quicktype.yue:1944
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1944)); -- shunt/quicktype.yue:1944
      require('shunt.spec')._expect_that([=[(-> (F '(string...) -> nil', ->) 'hello', 'world')]=], (function() -- shunt/quicktype.yue:1945
        return (F('(string...) -> nil', function() end))('hello', 'world') -- shunt/quicktype.yue:1945
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1945)); -- shunt/quicktype.yue:1945
      require('shunt.spec')._expect_that([=[(-> (F '(number, string...) -> nil', ->) 123, 'hello', 'world')]=], (function() -- shunt/quicktype.yue:1946
        return (F('(number, string...) -> nil', function() end))(123, 'hello', 'world') -- shunt/quicktype.yue:1946
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1946)); -- shunt/quicktype.yue:1946
      return require('shunt.spec')._expect_that([=[(-> (F '(number, string...) -> nil', (...) ->) 123, 'hello', true)]=], (function() -- shunt/quicktype.yue:1948
        return (F('(number, string...) -> nil', function(...) end))(123, 'hello', true) -- shunt/quicktype.yue:1948
      end), (errors(matches('incorrect type: expected string but got boolean'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1948)) -- shunt/quicktype.yue:1948
    end) -- shunt/quicktype.yue:1943
    it('accepts absent optional returns', function() -- shunt/quicktype.yue:1950
      return require('shunt.spec')._expect_that([=[(-> (F '() -> nil', ->)!)]=], (function() -- shunt/quicktype.yue:1951
        return (F('() -> nil', function() end))() -- shunt/quicktype.yue:1951
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1951)) -- shunt/quicktype.yue:1951
    end) -- shunt/quicktype.yue:1950
    it('accepts multiple return values', function() -- shunt/quicktype.yue:1953
      return require('shunt.spec')._expect_that([=[(-> (F '() -> <string, boolean>', -> 'a', true)!)]=], (function() -- shunt/quicktype.yue:1954
        return (F('() -> <string, boolean>', function() -- shunt/quicktype.yue:1954
          return 'a', true -- shunt/quicktype.yue:1954
        end))() -- shunt/quicktype.yue:1954
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1954)) -- shunt/quicktype.yue:1954
    end) -- shunt/quicktype.yue:1953
    it('accepts remainder return values', function() -- shunt/quicktype.yue:1956
      require('shunt.spec')._expect_that([=[(-> (F '() -> string...', ->)!)]=], (function() -- shunt/quicktype.yue:1957
        return (F('() -> string...', function() end))() -- shunt/quicktype.yue:1957
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1957)); -- shunt/quicktype.yue:1957
      require('shunt.spec')._expect_that([=[(-> (F '() -> string...', -> 'hello', 'world')!)]=], (function() -- shunt/quicktype.yue:1958
        return (F('() -> string...', function() -- shunt/quicktype.yue:1958
          return 'hello', 'world' -- shunt/quicktype.yue:1958
        end))() -- shunt/quicktype.yue:1958
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1958)); -- shunt/quicktype.yue:1958
      require('shunt.spec')._expect_that([=[(-> (F '() -> <number, string...>', -> 123, 'hello', 'world')!)]=], (function() -- shunt/quicktype.yue:1959
        return (F('() -> <number, string...>', function() -- shunt/quicktype.yue:1959
          return 123, 'hello', 'world' -- shunt/quicktype.yue:1959
        end))() -- shunt/quicktype.yue:1959
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1959)); -- shunt/quicktype.yue:1959
      return require('shunt.spec')._expect_that([=[(-> (F '() -> <number, string...>', -> 123, 'hello', true)!)]=], (function() -- shunt/quicktype.yue:1961
        return (F('() -> <number, string...>', function() -- shunt/quicktype.yue:1961
          return 123, 'hello', true -- shunt/quicktype.yue:1961
        end))() -- shunt/quicktype.yue:1961
      end), (errors(matches('incorrect type: expected string but got boolean'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1961)) -- shunt/quicktype.yue:1961
    end) -- shunt/quicktype.yue:1956
    it('prevents execution on invalid args', function() -- shunt/quicktype.yue:1963
      return require('shunt.spec')._expect_that([=[(-> (F '(string) -> nil', -> error 'OH NO') 123)]=], (function() -- shunt/quicktype.yue:1964
        return (F('(string) -> nil', function() -- shunt/quicktype.yue:1964
          return error('OH NO') -- shunt/quicktype.yue:1964
        end))(123) -- shunt/quicktype.yue:1964
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1964)) -- shunt/quicktype.yue:1964
    end) -- shunt/quicktype.yue:1963
    it('rejects non-function types', function() -- shunt/quicktype.yue:1966
      return require('shunt.spec')._expect_that([=[(-> F '{}', ->)]=], (function() -- shunt/quicktype.yue:1967
        return F('{}', function() end) -- shunt/quicktype.yue:1967
      end), (errors(matches('cannot typecheck: expected a function type'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1967)) -- shunt/quicktype.yue:1967
    end) -- shunt/quicktype.yue:1966
    it('rejects incorrect-type arguments', function() -- shunt/quicktype.yue:1969
      return require('shunt.spec')._expect_that([=[(-> (F '(string) -> table', ->) 123)]=], (function() -- shunt/quicktype.yue:1970
        return (F('(string) -> table', function() end))(123) -- shunt/quicktype.yue:1970
      end), (errors(matches('incorrect type: expected string but got number'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1970)) -- shunt/quicktype.yue:1970
    end) -- shunt/quicktype.yue:1969
    it('rejects extra arguments', function() -- shunt/quicktype.yue:1972
      return require('shunt.spec')._expect_that([=[(-> (F '(string) -> table', ->) 'a', 'b')]=], (function() -- shunt/quicktype.yue:1973
        return (F('(string) -> table', function() end))('a', 'b') -- shunt/quicktype.yue:1973
      end), (errors(matches('function given too many arguments'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1973)) -- shunt/quicktype.yue:1973
    end) -- shunt/quicktype.yue:1972
    it('rejects incorrect-type return values', function() -- shunt/quicktype.yue:1975
      return require('shunt.spec')._expect_that([=[(-> (F '(table) -> string', ->) {})]=], (function() -- shunt/quicktype.yue:1976
        return (F('(table) -> string', function() end))({ }) -- shunt/quicktype.yue:1976
      end), (errors(matches('incorrect type: expected string but got nil'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1976)) -- shunt/quicktype.yue:1976
    end) -- shunt/quicktype.yue:1975
    it('rejects extra return arguments', function() -- shunt/quicktype.yue:1978
      return require('shunt.spec')._expect_that([=[(-> (F '() -> string', -> 'a', 'b')!)]=], (function() -- shunt/quicktype.yue:1979
        return (F('() -> string', function() -- shunt/quicktype.yue:1979
          return 'a', 'b' -- shunt/quicktype.yue:1979
        end))() -- shunt/quicktype.yue:1979
      end), (errors(matches('function returned too many values'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1979)) -- shunt/quicktype.yue:1979
    end) -- shunt/quicktype.yue:1978
    it('rejects multiple incorrect return values', function() -- shunt/quicktype.yue:1981
      require('shunt.spec')._expect_that([=[(-> (F '() -> <string, boolean>', -> {}, true)!)]=], (function() -- shunt/quicktype.yue:1982
        return (F('() -> <string, boolean>', function() -- shunt/quicktype.yue:1982
          return { }, true -- shunt/quicktype.yue:1982
        end))() -- shunt/quicktype.yue:1982
      end), (errors(matches('incorrect type: expected string but got table'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1982)); -- shunt/quicktype.yue:1982
      return require('shunt.spec')._expect_that([=[(-> (F '() -> <string, boolean>', -> 'asdf', {})!)]=], (function() -- shunt/quicktype.yue:1983
        return (F('() -> <string, boolean>', function() -- shunt/quicktype.yue:1983
          return 'asdf', { } -- shunt/quicktype.yue:1983
        end))() -- shunt/quicktype.yue:1983
      end), (errors(matches('incorrect type: expected boolean but got table'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1983)) -- shunt/quicktype.yue:1983
    end) -- shunt/quicktype.yue:1981
    it('accepts methods', function() -- shunt/quicktype.yue:1985
      require('shunt.spec')._expect_that([==[(-> (F '(number) => <>', =>), {}, 123)]==], (function() -- shunt/quicktype.yue:1986
        return (F('(number) => <>', function(self) end)), { }, 123 -- shunt/quicktype.yue:1986
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1986)); -- shunt/quicktype.yue:1986
      return require('shunt.spec')._expect_that([==[(-> (F '(number) => <>', =>), 'recv', 123)]==], (function() -- shunt/quicktype.yue:1987
        return (F('(number) => <>', function(self) end)), 'recv', 123 -- shunt/quicktype.yue:1987
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(1987)) -- shunt/quicktype.yue:1987
    end) -- shunt/quicktype.yue:1985
    it('requires a method receiver', function() -- shunt/quicktype.yue:1989
      return require('shunt.spec')._expect_that([==[(-> (F '() => <>', =>)!)]==], (function() -- shunt/quicktype.yue:1990
        return (F('() => <>', function(self) end))() -- shunt/quicktype.yue:1990
      end), (errors(matches("incorrect type: expected some but got nil"))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1990)) -- shunt/quicktype.yue:1990
    end) -- shunt/quicktype.yue:1989
    return it('checks never', function() -- shunt/quicktype.yue:1992
      return require('shunt.spec')._expect_that([=[(-> (F '() -> !', ->)!)]=], (function() -- shunt/quicktype.yue:1993
        return (F('() -> !', function() end))() -- shunt/quicktype.yue:1993
      end), (errors(matches('never expected a value here'))), tostring("shunt/quicktype.yue") .. ":" .. tostring(1993)) -- shunt/quicktype.yue:1993
    end) -- shunt/quicktype.yue:1993
  end) -- shunt/quicktype.yue:1924
  describe('stats', function() -- shunt/quicktype.yue:1995
    return it('has the correct type', function() -- shunt/quicktype.yue:1996
      local prev_collect_stats = COLLECT_STATS -- shunt/quicktype.yue:1997
      COLLECT_STATS = true -- shunt/quicktype.yue:1998
      T('string', 'hello') -- shunt/quicktype.yue:2000
      local stats_arr = stats(); -- shunt/quicktype.yue:2001
      require('shunt.spec')._expect_that([=[stats_arr]=], stats_arr, (len(gt(0))), tostring("shunt/quicktype.yue") .. ":" .. tostring(2002)); -- shunt/quicktype.yue:2002
      require('shunt.spec')._expect_that([=[stats_arr]=], stats_arr, (each_value(has_fields({ -- shunt/quicktype.yue:2003
        count = ge(0) -- shunt/quicktype.yue:2003
      }))), tostring("shunt/quicktype.yue") .. ":" .. tostring(2003)) -- shunt/quicktype.yue:2003
      COLLECT_STATS = prev_collect_stats -- shunt/quicktype.yue:2005
    end) -- shunt/quicktype.yue:2005
  end) -- shunt/quicktype.yue:1995
  describe('is_valid_type_spec', function() -- shunt/quicktype.yue:2007
    it('returns true on valid type specs', function() -- shunt/quicktype.yue:2008
      return require('shunt.spec')._expect_that([=[(is_valid_type_spec 'number')]=], (is_valid_type_spec('number')), (eq(true)), tostring("shunt/quicktype.yue") .. ":" .. tostring(2009)) -- shunt/quicktype.yue:2009
    end) -- shunt/quicktype.yue:2008
    return it('returns false on invalid type specs', function() -- shunt/quicktype.yue:2011
      require('shunt.spec')._expect_that([=[(is_valid_type_spec 'unknown')]=], (is_valid_type_spec('unknown')), (eq(false)), tostring("shunt/quicktype.yue") .. ":" .. tostring(2012)); -- shunt/quicktype.yue:2012
      require('shunt.spec')._expect_that([=[(is_valid_type_spec '(')]=], (is_valid_type_spec('(')), (eq(false)), tostring("shunt/quicktype.yue") .. ":" .. tostring(2013)); -- shunt/quicktype.yue:2013
      return require('shunt.spec')._expect_that([=[(is_valid_type_spec ')')]=], (is_valid_type_spec(')')), (eq(false)), tostring("shunt/quicktype.yue") .. ":" .. tostring(2014)) -- shunt/quicktype.yue:2014
    end) -- shunt/quicktype.yue:2014
  end) -- shunt/quicktype.yue:2007
  return describe('deactivate_typechecks', function() -- shunt/quicktype.yue:2016
    local activate_typechecks -- shunt/quicktype.yue:2017
    activate_typechecks = function() -- shunt/quicktype.yue:2017
      skip_typechecking = false -- shunt/quicktype.yue:2018
    end -- shunt/quicktype.yue:2017
    return it('deactivates typechecks', function() -- shunt/quicktype.yue:2020
      local received -- shunt/quicktype.yue:2021
      local f = F('(number) => <>', function(r) -- shunt/quicktype.yue:2022
        received = r -- shunt/quicktype.yue:2023
      end); -- shunt/quicktype.yue:2022
      require('shunt.spec')._assert_that([=[(-> f 'prepare for')]=], (function() -- shunt/quicktype.yue:2024
        return f('prepare for') -- shunt/quicktype.yue:2024
      end), (errors(anything())), tostring("shunt/quicktype.yue") .. ":" .. tostring(2024)) -- shunt/quicktype.yue:2024
      deactivate_typechecks(); -- shunt/quicktype.yue:2026
      require('shunt.spec')._assert_that([=[(-> f 'unforeseen')]=], (function() -- shunt/quicktype.yue:2027
        return f('unforeseen') -- shunt/quicktype.yue:2027
      end), (no_errors()), tostring("shunt/quicktype.yue") .. ":" .. tostring(2027)) -- shunt/quicktype.yue:2027
      activate_typechecks(); -- shunt/quicktype.yue:2029
      return require('shunt.spec')._assert_that([=[(-> f 'consequences')]=], (function() -- shunt/quicktype.yue:2030
        return f('consequences') -- shunt/quicktype.yue:2030
      end), (errors(anything())), tostring("shunt/quicktype.yue") .. ":" .. tostring(2030)) -- shunt/quicktype.yue:2030
    end) -- shunt/quicktype.yue:2030
  end) -- shunt/quicktype.yue:2030
end) -- shunt/quicktype.yue:1394
return _module_0 -- shunt/quicktype.yue:2030
end
package.preload['shunt.spec'] = function(...)
-- [yue]: shunt/spec.yue
local _module_0 = { } -- shunt/spec.yue:1
local spec_fns, verbose, set_log_verbosity, log, spec, root_spec, current_spec, current_spec_kind, describe, it, declare_spec_section, Spec, FATAL_TEST_ERROR_MARKER, Test, expect_that, _expect_that, assert_that, _assert_that, get_caller_location, Anything, Some, Not, Eq, Compare, Near, DeepEq, Type, Matches, Len, ToStringsAs, NoErrors, Errors, Contains, Each, Fields, visible_chars, repr, is_list, can_sort, clone, matchers, reflow, testing, running_tests, run_tests -- shunt/spec.yue:1
spec_fns = nil -- shunt/spec.yue:3
verbose = false -- shunt/spec.yue:5
set_log_verbosity = function(v) -- shunt/spec.yue:6
  if v == nil then -- shunt/spec.yue:6
    v = true -- shunt/spec.yue:6
  end -- shunt/spec.yue:6
  verbose = v -- shunt/spec.yue:7
end -- shunt/spec.yue:6
_module_0["set_log_verbosity"] = set_log_verbosity -- shunt/spec.yue:7
log = function(msg) -- shunt/spec.yue:8
  if verbose then -- shunt/spec.yue:9
    return print(msg()) -- shunt/spec.yue:10
  end -- shunt/spec.yue:9
end -- shunt/spec.yue:8
spec = function(fn) -- shunt/spec.yue:12
  if not (spec_fns ~= nil) then -- shunt/spec.yue:13
    spec_fns = { } -- shunt/spec.yue:14
  end -- shunt/spec.yue:13
  spec_fns[#spec_fns + 1] = fn -- shunt/spec.yue:15
end -- shunt/spec.yue:12
_module_0["spec"] = spec -- shunt/spec.yue:15
root_spec = nil -- shunt/spec.yue:17
current_spec = nil -- shunt/spec.yue:18
current_spec_kind = 'describe' -- shunt/spec.yue:19
describe = function(what, fn) -- shunt/spec.yue:20
  return declare_spec_section('describe', what, fn) -- shunt/spec.yue:21
end -- shunt/spec.yue:20
_module_0["describe"] = describe -- shunt/spec.yue:21
it = function(what, fn) -- shunt/spec.yue:23
  return declare_spec_section('it', what, fn) -- shunt/spec.yue:24
end -- shunt/spec.yue:23
_module_0["it"] = it -- shunt/spec.yue:24
declare_spec_section = function(kind, what, fn) -- shunt/spec.yue:26
  if not (root_spec ~= nil) then -- shunt/spec.yue:27
    root_spec = Spec:root() -- shunt/spec.yue:28
  end -- shunt/spec.yue:27
  if not (current_spec ~= nil) then -- shunt/spec.yue:29
    current_spec = root_spec -- shunt/spec.yue:30
  end -- shunt/spec.yue:29
  if current_spec.kind ~= 'describe' then -- shunt/spec.yue:32
    error("cannot use `" .. tostring(kind) .. "` in `" .. tostring(current_spec.kind) .. "` spec") -- shunt/spec.yue:33
  end -- shunt/spec.yue:32
  if 'describe' == kind then -- shunt/spec.yue:36
    local parent_spec = current_spec -- shunt/spec.yue:37
    current_spec = Spec(kind, what, parent_spec) -- shunt/spec.yue:39
    fn() -- shunt/spec.yue:40
    parent_spec:add_child(current_spec) -- shunt/spec.yue:42
    current_spec = parent_spec -- shunt/spec.yue:43
  elseif 'it' == kind then -- shunt/spec.yue:44
    return current_spec:add_child(Test(what, fn, current_spec)) -- shunt/spec.yue:45
  else -- shunt/spec.yue:47
    return error("internal error: unknown kind " .. tostring(repr(kind))) -- shunt/spec.yue:47
  end -- shunt/spec.yue:47
end -- shunt/spec.yue:26
do -- shunt/spec.yue:49
  local _class_0 -- shunt/spec.yue:49
  local _base_0 = { -- shunt/spec.yue:49
    add_child = function(self, child) -- shunt/spec.yue:56
      do -- shunt/spec.yue:57
        local _obj_0 = self.children -- shunt/spec.yue:57
        _obj_0[#_obj_0 + 1] = child -- shunt/spec.yue:57
      end -- shunt/spec.yue:57
    end, -- shunt/spec.yue:59
    desc = function(self) -- shunt/spec.yue:59
      local rev_parts -- shunt/spec.yue:60
      do -- shunt/spec.yue:60
        local _with_0 = { -- shunt/spec.yue:60
          self.name -- shunt/spec.yue:60
        } -- shunt/spec.yue:60
        spec = self.parent -- shunt/spec.yue:61
        while (spec ~= nil) do -- shunt/spec.yue:62
          _with_0[#_with_0 + 1] = spec.name -- shunt/spec.yue:63
          spec = spec.parent -- shunt/spec.yue:64
        end -- shunt/spec.yue:64
        rev_parts = _with_0 -- shunt/spec.yue:60
      end -- shunt/spec.yue:60
      local parts -- shunt/spec.yue:65
      do -- shunt/spec.yue:65
        local _with_0 = { } -- shunt/spec.yue:65
        local n = #rev_parts -- shunt/spec.yue:66
        for i = 1, n do -- shunt/spec.yue:67
          _with_0[i] = rev_parts[n - i + 1] -- shunt/spec.yue:68
        end -- shunt/spec.yue:68
        parts = _with_0 -- shunt/spec.yue:65
      end -- shunt/spec.yue:65
      return table.concat(parts, ' ') -- shunt/spec.yue:69
    end, -- shunt/spec.yue:71
    test = function(self, filter) -- shunt/spec.yue:71
      if filter == nil then -- shunt/spec.yue:71
        filter = nil -- shunt/spec.yue:71
      end -- shunt/spec.yue:71
      local _list_0 = self.children -- shunt/spec.yue:72
      for _index_0 = 1, #_list_0 do -- shunt/spec.yue:72
        local child = _list_0[_index_0] -- shunt/spec.yue:72
        child:test(filter) -- shunt/spec.yue:73
      end -- shunt/spec.yue:73
    end -- shunt/spec.yue:49
  } -- shunt/spec.yue:49
  if _base_0.__index == nil then -- shunt/spec.yue:49
    _base_0.__index = _base_0 -- shunt/spec.yue:49
  end -- shunt/spec.yue:73
  _class_0 = setmetatable({ -- shunt/spec.yue:49
    __init = function(self, kind, name, parent) -- shunt/spec.yue:53
      self.kind = kind -- shunt/spec.yue:53
      self.name = name -- shunt/spec.yue:53
      self.parent = parent -- shunt/spec.yue:53
      self.children = { } -- shunt/spec.yue:54
    end, -- shunt/spec.yue:49
    __base = _base_0, -- shunt/spec.yue:49
    __name = "Spec" -- shunt/spec.yue:49
  }, { -- shunt/spec.yue:49
    __index = _base_0, -- shunt/spec.yue:49
    __call = function(cls, ...) -- shunt/spec.yue:49
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:49
      cls.__init(_self_0, ...) -- shunt/spec.yue:49
      return _self_0 -- shunt/spec.yue:49
    end -- shunt/spec.yue:49
  }) -- shunt/spec.yue:49
  _base_0.__class = _class_0 -- shunt/spec.yue:49
  local self = _class_0; -- shunt/spec.yue:49
  self.root = function(self) -- shunt/spec.yue:50
    return Spec('describe', nil, nil) -- shunt/spec.yue:51
  end -- shunt/spec.yue:50
  Spec = _class_0 -- shunt/spec.yue:49
end -- shunt/spec.yue:73
FATAL_TEST_ERROR_MARKER = 'INTERNAL ERROR: FATAL TEST ERROR' -- shunt/spec.yue:75
do -- shunt/spec.yue:77
  local _class_0 -- shunt/spec.yue:77
  local _base_0 = { -- shunt/spec.yue:77
    test = function(self, filter) -- shunt/spec.yue:84
      if filter == nil then -- shunt/spec.yue:84
        filter = nil -- shunt/spec.yue:84
      end -- shunt/spec.yue:84
      if (filter ~= nil) then -- shunt/spec.yue:85
        local desc = self:desc() -- shunt/spec.yue:86
        if not desc:match(filter) then -- shunt/spec.yue:87
          log(function() -- shunt/spec.yue:88
            return "* skipping " .. tostring(desc) -- shunt/spec.yue:88
          end) -- shunt/spec.yue:88
          return -- shunt/spec.yue:89
        end -- shunt/spec.yue:87
      else -- shunt/spec.yue:91
        log(function() -- shunt/spec.yue:91
          return "* running " .. tostring(self:desc()) -- shunt/spec.yue:91
        end) -- shunt/spec.yue:91
      end -- shunt/spec.yue:85
      self.__class.num_run = self.__class.num_run + 1 -- shunt/spec.yue:92
      self.__class.current_run_failures = { } -- shunt/spec.yue:94
      local print_calls = { } -- shunt/spec.yue:95
      local old_print = print -- shunt/spec.yue:96
      print = function(...) -- shunt/spec.yue:97
        print_calls[#print_calls + 1] = { -- shunt/spec.yue:98
          ... -- shunt/spec.yue:98
        } -- shunt/spec.yue:98
      end -- shunt/spec.yue:97
xpcall(function() -- shunt/spec.yue:99
        return self:assertions_fn() -- shunt/spec.yue:100
      end, function(err) -- shunt/spec.yue:100
        if not err:match(FATAL_TEST_ERROR_MARKER) then -- shunt/spec.yue:102
          return Test:fail("caught error: " .. tostring(debug.traceback(err, 2))) -- shunt/spec.yue:103
        end -- shunt/spec.yue:102
      end) -- shunt/spec.yue:103
      print = old_print -- shunt/spec.yue:104
      local failures = self.__class.current_run_failures -- shunt/spec.yue:106
      self.__class.current_run_failures = nil -- shunt/spec.yue:107
      if #failures == 0 then -- shunt/spec.yue:109
        return -- shunt/spec.yue:110
      end -- shunt/spec.yue:109
      if #print_calls > 0 then -- shunt/spec.yue:112
        print('--- START of print output ---') -- shunt/spec.yue:113
        print(table.concat((function() -- shunt/spec.yue:114
          local _accum_0 = { } -- shunt/spec.yue:114
          local _len_0 = 1 -- shunt/spec.yue:114
          for _index_0 = 1, #print_calls do -- shunt/spec.yue:114
            local print_call_parts = print_calls[_index_0] -- shunt/spec.yue:114
            _accum_0[_len_0] = table.concat((function() -- shunt/spec.yue:114
              local _accum_1 = { } -- shunt/spec.yue:114
              local _len_1 = 1 -- shunt/spec.yue:114
              for _index_1 = 1, #print_call_parts do -- shunt/spec.yue:114
                local print_call_part = print_call_parts[_index_1] -- shunt/spec.yue:114
                _accum_1[_len_1] = tostring(print_call_part) -- shunt/spec.yue:114
                _len_1 = _len_1 + 1 -- shunt/spec.yue:114
              end -- shunt/spec.yue:114
              return _accum_1 -- shunt/spec.yue:114
            end)(), '\t') -- shunt/spec.yue:114
            _len_0 = _len_0 + 1 -- shunt/spec.yue:114
          end -- shunt/spec.yue:114
          return _accum_0 -- shunt/spec.yue:114
        end)(), '\n')) -- shunt/spec.yue:114
        print('--- END of print output ---') -- shunt/spec.yue:115
      end -- shunt/spec.yue:112
      print("* " .. tostring(self:desc()) .. ":") -- shunt/spec.yue:117
      for _index_0 = 1, #failures do -- shunt/spec.yue:118
        local failure = failures[_index_0] -- shunt/spec.yue:118
        print("  * " .. tostring(reflow('    ', failure))) -- shunt/spec.yue:119
      end -- shunt/spec.yue:119
    end, -- shunt/spec.yue:121
    desc = function(self) -- shunt/spec.yue:121
      return tostring(self.spec:desc()) .. " " .. tostring(self.name) -- shunt/spec.yue:122
    end -- shunt/spec.yue:77
  } -- shunt/spec.yue:77
  if _base_0.__index == nil then -- shunt/spec.yue:77
    _base_0.__index = _base_0 -- shunt/spec.yue:77
  end -- shunt/spec.yue:145
  _class_0 = setmetatable({ -- shunt/spec.yue:77
    __init = function(self, name, assertions_fn, spec) -- shunt/spec.yue:78
      self.name = name -- shunt/spec.yue:78
      self.assertions_fn = assertions_fn -- shunt/spec.yue:78
      self.spec = spec -- shunt/spec.yue:78
    end, -- shunt/spec.yue:77
    __base = _base_0, -- shunt/spec.yue:77
    __name = "Test" -- shunt/spec.yue:77
  }, { -- shunt/spec.yue:77
    __index = _base_0, -- shunt/spec.yue:77
    __call = function(cls, ...) -- shunt/spec.yue:77
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:77
      cls.__init(_self_0, ...) -- shunt/spec.yue:77
      return _self_0 -- shunt/spec.yue:77
    end -- shunt/spec.yue:77
  }) -- shunt/spec.yue:77
  _base_0.__class = _class_0 -- shunt/spec.yue:77
  local self = _class_0; -- shunt/spec.yue:77
  self.num_run = 0 -- shunt/spec.yue:80
  self.num_failures = 0 -- shunt/spec.yue:81
  self.current_run_failures = nil -- shunt/spec.yue:82
  self.fail = function(self, cause, message) -- shunt/spec.yue:124
    self.__class.num_failures = self.__class.num_failures + 1 -- shunt/spec.yue:125
    local cause_string -- shunt/spec.yue:126
    do -- shunt/spec.yue:126
      local _exp_0 = type(cause) -- shunt/spec.yue:126
      if 'string' == _exp_0 then -- shunt/spec.yue:127
        cause_string = cause -- shunt/spec.yue:128
      elseif 'table' == _exp_0 then -- shunt/spec.yue:129
        local value_label, location, expected, actual_repr, explanation = cause.value_label, cause.location, cause.expected, cause.actual_repr, cause.explanation -- shunt/spec.yue:130
        local value_label_line = '' -- shunt/spec.yue:131
        if (value_label ~= nil) then -- shunt/spec.yue:132
          value_label_line = "value: " .. tostring(value_label) .. "\n" -- shunt/spec.yue:133
        end -- shunt/spec.yue:132
        cause_string = tostring(value_label_line) .. "expected: " .. tostring(reflow('    ', expected, 70)) .. "\nactual: " .. tostring(reflow('    ', actual_repr, 70)) .. ",\n  " .. tostring(reflow('  ', explanation, 70)) .. "\nat: " .. tostring(location) -- shunt/spec.yue:135
      else -- shunt/spec.yue:137
        cause_string = error("internal error: invalid matcher return: " .. tostring(repr(cause))) -- shunt/spec.yue:137
      end -- shunt/spec.yue:137
    end -- shunt/spec.yue:137
    if (message ~= nil) then -- shunt/spec.yue:138
      do -- shunt/spec.yue:139
        local _obj_0 = self.__class.current_run_failures -- shunt/spec.yue:139
        _obj_0[#_obj_0 + 1] = tostring(message) .. ": " .. tostring(cause_string) -- shunt/spec.yue:139
      end -- shunt/spec.yue:139
    else -- shunt/spec.yue:141
      do -- shunt/spec.yue:141
        local _obj_0 = self.__class.current_run_failures -- shunt/spec.yue:141
        _obj_0[#_obj_0 + 1] = cause_string -- shunt/spec.yue:141
      end -- shunt/spec.yue:141
    end -- shunt/spec.yue:138
  end -- shunt/spec.yue:124
  self.fatal = function(self, cause, message) -- shunt/spec.yue:143
    self.__class:fail(cause, message) -- shunt/spec.yue:144
    return error(FATAL_TEST_ERROR_MARKER) -- shunt/spec.yue:145
  end -- shunt/spec.yue:143
  Test = _class_0 -- shunt/spec.yue:77
end -- shunt/spec.yue:145
expect_that = function(actual, matcher) -- shunt/spec.yue:147
  return _expect_that(nil, actual, matcher, nil) -- shunt/spec.yue:148
end -- shunt/spec.yue:147
_module_0["expect_that"] = expect_that -- shunt/spec.yue:148
_expect_that = function(value_label, actual, matcher, location) -- shunt/spec.yue:150
  if not (Test.current_run_failures ~= nil) then -- shunt/spec.yue:151
    error('internal error: expect_that call must be within an `it` call') -- shunt/spec.yue:152
  end -- shunt/spec.yue:151
  if matcher:matches(actual) then -- shunt/spec.yue:154
    return -- shunt/spec.yue:155
  end -- shunt/spec.yue:154
  if location == nil then -- shunt/spec.yue:157
    location = get_caller_location('expect_that') -- shunt/spec.yue:157
  end -- shunt/spec.yue:157
  return Test:fail({ -- shunt/spec.yue:159
    value_label = value_label, -- shunt/spec.yue:159
    location = location, -- shunt/spec.yue:160
    expected = matcher:describe(), -- shunt/spec.yue:161
    actual_repr = (function() -- shunt/spec.yue:162
      local _exp_0 -- shunt/spec.yue:162
      do -- shunt/spec.yue:162
        local _obj_0 = matcher.actual_repr -- shunt/spec.yue:162
        if _obj_0 ~= nil then -- shunt/spec.yue:162
          _exp_0 = _obj_0(matcher) -- shunt/spec.yue:162
        end -- shunt/spec.yue:162
      end -- shunt/spec.yue:162
      if _exp_0 ~= nil then -- shunt/spec.yue:162
        return _exp_0 -- shunt/spec.yue:162
      else -- shunt/spec.yue:162
        return repr(actual) -- shunt/spec.yue:162
      end -- shunt/spec.yue:162
    end)(), -- shunt/spec.yue:162
    explanation = matcher:explain_match(actual) -- shunt/spec.yue:163
  }) -- shunt/spec.yue:163
end -- shunt/spec.yue:150
_module_0["_expect_that"] = _expect_that -- shunt/spec.yue:163
assert_that = function(actual, matcher) -- shunt/spec.yue:165
  return _assert_that(nil, actual, matcher, nil) -- shunt/spec.yue:166
end -- shunt/spec.yue:165
_module_0["assert_that"] = assert_that -- shunt/spec.yue:166
_assert_that = function(value_label, actual, matcher, location) -- shunt/spec.yue:168
  if not (Test.current_run_failures ~= nil) then -- shunt/spec.yue:169
    error('internal error: assert_that call must be within an `it` call') -- shunt/spec.yue:170
  end -- shunt/spec.yue:169
  if matcher:matches(actual) then -- shunt/spec.yue:172
    return -- shunt/spec.yue:173
  end -- shunt/spec.yue:172
  if location == nil then -- shunt/spec.yue:175
    location = get_caller_location('assert_that') -- shunt/spec.yue:175
  end -- shunt/spec.yue:175
  return Test:fatal({ -- shunt/spec.yue:177
    value_label = value_label, -- shunt/spec.yue:177
    location = location, -- shunt/spec.yue:178
    expected = matcher:describe(), -- shunt/spec.yue:179
    actual_repr = (function() -- shunt/spec.yue:180
      local _exp_0 -- shunt/spec.yue:180
      do -- shunt/spec.yue:180
        local _obj_0 = matcher.actual_repr -- shunt/spec.yue:180
        if _obj_0 ~= nil then -- shunt/spec.yue:180
          _exp_0 = _obj_0(matcher) -- shunt/spec.yue:180
        end -- shunt/spec.yue:180
      end -- shunt/spec.yue:180
      if _exp_0 ~= nil then -- shunt/spec.yue:180
        return _exp_0 -- shunt/spec.yue:180
      else -- shunt/spec.yue:180
        return repr(actual) -- shunt/spec.yue:180
      end -- shunt/spec.yue:180
    end)(), -- shunt/spec.yue:180
    explanation = matcher:explain_match(actual) -- shunt/spec.yue:181
  }) -- shunt/spec.yue:181
end -- shunt/spec.yue:168
_module_0["_assert_that"] = _assert_that -- shunt/spec.yue:181
get_caller_location = function(kind) -- shunt/spec.yue:184
  local currentline, short_src, what -- shunt/spec.yue:185
  do -- shunt/spec.yue:185
    local _obj_0 = debug.getinfo(3, 'Sl') -- shunt/spec.yue:185
    currentline, short_src, what = _obj_0.currentline, _obj_0.short_src, _obj_0.what -- shunt/spec.yue:185
  end -- shunt/spec.yue:185
  if 'C' == what or 'tail' == what then -- shunt/spec.yue:187
    return "last " .. tostring(kind) .. " call (debug info lost)" -- shunt/spec.yue:188
  else -- shunt/spec.yue:190
    return tostring(short_src) .. ":" .. tostring(currentline) -- shunt/spec.yue:190
  end -- shunt/spec.yue:190
end -- shunt/spec.yue:184
do -- shunt/spec.yue:192
  local _class_0 -- shunt/spec.yue:192
  local _base_0 = { -- shunt/spec.yue:192
    matches = function(self, actual) -- shunt/spec.yue:193
      return true -- shunt/spec.yue:194
    end, -- shunt/spec.yue:196
    explain_match = function(self, actual) -- shunt/spec.yue:196
      return "which " .. tostring(self:describe()) -- shunt/spec.yue:197
    end, -- shunt/spec.yue:199
    describe = function(self, is_match) -- shunt/spec.yue:199
      if is_match == nil then -- shunt/spec.yue:199
        is_match = true -- shunt/spec.yue:199
      end -- shunt/spec.yue:199
      return "is anything" -- shunt/spec.yue:200
    end -- shunt/spec.yue:192
  } -- shunt/spec.yue:192
  if _base_0.__index == nil then -- shunt/spec.yue:192
    _base_0.__index = _base_0 -- shunt/spec.yue:192
  end -- shunt/spec.yue:200
  _class_0 = setmetatable({ -- shunt/spec.yue:192
    __init = function() end, -- shunt/spec.yue:192
    __base = _base_0, -- shunt/spec.yue:192
    __name = "Anything" -- shunt/spec.yue:192
  }, { -- shunt/spec.yue:192
    __index = _base_0, -- shunt/spec.yue:192
    __call = function(cls, ...) -- shunt/spec.yue:192
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:192
      cls.__init(_self_0, ...) -- shunt/spec.yue:192
      return _self_0 -- shunt/spec.yue:192
    end -- shunt/spec.yue:192
  }) -- shunt/spec.yue:192
  _base_0.__class = _class_0 -- shunt/spec.yue:192
  Anything = _class_0 -- shunt/spec.yue:192
end -- shunt/spec.yue:200
do -- shunt/spec.yue:202
  local _class_0 -- shunt/spec.yue:202
  local _base_0 = { -- shunt/spec.yue:202
    matches = function(self, actual) -- shunt/spec.yue:203
      return (actual ~= nil) -- shunt/spec.yue:204
    end, -- shunt/spec.yue:206
    explain_match = function(self, actual) -- shunt/spec.yue:206
      return "which " .. tostring(self:describe()) -- shunt/spec.yue:207
    end, -- shunt/spec.yue:209
    describe = function(self, is_match) -- shunt/spec.yue:209
      if is_match == nil then -- shunt/spec.yue:209
        is_match = true -- shunt/spec.yue:209
      end -- shunt/spec.yue:209
      return "is non-nil" -- shunt/spec.yue:210
    end -- shunt/spec.yue:202
  } -- shunt/spec.yue:202
  if _base_0.__index == nil then -- shunt/spec.yue:202
    _base_0.__index = _base_0 -- shunt/spec.yue:202
  end -- shunt/spec.yue:210
  _class_0 = setmetatable({ -- shunt/spec.yue:202
    __init = function() end, -- shunt/spec.yue:202
    __base = _base_0, -- shunt/spec.yue:202
    __name = "Some" -- shunt/spec.yue:202
  }, { -- shunt/spec.yue:202
    __index = _base_0, -- shunt/spec.yue:202
    __call = function(cls, ...) -- shunt/spec.yue:202
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:202
      cls.__init(_self_0, ...) -- shunt/spec.yue:202
      return _self_0 -- shunt/spec.yue:202
    end -- shunt/spec.yue:202
  }) -- shunt/spec.yue:202
  _base_0.__class = _class_0 -- shunt/spec.yue:202
  Some = _class_0 -- shunt/spec.yue:202
end -- shunt/spec.yue:210
do -- shunt/spec.yue:212
  local _class_0 -- shunt/spec.yue:212
  local _base_0 = { -- shunt/spec.yue:212
    matches = function(self, actual) -- shunt/spec.yue:215
      return not self.inner:matches(actual) -- shunt/spec.yue:216
    end, -- shunt/spec.yue:218
    explain_match = function(self, actual) -- shunt/spec.yue:218
      return self.inner:explain_match(actual) -- shunt/spec.yue:219
    end, -- shunt/spec.yue:221
    describe = function(self, is_match) -- shunt/spec.yue:221
      if is_match == nil then -- shunt/spec.yue:221
        is_match = true -- shunt/spec.yue:221
      end -- shunt/spec.yue:221
      return self.inner:describe(not is_match) -- shunt/spec.yue:222
    end -- shunt/spec.yue:212
  } -- shunt/spec.yue:212
  if _base_0.__index == nil then -- shunt/spec.yue:212
    _base_0.__index = _base_0 -- shunt/spec.yue:212
  end -- shunt/spec.yue:222
  _class_0 = setmetatable({ -- shunt/spec.yue:212
    __init = function(self, inner) -- shunt/spec.yue:213
      self.inner = inner -- shunt/spec.yue:213
    end, -- shunt/spec.yue:212
    __base = _base_0, -- shunt/spec.yue:212
    __name = "Not" -- shunt/spec.yue:212
  }, { -- shunt/spec.yue:212
    __index = _base_0, -- shunt/spec.yue:212
    __call = function(cls, ...) -- shunt/spec.yue:212
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:212
      cls.__init(_self_0, ...) -- shunt/spec.yue:212
      return _self_0 -- shunt/spec.yue:212
    end -- shunt/spec.yue:212
  }) -- shunt/spec.yue:212
  _base_0.__class = _class_0 -- shunt/spec.yue:212
  Not = _class_0 -- shunt/spec.yue:212
end -- shunt/spec.yue:222
do -- shunt/spec.yue:224
  local _class_0 -- shunt/spec.yue:224
  local _base_0 = { -- shunt/spec.yue:224
    matches = function(self, actual) -- shunt/spec.yue:227
      return self.expected == actual -- shunt/spec.yue:228
    end, -- shunt/spec.yue:230
    explain_match = function(self, actual) -- shunt/spec.yue:230
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:231
    end, -- shunt/spec.yue:233
    describe = function(self, is_match) -- shunt/spec.yue:233
      if is_match == nil then -- shunt/spec.yue:233
        is_match = true -- shunt/spec.yue:233
      end -- shunt/spec.yue:233
      if is_match then -- shunt/spec.yue:234
        return "is equal to " .. tostring(repr(self.expected)) -- shunt/spec.yue:235
      else -- shunt/spec.yue:237
        return "isn't equal to " .. tostring(repr(self.expected)) -- shunt/spec.yue:237
      end -- shunt/spec.yue:234
    end -- shunt/spec.yue:224
  } -- shunt/spec.yue:224
  if _base_0.__index == nil then -- shunt/spec.yue:224
    _base_0.__index = _base_0 -- shunt/spec.yue:224
  end -- shunt/spec.yue:237
  _class_0 = setmetatable({ -- shunt/spec.yue:224
    __init = function(self, expected) -- shunt/spec.yue:225
      self.expected = expected -- shunt/spec.yue:225
    end, -- shunt/spec.yue:224
    __base = _base_0, -- shunt/spec.yue:224
    __name = "Eq" -- shunt/spec.yue:224
  }, { -- shunt/spec.yue:224
    __index = _base_0, -- shunt/spec.yue:224
    __call = function(cls, ...) -- shunt/spec.yue:224
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:224
      cls.__init(_self_0, ...) -- shunt/spec.yue:224
      return _self_0 -- shunt/spec.yue:224
    end -- shunt/spec.yue:224
  }) -- shunt/spec.yue:224
  _base_0.__class = _class_0 -- shunt/spec.yue:224
  Eq = _class_0 -- shunt/spec.yue:224
end -- shunt/spec.yue:237
do -- shunt/spec.yue:239
  local _class_0 -- shunt/spec.yue:239
  local _base_0 = { -- shunt/spec.yue:239
    matches = function(self, actual) -- shunt/spec.yue:242
      local _exp_0 = self.kind -- shunt/spec.yue:243
      if '==' == _exp_0 then -- shunt/spec.yue:244
        return actual == self.value -- shunt/spec.yue:245
      elseif '<' == _exp_0 then -- shunt/spec.yue:246
        return actual < self.value -- shunt/spec.yue:247
      elseif '<=' == _exp_0 then -- shunt/spec.yue:248
        return actual <= self.value -- shunt/spec.yue:249
      elseif '>' == _exp_0 then -- shunt/spec.yue:250
        return actual > self.value -- shunt/spec.yue:251
      elseif '>=' == _exp_0 then -- shunt/spec.yue:252
        return actual >= self.value -- shunt/spec.yue:253
      else -- shunt/spec.yue:255
        return error("internal error: unrecognised comparison: " .. tostring(repr(self.kind))) -- shunt/spec.yue:255
      end -- shunt/spec.yue:255
    end, -- shunt/spec.yue:257
    explain_match = function(self, actual) -- shunt/spec.yue:257
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:258
    end, -- shunt/spec.yue:260
    describe = function(self, is_match) -- shunt/spec.yue:260
      if is_match == nil then -- shunt/spec.yue:260
        is_match = true -- shunt/spec.yue:260
      end -- shunt/spec.yue:260
      local comparison_name -- shunt/spec.yue:261
      do -- shunt/spec.yue:261
        local _exp_0 = self.kind -- shunt/spec.yue:261
        if '==' == _exp_0 then -- shunt/spec.yue:262
          comparison_name = "equal to" -- shunt/spec.yue:263
        elseif '<' == _exp_0 then -- shunt/spec.yue:264
          comparison_name = "less than" -- shunt/spec.yue:265
        elseif '<=' == _exp_0 then -- shunt/spec.yue:266
          comparison_name = "at most" -- shunt/spec.yue:267
        elseif '>' == _exp_0 then -- shunt/spec.yue:268
          comparison_name = "greater than" -- shunt/spec.yue:269
        elseif '>=' == _exp_0 then -- shunt/spec.yue:270
          comparison_name = "at least" -- shunt/spec.yue:271
        else -- shunt/spec.yue:273
          comparison_name = error("internal error: unrecognised comparison: " .. tostring(repr(self.kind))) -- shunt/spec.yue:273
        end -- shunt/spec.yue:273
      end -- shunt/spec.yue:273
      if is_match then -- shunt/spec.yue:274
        return "is " .. tostring(comparison_name) .. " " .. tostring(repr(self.value)) -- shunt/spec.yue:275
      else -- shunt/spec.yue:277
        return "isn't " .. tostring(comparison_name) .. " " .. tostring(repr(self.value)) -- shunt/spec.yue:277
      end -- shunt/spec.yue:274
    end -- shunt/spec.yue:239
  } -- shunt/spec.yue:239
  if _base_0.__index == nil then -- shunt/spec.yue:239
    _base_0.__index = _base_0 -- shunt/spec.yue:239
  end -- shunt/spec.yue:277
  _class_0 = setmetatable({ -- shunt/spec.yue:239
    __init = function(self, kind, value) -- shunt/spec.yue:240
      self.kind = kind -- shunt/spec.yue:240
      self.value = value -- shunt/spec.yue:240
    end, -- shunt/spec.yue:239
    __base = _base_0, -- shunt/spec.yue:239
    __name = "Compare" -- shunt/spec.yue:239
  }, { -- shunt/spec.yue:239
    __index = _base_0, -- shunt/spec.yue:239
    __call = function(cls, ...) -- shunt/spec.yue:239
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:239
      cls.__init(_self_0, ...) -- shunt/spec.yue:239
      return _self_0 -- shunt/spec.yue:239
    end -- shunt/spec.yue:239
  }) -- shunt/spec.yue:239
  _base_0.__class = _class_0 -- shunt/spec.yue:239
  Compare = _class_0 -- shunt/spec.yue:239
end -- shunt/spec.yue:277
do -- shunt/spec.yue:279
  local _class_0 -- shunt/spec.yue:279
  local _base_0 = { -- shunt/spec.yue:279
    matches = function(self, actual) -- shunt/spec.yue:282
      if 'number' ~= type(actual) then -- shunt/spec.yue:283
        return false -- shunt/spec.yue:284
      end -- shunt/spec.yue:283
      return (math.abs(actual - self.expected)) <= math.abs(self.delta * self.expected) -- shunt/spec.yue:285
    end, -- shunt/spec.yue:287
    explain_match = function(self, actual) -- shunt/spec.yue:287
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:288
    end, -- shunt/spec.yue:290
    describe = function(self, is_match) -- shunt/spec.yue:290
      if is_match == nil then -- shunt/spec.yue:290
        is_match = true -- shunt/spec.yue:290
      end -- shunt/spec.yue:290
      if is_match then -- shunt/spec.yue:291
        return "is near " .. tostring(self.expected) .. " (" .. tostring(self.delta) .. "x)" -- shunt/spec.yue:292
      else -- shunt/spec.yue:294
        return "isn't near " .. tostring(self.expected) .. " (" .. tostring(self.delta) .. "x)" -- shunt/spec.yue:294
      end -- shunt/spec.yue:291
    end -- shunt/spec.yue:279
  } -- shunt/spec.yue:279
  if _base_0.__index == nil then -- shunt/spec.yue:279
    _base_0.__index = _base_0 -- shunt/spec.yue:279
  end -- shunt/spec.yue:294
  _class_0 = setmetatable({ -- shunt/spec.yue:279
    __init = function(self, expected, delta) -- shunt/spec.yue:280
      if delta == nil then -- shunt/spec.yue:280
        delta = 0.00001 -- shunt/spec.yue:280
      end -- shunt/spec.yue:280
      self.expected = expected -- shunt/spec.yue:280
      self.delta = delta -- shunt/spec.yue:280
    end, -- shunt/spec.yue:279
    __base = _base_0, -- shunt/spec.yue:279
    __name = "Near" -- shunt/spec.yue:279
  }, { -- shunt/spec.yue:279
    __index = _base_0, -- shunt/spec.yue:279
    __call = function(cls, ...) -- shunt/spec.yue:279
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:279
      cls.__init(_self_0, ...) -- shunt/spec.yue:279
      return _self_0 -- shunt/spec.yue:279
    end -- shunt/spec.yue:279
  }) -- shunt/spec.yue:279
  _base_0.__class = _class_0 -- shunt/spec.yue:279
  Near = _class_0 -- shunt/spec.yue:279
end -- shunt/spec.yue:294
do -- shunt/spec.yue:296
  local _class_0 -- shunt/spec.yue:296
  local _base_0 = { -- shunt/spec.yue:296
    matches = function(self, actual) -- shunt/spec.yue:299
      return self:deep_equal(self.expected, actual) -- shunt/spec.yue:300
    end, -- shunt/spec.yue:302
    deep_equal = function(self, a, b, a_stack_set, b_stack_set) -- shunt/spec.yue:302
      if a_stack_set == nil then -- shunt/spec.yue:302
        a_stack_set = { } -- shunt/spec.yue:302
      end -- shunt/spec.yue:302
      if b_stack_set == nil then -- shunt/spec.yue:302
        b_stack_set = { } -- shunt/spec.yue:302
      end -- shunt/spec.yue:302
      if a == b then -- shunt/spec.yue:303
        return true -- shunt/spec.yue:304
      end -- shunt/spec.yue:303
      local type_a = type(a) -- shunt/spec.yue:306
      local type_b = type(b) -- shunt/spec.yue:307
      if type_a ~= type_b then -- shunt/spec.yue:308
        return false -- shunt/spec.yue:309
      end -- shunt/spec.yue:308
      if type_a ~= 'table' then -- shunt/spec.yue:311
        return false -- shunt/spec.yue:312
      end -- shunt/spec.yue:311
      for ka, va in pairs(a) do -- shunt/spec.yue:313
        local vb = b[ka] -- shunt/spec.yue:314
        if a_stack_set[va] and b_stack_set[vb] then -- shunt/spec.yue:316
          return true -- shunt/spec.yue:317
        end -- shunt/spec.yue:316
        a_stack_set[va] = true -- shunt/spec.yue:318
        if (vb ~= nil) then -- shunt/spec.yue:319
          b_stack_set[vb] = true -- shunt/spec.yue:320
        end -- shunt/spec.yue:319
        if not self:deep_equal(va, vb, a_stack_set, b_stack_set) then -- shunt/spec.yue:321
          return false -- shunt/spec.yue:322
        end -- shunt/spec.yue:321
        a_stack_set[va] = nil -- shunt/spec.yue:323
        b_stack_set[vb] = nil -- shunt/spec.yue:324
      end -- shunt/spec.yue:324
      for kb, _ in pairs(b) do -- shunt/spec.yue:325
        if not (a[kb] ~= nil) then -- shunt/spec.yue:326
          return false -- shunt/spec.yue:327
        end -- shunt/spec.yue:326
      end -- shunt/spec.yue:327
      return true -- shunt/spec.yue:328
    end, -- shunt/spec.yue:330
    explain_match = function(self, actual) -- shunt/spec.yue:330
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:331
    end, -- shunt/spec.yue:333
    describe = function(self, is_match) -- shunt/spec.yue:333
      if is_match == nil then -- shunt/spec.yue:333
        is_match = true -- shunt/spec.yue:333
      end -- shunt/spec.yue:333
      if is_match then -- shunt/spec.yue:334
        return "is deeply equal to " .. tostring(repr(self.expected)) -- shunt/spec.yue:335
      else -- shunt/spec.yue:337
        return "isn't deeply equal to " .. tostring(repr(self.expected)) -- shunt/spec.yue:337
      end -- shunt/spec.yue:334
    end -- shunt/spec.yue:296
  } -- shunt/spec.yue:296
  if _base_0.__index == nil then -- shunt/spec.yue:296
    _base_0.__index = _base_0 -- shunt/spec.yue:296
  end -- shunt/spec.yue:337
  _class_0 = setmetatable({ -- shunt/spec.yue:296
    __init = function(self, expected) -- shunt/spec.yue:297
      self.expected = expected -- shunt/spec.yue:297
    end, -- shunt/spec.yue:296
    __base = _base_0, -- shunt/spec.yue:296
    __name = "DeepEq" -- shunt/spec.yue:296
  }, { -- shunt/spec.yue:296
    __index = _base_0, -- shunt/spec.yue:296
    __call = function(cls, ...) -- shunt/spec.yue:296
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:296
      cls.__init(_self_0, ...) -- shunt/spec.yue:296
      return _self_0 -- shunt/spec.yue:296
    end -- shunt/spec.yue:296
  }) -- shunt/spec.yue:296
  _base_0.__class = _class_0 -- shunt/spec.yue:296
  DeepEq = _class_0 -- shunt/spec.yue:296
end -- shunt/spec.yue:337
do -- shunt/spec.yue:339
  local _class_0 -- shunt/spec.yue:339
  local _base_0 = { -- shunt/spec.yue:339
    matches = function(self, actual) -- shunt/spec.yue:342
      return self.type == type(actual) -- shunt/spec.yue:343
    end, -- shunt/spec.yue:345
    explain_match = function(self, actual) -- shunt/spec.yue:345
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:346
    end, -- shunt/spec.yue:348
    describe = function(self, is_match) -- shunt/spec.yue:348
      if is_match == nil then -- shunt/spec.yue:348
        is_match = true -- shunt/spec.yue:348
      end -- shunt/spec.yue:348
      if is_match then -- shunt/spec.yue:349
        return "has type " .. tostring(self.type) -- shunt/spec.yue:350
      else -- shunt/spec.yue:352
        return "does not have type " .. tostring(self.type) -- shunt/spec.yue:352
      end -- shunt/spec.yue:349
    end -- shunt/spec.yue:339
  } -- shunt/spec.yue:339
  if _base_0.__index == nil then -- shunt/spec.yue:339
    _base_0.__index = _base_0 -- shunt/spec.yue:339
  end -- shunt/spec.yue:352
  _class_0 = setmetatable({ -- shunt/spec.yue:339
    __init = function(self, type) -- shunt/spec.yue:340
      self.type = type -- shunt/spec.yue:340
    end, -- shunt/spec.yue:339
    __base = _base_0, -- shunt/spec.yue:339
    __name = "Type" -- shunt/spec.yue:339
  }, { -- shunt/spec.yue:339
    __index = _base_0, -- shunt/spec.yue:339
    __call = function(cls, ...) -- shunt/spec.yue:339
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:339
      cls.__init(_self_0, ...) -- shunt/spec.yue:339
      return _self_0 -- shunt/spec.yue:339
    end -- shunt/spec.yue:339
  }) -- shunt/spec.yue:339
  _base_0.__class = _class_0 -- shunt/spec.yue:339
  Type = _class_0 -- shunt/spec.yue:339
end -- shunt/spec.yue:352
do -- shunt/spec.yue:354
  local _class_0 -- shunt/spec.yue:354
  local _base_0 = { -- shunt/spec.yue:354
    matches = function(self, actual) -- shunt/spec.yue:357
      return ('string' == type(actual)) and ((actual:match(self.pat)) ~= nil) -- shunt/spec.yue:359
    end, -- shunt/spec.yue:361
    explain_match = function(self, actual) -- shunt/spec.yue:361
      if 'string' ~= type(actual) then -- shunt/spec.yue:362
        return "which is a " .. tostring(type(actual)) -- shunt/spec.yue:363
      end -- shunt/spec.yue:362
      return "which " .. tostring(self:describe(self:matches(actual))) -- shunt/spec.yue:364
    end, -- shunt/spec.yue:366
    describe = function(self, is_match) -- shunt/spec.yue:366
      if is_match == nil then -- shunt/spec.yue:366
        is_match = true -- shunt/spec.yue:366
      end -- shunt/spec.yue:366
      if is_match then -- shunt/spec.yue:367
        return "matches " .. tostring(repr(self.pat)) -- shunt/spec.yue:368
      else -- shunt/spec.yue:370
        return "doesn't match " .. tostring(repr(self.pat)) -- shunt/spec.yue:370
      end -- shunt/spec.yue:367
    end -- shunt/spec.yue:354
  } -- shunt/spec.yue:354
  if _base_0.__index == nil then -- shunt/spec.yue:354
    _base_0.__index = _base_0 -- shunt/spec.yue:354
  end -- shunt/spec.yue:370
  _class_0 = setmetatable({ -- shunt/spec.yue:354
    __init = function(self, pat) -- shunt/spec.yue:355
      self.pat = pat -- shunt/spec.yue:355
    end, -- shunt/spec.yue:354
    __base = _base_0, -- shunt/spec.yue:354
    __name = "Matches" -- shunt/spec.yue:354
  }, { -- shunt/spec.yue:354
    __index = _base_0, -- shunt/spec.yue:354
    __call = function(cls, ...) -- shunt/spec.yue:354
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:354
      cls.__init(_self_0, ...) -- shunt/spec.yue:354
      return _self_0 -- shunt/spec.yue:354
    end -- shunt/spec.yue:354
  }) -- shunt/spec.yue:354
  _base_0.__class = _class_0 -- shunt/spec.yue:354
  Matches = _class_0 -- shunt/spec.yue:354
end -- shunt/spec.yue:370
do -- shunt/spec.yue:372
  local _class_0 -- shunt/spec.yue:372
  local _base_0 = { -- shunt/spec.yue:372
    matches = function(self, actual) -- shunt/spec.yue:375
      local ty = type(actual) -- shunt/spec.yue:376
      return (ty == 'string' or ty == 'table') and self.inner:matches(#actual) -- shunt/spec.yue:377
    end, -- shunt/spec.yue:379
    explain_match = function(self, actual) -- shunt/spec.yue:379
      local _exp_0 = type(actual) -- shunt/spec.yue:380
      if 'string' == _exp_0 or 'table' == _exp_0 then -- shunt/spec.yue:381
        return "which has length " .. tostring(#actual) .. " " .. tostring(self.inner:explain_match(#actual)) -- shunt/spec.yue:382
      else -- shunt/spec.yue:384
        return "which is a " .. tostring(type(actual)) -- shunt/spec.yue:384
      end -- shunt/spec.yue:384
    end, -- shunt/spec.yue:386
    describe = function(self, is_match) -- shunt/spec.yue:386
      if is_match == nil then -- shunt/spec.yue:386
        is_match = true -- shunt/spec.yue:386
      end -- shunt/spec.yue:386
      if is_match then -- shunt/spec.yue:387
        return "has a length which " .. tostring(self.inner:describe()) -- shunt/spec.yue:388
      else -- shunt/spec.yue:390
        return "doesn't have a length which " .. tostring(self.inner:describe()) -- shunt/spec.yue:390
      end -- shunt/spec.yue:387
    end -- shunt/spec.yue:372
  } -- shunt/spec.yue:372
  if _base_0.__index == nil then -- shunt/spec.yue:372
    _base_0.__index = _base_0 -- shunt/spec.yue:372
  end -- shunt/spec.yue:390
  _class_0 = setmetatable({ -- shunt/spec.yue:372
    __init = function(self, inner) -- shunt/spec.yue:373
      self.inner = inner -- shunt/spec.yue:373
    end, -- shunt/spec.yue:372
    __base = _base_0, -- shunt/spec.yue:372
    __name = "Len" -- shunt/spec.yue:372
  }, { -- shunt/spec.yue:372
    __index = _base_0, -- shunt/spec.yue:372
    __call = function(cls, ...) -- shunt/spec.yue:372
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:372
      cls.__init(_self_0, ...) -- shunt/spec.yue:372
      return _self_0 -- shunt/spec.yue:372
    end -- shunt/spec.yue:372
  }) -- shunt/spec.yue:372
  _base_0.__class = _class_0 -- shunt/spec.yue:372
  Len = _class_0 -- shunt/spec.yue:372
end -- shunt/spec.yue:390
do -- shunt/spec.yue:392
  local _class_0 -- shunt/spec.yue:392
  local _base_0 = { -- shunt/spec.yue:392
    matches = function(self, actual) -- shunt/spec.yue:395
      return self.inner:matches(tostring(actual)) -- shunt/spec.yue:396
    end, -- shunt/spec.yue:398
    explain_match = function(self, actual) -- shunt/spec.yue:398
      local tostring_actual = tostring(actual) -- shunt/spec.yue:399
      return "which tostrings as '" .. tostring(tostring_actual) .. "' " .. tostring(self.inner:explain_match(tostring_actual)) -- shunt/spec.yue:400
    end, -- shunt/spec.yue:402
    describe = function(self, is_match) -- shunt/spec.yue:402
      if is_match == nil then -- shunt/spec.yue:402
        is_match = true -- shunt/spec.yue:402
      end -- shunt/spec.yue:402
      if is_match then -- shunt/spec.yue:403
        return "tostrings as a string which " .. tostring(self.inner:describe(true)) -- shunt/spec.yue:404
      else -- shunt/spec.yue:406
        return "doesn't tostrings as a string which " .. tostring(self.inner:describe(false)) -- shunt/spec.yue:406
      end -- shunt/spec.yue:403
    end -- shunt/spec.yue:392
  } -- shunt/spec.yue:392
  if _base_0.__index == nil then -- shunt/spec.yue:392
    _base_0.__index = _base_0 -- shunt/spec.yue:392
  end -- shunt/spec.yue:406
  _class_0 = setmetatable({ -- shunt/spec.yue:392
    __init = function(self, inner) -- shunt/spec.yue:393
      self.inner = inner -- shunt/spec.yue:393
    end, -- shunt/spec.yue:392
    __base = _base_0, -- shunt/spec.yue:392
    __name = "ToStringsAs" -- shunt/spec.yue:392
  }, { -- shunt/spec.yue:392
    __index = _base_0, -- shunt/spec.yue:392
    __call = function(cls, ...) -- shunt/spec.yue:392
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:392
      cls.__init(_self_0, ...) -- shunt/spec.yue:392
      return _self_0 -- shunt/spec.yue:392
    end -- shunt/spec.yue:392
  }) -- shunt/spec.yue:392
  _base_0.__class = _class_0 -- shunt/spec.yue:392
  ToStringsAs = _class_0 -- shunt/spec.yue:392
end -- shunt/spec.yue:406
do -- shunt/spec.yue:408
  local _class_0 -- shunt/spec.yue:408
  local _base_0 = { -- shunt/spec.yue:408
    actual_repr = function(self) -- shunt/spec.yue:413
      return "-> " .. tostring(self:error_repr()) -- shunt/spec.yue:414
    end, -- shunt/spec.yue:416
    error_repr = function(self) -- shunt/spec.yue:416
      if (self.error ~= nil) then -- shunt/spec.yue:417
        return "error " .. tostring(repr(self.error)) -- shunt/spec.yue:418
      else -- shunt/spec.yue:420
        return "no error" -- shunt/spec.yue:420
      end -- shunt/spec.yue:417
    end, -- shunt/spec.yue:422
    get_err = function(self, fn) -- shunt/spec.yue:422
      if self.error_set then -- shunt/spec.yue:423
        return self.error -- shunt/spec.yue:424
      end -- shunt/spec.yue:423
xpcall(function() -- shunt/spec.yue:426
        return fn() -- shunt/spec.yue:427
      end, function(err) -- shunt/spec.yue:427
        self.error = err -- shunt/spec.yue:429
      end) -- shunt/spec.yue:429
      self.error_set = true -- shunt/spec.yue:430
      return self.error -- shunt/spec.yue:431
    end, -- shunt/spec.yue:433
    matches = function(self, fn) -- shunt/spec.yue:433
      return not ((self:get_err(fn)) ~= nil) -- shunt/spec.yue:434
    end, -- shunt/spec.yue:436
    explain_match = function(self, fn) -- shunt/spec.yue:436
      return "which " .. tostring(self:describe(self:matches(fn))) -- shunt/spec.yue:437
    end, -- shunt/spec.yue:439
    describe = function(self, is_match) -- shunt/spec.yue:439
      if is_match == nil then -- shunt/spec.yue:439
        is_match = true -- shunt/spec.yue:439
      end -- shunt/spec.yue:439
      if is_match then -- shunt/spec.yue:440
        return "doesn't throw an error" -- shunt/spec.yue:441
      else -- shunt/spec.yue:443
        return "throws an error" -- shunt/spec.yue:443
      end -- shunt/spec.yue:440
    end -- shunt/spec.yue:408
  } -- shunt/spec.yue:408
  if _base_0.__index == nil then -- shunt/spec.yue:408
    _base_0.__index = _base_0 -- shunt/spec.yue:408
  end -- shunt/spec.yue:443
  _class_0 = setmetatable({ -- shunt/spec.yue:408
    __init = function(self) -- shunt/spec.yue:409
      self.error_set = false -- shunt/spec.yue:410
      self.error = nil -- shunt/spec.yue:411
    end, -- shunt/spec.yue:408
    __base = _base_0, -- shunt/spec.yue:408
    __name = "NoErrors" -- shunt/spec.yue:408
  }, { -- shunt/spec.yue:408
    __index = _base_0, -- shunt/spec.yue:408
    __call = function(cls, ...) -- shunt/spec.yue:408
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:408
      cls.__init(_self_0, ...) -- shunt/spec.yue:408
      return _self_0 -- shunt/spec.yue:408
    end -- shunt/spec.yue:408
  }) -- shunt/spec.yue:408
  _base_0.__class = _class_0 -- shunt/spec.yue:408
  NoErrors = _class_0 -- shunt/spec.yue:408
end -- shunt/spec.yue:443
do -- shunt/spec.yue:445
  local _class_0 -- shunt/spec.yue:445
  local _base_0 = { -- shunt/spec.yue:445
    actual_repr = function(self) -- shunt/spec.yue:450
      return "-> " .. tostring(self:error_repr()) -- shunt/spec.yue:451
    end, -- shunt/spec.yue:453
    error_repr = function(self) -- shunt/spec.yue:453
      if (self.error ~= nil) then -- shunt/spec.yue:454
        return "error " .. tostring(repr(self.error)) -- shunt/spec.yue:455
      else -- shunt/spec.yue:457
        return "no error" -- shunt/spec.yue:457
      end -- shunt/spec.yue:454
    end, -- shunt/spec.yue:459
    get_err = function(self, fn) -- shunt/spec.yue:459
      if self.error_set then -- shunt/spec.yue:460
        return self.error -- shunt/spec.yue:461
      end -- shunt/spec.yue:460
xpcall(function() -- shunt/spec.yue:463
        return fn() -- shunt/spec.yue:464
      end, function(err) -- shunt/spec.yue:464
        self.error = err -- shunt/spec.yue:466
      end) -- shunt/spec.yue:466
      self.error_set = true -- shunt/spec.yue:467
      return self.error -- shunt/spec.yue:468
    end, -- shunt/spec.yue:470
    matches = function(self, fn) -- shunt/spec.yue:470
      local err = self:get_err(fn) -- shunt/spec.yue:471
      if not (err ~= nil) then -- shunt/spec.yue:472
        return false -- shunt/spec.yue:473
      end -- shunt/spec.yue:472
      return self.inner:matches(err) -- shunt/spec.yue:474
    end, -- shunt/spec.yue:476
    explain_match = function(self, fn) -- shunt/spec.yue:476
      local err = self:get_err(fn) -- shunt/spec.yue:477
      if (err ~= nil) then -- shunt/spec.yue:478
        return "which throws " .. tostring(self:error_repr()) .. " " .. tostring(self.inner:explain_match(err)) -- shunt/spec.yue:479
      else -- shunt/spec.yue:481
        return "which doesn't throw an error" -- shunt/spec.yue:481
      end -- shunt/spec.yue:478
    end, -- shunt/spec.yue:483
    describe = function(self, is_match) -- shunt/spec.yue:483
      if is_match == nil then -- shunt/spec.yue:483
        is_match = true -- shunt/spec.yue:483
      end -- shunt/spec.yue:483
      if is_match then -- shunt/spec.yue:484
        return "throws an error which " .. tostring(self.inner:describe()) -- shunt/spec.yue:485
      else -- shunt/spec.yue:487
        return "doesn't throw an error" -- shunt/spec.yue:487
      end -- shunt/spec.yue:484
    end -- shunt/spec.yue:445
  } -- shunt/spec.yue:445
  if _base_0.__index == nil then -- shunt/spec.yue:445
    _base_0.__index = _base_0 -- shunt/spec.yue:445
  end -- shunt/spec.yue:487
  _class_0 = setmetatable({ -- shunt/spec.yue:445
    __init = function(self, inner) -- shunt/spec.yue:446
      self.inner = inner -- shunt/spec.yue:446
      self.error_set = false -- shunt/spec.yue:447
      self.error = nil -- shunt/spec.yue:448
    end, -- shunt/spec.yue:445
    __base = _base_0, -- shunt/spec.yue:445
    __name = "Errors" -- shunt/spec.yue:445
  }, { -- shunt/spec.yue:445
    __index = _base_0, -- shunt/spec.yue:445
    __call = function(cls, ...) -- shunt/spec.yue:445
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:445
      cls.__init(_self_0, ...) -- shunt/spec.yue:445
      return _self_0 -- shunt/spec.yue:445
    end -- shunt/spec.yue:445
  }) -- shunt/spec.yue:445
  _base_0.__class = _class_0 -- shunt/spec.yue:445
  Errors = _class_0 -- shunt/spec.yue:445
end -- shunt/spec.yue:487
do -- shunt/spec.yue:489
  local _class_0 -- shunt/spec.yue:489
  local _base_0 = { -- shunt/spec.yue:489
    matches = function(self, actual) -- shunt/spec.yue:496
      return (actual ~= nil) and ((self:find_match(actual)) ~= nil) -- shunt/spec.yue:497
    end, -- shunt/spec.yue:499
    find_match = function(self, actual) -- shunt/spec.yue:499
      for key, value in pairs(actual) do -- shunt/spec.yue:500
        local to_check -- shunt/spec.yue:501
        do -- shunt/spec.yue:501
          local _exp_0 = self.kind -- shunt/spec.yue:501
          if 'key' == _exp_0 then -- shunt/spec.yue:502
            to_check = key -- shunt/spec.yue:503
          elseif 'value' == _exp_0 then -- shunt/spec.yue:504
            to_check = value -- shunt/spec.yue:505
          elseif 'key-value' == _exp_0 then -- shunt/spec.yue:506
            to_check = { -- shunt/spec.yue:507
              key = key, -- shunt/spec.yue:507
              value = value -- shunt/spec.yue:507
            } -- shunt/spec.yue:507
          else -- shunt/spec.yue:509
            to_check = error("internal error: unknown kind " .. tostring(repr(self.kind))) -- shunt/spec.yue:509
          end -- shunt/spec.yue:509
        end -- shunt/spec.yue:509
        if self.inner:matches(to_check) then -- shunt/spec.yue:510
          return to_check -- shunt/spec.yue:511
        end -- shunt/spec.yue:510
      end -- shunt/spec.yue:511
      return nil -- shunt/spec.yue:512
    end, -- shunt/spec.yue:514
    explain_match = function(self, actual) -- shunt/spec.yue:514
      if 'table' ~= type(actual) then -- shunt/spec.yue:515
        return "which is a " .. tostring(type(actual)) -- shunt/spec.yue:516
      else -- shunt/spec.yue:517
        do -- shunt/spec.yue:517
          local match = self:find_match(actual) -- shunt/spec.yue:517
          if match then -- shunt/spec.yue:517
            return "which contains " .. tostring(repr(match)) .. " " .. tostring(self.inner:explain_match(match)) -- shunt/spec.yue:518
          else -- shunt/spec.yue:520
            return "which does not contain any " .. tostring(self.pretty_kind) .. " which " .. tostring(self.inner:describe()) -- shunt/spec.yue:520
          end -- shunt/spec.yue:517
        end -- shunt/spec.yue:517
      end -- shunt/spec.yue:515
    end, -- shunt/spec.yue:522
    describe = function(self, is_match) -- shunt/spec.yue:522
      if is_match == nil then -- shunt/spec.yue:522
        is_match = true -- shunt/spec.yue:522
      end -- shunt/spec.yue:522
      if is_match then -- shunt/spec.yue:523
        return "contains a value which " .. tostring(self.inner:describe()) -- shunt/spec.yue:524
      else -- shunt/spec.yue:526
        return "does not contain any " .. tostring(self.pretty_kind) .. " which " .. tostring(self.inner:describe()) -- shunt/spec.yue:526
      end -- shunt/spec.yue:523
    end -- shunt/spec.yue:489
  } -- shunt/spec.yue:489
  if _base_0.__index == nil then -- shunt/spec.yue:489
    _base_0.__index = _base_0 -- shunt/spec.yue:489
  end -- shunt/spec.yue:526
  _class_0 = setmetatable({ -- shunt/spec.yue:489
    __init = function(self, kind, inner) -- shunt/spec.yue:490
      self.kind = kind -- shunt/spec.yue:490
      self.inner = inner -- shunt/spec.yue:490
      if self.kind == 'key-value' then -- shunt/spec.yue:491
        self.pretty_kind = 'key-value pair' -- shunt/spec.yue:492
      else -- shunt/spec.yue:494
        self.pretty_kind = self.kind -- shunt/spec.yue:494
      end -- shunt/spec.yue:491
    end, -- shunt/spec.yue:489
    __base = _base_0, -- shunt/spec.yue:489
    __name = "Contains" -- shunt/spec.yue:489
  }, { -- shunt/spec.yue:489
    __index = _base_0, -- shunt/spec.yue:489
    __call = function(cls, ...) -- shunt/spec.yue:489
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:489
      cls.__init(_self_0, ...) -- shunt/spec.yue:489
      return _self_0 -- shunt/spec.yue:489
    end -- shunt/spec.yue:489
  }) -- shunt/spec.yue:489
  _base_0.__class = _class_0 -- shunt/spec.yue:489
  Contains = _class_0 -- shunt/spec.yue:489
end -- shunt/spec.yue:526
do -- shunt/spec.yue:528
  local _class_0 -- shunt/spec.yue:528
  local _base_0 = { -- shunt/spec.yue:528
    matches = function(self, actual) -- shunt/spec.yue:535
      return (actual ~= nil) and not ((self:find_non_match(actual)) ~= nil) -- shunt/spec.yue:536
    end, -- shunt/spec.yue:538
    find_non_match = function(self, actual) -- shunt/spec.yue:538
      for key, value in pairs(actual) do -- shunt/spec.yue:539
        local to_check -- shunt/spec.yue:540
        do -- shunt/spec.yue:540
          local _exp_0 = self.kind -- shunt/spec.yue:540
          if 'key' == _exp_0 then -- shunt/spec.yue:541
            to_check = key -- shunt/spec.yue:542
          elseif 'value' == _exp_0 then -- shunt/spec.yue:543
            to_check = value -- shunt/spec.yue:544
          elseif 'key-value' == _exp_0 then -- shunt/spec.yue:545
            to_check = { -- shunt/spec.yue:546
              key = key, -- shunt/spec.yue:546
              value = value -- shunt/spec.yue:546
            } -- shunt/spec.yue:546
          else -- shunt/spec.yue:548
            to_check = error("internal error: unknown kind " .. tostring(repr(self.kind))) -- shunt/spec.yue:548
          end -- shunt/spec.yue:548
        end -- shunt/spec.yue:548
        if not self.inner:matches(to_check) then -- shunt/spec.yue:549
          return to_check -- shunt/spec.yue:550
        end -- shunt/spec.yue:549
      end -- shunt/spec.yue:550
      return nil -- shunt/spec.yue:551
    end, -- shunt/spec.yue:553
    explain_match = function(self, actual) -- shunt/spec.yue:553
      if 'table' ~= type(actual) then -- shunt/spec.yue:554
        return "is a " .. tostring(actual) -- shunt/spec.yue:555
      else -- shunt/spec.yue:556
        do -- shunt/spec.yue:556
          local non_match = self:find_non_match(actual) -- shunt/spec.yue:556
          if non_match then -- shunt/spec.yue:556
            return "in which some element " .. tostring(self.inner:describe(false)) -- shunt/spec.yue:557
          else -- shunt/spec.yue:559
            return "in which each element " .. tostring(self.inner:describe(true)) -- shunt/spec.yue:559
          end -- shunt/spec.yue:556
        end -- shunt/spec.yue:556
      end -- shunt/spec.yue:554
    end, -- shunt/spec.yue:561
    describe = function(self, is_match) -- shunt/spec.yue:561
      if is_match == nil then -- shunt/spec.yue:561
        is_match = true -- shunt/spec.yue:561
      end -- shunt/spec.yue:561
      if is_match then -- shunt/spec.yue:562
        return "consists of " .. tostring(self.pretty_kind) .. " which " .. tostring(self.inner:describe()) -- shunt/spec.yue:563
      else -- shunt/spec.yue:565
        return "contains a " .. tostring(self.pretty_kind) .. " which " .. tostring(self.inner:describe()) -- shunt/spec.yue:565
      end -- shunt/spec.yue:562
    end -- shunt/spec.yue:528
  } -- shunt/spec.yue:528
  if _base_0.__index == nil then -- shunt/spec.yue:528
    _base_0.__index = _base_0 -- shunt/spec.yue:528
  end -- shunt/spec.yue:565
  _class_0 = setmetatable({ -- shunt/spec.yue:528
    __init = function(self, kind, inner) -- shunt/spec.yue:529
      self.kind = kind -- shunt/spec.yue:529
      self.inner = inner -- shunt/spec.yue:529
      if self.kind == 'key-value' then -- shunt/spec.yue:530
        self.pretty_kind = 'key-value pair' -- shunt/spec.yue:531
      else -- shunt/spec.yue:533
        self.pretty_kind = self.kind -- shunt/spec.yue:533
      end -- shunt/spec.yue:530
    end, -- shunt/spec.yue:528
    __base = _base_0, -- shunt/spec.yue:528
    __name = "Each" -- shunt/spec.yue:528
  }, { -- shunt/spec.yue:528
    __index = _base_0, -- shunt/spec.yue:528
    __call = function(cls, ...) -- shunt/spec.yue:528
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:528
      cls.__init(_self_0, ...) -- shunt/spec.yue:528
      return _self_0 -- shunt/spec.yue:528
    end -- shunt/spec.yue:528
  }) -- shunt/spec.yue:528
  _base_0.__class = _class_0 -- shunt/spec.yue:528
  Each = _class_0 -- shunt/spec.yue:528
end -- shunt/spec.yue:565
do -- shunt/spec.yue:567
  local _class_0 -- shunt/spec.yue:567
  local _base_0 = { -- shunt/spec.yue:567
    matches = function(self, actual) -- shunt/spec.yue:577
      return (actual ~= nil) and not ((self:find_non_match(actual)) ~= nil) -- shunt/spec.yue:578
    end, -- shunt/spec.yue:580
    find_non_match = function(self, actual) -- shunt/spec.yue:580
      local _list_0 = self.fields -- shunt/spec.yue:581
      for _index_0 = 1, #_list_0 do -- shunt/spec.yue:581
        local _des_0 = _list_0[_index_0] -- shunt/spec.yue:581
        local field, matcher = _des_0.field, _des_0.matcher -- shunt/spec.yue:581
        if not matcher:matches(actual[field]) then -- shunt/spec.yue:582
          return field, matcher -- shunt/spec.yue:583
        end -- shunt/spec.yue:582
      end -- shunt/spec.yue:583
      return nil -- shunt/spec.yue:584
    end, -- shunt/spec.yue:586
    explain_match = function(self, actual) -- shunt/spec.yue:586
      if 'table' ~= type(actual) then -- shunt/spec.yue:587
        return "is a " .. tostring(type(actual)) -- shunt/spec.yue:588
      end -- shunt/spec.yue:587
      local non_match_field, non_match_matcher = self:find_non_match(actual) -- shunt/spec.yue:590
      if not (non_match_field ~= nil) then -- shunt/spec.yue:591
        local field_descriptions -- shunt/spec.yue:592
        do -- shunt/spec.yue:592
          local _accum_0 = { } -- shunt/spec.yue:592
          local _len_0 = 1 -- shunt/spec.yue:592
          local _list_0 = self.fields -- shunt/spec.yue:592
          for _index_0 = 1, #_list_0 do -- shunt/spec.yue:592
            local _des_0 = _list_0[_index_0] -- shunt/spec.yue:592
            local field, matcher = _des_0.field, _des_0.matcher -- shunt/spec.yue:592
            _accum_0[_len_0] = "there is a field '" .. tostring(field) .. "' " .. tostring(matcher:explain_match(actual[field])) -- shunt/spec.yue:592
            _len_0 = _len_0 + 1 -- shunt/spec.yue:592
          end -- shunt/spec.yue:592
          field_descriptions = _accum_0 -- shunt/spec.yue:592
        end -- shunt/spec.yue:592
        return "in which:\n  " .. tostring(table.concat(field_descriptions, '\n  ')) -- shunt/spec.yue:593
      else -- shunt/spec.yue:595
        return "in which field " .. tostring(repr(non_match_field)) .. " " .. tostring(non_match_matcher:explain_match(actual[non_match_field])) -- shunt/spec.yue:595
      end -- shunt/spec.yue:591
    end, -- shunt/spec.yue:597
    describe = function(self, is_match) -- shunt/spec.yue:597
      if is_match == nil then -- shunt/spec.yue:597
        is_match = true -- shunt/spec.yue:597
      end -- shunt/spec.yue:597
      local field_descriptions -- shunt/spec.yue:598
      do -- shunt/spec.yue:598
        local _accum_0 = { } -- shunt/spec.yue:598
        local _len_0 = 1 -- shunt/spec.yue:598
        local _list_0 = self.fields -- shunt/spec.yue:598
        for _index_0 = 1, #_list_0 do -- shunt/spec.yue:598
          local _des_0 = _list_0[_index_0] -- shunt/spec.yue:598
          local field, matcher = _des_0.field, _des_0.matcher -- shunt/spec.yue:598
          _accum_0[_len_0] = "there is a field '" .. tostring(field) .. "' which " .. tostring(matcher:describe()) -- shunt/spec.yue:598
          _len_0 = _len_0 + 1 -- shunt/spec.yue:598
        end -- shunt/spec.yue:598
        field_descriptions = _accum_0 -- shunt/spec.yue:598
      end -- shunt/spec.yue:598
      if is_match then -- shunt/spec.yue:599
        return "is a table in which:\n  " .. tostring(table.concat(field_descriptions, '\n  ')) -- shunt/spec.yue:600
      else -- shunt/spec.yue:602
        return "isn't a table in which:\n  " .. tostring(table.concat(field_descriptions, '\n  ')) -- shunt/spec.yue:602
      end -- shunt/spec.yue:599
    end -- shunt/spec.yue:567
  } -- shunt/spec.yue:567
  if _base_0.__index == nil then -- shunt/spec.yue:567
    _base_0.__index = _base_0 -- shunt/spec.yue:567
  end -- shunt/spec.yue:602
  _class_0 = setmetatable({ -- shunt/spec.yue:567
    __init = function(self, fields) -- shunt/spec.yue:568
      do -- shunt/spec.yue:569
        local _accum_0 = { } -- shunt/spec.yue:569
        local _len_0 = 1 -- shunt/spec.yue:569
        for field, matcher in pairs(fields) do -- shunt/spec.yue:569
          _accum_0[_len_0] = { -- shunt/spec.yue:569
            field = field, -- shunt/spec.yue:569
            matcher = matcher -- shunt/spec.yue:569
          } -- shunt/spec.yue:569
          _len_0 = _len_0 + 1 -- shunt/spec.yue:569
        end -- shunt/spec.yue:569
        self.fields = _accum_0 -- shunt/spec.yue:569
      end -- shunt/spec.yue:569
      return table.sort(self.fields, function(a, b) -- shunt/spec.yue:570
        local taf = type(a.field) -- shunt/spec.yue:571
        local tbf = type(b.field) -- shunt/spec.yue:572
        if taf ~= tbf or taf == 'number' then -- shunt/spec.yue:573
          return false -- shunt/spec.yue:574
        end -- shunt/spec.yue:573
        return a.field < b.field -- shunt/spec.yue:575
      end) -- shunt/spec.yue:575
    end, -- shunt/spec.yue:567
    __base = _base_0, -- shunt/spec.yue:567
    __name = "Fields" -- shunt/spec.yue:567
  }, { -- shunt/spec.yue:567
    __index = _base_0, -- shunt/spec.yue:567
    __call = function(cls, ...) -- shunt/spec.yue:567
      local _self_0 = setmetatable({ }, _base_0) -- shunt/spec.yue:567
      cls.__init(_self_0, ...) -- shunt/spec.yue:567
      return _self_0 -- shunt/spec.yue:567
    end -- shunt/spec.yue:567
  }) -- shunt/spec.yue:567
  _base_0.__class = _class_0 -- shunt/spec.yue:567
  Fields = _class_0 -- shunt/spec.yue:567
end -- shunt/spec.yue:602
do -- shunt/spec.yue:604
  local _with_0 = { } -- shunt/spec.yue:604
  _with_0['('] = true -- shunt/spec.yue:605
  _with_0[')'] = true -- shunt/spec.yue:606
  _with_0['['] = true -- shunt/spec.yue:607
  _with_0[']'] = true -- shunt/spec.yue:608
  _with_0['{'] = true -- shunt/spec.yue:609
  _with_0['}'] = true -- shunt/spec.yue:610
  _with_0['!'] = true -- shunt/spec.yue:611
  _with_0['"'] = true -- shunt/spec.yue:612
  _with_0["'"] = true -- shunt/spec.yue:613
  _with_0['$'] = true -- shunt/spec.yue:614
  _with_0['%'] = true -- shunt/spec.yue:615
  _with_0['^'] = true -- shunt/spec.yue:616
  _with_0['&'] = true -- shunt/spec.yue:617
  _with_0['*'] = true -- shunt/spec.yue:618
  _with_0['-'] = true -- shunt/spec.yue:619
  _with_0['_'] = true -- shunt/spec.yue:620
  _with_0['+'] = true -- shunt/spec.yue:621
  _with_0['='] = true -- shunt/spec.yue:622
  _with_0[':'] = true -- shunt/spec.yue:623
  _with_0[' '] = true -- shunt/spec.yue:624
  _with_0['\t'] = true -- shunt/spec.yue:625
  _with_0['.'] = true -- shunt/spec.yue:626
  _with_0[','] = true -- shunt/spec.yue:627
  _with_0['/'] = true -- shunt/spec.yue:628
  _with_0['\\'] = true -- shunt/spec.yue:629
  _with_0['>'] = true -- shunt/spec.yue:630
  _with_0['<'] = true -- shunt/spec.yue:631
  _with_0['!'] = true -- shunt/spec.yue:632
  _with_0['?'] = true -- shunt/spec.yue:633
  _with_0['#'] = true -- shunt/spec.yue:634
  _with_0['|'] = true -- shunt/spec.yue:635
  _with_0['~'] = true -- shunt/spec.yue:636
  local a = string.byte('a') -- shunt/spec.yue:637
  for i = 0, 25 do -- shunt/spec.yue:638
    _with_0[string.char(a + i)] = true -- shunt/spec.yue:639
  end -- shunt/spec.yue:639
  local A = string.byte('A') -- shunt/spec.yue:640
  for i = 0, 25 do -- shunt/spec.yue:641
    _with_0[string.char(A + i)] = true -- shunt/spec.yue:642
  end -- shunt/spec.yue:642
  local zero = string.byte('0') -- shunt/spec.yue:643
  for i = 0, 9 do -- shunt/spec.yue:644
    _with_0[string.char(zero + i)] = true -- shunt/spec.yue:645
  end -- shunt/spec.yue:645
  visible_chars = _with_0 -- shunt/spec.yue:604
end -- shunt/spec.yue:604
repr = function(self) -- shunt/spec.yue:646
  return table.concat((function() -- shunt/spec.yue:647
    local _with_0 = { } -- shunt/spec.yue:647
    local stack = { } -- shunt/spec.yue:648
    local repr_impl -- shunt/spec.yue:649
    repr_impl = function(self) -- shunt/spec.yue:649
      for _index_0 = 1, #stack do -- shunt/spec.yue:650
        local elem = stack[_index_0] -- shunt/spec.yue:650
        if rawequal(self, elem) then -- shunt/spec.yue:651
          _with_0[#_with_0 + 1] = '...' -- shunt/spec.yue:652
          return -- shunt/spec.yue:653
        end -- shunt/spec.yue:651
      end -- shunt/spec.yue:653
      stack[#stack + 1] = self -- shunt/spec.yue:654
      do -- shunt/spec.yue:656
        local _exp_0 = type(self) -- shunt/spec.yue:656
        if 'string' == _exp_0 then -- shunt/spec.yue:657
          _with_0[#_with_0 + 1] = "'" -- shunt/spec.yue:658
          for i = 1, #self do -- shunt/spec.yue:659
            local c = self:sub(i, i) -- shunt/spec.yue:660
            if visible_chars[c] then -- shunt/spec.yue:661
              _with_0[#_with_0 + 1] = c -- shunt/spec.yue:662
            else -- shunt/spec.yue:664
              _with_0[#_with_0 + 1] = ("\\x%02x"):format(string.byte(self, i)) -- shunt/spec.yue:664
            end -- shunt/spec.yue:661
          end -- shunt/spec.yue:664
          _with_0[#_with_0 + 1] = "'" -- shunt/spec.yue:665
        elseif 'table' == _exp_0 then -- shunt/spec.yue:666
          if (getmetatable(self) ~= nil) and (getmetatable(self).__tostring ~= nil) then -- shunt/spec.yue:667
            _with_0[#_with_0 + 1] = tostring(self) -- shunt/spec.yue:668
          else -- shunt/spec.yue:669
            if is_list(self) then -- shunt/spec.yue:669
              _with_0[#_with_0 + 1] = '[' -- shunt/spec.yue:670
              local first = true -- shunt/spec.yue:671
              for _index_0 = 1, #self do -- shunt/spec.yue:672
                local elem = self[_index_0] -- shunt/spec.yue:672
                if not first then -- shunt/spec.yue:673
                  _with_0[#_with_0 + 1] = ', ' -- shunt/spec.yue:674
                end -- shunt/spec.yue:673
                first = false -- shunt/spec.yue:675
                repr_impl(elem) -- shunt/spec.yue:677
              end -- shunt/spec.yue:677
              _with_0[#_with_0 + 1] = ']' -- shunt/spec.yue:678
            else -- shunt/spec.yue:680
              _with_0[#_with_0 + 1] = '{' -- shunt/spec.yue:680
              local first = true -- shunt/spec.yue:681
              local keys -- shunt/spec.yue:682
              do -- shunt/spec.yue:682
                local _accum_0 = { } -- shunt/spec.yue:682
                local _len_0 = 1 -- shunt/spec.yue:682
                for key, _ in pairs(self) do -- shunt/spec.yue:682
                  _accum_0[_len_0] = key -- shunt/spec.yue:682
                  _len_0 = _len_0 + 1 -- shunt/spec.yue:682
                end -- shunt/spec.yue:682
                keys = _accum_0 -- shunt/spec.yue:682
              end -- shunt/spec.yue:682
              if can_sort(keys) then -- shunt/spec.yue:683
                table.sort(keys, function(a, b) -- shunt/spec.yue:684
                  local ta = type(a) -- shunt/spec.yue:685
                  local tb = type(b) -- shunt/spec.yue:686
                  if ta ~= tb or ta == 'number' then -- shunt/spec.yue:687
                    return false -- shunt/spec.yue:688
                  end -- shunt/spec.yue:687
                  return a < b -- shunt/spec.yue:689
                end) -- shunt/spec.yue:684
              end -- shunt/spec.yue:683
              for _index_0 = 1, #keys do -- shunt/spec.yue:690
                local key = keys[_index_0] -- shunt/spec.yue:690
                local value = self[key] -- shunt/spec.yue:691
                if not first then -- shunt/spec.yue:692
                  _with_0[#_with_0 + 1] = ', ' -- shunt/spec.yue:693
                end -- shunt/spec.yue:692
                first = false -- shunt/spec.yue:694
                repr_impl(key) -- shunt/spec.yue:696
                _with_0[#_with_0 + 1] = ': ' -- shunt/spec.yue:697
                repr_impl(value) -- shunt/spec.yue:698
              end -- shunt/spec.yue:698
              _with_0[#_with_0 + 1] = '}' -- shunt/spec.yue:699
            end -- shunt/spec.yue:669
          end -- shunt/spec.yue:667
        else -- shunt/spec.yue:701
          _with_0[#_with_0 + 1] = tostring(self) -- shunt/spec.yue:701
        end -- shunt/spec.yue:701
      end -- shunt/spec.yue:701
      stack[#stack] = nil -- shunt/spec.yue:703
    end -- shunt/spec.yue:649
    repr_impl(self) -- shunt/spec.yue:704
    return _with_0 -- shunt/spec.yue:647
  end)()) -- shunt/spec.yue:704
end -- shunt/spec.yue:646
_module_0["repr"] = repr -- shunt/spec.yue:704
is_list = function(table) -- shunt/spec.yue:706
  local max_key = 0 -- shunt/spec.yue:707
  local num_keys = 0 -- shunt/spec.yue:708
  for k, _ in pairs(table) do -- shunt/spec.yue:709
    num_keys = num_keys + 1 -- shunt/spec.yue:710
    if 'number' ~= type(k) then -- shunt/spec.yue:711
      return false -- shunt/spec.yue:712
    end -- shunt/spec.yue:711
    if max_key < k then -- shunt/spec.yue:713
      max_key = k -- shunt/spec.yue:714
    end -- shunt/spec.yue:713
  end -- shunt/spec.yue:714
  return max_key == num_keys and num_keys > 0 -- shunt/spec.yue:715
end -- shunt/spec.yue:706
can_sort = function(list) -- shunt/spec.yue:717
  for _index_0 = 1, #list do -- shunt/spec.yue:718
    local elem = list[_index_0] -- shunt/spec.yue:718
    local _continue_0 = false -- shunt/spec.yue:719
    repeat -- shunt/spec.yue:719
      do -- shunt/spec.yue:719
        local _exp_0 = type(elem) -- shunt/spec.yue:719
        if 'boolean' == _exp_0 or 'string' == _exp_0 or 'number' == _exp_0 then -- shunt/spec.yue:720
          _continue_0 = true -- shunt/spec.yue:721
          break -- shunt/spec.yue:721
        elseif 'table' == _exp_0 then -- shunt/spec.yue:722
          if not (getmetatable(table) ~= nil) or not (getmetatable(table).__lt ~= nil) then -- shunt/spec.yue:723
            return false -- shunt/spec.yue:724
          end -- shunt/spec.yue:723
        else -- shunt/spec.yue:726
          return false -- shunt/spec.yue:726
        end -- shunt/spec.yue:726
      end -- shunt/spec.yue:726
      _continue_0 = true -- shunt/spec.yue:719
    until true -- shunt/spec.yue:726
    if not _continue_0 then -- shunt/spec.yue:726
      break -- shunt/spec.yue:726
    end -- shunt/spec.yue:726
  end -- shunt/spec.yue:726
  return true -- shunt/spec.yue:727
end -- shunt/spec.yue:717
clone = function(value) -- shunt/spec.yue:729
  local _exp_0 = type(value) -- shunt/spec.yue:730
  if 'nil' == _exp_0 or 'boolean' == _exp_0 or 'number' == _exp_0 or 'string' == _exp_0 then -- shunt/spec.yue:731
    return value -- shunt/spec.yue:732
  elseif 'table' == _exp_0 then -- shunt/spec.yue:733
    local _with_0 = { } -- shunt/spec.yue:734
    for k, v in pairs(value) do -- shunt/spec.yue:735
      _with_0[clone(k)] = clone(v) -- shunt/spec.yue:736
    end -- shunt/spec.yue:736
    return _with_0 -- shunt/spec.yue:734
  else -- shunt/spec.yue:738
    return error("cannot clone a " .. tostring(type(value)) .. " (" .. tostring(value) .. ")") -- shunt/spec.yue:738
  end -- shunt/spec.yue:738
end -- shunt/spec.yue:729
_module_0["clone"] = clone -- shunt/spec.yue:738
matchers = { -- shunt/spec.yue:741
  anything = function() -- shunt/spec.yue:741
    return Anything() -- shunt/spec.yue:741
  end, -- shunt/spec.yue:741
  some = function() -- shunt/spec.yue:742
    return Some() -- shunt/spec.yue:742
  end, -- shunt/spec.yue:742
  not_ = function(matcher) -- shunt/spec.yue:743
    return Not(matcher) -- shunt/spec.yue:743
  end, -- shunt/spec.yue:743
  eq = function(value) -- shunt/spec.yue:744
    return Compare('==', value) -- shunt/spec.yue:744
  end, -- shunt/spec.yue:744
  deep_eq = function(value) -- shunt/spec.yue:745
    return DeepEq(value) -- shunt/spec.yue:745
  end, -- shunt/spec.yue:745
  lt = function(value) -- shunt/spec.yue:746
    return Compare('<', value) -- shunt/spec.yue:746
  end, -- shunt/spec.yue:746
  le = function(value) -- shunt/spec.yue:747
    return Compare('<=', value) -- shunt/spec.yue:747
  end, -- shunt/spec.yue:747
  gt = function(value) -- shunt/spec.yue:748
    return Compare('>', value) -- shunt/spec.yue:748
  end, -- shunt/spec.yue:748
  ge = function(value) -- shunt/spec.yue:749
    return Compare('>=', value) -- shunt/spec.yue:749
  end, -- shunt/spec.yue:749
  len = function(matcher) -- shunt/spec.yue:750
    return Len(matcher) -- shunt/spec.yue:750
  end, -- shunt/spec.yue:750
  matches = function(pattern) -- shunt/spec.yue:751
    return Matches(pattern) -- shunt/spec.yue:751
  end, -- shunt/spec.yue:751
  near = function(value, delta) -- shunt/spec.yue:752
    return Near(value, delta) -- shunt/spec.yue:752
  end, -- shunt/spec.yue:752
  tostrings_as = function(matcher) -- shunt/spec.yue:753
    return ToStringsAs(matcher) -- shunt/spec.yue:753
  end, -- shunt/spec.yue:753
  contains_key = function(matcher) -- shunt/spec.yue:754
    return Contains('key', matcher) -- shunt/spec.yue:754
  end, -- shunt/spec.yue:754
  contains_value = function(matcher) -- shunt/spec.yue:755
    return Contains('value', matcher) -- shunt/spec.yue:755
  end, -- shunt/spec.yue:755
  contains_pair = function(matcher) -- shunt/spec.yue:756
    return Contains('key-value', matcher) -- shunt/spec.yue:756
  end, -- shunt/spec.yue:756
  each_key = function(matcher) -- shunt/spec.yue:757
    return Each('key', matcher) -- shunt/spec.yue:757
  end, -- shunt/spec.yue:757
  each_value = function(matcher) -- shunt/spec.yue:758
    return Each('value', matcher) -- shunt/spec.yue:758
  end, -- shunt/spec.yue:758
  each_pair = function(matcher) -- shunt/spec.yue:759
    return Each('key-value', matcher) -- shunt/spec.yue:759
  end, -- shunt/spec.yue:759
  no_errors = function() -- shunt/spec.yue:760
    return NoErrors() -- shunt/spec.yue:760
  end, -- shunt/spec.yue:760
  errors = function(matcher) -- shunt/spec.yue:761
    return Errors(matcher) -- shunt/spec.yue:761
  end, -- shunt/spec.yue:761
  has_type = function(typ) -- shunt/spec.yue:762
    return Type(typ) -- shunt/spec.yue:762
  end, -- shunt/spec.yue:762
  has_fields = function(fields) -- shunt/spec.yue:763
    return Fields(fields) -- shunt/spec.yue:763
  end -- shunt/spec.yue:763
} -- shunt/spec.yue:740
_module_0["matchers"] = matchers -- shunt/spec.yue:763
reflow = function(prefix, string, width) -- shunt/spec.yue:765
  if width == nil then -- shunt/spec.yue:765
    width = 80 -- shunt/spec.yue:765
  end -- shunt/spec.yue:765
  local lines -- shunt/spec.yue:766
  do -- shunt/spec.yue:766
    local _with_0 = { } -- shunt/spec.yue:766
    local chunk_len = width - #prefix -- shunt/spec.yue:767
    local first_line = true -- shunt/spec.yue:768
    for line in string:gmatch('[^\r\n]*') do -- shunt/spec.yue:769
      for i = 1, #line, chunk_len do -- shunt/spec.yue:770
        local chunk = line:sub(i, i + chunk_len - 1) -- shunt/spec.yue:771
        if first_line then -- shunt/spec.yue:772
          _with_0[#_with_0 + 1] = chunk -- shunt/spec.yue:773
        else -- shunt/spec.yue:775
          _with_0[#_with_0 + 1] = prefix .. chunk -- shunt/spec.yue:775
        end -- shunt/spec.yue:772
        first_line = false -- shunt/spec.yue:776
      end -- shunt/spec.yue:776
    end -- shunt/spec.yue:776
    lines = _with_0 -- shunt/spec.yue:766
  end -- shunt/spec.yue:766
  return table.concat(lines, '\n') -- shunt/spec.yue:777
end -- shunt/spec.yue:765
testing = false -- shunt/spec.yue:779
running_tests = function() -- shunt/spec.yue:780
  return testing -- shunt/spec.yue:780
end -- shunt/spec.yue:780
_module_0["running_tests"] = running_tests -- shunt/spec.yue:780
run_tests = function(filter) -- shunt/spec.yue:782
  if not (spec_fns ~= nil) then -- shunt/spec.yue:784
    return -- shunt/spec.yue:785
  end -- shunt/spec.yue:784
  for _index_0 = 1, #spec_fns do -- shunt/spec.yue:786
    local spec_fn = spec_fns[_index_0] -- shunt/spec.yue:786
    spec_fn() -- shunt/spec.yue:787
  end -- shunt/spec.yue:787
  testing = true -- shunt/spec.yue:789
  if root_spec ~= nil then -- shunt/spec.yue:790
    root_spec:test(filter) -- shunt/spec.yue:790
  end -- shunt/spec.yue:790
  testing = false -- shunt/spec.yue:791
  log(function() -- shunt/spec.yue:793
    return tostring(Test.num_run) .. " checks run" -- shunt/spec.yue:794
  end) -- shunt/spec.yue:793
  local ok = Test.num_failures == 0 -- shunt/spec.yue:795
  if not ok then -- shunt/spec.yue:796
    print(tostring(Test.num_failures) .. " checks failed!") -- shunt/spec.yue:797
  end -- shunt/spec.yue:796
  return ok -- shunt/spec.yue:798
end -- shunt/spec.yue:782
_module_0["run_tests"] = run_tests -- shunt/spec.yue:798
return _module_0 -- shunt/spec.yue:798
end
package.preload['shunt.args'] = function(...)
-- [yue]: shunt/args.yue
local _module_0 = { } -- shunt/args.yue:1
local ArgParser, Flag, Param, Subcommand -- shunt/args.yue:0
do -- shunt/args.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/args.yue:0
  ArgParser, Flag, Param, Subcommand = _obj_0.ArgParser, _obj_0.Flag, _obj_0.Param, _obj_0.Subcommand -- shunt/args.yue:0
end -- shunt/args.yue:0
local VERSION = require('shunt.version').VERSION -- shunt/args.yue:0
local Args -- shunt/args.yue:6
do -- shunt/args.yue:6
  local _class_0 -- shunt/args.yue:6
  local _base_0 = { } -- shunt/args.yue:6
  if _base_0.__index == nil then -- shunt/args.yue:6
    _base_0.__index = _base_0 -- shunt/args.yue:6
  end -- shunt/args.yue:55
  _class_0 = setmetatable({ -- shunt/args.yue:6
    __init = function() end, -- shunt/args.yue:6
    __base = _base_0, -- shunt/args.yue:6
    __name = "Args" -- shunt/args.yue:6
  }, { -- shunt/args.yue:6
    __index = _base_0, -- shunt/args.yue:6
    __call = function(cls, ...) -- shunt/args.yue:6
      local _self_0 = setmetatable({ }, _base_0) -- shunt/args.yue:6
      cls.__init(_self_0, ...) -- shunt/args.yue:6
      return _self_0 -- shunt/args.yue:6
    end -- shunt/args.yue:6
  }) -- shunt/args.yue:6
  _base_0.__class = _class_0 -- shunt/args.yue:6
  local self = _class_0; -- shunt/args.yue:6
  self.parse = function(self, args) -- shunt/args.yue:7
    local arg_parser = self:_arg_parser() -- shunt/args.yue:8
    return arg_parser:parse(args) -- shunt/args.yue:9
  end -- shunt/args.yue:7
  self._arg_parser = function(self) -- shunt/args.yue:11
    local _with_0 = ArgParser('shunt') -- shunt/args.yue:12
    _with_0:version(VERSION) -- shunt/args.yue:13
    _with_0:description('an automatic cargo router') -- shunt/args.yue:14
    _with_0:add((function() -- shunt/args.yue:15
      local _with_1 = Flag('terse') -- shunt/args.yue:15
      _with_1:short(nil) -- shunt/args.yue:16
      _with_1:description('log tersely') -- shunt/args.yue:17
      _with_1:global() -- shunt/args.yue:18
      return _with_1 -- shunt/args.yue:15
    end)()) -- shunt/args.yue:15
    if not (pocket ~= nil) then -- shunt/args.yue:19
      _with_0:add((function() -- shunt/args.yue:20
        local _with_1 = Flag('ignore-monitor') -- shunt/args.yue:20
        _with_1:description('log output on this computer') -- shunt/args.yue:21
        _with_1:short(nil) -- shunt/args.yue:22
        _with_1:global() -- shunt/args.yue:23
        return _with_1 -- shunt/args.yue:20
      end)()) -- shunt/args.yue:20
    end -- shunt/args.yue:19
    _with_0:add((function() -- shunt/args.yue:24
      local _with_1 = Flag('instrument') -- shunt/args.yue:24
      _with_1:description('gather performance data when executing') -- shunt/args.yue:25
      _with_1:short(nil) -- shunt/args.yue:26
      _with_1:global() -- shunt/args.yue:27
      _with_1:hidden() -- shunt/args.yue:28
      return _with_1 -- shunt/args.yue:24
    end)()) -- shunt/args.yue:24
    _with_0:add((function() -- shunt/args.yue:29
      local _with_1 = Flag('force-error-on-bad-exit') -- shunt/args.yue:29
      _with_1:hidden() -- shunt/args.yue:30
      _with_1:short(nil) -- shunt/args.yue:31
      _with_1:global() -- shunt/args.yue:32
      return _with_1 -- shunt/args.yue:29
    end)()) -- shunt/args.yue:29
    _with_0:add((function() -- shunt/args.yue:33
      local _with_1 = Subcommand('test') -- shunt/args.yue:33
      _with_1:description('test the program and exit') -- shunt/args.yue:34
      _with_1:add((function() -- shunt/args.yue:35
        local _with_2 = Flag('no-minecraft') -- shunt/args.yue:35
        _with_2:description('skip in-world tests') -- shunt/args.yue:36
        _with_2:short(nil) -- shunt/args.yue:37
        return _with_2 -- shunt/args.yue:35
      end)()) -- shunt/args.yue:35
      _with_1:add((function() -- shunt/args.yue:38
        local _with_2 = Flag('run-ugly-tests') -- shunt/args.yue:38
        _with_2:description('tests with deliberate unsuppressible errors') -- shunt/args.yue:39
        _with_2:short(nil) -- shunt/args.yue:40
        return _with_2 -- shunt/args.yue:38
      end)()) -- shunt/args.yue:38
      _with_1:add((function() -- shunt/args.yue:41
        local _with_2 = Flag('verbose') -- shunt/args.yue:41
        _with_2:description('log tersely') -- shunt/args.yue:42
        return _with_2 -- shunt/args.yue:41
      end)()) -- shunt/args.yue:41
      _with_1:add((function() -- shunt/args.yue:43
        local _with_2 = Param('filter') -- shunt/args.yue:43
        _with_2:description('run only tests matching this pattern') -- shunt/args.yue:44
        _with_2:default(nil) -- shunt/args.yue:45
        return _with_2 -- shunt/args.yue:43
      end)()) -- shunt/args.yue:43
      return _with_1 -- shunt/args.yue:33
    end)()) -- shunt/args.yue:33
    _with_0:add((require('shunt.cmd.clean')).subcommand) -- shunt/args.yue:46
    _with_0:add((require('shunt.cmd.debug')).subcommand) -- shunt/args.yue:47
    _with_0:add((require('shunt.cmd.declare')).subcommand) -- shunt/args.yue:48
    _with_0:add((require('shunt.cmd.disable')).subcommand) -- shunt/args.yue:49
    _with_0:add((require('shunt.cmd.edit')).subcommand) -- shunt/args.yue:50
    _with_0:add((require('shunt.cmd.enable')).subcommand) -- shunt/args.yue:51
    _with_0:add((require('shunt.cmd.flash')).subcommand) -- shunt/args.yue:52
    _with_0:add((require('shunt.cmd.init')).subcommand) -- shunt/args.yue:53
    _with_0:add((require('shunt.cmd.start')).subcommand) -- shunt/args.yue:54
    _with_0:add((require('shunt.cmd.upgrade')).subcommand) -- shunt/args.yue:55
    return _with_0 -- shunt/args.yue:12
  end -- shunt/args.yue:11
  Args = _class_0 -- shunt/args.yue:6
end -- shunt/args.yue:55
_module_0["Args"] = Args -- shunt/args.yue:6
return _module_0 -- shunt/args.yue:55
end
package.preload['shunt.clap'] = function(...)
-- [yue]: shunt/clap.yue
local _module_0 = { } -- shunt/clap.yue:1
local EXIT, SELF -- shunt/clap.yue:1
local Flag -- shunt/clap.yue:2
local Param -- shunt/clap.yue:3
local Subcommand -- shunt/clap.yue:4
local unpack -- shunt/clap.yue:6
if unpack == nil then -- shunt/clap.yue:6
  do -- shunt/clap.yue:6
    local _exp_0 = table.unpack -- shunt/clap.yue:6
    if _exp_0 ~= nil then -- shunt/clap.yue:6
      unpack = _exp_0 -- shunt/clap.yue:6
    else -- shunt/clap.yue:6
      unpack = function(tab) -- shunt/clap.yue:6
        local e1, e2, e3, e4, e5, e6, e7, e8, e9, e10, _limit = tab[1], tab[2], tab[3], tab[4], tab[5], tab[6], tab[7], tab[8], tab[9], tab[10], tab[11] -- shunt/clap.yue:8
        do -- shunt/clap.yue:9
          local _exp_1 = #tab -- shunt/clap.yue:9
          if 0 == _exp_1 then -- shunt/clap.yue:10
            return -- shunt/clap.yue:11
          elseif 1 == _exp_1 then -- shunt/clap.yue:12
            return e1 -- shunt/clap.yue:13
          elseif 2 == _exp_1 then -- shunt/clap.yue:14
            return e1, e2 -- shunt/clap.yue:15
          elseif 3 == _exp_1 then -- shunt/clap.yue:16
            return e1, e2, e3 -- shunt/clap.yue:17
          elseif 4 == _exp_1 then -- shunt/clap.yue:18
            return e1, e2, e3, e4 -- shunt/clap.yue:19
          elseif 5 == _exp_1 then -- shunt/clap.yue:20
            return e1, e2, e3, e4, e5 -- shunt/clap.yue:21
          elseif 6 == _exp_1 then -- shunt/clap.yue:22
            return e1, e2, e3, e4, e5, e6 -- shunt/clap.yue:23
          elseif 7 == _exp_1 then -- shunt/clap.yue:24
            return e1, e2, e3, e4, e5, e6, e7 -- shunt/clap.yue:25
          elseif 8 == _exp_1 then -- shunt/clap.yue:26
            return e1, e2, e3, e4, e5, e6, e7, e8 -- shunt/clap.yue:27
          elseif 9 == _exp_1 then -- shunt/clap.yue:28
            return e1, e2, e3, e4, e5, e6, e7, e8, e9 -- shunt/clap.yue:29
          elseif 10 == _exp_1 then -- shunt/clap.yue:30
            return e1, e2, e3, e4, e5, e6, e7, e8, e9, e10 -- shunt/clap.yue:31
          end -- shunt/clap.yue:31
        end -- shunt/clap.yue:31
        return error('cannot unpack table: too many values to unpack') -- shunt/clap.yue:32
      end -- shunt/clap.yue:6
    end -- shunt/clap.yue:32
  end -- shunt/clap.yue:32
end -- shunt/clap.yue:32
EXIT = setmetatable({ }, { -- shunt/clap.yue:34
  __tostring = function(self) -- shunt/clap.yue:34
    return "<exit>" -- shunt/clap.yue:34
  end -- shunt/clap.yue:34
}) -- shunt/clap.yue:34
SELF = setmetatable({ }, { -- shunt/clap.yue:35
  __tostring = function(self) -- shunt/clap.yue:35
    return '<self>' -- shunt/clap.yue:35
  end -- shunt/clap.yue:35
}) -- shunt/clap.yue:35
do -- shunt/clap.yue:37
  local _class_0 -- shunt/clap.yue:37
  local _base_0 = { -- shunt/clap.yue:37
    dest = function(self, _dest) -- shunt/clap.yue:55
      self._dest = _dest -- shunt/clap.yue:55
      return self -- shunt/clap.yue:55
    end, -- shunt/clap.yue:56
    short = function(self, _short) -- shunt/clap.yue:56
      self._short = _short -- shunt/clap.yue:56
      return self -- shunt/clap.yue:56
    end, -- shunt/clap.yue:57
    long = function(self, _long) -- shunt/clap.yue:57
      self._long = _long -- shunt/clap.yue:57
      return self -- shunt/clap.yue:57
    end, -- shunt/clap.yue:58
    hidden = function(self) -- shunt/clap.yue:58
      self._hidden = true -- shunt/clap.yue:59
      return self -- shunt/clap.yue:60
    end, -- shunt/clap.yue:61
    required = function(self) -- shunt/clap.yue:61
      self._required = true -- shunt/clap.yue:62
      return self -- shunt/clap.yue:63
    end, -- shunt/clap.yue:64
    global = function(self) -- shunt/clap.yue:64
      self._global = true -- shunt/clap.yue:65
    end, -- shunt/clap.yue:66
    description = function(self, _description) -- shunt/clap.yue:66
      self._description = _description -- shunt/clap.yue:66
      return self -- shunt/clap.yue:66
    end, -- shunt/clap.yue:67
    options = function(self, _options) -- shunt/clap.yue:67
      self._options = _options -- shunt/clap.yue:67
      return self -- shunt/clap.yue:67
    end, -- shunt/clap.yue:68
    transform = function(self, _transform) -- shunt/clap.yue:68
      self._transform = _transform -- shunt/clap.yue:68
      return self -- shunt/clap.yue:68
    end, -- shunt/clap.yue:70
    takes_param = function(self) -- shunt/clap.yue:70
      self._takes_param = true -- shunt/clap.yue:71
      return self -- shunt/clap.yue:72
    end, -- shunt/clap.yue:73
    default = function(self, _default) -- shunt/clap.yue:73
      self._default = _default -- shunt/clap.yue:73
      if 'boolean' == type(self._default) then -- shunt/clap.yue:74
        error('boolean default flag arguments not currently supported') -- shunt/clap.yue:75
      end -- shunt/clap.yue:74
      self:takes_param() -- shunt/clap.yue:76
      return self -- shunt/clap.yue:77
    end, -- shunt/clap.yue:79
    value_name = function(self, _value_name) -- shunt/clap.yue:79
      self._value_name = _value_name -- shunt/clap.yue:79
      return self -- shunt/clap.yue:79
    end, -- shunt/clap.yue:81
    _repr = function(self) -- shunt/clap.yue:81
      return self._short or self._long -- shunt/clap.yue:81
    end, -- shunt/clap.yue:82
    _long_repr = function(self) -- shunt/clap.yue:82
      if (self._short ~= nil) and (self._long ~= nil) then -- shunt/clap.yue:83
        return " " .. tostring(self._short) .. ", " .. tostring(self._long) -- shunt/clap.yue:84
      else -- shunt/clap.yue:85
        if (self._short ~= nil) then -- shunt/clap.yue:85
          return " " .. tostring(self._short) -- shunt/clap.yue:86
        else -- shunt/clap.yue:88
          return self._long -- shunt/clap.yue:88
        end -- shunt/clap.yue:85
      end -- shunt/clap.yue:83
    end -- shunt/clap.yue:37
  } -- shunt/clap.yue:37
  if _base_0.__index == nil then -- shunt/clap.yue:37
    _base_0.__index = _base_0 -- shunt/clap.yue:37
  end -- shunt/clap.yue:89
  _class_0 = setmetatable({ -- shunt/clap.yue:37
    __init = function(self, _name) -- shunt/clap.yue:38
      self._name = _name -- shunt/clap.yue:38
      self._dest = self._name:gsub('-', '_') -- shunt/clap.yue:39
      self._takes_param = false -- shunt/clap.yue:40
      self._default = false -- shunt/clap.yue:41
      self._value_name = 'value' -- shunt/clap.yue:42
      self._short = '-' .. self._name:sub(1, 1) -- shunt/clap.yue:43
      if #self._name > 1 then -- shunt/clap.yue:44
        self._long = '--' .. self._name:gsub(' ', '-') -- shunt/clap.yue:45
      else -- shunt/clap.yue:47
        self._long = nil -- shunt/clap.yue:47
      end -- shunt/clap.yue:44
      self._global = false -- shunt/clap.yue:48
      self._required = false -- shunt/clap.yue:49
      self._hidden = false -- shunt/clap.yue:50
      self._description = nil -- shunt/clap.yue:51
      self._options = nil -- shunt/clap.yue:52
      self._transform = nil -- shunt/clap.yue:53
    end, -- shunt/clap.yue:37
    __base = _base_0, -- shunt/clap.yue:37
    __name = "Flag" -- shunt/clap.yue:37
  }, { -- shunt/clap.yue:37
    __index = _base_0, -- shunt/clap.yue:37
    __call = function(cls, ...) -- shunt/clap.yue:37
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clap.yue:37
      cls.__init(_self_0, ...) -- shunt/clap.yue:37
      return _self_0 -- shunt/clap.yue:37
    end -- shunt/clap.yue:37
  }) -- shunt/clap.yue:37
  _base_0.__class = _class_0 -- shunt/clap.yue:37
  Flag = _class_0 -- shunt/clap.yue:37
end -- shunt/clap.yue:89
_module_0["Flag"] = Flag -- shunt/clap.yue:37
do -- shunt/clap.yue:91
  local _class_0 -- shunt/clap.yue:91
  local _base_0 = { -- shunt/clap.yue:91
    dest = function(self, _dest) -- shunt/clap.yue:101
      self._dest = _dest -- shunt/clap.yue:101
      return self -- shunt/clap.yue:101
    end, -- shunt/clap.yue:102
    arg_name = function(self, _arg_name) -- shunt/clap.yue:102
      self._arg_name = _arg_name -- shunt/clap.yue:102
      return self -- shunt/clap.yue:102
    end, -- shunt/clap.yue:103
    default = function(self, _default) -- shunt/clap.yue:103
      self._default = _default -- shunt/clap.yue:103
      self._required = false -- shunt/clap.yue:104
      return self -- shunt/clap.yue:105
    end, -- shunt/clap.yue:106
    description = function(self, _description) -- shunt/clap.yue:106
      self._description = _description -- shunt/clap.yue:106
      return self -- shunt/clap.yue:106
    end, -- shunt/clap.yue:107
    options = function(self, _options) -- shunt/clap.yue:107
      self._options = _options -- shunt/clap.yue:107
      return self -- shunt/clap.yue:107
    end, -- shunt/clap.yue:108
    transform = function(self, _transform) -- shunt/clap.yue:108
      self._transform = _transform -- shunt/clap.yue:108
      return self -- shunt/clap.yue:108
    end, -- shunt/clap.yue:109
    capture_remainder = function(self) -- shunt/clap.yue:109
      self._capture_remainder = true -- shunt/clap.yue:110
      self._required = false -- shunt/clap.yue:111
      return self -- shunt/clap.yue:112
    end, -- shunt/clap.yue:114
    _repr = function(self) -- shunt/clap.yue:114
      local name = self._arg_name or self._name -- shunt/clap.yue:115
      if not self._capture_remainder then -- shunt/clap.yue:116
        return name -- shunt/clap.yue:117
      end -- shunt/clap.yue:116
      return tostring(name) .. "..." -- shunt/clap.yue:118
    end -- shunt/clap.yue:91
  } -- shunt/clap.yue:91
  if _base_0.__index == nil then -- shunt/clap.yue:91
    _base_0.__index = _base_0 -- shunt/clap.yue:91
  end -- shunt/clap.yue:118
  _class_0 = setmetatable({ -- shunt/clap.yue:91
    __init = function(self, _name) -- shunt/clap.yue:92
      self._name = _name -- shunt/clap.yue:92
      self._dest = self._name:gsub('-', '_') -- shunt/clap.yue:93
      self._arg_name = nil -- shunt/clap.yue:94
      self._required = true -- shunt/clap.yue:95
      self._description = nil -- shunt/clap.yue:96
      self._options = nil -- shunt/clap.yue:97
      self._transform = nil -- shunt/clap.yue:98
      self._capture_remainder = false -- shunt/clap.yue:99
    end, -- shunt/clap.yue:91
    __base = _base_0, -- shunt/clap.yue:91
    __name = "Param" -- shunt/clap.yue:91
  }, { -- shunt/clap.yue:91
    __index = _base_0, -- shunt/clap.yue:91
    __call = function(cls, ...) -- shunt/clap.yue:91
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clap.yue:91
      cls.__init(_self_0, ...) -- shunt/clap.yue:91
      return _self_0 -- shunt/clap.yue:91
    end -- shunt/clap.yue:91
  }) -- shunt/clap.yue:91
  _base_0.__class = _class_0 -- shunt/clap.yue:91
  Param = _class_0 -- shunt/clap.yue:91
end -- shunt/clap.yue:118
_module_0["Param"] = Param -- shunt/clap.yue:91
do -- shunt/clap.yue:120
  local _class_0 -- shunt/clap.yue:120
  local _base_0 = { -- shunt/clap.yue:120
    dest = function(self, _dest) -- shunt/clap.yue:133
      self._dest = _dest -- shunt/clap.yue:133
      return self -- shunt/clap.yue:133
    end, -- shunt/clap.yue:134
    version = function(self, _version) -- shunt/clap.yue:134
      self._version = _version -- shunt/clap.yue:134
      return self -- shunt/clap.yue:134
    end, -- shunt/clap.yue:135
    add = function(self, arg) -- shunt/clap.yue:135
      local arg_type -- shunt/clap.yue:136
      do -- shunt/clap.yue:136
        local _obj_0 = getmetatable(arg) -- shunt/clap.yue:136
        if _obj_0 ~= nil then -- shunt/clap.yue:136
          do -- shunt/clap.yue:136
            local _obj_1 = _obj_0.__class -- shunt/clap.yue:136
            if _obj_1 ~= nil then -- shunt/clap.yue:136
              arg_type = _obj_1.__name -- shunt/clap.yue:136
            end -- shunt/clap.yue:136
          end -- shunt/clap.yue:136
        end -- shunt/clap.yue:136
      end -- shunt/clap.yue:136
      if 'Flag' == arg_type then -- shunt/clap.yue:138
        do -- shunt/clap.yue:139
          local _obj_0 = self._flags -- shunt/clap.yue:139
          _obj_0[#_obj_0 + 1] = arg -- shunt/clap.yue:139
        end -- shunt/clap.yue:139
      elseif 'Param' == arg_type then -- shunt/clap.yue:140
        do -- shunt/clap.yue:141
          local _obj_0 = self._params -- shunt/clap.yue:141
          _obj_0[#_obj_0 + 1] = arg -- shunt/clap.yue:141
        end -- shunt/clap.yue:141
      elseif 'Subcommand' == arg_type then -- shunt/clap.yue:142
        arg._parent_command = self -- shunt/clap.yue:143
        do -- shunt/clap.yue:144
          local _obj_0 = self._subcommands -- shunt/clap.yue:144
          _obj_0[#_obj_0 + 1] = arg -- shunt/clap.yue:144
        end -- shunt/clap.yue:144
      else -- shunt/clap.yue:146
        error("cannot use a " .. tostring(type(arg)) .. " as an arg") -- shunt/clap.yue:146
      end -- shunt/clap.yue:146
      return self -- shunt/clap.yue:147
    end, -- shunt/clap.yue:149
    hidden = function(self) -- shunt/clap.yue:149
      self._hidden = true -- shunt/clap.yue:150
      return self -- shunt/clap.yue:151
    end, -- shunt/clap.yue:153
    no_help = function(self) -- shunt/clap.yue:153
      self._add_help = false -- shunt/clap.yue:154
      return self -- shunt/clap.yue:155
    end, -- shunt/clap.yue:156
    description = function(self, _description) -- shunt/clap.yue:156
      self._description = _description -- shunt/clap.yue:156
      return self -- shunt/clap.yue:156
    end, -- shunt/clap.yue:158
    _parse = function(self, args, global_flags, global_values, path) -- shunt/clap.yue:158
      if global_values == nil then -- shunt/clap.yue:158
        global_values = { } -- shunt/clap.yue:158
      end -- shunt/clap.yue:158
      if path == nil then -- shunt/clap.yue:158
        path = { } -- shunt/clap.yue:158
      end -- shunt/clap.yue:158
      local ret -- shunt/clap.yue:159
      do -- shunt/clap.yue:159
        local _with_0 = setmetatable({ }, { -- shunt/clap.yue:159
          __index = global_values -- shunt/clap.yue:159
        }) -- shunt/clap.yue:159
        local _list_0 = self._flags -- shunt/clap.yue:160
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:160
          local flag = _list_0[_index_0] -- shunt/clap.yue:160
          local _continue_0 = false -- shunt/clap.yue:161
          repeat -- shunt/clap.yue:161
            if flag._global then -- shunt/clap.yue:161
              _continue_0 = true -- shunt/clap.yue:162
              break -- shunt/clap.yue:162
            end -- shunt/clap.yue:161
            _with_0[flag._dest] = flag._default -- shunt/clap.yue:163
            _continue_0 = true -- shunt/clap.yue:161
          until true -- shunt/clap.yue:163
          if not _continue_0 then -- shunt/clap.yue:163
            break -- shunt/clap.yue:163
          end -- shunt/clap.yue:163
        end -- shunt/clap.yue:163
        local _list_1 = self._params -- shunt/clap.yue:164
        for _index_0 = 1, #_list_1 do -- shunt/clap.yue:164
          local param = _list_1[_index_0] -- shunt/clap.yue:164
          if param._capture_remainder then -- shunt/clap.yue:165
            _with_0[param._dest] = { } -- shunt/clap.yue:166
          else -- shunt/clap.yue:168
            _with_0[param._dest] = param._default -- shunt/clap.yue:168
          end -- shunt/clap.yue:165
        end -- shunt/clap.yue:168
        ret = _with_0 -- shunt/clap.yue:159
      end -- shunt/clap.yue:159
      local flag_map -- shunt/clap.yue:170
      do -- shunt/clap.yue:170
        local _with_0 = { } -- shunt/clap.yue:170
        local declare -- shunt/clap.yue:171
        declare = function(flag) -- shunt/clap.yue:171
          if flag._short then -- shunt/clap.yue:172
            _with_0[flag._short] = flag -- shunt/clap.yue:173
          end -- shunt/clap.yue:172
          if flag._long then -- shunt/clap.yue:174
            _with_0[flag._long] = flag -- shunt/clap.yue:175
          end -- shunt/clap.yue:174
        end -- shunt/clap.yue:171
        for _index_0 = 1, #global_flags do -- shunt/clap.yue:176
          local flag = global_flags[_index_0] -- shunt/clap.yue:176
          declare(flag) -- shunt/clap.yue:177
        end -- shunt/clap.yue:177
        local _list_0 = self._flags -- shunt/clap.yue:178
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:178
          local flag = _list_0[_index_0] -- shunt/clap.yue:178
          declare(flag) -- shunt/clap.yue:179
        end -- shunt/clap.yue:179
        flag_map = _with_0 -- shunt/clap.yue:170
      end -- shunt/clap.yue:170
      local subcommand_map -- shunt/clap.yue:181
      do -- shunt/clap.yue:181
        local _tbl_0 = { } -- shunt/clap.yue:181
        local _list_0 = self._subcommands -- shunt/clap.yue:181
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:181
          local sc = _list_0[_index_0] -- shunt/clap.yue:181
          _tbl_0[sc._name] = sc -- shunt/clap.yue:181
        end -- shunt/clap.yue:181
        subcommand_map = _tbl_0 -- shunt/clap.yue:181
      end -- shunt/clap.yue:181
      local curr_param = 1 -- shunt/clap.yue:183
      local i = 0 -- shunt/clap.yue:184
      while i < #args do -- shunt/clap.yue:185
        i = i + 1 -- shunt/clap.yue:186
        local arg = args[i] -- shunt/clap.yue:187
        if '-' == arg:sub(1, 1) then -- shunt/clap.yue:188
          local flag = flag_map[arg] -- shunt/clap.yue:189
          if not (flag ~= nil) then -- shunt/clap.yue:190
            return nil, "unknown flag " .. tostring(arg) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:191
          end -- shunt/clap.yue:190
          local flag_value -- shunt/clap.yue:192
          if not flag._takes_param then -- shunt/clap.yue:192
            flag_value = true -- shunt/clap.yue:193
          else -- shunt/clap.yue:195
            i = i + 1 -- shunt/clap.yue:195
            local flag_arg = args[i] -- shunt/clap.yue:196
            if not (flag_arg ~= nil) then -- shunt/clap.yue:197
              return nil, "flag " .. tostring(arg) .. " expected an argument\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:198
            end -- shunt/clap.yue:197
            do -- shunt/clap.yue:200
              local transform = flag._transform -- shunt/clap.yue:200
              if transform then -- shunt/clap.yue:200
                local transformed, err = transform(flag_arg) -- shunt/clap.yue:201
                if (err ~= nil) then -- shunt/clap.yue:202
                  return nil, "cannot parse '" .. tostring(flag_arg) .. "': " .. tostring(err) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:203
                end -- shunt/clap.yue:202
                flag_value = transformed -- shunt/clap.yue:204
              else -- shunt/clap.yue:206
                flag_value = flag_arg -- shunt/clap.yue:206
              end -- shunt/clap.yue:200
            end -- shunt/clap.yue:200
          end -- shunt/clap.yue:192
          if flag._global then -- shunt/clap.yue:208
            getmetatable(ret).__index[flag._dest] = flag_value -- shunt/clap.yue:209
          else -- shunt/clap.yue:211
            ret[flag._dest] = flag_value -- shunt/clap.yue:211
          end -- shunt/clap.yue:208
        else -- shunt/clap.yue:212
          do -- shunt/clap.yue:212
            local param = self._params[curr_param] -- shunt/clap.yue:212
            if param then -- shunt/clap.yue:212
              local arg_value -- shunt/clap.yue:213
              do -- shunt/clap.yue:213
                local transform = param._transform -- shunt/clap.yue:213
                if transform then -- shunt/clap.yue:213
                  local transformed, err = transform(arg) -- shunt/clap.yue:214
                  if (err ~= nil) then -- shunt/clap.yue:215
                    return nil, "failed to parse " .. tostring(arg) .. ": " .. tostring(err) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:216
                  end -- shunt/clap.yue:215
                  arg_value = transformed -- shunt/clap.yue:217
                else -- shunt/clap.yue:219
                  arg_value = arg -- shunt/clap.yue:219
                end -- shunt/clap.yue:213
              end -- shunt/clap.yue:213
              if param._capture_remainder then -- shunt/clap.yue:220
                do -- shunt/clap.yue:221
                  local _obj_0 = ret[param._dest] -- shunt/clap.yue:221
                  _obj_0[#_obj_0 + 1] = arg_value -- shunt/clap.yue:221
                end -- shunt/clap.yue:221
              else -- shunt/clap.yue:223
                ret[param._dest] = arg_value -- shunt/clap.yue:223
                curr_param = curr_param + 1 -- shunt/clap.yue:224
              end -- shunt/clap.yue:220
            else -- shunt/clap.yue:225
              do -- shunt/clap.yue:225
                local command = subcommand_map[arg] -- shunt/clap.yue:225
                if command then -- shunt/clap.yue:225
                  path[#path + 1] = arg -- shunt/clap.yue:226
                  local subcommand_ret, err = command:_parse((function() -- shunt/clap.yue:227
                    local _accum_0 = { } -- shunt/clap.yue:227
                    local _len_0 = 1 -- shunt/clap.yue:227
                    for _index_0 = i + 1, #args do -- shunt/clap.yue:227
                      local a = args[_index_0] -- shunt/clap.yue:227
                      _accum_0[_len_0] = a -- shunt/clap.yue:227
                      _len_0 = _len_0 + 1 -- shunt/clap.yue:227
                    end -- shunt/clap.yue:227
                    return _accum_0 -- shunt/clap.yue:227
                  end)(), global_flags, global_values, path) -- shunt/clap.yue:227
                  if (err ~= nil) then -- shunt/clap.yue:228
                    return nil, err -- shunt/clap.yue:229
                  end -- shunt/clap.yue:228
                  ret[command._dest] = subcommand_ret -- shunt/clap.yue:230
                  break -- shunt/clap.yue:231
                else -- shunt/clap.yue:233
                  return nil, "unexpected argument '" .. tostring(arg) .. "'\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:233
                end -- shunt/clap.yue:225
              end -- shunt/clap.yue:225
            end -- shunt/clap.yue:212
          end -- shunt/clap.yue:212
        end -- shunt/clap.yue:188
      end -- shunt/clap.yue:233
      if ret._usage then -- shunt/clap.yue:235
        print(self:_usage_message(path)) -- shunt/clap.yue:236
        return nil, EXIT -- shunt/clap.yue:237
      end -- shunt/clap.yue:235
      do -- shunt/clap.yue:238
        local help = ret._help -- shunt/clap.yue:238
        if help then -- shunt/clap.yue:238
          if help == true then -- shunt/clap.yue:239
            print(self:_help_message(path)) -- shunt/clap.yue:240
            return nil, EXIT -- shunt/clap.yue:241
          end -- shunt/clap.yue:239
          if 'table' ~= type(help) then -- shunt/clap.yue:243
            error("internal error: unexpected help type " .. tostring(type(help))) -- shunt/clap.yue:244
          end -- shunt/clap.yue:243
          if (help.command ~= nil) then -- shunt/clap.yue:246
            if help.command ~= SELF then -- shunt/clap.yue:247
              path[#path] = help.command -- shunt/clap.yue:248
            else -- shunt/clap.yue:250
              path[#path] = nil -- shunt/clap.yue:250
            end -- shunt/clap.yue:247
          end -- shunt/clap.yue:246
          if help.command == SELF then -- shunt/clap.yue:251
            print(self:_help_message(path)) -- shunt/clap.yue:252
            return nil, EXIT -- shunt/clap.yue:253
          end -- shunt/clap.yue:251
          do -- shunt/clap.yue:254
            local sc = subcommand_map[help.command] -- shunt/clap.yue:254
            if sc then -- shunt/clap.yue:254
              print(sc:_help_message(path)) -- shunt/clap.yue:255
              return nil, EXIT -- shunt/clap.yue:256
            end -- shunt/clap.yue:254
          end -- shunt/clap.yue:254
          return nil, "no such subcommand '" .. tostring(help.command) .. "'\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:257
        end -- shunt/clap.yue:238
      end -- shunt/clap.yue:238
      if ret._version then -- shunt/clap.yue:258
        print(self:_version_message(path)) -- shunt/clap.yue:259
        return nil, EXIT -- shunt/clap.yue:260
      end -- shunt/clap.yue:258
      local _list_0 = self._flags -- shunt/clap.yue:262
      for _index_0 = 1, #_list_0 do -- shunt/clap.yue:262
        local flag = _list_0[_index_0] -- shunt/clap.yue:262
        do -- shunt/clap.yue:263
          local arg = flag[flag._dest] -- shunt/clap.yue:264
          if not arg and flag._required then -- shunt/clap.yue:265
            return nil, "flag '" .. tostring(flag:_repr()) .. "' required\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:266
          end -- shunt/clap.yue:265
          if arg and flag._options then -- shunt/clap.yue:267
            local ok = false -- shunt/clap.yue:268
            local _list_1 = flag._options -- shunt/clap.yue:269
            for _index_1 = 1, #_list_1 do -- shunt/clap.yue:269
              local option = _list_1[_index_1] -- shunt/clap.yue:269
              if arg == option then -- shunt/clap.yue:270
                ok = true -- shunt/clap.yue:271
                break -- shunt/clap.yue:272
              end -- shunt/clap.yue:270
            end -- shunt/clap.yue:272
            if not ok then -- shunt/clap.yue:273
              return nil, "flag '" .. tostring(flag:_repr()) .. "' has incorrect value, got '" .. tostring(arg) .. "' but expected one of " .. tostring(table.concat(flag._options, ', ')) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:274
            end -- shunt/clap.yue:273
          end -- shunt/clap.yue:267
        end -- shunt/clap.yue:263
      end -- shunt/clap.yue:274
      local _list_1 = self._params -- shunt/clap.yue:275
      for _index_0 = 1, #_list_1 do -- shunt/clap.yue:275
        local param = _list_1[_index_0] -- shunt/clap.yue:275
        do -- shunt/clap.yue:276
          local arg = ret[param._dest] -- shunt/clap.yue:277
          if not arg and param._required then -- shunt/clap.yue:278
            local options_repr -- shunt/clap.yue:279
            if param._options then -- shunt/clap.yue:279
              options_repr = " (accepts: " .. tostring(table.concat(param._options, ', ')) .. ")" -- shunt/clap.yue:280
            else -- shunt/clap.yue:282
              options_repr = "" -- shunt/clap.yue:282
            end -- shunt/clap.yue:279
            return nil, "argument '" .. tostring(param:_repr()) .. "' required" .. tostring(options_repr) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:283
          end -- shunt/clap.yue:278
          if arg and param._options then -- shunt/clap.yue:284
            local ok = false -- shunt/clap.yue:285
            local _list_2 = param._options -- shunt/clap.yue:286
            for _index_1 = 1, #_list_2 do -- shunt/clap.yue:286
              local option = _list_2[_index_1] -- shunt/clap.yue:286
              if arg == option then -- shunt/clap.yue:287
                ok = true -- shunt/clap.yue:288
                break -- shunt/clap.yue:289
              end -- shunt/clap.yue:287
            end -- shunt/clap.yue:289
            if not ok then -- shunt/clap.yue:290
              return nil, "argument '" .. tostring(param:_repr()) .. "' has incorrect value, got '" .. tostring(arg) .. "' but expected one of " .. tostring(table.concat(param._options, ', ')) .. "\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:291
            end -- shunt/clap.yue:290
          end -- shunt/clap.yue:284
        end -- shunt/clap.yue:276
      end -- shunt/clap.yue:291
      if #self._subcommands > 0 then -- shunt/clap.yue:292
        local command_specified = false -- shunt/clap.yue:293
        local _list_2 = self._subcommands -- shunt/clap.yue:294
        for _index_0 = 1, #_list_2 do -- shunt/clap.yue:294
          local command = _list_2[_index_0] -- shunt/clap.yue:294
          if (ret[command._dest] ~= nil) then -- shunt/clap.yue:295
            command_specified = true -- shunt/clap.yue:296
            break -- shunt/clap.yue:297
          end -- shunt/clap.yue:295
        end -- shunt/clap.yue:297
        if not command_specified then -- shunt/clap.yue:298
          return nil, "command required\n" .. tostring(self:_usage_message(path)) -- shunt/clap.yue:299
        end -- shunt/clap.yue:298
      end -- shunt/clap.yue:292
      return ret, nil -- shunt/clap.yue:301
    end, -- shunt/clap.yue:303
    _add_auto_args = function(self) -- shunt/clap.yue:303
      if self._add_help then -- shunt/clap.yue:304
        if #self._subcommands > 0 then -- shunt/clap.yue:305
          self:add((function() -- shunt/clap.yue:306
            local _with_0 = Subcommand('help') -- shunt/clap.yue:306
            _with_0:dest('_help') -- shunt/clap.yue:307
            _with_0:description('print help and exit') -- shunt/clap.yue:308
            _with_0:add((function() -- shunt/clap.yue:309
              local _with_1 = Param('command') -- shunt/clap.yue:309
              _with_1:description('print help for the given command and exit') -- shunt/clap.yue:310
              _with_1:default(SELF) -- shunt/clap.yue:311
              return _with_1 -- shunt/clap.yue:309
            end)()) -- shunt/clap.yue:309
            return _with_0 -- shunt/clap.yue:306
          end)()) -- shunt/clap.yue:306
        else -- shunt/clap.yue:313
          self:add((function() -- shunt/clap.yue:313
            local _with_0 = Flag('help') -- shunt/clap.yue:313
            _with_0:dest('_usage') -- shunt/clap.yue:314
            _with_0:description('print usage and exit') -- shunt/clap.yue:315
            _with_0:long(nil) -- shunt/clap.yue:316
            return _with_0 -- shunt/clap.yue:313
          end)()) -- shunt/clap.yue:313
          self:add((function() -- shunt/clap.yue:317
            local _with_0 = Flag('help') -- shunt/clap.yue:317
            _with_0:dest('_help') -- shunt/clap.yue:318
            _with_0:description('print help and exit') -- shunt/clap.yue:319
            _with_0:short(nil) -- shunt/clap.yue:320
            return _with_0 -- shunt/clap.yue:317
          end)()) -- shunt/clap.yue:317
        end -- shunt/clap.yue:305
      end -- shunt/clap.yue:304
      if (self._version ~= nil) then -- shunt/clap.yue:322
        return self:add((function() -- shunt/clap.yue:323
          local _with_0 = Flag('version') -- shunt/clap.yue:323
          _with_0:dest('_version') -- shunt/clap.yue:324
          _with_0:description('print version') -- shunt/clap.yue:325
          _with_0:short(nil) -- shunt/clap.yue:326
          return _with_0 -- shunt/clap.yue:323
        end)()) -- shunt/clap.yue:326
      end -- shunt/clap.yue:322
    end, -- shunt/clap.yue:328
    _validate_spec = function(self, is_root) -- shunt/clap.yue:328
      if is_root == nil then -- shunt/clap.yue:328
        is_root = true -- shunt/clap.yue:328
      end -- shunt/clap.yue:328
      if #self._params > 0 and #self._subcommands > 0 then -- shunt/clap.yue:329
        return "cannot have both parameters and subcommands in command " .. tostring(self._name) -- shunt/clap.yue:330
      end -- shunt/clap.yue:329
      do -- shunt/clap.yue:332
        local _with_0 = { } -- shunt/clap.yue:332
        local _list_0 = self._flags -- shunt/clap.yue:333
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:333
          local flag = _list_0[_index_0] -- shunt/clap.yue:333
          if _with_0[flag._short] or _with_0[flag._long] then -- shunt/clap.yue:334
            return "duplicate flag: " .. tostring(flag:_repr()) -- shunt/clap.yue:335
          end -- shunt/clap.yue:334
          if flag._short then -- shunt/clap.yue:336
            _with_0[flag._short] = true -- shunt/clap.yue:337
          end -- shunt/clap.yue:336
          if flag._long then -- shunt/clap.yue:338
            _with_0[flag._long] = true -- shunt/clap.yue:339
          end -- shunt/clap.yue:338
        end -- shunt/clap.yue:339
      end -- shunt/clap.yue:332
      if not is_root then -- shunt/clap.yue:341
        local _list_0 = self._flags -- shunt/clap.yue:342
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:342
          local flag = _list_0[_index_0] -- shunt/clap.yue:342
          if flag._global then -- shunt/clap.yue:343
            return "cannot declare " .. tostring(flag._name) .. " as global: not in root command" -- shunt/clap.yue:344
          end -- shunt/clap.yue:343
        end -- shunt/clap.yue:344
      end -- shunt/clap.yue:341
      local arg_dests -- shunt/clap.yue:347
      do -- shunt/clap.yue:347
        local _tbl_0 = { } -- shunt/clap.yue:347
        local _list_0 = self._flags -- shunt/clap.yue:347
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:347
          local flag = _list_0[_index_0] -- shunt/clap.yue:347
          _tbl_0[flag._dest] = true -- shunt/clap.yue:347
        end -- shunt/clap.yue:347
        arg_dests = _tbl_0 -- shunt/clap.yue:347
      end -- shunt/clap.yue:347
      local remainder_capturer = nil -- shunt/clap.yue:348
      local _list_0 = self._params -- shunt/clap.yue:349
      for _index_0 = 1, #_list_0 do -- shunt/clap.yue:349
        local param = _list_0[_index_0] -- shunt/clap.yue:349
        local dest = param._dest -- shunt/clap.yue:350
        if arg_dests[dest] then -- shunt/clap.yue:351
          return "duplicate parameter name: " .. tostring(dest) -- shunt/clap.yue:352
        end -- shunt/clap.yue:351
        arg_dests[dest] = true -- shunt/clap.yue:353
        if param._capture_remainder then -- shunt/clap.yue:355
          if (remainder_capturer ~= nil) then -- shunt/clap.yue:356
            return "parameters '" .. tostring(remainder_capturer._name) .. "' and '" .. tostring(param._name) .. "' both capture remainder args" -- shunt/clap.yue:357
          end -- shunt/clap.yue:356
          remainder_capturer = param -- shunt/clap.yue:358
          if param._default then -- shunt/clap.yue:360
            return "capture-remainder does not support a default" -- shunt/clap.yue:361
          end -- shunt/clap.yue:360
        end -- shunt/clap.yue:355
      end -- shunt/clap.yue:361
      local _list_1 = self._subcommands -- shunt/clap.yue:363
      for _index_0 = 1, #_list_1 do -- shunt/clap.yue:363
        local subcommand = _list_1[_index_0] -- shunt/clap.yue:363
        local dest = subcommand._dest -- shunt/clap.yue:364
        if (arg_dests[dest] ~= nil) then -- shunt/clap.yue:365
          return "duplicate subcommand name: " .. tostring(dest) -- shunt/clap.yue:366
        end -- shunt/clap.yue:365
        arg_dests[dest] = true -- shunt/clap.yue:367
        do -- shunt/clap.yue:369
          local err = subcommand:_validate_spec(false) -- shunt/clap.yue:369
          if err then -- shunt/clap.yue:369
            return err -- shunt/clap.yue:370
          end -- shunt/clap.yue:369
        end -- shunt/clap.yue:369
      end -- shunt/clap.yue:370
      if #self._params > 0 and #self._subcommands > 0 then -- shunt/clap.yue:372
        return "command cannot have both params and subcommands" -- shunt/clap.yue:373
      end -- shunt/clap.yue:372
      return nil -- shunt/clap.yue:375
    end, -- shunt/clap.yue:377
    _usage_message = function(self, path) -- shunt/clap.yue:377
      if path == nil then -- shunt/clap.yue:377
        path = { } -- shunt/clap.yue:377
      end -- shunt/clap.yue:377
      local path_repr = table.concat(path, ' ') -- shunt/clap.yue:378
      return table.concat((function() -- shunt/clap.yue:379
        local _with_0 = { -- shunt/clap.yue:379
          'Usage: ', -- shunt/clap.yue:379
          path_repr, -- shunt/clap.yue:379
          ' ' -- shunt/clap.yue:379
        } -- shunt/clap.yue:379
        local first_arg = true -- shunt/clap.yue:380
        local _list_0 = self:_sorted_flags() -- shunt/clap.yue:381
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:381
          local flag = _list_0[_index_0] -- shunt/clap.yue:381
          local _continue_0 = false -- shunt/clap.yue:382
          repeat -- shunt/clap.yue:382
            if flag._hidden then -- shunt/clap.yue:382
              _continue_0 = true -- shunt/clap.yue:383
              break -- shunt/clap.yue:383
            end -- shunt/clap.yue:382
            if not first_arg then -- shunt/clap.yue:384
              _with_0[#_with_0 + 1] = ' ' -- shunt/clap.yue:385
            end -- shunt/clap.yue:384
            first_arg = false -- shunt/clap.yue:386
            if not flag._required then -- shunt/clap.yue:388
              _with_0[#_with_0 + 1] = '[' -- shunt/clap.yue:389
            end -- shunt/clap.yue:388
            _with_0[#_with_0 + 1] = flag:_repr() -- shunt/clap.yue:390
            if flag._takes_param then -- shunt/clap.yue:391
              _with_0[#_with_0 + 1] = ' ' -- shunt/clap.yue:392
              _with_0[#_with_0 + 1] = flag._value_name -- shunt/clap.yue:393
            end -- shunt/clap.yue:391
            if not flag._required then -- shunt/clap.yue:394
              _with_0[#_with_0 + 1] = ']' -- shunt/clap.yue:395
            end -- shunt/clap.yue:394
            _continue_0 = true -- shunt/clap.yue:382
          until true -- shunt/clap.yue:395
          if not _continue_0 then -- shunt/clap.yue:395
            break -- shunt/clap.yue:395
          end -- shunt/clap.yue:395
        end -- shunt/clap.yue:395
        local _list_1 = self._params -- shunt/clap.yue:397
        for _index_0 = 1, #_list_1 do -- shunt/clap.yue:397
          local param = _list_1[_index_0] -- shunt/clap.yue:397
          if not first_arg then -- shunt/clap.yue:398
            _with_0[#_with_0 + 1] = ' ' -- shunt/clap.yue:399
          end -- shunt/clap.yue:398
          first_arg = false -- shunt/clap.yue:400
          if not param._required then -- shunt/clap.yue:402
            _with_0[#_with_0 + 1] = '[' -- shunt/clap.yue:403
          end -- shunt/clap.yue:402
          _with_0[#_with_0 + 1] = param:_repr() -- shunt/clap.yue:404
          if not param._required then -- shunt/clap.yue:405
            _with_0[#_with_0 + 1] = ']' -- shunt/clap.yue:406
          end -- shunt/clap.yue:405
        end -- shunt/clap.yue:406
        if #self._subcommands > 0 then -- shunt/clap.yue:408
          if not first_arg then -- shunt/clap.yue:409
            _with_0[#_with_0 + 1] = ' ' -- shunt/clap.yue:410
          end -- shunt/clap.yue:409
          _with_0[#_with_0 + 1] = '<command>' -- shunt/clap.yue:411
        end -- shunt/clap.yue:408
        return _with_0 -- shunt/clap.yue:379
      end)()) -- shunt/clap.yue:411
    end, -- shunt/clap.yue:413
    _help_message = function(self, path) -- shunt/clap.yue:413
      if path == nil then -- shunt/clap.yue:413
        path = { } -- shunt/clap.yue:413
      end -- shunt/clap.yue:413
      local lines -- shunt/clap.yue:414
      do -- shunt/clap.yue:414
        local _with_0 = { } -- shunt/clap.yue:414
        if (self._description ~= nil) then -- shunt/clap.yue:415
          _with_0[#_with_0 + 1] = table.concat((function() -- shunt/clap.yue:416
            local _with_1 = { } -- shunt/clap.yue:416
            _with_1[#_with_1 + 1] = table.concat(path, ' ') -- shunt/clap.yue:417
            _with_1[#_with_1 + 1] = " - " .. tostring(self._description) -- shunt/clap.yue:418
            return _with_1 -- shunt/clap.yue:416
          end)()) -- shunt/clap.yue:416
        end -- shunt/clap.yue:415
        _with_0[#_with_0 + 1] = '' -- shunt/clap.yue:420
        _with_0[#_with_0 + 1] = self:_usage_message(path) -- shunt/clap.yue:421
        if #self._subcommands > 0 then -- shunt/clap.yue:423
          _with_0[#_with_0 + 1] = '' -- shunt/clap.yue:424
          _with_0[#_with_0 + 1] = 'Commands:' -- shunt/clap.yue:425
          local longest_subommand_repr_len = math.max(unpack((function() -- shunt/clap.yue:427
            local _accum_0 = { } -- shunt/clap.yue:427
            local _len_0 = 1 -- shunt/clap.yue:427
            local _list_0 = self._subcommands -- shunt/clap.yue:427
            for _index_0 = 1, #_list_0 do -- shunt/clap.yue:427
              local sc = _list_0[_index_0] -- shunt/clap.yue:427
              if not sc._hidden then -- shunt/clap.yue:427
                _accum_0[_len_0] = #sc:_repr() -- shunt/clap.yue:427
                _len_0 = _len_0 + 1 -- shunt/clap.yue:427
              end -- shunt/clap.yue:427
            end -- shunt/clap.yue:427
            return _accum_0 -- shunt/clap.yue:427
          end)())) -- shunt/clap.yue:427
          local sorted_subcommands -- shunt/clap.yue:428
          do -- shunt/clap.yue:428
            local _accum_0 = { } -- shunt/clap.yue:428
            local _len_0 = 1 -- shunt/clap.yue:428
            local _list_0 = self._subcommands -- shunt/clap.yue:428
            for _index_0 = 1, #_list_0 do -- shunt/clap.yue:428
              local sc = _list_0[_index_0] -- shunt/clap.yue:428
              if not sc._hidden then -- shunt/clap.yue:428
                _accum_0[_len_0] = sc -- shunt/clap.yue:428
                _len_0 = _len_0 + 1 -- shunt/clap.yue:428
              end -- shunt/clap.yue:428
            end -- shunt/clap.yue:428
            sorted_subcommands = _accum_0 -- shunt/clap.yue:428
          end -- shunt/clap.yue:428
          table.sort(sorted_subcommands, function(sc1, sc2) -- shunt/clap.yue:429
            return sc1._name < sc2._name -- shunt/clap.yue:429
          end) -- shunt/clap.yue:429
          for _index_0 = 1, #sorted_subcommands do -- shunt/clap.yue:430
            local subcommand = sorted_subcommands[_index_0] -- shunt/clap.yue:430
            local repr = subcommand:_repr() -- shunt/clap.yue:431
            do -- shunt/clap.yue:432
              local description = subcommand._description -- shunt/clap.yue:432
              if description then -- shunt/clap.yue:432
                local padding = (' '):rep(longest_subommand_repr_len - #repr) -- shunt/clap.yue:433
                _with_0[#_with_0 + 1] = "  " .. tostring(repr) .. tostring(padding) .. "  " .. tostring(description) -- shunt/clap.yue:434
              else -- shunt/clap.yue:436
                _with_0[#_with_0 + 1] = "  " .. tostring(repr) -- shunt/clap.yue:436
              end -- shunt/clap.yue:432
            end -- shunt/clap.yue:432
          end -- shunt/clap.yue:436
        end -- shunt/clap.yue:423
        if #self._params > 0 then -- shunt/clap.yue:438
          _with_0[#_with_0 + 1] = '' -- shunt/clap.yue:439
          _with_0[#_with_0 + 1] = 'Arguments:' -- shunt/clap.yue:440
          local longest_param_repr_len = math.max(unpack((function() -- shunt/clap.yue:442
            local _accum_0 = { } -- shunt/clap.yue:442
            local _len_0 = 1 -- shunt/clap.yue:442
            local _list_0 = self._params -- shunt/clap.yue:442
            for _index_0 = 1, #_list_0 do -- shunt/clap.yue:442
              local p = _list_0[_index_0] -- shunt/clap.yue:442
              _accum_0[_len_0] = #p:_repr() -- shunt/clap.yue:442
              _len_0 = _len_0 + 1 -- shunt/clap.yue:442
            end -- shunt/clap.yue:442
            return _accum_0 -- shunt/clap.yue:442
          end)())) -- shunt/clap.yue:442
          local _list_0 = self._params -- shunt/clap.yue:443
          for _index_0 = 1, #_list_0 do -- shunt/clap.yue:443
            local param = _list_0[_index_0] -- shunt/clap.yue:443
            local repr = param:_repr() -- shunt/clap.yue:444
            local padding = (' '):rep(longest_param_repr_len - #repr) -- shunt/clap.yue:445
            local description -- shunt/clap.yue:446
            do -- shunt/clap.yue:446
              local _exp_0 = param._description -- shunt/clap.yue:446
              if _exp_0 ~= nil then -- shunt/clap.yue:446
                description = _exp_0 -- shunt/clap.yue:446
              else -- shunt/clap.yue:446
                description = "" -- shunt/clap.yue:446
              end -- shunt/clap.yue:446
            end -- shunt/clap.yue:446
            local default_repr -- shunt/clap.yue:447
            do -- shunt/clap.yue:447
              local default = param._default -- shunt/clap.yue:447
              if default then -- shunt/clap.yue:447
                default_repr = " (default: " .. tostring(default) .. ")" -- shunt/clap.yue:448
              else -- shunt/clap.yue:450
                default_repr = "" -- shunt/clap.yue:450
              end -- shunt/clap.yue:447
            end -- shunt/clap.yue:447
            local options_repr -- shunt/clap.yue:451
            do -- shunt/clap.yue:451
              local options = param._options -- shunt/clap.yue:451
              if options then -- shunt/clap.yue:451
                options_repr = " (one of: " .. tostring(table.concat(options, ', ')) .. ")" -- shunt/clap.yue:452
              else -- shunt/clap.yue:454
                options_repr = "" -- shunt/clap.yue:454
              end -- shunt/clap.yue:451
            end -- shunt/clap.yue:451
            local rhs_width = ((function() -- shunt/clap.yue:455
              local _exp_0 -- shunt/clap.yue:455
              do -- shunt/clap.yue:455
                local _obj_0 = term -- shunt/clap.yue:455
                if _obj_0 ~= nil then -- shunt/clap.yue:455
                  _exp_0 = _obj_0.getSize() -- shunt/clap.yue:455
                end -- shunt/clap.yue:455
              end -- shunt/clap.yue:455
              if _exp_0 ~= nil then -- shunt/clap.yue:455
                return _exp_0 -- shunt/clap.yue:455
              else -- shunt/clap.yue:455
                return 80 -- shunt/clap.yue:455
              end -- shunt/clap.yue:455
            end)()) - (longest_param_repr_len + 3) -- shunt/clap.yue:455
            local rhs_words = (tostring(description) .. tostring(default_repr) .. tostring(options_repr)):gmatch('(%S+)') -- shunt/clap.yue:456
            local rhs_lines -- shunt/clap.yue:457
            do -- shunt/clap.yue:457
              local _with_1 = { } -- shunt/clap.yue:457
              local curr_line = { } -- shunt/clap.yue:458
              local curr_line_len = 0 -- shunt/clap.yue:459
              for word in rhs_words do -- shunt/clap.yue:460
                local _continue_0 = false -- shunt/clap.yue:461
                repeat -- shunt/clap.yue:461
                  if #word > rhs_width then -- shunt/clap.yue:461
                    if #curr_line > 0 then -- shunt/clap.yue:462
                      _with_1[#_with_1 + 1] = table.concat(curr_line, ' ') -- shunt/clap.yue:463
                    end -- shunt/clap.yue:462
                    _with_1[#_with_1 + 1] = word -- shunt/clap.yue:464
                    curr_line = { } -- shunt/clap.yue:465
                    _continue_0 = true -- shunt/clap.yue:466
                    break -- shunt/clap.yue:466
                  end -- shunt/clap.yue:461
                  if curr_line_len + 1 + #word > rhs_width then -- shunt/clap.yue:468
                    _with_1[#_with_1 + 1] = table.concat(curr_line, ' ') -- shunt/clap.yue:469
                    curr_line = { -- shunt/clap.yue:470
                      word -- shunt/clap.yue:470
                    } -- shunt/clap.yue:470
                    curr_line_len = #word -- shunt/clap.yue:471
                    _continue_0 = true -- shunt/clap.yue:472
                    break -- shunt/clap.yue:472
                  end -- shunt/clap.yue:468
                  curr_line[#curr_line + 1] = word -- shunt/clap.yue:474
                  curr_line_len = curr_line_len + (1 + #word) -- shunt/clap.yue:475
                  _continue_0 = true -- shunt/clap.yue:461
                until true -- shunt/clap.yue:475
                if not _continue_0 then -- shunt/clap.yue:475
                  break -- shunt/clap.yue:475
                end -- shunt/clap.yue:475
              end -- shunt/clap.yue:475
              if #curr_line > 0 then -- shunt/clap.yue:476
                _with_1[#_with_1 + 1] = table.concat(curr_line, ' ') -- shunt/clap.yue:477
              end -- shunt/clap.yue:476
              rhs_lines = _with_1 -- shunt/clap.yue:457
            end -- shunt/clap.yue:457
            _with_0[#_with_0 + 1] = " " .. tostring(repr) .. tostring(padding) .. "  " .. tostring(table.concat(rhs_lines, '\n' .. (' '):rep(longest_param_repr_len + 3))) -- shunt/clap.yue:479
          end -- shunt/clap.yue:479
        end -- shunt/clap.yue:438
        if #self._flags > 0 then -- shunt/clap.yue:481
          _with_0[#_with_0 + 1] = '' -- shunt/clap.yue:482
          _with_0[#_with_0 + 1] = 'Flags:' -- shunt/clap.yue:483
          local longest_local_flag_repr_len = math.max(0, unpack((function() -- shunt/clap.yue:485
            local _accum_0 = { } -- shunt/clap.yue:485
            local _len_0 = 1 -- shunt/clap.yue:485
            local _list_0 = self._flags -- shunt/clap.yue:485
            for _index_0 = 1, #_list_0 do -- shunt/clap.yue:485
              local p = _list_0[_index_0] -- shunt/clap.yue:485
              _accum_0[_len_0] = #p:_long_repr() -- shunt/clap.yue:485
              _len_0 = _len_0 + 1 -- shunt/clap.yue:485
            end -- shunt/clap.yue:485
            return _accum_0 -- shunt/clap.yue:485
          end)())) -- shunt/clap.yue:485
          local longest_global_flag_repr_len = math.max(0, unpack((function() -- shunt/clap.yue:486
            local _accum_0 = { } -- shunt/clap.yue:486
            local _len_0 = 1 -- shunt/clap.yue:486
            local _list_0 = self:_global_flags() -- shunt/clap.yue:486
            for _index_0 = 1, #_list_0 do -- shunt/clap.yue:486
              local p = _list_0[_index_0] -- shunt/clap.yue:486
              _accum_0[_len_0] = #p:_long_repr() -- shunt/clap.yue:486
              _len_0 = _len_0 + 1 -- shunt/clap.yue:486
            end -- shunt/clap.yue:486
            return _accum_0 -- shunt/clap.yue:486
          end)())) -- shunt/clap.yue:486
          local longest_flag_repr_len = math.max(longest_local_flag_repr_len, longest_global_flag_repr_len) -- shunt/clap.yue:487
          local _list_0 = self:_sorted_flags() -- shunt/clap.yue:488
          for _index_0 = 1, #_list_0 do -- shunt/clap.yue:488
            local flag = _list_0[_index_0] -- shunt/clap.yue:488
            local _continue_0 = false -- shunt/clap.yue:489
            repeat -- shunt/clap.yue:489
              if flag._hidden then -- shunt/clap.yue:489
                _continue_0 = true -- shunt/clap.yue:490
                break -- shunt/clap.yue:490
              end -- shunt/clap.yue:489
              local repr = flag:_long_repr() -- shunt/clap.yue:492
              do -- shunt/clap.yue:493
                local description = flag._description -- shunt/clap.yue:493
                if description then -- shunt/clap.yue:493
                  local padding = (' '):rep(longest_flag_repr_len - #repr) -- shunt/clap.yue:494
                  _with_0[#_with_0 + 1] = " " .. tostring(repr) .. tostring(padding) .. "  " .. tostring(description) -- shunt/clap.yue:495
                else -- shunt/clap.yue:497
                  _with_0[#_with_0 + 1] = " " .. tostring(repr) -- shunt/clap.yue:497
                end -- shunt/clap.yue:493
              end -- shunt/clap.yue:493
              _continue_0 = true -- shunt/clap.yue:489
            until true -- shunt/clap.yue:497
            if not _continue_0 then -- shunt/clap.yue:497
              break -- shunt/clap.yue:497
            end -- shunt/clap.yue:497
          end -- shunt/clap.yue:497
        end -- shunt/clap.yue:481
        lines = _with_0 -- shunt/clap.yue:414
      end -- shunt/clap.yue:414
      return table.concat(lines, '\n') -- shunt/clap.yue:499
    end, -- shunt/clap.yue:501
    _sorted_flags = function(self) -- shunt/clap.yue:501
      local ret -- shunt/clap.yue:502
      do -- shunt/clap.yue:502
        local _tab_0 = { } -- shunt/clap.yue:502
        local _obj_0 = self._flags -- shunt/clap.yue:502
        local _idx_0 = 1 -- shunt/clap.yue:502
        for _key_0, _value_0 in pairs(_obj_0) do -- shunt/clap.yue:502
          if _idx_0 == _key_0 then -- shunt/clap.yue:502
            _tab_0[#_tab_0 + 1] = _value_0 -- shunt/clap.yue:502
            _idx_0 = _idx_0 + 1 -- shunt/clap.yue:502
          else -- shunt/clap.yue:502
            _tab_0[_key_0] = _value_0 -- shunt/clap.yue:502
          end -- shunt/clap.yue:502
        end -- shunt/clap.yue:502
        local _obj_1 = self:_global_flags() -- shunt/clap.yue:502
        local _idx_1 = 1 -- shunt/clap.yue:502
        for _key_0, _value_0 in pairs(_obj_1) do -- shunt/clap.yue:502
          if _idx_1 == _key_0 then -- shunt/clap.yue:502
            _tab_0[#_tab_0 + 1] = _value_0 -- shunt/clap.yue:502
            _idx_1 = _idx_1 + 1 -- shunt/clap.yue:502
          else -- shunt/clap.yue:502
            _tab_0[_key_0] = _value_0 -- shunt/clap.yue:502
          end -- shunt/clap.yue:502
        end -- shunt/clap.yue:502
        ret = _tab_0 -- shunt/clap.yue:502
      end -- shunt/clap.yue:502
      table.sort(ret, function(flag1, flag2) -- shunt/clap.yue:503
        local name1 = (flag1._short or flag1._long):match('[^-]+$') -- shunt/clap.yue:504
        local name2 = (flag2._short or flag2._long):match('[^-]+$') -- shunt/clap.yue:505
        return name1 < name2 -- shunt/clap.yue:506
      end) -- shunt/clap.yue:503
      return ret -- shunt/clap.yue:507
    end, -- shunt/clap.yue:509
    _global_flags = function(self) -- shunt/clap.yue:509
      local _with_0 = { } -- shunt/clap.yue:510
      if (self._parent_command ~= nil) then -- shunt/clap.yue:511
        local root = self -- shunt/clap.yue:512
        while (root._parent_command ~= nil) do -- shunt/clap.yue:513
          root = root._parent_command -- shunt/clap.yue:514
        end -- shunt/clap.yue:514
        local _list_0 = root._flags -- shunt/clap.yue:515
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:515
          local flag = _list_0[_index_0] -- shunt/clap.yue:515
          if flag._global then -- shunt/clap.yue:516
            _with_0[#_with_0 + 1] = flag -- shunt/clap.yue:517
          end -- shunt/clap.yue:516
        end -- shunt/clap.yue:517
      end -- shunt/clap.yue:511
      return _with_0 -- shunt/clap.yue:510
    end, -- shunt/clap.yue:519
    _version_message = function(self, path) -- shunt/clap.yue:519
      if path == nil then -- shunt/clap.yue:519
        path = { } -- shunt/clap.yue:519
      end -- shunt/clap.yue:519
      local parts -- shunt/clap.yue:520
      do -- shunt/clap.yue:520
        local _tab_0 = { } -- shunt/clap.yue:520
        local _idx_0 = 1 -- shunt/clap.yue:520
        for _key_0, _value_0 in pairs(path) do -- shunt/clap.yue:520
          if _idx_0 == _key_0 then -- shunt/clap.yue:520
            _tab_0[#_tab_0 + 1] = _value_0 -- shunt/clap.yue:520
            _idx_0 = _idx_0 + 1 -- shunt/clap.yue:520
          else -- shunt/clap.yue:520
            _tab_0[_key_0] = _value_0 -- shunt/clap.yue:520
          end -- shunt/clap.yue:520
        end -- shunt/clap.yue:520
        parts = _tab_0 -- shunt/clap.yue:520
      end -- shunt/clap.yue:520
      if (self._version ~= nil) then -- shunt/clap.yue:521
        parts[#parts + 1] = self._version -- shunt/clap.yue:522
      end -- shunt/clap.yue:521
      return table.concat(parts, ' ') -- shunt/clap.yue:523
    end, -- shunt/clap.yue:525
    _repr = function(self) -- shunt/clap.yue:525
      return self._name -- shunt/clap.yue:525
    end -- shunt/clap.yue:120
  } -- shunt/clap.yue:120
  if _base_0.__index == nil then -- shunt/clap.yue:120
    _base_0.__index = _base_0 -- shunt/clap.yue:120
  end -- shunt/clap.yue:525
  _class_0 = setmetatable({ -- shunt/clap.yue:120
    __init = function(self, _name) -- shunt/clap.yue:121
      self._name = _name -- shunt/clap.yue:121
      self._parent_command = nil -- shunt/clap.yue:122
      self._dest = self._name:gsub('-', '_') -- shunt/clap.yue:123
      self._version = nil -- shunt/clap.yue:124
      self._flags = { } -- shunt/clap.yue:125
      self._params = { } -- shunt/clap.yue:126
      self._subcommands = { } -- shunt/clap.yue:127
      self._hidden = false -- shunt/clap.yue:128
      self._add_help = true -- shunt/clap.yue:129
      self._description = nil -- shunt/clap.yue:130
      self._auto_args_added = false -- shunt/clap.yue:131
    end, -- shunt/clap.yue:120
    __base = _base_0, -- shunt/clap.yue:120
    __name = "Subcommand" -- shunt/clap.yue:120
  }, { -- shunt/clap.yue:120
    __index = _base_0, -- shunt/clap.yue:120
    __call = function(cls, ...) -- shunt/clap.yue:120
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clap.yue:120
      cls.__init(_self_0, ...) -- shunt/clap.yue:120
      return _self_0 -- shunt/clap.yue:120
    end -- shunt/clap.yue:120
  }) -- shunt/clap.yue:120
  _base_0.__class = _class_0 -- shunt/clap.yue:120
  Subcommand = _class_0 -- shunt/clap.yue:120
end -- shunt/clap.yue:525
_module_0["Subcommand"] = Subcommand -- shunt/clap.yue:120
local ArgParser -- shunt/clap.yue:527
do -- shunt/clap.yue:527
  local _class_0 -- shunt/clap.yue:527
  local _parent_0 = Subcommand -- shunt/clap.yue:527
  local _base_0 = { -- shunt/clap.yue:527
    parse = function(self, args) -- shunt/clap.yue:530
      if not self._auto_args_added then -- shunt/clap.yue:531
        self:_add_auto_args() -- shunt/clap.yue:532
        local _list_0 = self._subcommands -- shunt/clap.yue:533
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:533
          local subcommand = _list_0[_index_0] -- shunt/clap.yue:533
          subcommand:_add_auto_args() -- shunt/clap.yue:534
        end -- shunt/clap.yue:534
      end -- shunt/clap.yue:531
      self._auto_args_added = true -- shunt/clap.yue:535
      do -- shunt/clap.yue:537
        local err = self:_validate_spec() -- shunt/clap.yue:537
        if err then -- shunt/clap.yue:537
          print(err) -- shunt/clap.yue:538
          return nil, false -- shunt/clap.yue:539
        end -- shunt/clap.yue:537
      end -- shunt/clap.yue:537
      local global_flags -- shunt/clap.yue:541
      do -- shunt/clap.yue:541
        local _accum_0 = { } -- shunt/clap.yue:541
        local _len_0 = 1 -- shunt/clap.yue:541
        local _list_0 = self._flags -- shunt/clap.yue:541
        for _index_0 = 1, #_list_0 do -- shunt/clap.yue:541
          local flag = _list_0[_index_0] -- shunt/clap.yue:541
          if flag._global then -- shunt/clap.yue:541
            _accum_0[_len_0] = flag -- shunt/clap.yue:541
            _len_0 = _len_0 + 1 -- shunt/clap.yue:541
          end -- shunt/clap.yue:541
        end -- shunt/clap.yue:541
        global_flags = _accum_0 -- shunt/clap.yue:541
      end -- shunt/clap.yue:541
      local global_values -- shunt/clap.yue:542
      do -- shunt/clap.yue:542
        local _with_0 = { } -- shunt/clap.yue:542
        for _index_0 = 1, #global_flags do -- shunt/clap.yue:543
          local global_flag = global_flags[_index_0] -- shunt/clap.yue:543
          _with_0[global_flag._dest] = global_flag._default -- shunt/clap.yue:544
        end -- shunt/clap.yue:544
        global_values = _with_0 -- shunt/clap.yue:542
      end -- shunt/clap.yue:542
      local ret, err = self:_parse(args, global_flags, global_values, { -- shunt/clap.yue:545
        self._name -- shunt/clap.yue:545
      }) -- shunt/clap.yue:545
      if (err ~= nil) then -- shunt/clap.yue:546
        if err == EXIT then -- shunt/clap.yue:547
          return nil, false -- shunt/clap.yue:548
        end -- shunt/clap.yue:547
        print(err) -- shunt/clap.yue:549
        return nil, false -- shunt/clap.yue:550
      end -- shunt/clap.yue:546
      return ret, true -- shunt/clap.yue:551
    end -- shunt/clap.yue:527
  } -- shunt/clap.yue:527
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/clap.yue:551
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/clap.yue:527
      _base_0[_key_0] = _val_0 -- shunt/clap.yue:527
    end -- shunt/clap.yue:527
  end -- shunt/clap.yue:551
  if _base_0.__index == nil then -- shunt/clap.yue:527
    _base_0.__index = _base_0 -- shunt/clap.yue:527
  end -- shunt/clap.yue:551
  setmetatable(_base_0, _parent_0.__base) -- shunt/clap.yue:527
  _class_0 = setmetatable({ -- shunt/clap.yue:527
    __init = function(self, _name) -- shunt/clap.yue:528
      self._name = _name -- shunt/clap.yue:528
      return _class_0.__parent.__init(self, self._name) -- shunt/clap.yue:528
    end, -- shunt/clap.yue:527
    __base = _base_0, -- shunt/clap.yue:527
    __name = "ArgParser", -- shunt/clap.yue:527
    __parent = _parent_0 -- shunt/clap.yue:527
  }, { -- shunt/clap.yue:527
    __index = function(cls, name) -- shunt/clap.yue:527
      local val = rawget(_base_0, name) -- shunt/clap.yue:527
      if val == nil then -- shunt/clap.yue:527
        local parent = rawget(cls, "__parent") -- shunt/clap.yue:527
        if parent then -- shunt/clap.yue:527
          return parent[name] -- shunt/clap.yue:527
        end -- shunt/clap.yue:527
      else -- shunt/clap.yue:527
        return val -- shunt/clap.yue:527
      end -- shunt/clap.yue:527
    end, -- shunt/clap.yue:527
    __call = function(cls, ...) -- shunt/clap.yue:527
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clap.yue:527
      cls.__init(_self_0, ...) -- shunt/clap.yue:527
      return _self_0 -- shunt/clap.yue:527
    end -- shunt/clap.yue:527
  }) -- shunt/clap.yue:527
  _base_0.__class = _class_0 -- shunt/clap.yue:527
  if _parent_0.__inherited then -- shunt/clap.yue:527
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/clap.yue:527
  end -- shunt/clap.yue:527
  ArgParser = _class_0 -- shunt/clap.yue:527
end -- shunt/clap.yue:551
_module_0["ArgParser"] = ArgParser -- shunt/clap.yue:527
return _module_0 -- shunt/clap.yue:551
end
package.preload['shunt.version'] = function(...)
-- [yue]: shunt/version.yue
local _module_0 = { } -- shunt/version.yue:1
local VERSION -- shunt/version.yue:1
local spec = require('shunt.spec').spec -- shunt/version.yue:0
VERSION = ' (2025-09-16@10:32:23)' -- shunt/version.yue:13
_module_0["VERSION"] = VERSION -- shunt/version.yue:13
spec(function() -- shunt/version.yue:15
  local describe, expect_that, it, matchers -- shunt/version.yue:0
  do -- shunt/version.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/version.yue:0
    describe, expect_that, it, matchers = _obj_0.describe, _obj_0.expect_that, _obj_0.it, _obj_0.matchers -- shunt/version.yue:0
  end -- shunt/version.yue:0
  local lt = matchers.lt -- shunt/version.yue:20
  return describe('version', function() -- shunt/version.yue:22
    it('has a standard form', function() -- shunt/version.yue:23
      if VERSION:match('^%d+%.%d+$') then -- shunt/version.yue:24
        return -- shunt/version.yue:25
      end -- shunt/version.yue:24
      if VERSION:match('^%d+%.%d+ %(%d%d%d%d-%d%d-%d%d@%d%d:%d%d:%d%d%)$') then -- shunt/version.yue:26
        return -- shunt/version.yue:27
      end -- shunt/version.yue:26
      return error("version '" .. tostring(VERSION) .. "'does not have a standard form") -- shunt/version.yue:28
    end) -- shunt/version.yue:23
    return it('is ordered', function() -- shunt/version.yue:30
      local lesser = '0.1' -- shunt/version.yue:31
      local greater = '0.1 (2025-01-01@12:00:00)'; -- shunt/version.yue:32
      return require('shunt.spec')._expect_that([=[lesser]=], lesser, (lt(greater)), tostring("shunt/version.yue") .. ":" .. tostring(33)) -- shunt/version.yue:33
    end) -- shunt/version.yue:33
  end) -- shunt/version.yue:33
end) -- shunt/version.yue:15
return _module_0 -- shunt/version.yue:33
end
package.preload['shunt.cmd.clean'] = function(...)
-- [yue]: shunt/cmd/clean.yue
local _module_0 = { } -- shunt/cmd/clean.yue:1
local subcommand, main -- shunt/cmd/clean.yue:1
local Flag, Subcommand -- shunt/cmd/clean.yue:0
do -- shunt/cmd/clean.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/clean.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/cmd/clean.yue:0
end -- shunt/cmd/clean.yue:0
local F = require('shunt.quicktype').F -- shunt/cmd/clean.yue:0
do -- shunt/cmd/clean.yue:6
  local _with_0 = Subcommand('clean') -- shunt/cmd/clean.yue:6
  _with_0:description('remove all files associated with shunt') -- shunt/cmd/clean.yue:7
  subcommand = _with_0 -- shunt/cmd/clean.yue:6
end -- shunt/cmd/clean.yue:6
_module_0["subcommand"] = subcommand -- shunt/cmd/clean.yue:7
main = F('({}) -> <>', function(args) -- shunt/cmd/clean.yue:9
  os.remove('startup.lua') -- shunt/cmd/clean.yue:10
  os.remove('shunt.toml') -- shunt/cmd/clean.yue:11
  return -- shunt/cmd/clean.yue:12
end) -- shunt/cmd/clean.yue:9
_module_0["main"] = main -- shunt/cmd/clean.yue:12
return _module_0 -- shunt/cmd/clean.yue:12
end
package.preload['shunt.cmd.debug'] = function(...)
-- [yue]: shunt/cmd/debug.yue
local _module_0 = { } -- shunt/cmd/debug.yue:1
local state_machines, subcommand, main -- shunt/cmd/debug.yue:1
local Param, Subcommand -- shunt/cmd/debug.yue:0
do -- shunt/cmd/debug.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/debug.yue:0
  Param, Subcommand = _obj_0.Param, _obj_0.Subcommand -- shunt/cmd/debug.yue:0
end -- shunt/cmd/debug.yue:0
local F, T -- shunt/cmd/debug.yue:0
do -- shunt/cmd/debug.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/debug.yue:0
  F, T = _obj_0.F, _obj_0.T -- shunt/cmd/debug.yue:0
end -- shunt/cmd/debug.yue:0
state_machines = T('{string->()->string}', { -- shunt/cmd/debug.yue:7
  ['config_listener'] = function() -- shunt/cmd/debug.yue:7
    local ConfigListener = require('shunt.configurator.listener').ConfigListener -- shunt/cmd/debug.yue:0
    return ConfigListener:make_sm() -- shunt/cmd/debug.yue:9
  end, -- shunt/cmd/debug.yue:7
  ['marshal-main'] = function() -- shunt/cmd/debug.yue:10
    local Marshal = require('shunt.nodes.marshal.main').Marshal -- shunt/cmd/debug.yue:0
    return Marshal:make_sm() -- shunt/cmd/debug.yue:12
  end, -- shunt/cmd/debug.yue:10
  ['marshal-resource_orchestrator'] = function() -- shunt/cmd/debug.yue:13
    local ResourceOrchestrator = require('shunt.nodes.marshal.resource_orchestrator.main').ResourceOrchestrator -- shunt/cmd/debug.yue:0
    return ResourceOrchestrator:make_sm() -- shunt/cmd/debug.yue:15
  end, -- shunt/cmd/debug.yue:13
  ['marshal-scheduler'] = function() -- shunt/cmd/debug.yue:16
    local Scheduler = require('shunt.nodes.marshal.resource_orchestrator.scheduler').Scheduler -- shunt/cmd/debug.yue:0
    return Scheduler:make_sm() -- shunt/cmd/debug.yue:18
  end, -- shunt/cmd/debug.yue:16
  ['marshal-schedule_generator'] = function() -- shunt/cmd/debug.yue:19
    local ScheduleGenerator = require('shunt.nodes.marshal.resource_orchestrator.scheduler').ScheduleGenerator -- shunt/cmd/debug.yue:0
    return ScheduleGenerator:make_sm() -- shunt/cmd/debug.yue:21
  end, -- shunt/cmd/debug.yue:19
  ['marshal-schedule_generator_impl'] = function() -- shunt/cmd/debug.yue:22
    local ScheduleGeneratorImpl = require('shunt.nodes.marshal.resource_orchestrator.scheduler').ScheduleGeneratorImpl -- shunt/cmd/debug.yue:0
    return ScheduleGeneratorImpl:make_sm() -- shunt/cmd/debug.yue:24
  end, -- shunt/cmd/debug.yue:22
  ['upgrade_listener'] = function() -- shunt/cmd/debug.yue:25
    local UpgradeListener = require('shunt.upgrade.listener').UpgradeListener -- shunt/cmd/debug.yue:0
    return UpgradeListener:make_sm() -- shunt/cmd/debug.yue:27
  end -- shunt/cmd/debug.yue:25
}) -- shunt/cmd/debug.yue:6
do -- shunt/cmd/debug.yue:29
  local _with_0 = Subcommand('debug') -- shunt/cmd/debug.yue:29
  _with_0:hidden() -- shunt/cmd/debug.yue:30
  _with_0:description('helper functions for generating documentation') -- shunt/cmd/debug.yue:31
  _with_0:add((function() -- shunt/cmd/debug.yue:32
    local _with_1 = Subcommand('mermaid') -- shunt/cmd/debug.yue:32
    _with_1:description('generate mermaid diagrams') -- shunt/cmd/debug.yue:33
    _with_1:add((function() -- shunt/cmd/debug.yue:34
      local _with_2 = Param('which') -- shunt/cmd/debug.yue:34
      _with_2:description('the diagram to print') -- shunt/cmd/debug.yue:35
      _with_2:options((function() -- shunt/cmd/debug.yue:36
        local opts -- shunt/cmd/debug.yue:37
        do -- shunt/cmd/debug.yue:37
          local _accum_0 = { } -- shunt/cmd/debug.yue:37
          local _len_0 = 1 -- shunt/cmd/debug.yue:37
          for name in pairs(state_machines) do -- shunt/cmd/debug.yue:37
            _accum_0[_len_0] = name -- shunt/cmd/debug.yue:37
            _len_0 = _len_0 + 1 -- shunt/cmd/debug.yue:37
          end -- shunt/cmd/debug.yue:37
          opts = _accum_0 -- shunt/cmd/debug.yue:37
        end -- shunt/cmd/debug.yue:37
        table.sort(opts) -- shunt/cmd/debug.yue:38
        return opts -- shunt/cmd/debug.yue:39
      end)()) -- shunt/cmd/debug.yue:36
      return _with_2 -- shunt/cmd/debug.yue:34
    end)()) -- shunt/cmd/debug.yue:34
    return _with_1 -- shunt/cmd/debug.yue:32
  end)()) -- shunt/cmd/debug.yue:32
  subcommand = _with_0 -- shunt/cmd/debug.yue:29
end -- shunt/cmd/debug.yue:29
_module_0["subcommand"] = subcommand -- shunt/cmd/debug.yue:39
main = F('({}) -> <>', function(args) -- shunt/cmd/debug.yue:41
  do -- shunt/cmd/debug.yue:42
    local mermaid = args.mermaid -- shunt/cmd/debug.yue:42
    if mermaid then -- shunt/cmd/debug.yue:42
      print(state_machines[mermaid.which]():to_mermaid()) -- shunt/cmd/debug.yue:43
    end -- shunt/cmd/debug.yue:42
  end -- shunt/cmd/debug.yue:42
  return -- shunt/cmd/debug.yue:44
end) -- shunt/cmd/debug.yue:41
_module_0["main"] = main -- shunt/cmd/debug.yue:44
return _module_0 -- shunt/cmd/debug.yue:44
end
package.preload['shunt.configurator.listener'] = function(...)
-- [yue]: shunt/configurator/listener.yue
local _module_0 = { } -- shunt/configurator/listener.yue:1
local GetConfigRequest, GetConfigResponse, SetConfigRequest, SetConfigResponse -- shunt/configurator/listener.yue:0
do -- shunt/configurator/listener.yue:0
  local _obj_0 = require('shunt.configurator.main') -- shunt/configurator/listener.yue:0
  GetConfigRequest, GetConfigResponse, SetConfigRequest, SetConfigResponse = _obj_0.GetConfigRequest, _obj_0.GetConfigResponse, _obj_0.SetConfigRequest, _obj_0.SetConfigResponse -- shunt/configurator/listener.yue:0
end -- shunt/configurator/listener.yue:0
local Queue = require('shunt.data.queue').Queue -- shunt/configurator/listener.yue:0
local Firewall = require('shunt.firewall').Firewall -- shunt/configurator/listener.yue:0
local declare_type, F, is -- shunt/configurator/listener.yue:0
do -- shunt/configurator/listener.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/configurator/listener.yue:0
  declare_type, F, is = _obj_0.declare_type, _obj_0.F, _obj_0.is -- shunt/configurator/listener.yue:0
end -- shunt/configurator/listener.yue:0
local shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder -- shunt/configurator/listener.yue:0
do -- shunt/configurator/listener.yue:0
  local _obj_0 = require('shunt.state') -- shunt/configurator/listener.yue:0
  shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder = _obj_0.shallow_log_reporter, _obj_0.State, _obj_0.StateMachineBuilder, _obj_0.StateResponsesBuilder -- shunt/configurator/listener.yue:0
end -- shunt/configurator/listener.yue:0
local toml = require('shunt.toml') -- shunt/configurator/listener.yue:9
declare_type('ConfigListener', 'Component') -- shunt/configurator/listener.yue:11
declare_type('ConfigListenerEvent', [[{
  type: "network-packet",
}]]) -- shunt/configurator/listener.yue:12
declare_type('ConfigListenerOpts', [[{
  config_type: string,
  target: Component + { config: some },
  uplink: Uplink,
}]]) -- shunt/configurator/listener.yue:15
local ConfigListener -- shunt/configurator/listener.yue:20
do -- shunt/configurator/listener.yue:20
  local _class_0 -- shunt/configurator/listener.yue:20
  local _base_0 = { -- shunt/configurator/listener.yue:20
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/configurator/listener.yue:86
      return (StateResponsesBuilder(sm)):add('waiting', (function() -- shunt/configurator/listener.yue:88
        local _base_1 = self -- shunt/configurator/listener.yue:88
        local _fn_0 = _base_1.on_waiting -- shunt/configurator/listener.yue:88
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:88
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:88
        end -- shunt/configurator/listener.yue:88
      end)()):add('inspecting_packet', (function() -- shunt/configurator/listener.yue:89
        local _base_1 = self -- shunt/configurator/listener.yue:89
        local _fn_0 = _base_1.on_inspecting_packet -- shunt/configurator/listener.yue:89
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:89
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:89
        end -- shunt/configurator/listener.yue:89
      end)()):add('analysing_get_config_request', (function() -- shunt/configurator/listener.yue:90
        local _base_1 = self -- shunt/configurator/listener.yue:90
        local _fn_0 = _base_1.on_analysing_get_config_request -- shunt/configurator/listener.yue:90
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:90
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:90
        end -- shunt/configurator/listener.yue:90
      end)()):add('sending_get_config_response', (function() -- shunt/configurator/listener.yue:91
        local _base_1 = self -- shunt/configurator/listener.yue:91
        local _fn_0 = _base_1.on_sending_get_config_response -- shunt/configurator/listener.yue:91
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:91
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:91
        end -- shunt/configurator/listener.yue:91
      end)()):add('analysing_set_config_request', (function() -- shunt/configurator/listener.yue:92
        local _base_1 = self -- shunt/configurator/listener.yue:92
        local _fn_0 = _base_1.on_analysing_set_config_request -- shunt/configurator/listener.yue:92
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:92
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:92
        end -- shunt/configurator/listener.yue:92
      end)()):add('sending_set_config_response', (function() -- shunt/configurator/listener.yue:93
        local _base_1 = self -- shunt/configurator/listener.yue:93
        local _fn_0 = _base_1.on_sending_set_config_response -- shunt/configurator/listener.yue:93
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:93
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:93
        end -- shunt/configurator/listener.yue:93
      end)()):add('scheduling_config_application', (function() -- shunt/configurator/listener.yue:94
        local _base_1 = self -- shunt/configurator/listener.yue:94
        local _fn_0 = _base_1.on_scheduling_config_application -- shunt/configurator/listener.yue:94
        return _fn_0 and function(...) -- shunt/configurator/listener.yue:94
          return _fn_0(_base_1, ...) -- shunt/configurator/listener.yue:94
        end -- shunt/configurator/listener.yue:94
      end)()):build() -- shunt/configurator/listener.yue:95
    end), -- shunt/configurator/listener.yue:97
    step = F('() => <>', function(self) -- shunt/configurator/listener.yue:97
      return self.sm_responses[self.sm.state.name]() -- shunt/configurator/listener.yue:98
    end), -- shunt/configurator/listener.yue:100
    on_waiting = F('() => <>', function(self) -- shunt/configurator/listener.yue:100
      local event = self.events:dequeue() -- shunt/configurator/listener.yue:101
      if not (event ~= nil) then -- shunt/configurator/listener.yue:102
        return -- shunt/configurator/listener.yue:103
      end -- shunt/configurator/listener.yue:102
      local _exp_0 = event.type -- shunt/configurator/listener.yue:104
      if 'network-packet' == _exp_0 then -- shunt/configurator/listener.yue:105
        local _call_0 = self.sm -- shunt/configurator/listener.yue:106
        return _call_0["goto"](_call_0, 'inspecting_packet', { -- shunt/configurator/listener.yue:107
          packet = event.packet -- shunt/configurator/listener.yue:107
        }) -- shunt/configurator/listener.yue:106
      else -- shunt/configurator/listener.yue:109
        return error("internal error: unrecognised event type '" .. tostring(event.type) .. "'") -- shunt/configurator/listener.yue:109
      end -- shunt/configurator/listener.yue:109
    end), -- shunt/configurator/listener.yue:111
    on_inspecting_packet = F('() => <>', function(self) -- shunt/configurator/listener.yue:111
      local packet = self.sm.state.packet -- shunt/configurator/listener.yue:112
      local _exp_0 = packet.protocol -- shunt/configurator/listener.yue:113
      if 'GetConfigRequest' == _exp_0 then -- shunt/configurator/listener.yue:114
        local _call_0 = self.sm -- shunt/configurator/listener.yue:115
        return _call_0["goto"](_call_0, 'analysing_get_config_request', { -- shunt/configurator/listener.yue:116
          packet = packet -- shunt/configurator/listener.yue:116
        }) -- shunt/configurator/listener.yue:115
      elseif 'SetConfigRequest' == _exp_0 then -- shunt/configurator/listener.yue:117
        local _call_0 = self.sm -- shunt/configurator/listener.yue:118
        return _call_0["goto"](_call_0, 'analysing_set_config_request', { -- shunt/configurator/listener.yue:119
          packet = packet -- shunt/configurator/listener.yue:119
        }) -- shunt/configurator/listener.yue:118
      else -- shunt/configurator/listener.yue:121
        local repr = require('shunt.spec').repr -- shunt/configurator/listener.yue:0
        return error("internal error: unhandled packet admitted through firewall: " .. tostring(repr(protocol))) -- shunt/configurator/listener.yue:122
      end -- shunt/configurator/listener.yue:122
    end), -- shunt/configurator/listener.yue:124
    on_analysing_get_config_request = F('() => <>', function(self) -- shunt/configurator/listener.yue:124
      local idemp_tok, pc_id -- shunt/configurator/listener.yue:125
      do -- shunt/configurator/listener.yue:125
        local _obj_0 = self.sm.state -- shunt/configurator/listener.yue:129
        idemp_tok, pc_id = _obj_0.packet.idemp_tok, _obj_0.packet.pc_id -- shunt/configurator/listener.yue:125
      end -- shunt/configurator/listener.yue:129
      local _call_0 = self.sm -- shunt/configurator/listener.yue:130
      return _call_0["goto"](_call_0, 'sending_get_config_response', { -- shunt/configurator/listener.yue:131
        idemp_tok = idemp_tok, -- shunt/configurator/listener.yue:131
        recipient_id = pc_id, -- shunt/configurator/listener.yue:132
        raw = getmetatable(self.target.config).__raw -- shunt/configurator/listener.yue:133
      }) -- shunt/configurator/listener.yue:130
    end), -- shunt/configurator/listener.yue:135
    on_sending_get_config_response = F('() => <>', function(self) -- shunt/configurator/listener.yue:135
      local idemp_tok, recipient_id, raw -- shunt/configurator/listener.yue:136
      do -- shunt/configurator/listener.yue:136
        local _obj_0 = self.sm.state -- shunt/configurator/listener.yue:136
        idemp_tok, recipient_id, raw = _obj_0.idemp_tok, _obj_0.recipient_id, _obj_0.raw -- shunt/configurator/listener.yue:136
      end -- shunt/configurator/listener.yue:136
      self.uplink:send_to(recipient_id, GetConfigResponse(idemp_tok, raw)) -- shunt/configurator/listener.yue:137
      local _call_0 = self.sm -- shunt/configurator/listener.yue:138
      return _call_0["goto"](_call_0, 'waiting') -- shunt/configurator/listener.yue:138
    end), -- shunt/configurator/listener.yue:140
    on_analysing_set_config_request = F('() => <>', function(self) -- shunt/configurator/listener.yue:140
      local idemp_tok, pc_id, raw -- shunt/configurator/listener.yue:141
      do -- shunt/configurator/listener.yue:141
        local _obj_0 = self.sm.state -- shunt/configurator/listener.yue:146
        idemp_tok, pc_id, raw = _obj_0.packet.idemp_tok, _obj_0.packet.pc_id, _obj_0.packet.raw -- shunt/configurator/listener.yue:141
      end -- shunt/configurator/listener.yue:146
      local config, error_reason = toml.decode(raw) -- shunt/configurator/listener.yue:147
      if (err ~= nil) then -- shunt/configurator/listener.yue:148
        local _call_0 = self.sm -- shunt/configurator/listener.yue:149
        _call_0["goto"](_call_0, 'sending_set_config_response', { -- shunt/configurator/listener.yue:150
          idemp_tok = idemp_tok, -- shunt/configurator/listener.yue:150
          recipient_id = pc_id, -- shunt/configurator/listener.yue:151
          response = { -- shunt/configurator/listener.yue:153
            error_reason = error_reason -- shunt/configurator/listener.yue:153
          } -- shunt/configurator/listener.yue:152
        }) -- shunt/configurator/listener.yue:149
        return -- shunt/configurator/listener.yue:154
      end -- shunt/configurator/listener.yue:148
      local ok -- shunt/configurator/listener.yue:156
      ok, error_reason = is(self.config_type, config) -- shunt/configurator/listener.yue:156
      if not ok then -- shunt/configurator/listener.yue:157
        local _call_0 = self.sm -- shunt/configurator/listener.yue:158
        _call_0["goto"](_call_0, 'sending_set_config_response', { -- shunt/configurator/listener.yue:159
          idemp_tok = idemp_tok, -- shunt/configurator/listener.yue:159
          recipient_id = pc_id, -- shunt/configurator/listener.yue:160
          response = { -- shunt/configurator/listener.yue:162
            error_reason = error_reason -- shunt/configurator/listener.yue:162
          } -- shunt/configurator/listener.yue:161
        }) -- shunt/configurator/listener.yue:158
        return -- shunt/configurator/listener.yue:163
      end -- shunt/configurator/listener.yue:157
      setmetatable(config, { }) -- shunt/configurator/listener.yue:165
      getmetatable(config).__raw = raw -- shunt/configurator/listener.yue:166
      local _call_0 = self.sm -- shunt/configurator/listener.yue:167
      return _call_0["goto"](_call_0, 'sending_set_config_response', { -- shunt/configurator/listener.yue:168
        idemp_tok = idemp_tok, -- shunt/configurator/listener.yue:168
        recipient_id = pc_id, -- shunt/configurator/listener.yue:169
        response = { -- shunt/configurator/listener.yue:171
          config = config -- shunt/configurator/listener.yue:171
        } -- shunt/configurator/listener.yue:170
      }) -- shunt/configurator/listener.yue:167
    end), -- shunt/configurator/listener.yue:173
    on_sending_set_config_response = F('() => <>', function(self) -- shunt/configurator/listener.yue:173
      local idemp_tok, recipient_id, config, error_reason -- shunt/configurator/listener.yue:174
      do -- shunt/configurator/listener.yue:174
        local _obj_0 = self.sm.state -- shunt/configurator/listener.yue:180
        idemp_tok, recipient_id, config, error_reason = _obj_0.idemp_tok, _obj_0.recipient_id, _obj_0.response.config, _obj_0.response.error_reason -- shunt/configurator/listener.yue:174
      end -- shunt/configurator/listener.yue:180
      if (config ~= nil) then -- shunt/configurator/listener.yue:181
        self.uplink:send_to(recipient_id, SetConfigResponse(idemp_tok, nil)) -- shunt/configurator/listener.yue:182
        local _call_0 = self.sm -- shunt/configurator/listener.yue:183
        return _call_0["goto"](_call_0, 'scheduling_config_application', { -- shunt/configurator/listener.yue:184
          config = config -- shunt/configurator/listener.yue:184
        }) -- shunt/configurator/listener.yue:183
      else -- shunt/configurator/listener.yue:185
        if (error_reason ~= nil) then -- shunt/configurator/listener.yue:185
          self.uplink:send_to(recipient_id, SetConfigResponse(idemp_tok, error_reason)) -- shunt/configurator/listener.yue:186
          local _call_0 = self.sm -- shunt/configurator/listener.yue:187
          return _call_0["goto"](_call_0, 'waiting') -- shunt/configurator/listener.yue:187
        else -- shunt/configurator/listener.yue:189
          return error('unreachable') -- shunt/configurator/listener.yue:189
        end -- shunt/configurator/listener.yue:185
      end -- shunt/configurator/listener.yue:181
    end), -- shunt/configurator/listener.yue:191
    on_scheduling_config_application = F('() => <>', function(self) -- shunt/configurator/listener.yue:191
      local config = self.sm.state.config -- shunt/configurator/listener.yue:192
      self.target.events:enqueue({ -- shunt/configurator/listener.yue:194
        type = 'new-config', -- shunt/configurator/listener.yue:194
        config = config -- shunt/configurator/listener.yue:195
      }) -- shunt/configurator/listener.yue:193
      local _call_0 = self.sm -- shunt/configurator/listener.yue:196
      return _call_0["goto"](_call_0, 'waiting') -- shunt/configurator/listener.yue:196
    end) -- shunt/configurator/listener.yue:20
  } -- shunt/configurator/listener.yue:20
  if _base_0.__index == nil then -- shunt/configurator/listener.yue:20
    _base_0.__index = _base_0 -- shunt/configurator/listener.yue:20
  end -- shunt/configurator/listener.yue:196
  _class_0 = setmetatable({ -- shunt/configurator/listener.yue:20
    __init = F('(ConfigListenerOpts) => <>', function(self, opts) -- shunt/configurator/listener.yue:21
      local config_type, target, uplink = opts.config_type, opts.target, opts.uplink -- shunt/configurator/listener.yue:22
      self.config_type = config_type -- shunt/configurator/listener.yue:27
      self.target = target -- shunt/configurator/listener.yue:28
      self.uplink = uplink -- shunt/configurator/listener.yue:29
      self.events = Queue('ConfigListenerEvent') -- shunt/configurator/listener.yue:31
      self.firewall = Firewall({ -- shunt/configurator/listener.yue:34
        GetConfigRequest, -- shunt/configurator/listener.yue:34
        SetConfigRequest -- shunt/configurator/listener.yue:35
      }) -- shunt/configurator/listener.yue:33
      self.sm = self.__class:make_sm() -- shunt/configurator/listener.yue:36
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/configurator/listener.yue:37
    end), -- shunt/configurator/listener.yue:20
    __base = _base_0, -- shunt/configurator/listener.yue:20
    __name = "ConfigListener" -- shunt/configurator/listener.yue:20
  }, { -- shunt/configurator/listener.yue:20
    __index = _base_0, -- shunt/configurator/listener.yue:20
    __call = function(cls, ...) -- shunt/configurator/listener.yue:20
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/listener.yue:20
      cls.__init(_self_0, ...) -- shunt/configurator/listener.yue:20
      return _self_0 -- shunt/configurator/listener.yue:20
    end -- shunt/configurator/listener.yue:20
  }) -- shunt/configurator/listener.yue:20
  _base_0.__class = _class_0 -- shunt/configurator/listener.yue:20
  local self = _class_0; -- shunt/configurator/listener.yue:20
  self.make_sm = F('() => StateMachine', function(self) -- shunt/configurator/listener.yue:39
    return (StateMachineBuilder('config_listener')):set_initial_state('waiting'):declare_endless():set_reporter(shallow_log_reporter):add((State('waiting')):add_transition_to('inspecting_packet')):add((State('inspecting_packet')):set_data_type([[{
          packet: Packet,
        }]]):add_transition_to('analysing_get_config_request'):add_transition_to('analysing_set_config_request')):add((State('analysing_get_config_request')):set_data_type([[{
          packet: GetConfigRequest,
        }]]):add_transition_to('sending_get_config_response')):add((State('sending_get_config_response')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          recipient_id: number,
          raw: string,
        }]]):add_transition_to('waiting')):add((State('analysing_set_config_request')):set_data_type([[{
          packet: SetConfigRequest,
        }]]):add_transition_to('sending_set_config_response')):add((State('sending_set_config_response')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          recipient_id: number,
          response: { config: {} }
            | { error_reason: string },
          error: ?string,
        }]]):add_transition_to('scheduling_config_application'):add_transition_to('waiting')):add((State('scheduling_config_application')):set_data_type([[{
          config: {},
        }]]):add_transition_to('waiting')):build() -- shunt/configurator/listener.yue:84
  end) -- shunt/configurator/listener.yue:39
  ConfigListener = _class_0 -- shunt/configurator/listener.yue:20
end -- shunt/configurator/listener.yue:196
_module_0["ConfigListener"] = ConfigListener -- shunt/configurator/listener.yue:20
return _module_0 -- shunt/configurator/listener.yue:196
end
package.preload['shunt.configurator.main'] = function(...)
-- [yue]: shunt/configurator/main.yue
local _module_0 = { } -- shunt/configurator/main.yue:1
local MarshalIdentityRequest -- shunt/configurator/main.yue:3
local MarshalIdentityResponse -- shunt/configurator/main.yue:4
local GetConfigRequest -- shunt/configurator/main.yue:5
local GetConfigResponse -- shunt/configurator/main.yue:6
local SetConfigRequest -- shunt/configurator/main.yue:7
local SetConfigResponse -- shunt/configurator/main.yue:8
local ABORT, Editor -- shunt/configurator/main.yue:0
do -- shunt/configurator/main.yue:0
  local _obj_0 = require('shunt.configurator.editor') -- shunt/configurator/main.yue:0
  ABORT, Editor = _obj_0.ABORT, _obj_0.Editor -- shunt/configurator/main.yue:0
end -- shunt/configurator/main.yue:0
local Pc = require('shunt.pc').Pc -- shunt/configurator/main.yue:0
local IdempotenceToken, Packet, TIMEOUT, Uplink -- shunt/configurator/main.yue:0
do -- shunt/configurator/main.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/configurator/main.yue:0
  IdempotenceToken, Packet, TIMEOUT, Uplink = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.TIMEOUT, _obj_0.Uplink -- shunt/configurator/main.yue:0
end -- shunt/configurator/main.yue:0
local declare_type, F, is, T -- shunt/configurator/main.yue:0
do -- shunt/configurator/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/configurator/main.yue:0
  declare_type, F, is, T = _obj_0.declare_type, _obj_0.F, _obj_0.is, _obj_0.T -- shunt/configurator/main.yue:0
end -- shunt/configurator/main.yue:0
local spec = require('shunt.spec').spec -- shunt/configurator/main.yue:0
local toml = require('shunt.toml') -- shunt/configurator/main.yue:16
local Configurator -- shunt/configurator/main.yue:18
do -- shunt/configurator/main.yue:18
  local _class_0 -- shunt/configurator/main.yue:18
  local _base_0 = { -- shunt/configurator/main.yue:18
    get_pc_id = F('(string|"marshal") => <?number, ?string>', function(self, name) -- shunt/configurator/main.yue:21
      local name_to_request -- shunt/configurator/main.yue:22
      if 'marshal' == name then -- shunt/configurator/main.yue:23
        name_to_request = nil -- shunt/configurator/main.yue:24
      else -- shunt/configurator/main.yue:26
        name_to_request = name -- shunt/configurator/main.yue:26
      end -- shunt/configurator/main.yue:26
      local MAX_ATTEMPTS = 3 -- shunt/configurator/main.yue:28
      for i = 1, MAX_ATTEMPTS do -- shunt/configurator/main.yue:29
        local _continue_0 = false -- shunt/configurator/main.yue:30
        repeat -- shunt/configurator/main.yue:30
          if i > 1 then -- shunt/configurator/main.yue:30
            print("getting marshal PC ID... (attempt " .. tostring(i) .. "/" .. tostring(MAX_ATTEMPTS) .. ")") -- shunt/configurator/main.yue:31
          end -- shunt/configurator/main.yue:30
          local idemp_tok = IdempotenceToken() -- shunt/configurator/main.yue:33
          self.uplink:broadcast(MarshalIdentityRequest(idemp_tok, self.pc:id(), name_to_request)) -- shunt/configurator/main.yue:34
          local _, resp = self.uplink:receive_from_any(MarshalIdentityResponse, { -- shunt/configurator/main.yue:35
            timeout = 5 -- shunt/configurator/main.yue:35
          }) -- shunt/configurator/main.yue:35
          if resp == TIMEOUT then -- shunt/configurator/main.yue:36
            _continue_0 = true -- shunt/configurator/main.yue:37
            break -- shunt/configurator/main.yue:37
          end -- shunt/configurator/main.yue:36
          if resp.idemp_tok ~= idemp_tok then -- shunt/configurator/main.yue:38
            _continue_0 = true -- shunt/configurator/main.yue:39
            break -- shunt/configurator/main.yue:39
          end -- shunt/configurator/main.yue:38
          if 'number' ~= type(resp.resp) then -- shunt/configurator/main.yue:40
            return nil, resp.resp -- shunt/configurator/main.yue:41
          end -- shunt/configurator/main.yue:40
          do -- shunt/configurator/main.yue:42
            return resp.resp, nil -- shunt/configurator/main.yue:42
          end -- shunt/configurator/main.yue:42
          _continue_0 = true -- shunt/configurator/main.yue:30
        until true -- shunt/configurator/main.yue:42
        if not _continue_0 then -- shunt/configurator/main.yue:42
          break -- shunt/configurator/main.yue:42
        end -- shunt/configurator/main.yue:42
      end -- shunt/configurator/main.yue:42
      return nil, "cannot find marshal after " .. tostring(MAX_ATTEMPTS) .. " attempts" -- shunt/configurator/main.yue:43
    end), -- shunt/configurator/main.yue:45
    configure = F('(number, string, ?boolean) => ?string', function(self, pc_id, what, prompt) -- shunt/configurator/main.yue:45
      if prompt == nil then -- shunt/configurator/main.yue:45
        prompt = true -- shunt/configurator/main.yue:45
      end -- shunt/configurator/main.yue:45
      local config, err = self:get_config(pc_id) -- shunt/configurator/main.yue:46
      if err ~= nil then -- shunt/configurator/main.yue:47
        return err -- shunt/configurator/main.yue:48
      end -- shunt/configurator/main.yue:47
      local on_attempt -- shunt/configurator/main.yue:50
      if prompt then -- shunt/configurator/main.yue:51
        do -- shunt/configurator/main.yue:52
          local _base_1 = self.__class -- shunt/configurator/main.yue:52
          local _fn_0 = _base_1.ask_permission_on_attempt -- shunt/configurator/main.yue:52
          on_attempt = _fn_0 and function(...) -- shunt/configurator/main.yue:52
            return _fn_0(_base_1, ...) -- shunt/configurator/main.yue:52
          end -- shunt/configurator/main.yue:52
        end -- shunt/configurator/main.yue:52
      end -- shunt/configurator/main.yue:51
      local checker = self.__class:config_checker(what) -- shunt/configurator/main.yue:54
      config, err = self.editor:edit_text(config, "shunt.toml (" .. tostring(what) .. ")", checker, on_attempt) -- shunt/configurator/main.yue:55
      if (err ~= nil) then -- shunt/configurator/main.yue:56
        return err -- shunt/configurator/main.yue:57
      end -- shunt/configurator/main.yue:56
      return self:set_config(pc_id, config) -- shunt/configurator/main.yue:59
    end), -- shunt/configurator/main.yue:61
    get_config = F('(number) => <?string, ?string>', function(self, pc_id) -- shunt/configurator/main.yue:61
      local MAX_ATTEMPTS = 3 -- shunt/configurator/main.yue:62
      for i = 1, MAX_ATTEMPTS do -- shunt/configurator/main.yue:63
        local _continue_0 = false -- shunt/configurator/main.yue:64
        repeat -- shunt/configurator/main.yue:64
          if i > 1 then -- shunt/configurator/main.yue:64
            print("getting config... (attempt " .. tostring(i) .. "/" .. tostring(MAX_ATTEMPTS) .. ")") -- shunt/configurator/main.yue:65
          end -- shunt/configurator/main.yue:64
          local idemp_tok = IdempotenceToken() -- shunt/configurator/main.yue:67
          self.uplink:send_to(pc_id, GetConfigRequest(idemp_tok, self.pc:id())) -- shunt/configurator/main.yue:68
          local _, resp = self.uplink:receive_from_any(GetConfigResponse, { -- shunt/configurator/main.yue:69
            timeout = 5 -- shunt/configurator/main.yue:69
          }) -- shunt/configurator/main.yue:69
          if resp == TIMEOUT then -- shunt/configurator/main.yue:70
            _continue_0 = true -- shunt/configurator/main.yue:71
            break -- shunt/configurator/main.yue:71
          end -- shunt/configurator/main.yue:70
          if resp.idemp_tok ~= idemp_tok then -- shunt/configurator/main.yue:72
            _continue_0 = true -- shunt/configurator/main.yue:73
            break -- shunt/configurator/main.yue:73
          end -- shunt/configurator/main.yue:72
          do -- shunt/configurator/main.yue:74
            return resp.raw, nil -- shunt/configurator/main.yue:74
          end -- shunt/configurator/main.yue:74
          _continue_0 = true -- shunt/configurator/main.yue:64
        until true -- shunt/configurator/main.yue:74
        if not _continue_0 then -- shunt/configurator/main.yue:74
          break -- shunt/configurator/main.yue:74
        end -- shunt/configurator/main.yue:74
      end -- shunt/configurator/main.yue:74
      return nil, "cannot find marshal after " .. tostring(MAX_ATTEMPTS) .. " attempts" -- shunt/configurator/main.yue:76
    end), -- shunt/configurator/main.yue:78
    set_config = F('(number, string) => ?string', function(self, pc_id, config) -- shunt/configurator/main.yue:78
      local MAX_ATTEMPTS = 5 -- shunt/configurator/main.yue:79
      for i = 1, MAX_ATTEMPTS do -- shunt/configurator/main.yue:80
        local _continue_0 = false -- shunt/configurator/main.yue:81
        repeat -- shunt/configurator/main.yue:81
          if i > 1 then -- shunt/configurator/main.yue:81
            print("setting config... (attempt " .. tostring(i) .. "/" .. tostring(MAX_ATTEMPTS) .. ")") -- shunt/configurator/main.yue:82
          end -- shunt/configurator/main.yue:81
          local idemp_tok = IdempotenceToken() -- shunt/configurator/main.yue:84
          self.uplink:send_to(pc_id, SetConfigRequest(idemp_tok, self.pc:id(), config)) -- shunt/configurator/main.yue:85
          local _, resp = self.uplink:receive_from_any(SetConfigResponse, { -- shunt/configurator/main.yue:86
            timeout = 5 -- shunt/configurator/main.yue:86
          }) -- shunt/configurator/main.yue:86
          if resp == TIMEOUT then -- shunt/configurator/main.yue:87
            _continue_0 = true -- shunt/configurator/main.yue:88
            break -- shunt/configurator/main.yue:88
          end -- shunt/configurator/main.yue:87
          if resp.idemp_tok ~= idemp_tok then -- shunt/configurator/main.yue:89
            break -- shunt/configurator/main.yue:90
          end -- shunt/configurator/main.yue:89
          do -- shunt/configurator/main.yue:91
            return resp.error_reason -- shunt/configurator/main.yue:91
          end -- shunt/configurator/main.yue:91
          _continue_0 = true -- shunt/configurator/main.yue:81
        until true -- shunt/configurator/main.yue:91
        if not _continue_0 then -- shunt/configurator/main.yue:91
          break -- shunt/configurator/main.yue:91
        end -- shunt/configurator/main.yue:91
      end -- shunt/configurator/main.yue:91
      return "cannot find pc #" .. tostring(pc_id) .. " after " .. tostring(MAX_ATTEMPTS) .. " attempts" -- shunt/configurator/main.yue:93
    end) -- shunt/configurator/main.yue:18
  } -- shunt/configurator/main.yue:18
  if _base_0.__index == nil then -- shunt/configurator/main.yue:18
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:18
  end -- shunt/configurator/main.yue:121
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:18
    __init = F('(?Pc, ?Uplink, ?Editor) => <>', function(self, pc, uplink, editor) -- shunt/configurator/main.yue:19
      if pc == nil then -- shunt/configurator/main.yue:19
        pc = Pc() -- shunt/configurator/main.yue:19
      end -- shunt/configurator/main.yue:19
      if uplink == nil then -- shunt/configurator/main.yue:19
        uplink = Uplink() -- shunt/configurator/main.yue:19
      end -- shunt/configurator/main.yue:19
      if editor == nil then -- shunt/configurator/main.yue:19
        editor = Editor() -- shunt/configurator/main.yue:19
      end -- shunt/configurator/main.yue:19
      self.pc = pc -- shunt/configurator/main.yue:19
      self.uplink = uplink -- shunt/configurator/main.yue:19
      self.editor = editor -- shunt/configurator/main.yue:19
    end), -- shunt/configurator/main.yue:18
    __base = _base_0, -- shunt/configurator/main.yue:18
    __name = "Configurator" -- shunt/configurator/main.yue:18
  }, { -- shunt/configurator/main.yue:18
    __index = _base_0, -- shunt/configurator/main.yue:18
    __call = function(cls, ...) -- shunt/configurator/main.yue:18
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:18
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:18
      return _self_0 -- shunt/configurator/main.yue:18
    end -- shunt/configurator/main.yue:18
  }) -- shunt/configurator/main.yue:18
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:18
  local self = _class_0; -- shunt/configurator/main.yue:18
  self.expected_instance_types = T('{string->string}', { -- shunt/configurator/main.yue:96
    marshal = 'MarshalConfig', -- shunt/configurator/main.yue:96
    factory = 'FactoryConfig' -- shunt/configurator/main.yue:97
  }) -- shunt/configurator/main.yue:95
  self.config_checker = F('(string) => (string) -> boolean', function(self, instance_type) -- shunt/configurator/main.yue:98
    local expected_type = self.expected_instance_types[instance_type] -- shunt/configurator/main.yue:99
    if not (expected_type ~= nil) then -- shunt/configurator/main.yue:100
      error("internal error: unknown instance type " .. tostring(instance_type)) -- shunt/configurator/main.yue:101
    end -- shunt/configurator/main.yue:100
    return F('(string) -> boolean', function(raw) -- shunt/configurator/main.yue:103
      local config, err = toml.decode(raw) -- shunt/configurator/main.yue:104
      if (err ~= nil) then -- shunt/configurator/main.yue:105
        print(err) -- shunt/configurator/main.yue:106
        return false -- shunt/configurator/main.yue:107
      end -- shunt/configurator/main.yue:105
      local _ -- shunt/configurator/main.yue:108
      _, err = is(expected_type, config) -- shunt/configurator/main.yue:108
      if (err ~= nil) then -- shunt/configurator/main.yue:109
        print(err) -- shunt/configurator/main.yue:110
        return false -- shunt/configurator/main.yue:111
      end -- shunt/configurator/main.yue:109
      return true -- shunt/configurator/main.yue:112
    end) -- shunt/configurator/main.yue:112
  end) -- shunt/configurator/main.yue:98
  self.ask_permission_on_attempt = F('(string, number) => ?ABORT', function(self, file_name, attempt) -- shunt/configurator/main.yue:114
    print("press [ENTER] edit " .. tostring(file_name) .. ", [q] to abort") -- shunt/configurator/main.yue:115
    local resp = io.read('*l') -- shunt/configurator/main.yue:116
    if 'q' == resp then -- shunt/configurator/main.yue:118
      return ABORT -- shunt/configurator/main.yue:119
    elseif '' == resp then -- shunt/configurator/main.yue:120
      return nil -- shunt/configurator/main.yue:121
    end -- shunt/configurator/main.yue:121
  end) -- shunt/configurator/main.yue:114
  Configurator = _class_0 -- shunt/configurator/main.yue:18
end -- shunt/configurator/main.yue:121
_module_0["Configurator"] = Configurator -- shunt/configurator/main.yue:18
declare_type('MarshalIdentityRequest', [[{
  idemp_tok: IdempotenceToken,
  pc_id: number,
  name: ?string,
}]]) -- shunt/configurator/main.yue:123
do -- shunt/configurator/main.yue:128
  local _class_0 -- shunt/configurator/main.yue:128
  local _parent_0 = Packet -- shunt/configurator/main.yue:128
  local _base_0 = { } -- shunt/configurator/main.yue:128
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:130
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:128
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:128
    end -- shunt/configurator/main.yue:128
  end -- shunt/configurator/main.yue:130
  if _base_0.__index == nil then -- shunt/configurator/main.yue:128
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:128
  end -- shunt/configurator/main.yue:130
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:128
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:128
    __init = F('(IdempotenceToken, number, ?string) => <>', function(self, idemp_tok, pc_id, name) -- shunt/configurator/main.yue:129
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:129
      self.pc_id = pc_id -- shunt/configurator/main.yue:129
      self.name = name -- shunt/configurator/main.yue:129
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:130
    end), -- shunt/configurator/main.yue:128
    __base = _base_0, -- shunt/configurator/main.yue:128
    __name = "MarshalIdentityRequest", -- shunt/configurator/main.yue:128
    __parent = _parent_0 -- shunt/configurator/main.yue:128
  }, { -- shunt/configurator/main.yue:128
    __index = function(cls, name) -- shunt/configurator/main.yue:128
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:128
      if val == nil then -- shunt/configurator/main.yue:128
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:128
        if parent then -- shunt/configurator/main.yue:128
          return parent[name] -- shunt/configurator/main.yue:128
        end -- shunt/configurator/main.yue:128
      else -- shunt/configurator/main.yue:128
        return val -- shunt/configurator/main.yue:128
      end -- shunt/configurator/main.yue:128
    end, -- shunt/configurator/main.yue:128
    __call = function(cls, ...) -- shunt/configurator/main.yue:128
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:128
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:128
      return _self_0 -- shunt/configurator/main.yue:128
    end -- shunt/configurator/main.yue:128
  }) -- shunt/configurator/main.yue:128
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:128
  if _parent_0.__inherited then -- shunt/configurator/main.yue:128
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:128
  end -- shunt/configurator/main.yue:128
  MarshalIdentityRequest = _class_0 -- shunt/configurator/main.yue:128
end -- shunt/configurator/main.yue:130
_module_0["MarshalIdentityRequest"] = MarshalIdentityRequest -- shunt/configurator/main.yue:128
declare_type('MarshalIdentityResponse', [[{
  idemp_tok: IdempotenceToken,
  resp: number|string,
}]]) -- shunt/configurator/main.yue:132
do -- shunt/configurator/main.yue:136
  local _class_0 -- shunt/configurator/main.yue:136
  local _parent_0 = Packet -- shunt/configurator/main.yue:136
  local _base_0 = { } -- shunt/configurator/main.yue:136
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:138
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:136
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:136
    end -- shunt/configurator/main.yue:136
  end -- shunt/configurator/main.yue:138
  if _base_0.__index == nil then -- shunt/configurator/main.yue:136
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:136
  end -- shunt/configurator/main.yue:138
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:136
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:136
    __init = F('(IdempotenceToken, number|string) => <>', function(self, idemp_tok, resp) -- shunt/configurator/main.yue:137
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:137
      self.resp = resp -- shunt/configurator/main.yue:137
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:138
    end), -- shunt/configurator/main.yue:136
    __base = _base_0, -- shunt/configurator/main.yue:136
    __name = "MarshalIdentityResponse", -- shunt/configurator/main.yue:136
    __parent = _parent_0 -- shunt/configurator/main.yue:136
  }, { -- shunt/configurator/main.yue:136
    __index = function(cls, name) -- shunt/configurator/main.yue:136
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:136
      if val == nil then -- shunt/configurator/main.yue:136
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:136
        if parent then -- shunt/configurator/main.yue:136
          return parent[name] -- shunt/configurator/main.yue:136
        end -- shunt/configurator/main.yue:136
      else -- shunt/configurator/main.yue:136
        return val -- shunt/configurator/main.yue:136
      end -- shunt/configurator/main.yue:136
    end, -- shunt/configurator/main.yue:136
    __call = function(cls, ...) -- shunt/configurator/main.yue:136
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:136
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:136
      return _self_0 -- shunt/configurator/main.yue:136
    end -- shunt/configurator/main.yue:136
  }) -- shunt/configurator/main.yue:136
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:136
  if _parent_0.__inherited then -- shunt/configurator/main.yue:136
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:136
  end -- shunt/configurator/main.yue:136
  MarshalIdentityResponse = _class_0 -- shunt/configurator/main.yue:136
end -- shunt/configurator/main.yue:138
_module_0["MarshalIdentityResponse"] = MarshalIdentityResponse -- shunt/configurator/main.yue:136
declare_type('GetConfigRequest', [[{
  idemp_tok: IdempotenceToken,
  pc_id: number,
}]]) -- shunt/configurator/main.yue:140
do -- shunt/configurator/main.yue:144
  local _class_0 -- shunt/configurator/main.yue:144
  local _parent_0 = Packet -- shunt/configurator/main.yue:144
  local _base_0 = { } -- shunt/configurator/main.yue:144
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:146
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:144
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:144
    end -- shunt/configurator/main.yue:144
  end -- shunt/configurator/main.yue:146
  if _base_0.__index == nil then -- shunt/configurator/main.yue:144
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:144
  end -- shunt/configurator/main.yue:146
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:144
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:144
    __init = F('(IdempotenceToken, number) => <>', function(self, idemp_tok, pc_id) -- shunt/configurator/main.yue:145
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:145
      self.pc_id = pc_id -- shunt/configurator/main.yue:145
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:146
    end), -- shunt/configurator/main.yue:144
    __base = _base_0, -- shunt/configurator/main.yue:144
    __name = "GetConfigRequest", -- shunt/configurator/main.yue:144
    __parent = _parent_0 -- shunt/configurator/main.yue:144
  }, { -- shunt/configurator/main.yue:144
    __index = function(cls, name) -- shunt/configurator/main.yue:144
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:144
      if val == nil then -- shunt/configurator/main.yue:144
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:144
        if parent then -- shunt/configurator/main.yue:144
          return parent[name] -- shunt/configurator/main.yue:144
        end -- shunt/configurator/main.yue:144
      else -- shunt/configurator/main.yue:144
        return val -- shunt/configurator/main.yue:144
      end -- shunt/configurator/main.yue:144
    end, -- shunt/configurator/main.yue:144
    __call = function(cls, ...) -- shunt/configurator/main.yue:144
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:144
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:144
      return _self_0 -- shunt/configurator/main.yue:144
    end -- shunt/configurator/main.yue:144
  }) -- shunt/configurator/main.yue:144
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:144
  if _parent_0.__inherited then -- shunt/configurator/main.yue:144
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:144
  end -- shunt/configurator/main.yue:144
  GetConfigRequest = _class_0 -- shunt/configurator/main.yue:144
end -- shunt/configurator/main.yue:146
_module_0["GetConfigRequest"] = GetConfigRequest -- shunt/configurator/main.yue:144
do -- shunt/configurator/main.yue:148
  local _class_0 -- shunt/configurator/main.yue:148
  local _parent_0 = Packet -- shunt/configurator/main.yue:148
  local _base_0 = { } -- shunt/configurator/main.yue:148
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:150
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:148
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:148
    end -- shunt/configurator/main.yue:148
  end -- shunt/configurator/main.yue:150
  if _base_0.__index == nil then -- shunt/configurator/main.yue:148
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:148
  end -- shunt/configurator/main.yue:150
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:148
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:148
    __init = F('(IdempotenceToken, ?string) => <>', function(self, idemp_tok, raw) -- shunt/configurator/main.yue:149
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:149
      self.raw = raw -- shunt/configurator/main.yue:149
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:150
    end), -- shunt/configurator/main.yue:148
    __base = _base_0, -- shunt/configurator/main.yue:148
    __name = "GetConfigResponse", -- shunt/configurator/main.yue:148
    __parent = _parent_0 -- shunt/configurator/main.yue:148
  }, { -- shunt/configurator/main.yue:148
    __index = function(cls, name) -- shunt/configurator/main.yue:148
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:148
      if val == nil then -- shunt/configurator/main.yue:148
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:148
        if parent then -- shunt/configurator/main.yue:148
          return parent[name] -- shunt/configurator/main.yue:148
        end -- shunt/configurator/main.yue:148
      else -- shunt/configurator/main.yue:148
        return val -- shunt/configurator/main.yue:148
      end -- shunt/configurator/main.yue:148
    end, -- shunt/configurator/main.yue:148
    __call = function(cls, ...) -- shunt/configurator/main.yue:148
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:148
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:148
      return _self_0 -- shunt/configurator/main.yue:148
    end -- shunt/configurator/main.yue:148
  }) -- shunt/configurator/main.yue:148
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:148
  if _parent_0.__inherited then -- shunt/configurator/main.yue:148
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:148
  end -- shunt/configurator/main.yue:148
  GetConfigResponse = _class_0 -- shunt/configurator/main.yue:148
end -- shunt/configurator/main.yue:150
_module_0["GetConfigResponse"] = GetConfigResponse -- shunt/configurator/main.yue:148
declare_type('SetConfigRequest', [[{
  idemp_tok: IdempotenceToken,
  pc_id: number,
  raw: string,
}]]) -- shunt/configurator/main.yue:152
do -- shunt/configurator/main.yue:157
  local _class_0 -- shunt/configurator/main.yue:157
  local _parent_0 = Packet -- shunt/configurator/main.yue:157
  local _base_0 = { } -- shunt/configurator/main.yue:157
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:159
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:157
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:157
    end -- shunt/configurator/main.yue:157
  end -- shunt/configurator/main.yue:159
  if _base_0.__index == nil then -- shunt/configurator/main.yue:157
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:157
  end -- shunt/configurator/main.yue:159
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:157
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:157
    __init = F('(IdempotenceToken, number, string) => <>', function(self, idemp_tok, pc_id, raw) -- shunt/configurator/main.yue:158
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:158
      self.pc_id = pc_id -- shunt/configurator/main.yue:158
      self.raw = raw -- shunt/configurator/main.yue:158
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:159
    end), -- shunt/configurator/main.yue:157
    __base = _base_0, -- shunt/configurator/main.yue:157
    __name = "SetConfigRequest", -- shunt/configurator/main.yue:157
    __parent = _parent_0 -- shunt/configurator/main.yue:157
  }, { -- shunt/configurator/main.yue:157
    __index = function(cls, name) -- shunt/configurator/main.yue:157
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:157
      if val == nil then -- shunt/configurator/main.yue:157
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:157
        if parent then -- shunt/configurator/main.yue:157
          return parent[name] -- shunt/configurator/main.yue:157
        end -- shunt/configurator/main.yue:157
      else -- shunt/configurator/main.yue:157
        return val -- shunt/configurator/main.yue:157
      end -- shunt/configurator/main.yue:157
    end, -- shunt/configurator/main.yue:157
    __call = function(cls, ...) -- shunt/configurator/main.yue:157
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:157
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:157
      return _self_0 -- shunt/configurator/main.yue:157
    end -- shunt/configurator/main.yue:157
  }) -- shunt/configurator/main.yue:157
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:157
  if _parent_0.__inherited then -- shunt/configurator/main.yue:157
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:157
  end -- shunt/configurator/main.yue:157
  SetConfigRequest = _class_0 -- shunt/configurator/main.yue:157
end -- shunt/configurator/main.yue:159
_module_0["SetConfigRequest"] = SetConfigRequest -- shunt/configurator/main.yue:157
do -- shunt/configurator/main.yue:161
  local _class_0 -- shunt/configurator/main.yue:161
  local _parent_0 = Packet -- shunt/configurator/main.yue:161
  local _base_0 = { } -- shunt/configurator/main.yue:161
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/configurator/main.yue:163
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/configurator/main.yue:161
      _base_0[_key_0] = _val_0 -- shunt/configurator/main.yue:161
    end -- shunt/configurator/main.yue:161
  end -- shunt/configurator/main.yue:163
  if _base_0.__index == nil then -- shunt/configurator/main.yue:161
    _base_0.__index = _base_0 -- shunt/configurator/main.yue:161
  end -- shunt/configurator/main.yue:163
  setmetatable(_base_0, _parent_0.__base) -- shunt/configurator/main.yue:161
  _class_0 = setmetatable({ -- shunt/configurator/main.yue:161
    __init = F('(IdempotenceToken, ?string) => <>', function(self, idemp_tok, error_reason) -- shunt/configurator/main.yue:162
      self.idemp_tok = idemp_tok -- shunt/configurator/main.yue:162
      self.error_reason = error_reason -- shunt/configurator/main.yue:162
      return _class_0.__parent.__init(self) -- shunt/configurator/main.yue:163
    end), -- shunt/configurator/main.yue:161
    __base = _base_0, -- shunt/configurator/main.yue:161
    __name = "SetConfigResponse", -- shunt/configurator/main.yue:161
    __parent = _parent_0 -- shunt/configurator/main.yue:161
  }, { -- shunt/configurator/main.yue:161
    __index = function(cls, name) -- shunt/configurator/main.yue:161
      local val = rawget(_base_0, name) -- shunt/configurator/main.yue:161
      if val == nil then -- shunt/configurator/main.yue:161
        local parent = rawget(cls, "__parent") -- shunt/configurator/main.yue:161
        if parent then -- shunt/configurator/main.yue:161
          return parent[name] -- shunt/configurator/main.yue:161
        end -- shunt/configurator/main.yue:161
      else -- shunt/configurator/main.yue:161
        return val -- shunt/configurator/main.yue:161
      end -- shunt/configurator/main.yue:161
    end, -- shunt/configurator/main.yue:161
    __call = function(cls, ...) -- shunt/configurator/main.yue:161
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/main.yue:161
      cls.__init(_self_0, ...) -- shunt/configurator/main.yue:161
      return _self_0 -- shunt/configurator/main.yue:161
    end -- shunt/configurator/main.yue:161
  }) -- shunt/configurator/main.yue:161
  _base_0.__class = _class_0 -- shunt/configurator/main.yue:161
  if _parent_0.__inherited then -- shunt/configurator/main.yue:161
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/configurator/main.yue:161
  end -- shunt/configurator/main.yue:161
  SetConfigResponse = _class_0 -- shunt/configurator/main.yue:161
end -- shunt/configurator/main.yue:163
_module_0["SetConfigResponse"] = SetConfigResponse -- shunt/configurator/main.yue:161
spec(function() -- shunt/configurator/main.yue:165
  local TestEditorBackend = require('shunt.configurator.editor').TestEditorBackend -- shunt/configurator/main.yue:0
  local TestPcBackend = require('shunt.pc').TestPcBackend -- shunt/configurator/main.yue:0
  local TestUplinkBackend = require('shunt.peripheral.uplink').TestUplinkBackend -- shunt/configurator/main.yue:0
  local describe, it, matchers -- shunt/configurator/main.yue:0
  do -- shunt/configurator/main.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/configurator/main.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/configurator/main.yue:0
  end -- shunt/configurator/main.yue:0
  local deep_eq, each_value, eq, gt, has_type, has_fields, matches, not_ = matchers.deep_eq, matchers.each_value, matchers.eq, matchers.gt, matchers.has_type, matchers.has_fields, matchers.matches, matchers.not_ -- shunt/configurator/main.yue:173
  return describe('Configurator', function() -- shunt/configurator/main.yue:175
    local CONFIGURATOR_PC_ID = 1 -- shunt/configurator/main.yue:176
    local MARSHAL_PC_ID = 2 -- shunt/configurator/main.yue:177
    local ORIGINAL_CONFIG = [[      [marshal]
    ]] -- shunt/configurator/main.yue:178
    local edited_config = [[      [marshal]
      key = 'value'
    ]] -- shunt/configurator/main.yue:181
    local pc = Pc(TestPcBackend({ -- shunt/configurator/main.yue:187
      id = function(self) -- shunt/configurator/main.yue:187
        return CONFIGURATOR_PC_ID -- shunt/configurator/main.yue:187
      end -- shunt/configurator/main.yue:187
    })) -- shunt/configurator/main.yue:186
    local active_responses = T('{string->boolean}', { }) -- shunt/configurator/main.yue:189
    local idemp_tok -- shunt/configurator/main.yue:190
    local uplink = Uplink(TestUplinkBackend({ -- shunt/configurator/main.yue:192
      on_send = function(self, _, packet, _) -- shunt/configurator/main.yue:192
        if (packet.idemp_tok ~= nil) then -- shunt/configurator/main.yue:193
          idemp_tok = packet.idemp_tok -- shunt/configurator/main.yue:194
        end -- shunt/configurator/main.yue:193
        return true -- shunt/configurator/main.yue:195
      end, -- shunt/configurator/main.yue:192
      on_broadcast = function(self, packet, _) -- shunt/configurator/main.yue:196
        if (packet.idemp_tok ~= nil) then -- shunt/configurator/main.yue:197
          idemp_tok = packet.idemp_tok -- shunt/configurator/main.yue:198
        end -- shunt/configurator/main.yue:197
        return true -- shunt/configurator/main.yue:199
      end, -- shunt/configurator/main.yue:196
      on_receive = function(self, protocol, _) -- shunt/configurator/main.yue:200
        require('shunt.spec')._assert_that([=[idemp_tok]=], idemp_tok, (not_(eq(nil))), tostring("shunt/configurator/main.yue") .. ":" .. tostring(201)); -- shunt/configurator/main.yue:201
        require('shunt.spec')._assert_that([=[protocol]=], protocol, (not_(eq(nil))), tostring("shunt/configurator/main.yue") .. ":" .. tostring(202)) -- shunt/configurator/main.yue:202
        return active_responses[protocol] or false -- shunt/configurator/main.yue:203
      end, -- shunt/configurator/main.yue:200
      to_receive = { -- shunt/configurator/main.yue:205
        function() -- shunt/configurator/main.yue:205
          local _with_0 = { } -- shunt/configurator/main.yue:205
          _with_0.from_id = MARSHAL_PC_ID -- shunt/configurator/main.yue:206
          _with_0.packet = MarshalIdentityResponse(idemp_tok, MARSHAL_PC_ID) -- shunt/configurator/main.yue:207
          return _with_0 -- shunt/configurator/main.yue:205
        end, -- shunt/configurator/main.yue:205
        function() -- shunt/configurator/main.yue:208
          local _with_0 = { } -- shunt/configurator/main.yue:208
          _with_0.from_id = MARSHAL_PC_ID -- shunt/configurator/main.yue:209
          _with_0.packet = GetConfigResponse(idemp_tok, ORIGINAL_CONFIG) -- shunt/configurator/main.yue:210
          return _with_0 -- shunt/configurator/main.yue:208
        end, -- shunt/configurator/main.yue:208
        function() -- shunt/configurator/main.yue:211
          local _with_0 = { } -- shunt/configurator/main.yue:211
          _with_0.from_id = MARSHAL_PC_ID -- shunt/configurator/main.yue:212
          _with_0.packet = SetConfigResponse(idemp_tok, nil) -- shunt/configurator/main.yue:213
          return _with_0 -- shunt/configurator/main.yue:211
        end -- shunt/configurator/main.yue:211
      } -- shunt/configurator/main.yue:204
    })) -- shunt/configurator/main.yue:191
    local editor = Editor(TestEditorBackend({ -- shunt/configurator/main.yue:216
      edit_file = function(self, path) -- shunt/configurator/main.yue:216
        do -- shunt/configurator/main.yue:217
          local _with_0 = assert(io.open(path, 'w')) -- shunt/configurator/main.yue:217
          assert(_with_0:write(edited_config)) -- shunt/configurator/main.yue:218
          assert(_with_0:close()) -- shunt/configurator/main.yue:219
        end -- shunt/configurator/main.yue:217
        return nil -- shunt/configurator/main.yue:220
      end -- shunt/configurator/main.yue:216
    })) -- shunt/configurator/main.yue:215
    editor.max_retries = 1 -- shunt/configurator/main.yue:221
    local reset -- shunt/configurator/main.yue:223
    reset = function() -- shunt/configurator/main.yue:223
      uplink.backend:reset() -- shunt/configurator/main.yue:224
      idemp_tok = nil -- shunt/configurator/main.yue:225
      active_responses = { -- shunt/configurator/main.yue:227
        MarshalIdentityResponse = true, -- shunt/configurator/main.yue:227
        GetConfigResponse = true, -- shunt/configurator/main.yue:228
        SetConfigResponse = true -- shunt/configurator/main.yue:229
      } -- shunt/configurator/main.yue:226
    end -- shunt/configurator/main.yue:223
    it('handles okay case', function() -- shunt/configurator/main.yue:231
      reset() -- shunt/configurator/main.yue:232
      do -- shunt/configurator/main.yue:233
        local _with_0 = Configurator(pc, uplink, editor) -- shunt/configurator/main.yue:233
        local pc_id, err = _with_0:get_pc_id('marshal'); -- shunt/configurator/main.yue:234
        require('shunt.spec')._assert_that([=[pc_id]=], pc_id, (eq(MARSHAL_PC_ID)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(235)); -- shunt/configurator/main.yue:235
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(236)) -- shunt/configurator/main.yue:236
        err = _with_0:configure(pc_id, 'marshal', false); -- shunt/configurator/main.yue:238
        require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(239)) -- shunt/configurator/main.yue:239
      end -- shunt/configurator/main.yue:233
      require('shunt.spec')._expect_that([=[#uplink.backend.broadcasted]=], #uplink.backend.broadcasted, (eq(1)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(241)); -- shunt/configurator/main.yue:241
      require('shunt.spec')._expect_that([=[uplink.backend.broadcasted[1]]=], uplink.backend.broadcasted[1], (has_fields({ -- shunt/configurator/main.yue:242
        packet = has_fields({ -- shunt/configurator/main.yue:242
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:242
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:242
        }), -- shunt/configurator/main.yue:242
        protocol = eq(MarshalIdentityRequest:protocol()) -- shunt/configurator/main.yue:242
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(242)); -- shunt/configurator/main.yue:242
      require('shunt.spec')._expect_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (eq(2)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(247)); -- shunt/configurator/main.yue:247
      require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/configurator/main.yue:248
        id = eq(MARSHAL_PC_ID), -- shunt/configurator/main.yue:248
        packet = has_fields({ -- shunt/configurator/main.yue:248
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:248
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:248
        }), -- shunt/configurator/main.yue:248
        protocol = eq(GetConfigRequest:protocol()) -- shunt/configurator/main.yue:248
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(248)); -- shunt/configurator/main.yue:248
      return require('shunt.spec')._expect_that([=[uplink.backend.sent[2]]=], uplink.backend.sent[2], (has_fields({ -- shunt/configurator/main.yue:254
        id = eq(MARSHAL_PC_ID), -- shunt/configurator/main.yue:254
        packet = has_fields({ -- shunt/configurator/main.yue:254
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:254
          pc_id = eq(CONFIGURATOR_PC_ID), -- shunt/configurator/main.yue:254
          raw = eq(edited_config) -- shunt/configurator/main.yue:254
        }), -- shunt/configurator/main.yue:254
        protocol = eq(SetConfigRequest:protocol()) -- shunt/configurator/main.yue:254
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(254)) -- shunt/configurator/main.yue:260
    end) -- shunt/configurator/main.yue:231
    it('handles connection loss when getting marshal identity', function() -- shunt/configurator/main.yue:262
      reset() -- shunt/configurator/main.yue:263
      active_responses.MarshalIdentityResponse = false -- shunt/configurator/main.yue:264
      do -- shunt/configurator/main.yue:266
        local _with_0 = Configurator(pc, uplink, editor) -- shunt/configurator/main.yue:266
        local pc_id, err = _with_0:get_pc_id('marshal'); -- shunt/configurator/main.yue:267
        require('shunt.spec')._assert_that([=[pc_id]=], pc_id, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(268)); -- shunt/configurator/main.yue:268
        require('shunt.spec')._assert_that([=[err]=], err, (matches("cannot find marshal")), tostring("shunt/configurator/main.yue") .. ":" .. tostring(269)) -- shunt/configurator/main.yue:269
      end -- shunt/configurator/main.yue:266
      require('shunt.spec')._expect_that([=[#uplink.backend.broadcasted]=], #uplink.backend.broadcasted, (gt(1)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(271)); -- shunt/configurator/main.yue:271
      require('shunt.spec')._expect_that([=[uplink.backend.broadcasted]=], uplink.backend.broadcasted, (each_value(has_fields({ -- shunt/configurator/main.yue:272
        packet = has_fields({ -- shunt/configurator/main.yue:272
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:272
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:272
        }), -- shunt/configurator/main.yue:272
        protocol = eq(MarshalIdentityRequest:protocol()) -- shunt/configurator/main.yue:272
      }))), tostring("shunt/configurator/main.yue") .. ":" .. tostring(272)); -- shunt/configurator/main.yue:272
      return require('shunt.spec')._expect_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (eq(0)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(277)) -- shunt/configurator/main.yue:277
    end) -- shunt/configurator/main.yue:262
    it('handles connection loss when getting config', function() -- shunt/configurator/main.yue:279
      reset() -- shunt/configurator/main.yue:280
      active_responses.GetConfigResponse = false -- shunt/configurator/main.yue:281
      do -- shunt/configurator/main.yue:283
        local _with_0 = Configurator(pc, uplink, editor) -- shunt/configurator/main.yue:283
        local pc_id, err = _with_0:get_pc_id('marshal'); -- shunt/configurator/main.yue:284
        require('shunt.spec')._assert_that([=[pc_id]=], pc_id, (eq(MARSHAL_PC_ID)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(285)); -- shunt/configurator/main.yue:285
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(286)) -- shunt/configurator/main.yue:286
        err = _with_0:configure(pc_id, 'marshal', false); -- shunt/configurator/main.yue:288
        require('shunt.spec')._expect_that([=[err]=], err, (matches('cannot find marshal')), tostring("shunt/configurator/main.yue") .. ":" .. tostring(289)) -- shunt/configurator/main.yue:289
      end -- shunt/configurator/main.yue:283
      require('shunt.spec')._expect_that([=[#uplink.backend.broadcasted]=], #uplink.backend.broadcasted, (eq(1)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(291)); -- shunt/configurator/main.yue:291
      require('shunt.spec')._expect_that([=[uplink.backend.broadcasted[1]]=], uplink.backend.broadcasted[1], (has_fields({ -- shunt/configurator/main.yue:292
        packet = has_fields({ -- shunt/configurator/main.yue:292
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:292
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:292
        }), -- shunt/configurator/main.yue:292
        protocol = eq(MarshalIdentityRequest:protocol()) -- shunt/configurator/main.yue:292
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(292)); -- shunt/configurator/main.yue:292
      require('shunt.spec')._expect_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (gt(1)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(297)); -- shunt/configurator/main.yue:297
      return require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (each_value(has_fields({ -- shunt/configurator/main.yue:298
        id = eq(MARSHAL_PC_ID), -- shunt/configurator/main.yue:298
        packet = has_fields({ -- shunt/configurator/main.yue:298
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:298
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:298
        }), -- shunt/configurator/main.yue:298
        protocol = eq(GetConfigRequest:protocol()) -- shunt/configurator/main.yue:298
      }))), tostring("shunt/configurator/main.yue") .. ":" .. tostring(298)) -- shunt/configurator/main.yue:303
    end) -- shunt/configurator/main.yue:279
    it('handles connection loss when setting config', function() -- shunt/configurator/main.yue:305
      reset() -- shunt/configurator/main.yue:306
      active_responses.SetConfigResponse = false -- shunt/configurator/main.yue:307
      do -- shunt/configurator/main.yue:309
        local _with_0 = Configurator(pc, uplink, editor) -- shunt/configurator/main.yue:309
        local pc_id, err = _with_0:get_pc_id('marshal'); -- shunt/configurator/main.yue:310
        require('shunt.spec')._assert_that([=[pc_id]=], pc_id, (eq(MARSHAL_PC_ID)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(311)); -- shunt/configurator/main.yue:311
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(312)) -- shunt/configurator/main.yue:312
        err = _with_0:configure(pc_id, 'marshal', false); -- shunt/configurator/main.yue:314
        require('shunt.spec')._expect_that([=[err]=], err, (matches('cannot find pc #')), tostring("shunt/configurator/main.yue") .. ":" .. tostring(315)) -- shunt/configurator/main.yue:315
      end -- shunt/configurator/main.yue:309
      require('shunt.spec')._expect_that([=[#uplink.backend.broadcasted]=], #uplink.backend.broadcasted, (eq(1)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(317)); -- shunt/configurator/main.yue:317
      require('shunt.spec')._expect_that([=[uplink.backend.broadcasted[1]]=], uplink.backend.broadcasted[1], (has_fields({ -- shunt/configurator/main.yue:318
        packet = has_fields({ -- shunt/configurator/main.yue:318
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:318
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:318
        }), -- shunt/configurator/main.yue:318
        protocol = eq(MarshalIdentityRequest:protocol()) -- shunt/configurator/main.yue:318
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(318)); -- shunt/configurator/main.yue:318
      require('shunt.spec')._expect_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (gt(2)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(323)); -- shunt/configurator/main.yue:323
      require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/configurator/main.yue:324
        id = eq(MARSHAL_PC_ID), -- shunt/configurator/main.yue:324
        packet = has_fields({ -- shunt/configurator/main.yue:324
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:324
          pc_id = eq(CONFIGURATOR_PC_ID) -- shunt/configurator/main.yue:324
        }), -- shunt/configurator/main.yue:324
        protocol = eq(GetConfigRequest:protocol()) -- shunt/configurator/main.yue:324
      })), tostring("shunt/configurator/main.yue") .. ":" .. tostring(324)) -- shunt/configurator/main.yue:324
      local sent_tail -- shunt/configurator/main.yue:330
      do -- shunt/configurator/main.yue:330
        local _accum_0 = { } -- shunt/configurator/main.yue:330
        local _len_0 = 1 -- shunt/configurator/main.yue:330
        local _list_0 = uplink.backend.sent -- shunt/configurator/main.yue:330
        for _index_0 = 2, #_list_0 do -- shunt/configurator/main.yue:330
          local msg = _list_0[_index_0] -- shunt/configurator/main.yue:330
          _accum_0[_len_0] = msg -- shunt/configurator/main.yue:330
          _len_0 = _len_0 + 1 -- shunt/configurator/main.yue:330
        end -- shunt/configurator/main.yue:330
        sent_tail = _accum_0 -- shunt/configurator/main.yue:330
      end -- shunt/configurator/main.yue:330
      return require('shunt.spec')._expect_that([=[sent_tail]=], sent_tail, (each_value(has_fields({ -- shunt/configurator/main.yue:331
        id = eq(MARSHAL_PC_ID), -- shunt/configurator/main.yue:331
        packet = has_fields({ -- shunt/configurator/main.yue:331
          idemp_tok = not_(eq(nil)), -- shunt/configurator/main.yue:331
          pc_id = eq(CONFIGURATOR_PC_ID), -- shunt/configurator/main.yue:331
          raw = eq(edited_config) -- shunt/configurator/main.yue:331
        }), -- shunt/configurator/main.yue:331
        protocol = eq(SetConfigRequest:protocol()) -- shunt/configurator/main.yue:331
      }))), tostring("shunt/configurator/main.yue") .. ":" .. tostring(331)) -- shunt/configurator/main.yue:337
    end) -- shunt/configurator/main.yue:305
    return it('validates config', function() -- shunt/configurator/main.yue:339
      reset() -- shunt/configurator/main.yue:340
      edited_config = [[        [invalid-config]
      ]] -- shunt/configurator/main.yue:341
      local _with_0 = Configurator(pc, uplink, editor) -- shunt/configurator/main.yue:345
      local pc_id, err = _with_0:get_pc_id('marshal'); -- shunt/configurator/main.yue:346
      require('shunt.spec')._assert_that([=[pc_id]=], pc_id, (eq(MARSHAL_PC_ID)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(347)); -- shunt/configurator/main.yue:347
      require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/main.yue") .. ":" .. tostring(348)) -- shunt/configurator/main.yue:348
      err = _with_0:configure(pc_id, 'marshal', false); -- shunt/configurator/main.yue:350
      require('shunt.spec')._expect_that([=[err]=], err, (matches('max edit retries reached')), tostring("shunt/configurator/main.yue") .. ":" .. tostring(351)) -- shunt/configurator/main.yue:351
      return _with_0 -- shunt/configurator/main.yue:345
    end) -- shunt/configurator/main.yue:351
  end) -- shunt/configurator/main.yue:351
end) -- shunt/configurator/main.yue:165
return _module_0 -- shunt/configurator/main.yue:351
end
package.preload['shunt.configurator.editor'] = function(...)
-- [yue]: shunt/configurator/editor.yue
local _module_0 = { } -- shunt/configurator/editor.yue:1
local ABORT, MinecraftBackend, LinuxBackend -- shunt/configurator/editor.yue:1
local declare_singleton_type, declare_type, F, T -- shunt/configurator/editor.yue:0
do -- shunt/configurator/editor.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/configurator/editor.yue:0
  declare_singleton_type, declare_type, F, T = _obj_0.declare_singleton_type, _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/configurator/editor.yue:0
end -- shunt/configurator/editor.yue:0
local spec = require('shunt.spec').spec -- shunt/configurator/editor.yue:0
declare_type('Editor', [[{
  edit_file: (string) => ?string,
  edit_text: (
      string,
      string,
      ?(string) -> boolean,
      ?(string, number) -> ?ABORT
    ) => <?string, ?string>,
}]]) -- shunt/configurator/editor.yue:6
declare_type('EditorBackend', [[{
  edit_file: (string) => ?string,
}]]) -- shunt/configurator/editor.yue:15
ABORT = setmetatable({ }, { -- shunt/configurator/editor.yue:18
  __tostring = function(self) -- shunt/configurator/editor.yue:18
    return 'ABORT' -- shunt/configurator/editor.yue:18
  end -- shunt/configurator/editor.yue:18
}) -- shunt/configurator/editor.yue:18
_module_0["ABORT"] = ABORT -- shunt/configurator/editor.yue:18
declare_singleton_type(ABORT) -- shunt/configurator/editor.yue:19
local Editor -- shunt/configurator/editor.yue:20
do -- shunt/configurator/editor.yue:20
  local _class_0 -- shunt/configurator/editor.yue:20
  local _base_0 = { -- shunt/configurator/editor.yue:20
    edit_file = F('(string) => ?string', function(self, path) -- shunt/configurator/editor.yue:24
      return self.backend:edit_file(path) -- shunt/configurator/editor.yue:25
    end), -- shunt/configurator/editor.yue:27
    edit_text = F('(string, string, ?(string) -> boolean, ?(string, number) -> ?ABORT) => <?string, ?string>', function(self, text, value_name, check, on_attempt) -- shunt/configurator/editor.yue:27
      local tmp_path = os.tmpname() -- shunt/configurator/editor.yue:28
      do -- shunt/configurator/editor.yue:30
        local _with_0 = assert(io.open(tmp_path, 'w+')) -- shunt/configurator/editor.yue:30
        assert(_with_0:write(text)) -- shunt/configurator/editor.yue:31
        assert(_with_0:close()) -- shunt/configurator/editor.yue:32
      end -- shunt/configurator/editor.yue:30
      local err -- shunt/configurator/editor.yue:34
      local attempt_num = 0 -- shunt/configurator/editor.yue:35
      repeat -- shunt/configurator/editor.yue:36
        attempt_num = attempt_num + 1 -- shunt/configurator/editor.yue:37
        if (on_attempt ~= nil) then -- shunt/configurator/editor.yue:38
          err = on_attempt(value_name, attempt_num) -- shunt/configurator/editor.yue:39
          if (err ~= nil) then -- shunt/configurator/editor.yue:40
            break -- shunt/configurator/editor.yue:41
          end -- shunt/configurator/editor.yue:40
        end -- shunt/configurator/editor.yue:38
        err = self.backend:edit_file(tmp_path) -- shunt/configurator/editor.yue:43
        if (err ~= nil) then -- shunt/configurator/editor.yue:44
          break -- shunt/configurator/editor.yue:45
        end -- shunt/configurator/editor.yue:44
        do -- shunt/configurator/editor.yue:47
          local _with_0 = assert(io.open(tmp_path, 'r')) -- shunt/configurator/editor.yue:47
          text = _with_0:read('*a') -- shunt/configurator/editor.yue:48
          _with_0:close() -- shunt/configurator/editor.yue:49
        end -- shunt/configurator/editor.yue:47
        if (self.max_retries ~= nil) and attempt_num > self.max_retries then -- shunt/configurator/editor.yue:50
          err = 'max edit retries reached' -- shunt/configurator/editor.yue:51
          break -- shunt/configurator/editor.yue:52
        end -- shunt/configurator/editor.yue:50
      until not (check ~= nil) or (check(text)) -- shunt/configurator/editor.yue:53
      os.remove(tmp_path) -- shunt/configurator/editor.yue:55
      if err == ABORT then -- shunt/configurator/editor.yue:57
        err = 'aborted' -- shunt/configurator/editor.yue:58
      end -- shunt/configurator/editor.yue:57
      if (err ~= nil) then -- shunt/configurator/editor.yue:59
        return nil, err -- shunt/configurator/editor.yue:60
      else -- shunt/configurator/editor.yue:62
        return text, nil -- shunt/configurator/editor.yue:62
      end -- shunt/configurator/editor.yue:59
    end) -- shunt/configurator/editor.yue:20
  } -- shunt/configurator/editor.yue:20
  if _base_0.__index == nil then -- shunt/configurator/editor.yue:20
    _base_0.__index = _base_0 -- shunt/configurator/editor.yue:20
  end -- shunt/configurator/editor.yue:62
  _class_0 = setmetatable({ -- shunt/configurator/editor.yue:20
    __init = F('(?EditorBackend) => <>', function(self, backend) -- shunt/configurator/editor.yue:21
      if backend == nil then -- shunt/configurator/editor.yue:21
        backend = MinecraftBackend() -- shunt/configurator/editor.yue:21
      end -- shunt/configurator/editor.yue:21
      self.backend = backend -- shunt/configurator/editor.yue:21
      self.max_retries = T('?number', nil) -- shunt/configurator/editor.yue:22
    end), -- shunt/configurator/editor.yue:20
    __base = _base_0, -- shunt/configurator/editor.yue:20
    __name = "Editor" -- shunt/configurator/editor.yue:20
  }, { -- shunt/configurator/editor.yue:20
    __index = _base_0, -- shunt/configurator/editor.yue:20
    __call = function(cls, ...) -- shunt/configurator/editor.yue:20
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/editor.yue:20
      cls.__init(_self_0, ...) -- shunt/configurator/editor.yue:20
      return _self_0 -- shunt/configurator/editor.yue:20
    end -- shunt/configurator/editor.yue:20
  }) -- shunt/configurator/editor.yue:20
  _base_0.__class = _class_0 -- shunt/configurator/editor.yue:20
  Editor = _class_0 -- shunt/configurator/editor.yue:20
end -- shunt/configurator/editor.yue:62
_module_0["Editor"] = Editor -- shunt/configurator/editor.yue:20
do -- shunt/configurator/editor.yue:64
  local _class_0 -- shunt/configurator/editor.yue:64
  local _base_0 = { -- shunt/configurator/editor.yue:64
    edit_file = F('(string) => ?string', function(self, path) -- shunt/configurator/editor.yue:68
      local ok = shell.execute(self.editor, path) -- shunt/configurator/editor.yue:69
      if not ok then -- shunt/configurator/editor.yue:70
        return tostring(self.editor) .. " exited unsuccessfully" -- shunt/configurator/editor.yue:71
      end -- shunt/configurator/editor.yue:70
      return nil -- shunt/configurator/editor.yue:72
    end) -- shunt/configurator/editor.yue:64
  } -- shunt/configurator/editor.yue:64
  if _base_0.__index == nil then -- shunt/configurator/editor.yue:64
    _base_0.__index = _base_0 -- shunt/configurator/editor.yue:64
  end -- shunt/configurator/editor.yue:72
  _class_0 = setmetatable({ -- shunt/configurator/editor.yue:64
    __init = function(self) -- shunt/configurator/editor.yue:65
      self.editor = 'edit' -- shunt/configurator/editor.yue:66
    end, -- shunt/configurator/editor.yue:64
    __base = _base_0, -- shunt/configurator/editor.yue:64
    __name = "MinecraftBackend" -- shunt/configurator/editor.yue:64
  }, { -- shunt/configurator/editor.yue:64
    __index = _base_0, -- shunt/configurator/editor.yue:64
    __call = function(cls, ...) -- shunt/configurator/editor.yue:64
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/editor.yue:64
      cls.__init(_self_0, ...) -- shunt/configurator/editor.yue:64
      return _self_0 -- shunt/configurator/editor.yue:64
    end -- shunt/configurator/editor.yue:64
  }) -- shunt/configurator/editor.yue:64
  _base_0.__class = _class_0 -- shunt/configurator/editor.yue:64
  MinecraftBackend = _class_0 -- shunt/configurator/editor.yue:64
end -- shunt/configurator/editor.yue:72
declare_type('TestEditorBackendOpts', [[{
  edit_file: ?(string) => ?string,
}]]) -- shunt/configurator/editor.yue:74
local TestEditorBackend -- shunt/configurator/editor.yue:77
do -- shunt/configurator/editor.yue:77
  local _class_0 -- shunt/configurator/editor.yue:77
  local _base_0 = { } -- shunt/configurator/editor.yue:77
  if _base_0.__index == nil then -- shunt/configurator/editor.yue:77
    _base_0.__index = _base_0 -- shunt/configurator/editor.yue:77
  end -- shunt/configurator/editor.yue:82
  _class_0 = setmetatable({ -- shunt/configurator/editor.yue:77
    __init = F('(?TestEditorBackendOpts) => <>', function(self, opts) -- shunt/configurator/editor.yue:78
      if opts == nil then -- shunt/configurator/editor.yue:78
        opts = { } -- shunt/configurator/editor.yue:78
      end -- shunt/configurator/editor.yue:78
      local edit_file = opts.edit_file -- shunt/configurator/editor.yue:79
      if edit_file == nil then -- shunt/configurator/editor.yue:80
        edit_file = function() -- shunt/configurator/editor.yue:80
          return error('edit_file unimplemented') -- shunt/configurator/editor.yue:80
        end -- shunt/configurator/editor.yue:80
      end -- shunt/configurator/editor.yue:80
      self.edit_file = F('(string) => ?string', edit_file) -- shunt/configurator/editor.yue:82
    end), -- shunt/configurator/editor.yue:77
    __base = _base_0, -- shunt/configurator/editor.yue:77
    __name = "TestEditorBackend" -- shunt/configurator/editor.yue:77
  }, { -- shunt/configurator/editor.yue:77
    __index = _base_0, -- shunt/configurator/editor.yue:77
    __call = function(cls, ...) -- shunt/configurator/editor.yue:77
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/editor.yue:77
      cls.__init(_self_0, ...) -- shunt/configurator/editor.yue:77
      return _self_0 -- shunt/configurator/editor.yue:77
    end -- shunt/configurator/editor.yue:77
  }) -- shunt/configurator/editor.yue:77
  _base_0.__class = _class_0 -- shunt/configurator/editor.yue:77
  TestEditorBackend = _class_0 -- shunt/configurator/editor.yue:77
end -- shunt/configurator/editor.yue:82
_module_0["TestEditorBackend"] = TestEditorBackend -- shunt/configurator/editor.yue:77
do -- shunt/configurator/editor.yue:84
  local _class_0 -- shunt/configurator/editor.yue:84
  local _base_0 = { -- shunt/configurator/editor.yue:84
    edit_file = F('(string) => ?string', function(self, path) -- shunt/configurator/editor.yue:92
      if path:match("'") then -- shunt/configurator/editor.yue:93
        error('internal error: LinuxEditor quotes') -- shunt/configurator/editor.yue:94
      end -- shunt/configurator/editor.yue:93
      local rc = os.execute("nvim '" .. tostring(path) .. "'") -- shunt/configurator/editor.yue:95
      if rc ~= 0 then -- shunt/configurator/editor.yue:96
        return tostring(self.editor) .. " exited with code " .. tostring(rc) -- shunt/configurator/editor.yue:97
      end -- shunt/configurator/editor.yue:96
      return nil -- shunt/configurator/editor.yue:98
    end) -- shunt/configurator/editor.yue:84
  } -- shunt/configurator/editor.yue:84
  if _base_0.__index == nil then -- shunt/configurator/editor.yue:84
    _base_0.__index = _base_0 -- shunt/configurator/editor.yue:84
  end -- shunt/configurator/editor.yue:98
  _class_0 = setmetatable({ -- shunt/configurator/editor.yue:84
    __init = function(self) -- shunt/configurator/editor.yue:85
      do -- shunt/configurator/editor.yue:86
        local editor = os.getenv('EDITOR') -- shunt/configurator/editor.yue:87
        if not editor then -- shunt/configurator/editor.yue:88
          error('cannot create LinuxEditor: $EDITOR not set') -- shunt/configurator/editor.yue:89
        end -- shunt/configurator/editor.yue:88
        self.editor = editor -- shunt/configurator/editor.yue:90
      end -- shunt/configurator/editor.yue:90
    end, -- shunt/configurator/editor.yue:84
    __base = _base_0, -- shunt/configurator/editor.yue:84
    __name = "LinuxBackend" -- shunt/configurator/editor.yue:84
  }, { -- shunt/configurator/editor.yue:84
    __index = _base_0, -- shunt/configurator/editor.yue:84
    __call = function(cls, ...) -- shunt/configurator/editor.yue:84
      local _self_0 = setmetatable({ }, _base_0) -- shunt/configurator/editor.yue:84
      cls.__init(_self_0, ...) -- shunt/configurator/editor.yue:84
      return _self_0 -- shunt/configurator/editor.yue:84
    end -- shunt/configurator/editor.yue:84
  }) -- shunt/configurator/editor.yue:84
  _base_0.__class = _class_0 -- shunt/configurator/editor.yue:84
  LinuxBackend = _class_0 -- shunt/configurator/editor.yue:84
end -- shunt/configurator/editor.yue:98
spec(function() -- shunt/configurator/editor.yue:100
  local describe, it, matchers -- shunt/configurator/editor.yue:0
  do -- shunt/configurator/editor.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/configurator/editor.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/configurator/editor.yue:0
  end -- shunt/configurator/editor.yue:0
  local deep_eq, eq = matchers.deep_eq, matchers.eq -- shunt/configurator/editor.yue:105
  return describe('Editor', function() -- shunt/configurator/editor.yue:107
    it('edits text', function() -- shunt/configurator/editor.yue:108
      local FILE_PATH = 'file.txt' -- shunt/configurator/editor.yue:109
      local file_content = ('ab'):rep(10) -- shunt/configurator/editor.yue:110
      local editor = Editor(TestEditorBackend({ -- shunt/configurator/editor.yue:112
        edit_file = function(self, path) -- shunt/configurator/editor.yue:112
          require('shunt.spec')._expect_that([=[path]=], path, (eq(FILE_PATH)), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(113)) -- shunt/configurator/editor.yue:113
          file_content = file_content:gsub('b', 'c') -- shunt/configurator/editor.yue:115
        end -- shunt/configurator/editor.yue:112
      })) -- shunt/configurator/editor.yue:111
      editor:edit_file(FILE_PATH); -- shunt/configurator/editor.yue:116
      return require('shunt.spec')._expect_that([=[file_content]=], file_content, (eq(('ac'):rep(10))), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(117)) -- shunt/configurator/editor.yue:117
    end) -- shunt/configurator/editor.yue:108
    return it('edits text with a checker', function() -- shunt/configurator/editor.yue:119
      local FILE_PATH = 'file.txt' -- shunt/configurator/editor.yue:120
      local editor = Editor(TestEditorBackend({ -- shunt/configurator/editor.yue:122
        edit_file = function(self, path) -- shunt/configurator/editor.yue:122
          do -- shunt/configurator/editor.yue:123
            local _with_0 = assert(io.open(path, 'a')) -- shunt/configurator/editor.yue:123
            assert(_with_0:write('a')) -- shunt/configurator/editor.yue:124
            assert(_with_0:close()) -- shunt/configurator/editor.yue:125
          end -- shunt/configurator/editor.yue:123
          local file_content = "a" .. tostring(file_content) -- shunt/configurator/editor.yue:126
        end -- shunt/configurator/editor.yue:122
      })) -- shunt/configurator/editor.yue:121
      local num_edits = 0 -- shunt/configurator/editor.yue:128
      local file = 'value-name' -- shunt/configurator/editor.yue:129
      local text = ('a'):rep(7) -- shunt/configurator/editor.yue:130
      local checker = F('(string) -> boolean', function(text) -- shunt/configurator/editor.yue:131
        num_edits = num_edits + 1 -- shunt/configurator/editor.yue:132
        return #text >= 10 -- shunt/configurator/editor.yue:133
      end) -- shunt/configurator/editor.yue:131
      local attempts = { } -- shunt/configurator/editor.yue:134
      local on_attempt = F('(string, number) -> ?ABORT', function(file, attempt) -- shunt/configurator/editor.yue:135
        attempts[#attempts + 1] = { -- shunt/configurator/editor.yue:136
          file = file, -- shunt/configurator/editor.yue:136
          attempt = attempt -- shunt/configurator/editor.yue:136
        } -- shunt/configurator/editor.yue:136
        return nil -- shunt/configurator/editor.yue:137
      end) -- shunt/configurator/editor.yue:135
      local result, err = editor:edit_text(text, file, checker, on_attempt); -- shunt/configurator/editor.yue:138
      require('shunt.spec')._expect_that([=[result]=], result, (eq(('a'):rep(10))), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(140)); -- shunt/configurator/editor.yue:140
      require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(141)); -- shunt/configurator/editor.yue:141
      require('shunt.spec')._expect_that([=[num_edits]=], num_edits, (eq(3)), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(142)); -- shunt/configurator/editor.yue:142
      return require('shunt.spec')._expect_that([=[attempts]=], attempts, (deep_eq({ -- shunt/configurator/editor.yue:143
        { -- shunt/configurator/editor.yue:143
          file = file, -- shunt/configurator/editor.yue:143
          attempt = 1 -- shunt/configurator/editor.yue:143
        }, -- shunt/configurator/editor.yue:143
        { -- shunt/configurator/editor.yue:143
          file = file, -- shunt/configurator/editor.yue:143
          attempt = 2 -- shunt/configurator/editor.yue:143
        }, -- shunt/configurator/editor.yue:143
        { -- shunt/configurator/editor.yue:143
          file = file, -- shunt/configurator/editor.yue:143
          attempt = 3 -- shunt/configurator/editor.yue:143
        } -- shunt/configurator/editor.yue:143
      })), tostring("shunt/configurator/editor.yue") .. ":" .. tostring(143)) -- shunt/configurator/editor.yue:149
    end) -- shunt/configurator/editor.yue:149
  end) -- shunt/configurator/editor.yue:149
end) -- shunt/configurator/editor.yue:100
return _module_0 -- shunt/configurator/editor.yue:149
end
package.preload['shunt.pc'] = function(...)
-- [yue]: shunt/pc.yue
local _module_0 = { } -- shunt/pc.yue:1
local MinecraftBackend -- shunt/pc.yue:1
local declare_type, F -- shunt/pc.yue:0
do -- shunt/pc.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/pc.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/pc.yue:0
end -- shunt/pc.yue:0
local spec = require('shunt.spec').spec -- shunt/pc.yue:0
declare_type('Pc', [[{
  id: () => number,
  name: () => ?string,
}]]) -- shunt/pc.yue:6
declare_type('PcBackend', 'Pc') -- shunt/pc.yue:10
local Pc -- shunt/pc.yue:11
do -- shunt/pc.yue:11
  local _class_0 -- shunt/pc.yue:11
  local _base_0 = { -- shunt/pc.yue:11
    id = F('() => number', function(self) -- shunt/pc.yue:14
      return self.backend:id() -- shunt/pc.yue:15
    end), -- shunt/pc.yue:17
    name = F('() => ?string', function(self) -- shunt/pc.yue:17
      return self.backend:name() -- shunt/pc.yue:18
    end), -- shunt/pc.yue:20
    set_name = F('(string) => <>', function(self, name) -- shunt/pc.yue:20
      return self.backend:set_name(name) -- shunt/pc.yue:21
    end) -- shunt/pc.yue:11
  } -- shunt/pc.yue:11
  if _base_0.__index == nil then -- shunt/pc.yue:11
    _base_0.__index = _base_0 -- shunt/pc.yue:11
  end -- shunt/pc.yue:21
  _class_0 = setmetatable({ -- shunt/pc.yue:11
    __init = F('(?PcBackend) => <>', function(self, backend) -- shunt/pc.yue:12
      if backend == nil then -- shunt/pc.yue:12
        backend = MinecraftBackend() -- shunt/pc.yue:12
      end -- shunt/pc.yue:12
      self.backend = backend -- shunt/pc.yue:12
    end), -- shunt/pc.yue:11
    __base = _base_0, -- shunt/pc.yue:11
    __name = "Pc" -- shunt/pc.yue:11
  }, { -- shunt/pc.yue:11
    __index = _base_0, -- shunt/pc.yue:11
    __call = function(cls, ...) -- shunt/pc.yue:11
      local _self_0 = setmetatable({ }, _base_0) -- shunt/pc.yue:11
      cls.__init(_self_0, ...) -- shunt/pc.yue:11
      return _self_0 -- shunt/pc.yue:11
    end -- shunt/pc.yue:11
  }) -- shunt/pc.yue:11
  _base_0.__class = _class_0 -- shunt/pc.yue:11
  Pc = _class_0 -- shunt/pc.yue:11
end -- shunt/pc.yue:21
_module_0["Pc"] = Pc -- shunt/pc.yue:11
do -- shunt/pc.yue:23
  local _class_0 -- shunt/pc.yue:23
  local _base_0 = { -- shunt/pc.yue:23
    id = F('() => number', function(self) -- shunt/pc.yue:24
      return os.getComputerID() -- shunt/pc.yue:25
    end), -- shunt/pc.yue:27
    name = F('() => ?string', function(self) -- shunt/pc.yue:27
      return os.getComputerLabel() -- shunt/pc.yue:28
    end), -- shunt/pc.yue:30
    set_name = F('(string) => <>', function(self, name) -- shunt/pc.yue:30
      return os.setComputerLabel(name) -- shunt/pc.yue:31
    end) -- shunt/pc.yue:23
  } -- shunt/pc.yue:23
  if _base_0.__index == nil then -- shunt/pc.yue:23
    _base_0.__index = _base_0 -- shunt/pc.yue:23
  end -- shunt/pc.yue:31
  _class_0 = setmetatable({ -- shunt/pc.yue:23
    __init = function() end, -- shunt/pc.yue:23
    __base = _base_0, -- shunt/pc.yue:23
    __name = "MinecraftBackend" -- shunt/pc.yue:23
  }, { -- shunt/pc.yue:23
    __index = _base_0, -- shunt/pc.yue:23
    __call = function(cls, ...) -- shunt/pc.yue:23
      local _self_0 = setmetatable({ }, _base_0) -- shunt/pc.yue:23
      cls.__init(_self_0, ...) -- shunt/pc.yue:23
      return _self_0 -- shunt/pc.yue:23
    end -- shunt/pc.yue:23
  }) -- shunt/pc.yue:23
  _base_0.__class = _class_0 -- shunt/pc.yue:23
  MinecraftBackend = _class_0 -- shunt/pc.yue:23
end -- shunt/pc.yue:31
declare_type('TestPcBackendOpts', [[{
  id: ?() => number,
  name: ?() => ?string,
  set_name: ?(string) => <>,
}]]) -- shunt/pc.yue:33
local TestPcBackend -- shunt/pc.yue:39
do -- shunt/pc.yue:39
  local _class_0 -- shunt/pc.yue:39
  local _base_0 = { } -- shunt/pc.yue:39
  if _base_0.__index == nil then -- shunt/pc.yue:39
    _base_0.__index = _base_0 -- shunt/pc.yue:39
  end -- shunt/pc.yue:48
  _class_0 = setmetatable({ -- shunt/pc.yue:39
    __init = F('(?TestPcBackendOpts) => <>', function(self, opts) -- shunt/pc.yue:40
      if opts == nil then -- shunt/pc.yue:40
        opts = { } -- shunt/pc.yue:40
      end -- shunt/pc.yue:40
      local id, name, set_name = opts.id, opts.name, opts.set_name -- shunt/pc.yue:41
      if id == nil then -- shunt/pc.yue:42
        id = function() -- shunt/pc.yue:42
          return error('id unimplemented') -- shunt/pc.yue:42
        end -- shunt/pc.yue:42
      end -- shunt/pc.yue:42
      if name == nil then -- shunt/pc.yue:43
        name = function() -- shunt/pc.yue:43
          return error('name unimplemented') -- shunt/pc.yue:43
        end -- shunt/pc.yue:43
      end -- shunt/pc.yue:43
      if set_name == nil then -- shunt/pc.yue:44
        set_name = function() -- shunt/pc.yue:44
          return error('set_name unimplemented') -- shunt/pc.yue:44
        end -- shunt/pc.yue:44
      end -- shunt/pc.yue:44
      self.id = F('() => number', id) -- shunt/pc.yue:46
      self.name = F('() => string', name) -- shunt/pc.yue:47
      self.set_name = F('(string) => <>', set_name) -- shunt/pc.yue:48
    end), -- shunt/pc.yue:39
    __base = _base_0, -- shunt/pc.yue:39
    __name = "TestPcBackend" -- shunt/pc.yue:39
  }, { -- shunt/pc.yue:39
    __index = _base_0, -- shunt/pc.yue:39
    __call = function(cls, ...) -- shunt/pc.yue:39
      local _self_0 = setmetatable({ }, _base_0) -- shunt/pc.yue:39
      cls.__init(_self_0, ...) -- shunt/pc.yue:39
      return _self_0 -- shunt/pc.yue:39
    end -- shunt/pc.yue:39
  }) -- shunt/pc.yue:39
  _base_0.__class = _class_0 -- shunt/pc.yue:39
  TestPcBackend = _class_0 -- shunt/pc.yue:39
end -- shunt/pc.yue:48
_module_0["TestPcBackend"] = TestPcBackend -- shunt/pc.yue:39
spec(function() -- shunt/pc.yue:50
  local describe, it, matchers -- shunt/pc.yue:0
  do -- shunt/pc.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/pc.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/pc.yue:0
  end -- shunt/pc.yue:0
  local eq = matchers.eq -- shunt/pc.yue:55
  return describe('Pc', function() -- shunt/pc.yue:57
    it('reports its id', function() -- shunt/pc.yue:58
      local ID = 54321 -- shunt/pc.yue:59
      local pc = Pc(TestPcBackend({ -- shunt/pc.yue:61
        id = function(self) -- shunt/pc.yue:61
          return ID -- shunt/pc.yue:61
        end -- shunt/pc.yue:61
      })); -- shunt/pc.yue:60
      return require('shunt.spec')._expect_that([=[pc\id!]=], pc:id(), (eq(ID)), tostring("shunt/pc.yue") .. ":" .. tostring(62)) -- shunt/pc.yue:62
    end) -- shunt/pc.yue:58
    return it('reports its name', function() -- shunt/pc.yue:64
      local NAME = 'test-pc-name' -- shunt/pc.yue:65
      local pc = Pc(TestPcBackend({ -- shunt/pc.yue:67
        name = function(self) -- shunt/pc.yue:67
          return NAME -- shunt/pc.yue:67
        end -- shunt/pc.yue:67
      })); -- shunt/pc.yue:66
      return require('shunt.spec')._expect_that([=[pc\name!]=], pc:name(), (eq(NAME)), tostring("shunt/pc.yue") .. ":" .. tostring(68)) -- shunt/pc.yue:68
    end) -- shunt/pc.yue:68
  end) -- shunt/pc.yue:68
end) -- shunt/pc.yue:50
return _module_0 -- shunt/pc.yue:68
end
package.preload['shunt.peripheral.uplink'] = function(...)
-- [yue]: shunt/peripheral/uplink.yue
local _module_0 = { } -- shunt/peripheral/uplink.yue:1
local TIMEOUT, MinecraftBackend, IDEMP_TOK_MAX, IdempotenceToken -- shunt/peripheral/uplink.yue:1
local trace = require('shunt.logger').trace -- shunt/peripheral/uplink.yue:0
local declare_singleton_type, declare_type, F, T -- shunt/peripheral/uplink.yue:0
do -- shunt/peripheral/uplink.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/peripheral/uplink.yue:0
  declare_singleton_type, declare_type, F, T = _obj_0.declare_singleton_type, _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/peripheral/uplink.yue:0
end -- shunt/peripheral/uplink.yue:0
local spec = require('shunt.spec').spec -- shunt/peripheral/uplink.yue:0
TIMEOUT = setmetatable({ }, { -- shunt/peripheral/uplink.yue:7
  __tostring = function(self) -- shunt/peripheral/uplink.yue:7
    return "TIMEOUT" -- shunt/peripheral/uplink.yue:7
  end -- shunt/peripheral/uplink.yue:7
}) -- shunt/peripheral/uplink.yue:7
_module_0["TIMEOUT"] = TIMEOUT -- shunt/peripheral/uplink.yue:7
declare_singleton_type(TIMEOUT) -- shunt/peripheral/uplink.yue:8
declare_type('UplinkBackend', [[{
  send: (number, any, ?string) => boolean,
  receive: (?string, ?number) => <?number, any, ?string>,
  broadcast: (any, ?string) => <>,
}]]) -- shunt/peripheral/uplink.yue:10
declare_type('Uplink', [[{
  broadcast: (Packet) => <>,
  send_to: (number, Packet) => <>,
  receive_from_any: (Packet, ?UplinkReceiveOpts) => <?number, Packet|TIMEOUT>,
  receive_from: (number, Packet, ?UplinkReceiveOpts) => <?number, Packet|TIMEOUT>,
}]]) -- shunt/peripheral/uplink.yue:16
local Uplink -- shunt/peripheral/uplink.yue:22
do -- shunt/peripheral/uplink.yue:22
  local _class_0 -- shunt/peripheral/uplink.yue:22
  local _base_0 = { -- shunt/peripheral/uplink.yue:22
    deafen = F('() => <>', function(self) -- shunt/peripheral/uplink.yue:26
      self.deaf = true -- shunt/peripheral/uplink.yue:27
    end), -- shunt/peripheral/uplink.yue:29
    broadcast = F('(Packet) => <>', function(self, packet) -- shunt/peripheral/uplink.yue:29
      return self.backend:broadcast(packet, packet.protocol) -- shunt/peripheral/uplink.yue:30
    end), -- shunt/peripheral/uplink.yue:32
    send_to = F('(number, Packet) => <>', function(self, to_id, packet) -- shunt/peripheral/uplink.yue:32
      local ok = self.backend:send(to_id, packet, packet.protocol) -- shunt/peripheral/uplink.yue:33
      if not ok then -- shunt/peripheral/uplink.yue:34
        return error("failed to send " .. tostring(packet.protocol)) -- shunt/peripheral/uplink.yue:35
      end -- shunt/peripheral/uplink.yue:34
    end), -- shunt/peripheral/uplink.yue:37
    receive_from_any = F('(?PacketType, ?UplinkReceiveOpts) => <?number, Packet|TIMEOUT>', function(self, packet_type, opts) -- shunt/peripheral/uplink.yue:37
      if opts == nil then -- shunt/peripheral/uplink.yue:37
        opts = { } -- shunt/peripheral/uplink.yue:37
      end -- shunt/peripheral/uplink.yue:37
      return self:_receive_from(nil, packet_type, opts) -- shunt/peripheral/uplink.yue:38
    end), -- shunt/peripheral/uplink.yue:40
    receive_from = F('(number, ?PacketType, ?UplinkReceiveOpts) => <?number, Packet|TIMEOUT>', function(self, from_id, packet_type, opts) -- shunt/peripheral/uplink.yue:40
      if opts == nil then -- shunt/peripheral/uplink.yue:40
        opts = { } -- shunt/peripheral/uplink.yue:40
      end -- shunt/peripheral/uplink.yue:40
      return self:_receive_from(from_id, packet_type, opts) -- shunt/peripheral/uplink.yue:41
    end), -- shunt/peripheral/uplink.yue:43
    _receive_from = F('(?number, ?PacketType, ?UplinkReceiveOpts) => <?number, Packet|TIMEOUT>', function(self, from_id, packet_type, opts) -- shunt/peripheral/uplink.yue:43
      if opts == nil then -- shunt/peripheral/uplink.yue:43
        opts = { } -- shunt/peripheral/uplink.yue:43
      end -- shunt/peripheral/uplink.yue:43
      local timeout = opts.timeout -- shunt/peripheral/uplink.yue:44
      local id, packet, protocol -- shunt/peripheral/uplink.yue:46
      local protocol_filter -- shunt/peripheral/uplink.yue:47
      if packet_type ~= nil then -- shunt/peripheral/uplink.yue:47
        protocol_filter = packet_type:protocol() -- shunt/peripheral/uplink.yue:47
      end -- shunt/peripheral/uplink.yue:47
      while true do -- shunt/peripheral/uplink.yue:48
        local _continue_0 = false -- shunt/peripheral/uplink.yue:49
        repeat -- shunt/peripheral/uplink.yue:49
          id, packet, protocol = self.backend:receive(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:49
          if self.deaf then -- shunt/peripheral/uplink.yue:50
            _continue_0 = true -- shunt/peripheral/uplink.yue:51
            break -- shunt/peripheral/uplink.yue:51
          end -- shunt/peripheral/uplink.yue:50
          if not (id ~= nil) then -- shunt/peripheral/uplink.yue:53
            return nil, TIMEOUT -- shunt/peripheral/uplink.yue:54
          end -- shunt/peripheral/uplink.yue:53
          if not (from_id ~= nil) or id == from_id then -- shunt/peripheral/uplink.yue:55
            break -- shunt/peripheral/uplink.yue:56
          end -- shunt/peripheral/uplink.yue:55
          _continue_0 = true -- shunt/peripheral/uplink.yue:49
        until true -- shunt/peripheral/uplink.yue:56
        if not _continue_0 then -- shunt/peripheral/uplink.yue:56
          break -- shunt/peripheral/uplink.yue:56
        end -- shunt/peripheral/uplink.yue:56
      end -- shunt/peripheral/uplink.yue:56
      if not (packet_type ~= nil) then -- shunt/peripheral/uplink.yue:58
        packet.protocol = protocol -- shunt/peripheral/uplink.yue:59
        return id, packet -- shunt/peripheral/uplink.yue:60
      end -- shunt/peripheral/uplink.yue:58
      packet.protocol = protocol -- shunt/peripheral/uplink.yue:62
      if not packet_type:matches(packet) then -- shunt/peripheral/uplink.yue:63
        local repr = require('shunt.spec').repr -- shunt/peripheral/uplink.yue:0
        error("unexpected packet " .. tostring(repr(packet)) .. ", expected " .. tostring(packet_type:protocol()) .. " but got " .. tostring(packet.protocol)) -- shunt/peripheral/uplink.yue:65
      end -- shunt/peripheral/uplink.yue:63
      return id, packet -- shunt/peripheral/uplink.yue:66
    end) -- shunt/peripheral/uplink.yue:22
  } -- shunt/peripheral/uplink.yue:22
  if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:22
    _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:22
  end -- shunt/peripheral/uplink.yue:66
  _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:22
    __init = F('(?UplinkBackend) => <>', function(self, backend) -- shunt/peripheral/uplink.yue:23
      if backend == nil then -- shunt/peripheral/uplink.yue:23
        backend = MinecraftBackend() -- shunt/peripheral/uplink.yue:23
      end -- shunt/peripheral/uplink.yue:23
      self.backend = backend -- shunt/peripheral/uplink.yue:23
      self.deaf = false -- shunt/peripheral/uplink.yue:24
    end), -- shunt/peripheral/uplink.yue:22
    __base = _base_0, -- shunt/peripheral/uplink.yue:22
    __name = "Uplink" -- shunt/peripheral/uplink.yue:22
  }, { -- shunt/peripheral/uplink.yue:22
    __index = _base_0, -- shunt/peripheral/uplink.yue:22
    __call = function(cls, ...) -- shunt/peripheral/uplink.yue:22
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:22
      cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:22
      return _self_0 -- shunt/peripheral/uplink.yue:22
    end -- shunt/peripheral/uplink.yue:22
  }) -- shunt/peripheral/uplink.yue:22
  _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:22
  Uplink = _class_0 -- shunt/peripheral/uplink.yue:22
end -- shunt/peripheral/uplink.yue:66
_module_0["Uplink"] = Uplink -- shunt/peripheral/uplink.yue:22
declare_type('UplinkReceiveOpts', [[{
  timeout: ?number,
}]]) -- shunt/peripheral/uplink.yue:68
declare_type('PeripheralType', '"modem"') -- shunt/peripheral/uplink.yue:72
do -- shunt/peripheral/uplink.yue:73
  local _class_0 -- shunt/peripheral/uplink.yue:73
  local _base_0 = { -- shunt/peripheral/uplink.yue:73
    send = F('(number, any, ?string) => boolean', function(self, recipient, packet, protocol) -- shunt/peripheral/uplink.yue:79
      return rednet.send(recipient, packet, protocol) -- shunt/peripheral/uplink.yue:80
    end), -- shunt/peripheral/uplink.yue:82
    receive = F('(?string, ?number) => <?number, ?any, ?string>', function(self, protocol, timeout) -- shunt/peripheral/uplink.yue:82
      return rednet.receive(protocol, timeout) -- shunt/peripheral/uplink.yue:83
    end), -- shunt/peripheral/uplink.yue:85
    broadcast = F('(any, ?string) => <>', function(self, packet, protocol) -- shunt/peripheral/uplink.yue:85
      return rednet.broadcast(packet, protocol) -- shunt/peripheral/uplink.yue:86
    end) -- shunt/peripheral/uplink.yue:73
  } -- shunt/peripheral/uplink.yue:73
  if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:73
    _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:73
  end -- shunt/peripheral/uplink.yue:86
  _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:73
    __init = function(self) -- shunt/peripheral/uplink.yue:74
      peripheral.find('modem', rednet.open) -- shunt/peripheral/uplink.yue:75
      if not rednet.isOpen() then -- shunt/peripheral/uplink.yue:76
        return error('cannot create Uplink: no modem') -- shunt/peripheral/uplink.yue:77
      end -- shunt/peripheral/uplink.yue:76
    end, -- shunt/peripheral/uplink.yue:73
    __base = _base_0, -- shunt/peripheral/uplink.yue:73
    __name = "MinecraftBackend" -- shunt/peripheral/uplink.yue:73
  }, { -- shunt/peripheral/uplink.yue:73
    __index = _base_0, -- shunt/peripheral/uplink.yue:73
    __call = function(cls, ...) -- shunt/peripheral/uplink.yue:73
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:73
      cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:73
      return _self_0 -- shunt/peripheral/uplink.yue:73
    end -- shunt/peripheral/uplink.yue:73
  }) -- shunt/peripheral/uplink.yue:73
  _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:73
  MinecraftBackend = _class_0 -- shunt/peripheral/uplink.yue:73
end -- shunt/peripheral/uplink.yue:86
declare_type('Packet', [[{
  protocol: string,
}]]) -- shunt/peripheral/uplink.yue:88
declare_type('PacketType', [[{
  protocol: () => string,
}]]) -- shunt/peripheral/uplink.yue:91
local Packet -- shunt/peripheral/uplink.yue:94
do -- shunt/peripheral/uplink.yue:94
  local _class_0 -- shunt/peripheral/uplink.yue:94
  local _base_0 = { } -- shunt/peripheral/uplink.yue:94
  if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:94
    _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:94
  end -- shunt/peripheral/uplink.yue:102
  _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:94
    __init = F('() => <>', function(self) -- shunt/peripheral/uplink.yue:95
      self.protocol = self.__class:protocol() -- shunt/peripheral/uplink.yue:96
    end), -- shunt/peripheral/uplink.yue:94
    __base = _base_0, -- shunt/peripheral/uplink.yue:94
    __name = "Packet" -- shunt/peripheral/uplink.yue:94
  }, { -- shunt/peripheral/uplink.yue:94
    __index = _base_0, -- shunt/peripheral/uplink.yue:94
    __call = function(cls, ...) -- shunt/peripheral/uplink.yue:94
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:94
      cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:94
      return _self_0 -- shunt/peripheral/uplink.yue:94
    end -- shunt/peripheral/uplink.yue:94
  }) -- shunt/peripheral/uplink.yue:94
  _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:94
  local self = _class_0; -- shunt/peripheral/uplink.yue:94
  self.protocol = F('() => string', function(self) -- shunt/peripheral/uplink.yue:98
    return self.__class.__name -- shunt/peripheral/uplink.yue:99
  end) -- shunt/peripheral/uplink.yue:98
  self.matches = F('(Packet) => boolean', function(self, raw) -- shunt/peripheral/uplink.yue:101
    return raw.protocol == self.__class:protocol() -- shunt/peripheral/uplink.yue:102
  end) -- shunt/peripheral/uplink.yue:101
  Packet = _class_0 -- shunt/peripheral/uplink.yue:94
end -- shunt/peripheral/uplink.yue:102
_module_0["Packet"] = Packet -- shunt/peripheral/uplink.yue:94
declare_type('TestUplinkBackendOpts', [[{
  to_receive: ?[NetworkFrameSpec] | () -> [NetworkFrameSpec],
  on_send: ?(number, any, ?string) => boolean,
  on_receive: ?(?string, ?number) => <?number|boolean, any|TIMEOUT, ?string>,
  on_broadcast: ?(any, ?string) => boolean,
}]]) -- shunt/peripheral/uplink.yue:104
declare_type('NetworkFrameSpec', 'NetworkFrame | () -> NetworkFrame') -- shunt/peripheral/uplink.yue:110
declare_type('NetworkFrame', [[  { from_id: number } + NetworkFrameData
]]) -- shunt/peripheral/uplink.yue:111
declare_type('NetworkFrameData', [[{
  packet: any,
  protocol: ?string,
}]]) -- shunt/peripheral/uplink.yue:114
local TestUplinkBackend -- shunt/peripheral/uplink.yue:118
do -- shunt/peripheral/uplink.yue:118
  local _class_0 -- shunt/peripheral/uplink.yue:118
  local _base_0 = { -- shunt/peripheral/uplink.yue:118
    reset = F('() => <>', function(self) -- shunt/peripheral/uplink.yue:143
      self.num_received = T('number', 0) -- shunt/peripheral/uplink.yue:144
      self.to_receive = T('[NetworkFrameSpec]', (function() -- shunt/peripheral/uplink.yue:146
        local _exp_0 = type(self.original_to_receive) -- shunt/peripheral/uplink.yue:146
        if 'table' == _exp_0 then -- shunt/peripheral/uplink.yue:147
          local _accum_0 = { } -- shunt/peripheral/uplink.yue:148
          local _len_0 = 1 -- shunt/peripheral/uplink.yue:148
          local _list_0 = self.original_to_receive -- shunt/peripheral/uplink.yue:148
          for _index_0 = 1, #_list_0 do -- shunt/peripheral/uplink.yue:148
            local frame = _list_0[_index_0] -- shunt/peripheral/uplink.yue:148
            _accum_0[_len_0] = frame -- shunt/peripheral/uplink.yue:148
            _len_0 = _len_0 + 1 -- shunt/peripheral/uplink.yue:148
          end -- shunt/peripheral/uplink.yue:148
          return _accum_0 -- shunt/peripheral/uplink.yue:148
        elseif 'function' == _exp_0 then -- shunt/peripheral/uplink.yue:149
          return self:original_to_receive() -- shunt/peripheral/uplink.yue:150
        end -- shunt/peripheral/uplink.yue:150
      end)()) -- shunt/peripheral/uplink.yue:145
      self.num_to_receive = T('number', #self.to_receive) -- shunt/peripheral/uplink.yue:151
      self.sent = T('[NetworkFrame]', { }) -- shunt/peripheral/uplink.yue:152
      self.broadcasted = T('[NetworkFrameData]', { }) -- shunt/peripheral/uplink.yue:153
    end), -- shunt/peripheral/uplink.yue:155
    send = F('(number, any, ?string) => boolean', function(self, id, packet, protocol) -- shunt/peripheral/uplink.yue:155
      if (self.on_send ~= nil) and not self:on_send(id, packet, protocol) then -- shunt/peripheral/uplink.yue:156
        return false -- shunt/peripheral/uplink.yue:157
      end -- shunt/peripheral/uplink.yue:156
      do -- shunt/peripheral/uplink.yue:158
        local _obj_0 = self.sent -- shunt/peripheral/uplink.yue:158
        _obj_0[#_obj_0 + 1] = { -- shunt/peripheral/uplink.yue:158
          id = id, -- shunt/peripheral/uplink.yue:158
          packet = packet, -- shunt/peripheral/uplink.yue:158
          protocol = protocol -- shunt/peripheral/uplink.yue:158
        } -- shunt/peripheral/uplink.yue:158
      end -- shunt/peripheral/uplink.yue:158
      return true -- shunt/peripheral/uplink.yue:159
    end), -- shunt/peripheral/uplink.yue:161
    broadcast = F('(any, ?string) => <>', function(self, packet, protocol) -- shunt/peripheral/uplink.yue:161
      if (self.on_broadcast ~= nil) and not self:on_broadcast(packet, protocol) then -- shunt/peripheral/uplink.yue:162
        return false -- shunt/peripheral/uplink.yue:163
      end -- shunt/peripheral/uplink.yue:162
      do -- shunt/peripheral/uplink.yue:164
        local _obj_0 = self.broadcasted -- shunt/peripheral/uplink.yue:164
        _obj_0[#_obj_0 + 1] = { -- shunt/peripheral/uplink.yue:164
          packet = packet, -- shunt/peripheral/uplink.yue:164
          protocol = protocol -- shunt/peripheral/uplink.yue:164
        } -- shunt/peripheral/uplink.yue:164
      end -- shunt/peripheral/uplink.yue:164
    end), -- shunt/peripheral/uplink.yue:166
    receive = F('(?string, ?number) => <?number, any|TIMEOUT, ?string>', function(self, protocol_filter, timeout) -- shunt/peripheral/uplink.yue:166
      if (self.on_receive ~= nil) then -- shunt/peripheral/uplink.yue:167
        local id, resp, protocol = self:on_receive(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:168
        do -- shunt/peripheral/uplink.yue:169
          local _exp_0 = type(id) -- shunt/peripheral/uplink.yue:169
          if 'number' == _exp_0 then -- shunt/peripheral/uplink.yue:170
            return id, resp, protocol -- shunt/peripheral/uplink.yue:171
          elseif 'boolean' == _exp_0 then -- shunt/peripheral/uplink.yue:172
            if not id then -- shunt/peripheral/uplink.yue:173
              trace("! no more " .. tostring((protocol_filter ~= nil) and protocol_filter .. ' ' or '') .. "packets to receive") -- shunt/peripheral/uplink.yue:174
              return self:on_absent_frame(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:175
            end -- shunt/peripheral/uplink.yue:173
          elseif 'nil' == _exp_0 then -- shunt/peripheral/uplink.yue:176
          else -- shunt/peripheral/uplink.yue:179
            error("unexpected return type: " .. tostring(type(id))) -- shunt/peripheral/uplink.yue:179
          end -- shunt/peripheral/uplink.yue:179
        end -- shunt/peripheral/uplink.yue:179
      end -- shunt/peripheral/uplink.yue:167
      print('num to receive ', self.num_to_receive) -- shunt/peripheral/uplink.yue:180
      for i = 1, self.num_to_receive do -- shunt/peripheral/uplink.yue:182
        local _continue_0 = false -- shunt/peripheral/uplink.yue:183
        repeat -- shunt/peripheral/uplink.yue:183
          local frame = self.to_receive[i] -- shunt/peripheral/uplink.yue:183
          if not (frame ~= nil) then -- shunt/peripheral/uplink.yue:184
            _continue_0 = true -- shunt/peripheral/uplink.yue:185
            break -- shunt/peripheral/uplink.yue:185
          end -- shunt/peripheral/uplink.yue:184
          if 'function' == type(frame) then -- shunt/peripheral/uplink.yue:186
            frame = T('NetworkFrame', frame()) -- shunt/peripheral/uplink.yue:187
          end -- shunt/peripheral/uplink.yue:186
          local from_id, packet, protocol = frame.from_id, frame.packet, frame.protocol -- shunt/peripheral/uplink.yue:188
          if not (protocol ~= nil) and (packet.protocol ~= nil) then -- shunt/peripheral/uplink.yue:189
            protocol = packet.protocol -- shunt/peripheral/uplink.yue:190
          end -- shunt/peripheral/uplink.yue:189
          if not (protocol_filter ~= nil) or protocol_filter == protocol then -- shunt/peripheral/uplink.yue:192
            self.to_receive[i] = nil -- shunt/peripheral/uplink.yue:193
            self.num_received = self.num_received + 1 -- shunt/peripheral/uplink.yue:194
            return from_id, packet, protocol -- shunt/peripheral/uplink.yue:195
          end -- shunt/peripheral/uplink.yue:192
          _continue_0 = true -- shunt/peripheral/uplink.yue:183
        until true -- shunt/peripheral/uplink.yue:195
        if not _continue_0 then -- shunt/peripheral/uplink.yue:195
          break -- shunt/peripheral/uplink.yue:195
        end -- shunt/peripheral/uplink.yue:195
      end -- shunt/peripheral/uplink.yue:195
      trace("! no more " .. tostring((protocol_filter ~= nil) and protocol_filter .. ' ' or '') .. "packets to receive") -- shunt/peripheral/uplink.yue:197
      return self:on_absent_frame(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:198
    end), -- shunt/peripheral/uplink.yue:200
    on_absent_frame = F('(?string, ?number) => <?number, any|TIMEOUT, ?string>', function(self, protocol_filter, timeout) -- shunt/peripheral/uplink.yue:200
      if (timeout ~= nil) then -- shunt/peripheral/uplink.yue:201
        return nil, TIMEOUT, nil -- shunt/peripheral/uplink.yue:202
      end -- shunt/peripheral/uplink.yue:201
      if not (coroutine.running() ~= nil) then -- shunt/peripheral/uplink.yue:204
        error("internal test error: network-read of " .. tostring(protocol_filter) .. " would cause jam (no timeout, not in coroutine)") -- shunt/peripheral/uplink.yue:205
      end -- shunt/peripheral/uplink.yue:204
      coroutine.yield() -- shunt/peripheral/uplink.yue:207
      while true do -- shunt/peripheral/uplink.yue:208
        if (self.on_receive ~= nil) then -- shunt/peripheral/uplink.yue:209
          local id, pkg, protocol = self:on_receive(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:210
          if (id ~= nil) then -- shunt/peripheral/uplink.yue:211
            return id, pkg, protocol -- shunt/peripheral/uplink.yue:212
          end -- shunt/peripheral/uplink.yue:211
        end -- shunt/peripheral/uplink.yue:209
        if self.num_received ~= self.num_to_receive then -- shunt/peripheral/uplink.yue:213
          break -- shunt/peripheral/uplink.yue:214
        end -- shunt/peripheral/uplink.yue:213
        coroutine.yield() -- shunt/peripheral/uplink.yue:215
      end -- shunt/peripheral/uplink.yue:215
      return self:receive(protocol_filter, timeout) -- shunt/peripheral/uplink.yue:217
    end) -- shunt/peripheral/uplink.yue:118
  } -- shunt/peripheral/uplink.yue:118
  if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:118
    _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:118
  end -- shunt/peripheral/uplink.yue:217
  _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:118
    __init = F('(?TestUplinkBackendOpts) => <>', function(self, opts) -- shunt/peripheral/uplink.yue:119
      if opts == nil then -- shunt/peripheral/uplink.yue:119
        opts = { } -- shunt/peripheral/uplink.yue:119
      end -- shunt/peripheral/uplink.yue:119
      assert(not opts.send, "internal test error: TestUplinkBackend.send is deprecated") -- shunt/peripheral/uplink.yue:122
      assert(not opts.receive, "internal test error: TestUplinkBackend.receive is deprecated") -- shunt/peripheral/uplink.yue:123
      assert(not opts.broadcast, "internal test error: TestUplinkBackend.broadcast is deprecated") -- shunt/peripheral/uplink.yue:124
      local to_receive, on_send, on_receive, on_broadcast = opts.to_receive, opts.on_send, opts.on_receive, opts.on_broadcast -- shunt/peripheral/uplink.yue:126
      if to_receive == nil then -- shunt/peripheral/uplink.yue:127
        to_receive = { } -- shunt/peripheral/uplink.yue:127
      end -- shunt/peripheral/uplink.yue:127
      if (on_send ~= nil) then -- shunt/peripheral/uplink.yue:133
        self.on_send = F('(number, any, ?string) => boolean', on_send) -- shunt/peripheral/uplink.yue:134
      end -- shunt/peripheral/uplink.yue:133
      if (on_receive ~= nil) then -- shunt/peripheral/uplink.yue:135
        self.on_receive = F('(?string, ?number) => <?number|boolean, any|TIMEOUT, ?string>', on_receive) -- shunt/peripheral/uplink.yue:136
      end -- shunt/peripheral/uplink.yue:135
      if (on_broadcast ~= nil) then -- shunt/peripheral/uplink.yue:137
        self.on_broadcast = F('(any, ?string) => boolean', on_broadcast) -- shunt/peripheral/uplink.yue:138
      end -- shunt/peripheral/uplink.yue:137
      self.original_to_receive = to_receive -- shunt/peripheral/uplink.yue:140
      return self:reset() -- shunt/peripheral/uplink.yue:141
    end), -- shunt/peripheral/uplink.yue:118
    __base = _base_0, -- shunt/peripheral/uplink.yue:118
    __name = "TestUplinkBackend" -- shunt/peripheral/uplink.yue:118
  }, { -- shunt/peripheral/uplink.yue:118
    __index = _base_0, -- shunt/peripheral/uplink.yue:118
    __call = function(cls, ...) -- shunt/peripheral/uplink.yue:118
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:118
      cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:118
      return _self_0 -- shunt/peripheral/uplink.yue:118
    end -- shunt/peripheral/uplink.yue:118
  }) -- shunt/peripheral/uplink.yue:118
  _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:118
  TestUplinkBackend = _class_0 -- shunt/peripheral/uplink.yue:118
end -- shunt/peripheral/uplink.yue:217
_module_0["TestUplinkBackend"] = TestUplinkBackend -- shunt/peripheral/uplink.yue:118
declare_type('IdempotenceToken', 'number') -- shunt/peripheral/uplink.yue:219
IDEMP_TOK_MAX = bit.lshift(1, 30) -- shunt/peripheral/uplink.yue:220
IdempotenceToken = F('() -> IdempotenceToken', function() -- shunt/peripheral/uplink.yue:221
  return math.random(1, IDEMP_TOK_MAX) -- shunt/peripheral/uplink.yue:222
end) -- shunt/peripheral/uplink.yue:221
_module_0["IdempotenceToken"] = IdempotenceToken -- shunt/peripheral/uplink.yue:222
spec(function() -- shunt/peripheral/uplink.yue:224
  local describe, it, matchers -- shunt/peripheral/uplink.yue:0
  do -- shunt/peripheral/uplink.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/peripheral/uplink.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/peripheral/uplink.yue:0
  end -- shunt/peripheral/uplink.yue:0
  local deep_eq, eq, errors, matches, no_errors = matchers.deep_eq, matchers.eq, matchers.errors, matchers.matches, matchers.no_errors -- shunt/peripheral/uplink.yue:229
  local TestPacket -- shunt/peripheral/uplink.yue:231
  do -- shunt/peripheral/uplink.yue:231
    local _class_0 -- shunt/peripheral/uplink.yue:231
    local _parent_0 = Packet -- shunt/peripheral/uplink.yue:231
    local _base_0 = { } -- shunt/peripheral/uplink.yue:231
    for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/peripheral/uplink.yue:233
      if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/peripheral/uplink.yue:231
        _base_0[_key_0] = _val_0 -- shunt/peripheral/uplink.yue:231
      end -- shunt/peripheral/uplink.yue:231
    end -- shunt/peripheral/uplink.yue:233
    if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:231
      _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:231
    end -- shunt/peripheral/uplink.yue:233
    setmetatable(_base_0, _parent_0.__base) -- shunt/peripheral/uplink.yue:231
    _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:231
      __init = function(self, data) -- shunt/peripheral/uplink.yue:232
        self.data = data -- shunt/peripheral/uplink.yue:232
        return _class_0.__parent.__init(self) -- shunt/peripheral/uplink.yue:233
      end, -- shunt/peripheral/uplink.yue:231
      __base = _base_0, -- shunt/peripheral/uplink.yue:231
      __name = "TestPacket", -- shunt/peripheral/uplink.yue:231
      __parent = _parent_0 -- shunt/peripheral/uplink.yue:231
    }, { -- shunt/peripheral/uplink.yue:231
      __index = function(cls, name) -- shunt/peripheral/uplink.yue:231
        local val = rawget(_base_0, name) -- shunt/peripheral/uplink.yue:231
        if val == nil then -- shunt/peripheral/uplink.yue:231
          local parent = rawget(cls, "__parent") -- shunt/peripheral/uplink.yue:231
          if parent then -- shunt/peripheral/uplink.yue:231
            return parent[name] -- shunt/peripheral/uplink.yue:231
          end -- shunt/peripheral/uplink.yue:231
        else -- shunt/peripheral/uplink.yue:231
          return val -- shunt/peripheral/uplink.yue:231
        end -- shunt/peripheral/uplink.yue:231
      end, -- shunt/peripheral/uplink.yue:231
      __call = function(cls, ...) -- shunt/peripheral/uplink.yue:231
        local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:231
        cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:231
        return _self_0 -- shunt/peripheral/uplink.yue:231
      end -- shunt/peripheral/uplink.yue:231
    }) -- shunt/peripheral/uplink.yue:231
    _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:231
    if _parent_0.__inherited then -- shunt/peripheral/uplink.yue:231
      _parent_0.__inherited(_parent_0, _class_0) -- shunt/peripheral/uplink.yue:231
    end -- shunt/peripheral/uplink.yue:231
    TestPacket = _class_0 -- shunt/peripheral/uplink.yue:231
  end -- shunt/peripheral/uplink.yue:233
  local TestPacket2 -- shunt/peripheral/uplink.yue:235
  do -- shunt/peripheral/uplink.yue:235
    local _class_0 -- shunt/peripheral/uplink.yue:235
    local _parent_0 = Packet -- shunt/peripheral/uplink.yue:235
    local _base_0 = { } -- shunt/peripheral/uplink.yue:235
    for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/peripheral/uplink.yue:237
      if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/peripheral/uplink.yue:235
        _base_0[_key_0] = _val_0 -- shunt/peripheral/uplink.yue:235
      end -- shunt/peripheral/uplink.yue:235
    end -- shunt/peripheral/uplink.yue:237
    if _base_0.__index == nil then -- shunt/peripheral/uplink.yue:235
      _base_0.__index = _base_0 -- shunt/peripheral/uplink.yue:235
    end -- shunt/peripheral/uplink.yue:237
    setmetatable(_base_0, _parent_0.__base) -- shunt/peripheral/uplink.yue:235
    _class_0 = setmetatable({ -- shunt/peripheral/uplink.yue:235
      __init = function(self, data) -- shunt/peripheral/uplink.yue:236
        self.data = data -- shunt/peripheral/uplink.yue:236
        return _class_0.__parent.__init(self) -- shunt/peripheral/uplink.yue:237
      end, -- shunt/peripheral/uplink.yue:235
      __base = _base_0, -- shunt/peripheral/uplink.yue:235
      __name = "TestPacket2", -- shunt/peripheral/uplink.yue:235
      __parent = _parent_0 -- shunt/peripheral/uplink.yue:235
    }, { -- shunt/peripheral/uplink.yue:235
      __index = function(cls, name) -- shunt/peripheral/uplink.yue:235
        local val = rawget(_base_0, name) -- shunt/peripheral/uplink.yue:235
        if val == nil then -- shunt/peripheral/uplink.yue:235
          local parent = rawget(cls, "__parent") -- shunt/peripheral/uplink.yue:235
          if parent then -- shunt/peripheral/uplink.yue:235
            return parent[name] -- shunt/peripheral/uplink.yue:235
          end -- shunt/peripheral/uplink.yue:235
        else -- shunt/peripheral/uplink.yue:235
          return val -- shunt/peripheral/uplink.yue:235
        end -- shunt/peripheral/uplink.yue:235
      end, -- shunt/peripheral/uplink.yue:235
      __call = function(cls, ...) -- shunt/peripheral/uplink.yue:235
        local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/uplink.yue:235
        cls.__init(_self_0, ...) -- shunt/peripheral/uplink.yue:235
        return _self_0 -- shunt/peripheral/uplink.yue:235
      end -- shunt/peripheral/uplink.yue:235
    }) -- shunt/peripheral/uplink.yue:235
    _base_0.__class = _class_0 -- shunt/peripheral/uplink.yue:235
    if _parent_0.__inherited then -- shunt/peripheral/uplink.yue:235
      _parent_0.__inherited(_parent_0, _class_0) -- shunt/peripheral/uplink.yue:235
    end -- shunt/peripheral/uplink.yue:235
    TestPacket2 = _class_0 -- shunt/peripheral/uplink.yue:235
  end -- shunt/peripheral/uplink.yue:237
  describe('Uplink', function() -- shunt/peripheral/uplink.yue:239
    describe('default backend', function() -- shunt/peripheral/uplink.yue:240
      if not _G.skip_minecraft_tests then -- shunt/peripheral/uplink.yue:241
        return -- shunt/peripheral/uplink.yue:242
      end -- shunt/peripheral/uplink.yue:241
      return it('requires a modem', function() -- shunt/peripheral/uplink.yue:244
        if peripheral.find('modem') then -- shunt/peripheral/uplink.yue:245
          return require('shunt.spec')._expect_that([=[(-> Uplink!)]=], (function() -- shunt/peripheral/uplink.yue:246
            return Uplink() -- shunt/peripheral/uplink.yue:246
          end), (no_errors()), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(246)) -- shunt/peripheral/uplink.yue:246
        else -- shunt/peripheral/uplink.yue:248
          return require('shunt.spec')._expect_that([=[(-> Uplink!)]=], (function() -- shunt/peripheral/uplink.yue:248
            return Uplink() -- shunt/peripheral/uplink.yue:248
          end), (errors(matches('cannot find modem'))), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(248)) -- shunt/peripheral/uplink.yue:248
        end -- shunt/peripheral/uplink.yue:245
      end) -- shunt/peripheral/uplink.yue:248
    end) -- shunt/peripheral/uplink.yue:240
    describe('\\broadcast', function() -- shunt/peripheral/uplink.yue:250
      return it('sends the given packet', function() -- shunt/peripheral/uplink.yue:251
        local uplink = Uplink(TestUplinkBackend()) -- shunt/peripheral/uplink.yue:252
        uplink:broadcast(TestPacket('data-1')) -- shunt/peripheral/uplink.yue:254
        uplink:broadcast(TestPacket('data-2')); -- shunt/peripheral/uplink.yue:255
        return require('shunt.spec')._expect_that([=[uplink.backend.broadcasted]=], uplink.backend.broadcasted, (deep_eq({ -- shunt/peripheral/uplink.yue:257
          { -- shunt/peripheral/uplink.yue:257
            protocol = 'TestPacket', -- shunt/peripheral/uplink.yue:257
            packet = TestPacket('data-1') -- shunt/peripheral/uplink.yue:257
          }, -- shunt/peripheral/uplink.yue:257
          { -- shunt/peripheral/uplink.yue:257
            protocol = 'TestPacket', -- shunt/peripheral/uplink.yue:257
            packet = TestPacket('data-2') -- shunt/peripheral/uplink.yue:257
          } -- shunt/peripheral/uplink.yue:257
        })), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(257)) -- shunt/peripheral/uplink.yue:259
      end) -- shunt/peripheral/uplink.yue:259
    end) -- shunt/peripheral/uplink.yue:250
    describe('\\send_to', function() -- shunt/peripheral/uplink.yue:261
      it('sends the given packet', function() -- shunt/peripheral/uplink.yue:262
        local uplink = Uplink(TestUplinkBackend()) -- shunt/peripheral/uplink.yue:263
        uplink:send_to(1, TestPacket('packet-1')) -- shunt/peripheral/uplink.yue:265
        uplink:send_to(2, TestPacket('packet-2')); -- shunt/peripheral/uplink.yue:266
        return require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (deep_eq({ -- shunt/peripheral/uplink.yue:268
          { -- shunt/peripheral/uplink.yue:268
            id = 1, -- shunt/peripheral/uplink.yue:268
            protocol = 'TestPacket', -- shunt/peripheral/uplink.yue:268
            packet = TestPacket('packet-1') -- shunt/peripheral/uplink.yue:268
          }, -- shunt/peripheral/uplink.yue:268
          { -- shunt/peripheral/uplink.yue:268
            id = 2, -- shunt/peripheral/uplink.yue:268
            protocol = 'TestPacket', -- shunt/peripheral/uplink.yue:268
            packet = TestPacket('packet-2') -- shunt/peripheral/uplink.yue:268
          } -- shunt/peripheral/uplink.yue:268
        })), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(268)) -- shunt/peripheral/uplink.yue:270
      end) -- shunt/peripheral/uplink.yue:262
      return it('handles transmission failure', function() -- shunt/peripheral/uplink.yue:272
        local uplink = Uplink(TestUplinkBackend({ -- shunt/peripheral/uplink.yue:274
          on_send = function(_, _, _) -- shunt/peripheral/uplink.yue:274
            return false -- shunt/peripheral/uplink.yue:274
          end -- shunt/peripheral/uplink.yue:274
        })); -- shunt/peripheral/uplink.yue:273
        return require('shunt.spec')._expect_that([=[(-> uplink\send_to 1, TestPacket 'packet-1')]=], (function() -- shunt/peripheral/uplink.yue:276
          return uplink:send_to(1, TestPacket('packet-1')) -- shunt/peripheral/uplink.yue:276
        end), (errors(matches("failed to send TestPacket"))), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(276)) -- shunt/peripheral/uplink.yue:276
      end) -- shunt/peripheral/uplink.yue:276
    end) -- shunt/peripheral/uplink.yue:261
    describe('\\receive_from_any', function() -- shunt/peripheral/uplink.yue:278
      it('receives the only given packet', function() -- shunt/peripheral/uplink.yue:279
        local num_received = 0 -- shunt/peripheral/uplink.yue:280
        local uplink = Uplink(TestUplinkBackend({ -- shunt/peripheral/uplink.yue:282
          to_receive = { -- shunt/peripheral/uplink.yue:283
            { -- shunt/peripheral/uplink.yue:283
              from_id = 1, -- shunt/peripheral/uplink.yue:283
              packet = TestPacket('packet-1') -- shunt/peripheral/uplink.yue:284
            }, -- shunt/peripheral/uplink.yue:283
            { -- shunt/peripheral/uplink.yue:285
              from_id = 2, -- shunt/peripheral/uplink.yue:285
              packet = TestPacket2('packet-2') -- shunt/peripheral/uplink.yue:286
            }, -- shunt/peripheral/uplink.yue:285
            { -- shunt/peripheral/uplink.yue:287
              from_id = 3, -- shunt/peripheral/uplink.yue:287
              packet = TestPacket('packet-3') -- shunt/peripheral/uplink.yue:288
            }, -- shunt/peripheral/uplink.yue:287
            { -- shunt/peripheral/uplink.yue:289
              from_id = 4, -- shunt/peripheral/uplink.yue:289
              packet = TestPacket2('packet-4') -- shunt/peripheral/uplink.yue:290
            } -- shunt/peripheral/uplink.yue:289
          } -- shunt/peripheral/uplink.yue:282
        })) -- shunt/peripheral/uplink.yue:281
        local received -- shunt/peripheral/uplink.yue:292
        do -- shunt/peripheral/uplink.yue:292
          local _with_0 = { } -- shunt/peripheral/uplink.yue:292
          _with_0[#_with_0 + 1] = { -- shunt/peripheral/uplink.yue:293
            uplink:receive_from_any(TestPacket2, { -- shunt/peripheral/uplink.yue:293
              timeout = 1 -- shunt/peripheral/uplink.yue:293
            }) -- shunt/peripheral/uplink.yue:293
          } -- shunt/peripheral/uplink.yue:293
          _with_0[#_with_0 + 1] = { -- shunt/peripheral/uplink.yue:294
            uplink:receive_from_any(TestPacket, { -- shunt/peripheral/uplink.yue:294
              timeout = 1 -- shunt/peripheral/uplink.yue:294
            }) -- shunt/peripheral/uplink.yue:294
          } -- shunt/peripheral/uplink.yue:294
          _with_0[#_with_0 + 1] = { -- shunt/peripheral/uplink.yue:295
            uplink:receive_from_any(TestPacket2, { -- shunt/peripheral/uplink.yue:295
              timeout = 1 -- shunt/peripheral/uplink.yue:295
            }) -- shunt/peripheral/uplink.yue:295
          } -- shunt/peripheral/uplink.yue:295
          _with_0[#_with_0 + 1] = { -- shunt/peripheral/uplink.yue:296
            uplink:receive_from_any(TestPacket, { -- shunt/peripheral/uplink.yue:296
              timeout = 1 -- shunt/peripheral/uplink.yue:296
            }) -- shunt/peripheral/uplink.yue:296
          } -- shunt/peripheral/uplink.yue:296
          received = _with_0 -- shunt/peripheral/uplink.yue:292
        end -- shunt/peripheral/uplink.yue:292
        return require('shunt.spec')._expect_that([=[received]=], received, (deep_eq({ -- shunt/peripheral/uplink.yue:298
          { -- shunt/peripheral/uplink.yue:298
            2, -- shunt/peripheral/uplink.yue:298
            TestPacket2('packet-2') -- shunt/peripheral/uplink.yue:298
          }, -- shunt/peripheral/uplink.yue:298
          { -- shunt/peripheral/uplink.yue:298
            1, -- shunt/peripheral/uplink.yue:298
            TestPacket('packet-1') -- shunt/peripheral/uplink.yue:298
          }, -- shunt/peripheral/uplink.yue:298
          { -- shunt/peripheral/uplink.yue:298
            4, -- shunt/peripheral/uplink.yue:298
            TestPacket2('packet-4') -- shunt/peripheral/uplink.yue:298
          }, -- shunt/peripheral/uplink.yue:298
          { -- shunt/peripheral/uplink.yue:298
            3, -- shunt/peripheral/uplink.yue:298
            TestPacket('packet-3') -- shunt/peripheral/uplink.yue:298
          } -- shunt/peripheral/uplink.yue:298
        })), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(298)) -- shunt/peripheral/uplink.yue:302
      end) -- shunt/peripheral/uplink.yue:279
      return it('gracefully handles timeout', function() -- shunt/peripheral/uplink.yue:304
        local uplink = Uplink(TestUplinkBackend({ -- shunt/peripheral/uplink.yue:305
          to_receive = { } -- shunt/peripheral/uplink.yue:305
        })) -- shunt/peripheral/uplink.yue:305
        local id, err = uplink:receive_from_any(TestPacket, { -- shunt/peripheral/uplink.yue:306
          timeout = 1 -- shunt/peripheral/uplink.yue:306
        }); -- shunt/peripheral/uplink.yue:306
        require('shunt.spec')._expect_that([=[id]=], id, (eq(nil)), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(307)); -- shunt/peripheral/uplink.yue:307
        return require('shunt.spec')._expect_that([=[err]=], err, (eq(TIMEOUT)), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(308)) -- shunt/peripheral/uplink.yue:308
      end) -- shunt/peripheral/uplink.yue:308
    end) -- shunt/peripheral/uplink.yue:278
    return describe('\\receive_from', function() -- shunt/peripheral/uplink.yue:310
      return it('receives the only given packet', function() -- shunt/peripheral/uplink.yue:311
        local num_received = 0 -- shunt/peripheral/uplink.yue:312
        local uplink = Uplink(TestUplinkBackend({ -- shunt/peripheral/uplink.yue:314
          to_receive = { -- shunt/peripheral/uplink.yue:315
            { -- shunt/peripheral/uplink.yue:315
              from_id = 1, -- shunt/peripheral/uplink.yue:315
              packet = TestPacket('packet-1') -- shunt/peripheral/uplink.yue:316
            }, -- shunt/peripheral/uplink.yue:315
            { -- shunt/peripheral/uplink.yue:317
              from_id = 2, -- shunt/peripheral/uplink.yue:317
              packet = TestPacket2('packet-2') -- shunt/peripheral/uplink.yue:318
            }, -- shunt/peripheral/uplink.yue:317
            { -- shunt/peripheral/uplink.yue:319
              from_id = 3, -- shunt/peripheral/uplink.yue:319
              packet = TestPacket('packet-3') -- shunt/peripheral/uplink.yue:320
            }, -- shunt/peripheral/uplink.yue:319
            { -- shunt/peripheral/uplink.yue:321
              from_id = 4, -- shunt/peripheral/uplink.yue:321
              packet = TestPacket2('packet-4') -- shunt/peripheral/uplink.yue:322
            } -- shunt/peripheral/uplink.yue:321
          } -- shunt/peripheral/uplink.yue:314
        })) -- shunt/peripheral/uplink.yue:313
        local received -- shunt/peripheral/uplink.yue:323
        do -- shunt/peripheral/uplink.yue:323
          local _with_0 = { } -- shunt/peripheral/uplink.yue:323
          _with_0[#_with_0 + 1] = { -- shunt/peripheral/uplink.yue:324
            uplink:receive_from(3, TestPacket, { -- shunt/peripheral/uplink.yue:324
              timeout = 1 -- shunt/peripheral/uplink.yue:324
            }) -- shunt/peripheral/uplink.yue:324
          } -- shunt/peripheral/uplink.yue:324
          received = _with_0 -- shunt/peripheral/uplink.yue:323
        end -- shunt/peripheral/uplink.yue:323
        return require('shunt.spec')._expect_that([=[received]=], received, (deep_eq({ -- shunt/peripheral/uplink.yue:326
          { -- shunt/peripheral/uplink.yue:326
            3, -- shunt/peripheral/uplink.yue:326
            TestPacket('packet-3') -- shunt/peripheral/uplink.yue:326
          } -- shunt/peripheral/uplink.yue:326
        })), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(326)) -- shunt/peripheral/uplink.yue:327
      end) -- shunt/peripheral/uplink.yue:327
    end) -- shunt/peripheral/uplink.yue:327
  end) -- shunt/peripheral/uplink.yue:239
  describe('Packet', function() -- shunt/peripheral/uplink.yue:329
    return describe('::matches', function() -- shunt/peripheral/uplink.yue:330
      it('accepts correct packets', function() -- shunt/peripheral/uplink.yue:331
        local ok = TestPacket:matches(TestPacket('hello')); -- shunt/peripheral/uplink.yue:332
        return require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(333)) -- shunt/peripheral/uplink.yue:333
      end) -- shunt/peripheral/uplink.yue:331
      return it('rejects incorrect packets', function() -- shunt/peripheral/uplink.yue:335
        local ok = TestPacket2:matches({ -- shunt/peripheral/uplink.yue:336
          protocol = TestPacket:protocol() -- shunt/peripheral/uplink.yue:336
        }); -- shunt/peripheral/uplink.yue:336
        return require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(337)) -- shunt/peripheral/uplink.yue:337
      end) -- shunt/peripheral/uplink.yue:337
    end) -- shunt/peripheral/uplink.yue:337
  end) -- shunt/peripheral/uplink.yue:329
  return describe('IdempotenceToken', function() -- shunt/peripheral/uplink.yue:339
    return it('is safe to cross lua machine boundaries', function() -- shunt/peripheral/uplink.yue:340
      local idemp_tok = IdempotenceToken(); -- shunt/peripheral/uplink.yue:341
      return require('shunt.spec')._expect_that([=[idemp_tok.<>]=], getmetatable(idemp_tok), (eq(nil)), tostring("shunt/peripheral/uplink.yue") .. ":" .. tostring(342)) -- shunt/peripheral/uplink.yue:342
    end) -- shunt/peripheral/uplink.yue:342
  end) -- shunt/peripheral/uplink.yue:342
end) -- shunt/peripheral/uplink.yue:224
return _module_0 -- shunt/peripheral/uplink.yue:342
end
package.preload['shunt.logger'] = function(...)
-- [yue]: shunt/logger.yue
local _module_0 = { } -- shunt/logger.yue:1
local verbose, LOG_DIR, LOG_FILE, set_log_verbosity, log, fatal, test_mode, activate_test_mode, trace, setup_done, write_to_log, MAX_LOGS, setup_logs -- shunt/logger.yue:1
verbose = false -- shunt/logger.yue:3
LOG_DIR = "logs" -- shunt/logger.yue:5
LOG_FILE = tostring(LOG_DIR) .. "/run-" .. tostring(os.date('%Y-%m-%d@%H:%M:%S')) .. ".log" -- shunt/logger.yue:6
set_log_verbosity = function(v) -- shunt/logger.yue:8
  verbose = v -- shunt/logger.yue:9
end -- shunt/logger.yue:8
_module_0["set_log_verbosity"] = set_log_verbosity -- shunt/logger.yue:9
log = function(fn) -- shunt/logger.yue:11
  local msg = fn() -- shunt/logger.yue:12
  if verbose then -- shunt/logger.yue:13
    print(msg) -- shunt/logger.yue:14
  end -- shunt/logger.yue:13
  return write_to_log(msg) -- shunt/logger.yue:15
end -- shunt/logger.yue:11
_module_0["log"] = log -- shunt/logger.yue:15
fatal = function(...) -- shunt/logger.yue:17
  local fragments -- shunt/logger.yue:18
  do -- shunt/logger.yue:18
    local _with_0 = { } -- shunt/logger.yue:18
    for i = 1, select('#', ...) do -- shunt/logger.yue:19
      _with_0[#_with_0 + 1] = tostring(select(i, ...)) -- shunt/logger.yue:20
    end -- shunt/logger.yue:20
    fragments = _with_0 -- shunt/logger.yue:18
  end -- shunt/logger.yue:18
  local msg = table.concat(fragments, ' ') -- shunt/logger.yue:21
  print(msg) -- shunt/logger.yue:22
  write_to_log(msg) -- shunt/logger.yue:23
  return os.exit(1) -- shunt/logger.yue:25
end -- shunt/logger.yue:17
_module_0["fatal"] = fatal -- shunt/logger.yue:25
test_mode = false -- shunt/logger.yue:27
activate_test_mode = function() -- shunt/logger.yue:28
  test_mode = true -- shunt/logger.yue:29
end -- shunt/logger.yue:28
_module_0["activate_test_mode"] = activate_test_mode -- shunt/logger.yue:29
trace = function(msg) -- shunt/logger.yue:31
  if test_mode then -- shunt/logger.yue:32
    print(msg) -- shunt/logger.yue:33
  end -- shunt/logger.yue:32
  return write_to_log(msg) -- shunt/logger.yue:34
end -- shunt/logger.yue:31
_module_0["trace"] = trace -- shunt/logger.yue:34
setup_done = false -- shunt/logger.yue:36
write_to_log = function(msg) -- shunt/logger.yue:37
  if not setup_done then -- shunt/logger.yue:38
    setup_done = true -- shunt/logger.yue:39
    setup_logs() -- shunt/logger.yue:40
  end -- shunt/logger.yue:38
  local timestamp = os.date('%Y-%m-%d@%H:%M:%S') -- shunt/logger.yue:42
  local to_write = "[" .. tostring(timestamp) .. "]: " .. tostring(msg) .. "\n" -- shunt/logger.yue:43
  do -- shunt/logger.yue:44
    local _with_0 = io.open(LOG_FILE, 'a') -- shunt/logger.yue:44
    if _with_0 ~= nil then -- shunt/logger.yue:44
      _with_0:write(to_write) -- shunt/logger.yue:45
      _with_0:close() -- shunt/logger.yue:46
    end -- shunt/logger.yue:44
  end -- shunt/logger.yue:44
  return -- shunt/logger.yue:47
end -- shunt/logger.yue:37
MAX_LOGS = 10 -- shunt/logger.yue:49
setup_logs = function() -- shunt/logger.yue:50
  fs.makeDir(LOG_DIR) -- shunt/logger.yue:51
  local existing_logs = fs.list(LOG_DIR) -- shunt/logger.yue:53
  table.sort(existing_logs, function(a, b) -- shunt/logger.yue:54
    return a > b -- shunt/logger.yue:54
  end) -- shunt/logger.yue:54
  for _index_0 = MAX_LOGS - 1, #existing_logs do -- shunt/logger.yue:55
    local log_to_delete = existing_logs[_index_0] -- shunt/logger.yue:55
    os.remove(tostring(LOG_DIR) .. "/" .. tostring(log_to_delete)) -- shunt/logger.yue:56
  end -- shunt/logger.yue:56
end -- shunt/logger.yue:50
return _module_0 -- shunt/logger.yue:56
end
package.preload['shunt.toml'] = function(...)
-- [yue]: shunt/toml.yue
local _module_0 = { } -- shunt/toml.yue:1
local decode, Decoder, Ast, Section, TableHeader, ArrayOfTablesHeader, Entry, Key, Value, T_KEY_LITERAL, T_BOOLEAN, T_NUMBER, T_STRING, T_BRACE_OPEN, T_BRACE_CLOSE, T_BRACKET_OPEN, T_BRACKET_CLOSE, T_EQUALS, T_COMMA, T_DOT, T_NEWLINE, T_EOF, Lexer -- shunt/toml.yue:1
local declare_type, F, Parser, Symbol -- shunt/toml.yue:0
do -- shunt/toml.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/toml.yue:0
  declare_type, F, Parser, Symbol = _obj_0.declare_type, _obj_0.F, _obj_0.Parser, _obj_0.Symbol -- shunt/toml.yue:0
end -- shunt/toml.yue:0
local spec = require('shunt.spec').spec -- shunt/toml.yue:0
decode = function(raw) -- shunt/toml.yue:6
  local parser = Decoder(Lexer(raw)) -- shunt/toml.yue:7
  local ast, err = parser:parse() -- shunt/toml.yue:8
  if (err ~= nil) then -- shunt/toml.yue:9
    return nil, err -- shunt/toml.yue:10
  end -- shunt/toml.yue:9
  return ast:construct_value(), nil -- shunt/toml.yue:11
end -- shunt/toml.yue:6
_module_0["decode"] = decode -- shunt/toml.yue:11
do -- shunt/toml.yue:18
  local _class_0 -- shunt/toml.yue:18
  local _parent_0 = Parser -- shunt/toml.yue:18
  local _base_0 = { -- shunt/toml.yue:18
    parse = function(self) -- shunt/toml.yue:21
      local ret, err -- shunt/toml.yue:22
xpcall(function() -- shunt/toml.yue:23
        ret = self:parse_file() -- shunt/toml.yue:24
        return self:expect(T_EOF) -- shunt/toml.yue:25
      end, function(err2) -- shunt/toml.yue:25
        err = err2 -- shunt/toml.yue:27
      end) -- shunt/toml.yue:27
      if (err ~= nil) then -- shunt/toml.yue:28
        return nil, err -- shunt/toml.yue:29
      end -- shunt/toml.yue:28
      return ret, nil -- shunt/toml.yue:30
    end, -- shunt/toml.yue:32
    parse_file = function(self) -- shunt/toml.yue:32
      self:ignore_any(T_NEWLINE) -- shunt/toml.yue:33
      if self.lexer:peek().type == T_EOF then -- shunt/toml.yue:34
        return Ast() -- shunt/toml.yue:35
      end -- shunt/toml.yue:34
      local root_section = nil -- shunt/toml.yue:37
      if self.lexer:peek().type ~= T_BRACKET_OPEN then -- shunt/toml.yue:38
        root_section = Section(nil, self:parse_section_body()) -- shunt/toml.yue:39
        self:ignore_any(T_NEWLINE) -- shunt/toml.yue:40
      end -- shunt/toml.yue:38
      local named_sections = nil -- shunt/toml.yue:42
      if self.lexer:peek().type ~= T_EOF then -- shunt/toml.yue:43
        named_sections = self:repeat_until((function() -- shunt/toml.yue:44
          local _base_1 = self -- shunt/toml.yue:44
          local _fn_0 = _base_1.parse_section -- shunt/toml.yue:44
          return _fn_0 and function(...) -- shunt/toml.yue:44
            return _fn_0(_base_1, ...) -- shunt/toml.yue:44
          end -- shunt/toml.yue:44
        end)(), T_EOF) -- shunt/toml.yue:44
      end -- shunt/toml.yue:43
      return Ast(root_section, named_sections) -- shunt/toml.yue:45
    end, -- shunt/toml.yue:47
    parse_section = function(self) -- shunt/toml.yue:47
      local header = self:parse_section_header() -- shunt/toml.yue:48
      self:expect(T_NEWLINE) -- shunt/toml.yue:50
      self:ignore_any(T_NEWLINE) -- shunt/toml.yue:51
      local body -- shunt/toml.yue:53
      do -- shunt/toml.yue:53
        local _exp_0 = self.lexer:peek().type -- shunt/toml.yue:53
        if T_BRACKET_OPEN == _exp_0 or T_EOF == _exp_0 then -- shunt/toml.yue:54
          body = nil -- shunt/toml.yue:55
        else -- shunt/toml.yue:57
          body = self:parse_section_body() -- shunt/toml.yue:57
        end -- shunt/toml.yue:57
      end -- shunt/toml.yue:57
      return Section(header, body) -- shunt/toml.yue:59
    end, -- shunt/toml.yue:61
    parse_section_header = function(self) -- shunt/toml.yue:61
      self:expect(T_BRACKET_OPEN) -- shunt/toml.yue:62
      local is_array_of_tables = self:maybe(T_BRACKET_OPEN) -- shunt/toml.yue:63
      local key = self:parse_key() -- shunt/toml.yue:65
      if is_array_of_tables then -- shunt/toml.yue:67
        self:expect(T_BRACKET_CLOSE) -- shunt/toml.yue:68
      end -- shunt/toml.yue:67
      self:expect(T_BRACKET_CLOSE) -- shunt/toml.yue:69
      if is_array_of_tables then -- shunt/toml.yue:71
        return ArrayOfTablesHeader(key) -- shunt/toml.yue:72
      else -- shunt/toml.yue:74
        return TableHeader(key) -- shunt/toml.yue:74
      end -- shunt/toml.yue:71
    end, -- shunt/toml.yue:76
    parse_section_body = function(self) -- shunt/toml.yue:76
      return self:parse_repeat_separated((function() -- shunt/toml.yue:77
        local _base_1 = self -- shunt/toml.yue:77
        local _fn_0 = _base_1.parse_entry -- shunt/toml.yue:77
        return _fn_0 and function(...) -- shunt/toml.yue:77
          return _fn_0(_base_1, ...) -- shunt/toml.yue:77
        end -- shunt/toml.yue:77
      end)(), T_NEWLINE, { -- shunt/toml.yue:78
        allow_repeated_separator = true, -- shunt/toml.yue:78
        separator_trails_before = { -- shunt/toml.yue:80
          T_BRACKET_OPEN, -- shunt/toml.yue:80
          T_EOF -- shunt/toml.yue:81
        } -- shunt/toml.yue:79
      }) -- shunt/toml.yue:81
    end, -- shunt/toml.yue:83
    parse_entry = function(self) -- shunt/toml.yue:83
      local key = self:parse_key() -- shunt/toml.yue:84
      self:expect(T_EQUALS) -- shunt/toml.yue:85
      local value = self:parse_value() -- shunt/toml.yue:86
      return Entry(key, value) -- shunt/toml.yue:87
    end, -- shunt/toml.yue:89
    parse_key = function(self) -- shunt/toml.yue:89
      return Key(self:parse_repeat_separated((function() -- shunt/toml.yue:90
        local _base_1 = self -- shunt/toml.yue:90
        local _fn_0 = _base_1.parse_key_part -- shunt/toml.yue:90
        return _fn_0 and function(...) -- shunt/toml.yue:90
          return _fn_0(_base_1, ...) -- shunt/toml.yue:90
        end -- shunt/toml.yue:90
      end)(), T_DOT)) -- shunt/toml.yue:90
    end, -- shunt/toml.yue:92
    parse_key_part = function(self) -- shunt/toml.yue:92
      return self:expect(T_KEY_LITERAL) -- shunt/toml.yue:93
    end, -- shunt/toml.yue:95
    parse_value = function(self) -- shunt/toml.yue:95
      return Value(self:select({ -- shunt/toml.yue:97
        { -- shunt/toml.yue:97
          token = T_BOOLEAN -- shunt/toml.yue:97
        }, -- shunt/toml.yue:97
        { -- shunt/toml.yue:98
          token = T_STRING -- shunt/toml.yue:98
        }, -- shunt/toml.yue:98
        { -- shunt/toml.yue:99
          token = T_NUMBER -- shunt/toml.yue:99
        } -- shunt/toml.yue:99
      })) -- shunt/toml.yue:99
    end -- shunt/toml.yue:18
  } -- shunt/toml.yue:18
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/toml.yue:99
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/toml.yue:18
      _base_0[_key_0] = _val_0 -- shunt/toml.yue:18
    end -- shunt/toml.yue:18
  end -- shunt/toml.yue:99
  if _base_0.__index == nil then -- shunt/toml.yue:18
    _base_0.__index = _base_0 -- shunt/toml.yue:18
  end -- shunt/toml.yue:99
  setmetatable(_base_0, _parent_0.__base) -- shunt/toml.yue:18
  _class_0 = setmetatable({ -- shunt/toml.yue:18
    __init = function(self, lexer) -- shunt/toml.yue:19
      self.lexer = lexer -- shunt/toml.yue:19
    end, -- shunt/toml.yue:18
    __base = _base_0, -- shunt/toml.yue:18
    __name = "Decoder", -- shunt/toml.yue:18
    __parent = _parent_0 -- shunt/toml.yue:18
  }, { -- shunt/toml.yue:18
    __index = function(cls, name) -- shunt/toml.yue:18
      local val = rawget(_base_0, name) -- shunt/toml.yue:18
      if val == nil then -- shunt/toml.yue:18
        local parent = rawget(cls, "__parent") -- shunt/toml.yue:18
        if parent then -- shunt/toml.yue:18
          return parent[name] -- shunt/toml.yue:18
        end -- shunt/toml.yue:18
      else -- shunt/toml.yue:18
        return val -- shunt/toml.yue:18
      end -- shunt/toml.yue:18
    end, -- shunt/toml.yue:18
    __call = function(cls, ...) -- shunt/toml.yue:18
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:18
      cls.__init(_self_0, ...) -- shunt/toml.yue:18
      return _self_0 -- shunt/toml.yue:18
    end -- shunt/toml.yue:18
  }) -- shunt/toml.yue:18
  _base_0.__class = _class_0 -- shunt/toml.yue:18
  if _parent_0.__inherited then -- shunt/toml.yue:18
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/toml.yue:18
  end -- shunt/toml.yue:18
  Decoder = _class_0 -- shunt/toml.yue:18
end -- shunt/toml.yue:99
do -- shunt/toml.yue:101
  local _class_0 -- shunt/toml.yue:101
  local _base_0 = { -- shunt/toml.yue:101
    construct_value = function(self) -- shunt/toml.yue:109
      local tab = { } -- shunt/toml.yue:110
      if (self.root_section ~= nil) then -- shunt/toml.yue:111
        local _list_0 = self.root_section.entries -- shunt/toml.yue:112
        for _index_0 = 1, #_list_0 do -- shunt/toml.yue:112
          local entry = _list_0[_index_0] -- shunt/toml.yue:112
          entry:construct_value_in(tab) -- shunt/toml.yue:113
        end -- shunt/toml.yue:113
      end -- shunt/toml.yue:111
      local _list_0 = self.named_sections -- shunt/toml.yue:114
      for _index_0 = 1, #_list_0 do -- shunt/toml.yue:114
        local named_section = _list_0[_index_0] -- shunt/toml.yue:114
        named_section:construct_value_in(tab) -- shunt/toml.yue:115
      end -- shunt/toml.yue:115
      return tab -- shunt/toml.yue:116
    end -- shunt/toml.yue:101
  } -- shunt/toml.yue:101
  if _base_0.__index == nil then -- shunt/toml.yue:101
    _base_0.__index = _base_0 -- shunt/toml.yue:101
  end -- shunt/toml.yue:116
  _class_0 = setmetatable({ -- shunt/toml.yue:101
    __init = function(self, root_section, named_sections) -- shunt/toml.yue:102
      if root_section == nil then -- shunt/toml.yue:102
        root_section = nil -- shunt/toml.yue:102
      end -- shunt/toml.yue:102
      if named_sections == nil then -- shunt/toml.yue:102
        named_sections = { } -- shunt/toml.yue:102
      end -- shunt/toml.yue:102
      self.root_section = root_section -- shunt/toml.yue:102
      self.named_sections = named_sections -- shunt/toml.yue:102
      if (self.root_section ~= nil) and (self.root_section.header ~= nil) then -- shunt/toml.yue:103
        error("internal error: root section has header") -- shunt/toml.yue:104
      end -- shunt/toml.yue:103
      local _list_0 = self.named_sections -- shunt/toml.yue:105
      for _index_0 = 1, #_list_0 do -- shunt/toml.yue:105
        local named_section = _list_0[_index_0] -- shunt/toml.yue:105
        if not (named_section.header ~= nil) then -- shunt/toml.yue:106
          error("internal error: non-root section has no header") -- shunt/toml.yue:107
        end -- shunt/toml.yue:106
      end -- shunt/toml.yue:107
    end, -- shunt/toml.yue:101
    __base = _base_0, -- shunt/toml.yue:101
    __name = "Ast" -- shunt/toml.yue:101
  }, { -- shunt/toml.yue:101
    __index = _base_0, -- shunt/toml.yue:101
    __call = function(cls, ...) -- shunt/toml.yue:101
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:101
      cls.__init(_self_0, ...) -- shunt/toml.yue:101
      return _self_0 -- shunt/toml.yue:101
    end -- shunt/toml.yue:101
  }) -- shunt/toml.yue:101
  _base_0.__class = _class_0 -- shunt/toml.yue:101
  Ast = _class_0 -- shunt/toml.yue:101
end -- shunt/toml.yue:116
do -- shunt/toml.yue:118
  local _class_0 -- shunt/toml.yue:118
  local _base_0 = { -- shunt/toml.yue:118
    construct_value_in = function(self, tab) -- shunt/toml.yue:121
      if (self.header ~= nil) then -- shunt/toml.yue:122
        tab = self.header:acquire_target(tab) -- shunt/toml.yue:123
      end -- shunt/toml.yue:122
      local _list_0 = self.entries -- shunt/toml.yue:124
      for _index_0 = 1, #_list_0 do -- shunt/toml.yue:124
        local entry = _list_0[_index_0] -- shunt/toml.yue:124
        entry:construct_value_in(tab) -- shunt/toml.yue:125
      end -- shunt/toml.yue:125
    end -- shunt/toml.yue:118
  } -- shunt/toml.yue:118
  if _base_0.__index == nil then -- shunt/toml.yue:118
    _base_0.__index = _base_0 -- shunt/toml.yue:118
  end -- shunt/toml.yue:125
  _class_0 = setmetatable({ -- shunt/toml.yue:118
    __init = function(self, header, entries) -- shunt/toml.yue:119
      if entries == nil then -- shunt/toml.yue:119
        entries = { } -- shunt/toml.yue:119
      end -- shunt/toml.yue:119
      self.header = header -- shunt/toml.yue:119
      self.entries = entries -- shunt/toml.yue:119
    end, -- shunt/toml.yue:118
    __base = _base_0, -- shunt/toml.yue:118
    __name = "Section" -- shunt/toml.yue:118
  }, { -- shunt/toml.yue:118
    __index = _base_0, -- shunt/toml.yue:118
    __call = function(cls, ...) -- shunt/toml.yue:118
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:118
      cls.__init(_self_0, ...) -- shunt/toml.yue:118
      return _self_0 -- shunt/toml.yue:118
    end -- shunt/toml.yue:118
  }) -- shunt/toml.yue:118
  _base_0.__class = _class_0 -- shunt/toml.yue:118
  Section = _class_0 -- shunt/toml.yue:118
end -- shunt/toml.yue:125
do -- shunt/toml.yue:127
  local _class_0 -- shunt/toml.yue:127
  local _base_0 = { -- shunt/toml.yue:127
    acquire_target = function(self, tab) -- shunt/toml.yue:130
      local key -- shunt/toml.yue:131
      tab, key = self.key:acquire_target(tab) -- shunt/toml.yue:131
      if not (tab[key] ~= nil) then -- shunt/toml.yue:132
        tab[key] = { } -- shunt/toml.yue:133
      end -- shunt/toml.yue:132
      return tab[key] -- shunt/toml.yue:134
    end -- shunt/toml.yue:127
  } -- shunt/toml.yue:127
  if _base_0.__index == nil then -- shunt/toml.yue:127
    _base_0.__index = _base_0 -- shunt/toml.yue:127
  end -- shunt/toml.yue:134
  _class_0 = setmetatable({ -- shunt/toml.yue:127
    __init = function(self, key) -- shunt/toml.yue:128
      self.key = key -- shunt/toml.yue:128
    end, -- shunt/toml.yue:127
    __base = _base_0, -- shunt/toml.yue:127
    __name = "TableHeader" -- shunt/toml.yue:127
  }, { -- shunt/toml.yue:127
    __index = _base_0, -- shunt/toml.yue:127
    __call = function(cls, ...) -- shunt/toml.yue:127
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:127
      cls.__init(_self_0, ...) -- shunt/toml.yue:127
      return _self_0 -- shunt/toml.yue:127
    end -- shunt/toml.yue:127
  }) -- shunt/toml.yue:127
  _base_0.__class = _class_0 -- shunt/toml.yue:127
  TableHeader = _class_0 -- shunt/toml.yue:127
end -- shunt/toml.yue:134
do -- shunt/toml.yue:136
  local _class_0 -- shunt/toml.yue:136
  local _base_0 = { -- shunt/toml.yue:136
    acquire_target = function(self, tab) -- shunt/toml.yue:139
      local key -- shunt/toml.yue:140
      tab, key = self.key:acquire_target(tab) -- shunt/toml.yue:140
      if not (tab[key] ~= nil) then -- shunt/toml.yue:141
        tab[key] = { } -- shunt/toml.yue:142
      end -- shunt/toml.yue:141
      tab = tab[key] -- shunt/toml.yue:143
      local target = { } -- shunt/toml.yue:145
      tab[#tab + 1] = target -- shunt/toml.yue:146
      return target -- shunt/toml.yue:147
    end -- shunt/toml.yue:136
  } -- shunt/toml.yue:136
  if _base_0.__index == nil then -- shunt/toml.yue:136
    _base_0.__index = _base_0 -- shunt/toml.yue:136
  end -- shunt/toml.yue:147
  _class_0 = setmetatable({ -- shunt/toml.yue:136
    __init = function(self, key) -- shunt/toml.yue:137
      self.key = key -- shunt/toml.yue:137
    end, -- shunt/toml.yue:136
    __base = _base_0, -- shunt/toml.yue:136
    __name = "ArrayOfTablesHeader" -- shunt/toml.yue:136
  }, { -- shunt/toml.yue:136
    __index = _base_0, -- shunt/toml.yue:136
    __call = function(cls, ...) -- shunt/toml.yue:136
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:136
      cls.__init(_self_0, ...) -- shunt/toml.yue:136
      return _self_0 -- shunt/toml.yue:136
    end -- shunt/toml.yue:136
  }) -- shunt/toml.yue:136
  _base_0.__class = _class_0 -- shunt/toml.yue:136
  ArrayOfTablesHeader = _class_0 -- shunt/toml.yue:136
end -- shunt/toml.yue:147
do -- shunt/toml.yue:149
  local _class_0 -- shunt/toml.yue:149
  local _base_0 = { -- shunt/toml.yue:149
    construct_value_in = function(self, tab) -- shunt/toml.yue:152
      local key -- shunt/toml.yue:153
      tab, key = self.key:acquire_target(tab) -- shunt/toml.yue:153
      tab[key] = self.value:construct_value() -- shunt/toml.yue:154
    end -- shunt/toml.yue:149
  } -- shunt/toml.yue:149
  if _base_0.__index == nil then -- shunt/toml.yue:149
    _base_0.__index = _base_0 -- shunt/toml.yue:149
  end -- shunt/toml.yue:154
  _class_0 = setmetatable({ -- shunt/toml.yue:149
    __init = function(self, key, value) -- shunt/toml.yue:150
      self.key = key -- shunt/toml.yue:150
      self.value = value -- shunt/toml.yue:150
    end, -- shunt/toml.yue:149
    __base = _base_0, -- shunt/toml.yue:149
    __name = "Entry" -- shunt/toml.yue:149
  }, { -- shunt/toml.yue:149
    __index = _base_0, -- shunt/toml.yue:149
    __call = function(cls, ...) -- shunt/toml.yue:149
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:149
      cls.__init(_self_0, ...) -- shunt/toml.yue:149
      return _self_0 -- shunt/toml.yue:149
    end -- shunt/toml.yue:149
  }) -- shunt/toml.yue:149
  _base_0.__class = _class_0 -- shunt/toml.yue:149
  Entry = _class_0 -- shunt/toml.yue:149
end -- shunt/toml.yue:154
do -- shunt/toml.yue:156
  local _class_0 -- shunt/toml.yue:156
  local _base_0 = { -- shunt/toml.yue:156
    acquire_target = function(self, tab) -- shunt/toml.yue:159
      do -- shunt/toml.yue:160
        local _list_0 = self.parts -- shunt/toml.yue:160
        local _max_0 = -1 -- shunt/toml.yue:160
        for _index_0 = 1, _max_0 < 0 and #_list_0 + _max_0 or _max_0 do -- shunt/toml.yue:160
          local part = _list_0[_index_0] -- shunt/toml.yue:160
          if not (tab[part] ~= nil) then -- shunt/toml.yue:161
            tab[part] = { } -- shunt/toml.yue:162
          end -- shunt/toml.yue:161
          tab = tab[part] -- shunt/toml.yue:163
        end -- shunt/toml.yue:163
      end -- shunt/toml.yue:163
      return tab, self.parts[#self.parts] -- shunt/toml.yue:164
    end -- shunt/toml.yue:156
  } -- shunt/toml.yue:156
  if _base_0.__index == nil then -- shunt/toml.yue:156
    _base_0.__index = _base_0 -- shunt/toml.yue:156
  end -- shunt/toml.yue:164
  _class_0 = setmetatable({ -- shunt/toml.yue:156
    __init = function(self, parts) -- shunt/toml.yue:157
      self.parts = parts -- shunt/toml.yue:157
    end, -- shunt/toml.yue:156
    __base = _base_0, -- shunt/toml.yue:156
    __name = "Key" -- shunt/toml.yue:156
  }, { -- shunt/toml.yue:156
    __index = _base_0, -- shunt/toml.yue:156
    __call = function(cls, ...) -- shunt/toml.yue:156
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:156
      cls.__init(_self_0, ...) -- shunt/toml.yue:156
      return _self_0 -- shunt/toml.yue:156
    end -- shunt/toml.yue:156
  }) -- shunt/toml.yue:156
  _base_0.__class = _class_0 -- shunt/toml.yue:156
  Key = _class_0 -- shunt/toml.yue:156
end -- shunt/toml.yue:164
do -- shunt/toml.yue:166
  local _class_0 -- shunt/toml.yue:166
  local _base_0 = { -- shunt/toml.yue:166
    construct_value = function(self) -- shunt/toml.yue:169
      return self.value -- shunt/toml.yue:170
    end -- shunt/toml.yue:166
  } -- shunt/toml.yue:166
  if _base_0.__index == nil then -- shunt/toml.yue:166
    _base_0.__index = _base_0 -- shunt/toml.yue:166
  end -- shunt/toml.yue:170
  _class_0 = setmetatable({ -- shunt/toml.yue:166
    __init = function(self, value) -- shunt/toml.yue:167
      self.value = value -- shunt/toml.yue:167
    end, -- shunt/toml.yue:166
    __base = _base_0, -- shunt/toml.yue:166
    __name = "Value" -- shunt/toml.yue:166
  }, { -- shunt/toml.yue:166
    __index = _base_0, -- shunt/toml.yue:166
    __call = function(cls, ...) -- shunt/toml.yue:166
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:166
      cls.__init(_self_0, ...) -- shunt/toml.yue:166
      return _self_0 -- shunt/toml.yue:166
    end -- shunt/toml.yue:166
  }) -- shunt/toml.yue:166
  _base_0.__class = _class_0 -- shunt/toml.yue:166
  Value = _class_0 -- shunt/toml.yue:166
end -- shunt/toml.yue:170
T_KEY_LITERAL = setmetatable({ }, { -- shunt/toml.yue:173
  __tostring = function(self) -- shunt/toml.yue:173
    return '<key-literal>' -- shunt/toml.yue:173
  end -- shunt/toml.yue:173
}) -- shunt/toml.yue:173
T_BOOLEAN = setmetatable({ }, { -- shunt/toml.yue:174
  __tostring = function(self) -- shunt/toml.yue:174
    return '<boolean>' -- shunt/toml.yue:174
  end -- shunt/toml.yue:174
}) -- shunt/toml.yue:174
T_NUMBER = setmetatable({ }, { -- shunt/toml.yue:175
  __tostring = function(self) -- shunt/toml.yue:175
    return '<number>' -- shunt/toml.yue:175
  end -- shunt/toml.yue:175
}) -- shunt/toml.yue:175
T_STRING = setmetatable({ }, { -- shunt/toml.yue:176
  __tostring = function(self) -- shunt/toml.yue:176
    return '<string>' -- shunt/toml.yue:176
  end -- shunt/toml.yue:176
}) -- shunt/toml.yue:176
T_BRACE_OPEN = setmetatable({ }, { -- shunt/toml.yue:177
  __tostring = function(self) -- shunt/toml.yue:177
    return "'{'" -- shunt/toml.yue:177
  end -- shunt/toml.yue:177
}) -- shunt/toml.yue:177
T_BRACE_CLOSE = setmetatable({ }, { -- shunt/toml.yue:178
  __tostring = function(self) -- shunt/toml.yue:178
    return "'}'" -- shunt/toml.yue:178
  end -- shunt/toml.yue:178
}) -- shunt/toml.yue:178
T_BRACKET_OPEN = setmetatable({ }, { -- shunt/toml.yue:179
  __tostring = function(self) -- shunt/toml.yue:179
    return "'['" -- shunt/toml.yue:179
  end -- shunt/toml.yue:179
}) -- shunt/toml.yue:179
T_BRACKET_CLOSE = setmetatable({ }, { -- shunt/toml.yue:180
  __tostring = function(self) -- shunt/toml.yue:180
    return "']'" -- shunt/toml.yue:180
  end -- shunt/toml.yue:180
}) -- shunt/toml.yue:180
T_EQUALS = setmetatable({ }, { -- shunt/toml.yue:181
  __tostring = function(self) -- shunt/toml.yue:181
    return "'='" -- shunt/toml.yue:181
  end -- shunt/toml.yue:181
}) -- shunt/toml.yue:181
T_COMMA = setmetatable({ }, { -- shunt/toml.yue:182
  __tostring = function(self) -- shunt/toml.yue:182
    return "','" -- shunt/toml.yue:182
  end -- shunt/toml.yue:182
}) -- shunt/toml.yue:182
T_DOT = setmetatable({ }, { -- shunt/toml.yue:183
  __tostring = function(self) -- shunt/toml.yue:183
    return "'.'" -- shunt/toml.yue:183
  end -- shunt/toml.yue:183
}) -- shunt/toml.yue:183
T_NEWLINE = setmetatable({ }, { -- shunt/toml.yue:184
  __tostring = function(self) -- shunt/toml.yue:184
    return "'\\n'" -- shunt/toml.yue:184
  end -- shunt/toml.yue:184
}) -- shunt/toml.yue:184
T_EOF = setmetatable({ }, { -- shunt/toml.yue:185
  __tostring = function(self) -- shunt/toml.yue:185
    return '<eof>' -- shunt/toml.yue:185
  end -- shunt/toml.yue:185
}) -- shunt/toml.yue:185
do -- shunt/toml.yue:187
  local _class_0 -- shunt/toml.yue:187
  local _base_0 = { -- shunt/toml.yue:187
    peek = function(self) -- shunt/toml.yue:237
      if self.done then -- shunt/toml.yue:238
        return nil -- shunt/toml.yue:239
      end -- shunt/toml.yue:238
      if (self.peeked ~= nil) then -- shunt/toml.yue:241
        return self.peeked -- shunt/toml.yue:242
      end -- shunt/toml.yue:241
      self.peeked = self:tokens() -- shunt/toml.yue:244
      if not self.peeked then -- shunt/toml.yue:245
        self.done = true -- shunt/toml.yue:246
      end -- shunt/toml.yue:245
      return self.peeked -- shunt/toml.yue:247
    end, -- shunt/toml.yue:249
    next = function(self) -- shunt/toml.yue:249
      if self.done then -- shunt/toml.yue:250
        return nil -- shunt/toml.yue:251
      end -- shunt/toml.yue:250
      if (self.peeked ~= nil) then -- shunt/toml.yue:253
        local peeked = self.peeked -- shunt/toml.yue:254
        self.peeked = nil -- shunt/toml.yue:255
        return peeked -- shunt/toml.yue:256
      else -- shunt/toml.yue:258
        local ret = self:tokens() -- shunt/toml.yue:258
        if not (ret ~= nil) then -- shunt/toml.yue:259
          self.done = true -- shunt/toml.yue:260
        end -- shunt/toml.yue:259
        return ret -- shunt/toml.yue:261
      end -- shunt/toml.yue:253
    end -- shunt/toml.yue:187
  } -- shunt/toml.yue:187
  if _base_0.__index == nil then -- shunt/toml.yue:187
    _base_0.__index = _base_0 -- shunt/toml.yue:187
  end -- shunt/toml.yue:261
  _class_0 = setmetatable({ -- shunt/toml.yue:187
    __init = function(self, input) -- shunt/toml.yue:188
      self.index = 1 -- shunt/toml.yue:189
      self.done = false -- shunt/toml.yue:190
      self.peeked = nil -- shunt/toml.yue:191
      self.tokens = coroutine.wrap(function() -- shunt/toml.yue:192
        while self.index <= #input do -- shunt/toml.yue:193
          local _continue_0 = false -- shunt/toml.yue:194
          repeat -- shunt/toml.yue:194
            local ty, value, bytes_consumed -- shunt/toml.yue:194
            do -- shunt/toml.yue:194
              local comment = input:match('^#[^\r\n]*', self.index) -- shunt/toml.yue:194
              if comment then -- shunt/toml.yue:194
                ty, value, bytes_consumed = nil, nil, #comment -- shunt/toml.yue:195
              else -- shunt/toml.yue:196
                do -- shunt/toml.yue:196
                  local whitespace = input:match('^[ \t]+', self.index) -- shunt/toml.yue:196
                  if whitespace then -- shunt/toml.yue:196
                    ty, value, bytes_consumed = nil, nil, #whitespace -- shunt/toml.yue:197
                  else -- shunt/toml.yue:198
                    do -- shunt/toml.yue:198
                      local string = input:match("^'''([^']*)'''", self.index) -- shunt/toml.yue:198
                      if string then -- shunt/toml.yue:198
                        ty, value, bytes_consumed = T_STRING, string, #string + 6 -- shunt/toml.yue:199
                      else -- shunt/toml.yue:200
                        string = input:match("^'([^'\r\n]*)'", self.index) -- shunt/toml.yue:200
                        if string then -- shunt/toml.yue:200
                          ty, value, bytes_consumed = T_STRING, string, #string + 2 -- shunt/toml.yue:201
                        else -- shunt/toml.yue:202
                          do -- shunt/toml.yue:202
                            local number = input:match('^%-?[0-9]*%.[0-9]+', self.index) -- shunt/toml.yue:202
                            if number then -- shunt/toml.yue:202
                              ty, value, bytes_consumed = T_NUMBER, (assert(tonumber(number))), #number -- shunt/toml.yue:203
                            else -- shunt/toml.yue:204
                              number = input:match('^%-?[0-9]+', self.index) -- shunt/toml.yue:204
                              if number then -- shunt/toml.yue:204
                                ty, value, bytes_consumed = T_NUMBER, (assert(tonumber(number))), #number -- shunt/toml.yue:205
                              else -- shunt/toml.yue:206
                                do -- shunt/toml.yue:206
                                  local boolean_true = input:match('^true', self.index) -- shunt/toml.yue:206
                                  if boolean_true then -- shunt/toml.yue:206
                                    ty, value, bytes_consumed = T_BOOLEAN, true, #boolean_true -- shunt/toml.yue:207
                                  else -- shunt/toml.yue:208
                                    do -- shunt/toml.yue:208
                                      local boolean_false = input:match('^false', self.index) -- shunt/toml.yue:208
                                      if boolean_false then -- shunt/toml.yue:208
                                        ty, value, bytes_consumed = T_BOOLEAN, false, #boolean_false -- shunt/toml.yue:209
                                      else -- shunt/toml.yue:210
                                        do -- shunt/toml.yue:210
                                          local key = input:match('^[a-zA-Z0-9_-]+', self.index) -- shunt/toml.yue:210
                                          if key then -- shunt/toml.yue:210
                                            ty, value, bytes_consumed = T_KEY_LITERAL, key, #key -- shunt/toml.yue:211
                                          else -- shunt/toml.yue:212
                                            do -- shunt/toml.yue:212
                                              local match = input:match('^=', self.index) -- shunt/toml.yue:212
                                              if match then -- shunt/toml.yue:212
                                                ty, value, bytes_consumed = T_EQUALS, nil, #match -- shunt/toml.yue:213
                                              else -- shunt/toml.yue:214
                                                match = input:match('^{', self.index) -- shunt/toml.yue:214
                                                if match then -- shunt/toml.yue:214
                                                  ty, value, bytes_consumed = T_BRACE_OPEN, nil, #match -- shunt/toml.yue:215
                                                else -- shunt/toml.yue:216
                                                  match = input:match('^}', self.index) -- shunt/toml.yue:216
                                                  if match then -- shunt/toml.yue:216
                                                    ty, value, bytes_consumed = T_BRACE_CLOSE, nil, #match -- shunt/toml.yue:217
                                                  else -- shunt/toml.yue:218
                                                    match = input:match('^%[', self.index) -- shunt/toml.yue:218
                                                    if match then -- shunt/toml.yue:218
                                                      ty, value, bytes_consumed = T_BRACKET_OPEN, nil, #match -- shunt/toml.yue:219
                                                    else -- shunt/toml.yue:220
                                                      match = input:match('^]', self.index) -- shunt/toml.yue:220
                                                      if match then -- shunt/toml.yue:220
                                                        ty, value, bytes_consumed = T_BRACKET_CLOSE, nil, #match -- shunt/toml.yue:221
                                                      else -- shunt/toml.yue:222
                                                        match = input:match('^,', self.index) -- shunt/toml.yue:222
                                                        if match then -- shunt/toml.yue:222
                                                          ty, value, bytes_consumed = T_COMMA, nil, #match -- shunt/toml.yue:223
                                                        else -- shunt/toml.yue:224
                                                          match = input:match('^%.', self.index) -- shunt/toml.yue:224
                                                          if match then -- shunt/toml.yue:224
                                                            ty, value, bytes_consumed = T_DOT, nil, #match -- shunt/toml.yue:225
                                                          else -- shunt/toml.yue:226
                                                            match = input:match('^[\r\n]', self.index) -- shunt/toml.yue:226
                                                            if match then -- shunt/toml.yue:226
                                                              ty, value, bytes_consumed = T_NEWLINE, nil, #match -- shunt/toml.yue:227
                                                            else -- shunt/toml.yue:229
                                                              ty, value, bytes_consumed = error("unexpected character '" .. tostring(input:sub(self.index, self.index)) .. "' in toml '" .. tostring(input) .. "'") -- shunt/toml.yue:229
                                                            end -- shunt/toml.yue:226
                                                          end -- shunt/toml.yue:224
                                                        end -- shunt/toml.yue:222
                                                      end -- shunt/toml.yue:220
                                                    end -- shunt/toml.yue:218
                                                  end -- shunt/toml.yue:216
                                                end -- shunt/toml.yue:214
                                              end -- shunt/toml.yue:212
                                            end -- shunt/toml.yue:212
                                          end -- shunt/toml.yue:210
                                        end -- shunt/toml.yue:210
                                      end -- shunt/toml.yue:208
                                    end -- shunt/toml.yue:208
                                  end -- shunt/toml.yue:206
                                end -- shunt/toml.yue:206
                              end -- shunt/toml.yue:204
                            end -- shunt/toml.yue:202
                          end -- shunt/toml.yue:202
                        end -- shunt/toml.yue:200
                      end -- shunt/toml.yue:198
                    end -- shunt/toml.yue:198
                  end -- shunt/toml.yue:196
                end -- shunt/toml.yue:196
              end -- shunt/toml.yue:194
            end -- shunt/toml.yue:194
            self.index = self.index + bytes_consumed -- shunt/toml.yue:231
            if not (ty ~= nil) then -- shunt/toml.yue:232
              _continue_0 = true -- shunt/toml.yue:233
              break -- shunt/toml.yue:233
            end -- shunt/toml.yue:232
            coroutine.yield(Symbol(ty, value)) -- shunt/toml.yue:234
            _continue_0 = true -- shunt/toml.yue:194
          until true -- shunt/toml.yue:234
          if not _continue_0 then -- shunt/toml.yue:234
            break -- shunt/toml.yue:234
          end -- shunt/toml.yue:234
        end -- shunt/toml.yue:234
        return coroutine.yield(Symbol(T_EOF)) -- shunt/toml.yue:235
      end) -- shunt/toml.yue:192
    end, -- shunt/toml.yue:187
    __base = _base_0, -- shunt/toml.yue:187
    __name = "Lexer" -- shunt/toml.yue:187
  }, { -- shunt/toml.yue:187
    __index = _base_0, -- shunt/toml.yue:187
    __call = function(cls, ...) -- shunt/toml.yue:187
      local _self_0 = setmetatable({ }, _base_0) -- shunt/toml.yue:187
      cls.__init(_self_0, ...) -- shunt/toml.yue:187
      return _self_0 -- shunt/toml.yue:187
    end -- shunt/toml.yue:187
  }) -- shunt/toml.yue:187
  _base_0.__class = _class_0 -- shunt/toml.yue:187
  Lexer = _class_0 -- shunt/toml.yue:187
end -- shunt/toml.yue:261
spec(function() -- shunt/toml.yue:263
  local describe, it, matchers -- shunt/toml.yue:0
  do -- shunt/toml.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/toml.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/toml.yue:0
  end -- shunt/toml.yue:0
  local deep_eq, eq, errors, matches = matchers.deep_eq, matchers.eq, matchers.errors, matchers.matches -- shunt/toml.yue:268
  describe('Lexer', function() -- shunt/toml.yue:270
    local tokens -- shunt/toml.yue:271
    tokens = function(raw) -- shunt/toml.yue:271
      assert(raw) -- shunt/toml.yue:272
      local _with_0 = { } -- shunt/toml.yue:273
      for token in (Lexer(raw)).tokens do -- shunt/toml.yue:274
        _with_0[#_with_0 + 1] = token -- shunt/toml.yue:275
      end -- shunt/toml.yue:275
      return _with_0 -- shunt/toml.yue:273
    end -- shunt/toml.yue:271
    it('emits structural tokens', function() -- shunt/toml.yue:277
      return require('shunt.spec')._expect_that([==[(tokens '{}[],=.\r\n')]==], (tokens('{}[],=.\r\n')), (deep_eq({ -- shunt/toml.yue:278
        Symbol(T_BRACE_OPEN), -- shunt/toml.yue:278
        Symbol(T_BRACE_CLOSE), -- shunt/toml.yue:278
        Symbol(T_BRACKET_OPEN), -- shunt/toml.yue:278
        Symbol(T_BRACKET_CLOSE), -- shunt/toml.yue:278
        Symbol(T_COMMA), -- shunt/toml.yue:278
        Symbol(T_EQUALS), -- shunt/toml.yue:278
        Symbol(T_DOT), -- shunt/toml.yue:278
        Symbol(T_NEWLINE), -- shunt/toml.yue:278
        Symbol(T_NEWLINE), -- shunt/toml.yue:278
        Symbol(T_EOF) -- shunt/toml.yue:278
      })), tostring("shunt/toml.yue") .. ":" .. tostring(278)) -- shunt/toml.yue:288
    end) -- shunt/toml.yue:277
    it('emits values', function() -- shunt/toml.yue:290
      return require('shunt.spec')._expect_that([=[(tokens [['hello' '''he\nllo''' 123 -1234.5 true false]])]=], (tokens([['hello' '''he\nllo''' 123 -1234.5 true false]])), (deep_eq({ -- shunt/toml.yue:291
        Symbol(T_STRING, 'hello'), -- shunt/toml.yue:291
        Symbol(T_STRING, 'he\\nllo'), -- shunt/toml.yue:291
        Symbol(T_NUMBER, 123), -- shunt/toml.yue:291
        Symbol(T_NUMBER, -1234.5), -- shunt/toml.yue:291
        Symbol(T_BOOLEAN, true), -- shunt/toml.yue:291
        Symbol(T_BOOLEAN, false), -- shunt/toml.yue:291
        Symbol(T_EOF) -- shunt/toml.yue:291
      })), tostring("shunt/toml.yue") .. ":" .. tostring(291)) -- shunt/toml.yue:298
    end) -- shunt/toml.yue:290
    it('ignores comments', function() -- shunt/toml.yue:300
      return require('shunt.spec')._expect_that([=[(tokens '#hello\n#world')]=], (tokens('#hello\n#world')), (deep_eq({ -- shunt/toml.yue:301
        Symbol(T_NEWLINE), -- shunt/toml.yue:301
        Symbol(T_EOF) -- shunt/toml.yue:301
      })), tostring("shunt/toml.yue") .. ":" .. tostring(301)) -- shunt/toml.yue:303
    end) -- shunt/toml.yue:300
    it('rejects unexpectec characters', function() -- shunt/toml.yue:305
      return require('shunt.spec')._expect_that([=[(-> tokens '~')]=], (function() -- shunt/toml.yue:306
        return tokens('~') -- shunt/toml.yue:306
      end), (errors(matches([[unexpected character '~']]))), tostring("shunt/toml.yue") .. ":" .. tostring(306)) -- shunt/toml.yue:306
    end) -- shunt/toml.yue:305
    return describe('\\peek', function() -- shunt/toml.yue:308
      it('matches \\next', function() -- shunt/toml.yue:309
        local lexer = Lexer('{}'); -- shunt/toml.yue:310
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_BRACE_OPEN))), tostring("shunt/toml.yue") .. ":" .. tostring(311)); -- shunt/toml.yue:311
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_BRACE_OPEN))), tostring("shunt/toml.yue") .. ":" .. tostring(312)); -- shunt/toml.yue:312
        require('shunt.spec')._assert_that([=[lexer\next!]=], lexer:next(), (deep_eq(Symbol(T_BRACE_OPEN))), tostring("shunt/toml.yue") .. ":" .. tostring(313)); -- shunt/toml.yue:313
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_BRACE_CLOSE))), tostring("shunt/toml.yue") .. ":" .. tostring(314)); -- shunt/toml.yue:314
        require('shunt.spec')._assert_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_BRACE_CLOSE))), tostring("shunt/toml.yue") .. ":" .. tostring(315)); -- shunt/toml.yue:315
        return require('shunt.spec')._assert_that([=[lexer\next!]=], lexer:next(), (deep_eq(Symbol(T_BRACE_CLOSE))), tostring("shunt/toml.yue") .. ":" .. tostring(316)) -- shunt/toml.yue:316
      end) -- shunt/toml.yue:309
      return it('returns EOF at EOF', function() -- shunt/toml.yue:318
        local lexer = Lexer(''); -- shunt/toml.yue:319
        require('shunt.spec')._expect_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_EOF))), tostring("shunt/toml.yue") .. ":" .. tostring(320)); -- shunt/toml.yue:320
        return require('shunt.spec')._expect_that([=[lexer\peek!]=], lexer:peek(), (deep_eq(Symbol(T_EOF))), tostring("shunt/toml.yue") .. ":" .. tostring(321)) -- shunt/toml.yue:321
      end) -- shunt/toml.yue:321
    end) -- shunt/toml.yue:321
  end) -- shunt/toml.yue:270
  describe('Decoder', function() -- shunt/toml.yue:323
    local parse_ast -- shunt/toml.yue:324
    parse_ast = function(input) -- shunt/toml.yue:324
      local tokens -- shunt/toml.yue:325
      tokens = function(raw) -- shunt/toml.yue:325
        assert(raw) -- shunt/toml.yue:326
        local _with_0 = { } -- shunt/toml.yue:327
        for token in (Lexer(raw)).tokens do -- shunt/toml.yue:328
          _with_0[#_with_0 + 1] = token -- shunt/toml.yue:329
        end -- shunt/toml.yue:329
        return _with_0 -- shunt/toml.yue:327
      end -- shunt/toml.yue:325
      return (Decoder(Lexer(input))):parse() -- shunt/toml.yue:330
    end -- shunt/toml.yue:324
    it('accepts empty', function() -- shunt/toml.yue:332
      require('shunt.spec')._expect_that([=[(parse_ast '')]=], (parse_ast('')), (deep_eq(Ast())), tostring("shunt/toml.yue") .. ":" .. tostring(333)); -- shunt/toml.yue:333
      return require('shunt.spec')._expect_that([=[(parse_ast '\n')]=], (parse_ast('\n')), (deep_eq(Ast())), tostring("shunt/toml.yue") .. ":" .. tostring(334)) -- shunt/toml.yue:334
    end) -- shunt/toml.yue:332
    it('accepts root table', function() -- shunt/toml.yue:336
      require('shunt.spec')._expect_that([==[(parse_ast '\nkey=true')]==], (parse_ast('\nkey=true')), (deep_eq(Ast(Section(nil, { -- shunt/toml.yue:337
        Entry((Key({ -- shunt/toml.yue:337
          'key' -- shunt/toml.yue:337
        })), Value(true)) -- shunt/toml.yue:337
      })))), tostring("shunt/toml.yue") .. ":" .. tostring(337)); -- shunt/toml.yue:337
      require('shunt.spec')._expect_that([==[(parse_ast 'key=1234\nkey=-1234.5')]==], (parse_ast('key=1234\nkey=-1234.5')), (deep_eq(Ast(Section(nil, { -- shunt/toml.yue:339
        Entry((Key({ -- shunt/toml.yue:339
          'key' -- shunt/toml.yue:339
        })), Value(1234)), -- shunt/toml.yue:339
        Entry((Key({ -- shunt/toml.yue:339
          'key' -- shunt/toml.yue:339
        })), Value(-1234.5)) -- shunt/toml.yue:339
      })))), tostring("shunt/toml.yue") .. ":" .. tostring(339)); -- shunt/toml.yue:339
      require('shunt.spec')._expect_that([==[(parse_ast "key='aa'\n\nkey='aa'")]==], (parse_ast("key='aa'\n\nkey='aa'")), (deep_eq(Ast(Section(nil, { -- shunt/toml.yue:342
        Entry((Key({ -- shunt/toml.yue:342
          'key' -- shunt/toml.yue:342
        })), Value('aa')), -- shunt/toml.yue:342
        Entry((Key({ -- shunt/toml.yue:342
          'key' -- shunt/toml.yue:342
        })), Value('aa')) -- shunt/toml.yue:342
      })))), tostring("shunt/toml.yue") .. ":" .. tostring(342)); -- shunt/toml.yue:342
      return require('shunt.spec')._expect_that([==[(parse_ast 'key=true\nkey=false\n')]==], (parse_ast('key=true\nkey=false\n')), (deep_eq(Ast(Section(nil, { -- shunt/toml.yue:345
        Entry((Key({ -- shunt/toml.yue:345
          'key' -- shunt/toml.yue:345
        })), Value(true)), -- shunt/toml.yue:345
        Entry((Key({ -- shunt/toml.yue:345
          'key' -- shunt/toml.yue:345
        })), Value(false)) -- shunt/toml.yue:345
      })))), tostring("shunt/toml.yue") .. ":" .. tostring(345)) -- shunt/toml.yue:347
    end) -- shunt/toml.yue:336
    it('accepts composite keys', function() -- shunt/toml.yue:349
      return require('shunt.spec')._expect_that([==[(parse_ast 'key1.key2=true')]==], (parse_ast('key1.key2=true')), (deep_eq(Ast(Section(nil, { -- shunt/toml.yue:350
        Entry((Key({ -- shunt/toml.yue:350
          'key1', -- shunt/toml.yue:350
          'key2' -- shunt/toml.yue:350
        })), Value(true)) -- shunt/toml.yue:350
      })))), tostring("shunt/toml.yue") .. ":" .. tostring(350)) -- shunt/toml.yue:351
    end) -- shunt/toml.yue:349
    it('accepts named sections', function() -- shunt/toml.yue:353
      return require('shunt.spec')._expect_that([==[(parse_ast "

        [table]

        key = 'value'

        [[table.array]]

        key = 'value'

      ")]==], (parse_ast("\n\n        [table]\n\n        key = 'value'\n\n        [[table.array]]\n\n        key = 'value'\n\n      ")), (deep_eq(Ast(nil, { -- shunt/toml.yue:354
        Section((TableHeader(Key({ -- shunt/toml.yue:354
          'table' -- shunt/toml.yue:354
        }))), { -- shunt/toml.yue:354
          Entry((Key({ -- shunt/toml.yue:354
            'key' -- shunt/toml.yue:354
          })), Value('value')) -- shunt/toml.yue:354
        }), -- shunt/toml.yue:354
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:354
          'table', -- shunt/toml.yue:354
          'array' -- shunt/toml.yue:354
        }))), { -- shunt/toml.yue:354
          Entry((Key({ -- shunt/toml.yue:354
            'key' -- shunt/toml.yue:354
          })), Value('value')) -- shunt/toml.yue:354
        }) -- shunt/toml.yue:354
      }))), tostring("shunt/toml.yue") .. ":" .. tostring(354)) -- shunt/toml.yue:368
    end) -- shunt/toml.yue:353
    it('accepts both root and named sections', function() -- shunt/toml.yue:370
      return require('shunt.spec')._expect_that([==[(parse_ast "
        key = 'value'
        [table]
        key = 'value'
      ")]==], (parse_ast("\n        key = 'value'\n        [table]\n        key = 'value'\n      ")), (deep_eq(Ast((Section(nil, { -- shunt/toml.yue:371
        Entry((Key({ -- shunt/toml.yue:371
          'key' -- shunt/toml.yue:371
        })), Value('value')) -- shunt/toml.yue:371
      })), { -- shunt/toml.yue:371
        Section((TableHeader(Key({ -- shunt/toml.yue:371
          'table' -- shunt/toml.yue:371
        }))), { -- shunt/toml.yue:371
          Entry((Key({ -- shunt/toml.yue:371
            'key' -- shunt/toml.yue:371
          })), Value('value')) -- shunt/toml.yue:371
        }) -- shunt/toml.yue:371
      }))), tostring("shunt/toml.yue") .. ":" .. tostring(371)) -- shunt/toml.yue:376
    end) -- shunt/toml.yue:370
    return it('accepts empty sections', function() -- shunt/toml.yue:378
      return require('shunt.spec')._expect_that([=[(parse_ast "
        [table1]
        [table2]
        [[array]]
        [table3]
      ")]=], (parse_ast("\n        [table1]\n        [table2]\n        [[array]]\n        [table3]\n      ")), (deep_eq(Ast(nil, { -- shunt/toml.yue:379
        Section((TableHeader(Key({ -- shunt/toml.yue:379
          'table1' -- shunt/toml.yue:379
        })))), -- shunt/toml.yue:379
        Section((TableHeader(Key({ -- shunt/toml.yue:379
          'table2' -- shunt/toml.yue:379
        })))), -- shunt/toml.yue:379
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:379
          'array' -- shunt/toml.yue:379
        })))), -- shunt/toml.yue:379
        Section((TableHeader(Key({ -- shunt/toml.yue:379
          'table3' -- shunt/toml.yue:379
        })))) -- shunt/toml.yue:379
      }))), tostring("shunt/toml.yue") .. ":" .. tostring(379)) -- shunt/toml.yue:388
    end) -- shunt/toml.yue:388
  end) -- shunt/toml.yue:323
  describe('Ast', function() -- shunt/toml.yue:390
    it('constructs the root section', function() -- shunt/toml.yue:391
      local ast = Ast(Section(nil, { -- shunt/toml.yue:393
        Entry((Key({ -- shunt/toml.yue:393
          'key1' -- shunt/toml.yue:393
        })), Value(true)), -- shunt/toml.yue:393
        Entry((Key({ -- shunt/toml.yue:394
          'key2', -- shunt/toml.yue:394
          'key3' -- shunt/toml.yue:394
        })), Value('hello')) -- shunt/toml.yue:394
      })); -- shunt/toml.yue:392
      return require('shunt.spec')._expect_that([=[ast\construct_value!]=], ast:construct_value(), (deep_eq({ -- shunt/toml.yue:395
        key1 = true, -- shunt/toml.yue:395
        key2 = { -- shunt/toml.yue:395
          key3 = 'hello' -- shunt/toml.yue:395
        } -- shunt/toml.yue:395
      })), tostring("shunt/toml.yue") .. ":" .. tostring(395)) -- shunt/toml.yue:398
    end) -- shunt/toml.yue:391
    it('constructs table sections', function() -- shunt/toml.yue:400
      local ast = Ast(nil, { -- shunt/toml.yue:402
        Section((TableHeader(Key({ -- shunt/toml.yue:402
          'table1' -- shunt/toml.yue:402
        }))), { -- shunt/toml.yue:403
          Entry((Key({ -- shunt/toml.yue:403
            'key1' -- shunt/toml.yue:403
          })), Value(true)), -- shunt/toml.yue:403
          Entry((Key({ -- shunt/toml.yue:404
            'key2', -- shunt/toml.yue:404
            'key3' -- shunt/toml.yue:404
          })), Value('hello')) -- shunt/toml.yue:404
        }), -- shunt/toml.yue:402
        Section((TableHeader(Key({ -- shunt/toml.yue:405
          'table1' -- shunt/toml.yue:405
        }))), { -- shunt/toml.yue:406
          Entry((Key({ -- shunt/toml.yue:406
            'key4' -- shunt/toml.yue:406
          })), Value('world')) -- shunt/toml.yue:406
        }), -- shunt/toml.yue:405
        Section((TableHeader(Key({ -- shunt/toml.yue:407
          'table2', -- shunt/toml.yue:407
          'table3' -- shunt/toml.yue:407
        }))), { -- shunt/toml.yue:408
          Entry((Key({ -- shunt/toml.yue:408
            'key5' -- shunt/toml.yue:408
          })), Value('hello')) -- shunt/toml.yue:408
        }), -- shunt/toml.yue:407
        Section((TableHeader(Key({ -- shunt/toml.yue:409
          'table2', -- shunt/toml.yue:409
          'table3' -- shunt/toml.yue:409
        }))), { -- shunt/toml.yue:410
          Entry((Key({ -- shunt/toml.yue:410
            'key6' -- shunt/toml.yue:410
          })), Value('world')) -- shunt/toml.yue:410
        }) -- shunt/toml.yue:409
      }); -- shunt/toml.yue:401
      return require('shunt.spec')._expect_that([=[ast\construct_value!]=], ast:construct_value(), (deep_eq({ -- shunt/toml.yue:411
        table1 = { -- shunt/toml.yue:411
          key1 = true, -- shunt/toml.yue:411
          key2 = { -- shunt/toml.yue:411
            key3 = 'hello' -- shunt/toml.yue:411
          }, -- shunt/toml.yue:411
          key4 = 'world' -- shunt/toml.yue:411
        }, -- shunt/toml.yue:411
        table2 = { -- shunt/toml.yue:411
          table3 = { -- shunt/toml.yue:411
            key5 = 'hello', -- shunt/toml.yue:411
            key6 = 'world' -- shunt/toml.yue:411
          } -- shunt/toml.yue:411
        } -- shunt/toml.yue:411
      })), tostring("shunt/toml.yue") .. ":" .. tostring(411)) -- shunt/toml.yue:420
    end) -- shunt/toml.yue:400
    return it('constructs array of tables sections', function() -- shunt/toml.yue:422
      local ast = Ast(nil, { -- shunt/toml.yue:424
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:424
          'table1' -- shunt/toml.yue:424
        }))), { -- shunt/toml.yue:425
          Entry((Key({ -- shunt/toml.yue:425
            'key1' -- shunt/toml.yue:425
          })), Value(true)), -- shunt/toml.yue:425
          Entry((Key({ -- shunt/toml.yue:426
            'key2', -- shunt/toml.yue:426
            'key3' -- shunt/toml.yue:426
          })), Value('hello')) -- shunt/toml.yue:426
        }), -- shunt/toml.yue:424
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:427
          'table1' -- shunt/toml.yue:427
        }))), { -- shunt/toml.yue:428
          Entry((Key({ -- shunt/toml.yue:428
            'key4' -- shunt/toml.yue:428
          })), Value('hello')) -- shunt/toml.yue:428
        }), -- shunt/toml.yue:427
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:429
          'table2', -- shunt/toml.yue:429
          'table3' -- shunt/toml.yue:429
        }))), { -- shunt/toml.yue:430
          Entry((Key({ -- shunt/toml.yue:430
            'key1' -- shunt/toml.yue:430
          })), Value(true)), -- shunt/toml.yue:430
          Entry((Key({ -- shunt/toml.yue:431
            'key2', -- shunt/toml.yue:431
            'key3' -- shunt/toml.yue:431
          })), Value('hello')) -- shunt/toml.yue:431
        }), -- shunt/toml.yue:429
        Section((ArrayOfTablesHeader(Key({ -- shunt/toml.yue:432
          'table2', -- shunt/toml.yue:432
          'table3' -- shunt/toml.yue:432
        }))), { -- shunt/toml.yue:433
          Entry((Key({ -- shunt/toml.yue:433
            'key4' -- shunt/toml.yue:433
          })), Value('hello')) -- shunt/toml.yue:433
        }) -- shunt/toml.yue:432
      }); -- shunt/toml.yue:423
      return require('shunt.spec')._expect_that([=[ast\construct_value!]=], ast:construct_value(), (deep_eq({ -- shunt/toml.yue:434
        table1 = { -- shunt/toml.yue:434
          { -- shunt/toml.yue:434
            key1 = true, -- shunt/toml.yue:434
            key2 = { -- shunt/toml.yue:434
              key3 = 'hello' -- shunt/toml.yue:434
            } -- shunt/toml.yue:434
          }, -- shunt/toml.yue:434
          { -- shunt/toml.yue:434
            key4 = 'hello' -- shunt/toml.yue:434
          } -- shunt/toml.yue:434
        }, -- shunt/toml.yue:434
        table2 = { -- shunt/toml.yue:434
          table3 = { -- shunt/toml.yue:434
            { -- shunt/toml.yue:434
              key1 = true, -- shunt/toml.yue:434
              key2 = { -- shunt/toml.yue:434
                key3 = 'hello' -- shunt/toml.yue:434
              } -- shunt/toml.yue:434
            }, -- shunt/toml.yue:434
            { -- shunt/toml.yue:434
              key4 = 'hello' -- shunt/toml.yue:434
            } -- shunt/toml.yue:434
          } -- shunt/toml.yue:434
        } -- shunt/toml.yue:434
      })), tostring("shunt/toml.yue") .. ":" .. tostring(434)) -- shunt/toml.yue:445
    end) -- shunt/toml.yue:445
  end) -- shunt/toml.yue:390
  return describe('decode', function() -- shunt/toml.yue:447
    it('returns an empty table on empty input', function() -- shunt/toml.yue:448
      local v, err = decode(''); -- shunt/toml.yue:449
      require('shunt.spec')._expect_that([=[v]=], v, (deep_eq({ })), tostring("shunt/toml.yue") .. ":" .. tostring(450)); -- shunt/toml.yue:450
      return require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/toml.yue") .. ":" .. tostring(451)) -- shunt/toml.yue:451
    end) -- shunt/toml.yue:448
    it('parses toml and returns its value', function() -- shunt/toml.yue:453
      local v, err = decode("hello = 'world'"); -- shunt/toml.yue:454
      require('shunt.spec')._expect_that([=[v]=], v, (deep_eq({ -- shunt/toml.yue:455
        hello = 'world' -- shunt/toml.yue:455
      })), tostring("shunt/toml.yue") .. ":" .. tostring(455)); -- shunt/toml.yue:455
      return require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/toml.yue") .. ":" .. tostring(457)) -- shunt/toml.yue:457
    end) -- shunt/toml.yue:453
    return it('reports errors', function() -- shunt/toml.yue:459
      local v, err = decode('['); -- shunt/toml.yue:460
      require('shunt.spec')._expect_that([=[v]=], v, (eq(nil)), tostring("shunt/toml.yue") .. ":" .. tostring(461)); -- shunt/toml.yue:461
      return require('shunt.spec')._expect_that([=[err]=], err, (matches('expected')), tostring("shunt/toml.yue") .. ":" .. tostring(462)) -- shunt/toml.yue:462
    end) -- shunt/toml.yue:462
  end) -- shunt/toml.yue:462
end) -- shunt/toml.yue:263
return _module_0 -- shunt/toml.yue:462
end
package.preload['shunt.data.queue'] = function(...)
-- [yue]: shunt/data/queue.yue
local _module_0 = { } -- shunt/data/queue.yue:1
local declare_type, F, T -- shunt/data/queue.yue:0
do -- shunt/data/queue.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/data/queue.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/data/queue.yue:0
end -- shunt/data/queue.yue:0
local spec = require('shunt.spec').spec -- shunt/data/queue.yue:0
declare_type('Queue', [[{
  len: () => number,
  enqueue: (some) => <>,
  dequeue: () => ?some,
  extract: ((some) -> boolean) => ?some,
  peek: () => ?some,
  iter: () => function,
}]]) -- shunt/data/queue.yue:6
local Queue -- shunt/data/queue.yue:14
do -- shunt/data/queue.yue:14
  local _class_0 -- shunt/data/queue.yue:14
  local _base_0 = { -- shunt/data/queue.yue:14
    len = F('() => number', function(self) -- shunt/data/queue.yue:21
      return self._len -- shunt/data/queue.yue:22
    end), -- shunt/data/queue.yue:24
    enqueue = F('(some) => <>', function(self, elem) -- shunt/data/queue.yue:24
      self.elems[self.back] = T(self.elem_type, elem) -- shunt/data/queue.yue:25
      self.back = self.back + 1 -- shunt/data/queue.yue:26
      self._len = self._len + 1 -- shunt/data/queue.yue:27
    end), -- shunt/data/queue.yue:29
    dequeue = F('() => ?some', function(self) -- shunt/data/queue.yue:29
      local ret = self.elems[self.front] -- shunt/data/queue.yue:30
      if (ret ~= nil) then -- shunt/data/queue.yue:31
        T(self.elem_type, ret) -- shunt/data/queue.yue:32
        self.elems[self.front] = nil -- shunt/data/queue.yue:33
        while not (self.elems[self.front] ~= nil) and self.front < self.back do -- shunt/data/queue.yue:34
          self.front = self.front + 1 -- shunt/data/queue.yue:35
        end -- shunt/data/queue.yue:35
        self._len = self._len - 1 -- shunt/data/queue.yue:36
      end -- shunt/data/queue.yue:31
      return ret -- shunt/data/queue.yue:37
    end), -- shunt/data/queue.yue:39
    peek = F('() => ?some', function(self) -- shunt/data/queue.yue:39
      return self.elems[self.front] -- shunt/data/queue.yue:40
    end), -- shunt/data/queue.yue:42
    extract = F('((some) -> boolean) => ?some', function(self, filter) -- shunt/data/queue.yue:42
      for i = self.front, self.back do -- shunt/data/queue.yue:43
        local _continue_0 = false -- shunt/data/queue.yue:44
        repeat -- shunt/data/queue.yue:44
          local elem = self.elems[i] -- shunt/data/queue.yue:44
          if not (elem ~= nil) then -- shunt/data/queue.yue:45
            _continue_0 = true -- shunt/data/queue.yue:46
            break -- shunt/data/queue.yue:46
          end -- shunt/data/queue.yue:45
          if filter(elem) then -- shunt/data/queue.yue:47
            self.elems[i] = nil -- shunt/data/queue.yue:48
            while not (self.elems[self.front] ~= nil) and self.front < self.back do -- shunt/data/queue.yue:49
              self.front = self.front + 1 -- shunt/data/queue.yue:50
            end -- shunt/data/queue.yue:50
            self._len = self._len - 1 -- shunt/data/queue.yue:51
            return elem -- shunt/data/queue.yue:53
          end -- shunt/data/queue.yue:47
          _continue_0 = true -- shunt/data/queue.yue:44
        until true -- shunt/data/queue.yue:53
        if not _continue_0 then -- shunt/data/queue.yue:53
          break -- shunt/data/queue.yue:53
        end -- shunt/data/queue.yue:53
      end -- shunt/data/queue.yue:53
      return nil -- shunt/data/queue.yue:54
    end), -- shunt/data/queue.yue:56
    iter = function(self) -- shunt/data/queue.yue:56
      return coroutine.wrap(function() -- shunt/data/queue.yue:57
        local i = self.front -- shunt/data/queue.yue:58
        local back = self.back -- shunt/data/queue.yue:59
        while i ~= back do -- shunt/data/queue.yue:60
          local _continue_0 = false -- shunt/data/queue.yue:61
          repeat -- shunt/data/queue.yue:61
            local elem = self.elems[i] -- shunt/data/queue.yue:61
            if not (elem ~= nil) then -- shunt/data/queue.yue:62
              _continue_0 = true -- shunt/data/queue.yue:63
              break -- shunt/data/queue.yue:63
            end -- shunt/data/queue.yue:62
            coroutine.yield(T(self.elem_type, elem)) -- shunt/data/queue.yue:64
            i = i + 1 -- shunt/data/queue.yue:65
            _continue_0 = true -- shunt/data/queue.yue:61
          until true -- shunt/data/queue.yue:65
          if not _continue_0 then -- shunt/data/queue.yue:65
            break -- shunt/data/queue.yue:65
          end -- shunt/data/queue.yue:65
        end -- shunt/data/queue.yue:65
      end) -- shunt/data/queue.yue:65
    end -- shunt/data/queue.yue:14
  } -- shunt/data/queue.yue:14
  if _base_0.__index == nil then -- shunt/data/queue.yue:14
    _base_0.__index = _base_0 -- shunt/data/queue.yue:14
  end -- shunt/data/queue.yue:65
  _class_0 = setmetatable({ -- shunt/data/queue.yue:14
    __init = F('(string) => <>', function(self, elem_type) -- shunt/data/queue.yue:15
      self.elem_type = elem_type -- shunt/data/queue.yue:15
      self.elems = { } -- shunt/data/queue.yue:16
      self.front = 1 -- shunt/data/queue.yue:17
      self.back = 1 -- shunt/data/queue.yue:18
      self._len = 0 -- shunt/data/queue.yue:19
    end), -- shunt/data/queue.yue:14
    __base = _base_0, -- shunt/data/queue.yue:14
    __name = "Queue" -- shunt/data/queue.yue:14
  }, { -- shunt/data/queue.yue:14
    __index = _base_0, -- shunt/data/queue.yue:14
    __call = function(cls, ...) -- shunt/data/queue.yue:14
      local _self_0 = setmetatable({ }, _base_0) -- shunt/data/queue.yue:14
      cls.__init(_self_0, ...) -- shunt/data/queue.yue:14
      return _self_0 -- shunt/data/queue.yue:14
    end -- shunt/data/queue.yue:14
  }) -- shunt/data/queue.yue:14
  _base_0.__class = _class_0 -- shunt/data/queue.yue:14
  Queue = _class_0 -- shunt/data/queue.yue:14
end -- shunt/data/queue.yue:65
_module_0["Queue"] = Queue -- shunt/data/queue.yue:14
spec(function() -- shunt/data/queue.yue:67
  local describe, it, matchers -- shunt/data/queue.yue:0
  do -- shunt/data/queue.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/data/queue.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/data/queue.yue:0
  end -- shunt/data/queue.yue:0
  local contains, deep_eq, eq, errors, matches = matchers.contains, matchers.deep_eq, matchers.eq, matchers.errors, matchers.matches -- shunt/data/queue.yue:72
  return describe('Queue', function() -- shunt/data/queue.yue:74
    it('dequeues nil on empty', function() -- shunt/data/queue.yue:75
      local _with_0 = Queue('any') -- shunt/data/queue.yue:76
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(nil)), tostring("shunt/data/queue.yue") .. ":" .. tostring(77)) -- shunt/data/queue.yue:77
      return _with_0 -- shunt/data/queue.yue:76
    end) -- shunt/data/queue.yue:75
    it('dequeues in the right order', function() -- shunt/data/queue.yue:79
      local _with_0 = Queue('string') -- shunt/data/queue.yue:80
      require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(0)), tostring("shunt/data/queue.yue") .. ":" .. tostring(81)) -- shunt/data/queue.yue:81
      _with_0:enqueue('one') -- shunt/data/queue.yue:82
      _with_0:enqueue('two') -- shunt/data/queue.yue:83
      _with_0:enqueue('three'); -- shunt/data/queue.yue:84
      require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(3)), tostring("shunt/data/queue.yue") .. ":" .. tostring(85)); -- shunt/data/queue.yue:85
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq('one')), tostring("shunt/data/queue.yue") .. ":" .. tostring(86)); -- shunt/data/queue.yue:86
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq('two')), tostring("shunt/data/queue.yue") .. ":" .. tostring(87)); -- shunt/data/queue.yue:87
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq('three')), tostring("shunt/data/queue.yue") .. ":" .. tostring(88)); -- shunt/data/queue.yue:88
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(nil)), tostring("shunt/data/queue.yue") .. ":" .. tostring(89)); -- shunt/data/queue.yue:89
      require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(0)), tostring("shunt/data/queue.yue") .. ":" .. tostring(90)) -- shunt/data/queue.yue:90
      _with_0:enqueue('four') -- shunt/data/queue.yue:91
      _with_0:enqueue('five'); -- shunt/data/queue.yue:92
      require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(2)), tostring("shunt/data/queue.yue") .. ":" .. tostring(93)); -- shunt/data/queue.yue:93
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq('four')), tostring("shunt/data/queue.yue") .. ":" .. tostring(94)); -- shunt/data/queue.yue:94
      require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq('five')), tostring("shunt/data/queue.yue") .. ":" .. tostring(95)) -- shunt/data/queue.yue:95
      return _with_0 -- shunt/data/queue.yue:80
    end) -- shunt/data/queue.yue:79
    it('typechecks on enqueue', function() -- shunt/data/queue.yue:97
      local _with_0 = Queue('string') -- shunt/data/queue.yue:98
      require('shunt.spec')._expect_that([=[(-> \enqueue 123)]=], (function() -- shunt/data/queue.yue:99
        return _with_0:enqueue(123) -- shunt/data/queue.yue:99
      end), (errors(matches('expected string but got number'))), tostring("shunt/data/queue.yue") .. ":" .. tostring(99)) -- shunt/data/queue.yue:99
      return _with_0 -- shunt/data/queue.yue:98
    end) -- shunt/data/queue.yue:97
    it('typechecks on dequeue', function() -- shunt/data/queue.yue:101
      local _with_0 = Queue('{ interloper: nil }') -- shunt/data/queue.yue:102
      local elem = { } -- shunt/data/queue.yue:103
      _with_0:enqueue(elem) -- shunt/data/queue.yue:104
      elem.interloper = 'interloper'; -- shunt/data/queue.yue:105
      require('shunt.spec')._expect_that([=[(-> \dequeue!)]=], (function() -- shunt/data/queue.yue:107
        return _with_0:dequeue() -- shunt/data/queue.yue:107
      end), (errors(matches('expected nil but got string'))), tostring("shunt/data/queue.yue") .. ":" .. tostring(107)) -- shunt/data/queue.yue:107
      return _with_0 -- shunt/data/queue.yue:102
    end) -- shunt/data/queue.yue:101
    describe('\\extract', function() -- shunt/data/queue.yue:109
      it('extracts and handles length', function() -- shunt/data/queue.yue:110
        local _with_0 = Queue('some') -- shunt/data/queue.yue:111
        for i = 1, 3 do -- shunt/data/queue.yue:112
          _with_0:enqueue(i) -- shunt/data/queue.yue:113
        end -- shunt/data/queue.yue:113
        local extracted = _with_0:extract(function(elem) -- shunt/data/queue.yue:115
          return elem == 2 -- shunt/data/queue.yue:115
        end); -- shunt/data/queue.yue:115
        require('shunt.spec')._expect_that([=[extracted]=], extracted, (eq(2)), tostring("shunt/data/queue.yue") .. ":" .. tostring(116)); -- shunt/data/queue.yue:116
        require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(2)), tostring("shunt/data/queue.yue") .. ":" .. tostring(117)) -- shunt/data/queue.yue:117
        extracted = _with_0:extract(function(elem) -- shunt/data/queue.yue:119
          return elem == 2 -- shunt/data/queue.yue:119
        end); -- shunt/data/queue.yue:119
        require('shunt.spec')._expect_that([=[extracted]=], extracted, (eq(nil)), tostring("shunt/data/queue.yue") .. ":" .. tostring(120)); -- shunt/data/queue.yue:120
        require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(2)), tostring("shunt/data/queue.yue") .. ":" .. tostring(121)) -- shunt/data/queue.yue:121
        return _with_0 -- shunt/data/queue.yue:111
      end) -- shunt/data/queue.yue:110
      return it('does not change on missing items', function() -- shunt/data/queue.yue:123
        local _with_0 = Queue('number') -- shunt/data/queue.yue:124
        _with_0:enqueue(1) -- shunt/data/queue.yue:125
        _with_0:enqueue(2) -- shunt/data/queue.yue:126
        _with_0:enqueue(3); -- shunt/data/queue.yue:127
        require('shunt.spec')._expect_that([===[(\extract (elem) -> elem == 2)]===], (_with_0:extract(function(elem) -- shunt/data/queue.yue:128
          return elem == 2 -- shunt/data/queue.yue:128
        end)), (eq(2)), tostring("shunt/data/queue.yue") .. ":" .. tostring(128)) -- shunt/data/queue.yue:128
        _with_0:enqueue(4); -- shunt/data/queue.yue:129
        require('shunt.spec')._expect_that([===[(\extract (elem) -> elem == 2)]===], (_with_0:extract(function(elem) -- shunt/data/queue.yue:130
          return elem == 2 -- shunt/data/queue.yue:130
        end)), (eq(nil)), tostring("shunt/data/queue.yue") .. ":" .. tostring(130)); -- shunt/data/queue.yue:130
        require('shunt.spec')._expect_that([=[\len!]=], _with_0:len(), (eq(3)), tostring("shunt/data/queue.yue") .. ":" .. tostring(131)); -- shunt/data/queue.yue:131
        require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(1)), tostring("shunt/data/queue.yue") .. ":" .. tostring(132)); -- shunt/data/queue.yue:132
        require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(3)), tostring("shunt/data/queue.yue") .. ":" .. tostring(133)); -- shunt/data/queue.yue:133
        require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(4)), tostring("shunt/data/queue.yue") .. ":" .. tostring(134)); -- shunt/data/queue.yue:134
        require('shunt.spec')._expect_that([=[\dequeue!]=], _with_0:dequeue(), (eq(nil)), tostring("shunt/data/queue.yue") .. ":" .. tostring(135)) -- shunt/data/queue.yue:135
        return _with_0 -- shunt/data/queue.yue:124
      end) -- shunt/data/queue.yue:135
    end) -- shunt/data/queue.yue:109
    return describe('\\iter', function() -- shunt/data/queue.yue:137
      it('yields in the correct order', function() -- shunt/data/queue.yue:138
        local _with_0 = Queue('string') -- shunt/data/queue.yue:139
        _with_0:enqueue('one') -- shunt/data/queue.yue:140
        _with_0:enqueue('two') -- shunt/data/queue.yue:141
        _with_0:enqueue('three'); -- shunt/data/queue.yue:142
        require('shunt.spec')._expect_that([=[[ elem for elem in \iter! ]]=], (function() -- shunt/data/queue.yue:144
          local _accum_0 = { } -- shunt/data/queue.yue:144
          local _len_0 = 1 -- shunt/data/queue.yue:144
          for elem in _with_0:iter() do -- shunt/data/queue.yue:144
            _accum_0[_len_0] = elem -- shunt/data/queue.yue:144
            _len_0 = _len_0 + 1 -- shunt/data/queue.yue:144
          end -- shunt/data/queue.yue:144
          return _accum_0 -- shunt/data/queue.yue:144
        end)(), (deep_eq({ -- shunt/data/queue.yue:144
          'one', -- shunt/data/queue.yue:144
          'two', -- shunt/data/queue.yue:144
          'three' -- shunt/data/queue.yue:144
        })), tostring("shunt/data/queue.yue") .. ":" .. tostring(144)) -- shunt/data/queue.yue:144
        return _with_0 -- shunt/data/queue.yue:139
      end) -- shunt/data/queue.yue:138
      return it('typechecks yielded elements', function() -- shunt/data/queue.yue:149
        local _with_0 = Queue('{interloper: nil}') -- shunt/data/queue.yue:150
        local elem = { } -- shunt/data/queue.yue:151
        _with_0:enqueue(elem) -- shunt/data/queue.yue:152
        elem.interloper = 'interloper'; -- shunt/data/queue.yue:153
        require('shunt.spec')._expect_that([=[(-> [ elem for elem in \iter! ])]=], (function() -- shunt/data/queue.yue:155
          local _accum_0 = { } -- shunt/data/queue.yue:155
          local _len_0 = 1 -- shunt/data/queue.yue:155
          for elem in _with_0:iter() do -- shunt/data/queue.yue:155
            _accum_0[_len_0] = elem -- shunt/data/queue.yue:155
            _len_0 = _len_0 + 1 -- shunt/data/queue.yue:155
          end -- shunt/data/queue.yue:155
          return _accum_0 -- shunt/data/queue.yue:155
        end), (errors(matches('expected nil but got string'))), tostring("shunt/data/queue.yue") .. ":" .. tostring(155)) -- shunt/data/queue.yue:155
        return _with_0 -- shunt/data/queue.yue:150
      end) -- shunt/data/queue.yue:155
    end) -- shunt/data/queue.yue:155
  end) -- shunt/data/queue.yue:155
end) -- shunt/data/queue.yue:67
return _module_0 -- shunt/data/queue.yue:155
end
package.preload['shunt.firewall'] = function(...)
-- [yue]: shunt/firewall.yue
local _module_0 = { } -- shunt/firewall.yue:1
local declare_type, F, T -- shunt/firewall.yue:0
do -- shunt/firewall.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/firewall.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/firewall.yue:0
end -- shunt/firewall.yue:0
local spec = require('shunt.spec').spec -- shunt/firewall.yue:0
declare_type('Firewall', [[{
  add_child: (Firewall) => <>,
  permits: (Packet) => boolean,
}]]) -- shunt/firewall.yue:8
local Firewall -- shunt/firewall.yue:12
do -- shunt/firewall.yue:12
  local _class_0 -- shunt/firewall.yue:12
  local _base_0 = { -- shunt/firewall.yue:12
    add_child = F('(Firewall) => <>', function(self, child) -- shunt/firewall.yue:17
      local _list_0 = child.protocol_list -- shunt/firewall.yue:18
      for _index_0 = 1, #_list_0 do -- shunt/firewall.yue:18
        local protocol = _list_0[_index_0] -- shunt/firewall.yue:18
        self.protocols[protocol] = true -- shunt/firewall.yue:19
      end -- shunt/firewall.yue:19
    end), -- shunt/firewall.yue:21
    permits = F('(Packet) => boolean', function(self, packet) -- shunt/firewall.yue:21
      return self.protocols[packet.protocol] or false -- shunt/firewall.yue:22
    end) -- shunt/firewall.yue:12
  } -- shunt/firewall.yue:12
  if _base_0.__index == nil then -- shunt/firewall.yue:12
    _base_0.__index = _base_0 -- shunt/firewall.yue:12
  end -- shunt/firewall.yue:22
  _class_0 = setmetatable({ -- shunt/firewall.yue:12
    __init = F('([PacketType]) => <>', function(self, packet_types) -- shunt/firewall.yue:13
      self.protocol_list = T('[string]', (function() -- shunt/firewall.yue:14
        local _accum_0 = { } -- shunt/firewall.yue:14
        local _len_0 = 1 -- shunt/firewall.yue:14
        for _index_0 = 1, #packet_types do -- shunt/firewall.yue:14
          local packet_type = packet_types[_index_0] -- shunt/firewall.yue:14
          _accum_0[_len_0] = packet_type:protocol() -- shunt/firewall.yue:14
          _len_0 = _len_0 + 1 -- shunt/firewall.yue:14
        end -- shunt/firewall.yue:14
        return _accum_0 -- shunt/firewall.yue:14
      end)()) -- shunt/firewall.yue:14
      self.protocols = T('{string}', (function() -- shunt/firewall.yue:15
        local _tbl_0 = { } -- shunt/firewall.yue:15
        local _list_0 = self.protocol_list -- shunt/firewall.yue:15
        for _index_0 = 1, #_list_0 do -- shunt/firewall.yue:15
          local protocol = _list_0[_index_0] -- shunt/firewall.yue:15
          _tbl_0[protocol] = true -- shunt/firewall.yue:15
        end -- shunt/firewall.yue:15
        return _tbl_0 -- shunt/firewall.yue:15
      end)()) -- shunt/firewall.yue:15
    end), -- shunt/firewall.yue:12
    __base = _base_0, -- shunt/firewall.yue:12
    __name = "Firewall" -- shunt/firewall.yue:12
  }, { -- shunt/firewall.yue:12
    __index = _base_0, -- shunt/firewall.yue:12
    __call = function(cls, ...) -- shunt/firewall.yue:12
      local _self_0 = setmetatable({ }, _base_0) -- shunt/firewall.yue:12
      cls.__init(_self_0, ...) -- shunt/firewall.yue:12
      return _self_0 -- shunt/firewall.yue:12
    end -- shunt/firewall.yue:12
  }) -- shunt/firewall.yue:12
  _base_0.__class = _class_0 -- shunt/firewall.yue:12
  Firewall = _class_0 -- shunt/firewall.yue:12
end -- shunt/firewall.yue:22
_module_0["Firewall"] = Firewall -- shunt/firewall.yue:12
spec(function() -- shunt/firewall.yue:24
  local Packet = require('shunt.peripheral.uplink').Packet -- shunt/firewall.yue:0
  local describe, it, matchers -- shunt/firewall.yue:0
  do -- shunt/firewall.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/firewall.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/firewall.yue:0
  end -- shunt/firewall.yue:0
  local eq = matchers.eq -- shunt/firewall.yue:30
  return describe('permits', function() -- shunt/firewall.yue:32
    local AdmittedPacket -- shunt/firewall.yue:33
    do -- shunt/firewall.yue:33
      local _class_0 -- shunt/firewall.yue:33
      local _parent_0 = Packet -- shunt/firewall.yue:33
      local _base_0 = { } -- shunt/firewall.yue:33
      for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/firewall.yue:33
        if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/firewall.yue:33
          _base_0[_key_0] = _val_0 -- shunt/firewall.yue:33
        end -- shunt/firewall.yue:33
      end -- shunt/firewall.yue:33
      if _base_0.__index == nil then -- shunt/firewall.yue:33
        _base_0.__index = _base_0 -- shunt/firewall.yue:33
      end -- shunt/firewall.yue:33
      setmetatable(_base_0, _parent_0.__base) -- shunt/firewall.yue:33
      _class_0 = setmetatable({ -- shunt/firewall.yue:33
        __init = function(self, ...) -- shunt/firewall.yue:33
          return _class_0.__parent.__init(self, ...) -- shunt/firewall.yue:33
        end, -- shunt/firewall.yue:33
        __base = _base_0, -- shunt/firewall.yue:33
        __name = "AdmittedPacket", -- shunt/firewall.yue:33
        __parent = _parent_0 -- shunt/firewall.yue:33
      }, { -- shunt/firewall.yue:33
        __index = function(cls, name) -- shunt/firewall.yue:33
          local val = rawget(_base_0, name) -- shunt/firewall.yue:33
          if val == nil then -- shunt/firewall.yue:33
            local parent = rawget(cls, "__parent") -- shunt/firewall.yue:33
            if parent then -- shunt/firewall.yue:33
              return parent[name] -- shunt/firewall.yue:33
            end -- shunt/firewall.yue:33
          else -- shunt/firewall.yue:33
            return val -- shunt/firewall.yue:33
          end -- shunt/firewall.yue:33
        end, -- shunt/firewall.yue:33
        __call = function(cls, ...) -- shunt/firewall.yue:33
          local _self_0 = setmetatable({ }, _base_0) -- shunt/firewall.yue:33
          cls.__init(_self_0, ...) -- shunt/firewall.yue:33
          return _self_0 -- shunt/firewall.yue:33
        end -- shunt/firewall.yue:33
      }) -- shunt/firewall.yue:33
      _base_0.__class = _class_0 -- shunt/firewall.yue:33
      if _parent_0.__inherited then -- shunt/firewall.yue:33
        _parent_0.__inherited(_parent_0, _class_0) -- shunt/firewall.yue:33
      end -- shunt/firewall.yue:33
      AdmittedPacket = _class_0 -- shunt/firewall.yue:33
    end -- shunt/firewall.yue:33
    local BlockedPacket -- shunt/firewall.yue:34
    do -- shunt/firewall.yue:34
      local _class_0 -- shunt/firewall.yue:34
      local _parent_0 = Packet -- shunt/firewall.yue:34
      local _base_0 = { } -- shunt/firewall.yue:34
      for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/firewall.yue:34
        if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/firewall.yue:34
          _base_0[_key_0] = _val_0 -- shunt/firewall.yue:34
        end -- shunt/firewall.yue:34
      end -- shunt/firewall.yue:34
      if _base_0.__index == nil then -- shunt/firewall.yue:34
        _base_0.__index = _base_0 -- shunt/firewall.yue:34
      end -- shunt/firewall.yue:34
      setmetatable(_base_0, _parent_0.__base) -- shunt/firewall.yue:34
      _class_0 = setmetatable({ -- shunt/firewall.yue:34
        __init = function(self, ...) -- shunt/firewall.yue:34
          return _class_0.__parent.__init(self, ...) -- shunt/firewall.yue:34
        end, -- shunt/firewall.yue:34
        __base = _base_0, -- shunt/firewall.yue:34
        __name = "BlockedPacket", -- shunt/firewall.yue:34
        __parent = _parent_0 -- shunt/firewall.yue:34
      }, { -- shunt/firewall.yue:34
        __index = function(cls, name) -- shunt/firewall.yue:34
          local val = rawget(_base_0, name) -- shunt/firewall.yue:34
          if val == nil then -- shunt/firewall.yue:34
            local parent = rawget(cls, "__parent") -- shunt/firewall.yue:34
            if parent then -- shunt/firewall.yue:34
              return parent[name] -- shunt/firewall.yue:34
            end -- shunt/firewall.yue:34
          else -- shunt/firewall.yue:34
            return val -- shunt/firewall.yue:34
          end -- shunt/firewall.yue:34
        end, -- shunt/firewall.yue:34
        __call = function(cls, ...) -- shunt/firewall.yue:34
          local _self_0 = setmetatable({ }, _base_0) -- shunt/firewall.yue:34
          cls.__init(_self_0, ...) -- shunt/firewall.yue:34
          return _self_0 -- shunt/firewall.yue:34
        end -- shunt/firewall.yue:34
      }) -- shunt/firewall.yue:34
      _base_0.__class = _class_0 -- shunt/firewall.yue:34
      if _parent_0.__inherited then -- shunt/firewall.yue:34
        _parent_0.__inherited(_parent_0, _class_0) -- shunt/firewall.yue:34
      end -- shunt/firewall.yue:34
      BlockedPacket = _class_0 -- shunt/firewall.yue:34
    end -- shunt/firewall.yue:34
    it('accepts packets correctly', function() -- shunt/firewall.yue:36
      local _with_0 = Firewall({ -- shunt/firewall.yue:37
        AdmittedPacket -- shunt/firewall.yue:37
      }) -- shunt/firewall.yue:37
      require('shunt.spec')._expect_that([=[(\permits AdmittedPacket!)]=], (_with_0:permits(AdmittedPacket())), (eq(true)), tostring("shunt/firewall.yue") .. ":" .. tostring(38)); -- shunt/firewall.yue:38
      require('shunt.spec')._expect_that([=[(\permits BlockedPacket!)]=], (_with_0:permits(BlockedPacket())), (eq(false)), tostring("shunt/firewall.yue") .. ":" .. tostring(39)) -- shunt/firewall.yue:39
      return _with_0 -- shunt/firewall.yue:37
    end) -- shunt/firewall.yue:36
    return it('accepts child-permitted packets correctly', function() -- shunt/firewall.yue:41
      local _with_0 = Firewall({ }) -- shunt/firewall.yue:42
      _with_0:add_child(Firewall({ -- shunt/firewall.yue:43
        AdmittedPacket -- shunt/firewall.yue:43
      })); -- shunt/firewall.yue:43
      require('shunt.spec')._expect_that([=[(\permits AdmittedPacket!)]=], (_with_0:permits(AdmittedPacket())), (eq(true)), tostring("shunt/firewall.yue") .. ":" .. tostring(44)); -- shunt/firewall.yue:44
      require('shunt.spec')._expect_that([=[(\permits BlockedPacket!)]=], (_with_0:permits(BlockedPacket())), (eq(false)), tostring("shunt/firewall.yue") .. ":" .. tostring(45)); -- shunt/firewall.yue:45
      require('shunt.spec')._expect_that([=[false]=], false, (eq(false)), tostring("shunt/firewall.yue") .. ":" .. tostring(46)) -- shunt/firewall.yue:46
      return _with_0 -- shunt/firewall.yue:42
    end) -- shunt/firewall.yue:46
  end) -- shunt/firewall.yue:46
end) -- shunt/firewall.yue:24
return _module_0 -- shunt/firewall.yue:46
end
package.preload['shunt.state'] = function(...)
-- [yue]: shunt/state.yue
local _module_0 = { } -- shunt/state.yue:1
local UNIMPLEMENTED, make_state, valid_ident, shallow_log_reporter -- shunt/state.yue:1
local log = require('shunt.logger').log -- shunt/state.yue:0
local declare_type, F, T -- shunt/state.yue:0
do -- shunt/state.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/state.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/state.yue:0
end -- shunt/state.yue:0
local spec = require('shunt.spec').spec -- shunt/state.yue:0
UNIMPLEMENTED = setmetatable({ }, { -- shunt/state.yue:9
  __call = function(...) end -- shunt/state.yue:9
}) -- shunt/state.yue:9
local StateMachineBuilder -- shunt/state.yue:11
do -- shunt/state.yue:11
  local _class_0 -- shunt/state.yue:11
  local _base_0 = { -- shunt/state.yue:11
    set_initial_state = F('(string) => Self', function(self, _initial_state_name) -- shunt/state.yue:22
      self._initial_state_name = _initial_state_name -- shunt/state.yue:22
      return self -- shunt/state.yue:22
    end), -- shunt/state.yue:24
    set_state_invariant = F('(({name: string}) -> <>) => Self', function(self, _check_state_invariant) -- shunt/state.yue:24
      self._check_state_invariant = _check_state_invariant -- shunt/state.yue:24
      return self -- shunt/state.yue:24
    end), -- shunt/state.yue:26
    set_transition_invariant = F('(({name: string}, {name: string}) -> <>) => Self', function(self, _check_transition_invariant) -- shunt/state.yue:26
      self._check_transition_invariant = _check_transition_invariant -- shunt/state.yue:26
      return self -- shunt/state.yue:26
    end), -- shunt/state.yue:28
    declare_endless = F('() => Self', function(self) -- shunt/state.yue:28
      self._endless = true -- shunt/state.yue:29
      return self -- shunt/state.yue:30
    end), -- shunt/state.yue:32
    set_reporter = F('((State, State) => <>) => Self', function(self, _reporter) -- shunt/state.yue:32
      self._reporter = _reporter -- shunt/state.yue:32
      return self -- shunt/state.yue:32
    end), -- shunt/state.yue:34
    add = F('(State) => Self', function(self, state) -- shunt/state.yue:34
      if (self._states[state._name] ~= nil) then -- shunt/state.yue:35
        error("cannot build state machine: state '" .. tostring(state._name) .. "' redefined") -- shunt/state.yue:36
      end -- shunt/state.yue:35
      self._states[state._name] = state -- shunt/state.yue:37
      return self -- shunt/state.yue:38
    end), -- shunt/state.yue:40
    build = F('() => StateMachine', function(self) -- shunt/state.yue:40
      do -- shunt/state.yue:41
        local err = self:validate() -- shunt/state.yue:41
        if err then -- shunt/state.yue:41
          error("cannot build state machine: " .. tostring(err)) -- shunt/state.yue:42
        end -- shunt/state.yue:41
      end -- shunt/state.yue:41
      return self:build_unchecked() -- shunt/state.yue:43
    end), -- shunt/state.yue:45
    validate = F('() => ?string', function(self) -- shunt/state.yue:45
      if not (self._initial_state_name ~= nil) then -- shunt/state.yue:46
        return 'initial state undefined' -- shunt/state.yue:47
      end -- shunt/state.yue:46
      if not (self._states[self._initial_state_name] ~= nil) then -- shunt/state.yue:48
        return "initial state '" .. tostring(self._initial_state_name) .. "' undefined" -- shunt/state.yue:49
      end -- shunt/state.yue:48
      if self._states[self._initial_state_name]._data_type ~= 'nil' then -- shunt/state.yue:50
        return 'initial state has data present' -- shunt/state.yue:51
      end -- shunt/state.yue:50
      if not self._endless then -- shunt/state.yue:52
        do -- shunt/state.yue:53
          local err = self:validate_end_states() -- shunt/state.yue:53
          if err then -- shunt/state.yue:53
            return err -- shunt/state.yue:54
          end -- shunt/state.yue:53
        end -- shunt/state.yue:53
      else -- shunt/state.yue:55
        do -- shunt/state.yue:55
          local err = self:validate_endless() -- shunt/state.yue:55
          if err then -- shunt/state.yue:55
            return err -- shunt/state.yue:56
          end -- shunt/state.yue:55
        end -- shunt/state.yue:55
      end -- shunt/state.yue:52
      do -- shunt/state.yue:57
        local err = self:validate_transitions() -- shunt/state.yue:57
        if err then -- shunt/state.yue:57
          return err -- shunt/state.yue:58
        end -- shunt/state.yue:57
      end -- shunt/state.yue:57
    end), -- shunt/state.yue:60
    validate_end_states = F('() => ?string', function(self) -- shunt/state.yue:60
      for _, state in pairs(self._states) do -- shunt/state.yue:61
        if state._is_end then -- shunt/state.yue:62
          return nil -- shunt/state.yue:63
        end -- shunt/state.yue:62
      end -- shunt/state.yue:63
      return "no end states declared" -- shunt/state.yue:64
    end), -- shunt/state.yue:66
    validate_endless = F('() => ?string', function(self) -- shunt/state.yue:66
      local dead_ends -- shunt/state.yue:67
      do -- shunt/state.yue:67
        local _with_0 = { } -- shunt/state.yue:67
        for _, state in pairs(self._states) do -- shunt/state.yue:68
          if #state._transition_list < 1 then -- shunt/state.yue:69
            _with_0[#_with_0 + 1] = state._name -- shunt/state.yue:70
          end -- shunt/state.yue:69
        end -- shunt/state.yue:70
        dead_ends = _with_0 -- shunt/state.yue:67
      end -- shunt/state.yue:67
      if #dead_ends > 0 then -- shunt/state.yue:71
        table.sort(dead_ends) -- shunt/state.yue:72
        return "the following states are dead ends: " .. tostring(table.concat(dead_ends, ', ')) -- shunt/state.yue:73
      end -- shunt/state.yue:71
      return nil -- shunt/state.yue:74
    end), -- shunt/state.yue:76
    validate_transitions = F('() => ?string', function(self) -- shunt/state.yue:76
      local seen = T('{string}', { }) -- shunt/state.yue:77
      local stack = T('[string]', { }) -- shunt/state.yue:78
      local dfs -- shunt/state.yue:79
      dfs = F('(string, {string->[string]}) -> <>', function(state_name, transitions) -- shunt/state.yue:80
        if seen[state_name] then -- shunt/state.yue:81
          return -- shunt/state.yue:82
        end -- shunt/state.yue:81
        seen[state_name] = true -- shunt/state.yue:83
        for _index_0 = 1, #stack do -- shunt/state.yue:85
          local name = stack[_index_0] -- shunt/state.yue:85
          if name == state_name then -- shunt/state.yue:86
            return -- shunt/state.yue:87
          end -- shunt/state.yue:86
        end -- shunt/state.yue:87
        stack[#stack + 1] = name -- shunt/state.yue:88
        local _list_0 = assert(transitions[state_name], "internal error: no transitions for " .. tostring(state_name)) -- shunt/state.yue:89
        for _index_0 = 1, #_list_0 do -- shunt/state.yue:89
          local neighbour = _list_0[_index_0] -- shunt/state.yue:89
          dfs(neighbour, transitions) -- shunt/state.yue:90
        end -- shunt/state.yue:90
        stack[#stack] = nil -- shunt/state.yue:91
      end) -- shunt/state.yue:80
      dfs(self._initial_state_name, (function() -- shunt/state.yue:93
        local _with_0 = { } -- shunt/state.yue:93
        for name, state in pairs(self._states) do -- shunt/state.yue:94
          do -- shunt/state.yue:95
            local _accum_0 = { } -- shunt/state.yue:95
            local _len_0 = 1 -- shunt/state.yue:95
            for state_name, _ in pairs(state._transitions) do -- shunt/state.yue:95
              _accum_0[_len_0] = state_name -- shunt/state.yue:95
              _len_0 = _len_0 + 1 -- shunt/state.yue:95
            end -- shunt/state.yue:95
            _with_0[name] = _accum_0 -- shunt/state.yue:95
          end -- shunt/state.yue:95
        end -- shunt/state.yue:95
        return _with_0 -- shunt/state.yue:93
      end)()) -- shunt/state.yue:93
      local non_reachable_from_start -- shunt/state.yue:97
      do -- shunt/state.yue:97
        local _with_0 = { } -- shunt/state.yue:97
        for state_name, _ in pairs(self._states) do -- shunt/state.yue:98
          if not seen[state_name] then -- shunt/state.yue:99
            _with_0[#_with_0 + 1] = state_name -- shunt/state.yue:100
          end -- shunt/state.yue:99
        end -- shunt/state.yue:100
        non_reachable_from_start = _with_0 -- shunt/state.yue:97
      end -- shunt/state.yue:97
      if #non_reachable_from_start > 0 then -- shunt/state.yue:101
        table.sort(non_reachable_from_start) -- shunt/state.yue:102
        return "the following states are not reachable from the start state: " .. tostring(table.concat(non_reachable_from_start, ', ')) -- shunt/state.yue:103
      end -- shunt/state.yue:101
      if not self._endless then -- shunt/state.yue:105
        seen = { } -- shunt/state.yue:106
        stack = { } -- shunt/state.yue:107
        local back_transitions -- shunt/state.yue:108
        do -- shunt/state.yue:108
          local _with_0 = { } -- shunt/state.yue:108
          for _, state in pairs(self._states) do -- shunt/state.yue:109
            _with_0[state._name] = { } -- shunt/state.yue:110
          end -- shunt/state.yue:110
          for _, state in pairs(self._states) do -- shunt/state.yue:111
            for neighbour, _ in pairs(state._transitions) do -- shunt/state.yue:112
              do -- shunt/state.yue:113
                local _obj_0 = _with_0[neighbour] -- shunt/state.yue:113
                _obj_0[#_obj_0 + 1] = state._name -- shunt/state.yue:113
              end -- shunt/state.yue:113
            end -- shunt/state.yue:113
          end -- shunt/state.yue:113
          back_transitions = _with_0 -- shunt/state.yue:108
        end -- shunt/state.yue:108
        local end_states -- shunt/state.yue:114
        do -- shunt/state.yue:114
          local _accum_0 = { } -- shunt/state.yue:114
          local _len_0 = 1 -- shunt/state.yue:114
          for _, state in pairs(self._states) do -- shunt/state.yue:114
            if state._is_end then -- shunt/state.yue:114
              _accum_0[_len_0] = state._name -- shunt/state.yue:114
              _len_0 = _len_0 + 1 -- shunt/state.yue:114
            end -- shunt/state.yue:114
          end -- shunt/state.yue:114
          end_states = _accum_0 -- shunt/state.yue:114
        end -- shunt/state.yue:114
        for _index_0 = 1, #end_states do -- shunt/state.yue:115
          local end_state = end_states[_index_0] -- shunt/state.yue:115
          dfs(end_state, back_transitions) -- shunt/state.yue:116
        end -- shunt/state.yue:116
        local non_reachable_from_end -- shunt/state.yue:118
        do -- shunt/state.yue:118
          local _with_0 = { } -- shunt/state.yue:118
          for state_name, _ in pairs(self._states) do -- shunt/state.yue:119
            if not seen[state_name] then -- shunt/state.yue:120
              _with_0[#_with_0 + 1] = state_name -- shunt/state.yue:121
            end -- shunt/state.yue:120
          end -- shunt/state.yue:121
          non_reachable_from_end = _with_0 -- shunt/state.yue:118
        end -- shunt/state.yue:118
        if #non_reachable_from_end > 0 then -- shunt/state.yue:122
          table.sort(non_reachable_from_end) -- shunt/state.yue:123
          return "the following states are not reachable from any end state: " .. tostring(table.concat(non_reachable_from_end, ', ')) -- shunt/state.yue:124
        end -- shunt/state.yue:122
      end -- shunt/state.yue:105
      return nil -- shunt/state.yue:126
    end), -- shunt/state.yue:128
    build_unchecked = F('() => StateMachine', function(self) -- shunt/state.yue:128
      local index -- shunt/state.yue:129
      do -- shunt/state.yue:129
        local _with_0 = { } -- shunt/state.yue:129
        local ended = false -- shunt/state.yue:130
        _with_0.name = self._name -- shunt/state.yue:132
        _with_0.states = setmetatable({ }, { -- shunt/state.yue:134
          __index = T('{string->string}', (function() -- shunt/state.yue:134
            local _with_1 = setmetatable({ }, { }) -- shunt/state.yue:134
            for state_name, _ in pairs(self._states) do -- shunt/state.yue:135
              _with_1[state_name] = state_name -- shunt/state.yue:136
            end -- shunt/state.yue:136
            getmetatable(_with_1).__index = function(self, key) -- shunt/state.yue:137
              return error("cannot get state '" .. tostring(key) .. "': no such state") -- shunt/state.yue:138
            end -- shunt/state.yue:137
            return _with_1 -- shunt/state.yue:134
          end)()), -- shunt/state.yue:134
          __newindex = function(self, _, _) -- shunt/state.yue:139
            return error("cannot set fields in states") -- shunt/state.yue:140
          end -- shunt/state.yue:139
        }) -- shunt/state.yue:133
        _with_0.state = make_state(self._initial_state_name, 'nil', nil) -- shunt/state.yue:142
        local check_state_invariant = self._check_state_invariant -- shunt/state.yue:143
        if (check_state_invariant ~= nil) then -- shunt/state.yue:144
          check_state_invariant(_with_0.state) -- shunt/state.yue:145
        end -- shunt/state.yue:144
        local states = self._states -- shunt/state.yue:147
        local reporter = self._reporter -- shunt/state.yue:149
        local check_transition_invariant = self._check_transition_invariant -- shunt/state.yue:150
        _with_0["goto"] = F('(string, any) => <>', function(self, name, data) -- shunt/state.yue:151
          if ended then -- shunt/state.yue:152
            error("internal error: cannot transition ended state machine") -- shunt/state.yue:153
          end -- shunt/state.yue:152
          if not (function() -- shunt/state.yue:154
            local _obj_0 = states[self.state.name] -- shunt/state.yue:154
            if _obj_0 ~= nil then -- shunt/state.yue:154
              return _obj_0._transitions[name] -- shunt/state.yue:154
            end -- shunt/state.yue:154
            return nil -- shunt/state.yue:154
          end)() then -- shunt/state.yue:154
            error(tostring(self.name) .. ": no such transition: " .. tostring(self.state.name) .. " -> " .. tostring(name)) -- shunt/state.yue:155
          end -- shunt/state.yue:154
          local new_state_spec = states[name] -- shunt/state.yue:156
          if not (new_state_spec ~= nil) then -- shunt/state.yue:157
            error("internal error: no such state '" .. tostring(name) .. "'") -- shunt/state.yue:158
          end -- shunt/state.yue:157
          local prev_state = _with_0.state -- shunt/state.yue:159
          _with_0.state = make_state(name, new_state_spec._data_type, data) -- shunt/state.yue:160
          if (reporter ~= nil) then -- shunt/state.yue:161
            reporter(self, prev_state, _with_0.state) -- shunt/state.yue:162
          end -- shunt/state.yue:161
          if (check_state_invariant ~= nil) then -- shunt/state.yue:163
            check_state_invariant(_with_0.state) -- shunt/state.yue:164
          end -- shunt/state.yue:163
          if (check_transition_invariant ~= nil) then -- shunt/state.yue:165
            return check_transition_invariant(prev_state, _with_0.state) -- shunt/state.yue:166
          end -- shunt/state.yue:165
        end) -- shunt/state.yue:151
        _with_0.recover_to = F('(string, any) => <>', function(self, name, data) -- shunt/state.yue:168
          ended = false -- shunt/state.yue:169
          local new_state_spec = states[name] -- shunt/state.yue:170
          if not (new_state_spec ~= nil) then -- shunt/state.yue:171
            error("internal error: no such state '" .. tostring(name) .. "'") -- shunt/state.yue:172
          end -- shunt/state.yue:171
          _with_0.state = make_state(name, new_state_spec._data_type, data) -- shunt/state.yue:173
          if (check_state_invariant ~= nil) then -- shunt/state.yue:174
            return check_state_invariant(_with_0.state) -- shunt/state.yue:175
          end -- shunt/state.yue:174
        end) -- shunt/state.yue:168
        local end_states -- shunt/state.yue:177
        do -- shunt/state.yue:177
          local _tbl_0 = { } -- shunt/state.yue:177
          for _, state in pairs(self._states) do -- shunt/state.yue:177
            if state._is_end then -- shunt/state.yue:177
              _tbl_0[state._name] = true -- shunt/state.yue:177
            end -- shunt/state.yue:177
          end -- shunt/state.yue:177
          end_states = _tbl_0 -- shunt/state.yue:177
        end -- shunt/state.yue:177
        _with_0["end"] = F('() => <>', function(self) -- shunt/state.yue:178
          if ended then -- shunt/state.yue:179
            error("internal error: cannot end state machine twice") -- shunt/state.yue:180
          end -- shunt/state.yue:179
          if not end_states[self.state.name] then -- shunt/state.yue:181
            error("internal error: state " .. tostring(self.state.name) .. " is not a valid end state") -- shunt/state.yue:182
          end -- shunt/state.yue:181
          if (check_state_invariant ~= nil) then -- shunt/state.yue:183
            check_state_invariant(_with_0.state) -- shunt/state.yue:184
          end -- shunt/state.yue:183
          ended = true -- shunt/state.yue:185
        end) -- shunt/state.yue:178
        local initial_state_name = self._initial_state_name -- shunt/state.yue:187
        _with_0.to_graphviz = F('() => string', function(self) -- shunt/state.yue:188
          local lines -- shunt/state.yue:189
          do -- shunt/state.yue:189
            local _with_1 = { } -- shunt/state.yue:189
            _with_1[#_with_1 + 1] = 'digraph {' -- shunt/state.yue:190
            _with_1[#_with_1 + 1] = '  bgcolor = black' -- shunt/state.yue:191
            _with_1[#_with_1 + 1] = '  color = white' -- shunt/state.yue:192
            _with_1[#_with_1 + 1] = "  label = \"" .. tostring(self.name) .. "\"" -- shunt/state.yue:193
            _with_1[#_with_1 + 1] = '  graph [' -- shunt/state.yue:194
            _with_1[#_with_1 + 1] = '    fontname = "NewCenturySchlbk-Roman"' -- shunt/state.yue:195
            _with_1[#_with_1 + 1] = '  ]' -- shunt/state.yue:196
            _with_1[#_with_1 + 1] = '  node [' -- shunt/state.yue:197
            _with_1[#_with_1 + 1] = '    color = white' -- shunt/state.yue:198
            _with_1[#_with_1 + 1] = '    fontcolor = white' -- shunt/state.yue:199
            _with_1[#_with_1 + 1] = '    fillcolor = white' -- shunt/state.yue:200
            _with_1[#_with_1 + 1] = '    shape = plaintext' -- shunt/state.yue:201
            _with_1[#_with_1 + 1] = '    fontname = "NewCenturySchlbk-Roman"' -- shunt/state.yue:202
            _with_1[#_with_1 + 1] = '  ]' -- shunt/state.yue:203
            _with_1[#_with_1 + 1] = '  edge [' -- shunt/state.yue:204
            _with_1[#_with_1 + 1] = '    color = white' -- shunt/state.yue:205
            _with_1[#_with_1 + 1] = '    fontcolor = white' -- shunt/state.yue:206
            _with_1[#_with_1 + 1] = '    fontname = "NewCenturySchlbk-Roman"' -- shunt/state.yue:207
            _with_1[#_with_1 + 1] = '  ]' -- shunt/state.yue:208
            _with_1[#_with_1 + 1] = '  levels=1' -- shunt/state.yue:209
            _with_1[#_with_1 + 1] = "  __init[shape=point]" -- shunt/state.yue:211
            _with_1[#_with_1 + 1] = "  __init -> " .. tostring(initial_state_name) -- shunt/state.yue:212
            local state_list -- shunt/state.yue:214
            do -- shunt/state.yue:214
              local _accum_0 = { } -- shunt/state.yue:214
              local _len_0 = 1 -- shunt/state.yue:214
              for state_name, state in pairs(states) do -- shunt/state.yue:214
                _accum_0[_len_0] = { -- shunt/state.yue:214
                  state_name = state_name, -- shunt/state.yue:214
                  state = state -- shunt/state.yue:214
                } -- shunt/state.yue:214
                _len_0 = _len_0 + 1 -- shunt/state.yue:214
              end -- shunt/state.yue:214
              state_list = _accum_0 -- shunt/state.yue:214
            end -- shunt/state.yue:214
            table.sort(state_list, function(a, b) -- shunt/state.yue:215
              return a.state_name < b.state_name -- shunt/state.yue:215
            end) -- shunt/state.yue:215
            for _index_0 = 1, #state_list do -- shunt/state.yue:216
              local _des_0 = state_list[_index_0] -- shunt/state.yue:216
              local state_name, state = _des_0.state_name, _des_0.state -- shunt/state.yue:216
              _with_1[#_with_1 + 1] = '' -- shunt/state.yue:217
              local fontname_override = '' -- shunt/state.yue:218
              if state._is_end then -- shunt/state.yue:219
                fontname_override = "fontname=\"NewCenturySchlbk-Italic\"" -- shunt/state.yue:220
              end -- shunt/state.yue:219
              _with_1[#_with_1 + 1] = "  " .. tostring(state_name) .. "[" .. tostring(fontname_override) .. "]" -- shunt/state.yue:221
              local num_transitions = #state._transition_list -- shunt/state.yue:223
              for i = 1, num_transitions do -- shunt/state.yue:224
                local other_state = state._transition_list[i] -- shunt/state.yue:225
                _with_1[#_with_1 + 1] = "  " .. tostring(state_name) .. " -> " .. tostring(other_state) .. "[weight=" .. tostring(1 + num_transitions - i) .. "]" -- shunt/state.yue:226
              end -- shunt/state.yue:226
            end -- shunt/state.yue:226
            _with_1[#_with_1 + 1] = '}' -- shunt/state.yue:228
            lines = _with_1 -- shunt/state.yue:189
          end -- shunt/state.yue:189
          return table.concat(lines, '\n') -- shunt/state.yue:229
        end) -- shunt/state.yue:188
        _with_0.to_mermaid = F('() => string', function(self) -- shunt/state.yue:231
          local lines -- shunt/state.yue:232
          do -- shunt/state.yue:232
            local _with_1 = { } -- shunt/state.yue:232
            _with_1[#_with_1 + 1] = 'stateDiagram' -- shunt/state.yue:233
            _with_1[#_with_1 + 1] = "  [*] --> " .. tostring(initial_state_name) -- shunt/state.yue:234
            local state_list -- shunt/state.yue:235
            do -- shunt/state.yue:235
              local _accum_0 = { } -- shunt/state.yue:235
              local _len_0 = 1 -- shunt/state.yue:235
              for state_name, state in pairs(states) do -- shunt/state.yue:235
                _accum_0[_len_0] = { -- shunt/state.yue:235
                  state_name = state_name, -- shunt/state.yue:235
                  state = state -- shunt/state.yue:235
                } -- shunt/state.yue:235
                _len_0 = _len_0 + 1 -- shunt/state.yue:235
              end -- shunt/state.yue:235
              state_list = _accum_0 -- shunt/state.yue:235
            end -- shunt/state.yue:235
            table.sort(state_list, function(a, b) -- shunt/state.yue:236
              return a.state_name < b.state_name -- shunt/state.yue:236
            end) -- shunt/state.yue:236
            for _index_0 = 1, #state_list do -- shunt/state.yue:237
              local _des_0 = state_list[_index_0] -- shunt/state.yue:237
              local state_name, state = _des_0.state_name, _des_0.state -- shunt/state.yue:237
              _with_1[#_with_1 + 1] = "  " .. tostring(state_name) -- shunt/state.yue:238
              if state._is_end then -- shunt/state.yue:239
                _with_1[#_with_1 + 1] = "  " .. tostring(state_name) .. " --> [*]" -- shunt/state.yue:240
              end -- shunt/state.yue:239
              local neighbours -- shunt/state.yue:242
              do -- shunt/state.yue:242
                local _accum_0 = { } -- shunt/state.yue:242
                local _len_0 = 1 -- shunt/state.yue:242
                for other_state in pairs(state._transitions) do -- shunt/state.yue:242
                  _accum_0[_len_0] = other_state -- shunt/state.yue:242
                  _len_0 = _len_0 + 1 -- shunt/state.yue:242
                end -- shunt/state.yue:242
                neighbours = _accum_0 -- shunt/state.yue:242
              end -- shunt/state.yue:242
              table.sort(neighbours) -- shunt/state.yue:243
              for _index_1 = 1, #neighbours do -- shunt/state.yue:244
                local neighbour = neighbours[_index_1] -- shunt/state.yue:244
                _with_1[#_with_1 + 1] = "  " .. tostring(state_name) .. " --> " .. tostring(neighbour) -- shunt/state.yue:245
              end -- shunt/state.yue:245
            end -- shunt/state.yue:245
            lines = _with_1 -- shunt/state.yue:232
          end -- shunt/state.yue:232
          return table.concat(lines, '\n') -- shunt/state.yue:247
        end) -- shunt/state.yue:231
        index = _with_0 -- shunt/state.yue:129
      end -- shunt/state.yue:129
      return T('StateMachine', setmetatable({ }, { -- shunt/state.yue:250
        __index = index, -- shunt/state.yue:250
        __newindex = function(self, key, v) -- shunt/state.yue:251
          return error("cannot add field '" .. tostring(key) .. "' to state machine") -- shunt/state.yue:252
        end -- shunt/state.yue:251
      })) -- shunt/state.yue:252
    end) -- shunt/state.yue:11
  } -- shunt/state.yue:11
  if _base_0.__index == nil then -- shunt/state.yue:11
    _base_0.__index = _base_0 -- shunt/state.yue:11
  end -- shunt/state.yue:252
  _class_0 = setmetatable({ -- shunt/state.yue:11
    __init = F('(string) => <>', function(self, _name) -- shunt/state.yue:12
      self._name = _name -- shunt/state.yue:12
      if not valid_ident(self._name) then -- shunt/state.yue:13
        error("cannot build state machine: name '" .. tostring(self._name) .. "' not a valid identifier") -- shunt/state.yue:14
      end -- shunt/state.yue:13
      self._states = T('{string -> table}', { }) -- shunt/state.yue:15
      self._initial_state_name = T('?string', nil) -- shunt/state.yue:16
      self._reporter = T('?(State, State) => <>', nil) -- shunt/state.yue:17
      self._endless = T('boolean', false) -- shunt/state.yue:18
      self._check_state_invariant = T('?({name: string}) -> <>', nil) -- shunt/state.yue:19
      self._check_transition_invariant = T('?({name: string}, {name: string}) -> <>', nil) -- shunt/state.yue:20
    end), -- shunt/state.yue:11
    __base = _base_0, -- shunt/state.yue:11
    __name = "StateMachineBuilder" -- shunt/state.yue:11
  }, { -- shunt/state.yue:11
    __index = _base_0, -- shunt/state.yue:11
    __call = function(cls, ...) -- shunt/state.yue:11
      local _self_0 = setmetatable({ }, _base_0) -- shunt/state.yue:11
      cls.__init(_self_0, ...) -- shunt/state.yue:11
      return _self_0 -- shunt/state.yue:11
    end -- shunt/state.yue:11
  }) -- shunt/state.yue:11
  _base_0.__class = _class_0 -- shunt/state.yue:11
  StateMachineBuilder = _class_0 -- shunt/state.yue:11
end -- shunt/state.yue:252
_module_0["StateMachineBuilder"] = StateMachineBuilder -- shunt/state.yue:11
make_state = F('(string, string, any) -> {}', function(name, data_type, data) -- shunt/state.yue:254
  T(data_type, data) -- shunt/state.yue:255
  local _with_0 = setmetatable({ -- shunt/state.yue:256
    name = name, -- shunt/state.yue:256
  }, { }) -- shunt/state.yue:256
  if 'table' == type(data) then -- shunt/state.yue:257
    getmetatable(_with_0).__index = data -- shunt/state.yue:258
  else -- shunt/state.yue:260
    getmetatable(_with_0).__index = { -- shunt/state.yue:260
      value = data -- shunt/state.yue:260
    } -- shunt/state.yue:260
  end -- shunt/state.yue:257
  getmetatable(_with_0).__newindex = function(self, key) -- shunt/state.yue:261
    local key_repr -- shunt/state.yue:262
    if 'string' == type(key) then -- shunt/state.yue:263
      key_repr = "." .. tostring(key) -- shunt/state.yue:264
    else -- shunt/state.yue:266
      key_repr = "[" .. tostring(key) .. "]" -- shunt/state.yue:266
    end -- shunt/state.yue:263
    return error("cannot directly assign state fields") -- shunt/state.yue:267
  end -- shunt/state.yue:261
  return _with_0 -- shunt/state.yue:256
end) -- shunt/state.yue:254
declare_type('State', [[{
  _is_end: boolean,
  _transitions: {string},
  _data_type: ?string,
}]]) -- shunt/state.yue:269
local State -- shunt/state.yue:274
do -- shunt/state.yue:274
  local _class_0 -- shunt/state.yue:274
  local _base_0 = { -- shunt/state.yue:274
    add_transition_to = F('(string) => Self', function(self, name) -- shunt/state.yue:285
      if not valid_ident(name) then -- shunt/state.yue:286
        error("cannot build state machine: state name '" .. tostring(name) .. "' not a valid identifier") -- shunt/state.yue:287
      end -- shunt/state.yue:286
      if (self._transitions[name] ~= nil) then -- shunt/state.yue:288
        error("cannot build state machine: transition " .. tostring(self._name) .. "->" .. tostring(name) .. " redefined") -- shunt/state.yue:289
      end -- shunt/state.yue:288
      self._transitions[name] = true -- shunt/state.yue:290
      do -- shunt/state.yue:291
        local _obj_0 = self._transition_list -- shunt/state.yue:291
        _obj_0[#_obj_0 + 1] = name -- shunt/state.yue:291
      end -- shunt/state.yue:291
      return self -- shunt/state.yue:292
    end), -- shunt/state.yue:294
    declare_end_state = F('() => Self', function(self) -- shunt/state.yue:294
      self._is_end = true -- shunt/state.yue:295
      return self -- shunt/state.yue:296
    end), -- shunt/state.yue:298
    set_data_type = F('(string) => Self', function(self, data_type) -- shunt/state.yue:298
      if self._data_type_set then -- shunt/state.yue:299
        error("cannot build state machine: data type for state " .. tostring(self._name) .. " already set") -- shunt/state.yue:300
      end -- shunt/state.yue:299
      self._data_type_set = true -- shunt/state.yue:301
      self._data_type = data_type -- shunt/state.yue:302
      return self -- shunt/state.yue:303
    end) -- shunt/state.yue:274
  } -- shunt/state.yue:274
  if _base_0.__index == nil then -- shunt/state.yue:274
    _base_0.__index = _base_0 -- shunt/state.yue:274
  end -- shunt/state.yue:303
  _class_0 = setmetatable({ -- shunt/state.yue:274
    __init = F('(string) => <>', function(self, _name) -- shunt/state.yue:275
      self._name = _name -- shunt/state.yue:275
      if not valid_ident(self._name) then -- shunt/state.yue:276
        error("cannot build state machine: state name '" .. tostring(self._name) .. "' not a valid identifier") -- shunt/state.yue:277
      end -- shunt/state.yue:276
      self._transitions = T('{string}', { }) -- shunt/state.yue:279
      self._transition_list = T('[string]', { }) -- shunt/state.yue:280
      self._data_type = T('string', 'nil') -- shunt/state.yue:281
      self._data_type_set = T('boolean', false) -- shunt/state.yue:282
      self._is_end = T('boolean', false) -- shunt/state.yue:283
    end), -- shunt/state.yue:274
    __base = _base_0, -- shunt/state.yue:274
    __name = "State" -- shunt/state.yue:274
  }, { -- shunt/state.yue:274
    __index = _base_0, -- shunt/state.yue:274
    __call = function(cls, ...) -- shunt/state.yue:274
      local _self_0 = setmetatable({ }, _base_0) -- shunt/state.yue:274
      cls.__init(_self_0, ...) -- shunt/state.yue:274
      return _self_0 -- shunt/state.yue:274
    end -- shunt/state.yue:274
  }) -- shunt/state.yue:274
  _base_0.__class = _class_0 -- shunt/state.yue:274
  State = _class_0 -- shunt/state.yue:274
end -- shunt/state.yue:303
_module_0["State"] = State -- shunt/state.yue:274
declare_type('StateMachine', [[{
  state: {name: string},
  goto: (string, ?{string -> any}) => <>,
}]]) -- shunt/state.yue:305
valid_ident = F('(string) -> boolean', function(name) -- shunt/state.yue:310
  return ((name:match('^[a-z][a-z0-9_]+[a-z0-9]$')) ~= nil) -- shunt/state.yue:311
end) -- shunt/state.yue:310
declare_type('StateResponses', '{string->()-><>}') -- shunt/state.yue:313
local StateResponsesBuilder -- shunt/state.yue:314
do -- shunt/state.yue:314
  local _class_0 -- shunt/state.yue:314
  local _base_0 = { -- shunt/state.yue:314
    add = F('(string, () -> <>) => Self', function(self, state, response) -- shunt/state.yue:318
      if not ((rawget(getmetatable(self.sm.states).__index, state)) ~= nil) then -- shunt/state.yue:319
        error("cannot add response to " .. tostring(self.sm.name) .. ": no such state '" .. tostring(state) .. "'") -- shunt/state.yue:320
      end -- shunt/state.yue:319
      if (self.responses[state] ~= nil) then -- shunt/state.yue:321
        error("cannot add response to " .. tostring(self.sm.name) .. ": response for '" .. tostring(state) .. "' already defined") -- shunt/state.yue:322
      end -- shunt/state.yue:321
      self.responses[state] = response -- shunt/state.yue:323
      return self -- shunt/state.yue:324
    end), -- shunt/state.yue:326
    build = F('() => StateResponses', function(self) -- shunt/state.yue:326
      local uncovered_states -- shunt/state.yue:327
      do -- shunt/state.yue:327
        local _with_0 = { } -- shunt/state.yue:327
        for state_name in pairs(getmetatable(self.sm.states).__index) do -- shunt/state.yue:328
          if not (self.responses[state_name] ~= nil) then -- shunt/state.yue:329
            _with_0[#_with_0 + 1] = state_name -- shunt/state.yue:330
          end -- shunt/state.yue:329
        end -- shunt/state.yue:330
        uncovered_states = _with_0 -- shunt/state.yue:327
      end -- shunt/state.yue:327
      if #uncovered_states > 0 then -- shunt/state.yue:331
        table.sort(uncovered_states) -- shunt/state.yue:332
        error("cannot build state responses: the following states have no response: " .. tostring(table.concat(uncovered_states, ', '))) -- shunt/state.yue:333
      end -- shunt/state.yue:331
      return self.responses -- shunt/state.yue:335
    end) -- shunt/state.yue:314
  } -- shunt/state.yue:314
  if _base_0.__index == nil then -- shunt/state.yue:314
    _base_0.__index = _base_0 -- shunt/state.yue:314
  end -- shunt/state.yue:335
  _class_0 = setmetatable({ -- shunt/state.yue:314
    __init = F('(StateMachine) => <>', function(self, sm) -- shunt/state.yue:315
      self.sm = sm -- shunt/state.yue:315
      self.responses = T('{string->()-><>}', { }) -- shunt/state.yue:316
    end), -- shunt/state.yue:314
    __base = _base_0, -- shunt/state.yue:314
    __name = "StateResponsesBuilder" -- shunt/state.yue:314
  }, { -- shunt/state.yue:314
    __index = _base_0, -- shunt/state.yue:314
    __call = function(cls, ...) -- shunt/state.yue:314
      local _self_0 = setmetatable({ }, _base_0) -- shunt/state.yue:314
      cls.__init(_self_0, ...) -- shunt/state.yue:314
      return _self_0 -- shunt/state.yue:314
    end -- shunt/state.yue:314
  }) -- shunt/state.yue:314
  _base_0.__class = _class_0 -- shunt/state.yue:314
  StateResponsesBuilder = _class_0 -- shunt/state.yue:314
end -- shunt/state.yue:335
_module_0["StateResponsesBuilder"] = StateResponsesBuilder -- shunt/state.yue:314
shallow_log_reporter = function(self, prev_state, state) -- shunt/state.yue:337
  return log(function() -- shunt/state.yue:338
    local fragments -- shunt/state.yue:339
    do -- shunt/state.yue:339
      local _with_0 = { } -- shunt/state.yue:339
      _with_0[#_with_0 + 1] = '$ ' -- shunt/state.yue:340
      _with_0[#_with_0 + 1] = self.name -- shunt/state.yue:341
      _with_0[#_with_0 + 1] = ':' -- shunt/state.yue:342
      _with_0[#_with_0 + 1] = prev_state.name -- shunt/state.yue:343
      _with_0[#_with_0 + 1] = '->' -- shunt/state.yue:344
      _with_0[#_with_0 + 1] = state.name -- shunt/state.yue:345
      local level_1_fields -- shunt/state.yue:346
      do -- shunt/state.yue:346
        local _accum_0 = { } -- shunt/state.yue:346
        local _len_0 = 1 -- shunt/state.yue:346
        for key, value in pairs(getmetatable(state).__index) do -- shunt/state.yue:346
          _accum_0[_len_0] = { -- shunt/state.yue:346
            key = key, -- shunt/state.yue:346
            value = value -- shunt/state.yue:346
          } -- shunt/state.yue:346
          _len_0 = _len_0 + 1 -- shunt/state.yue:346
        end -- shunt/state.yue:346
        level_1_fields = _accum_0 -- shunt/state.yue:346
      end -- shunt/state.yue:346
      table.sort(level_1_fields, function(a, b) -- shunt/state.yue:347
        return a.key < b.key -- shunt/state.yue:347
      end) -- shunt/state.yue:347
      for _index_0 = 1, #level_1_fields do -- shunt/state.yue:348
        local _des_0 = level_1_fields[_index_0] -- shunt/state.yue:348
        local key, value = _des_0.key, _des_0.value -- shunt/state.yue:348
        _with_0[#_with_0 + 1] = '\n    ' -- shunt/state.yue:349
        _with_0[#_with_0 + 1] = key -- shunt/state.yue:350
        _with_0[#_with_0 + 1] = ': ' -- shunt/state.yue:351
        local value_type = type(value) -- shunt/state.yue:352
        if 'function' == value_type or 'thread' == value_type or 'table' == value_type then -- shunt/state.yue:354
          _with_0[#_with_0 + 1] = '(' -- shunt/state.yue:355
          _with_0[#_with_0 + 1] = tostring(value) -- shunt/state.yue:356
          _with_0[#_with_0 + 1] = ')' -- shunt/state.yue:357
        elseif 'string' == value_type then -- shunt/state.yue:358
          _with_0[#_with_0 + 1] = '`' -- shunt/state.yue:359
          _with_0[#_with_0 + 1] = tostring(value) -- shunt/state.yue:360
          _with_0[#_with_0 + 1] = '\'' -- shunt/state.yue:361
        else -- shunt/state.yue:363
          _with_0[#_with_0 + 1] = tostring(value) -- shunt/state.yue:363
        end -- shunt/state.yue:363
        if value_type == 'table' then -- shunt/state.yue:364
          local level_2_fields -- shunt/state.yue:365
          do -- shunt/state.yue:365
            local _accum_0 = { } -- shunt/state.yue:365
            local _len_0 = 1 -- shunt/state.yue:365
            for key2, value2 in pairs(value) do -- shunt/state.yue:365
              _accum_0[_len_0] = { -- shunt/state.yue:365
                key2 = key2, -- shunt/state.yue:365
                value2 = value2 -- shunt/state.yue:365
              } -- shunt/state.yue:365
              _len_0 = _len_0 + 1 -- shunt/state.yue:365
            end -- shunt/state.yue:365
            level_2_fields = _accum_0 -- shunt/state.yue:365
          end -- shunt/state.yue:365
          table.sort(level_2_fields, function(a, b) -- shunt/state.yue:366
            return a.key2 < b.key2 -- shunt/state.yue:366
          end) -- shunt/state.yue:366
          for _index_1 = 1, #level_2_fields do -- shunt/state.yue:367
            local _des_1 = level_2_fields[_index_1] -- shunt/state.yue:367
            local key2, value2 = _des_1.key2, _des_1.value2 -- shunt/state.yue:367
            _with_0[#_with_0 + 1] = '\n      ' -- shunt/state.yue:368
            _with_0[#_with_0 + 1] = key2 -- shunt/state.yue:369
            _with_0[#_with_0 + 1] = ': ' -- shunt/state.yue:370
            do -- shunt/state.yue:371
              local _exp_0 = type(value2) -- shunt/state.yue:371
              if 'function' == _exp_0 or 'thread' == _exp_0 or 'table' == _exp_0 then -- shunt/state.yue:372
                _with_0[#_with_0 + 1] = '(' -- shunt/state.yue:373
                _with_0[#_with_0 + 1] = tostring(value2) -- shunt/state.yue:374
                _with_0[#_with_0 + 1] = ')' -- shunt/state.yue:375
              elseif 'string' == _exp_0 then -- shunt/state.yue:376
                _with_0[#_with_0 + 1] = '`' -- shunt/state.yue:377
                _with_0[#_with_0 + 1] = tostring(value2) -- shunt/state.yue:378
                _with_0[#_with_0 + 1] = '\'' -- shunt/state.yue:379
              else -- shunt/state.yue:381
                _with_0[#_with_0 + 1] = tostring(value2) -- shunt/state.yue:381
              end -- shunt/state.yue:381
            end -- shunt/state.yue:381
          end -- shunt/state.yue:381
        end -- shunt/state.yue:364
      end -- shunt/state.yue:381
      fragments = _with_0 -- shunt/state.yue:339
    end -- shunt/state.yue:339
    return table.concat(fragments) -- shunt/state.yue:382
  end) -- shunt/state.yue:382
end -- shunt/state.yue:337
_module_0["shallow_log_reporter"] = shallow_log_reporter -- shunt/state.yue:382
spec(function() -- shunt/state.yue:384
  local describe, it, matchers -- shunt/state.yue:0
  do -- shunt/state.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/state.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/state.yue:0
  end -- shunt/state.yue:0
  local anything, deep_eq, eq, errors, has_fields, len, matches, no_errors = matchers.anything, matchers.deep_eq, matchers.eq, matchers.errors, matchers.has_fields, matchers.len, matchers.matches, matchers.no_errors -- shunt/state.yue:389
  describe('StateMachineBuilder', function() -- shunt/state.yue:391
    it('exposes its name', function() -- shunt/state.yue:392
      local EXPECTED = 'some_name' -- shunt/state.yue:393
      local sm = (StateMachineBuilder(EXPECTED)):set_initial_state('q_0'):add((State('q_0')):declare_end_state()):build(); -- shunt/state.yue:394
      return require('shunt.spec')._expect_that([=[sm.name]=], sm.name, (eq(EXPECTED)), tostring("shunt/state.yue") .. ":" .. tostring(399)) -- shunt/state.yue:399
    end) -- shunt/state.yue:392
    it('rejects invalid state names', function() -- shunt/state.yue:401
      return require('shunt.spec')._expect_that([=[(-> StateMachineBuilder 'invalid-ident')]=], (function() -- shunt/state.yue:402
        return StateMachineBuilder('invalid-ident') -- shunt/state.yue:402
      end), (errors(matches("cannot build state machine: name 'invalid%-ident' not a valid identifier"))), tostring("shunt/state.yue") .. ":" .. tostring(402)) -- shunt/state.yue:402
    end) -- shunt/state.yue:401
    it('requires initial state', function() -- shunt/state.yue:404
      return require('shunt.spec')._expect_that([=[(-> (StateMachineBuilder 'test_sm')\build!)]=], (function() -- shunt/state.yue:405
        return (StateMachineBuilder('test_sm')):build() -- shunt/state.yue:405
      end), (errors(matches("cannot build state machine: initial state undefined"))), tostring("shunt/state.yue") .. ":" .. tostring(405)) -- shunt/state.yue:405
    end) -- shunt/state.yue:404
    it('rejects invalid initial state', function() -- shunt/state.yue:407
      return require('shunt.spec')._expect_that([=[(-> (StateMachineBuilder 'test_sm')\set_initial_state('phantom')\build!)]=], (function() -- shunt/state.yue:408
        return (StateMachineBuilder('test_sm')):set_initial_state('phantom'):build() -- shunt/state.yue:408
      end), (errors(matches("cannot build state machine: initial state 'phantom' undefined"))), tostring("shunt/state.yue") .. ":" .. tostring(408)) -- shunt/state.yue:408
    end) -- shunt/state.yue:407
    it('rejects duplicate state names', function() -- shunt/state.yue:410
      return require('shunt.spec')._expect_that([=[(-> (StateMachineBuilder 'test_sm')
        \set_initial_state 'waiting'
        \add State 'waiting'
        \add State 'waiting'
        \build!)]=], (function() -- shunt/state.yue:411
        return (StateMachineBuilder('test_sm')):set_initial_state('waiting'):add(State('waiting')):add(State('waiting')):build() -- shunt/state.yue:411
      end), (errors(matches("cannot build state machine: state 'waiting' redefined"))), tostring("shunt/state.yue") .. ":" .. tostring(411)) -- shunt/state.yue:415
    end) -- shunt/state.yue:410
    it('rejects repeated \\set_data_type calls', function() -- shunt/state.yue:417
      return require('shunt.spec')._expect_that([=[(-> (StateMachineBuilder 'test_sm')
        \set_initial_state 'waiting'
        \add (State 'waiting')
          \set_data_type 'string'
          \set_data_type 'number'
        \build!)]=], (function() -- shunt/state.yue:418
        return (StateMachineBuilder('test_sm')):set_initial_state('waiting'):add((State('waiting')):set_data_type('string'):set_data_type('number')):build() -- shunt/state.yue:418
      end), (errors(matches("cannot build state machine: data type for state waiting already set"))), tostring("shunt/state.yue") .. ":" .. tostring(418)) -- shunt/state.yue:423
    end) -- shunt/state.yue:417
    it('rejects invalid state names', function() -- shunt/state.yue:425
      return require('shunt.spec')._expect_that([=[(-> (StateMachineBuilder 'test_sm')
        \set_initial_state '-invalid'
        \add State '-invalid'
        \build!)]=], (function() -- shunt/state.yue:426
        return (StateMachineBuilder('test_sm')):set_initial_state('-invalid'):add(State('-invalid')):build() -- shunt/state.yue:426
      end), (errors(matches("cannot build state machine: state name '%-invalid' not a valid identifier"))), tostring("shunt/state.yue") .. ":" .. tostring(426)) -- shunt/state.yue:429
    end) -- shunt/state.yue:425
    it('formats itself as graphviz', function() -- shunt/state.yue:431
      local graphviz_repr = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state():add_transition_to('state_2')):add((State('state_2')):add_transition_to('state_1'):set_data_type([[{
            hello: string,
            world: number,
          }]])):build():to_graphviz() -- shunt/state.yue:432
      local expected_lines = { -- shunt/state.yue:446
        'digraph {', -- shunt/state.yue:446
        '  bgcolor = black', -- shunt/state.yue:447
        '  color = white', -- shunt/state.yue:448
        '  label = "test_sm"', -- shunt/state.yue:449
        '  graph [', -- shunt/state.yue:450
        '    fontname = "NewCenturySchlbk-Roman"', -- shunt/state.yue:451
        '  ]', -- shunt/state.yue:452
        '  node [', -- shunt/state.yue:453
        '    color = white', -- shunt/state.yue:454
        '    fontcolor = white', -- shunt/state.yue:455
        '    fillcolor = white', -- shunt/state.yue:456
        '    shape = plaintext', -- shunt/state.yue:457
        '    fontname = "NewCenturySchlbk-Roman"', -- shunt/state.yue:458
        '  ]', -- shunt/state.yue:459
        '  edge [', -- shunt/state.yue:460
        '    color = white', -- shunt/state.yue:461
        '    fontcolor = white', -- shunt/state.yue:462
        '    fontname = "NewCenturySchlbk-Roman"', -- shunt/state.yue:463
        '  ]', -- shunt/state.yue:464
        '  levels=1', -- shunt/state.yue:465
        '  __init[shape=point]', -- shunt/state.yue:466
        '  __init -> state_1', -- shunt/state.yue:467
        '', -- shunt/state.yue:468
        '  state_1[fontname="NewCenturySchlbk-Italic"]', -- shunt/state.yue:469
        '  state_1 -> state_2[weight=1]', -- shunt/state.yue:470
        '', -- shunt/state.yue:471
        '  state_2[]', -- shunt/state.yue:472
        '  state_2 -> state_1[weight=1]', -- shunt/state.yue:473
        '}' -- shunt/state.yue:474
      } -- shunt/state.yue:445
      local expected_repr = table.concat(expected_lines, '\n'); -- shunt/state.yue:475
      return require('shunt.spec')._expect_that([=[graphviz_repr]=], graphviz_repr, (eq(expected_repr)), tostring("shunt/state.yue") .. ":" .. tostring(476)) -- shunt/state.yue:476
    end) -- shunt/state.yue:431
    it('formats itself as mermaid', function() -- shunt/state.yue:478
      local mermaid_repr = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state():add_transition_to('state_2')):add((State('state_2')):add_transition_to('state_1'):set_data_type([[{
            hello: string,
            world: number,
          }]])):build():to_mermaid() -- shunt/state.yue:479
      local expected_lines = { -- shunt/state.yue:493
        'stateDiagram', -- shunt/state.yue:493
        '  [*] --> state_1', -- shunt/state.yue:494
        '  state_1', -- shunt/state.yue:495
        '  state_1 --> [*]', -- shunt/state.yue:496
        '  state_1 --> state_2', -- shunt/state.yue:497
        '  state_2', -- shunt/state.yue:498
        '  state_2 --> state_1' -- shunt/state.yue:499
      } -- shunt/state.yue:492
      local expected_repr = table.concat(expected_lines, '\n'); -- shunt/state.yue:500
      return require('shunt.spec')._expect_that([=[mermaid_repr]=], mermaid_repr, (eq(expected_repr)), tostring("shunt/state.yue") .. ":" .. tostring(501)) -- shunt/state.yue:501
    end) -- shunt/state.yue:478
    it('accepts endless state machines', function() -- shunt/state.yue:503
      local builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):declare_endless():add((State('state_1')):add_transition_to('state_1')); -- shunt/state.yue:504
      return require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:509
        local _base_0 = builder -- shunt/state.yue:509
        local _fn_0 = _base_0.build -- shunt/state.yue:509
        return _fn_0 and function(...) -- shunt/state.yue:509
          return _fn_0(_base_0, ...) -- shunt/state.yue:509
        end -- shunt/state.yue:509
      end)(), (no_errors()), tostring("shunt/state.yue") .. ":" .. tostring(509)) -- shunt/state.yue:509
    end) -- shunt/state.yue:503
    return it('rejects invalid transition graphs', function() -- shunt/state.yue:511
      local builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add(State('state_1')); -- shunt/state.yue:512
      require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:515
        local _base_0 = builder -- shunt/state.yue:515
        local _fn_0 = _base_0.build -- shunt/state.yue:515
        return _fn_0 and function(...) -- shunt/state.yue:515
          return _fn_0(_base_0, ...) -- shunt/state.yue:515
        end -- shunt/state.yue:515
      end)(), (errors(matches('no end states declared'))), tostring("shunt/state.yue") .. ":" .. tostring(515)) -- shunt/state.yue:515
      builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state():add_transition_to('state_2')):add((State('state_2')):add_transition_to('state_3')):add((State('state_3')):add_transition_to('state_1')); -- shunt/state.yue:517
      require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:526
        local _base_0 = builder -- shunt/state.yue:526
        local _fn_0 = _base_0.build -- shunt/state.yue:526
        return _fn_0 and function(...) -- shunt/state.yue:526
          return _fn_0(_base_0, ...) -- shunt/state.yue:526
        end -- shunt/state.yue:526
      end)(), (no_errors()), tostring("shunt/state.yue") .. ":" .. tostring(526)) -- shunt/state.yue:526
      builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state()):add((State('unreachable_1')):add_transition_to('unreachable_2')):add((State('unreachable_2'))); -- shunt/state.yue:528
      require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:535
        local _base_0 = builder -- shunt/state.yue:535
        local _fn_0 = _base_0.build -- shunt/state.yue:535
        return _fn_0 and function(...) -- shunt/state.yue:535
          return _fn_0(_base_0, ...) -- shunt/state.yue:535
        end -- shunt/state.yue:535
      end)(), (errors(matches('the following states are not reachable from the start state: unreachable_1, unreachable_2'))), tostring("shunt/state.yue") .. ":" .. tostring(535)) -- shunt/state.yue:535
      builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state():add_transition_to('interminable_1')):add((State('interminable_1')):add_transition_to('interminable_2')):add((State('interminable_2'))); -- shunt/state.yue:537
      require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:547
        local _base_0 = builder -- shunt/state.yue:547
        local _fn_0 = _base_0.build -- shunt/state.yue:547
        return _fn_0 and function(...) -- shunt/state.yue:547
          return _fn_0(_base_0, ...) -- shunt/state.yue:547
        end -- shunt/state.yue:547
      end)(), (errors(matches('the following states are not reachable from any end state: interminable_1, interminable_2'))), tostring("shunt/state.yue") .. ":" .. tostring(547)) -- shunt/state.yue:547
      builder = (StateMachineBuilder('test_sm')):set_initial_state('dead_end'):declare_endless():add(State('dead_end')); -- shunt/state.yue:549
      require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:553
        local _base_0 = builder -- shunt/state.yue:553
        local _fn_0 = _base_0.build -- shunt/state.yue:553
        return _fn_0 and function(...) -- shunt/state.yue:553
          return _fn_0(_base_0, ...) -- shunt/state.yue:553
        end -- shunt/state.yue:553
      end)(), (errors(matches('the following states are dead ends: dead_end'))), tostring("shunt/state.yue") .. ":" .. tostring(553)) -- shunt/state.yue:553
      builder = (StateMachineBuilder('test_sm')):set_initial_state('hub'):declare_endless():add((State('hub')):add_transition_to('dead_end_2'):add_transition_to('dead_end_1')):add(State('dead_end_2')):add(State('dead_end_1')); -- shunt/state.yue:554
      return require('shunt.spec')._expect_that([=[builder\build]=], (function() -- shunt/state.yue:562
        local _base_0 = builder -- shunt/state.yue:562
        local _fn_0 = _base_0.build -- shunt/state.yue:562
        return _fn_0 and function(...) -- shunt/state.yue:562
          return _fn_0(_base_0, ...) -- shunt/state.yue:562
        end -- shunt/state.yue:562
      end)(), (errors(matches('the following states are dead ends: dead_end_1, dead_end_2'))), tostring("shunt/state.yue") .. ":" .. tostring(562)) -- shunt/state.yue:562
    end) -- shunt/state.yue:562
  end) -- shunt/state.yue:391
  describe('valid_ident', function() -- shunt/state.yue:564
    local valid_idents = { -- shunt/state.yue:566
      'hello', -- shunt/state.yue:566
      'world_123' -- shunt/state.yue:567
    } -- shunt/state.yue:565
    for _index_0 = 1, #valid_idents do -- shunt/state.yue:568
      local ident = valid_idents[_index_0] -- shunt/state.yue:568
      it("accepts '" .. tostring(ident) .. "'", function() -- shunt/state.yue:569
        return require('shunt.spec')._expect_that([=[(valid_ident ident)]=], (valid_ident(ident)), (eq(true)), tostring("shunt/state.yue") .. ":" .. tostring(570)) -- shunt/state.yue:570
      end) -- shunt/state.yue:569
    end -- shunt/state.yue:570
    local invalid_idents = { -- shunt/state.yue:573
      '', -- shunt/state.yue:573
      '1234', -- shunt/state.yue:574
      '-qwer', -- shunt/state.yue:575
      '.asdf', -- shunt/state.yue:576
      'a-b' -- shunt/state.yue:577
    } -- shunt/state.yue:572
    for _index_0 = 1, #invalid_idents do -- shunt/state.yue:578
      local ident = invalid_idents[_index_0] -- shunt/state.yue:578
      it("rejects '" .. tostring(ident) .. "'", function() -- shunt/state.yue:579
        return require('shunt.spec')._expect_that([=[(valid_ident ident)]=], (valid_ident(ident)), (eq(false)), tostring("shunt/state.yue") .. ":" .. tostring(580)) -- shunt/state.yue:580
      end) -- shunt/state.yue:579
    end -- shunt/state.yue:580
  end) -- shunt/state.yue:564
  local make_test_sm -- shunt/state.yue:582
  make_test_sm = function() -- shunt/state.yue:582
    return (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state():add_transition_to('state_2'):add_transition_to('state_3')):add((State('state_2')):declare_end_state():set_data_type([[{
          hello: string,
          world: number,
          optional: ?string,
        }]]):add_transition_to('state_1')):add((State('state_3')):declare_end_state():set_data_type('number')):build() -- shunt/state.yue:600
  end -- shunt/state.yue:582
  describe('StateMachine', function() -- shunt/state.yue:602
    it('rejects new fields', function() -- shunt/state.yue:603
      local test_sm = make_test_sm(); -- shunt/state.yue:604
      return require('shunt.spec')._expect_that([==[(-> test_sm.foo = 'bar')]==], (function() -- shunt/state.yue:605
        test_sm.foo = 'bar' -- shunt/state.yue:605
      end), (errors(matches([[cannot add field 'foo' to state machine]]))), tostring("shunt/state.yue") .. ":" .. tostring(605)) -- shunt/state.yue:605
    end) -- shunt/state.yue:603
    describe('.state', function() -- shunt/state.yue:607
      it('exposes table data at its toplevel', function() -- shunt/state.yue:608
        local test_sm = make_test_sm() -- shunt/state.yue:609
        test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:611
          hello = 'asdf', -- shunt/state.yue:611
          world = 4321 -- shunt/state.yue:612
        }); -- shunt/state.yue:610
        require('shunt.spec')._expect_that([=[test_sm.state.hello]=], test_sm.state.hello, (eq('asdf')), tostring("shunt/state.yue") .. ":" .. tostring(613)); -- shunt/state.yue:613
        return require('shunt.spec')._expect_that([=[test_sm.state.world]=], test_sm.state.world, (eq(4321)), tostring("shunt/state.yue") .. ":" .. tostring(614)) -- shunt/state.yue:614
      end) -- shunt/state.yue:608
      it('exposes non-table data in the .data field', function() -- shunt/state.yue:616
        local test_sm = make_test_sm() -- shunt/state.yue:617
        test_sm["goto"](test_sm, 'state_3', 123); -- shunt/state.yue:618
        return require('shunt.spec')._expect_that([=[test_sm.state.value]=], test_sm.state.value, (eq(123)), tostring("shunt/state.yue") .. ":" .. tostring(619)) -- shunt/state.yue:619
      end) -- shunt/state.yue:616
      return it('rejects assignment', function() -- shunt/state.yue:621
        local test_sm = make_test_sm() -- shunt/state.yue:622
        test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:624
          hello = 'asdf', -- shunt/state.yue:624
          world = 4321 -- shunt/state.yue:625
        }); -- shunt/state.yue:623
        require('shunt.spec')._expect_that([==[(-> test_sm.state.absent = 'foo')]==], (function() -- shunt/state.yue:626
          test_sm.state.absent = 'foo' -- shunt/state.yue:626
        end), (errors(matches('cannot directly assign state fields'))), tostring("shunt/state.yue") .. ":" .. tostring(626)); -- shunt/state.yue:626
        require('shunt.spec')._expect_that([==[(-> test_sm.state.hello = nil)]==], (function() -- shunt/state.yue:627
          test_sm.state.hello = nil -- shunt/state.yue:627
        end), (errors(matches('cannot directly assign state fields'))), tostring("shunt/state.yue") .. ":" .. tostring(627)); -- shunt/state.yue:627
        return require('shunt.spec')._expect_that([==[(-> test_sm.state.hello = 'bar')]==], (function() -- shunt/state.yue:628
          test_sm.state.hello = 'bar' -- shunt/state.yue:628
        end), (errors(matches('cannot directly assign state fields'))), tostring("shunt/state.yue") .. ":" .. tostring(628)) -- shunt/state.yue:628
      end) -- shunt/state.yue:628
    end) -- shunt/state.yue:607
    describe('\\goto', function() -- shunt/state.yue:630
      it('requires at least one argument', function() -- shunt/state.yue:631
        local test_sm = make_test_sm(); -- shunt/state.yue:632
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto!)]=], (function() -- shunt/state.yue:633
          return test_sm["goto"](test_sm) -- shunt/state.yue:633
        end), (errors(anything())), tostring("shunt/state.yue") .. ":" .. tostring(633)) -- shunt/state.yue:633
      end) -- shunt/state.yue:631
      it('correctly transitions states', function() -- shunt/state.yue:635
        local test_sm = make_test_sm(); -- shunt/state.yue:636
        require('shunt.spec')._expect_that([=[test_sm.state.name]=], test_sm.state.name, (eq('state_1')), tostring("shunt/state.yue") .. ":" .. tostring(637)) -- shunt/state.yue:637
        test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:640
          hello = 'asdf', -- shunt/state.yue:640
          world = 4321 -- shunt/state.yue:641
        }); -- shunt/state.yue:639
        require('shunt.spec')._expect_that([=[test_sm.state.name]=], test_sm.state.name, (eq('state_2')), tostring("shunt/state.yue") .. ":" .. tostring(642)); -- shunt/state.yue:642
        require('shunt.spec')._expect_that([=[test_sm.state.hello]=], test_sm.state.hello, (eq('asdf')), tostring("shunt/state.yue") .. ":" .. tostring(643)); -- shunt/state.yue:643
        require('shunt.spec')._expect_that([=[test_sm.state.world]=], test_sm.state.world, (eq(4321)), tostring("shunt/state.yue") .. ":" .. tostring(644)); -- shunt/state.yue:644
        require('shunt.spec')._expect_that([=[test_sm.state.optional]=], test_sm.state.optional, (eq(nil)), tostring("shunt/state.yue") .. ":" .. tostring(645)) -- shunt/state.yue:645
        test_sm["goto"](test_sm, 'state_1'); -- shunt/state.yue:647
        require('shunt.spec')._expect_that([=[test_sm.state.name]=], test_sm.state.name, (eq('state_1')), tostring("shunt/state.yue") .. ":" .. tostring(648)); -- shunt/state.yue:648
        require('shunt.spec')._expect_that([=[test_sm.state.hello]=], test_sm.state.hello, (eq(nil)), tostring("shunt/state.yue") .. ":" .. tostring(649)); -- shunt/state.yue:649
        require('shunt.spec')._expect_that([=[test_sm.state.world]=], test_sm.state.world, (eq(nil)), tostring("shunt/state.yue") .. ":" .. tostring(650)); -- shunt/state.yue:650
        return require('shunt.spec')._expect_that([=[test_sm.state.optional]=], test_sm.state.optional, (eq(nil)), tostring("shunt/state.yue") .. ":" .. tostring(651)) -- shunt/state.yue:651
      end) -- shunt/state.yue:635
      it('rejects invalid transitions', function() -- shunt/state.yue:653
        local test_sm = make_test_sm(); -- shunt/state.yue:654
        require('shunt.spec')._expect_that([=[(-> test_sm\goto 'invalid')]=], (function() -- shunt/state.yue:655
          return test_sm["goto"](test_sm, 'invalid') -- shunt/state.yue:655
        end), (errors(matches('no such transition: state_1 %-> invalid'))), tostring("shunt/state.yue") .. ":" .. tostring(655)) -- shunt/state.yue:655
        test_sm["goto"](test_sm, 'state_3', 123); -- shunt/state.yue:657
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_1')]=], (function() -- shunt/state.yue:658
          return test_sm["goto"](test_sm, 'state_1') -- shunt/state.yue:658
        end), (errors(matches('no such transition: state_3 %-> state_1'))), tostring("shunt/state.yue") .. ":" .. tostring(658)) -- shunt/state.yue:658
      end) -- shunt/state.yue:653
      it('rejects transitions with missing data', function() -- shunt/state.yue:660
        local test_sm = make_test_sm(); -- shunt/state.yue:661
        require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_2')]=], (function() -- shunt/state.yue:662
          return test_sm["goto"](test_sm, 'state_2') -- shunt/state.yue:662
        end), (errors(matches('incorrect type: expected table but got nil'))), tostring("shunt/state.yue") .. ":" .. tostring(662)); -- shunt/state.yue:662
        require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_2', hello: 'asdf')]=], (function() -- shunt/state.yue:663
          return test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:663
            hello = 'asdf' -- shunt/state.yue:663
          }) -- shunt/state.yue:663
        end), (errors(matches('incorrect type: expected number but got nil'))), tostring("shunt/state.yue") .. ":" .. tostring(663)); -- shunt/state.yue:663
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_2', world: 123)]=], (function() -- shunt/state.yue:664
          return test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:664
            world = 123 -- shunt/state.yue:664
          }) -- shunt/state.yue:664
        end), (errors(matches('incorrect type: expected string but got nil'))), tostring("shunt/state.yue") .. ":" .. tostring(664)) -- shunt/state.yue:664
      end) -- shunt/state.yue:660
      it('validates state fields', function() -- shunt/state.yue:666
        local test_sm = make_test_sm(); -- shunt/state.yue:667
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_2', hello: 'asdf', world: 'fdsa')]=], (function() -- shunt/state.yue:668
          return test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:668
            hello = 'asdf', -- shunt/state.yue:668
            world = 'fdsa' -- shunt/state.yue:668
          }) -- shunt/state.yue:668
        end), (errors(matches('incorrect type: expected number but got string'))), tostring("shunt/state.yue") .. ":" .. tostring(668)) -- shunt/state.yue:668
      end) -- shunt/state.yue:666
      it('rejects extra state fields', function() -- shunt/state.yue:670
        local test_sm = make_test_sm(); -- shunt/state.yue:671
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_3', spare: 'spare')]=], (function() -- shunt/state.yue:672
          return test_sm["goto"](test_sm, 'state_3', { -- shunt/state.yue:672
            spare = 'spare' -- shunt/state.yue:672
          }) -- shunt/state.yue:672
        end), (errors(matches('incorrect type'))), tostring("shunt/state.yue") .. ":" .. tostring(672)) -- shunt/state.yue:672
      end) -- shunt/state.yue:670
      return it('rejects transition of ended state machine', function() -- shunt/state.yue:674
        local test_sm = make_test_sm() -- shunt/state.yue:675
        test_sm["end"](test_sm); -- shunt/state.yue:676
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_2', hello: 'asdf', world: 123)]=], (function() -- shunt/state.yue:677
          return test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:677
            hello = 'asdf', -- shunt/state.yue:677
            world = 123 -- shunt/state.yue:677
          }) -- shunt/state.yue:677
        end), (errors(matches('cannot transition ended state machine'))), tostring("shunt/state.yue") .. ":" .. tostring(677)) -- shunt/state.yue:677
      end) -- shunt/state.yue:677
    end) -- shunt/state.yue:630
    describe('\\end', function() -- shunt/state.yue:679
      it('accepts valid end state', function() -- shunt/state.yue:680
        local state_machine = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state()) -- shunt/state.yue:681
      end) -- shunt/state.yue:680
      return it('rejects invalid end state', function() -- shunt/state.yue:686
        local state_machine = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state()):build(); -- shunt/state.yue:687
        return require('shunt.spec')._expect_that([=[state_machine\end]=], (function() -- shunt/state.yue:694
          local _base_0 = state_machine -- shunt/state.yue:694
          local _fn_0 = _base_0["end"] -- shunt/state.yue:694
          return _fn_0 and function(...) -- shunt/state.yue:694
            return _fn_0(_base_0, ...) -- shunt/state.yue:694
          end -- shunt/state.yue:694
        end)(), (errors(matches('state_1 is not a valid end state'))), tostring("shunt/state.yue") .. ":" .. tostring(694)) -- shunt/state.yue:694
      end) -- shunt/state.yue:694
    end) -- shunt/state.yue:679
    describe('\\recover_to', function() -- shunt/state.yue:696
      it('allows recovery from any state to any state', function() -- shunt/state.yue:697
        local state_machine = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state():set_data_type([[{
              data: string,
            }]])):build() -- shunt/state.yue:698
        state_machine:recover_to('state_2', { -- shunt/state.yue:709
          data = 'asdf' -- shunt/state.yue:709
        }); -- shunt/state.yue:708
        require('shunt.spec')._assert_that([=[state_machine.state.name]=], state_machine.state.name, (eq('state_2')), tostring("shunt/state.yue") .. ":" .. tostring(710)); -- shunt/state.yue:710
        require('shunt.spec')._assert_that([=[state_machine.state.data]=], state_machine.state.data, (eq('asdf')), tostring("shunt/state.yue") .. ":" .. tostring(711)) -- shunt/state.yue:711
        state_machine:recover_to('state_1'); -- shunt/state.yue:713
        require('shunt.spec')._assert_that([=[state_machine.state.name]=], state_machine.state.name, (eq('state_1')), tostring("shunt/state.yue") .. ":" .. tostring(714)); -- shunt/state.yue:714
        return require('shunt.spec')._assert_that([=[state_machine.state.data]=], state_machine.state.data, (eq(nil)), tostring("shunt/state.yue") .. ":" .. tostring(715)) -- shunt/state.yue:715
      end) -- shunt/state.yue:697
      return it('allows recovery after end', function() -- shunt/state.yue:717
        local state_machine = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):add((State('state_1')):declare_end_state():add_transition_to('state_1')):build() -- shunt/state.yue:718
        state_machine["end"](state_machine) -- shunt/state.yue:724
        state_machine:recover_to('state_1') -- shunt/state.yue:725
        return state_machine["goto"](state_machine, 'state_1') -- shunt/state.yue:726
      end) -- shunt/state.yue:726
    end) -- shunt/state.yue:696
    describe('\\set_reporter', function() -- shunt/state.yue:728
      return it('is respected by state machines', function() -- shunt/state.yue:729
        local states = { } -- shunt/state.yue:730
        local test_sm = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):set_reporter(function(self, prev_state, state) -- shunt/state.yue:733
          states[#states + 1] = { -- shunt/state.yue:734
            prev_state = prev_state, -- shunt/state.yue:734
            state = state -- shunt/state.yue:734
          } -- shunt/state.yue:734
        end):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state():add_transition_to('state_1'):set_data_type([[{
              hello: string,
              world: number
            }]])):build() -- shunt/state.yue:731
        local data = { -- shunt/state.yue:747
          hello = 'asdf', -- shunt/state.yue:747
          world = 123 -- shunt/state.yue:748
        } -- shunt/state.yue:746
        test_sm["goto"](test_sm, 'state_2', data); -- shunt/state.yue:750
        require('shunt.spec')._expect_that([=[states]=], states, (deep_eq({ -- shunt/state.yue:752
          { -- shunt/state.yue:752
            prev_state = { -- shunt/state.yue:752
              name = 'state_1' -- shunt/state.yue:752
            }, -- shunt/state.yue:752
            state = (function() -- shunt/state.yue:752
              local _tab_0 = { -- shunt/state.yue:752
                name = 'state_2' -- shunt/state.yue:752
              } -- shunt/state.yue:752
              local _idx_0 = 1 -- shunt/state.yue:752
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:752
                if _idx_0 == _key_0 then -- shunt/state.yue:752
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:752
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:752
                else -- shunt/state.yue:752
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:752
                end -- shunt/state.yue:752
              end -- shunt/state.yue:752
              return _tab_0 -- shunt/state.yue:752
            end)() -- shunt/state.yue:752
          } -- shunt/state.yue:752
        })), tostring("shunt/state.yue") .. ":" .. tostring(752)) -- shunt/state.yue:752
        test_sm["goto"](test_sm, 'state_1') -- shunt/state.yue:756
        test_sm["goto"](test_sm, 'state_2', data) -- shunt/state.yue:757
        test_sm["goto"](test_sm, 'state_1') -- shunt/state.yue:758
        test_sm["goto"](test_sm, 'state_2', data); -- shunt/state.yue:759
        return require('shunt.spec')._expect_that([=[[ state for state in *states ]]=], (function() -- shunt/state.yue:761
          local _accum_0 = { } -- shunt/state.yue:761
          local _len_0 = 1 -- shunt/state.yue:761
          for _index_0 = 1, #states do -- shunt/state.yue:761
            local state = states[_index_0] -- shunt/state.yue:761
            _accum_0[_len_0] = state -- shunt/state.yue:761
            _len_0 = _len_0 + 1 -- shunt/state.yue:761
          end -- shunt/state.yue:761
          return _accum_0 -- shunt/state.yue:761
        end)(), (deep_eq({ -- shunt/state.yue:761
          { -- shunt/state.yue:761
            prev_state = { -- shunt/state.yue:761
              name = 'state_1' -- shunt/state.yue:761
            }, -- shunt/state.yue:761
            state = (function() -- shunt/state.yue:761
              local _tab_0 = { -- shunt/state.yue:761
                name = 'state_2' -- shunt/state.yue:761
              } -- shunt/state.yue:761
              local _idx_0 = 1 -- shunt/state.yue:761
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:761
                if _idx_0 == _key_0 then -- shunt/state.yue:761
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:761
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:761
                else -- shunt/state.yue:761
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:761
                end -- shunt/state.yue:761
              end -- shunt/state.yue:761
              return _tab_0 -- shunt/state.yue:761
            end)() -- shunt/state.yue:761
          }, -- shunt/state.yue:761
          { -- shunt/state.yue:761
            prev_state = (function() -- shunt/state.yue:761
              local _tab_0 = { -- shunt/state.yue:761
                name = 'state_2' -- shunt/state.yue:761
              } -- shunt/state.yue:761
              local _idx_0 = 1 -- shunt/state.yue:761
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:761
                if _idx_0 == _key_0 then -- shunt/state.yue:761
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:761
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:761
                else -- shunt/state.yue:761
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:761
                end -- shunt/state.yue:761
              end -- shunt/state.yue:761
              return _tab_0 -- shunt/state.yue:761
            end)(), -- shunt/state.yue:761
            state = { -- shunt/state.yue:761
              name = 'state_1' -- shunt/state.yue:761
            } -- shunt/state.yue:761
          }, -- shunt/state.yue:761
          { -- shunt/state.yue:761
            prev_state = { -- shunt/state.yue:761
              name = 'state_1' -- shunt/state.yue:761
            }, -- shunt/state.yue:761
            state = (function() -- shunt/state.yue:761
              local _tab_0 = { -- shunt/state.yue:761
                name = 'state_2' -- shunt/state.yue:761
              } -- shunt/state.yue:761
              local _idx_0 = 1 -- shunt/state.yue:761
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:761
                if _idx_0 == _key_0 then -- shunt/state.yue:761
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:761
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:761
                else -- shunt/state.yue:761
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:761
                end -- shunt/state.yue:761
              end -- shunt/state.yue:761
              return _tab_0 -- shunt/state.yue:761
            end)() -- shunt/state.yue:761
          }, -- shunt/state.yue:761
          { -- shunt/state.yue:761
            prev_state = (function() -- shunt/state.yue:761
              local _tab_0 = { -- shunt/state.yue:761
                name = 'state_2' -- shunt/state.yue:761
              } -- shunt/state.yue:761
              local _idx_0 = 1 -- shunt/state.yue:761
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:761
                if _idx_0 == _key_0 then -- shunt/state.yue:761
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:761
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:761
                else -- shunt/state.yue:761
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:761
                end -- shunt/state.yue:761
              end -- shunt/state.yue:761
              return _tab_0 -- shunt/state.yue:761
            end)(), -- shunt/state.yue:761
            state = { -- shunt/state.yue:761
              name = 'state_1' -- shunt/state.yue:761
            } -- shunt/state.yue:761
          }, -- shunt/state.yue:761
          { -- shunt/state.yue:761
            prev_state = { -- shunt/state.yue:761
              name = 'state_1' -- shunt/state.yue:761
            }, -- shunt/state.yue:761
            state = (function() -- shunt/state.yue:761
              local _tab_0 = { -- shunt/state.yue:761
                name = 'state_2' -- shunt/state.yue:761
              } -- shunt/state.yue:761
              local _idx_0 = 1 -- shunt/state.yue:761
              for _key_0, _value_0 in pairs(data) do -- shunt/state.yue:761
                if _idx_0 == _key_0 then -- shunt/state.yue:761
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/state.yue:761
                  _idx_0 = _idx_0 + 1 -- shunt/state.yue:761
                else -- shunt/state.yue:761
                  _tab_0[_key_0] = _value_0 -- shunt/state.yue:761
                end -- shunt/state.yue:761
              end -- shunt/state.yue:761
              return _tab_0 -- shunt/state.yue:761
            end)() -- shunt/state.yue:761
          } -- shunt/state.yue:761
        })), tostring("shunt/state.yue") .. ":" .. tostring(761)) -- shunt/state.yue:771
      end) -- shunt/state.yue:771
    end) -- shunt/state.yue:728
    describe('\\set_state_invariant', function() -- shunt/state.yue:773
      it('accepts valid states', function() -- shunt/state.yue:774
        local invariant_called_with = { } -- shunt/state.yue:775
        local test_sm = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):set_state_invariant(function(state) -- shunt/state.yue:778
          require('shunt.spec')._assert_that([=[state.name]=], state.name, (matches('^state_%d$')), tostring("shunt/state.yue") .. ":" .. tostring(779)) -- shunt/state.yue:779
          invariant_called_with[#invariant_called_with + 1] = state.name -- shunt/state.yue:780
        end):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state()):build() -- shunt/state.yue:776
        test_sm["goto"](test_sm, 'state_2') -- shunt/state.yue:786
        test_sm["end"](test_sm); -- shunt/state.yue:787
        return require('shunt.spec')._expect_that([=[invariant_called_with]=], invariant_called_with, (deep_eq({ -- shunt/state.yue:788
          'state_1', -- shunt/state.yue:788
          'state_2', -- shunt/state.yue:788
          'state_2' -- shunt/state.yue:788
        })), tostring("shunt/state.yue") .. ":" .. tostring(788)) -- shunt/state.yue:791
      end) -- shunt/state.yue:774
      return it('rejects invalid states', function() -- shunt/state.yue:793
        local invariant_called_with = { } -- shunt/state.yue:794
        local test_sm_builder = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):set_state_invariant(function(state) -- shunt/state.yue:797
          return error('canary') -- shunt/state.yue:798
        end):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state()); -- shunt/state.yue:795
        return require('shunt.spec')._expect_that([=[test_sm_builder\build]=], (function() -- shunt/state.yue:803
          local _base_0 = test_sm_builder -- shunt/state.yue:803
          local _fn_0 = _base_0.build -- shunt/state.yue:803
          return _fn_0 and function(...) -- shunt/state.yue:803
            return _fn_0(_base_0, ...) -- shunt/state.yue:803
          end -- shunt/state.yue:803
        end)(), (errors(matches('canary'))), tostring("shunt/state.yue") .. ":" .. tostring(803)) -- shunt/state.yue:803
      end) -- shunt/state.yue:803
    end) -- shunt/state.yue:773
    describe('\\set_transition_invariant', function() -- shunt/state.yue:805
      it('accepts valid transitions', function() -- shunt/state.yue:806
        local test_sm = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):set_transition_invariant(function(prev_state, state) -- shunt/state.yue:809
          require('shunt.spec')._expect_that([=[prev_state]=], prev_state, (has_fields({ -- shunt/state.yue:810
            name = eq('state_1') -- shunt/state.yue:810
          })), tostring("shunt/state.yue") .. ":" .. tostring(810)); -- shunt/state.yue:810
          return require('shunt.spec')._expect_that([=[state]=], state, (has_fields({ -- shunt/state.yue:812
            name = eq('state_2') -- shunt/state.yue:812
          })), tostring("shunt/state.yue") .. ":" .. tostring(812)) -- shunt/state.yue:813
        end):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):declare_end_state()):build() -- shunt/state.yue:807
        test_sm["goto"](test_sm, 'state_2'); -- shunt/state.yue:819
        return require('shunt.spec')._expect_that([=[test_sm.state.name]=], test_sm.state.name, (eq('state_2')), tostring("shunt/state.yue") .. ":" .. tostring(820)) -- shunt/state.yue:820
      end) -- shunt/state.yue:806
      return it('rejects invalid transitions', function() -- shunt/state.yue:822
        local test_sm = (StateMachineBuilder('test_sm')):set_initial_state('state_1'):set_transition_invariant(function(prev_state, state) -- shunt/state.yue:825
          local prev_counter = prev_state.counter -- shunt/state.yue:826
          local counter = state.counter -- shunt/state.yue:827
          if (prev_counter ~= nil) and (counter ~= nil) then -- shunt/state.yue:828
            if not (prev_counter <= counter) then -- shunt/state.yue:829
              local label = 'label' -- shunt/state.yue:829
              return error("invariant invalidated: prev_counter <= counter (" .. tostring(label) .. ")") -- shunt/state.yue:829
            end -- shunt/state.yue:829
          end -- shunt/state.yue:828
        end):add((State('state_1')):add_transition_to('state_2')):add((State('state_2')):set_data_type([[{
              counter: number,
            }]]):add_transition_to('state_3')):add((State('state_3')):declare_end_state():set_data_type([[{
              counter: number,
            }]])):build() -- shunt/state.yue:823
        test_sm["goto"](test_sm, 'state_2', { -- shunt/state.yue:844
          counter = 1 -- shunt/state.yue:844
        }); -- shunt/state.yue:843
        return require('shunt.spec')._expect_that([=[(-> test_sm\goto 'state_3', counter: -1)]=], (function() -- shunt/state.yue:845
          return test_sm["goto"](test_sm, 'state_3', { -- shunt/state.yue:845
            counter = -1 -- shunt/state.yue:845
          }) -- shunt/state.yue:845
        end), (errors(matches('invariant invalidated: prev_counter <= counter %(label%)'))), tostring("shunt/state.yue") .. ":" .. tostring(845)) -- shunt/state.yue:846
      end) -- shunt/state.yue:846
    end) -- shunt/state.yue:805
    return describe('.states', function() -- shunt/state.yue:848
      it('contains all states', function() -- shunt/state.yue:849
        local test_sm = make_test_sm() -- shunt/state.yue:850
        local expected_states = { -- shunt/state.yue:852
          'state_1', -- shunt/state.yue:852
          'state_2', -- shunt/state.yue:853
          'state_3' -- shunt/state.yue:854
        } -- shunt/state.yue:851
        for _index_0 = 1, #expected_states do -- shunt/state.yue:855
          local expected_state = expected_states[_index_0] -- shunt/state.yue:855
          require('shunt.spec')._expect_that([=[test_sm.states[expected_state]]=], test_sm.states[expected_state], (eq(expected_state)), tostring("shunt/state.yue") .. ":" .. tostring(856)) -- shunt/state.yue:856
        end -- shunt/state.yue:856
      end) -- shunt/state.yue:849
      it('rejects unknown states', function() -- shunt/state.yue:858
        local test_sm = make_test_sm(); -- shunt/state.yue:859
        return require('shunt.spec')._expect_that([=[(-> test_sm.states.unknown)]=], (function() -- shunt/state.yue:860
          return test_sm.states.unknown -- shunt/state.yue:860
        end), (errors(matches("cannot get state 'unknown': no such state"))), tostring("shunt/state.yue") .. ":" .. tostring(860)) -- shunt/state.yue:860
      end) -- shunt/state.yue:858
      return it('rejects modifications', function() -- shunt/state.yue:862
        local test_sm = make_test_sm(); -- shunt/state.yue:863
        return require('shunt.spec')._expect_that([==[(-> test_sm.states.state_1 = nil)]==], (function() -- shunt/state.yue:864
          test_sm.states.state_1 = nil -- shunt/state.yue:864
        end), (errors(matches('cannot set fields in states'))), tostring("shunt/state.yue") .. ":" .. tostring(864)) -- shunt/state.yue:864
      end) -- shunt/state.yue:864
    end) -- shunt/state.yue:864
  end) -- shunt/state.yue:602
  return describe('StateResponsesBuilder', function() -- shunt/state.yue:866
    it('builds response', function() -- shunt/state.yue:867
      local calls = { } -- shunt/state.yue:868
      local builder -- shunt/state.yue:869
      do -- shunt/state.yue:869
        local _with_0 = StateResponsesBuilder(make_test_sm()) -- shunt/state.yue:869
        local _list_0 = { -- shunt/state.yue:870
          'state_1', -- shunt/state.yue:870
          'state_2', -- shunt/state.yue:870
          'state_3' -- shunt/state.yue:870
        } -- shunt/state.yue:870
        for _index_0 = 1, #_list_0 do -- shunt/state.yue:870
          local name = _list_0[_index_0] -- shunt/state.yue:870
          _with_0:add(name, F('() -> <>', function() -- shunt/state.yue:871
            calls[#calls + 1] = { -- shunt/state.yue:872
              name = name -- shunt/state.yue:872
            } -- shunt/state.yue:872
          end)) -- shunt/state.yue:871
        end -- shunt/state.yue:872
        builder = _with_0 -- shunt/state.yue:869
      end -- shunt/state.yue:869
      local responses = builder:build() -- shunt/state.yue:874
      responses.state_1() -- shunt/state.yue:875
      responses.state_2() -- shunt/state.yue:876
      responses.state_3(); -- shunt/state.yue:877
      require('shunt.spec')._expect_that([=[calls]=], calls, (len(eq(3))), tostring("shunt/state.yue") .. ":" .. tostring(878)); -- shunt/state.yue:878
      require('shunt.spec')._expect_that([=[calls[1]]=], calls[1], (has_fields({ -- shunt/state.yue:879
        name = eq('state_1') -- shunt/state.yue:879
      })), tostring("shunt/state.yue") .. ":" .. tostring(879)); -- shunt/state.yue:879
      require('shunt.spec')._expect_that([=[calls[2]]=], calls[2], (has_fields({ -- shunt/state.yue:881
        name = eq('state_2') -- shunt/state.yue:881
      })), tostring("shunt/state.yue") .. ":" .. tostring(881)); -- shunt/state.yue:881
      return require('shunt.spec')._expect_that([=[calls[3]]=], calls[3], (has_fields({ -- shunt/state.yue:883
        name = eq('state_3') -- shunt/state.yue:883
      })), tostring("shunt/state.yue") .. ":" .. tostring(883)) -- shunt/state.yue:884
    end) -- shunt/state.yue:867
    it('rejects unknown states', function() -- shunt/state.yue:886
      local _with_0 = StateResponsesBuilder(make_test_sm()) -- shunt/state.yue:887
      require('shunt.spec')._expect_that([=[(-> \add 'fribib', ->)]=], (function() -- shunt/state.yue:888
        return _with_0:add('fribib', function() end) -- shunt/state.yue:888
      end), (errors(matches("no such state"))), tostring("shunt/state.yue") .. ":" .. tostring(888)) -- shunt/state.yue:888
      return _with_0 -- shunt/state.yue:887
    end) -- shunt/state.yue:886
    it('rejects redefinition', function() -- shunt/state.yue:890
      local _with_0 = StateResponsesBuilder(make_test_sm()) -- shunt/state.yue:891
      _with_0:add('state_1', function() end); -- shunt/state.yue:892
      require('shunt.spec')._expect_that([=[(-> \add 'state_1', ->)]=], (function() -- shunt/state.yue:893
        return _with_0:add('state_1', function() end) -- shunt/state.yue:893
      end), (errors(matches("response for 'state_1' already defined"))), tostring("shunt/state.yue") .. ":" .. tostring(893)) -- shunt/state.yue:893
      return _with_0 -- shunt/state.yue:891
    end) -- shunt/state.yue:890
    return it('rejects incomplete coverage', function() -- shunt/state.yue:895
      local _with_0 = StateResponsesBuilder(make_test_sm()) -- shunt/state.yue:896
      require('shunt.spec')._expect_that([=[\build]=], (function() -- shunt/state.yue:897
        local _base_0 = _with_0 -- shunt/state.yue:897
        local _fn_0 = _base_0.build -- shunt/state.yue:897
        return _fn_0 and function(...) -- shunt/state.yue:897
          return _fn_0(_base_0, ...) -- shunt/state.yue:897
        end -- shunt/state.yue:897
      end)(), (errors(matches('no response: state_1, state_2, state_3'))), tostring("shunt/state.yue") .. ":" .. tostring(897)) -- shunt/state.yue:897
      return _with_0 -- shunt/state.yue:896
    end) -- shunt/state.yue:897
  end) -- shunt/state.yue:897
end) -- shunt/state.yue:384
return _module_0 -- shunt/state.yue:897
end
package.preload['shunt.nodes.marshal.main'] = function(...)
-- [yue]: shunt/nodes/marshal/main.yue
local _module_0 = { } -- shunt/nodes/marshal/main.yue:1
local default_config, main, STEP_INTERVAL, RoundRobin -- shunt/nodes/marshal/main.yue:1
local MinecraftClock = require('shunt.clock').MinecraftClock -- shunt/nodes/marshal/main.yue:0
local DeclareTrainState, DeclareTrainStateResponse -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.cmd.declare') -- shunt/nodes/marshal/main.yue:0
  DeclareTrainState, DeclareTrainStateResponse = _obj_0.DeclareTrainState, _obj_0.DeclareTrainStateResponse -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local HOST = require('shunt.compat').HOST -- shunt/nodes/marshal/main.yue:0
local ConfigListener = require('shunt.configurator.listener').ConfigListener -- shunt/nodes/marshal/main.yue:0
local GetConfigResponse, MarshalIdentityRequest, MarshalIdentityResponse, SetConfigResponse -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.configurator.main') -- shunt/nodes/marshal/main.yue:0
  GetConfigResponse, MarshalIdentityRequest, MarshalIdentityResponse, SetConfigResponse = _obj_0.GetConfigResponse, _obj_0.MarshalIdentityRequest, _obj_0.MarshalIdentityResponse, _obj_0.SetConfigResponse -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local Queue = require('shunt.data.queue').Queue -- shunt/nodes/marshal/main.yue:0
local Firewall = require('shunt.firewall').Firewall -- shunt/nodes/marshal/main.yue:0
local log, trace -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/nodes/marshal/main.yue:0
  log, trace = _obj_0.log, _obj_0.trace -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local FactoryHeartbeat = require('shunt.nodes.factory.main').FactoryHeartbeat -- shunt/nodes/marshal/main.yue:0
local ResourceOrchestrator = require('shunt.nodes.marshal.resource_orchestrator.main').ResourceOrchestrator -- shunt/nodes/marshal/main.yue:0
local PromiseTracker = require('shunt.nodes.marshal.resource_orchestrator.promise_tracker').PromiseTracker -- shunt/nodes/marshal/main.yue:0
local Scheduler = require('shunt.nodes.marshal.resource_orchestrator.scheduler').Scheduler -- shunt/nodes/marshal/main.yue:0
local PseudoRandom = require('shunt.nodes.marshal.util.pseudo_random').PseudoRandom -- shunt/nodes/marshal/main.yue:0
local Pc = require('shunt.pc').Pc -- shunt/nodes/marshal/main.yue:0
local IdempotenceToken, Packet, TestUplinkBackend, TIMEOUT, Uplink -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/nodes/marshal/main.yue:0
  IdempotenceToken, Packet, TestUplinkBackend, TIMEOUT, Uplink = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.TestUplinkBackend, _obj_0.TIMEOUT, _obj_0.Uplink -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local declare_type, F, is, T -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/marshal/main.yue:0
  declare_type, F, is, T = _obj_0.declare_type, _obj_0.F, _obj_0.is, _obj_0.T -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local running_tests, spec -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.spec') -- shunt/nodes/marshal/main.yue:0
  running_tests, spec = _obj_0.running_tests, _obj_0.spec -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder -- shunt/nodes/marshal/main.yue:0
do -- shunt/nodes/marshal/main.yue:0
  local _obj_0 = require('shunt.state') -- shunt/nodes/marshal/main.yue:0
  shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder = _obj_0.shallow_log_reporter, _obj_0.State, _obj_0.StateMachineBuilder, _obj_0.StateResponsesBuilder -- shunt/nodes/marshal/main.yue:0
end -- shunt/nodes/marshal/main.yue:0
local UpgradeListener = require('shunt.upgrade.listener').UpgradeListener -- shunt/nodes/marshal/main.yue:0
local toml = require('shunt.toml') -- shunt/nodes/marshal/main.yue:25
default_config = function() -- shunt/nodes/marshal/main.yue:27
  return [=[[marshal]
resend_cooldown_seconds = 60
]=] -- shunt/nodes/marshal/main.yue:30
end -- shunt/nodes/marshal/main.yue:27
_module_0["default_config"] = default_config -- shunt/nodes/marshal/main.yue:30
main = F('(MarshalConfig) -> <>', function(config) -- shunt/nodes/marshal/main.yue:32
  log(function() -- shunt/nodes/marshal/main.yue:33
    return 'starting marshal' -- shunt/nodes/marshal/main.yue:33
  end) -- shunt/nodes/marshal/main.yue:33
  local state = nil -- shunt/nodes/marshal/main.yue:35
  do -- shunt/nodes/marshal/main.yue:36
    local _with_0 = io.open('.shunt-state.toml') -- shunt/nodes/marshal/main.yue:36
    if _with_0 ~= nil then -- shunt/nodes/marshal/main.yue:36
      local err -- shunt/nodes/marshal/main.yue:37
      state, err = toml.decode(assert(_with_0:read('*a'))) -- shunt/nodes/marshal/main.yue:37
      assert(_with_0:close()) -- shunt/nodes/marshal/main.yue:38
      if (err ~= nil) then -- shunt/nodes/marshal/main.yue:39
        print(err) -- shunt/nodes/marshal/main.yue:40
        return -- shunt/nodes/marshal/main.yue:41
      end -- shunt/nodes/marshal/main.yue:39
    end -- shunt/nodes/marshal/main.yue:36
  end -- shunt/nodes/marshal/main.yue:36
  local pc = Pc() -- shunt/nodes/marshal/main.yue:43
  local uplink = Uplink() -- shunt/nodes/marshal/main.yue:44
  local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:45
    config = config, -- shunt/nodes/marshal/main.yue:45
    pc = pc, -- shunt/nodes/marshal/main.yue:45
    uplink = uplink -- shunt/nodes/marshal/main.yue:45
  }) -- shunt/nodes/marshal/main.yue:45
  _with_0:load() -- shunt/nodes/marshal/main.yue:46
  _with_0:run() -- shunt/nodes/marshal/main.yue:47
  return _with_0 -- shunt/nodes/marshal/main.yue:45
end) -- shunt/nodes/marshal/main.yue:32
_module_0["main"] = main -- shunt/nodes/marshal/main.yue:47
STEP_INTERVAL = 60 -- shunt/nodes/marshal/main.yue:49
declare_type('Network', [[{
  name: string,
  factories: [Factory],
}]]) -- shunt/nodes/marshal/main.yue:51
declare_type('Factory', [[{
  -- Constant
  name: string,
  pc_id: number,
  -- Variable
  last_seen_epoch: number,
  stations: DetectedStations,
  stockpile: DetectedStockpile,
}]]) -- shunt/nodes/marshal/main.yue:55
declare_type('TrainStatus', [[{
  -- Constant:
  name: string,
  -- Variable:
  last_seen_epoch: number,
  last_seen_at_factory: string,
  last_seen_at_station: string,
}]]) -- shunt/nodes/marshal/main.yue:64
declare_type('MarshalConfig', [[{
  marshal: {
    resend_cooldown_seconds: ?number,
  },
}]]) -- shunt/nodes/marshal/main.yue:73
declare_type('MarshalEvent', [[{
  type: "network-packet",
  packet: Packet,
} | {
  type: "new-epoch",
  new_epoch: number,
} | {
  type: "new-config",
  config: MarshalConfig,
}]]) -- shunt/nodes/marshal/main.yue:78
declare_type('StationAddress', [[{
  factory: Factory,
  station: StationConfig,
}]]) -- shunt/nodes/marshal/main.yue:88
declare_type('DeliveryOptionSet', [[{
  inbound_station: StationAddress,
  outbound_stations: [StationAddress],
  trains: [AvailableTrain],
}]]) -- shunt/nodes/marshal/main.yue:92
declare_type('DeliveryOption', [[{
  inbound_station: string,
  outbound_station: string,
  train: AvailableTrain,
}]]) -- shunt/nodes/marshal/main.yue:97
declare_type('AvailableTrain', [[{
  at_factory: {
    name: string,
    pc_id: number,
  },
  at_station: {
    name: string,
  },
  name: string,
}]]) -- shunt/nodes/marshal/main.yue:102
declare_type('MarshalSnapshot', [[{
  version: number,
  epoch: number,
  promise_tracker_snapshot: PromiseTrackerSnapshot,
}]]) -- shunt/nodes/marshal/main.yue:112
declare_type('MarshalOpts', [[{
  config: MarshalConfig+StoredConfig,
  pc: Pc,
  uplink: Uplink,
  rand: ?Random,
  clock: ?Clock,
}]]) -- shunt/nodes/marshal/main.yue:117
local Marshal -- shunt/nodes/marshal/main.yue:124
do -- shunt/nodes/marshal/main.yue:124
  local _class_0 -- shunt/nodes/marshal/main.yue:124
  local _base_0 = { -- shunt/nodes/marshal/main.yue:124
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/nodes/marshal/main.yue:242
      return (StateResponsesBuilder(sm)):add('waiting', (function() -- shunt/nodes/marshal/main.yue:244
        local _base_1 = self -- shunt/nodes/marshal/main.yue:244
        local _fn_0 = _base_1.on_waiting -- shunt/nodes/marshal/main.yue:244
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:244
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:244
        end -- shunt/nodes/marshal/main.yue:244
      end)()):add('inspecting_packet', (function() -- shunt/nodes/marshal/main.yue:245
        local _base_1 = self -- shunt/nodes/marshal/main.yue:245
        local _fn_0 = _base_1.on_inspecting_packet -- shunt/nodes/marshal/main.yue:245
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:245
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:245
        end -- shunt/nodes/marshal/main.yue:245
      end)()):add('analysing_marshal_identity_request', (function() -- shunt/nodes/marshal/main.yue:246
        local _base_1 = self -- shunt/nodes/marshal/main.yue:246
        local _fn_0 = _base_1.on_analysing_marshal_identity_request -- shunt/nodes/marshal/main.yue:246
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:246
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:246
        end -- shunt/nodes/marshal/main.yue:246
      end)()):add('sending_marshal_identity_response', (function() -- shunt/nodes/marshal/main.yue:247
        local _base_1 = self -- shunt/nodes/marshal/main.yue:247
        local _fn_0 = _base_1.on_sending_marshal_identity_response -- shunt/nodes/marshal/main.yue:247
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:247
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:247
        end -- shunt/nodes/marshal/main.yue:247
      end)()):add('analysing_declare_train_state', (function() -- shunt/nodes/marshal/main.yue:248
        local _base_1 = self -- shunt/nodes/marshal/main.yue:248
        local _fn_0 = _base_1.on_analysing_declare_train_state -- shunt/nodes/marshal/main.yue:248
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:248
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:248
        end -- shunt/nodes/marshal/main.yue:248
      end)()):add('enqueueing_declare_train_state', (function() -- shunt/nodes/marshal/main.yue:249
        local _base_1 = self -- shunt/nodes/marshal/main.yue:249
        local _fn_0 = _base_1.on_enqueueing_declare_train_state -- shunt/nodes/marshal/main.yue:249
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:249
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:249
        end -- shunt/nodes/marshal/main.yue:249
      end)()):add('sending_declare_train_state_response', (function() -- shunt/nodes/marshal/main.yue:250
        local _base_1 = self -- shunt/nodes/marshal/main.yue:250
        local _fn_0 = _base_1.on_sending_declare_train_state_response -- shunt/nodes/marshal/main.yue:250
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:250
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:250
        end -- shunt/nodes/marshal/main.yue:250
      end)()):add('changing_epoch', (function() -- shunt/nodes/marshal/main.yue:251
        local _base_1 = self -- shunt/nodes/marshal/main.yue:251
        local _fn_0 = _base_1.on_changing_epoch -- shunt/nodes/marshal/main.yue:251
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:251
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:251
        end -- shunt/nodes/marshal/main.yue:251
      end)()):add('applying_config', (function() -- shunt/nodes/marshal/main.yue:252
        local _base_1 = self -- shunt/nodes/marshal/main.yue:252
        local _fn_0 = _base_1.on_applying_config -- shunt/nodes/marshal/main.yue:252
        return _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:252
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:252
        end -- shunt/nodes/marshal/main.yue:252
      end)()):build() -- shunt/nodes/marshal/main.yue:253
    end), -- shunt/nodes/marshal/main.yue:255
    step = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:255
      self.sm_responses[self.sm.state.name]() -- shunt/nodes/marshal/main.yue:256
      local _list_0 = self.child_components -- shunt/nodes/marshal/main.yue:257
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:257
        local child_component = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:257
        child_component:step() -- shunt/nodes/marshal/main.yue:258
      end -- shunt/nodes/marshal/main.yue:258
    end), -- shunt/nodes/marshal/main.yue:260
    on_waiting = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:260
      local event = self.events:dequeue() -- shunt/nodes/marshal/main.yue:261
      if not (event ~= nil) then -- shunt/nodes/marshal/main.yue:262
        return -- shunt/nodes/marshal/main.yue:263
      end -- shunt/nodes/marshal/main.yue:262
      local _exp_0 = event.type -- shunt/nodes/marshal/main.yue:264
      if 'network-packet' == _exp_0 then -- shunt/nodes/marshal/main.yue:265
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:266
        return _call_0["goto"](_call_0, 'inspecting_packet', { -- shunt/nodes/marshal/main.yue:267
          packet = event.packet -- shunt/nodes/marshal/main.yue:267
        }) -- shunt/nodes/marshal/main.yue:266
      elseif 'new-epoch' == _exp_0 then -- shunt/nodes/marshal/main.yue:268
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:269
        return _call_0["goto"](_call_0, 'changing_epoch', { -- shunt/nodes/marshal/main.yue:270
          new_epoch = event.new_epoch -- shunt/nodes/marshal/main.yue:270
        }) -- shunt/nodes/marshal/main.yue:269
      elseif 'new-config' == _exp_0 then -- shunt/nodes/marshal/main.yue:271
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:272
        return _call_0["goto"](_call_0, 'applying_config', { -- shunt/nodes/marshal/main.yue:273
          config = event.config -- shunt/nodes/marshal/main.yue:273
        }) -- shunt/nodes/marshal/main.yue:272
      else -- shunt/nodes/marshal/main.yue:275
        return error("internal error: unrecognised event type '" .. tostring(event.type) .. "'") -- shunt/nodes/marshal/main.yue:275
      end -- shunt/nodes/marshal/main.yue:275
    end), -- shunt/nodes/marshal/main.yue:277
    on_inspecting_packet = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:277
      local packet = self.sm.state.packet -- shunt/nodes/marshal/main.yue:278
      local forwarded = false -- shunt/nodes/marshal/main.yue:280
      local _list_0 = self.child_components -- shunt/nodes/marshal/main.yue:281
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:281
        local child_component = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:281
        if child_component.firewall:permits(packet) then -- shunt/nodes/marshal/main.yue:282
          forwarded = true -- shunt/nodes/marshal/main.yue:283
          child_component.events:enqueue({ -- shunt/nodes/marshal/main.yue:285
            type = 'network-packet', -- shunt/nodes/marshal/main.yue:285
            packet = packet -- shunt/nodes/marshal/main.yue:286
          }) -- shunt/nodes/marshal/main.yue:284
        end -- shunt/nodes/marshal/main.yue:282
      end -- shunt/nodes/marshal/main.yue:286
      local _exp_0 = packet.protocol -- shunt/nodes/marshal/main.yue:288
      if 'MarshalIdentityRequest' == _exp_0 then -- shunt/nodes/marshal/main.yue:289
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:290
        return _call_0["goto"](_call_0, 'analysing_marshal_identity_request', { -- shunt/nodes/marshal/main.yue:291
          packet = packet -- shunt/nodes/marshal/main.yue:291
        }) -- shunt/nodes/marshal/main.yue:290
      elseif 'DeclareTrainState' == _exp_0 then -- shunt/nodes/marshal/main.yue:292
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:293
        return _call_0["goto"](_call_0, 'analysing_declare_train_state', { -- shunt/nodes/marshal/main.yue:294
          packet = packet -- shunt/nodes/marshal/main.yue:294
        }) -- shunt/nodes/marshal/main.yue:293
      else -- shunt/nodes/marshal/main.yue:296
        if not forwarded then -- shunt/nodes/marshal/main.yue:296
          local repr = require('shunt.spec').repr -- shunt/nodes/marshal/main.yue:0
          error("internal error: unhandled packet admitted through firewall: " .. tostring(repr(protocol))) -- shunt/nodes/marshal/main.yue:298
        end -- shunt/nodes/marshal/main.yue:296
        local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:299
        return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/main.yue:299
      end -- shunt/nodes/marshal/main.yue:299
    end), -- shunt/nodes/marshal/main.yue:301
    on_analysing_marshal_identity_request = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:301
      local idemp_tok, pc_id, name -- shunt/nodes/marshal/main.yue:302
      do -- shunt/nodes/marshal/main.yue:302
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/main.yue:307
        idemp_tok, pc_id, name = _obj_0.packet.idemp_tok, _obj_0.packet.pc_id, _obj_0.packet.name -- shunt/nodes/marshal/main.yue:302
      end -- shunt/nodes/marshal/main.yue:307
      local resp -- shunt/nodes/marshal/main.yue:309
      if not (name ~= nil) then -- shunt/nodes/marshal/main.yue:310
        resp = self.pc:id() -- shunt/nodes/marshal/main.yue:311
      else -- shunt/nodes/marshal/main.yue:312
        do -- shunt/nodes/marshal/main.yue:312
          local id -- shunt/nodes/marshal/main.yue:312
          do -- shunt/nodes/marshal/main.yue:312
            local _obj_0 = (self.resource_orchestrator:factory(name)) -- shunt/nodes/marshal/main.yue:312
            if _obj_0 ~= nil then -- shunt/nodes/marshal/main.yue:312
              id = _obj_0.pc_id -- shunt/nodes/marshal/main.yue:312
            end -- shunt/nodes/marshal/main.yue:312
          end -- shunt/nodes/marshal/main.yue:312
          if id then -- shunt/nodes/marshal/main.yue:312
            resp = id -- shunt/nodes/marshal/main.yue:313
          else -- shunt/nodes/marshal/main.yue:315
            resp = "no known factory '" .. tostring(name) .. "'" -- shunt/nodes/marshal/main.yue:315
          end -- shunt/nodes/marshal/main.yue:312
        end -- shunt/nodes/marshal/main.yue:312
      end -- shunt/nodes/marshal/main.yue:310
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:317
      return _call_0["goto"](_call_0, 'sending_marshal_identity_response', { -- shunt/nodes/marshal/main.yue:318
        idemp_tok = idemp_tok, -- shunt/nodes/marshal/main.yue:318
        recipient_id = pc_id, -- shunt/nodes/marshal/main.yue:319
        resp = resp -- shunt/nodes/marshal/main.yue:320
      }) -- shunt/nodes/marshal/main.yue:317
    end), -- shunt/nodes/marshal/main.yue:322
    on_sending_marshal_identity_response = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:322
      local idemp_tok, recipient_id, resp -- shunt/nodes/marshal/main.yue:323
      do -- shunt/nodes/marshal/main.yue:323
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/main.yue:327
        idemp_tok, recipient_id, resp = _obj_0.idemp_tok, _obj_0.recipient_id, _obj_0.resp -- shunt/nodes/marshal/main.yue:323
      end -- shunt/nodes/marshal/main.yue:327
      self.uplink:send_to(recipient_id, MarshalIdentityResponse(idemp_tok, resp)) -- shunt/nodes/marshal/main.yue:328
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:329
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/main.yue:329
    end), -- shunt/nodes/marshal/main.yue:331
    on_analysing_declare_train_state = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:331
      local idemp_tok, pc_id, train_name, state -- shunt/nodes/marshal/main.yue:332
      do -- shunt/nodes/marshal/main.yue:332
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/main.yue:338
        idemp_tok, pc_id, train_name, state = _obj_0.packet.idemp_tok, _obj_0.packet.pc_id, _obj_0.packet.train_name, _obj_0.packet.state -- shunt/nodes/marshal/main.yue:332
      end -- shunt/nodes/marshal/main.yue:338
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:339
      return _call_0["goto"](_call_0, 'enqueueing_declare_train_state', { -- shunt/nodes/marshal/main.yue:340
        idemp_tok = idemp_tok, -- shunt/nodes/marshal/main.yue:340
        pc_id = pc_id, -- shunt/nodes/marshal/main.yue:341
        train_name = train_name, -- shunt/nodes/marshal/main.yue:342
        state = state -- shunt/nodes/marshal/main.yue:343
      }) -- shunt/nodes/marshal/main.yue:339
    end), -- shunt/nodes/marshal/main.yue:345
    on_enqueueing_declare_train_state = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:345
      local idemp_tok, pc_id, train_name, state -- shunt/nodes/marshal/main.yue:346
      do -- shunt/nodes/marshal/main.yue:346
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/main.yue:351
        idemp_tok, pc_id, train_name, state = _obj_0.idemp_tok, _obj_0.pc_id, _obj_0.train_name, _obj_0.state -- shunt/nodes/marshal/main.yue:346
      end -- shunt/nodes/marshal/main.yue:351
      local error_reason = nil -- shunt/nodes/marshal/main.yue:353
      if state == 'cleared' then -- shunt/nodes/marshal/main.yue:354
        if self.resource_orchestrator:train_is_known(train_name) then -- shunt/nodes/marshal/main.yue:355
          error_reason = 'train unknown' -- shunt/nodes/marshal/main.yue:356
        else -- shunt/nodes/marshal/main.yue:357
          if not self.scheduler:train_is_lost(train_name) then -- shunt/nodes/marshal/main.yue:357
            error_reason = 'train was not lost' -- shunt/nodes/marshal/main.yue:358
          end -- shunt/nodes/marshal/main.yue:357
        end -- shunt/nodes/marshal/main.yue:355
      end -- shunt/nodes/marshal/main.yue:354
      self.scheduler.events:enqueue({ -- shunt/nodes/marshal/main.yue:361
        type = 'declare-train-state', -- shunt/nodes/marshal/main.yue:361
        train_name = train_name, -- shunt/nodes/marshal/main.yue:362
        state = state -- shunt/nodes/marshal/main.yue:363
      }) -- shunt/nodes/marshal/main.yue:360
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:365
      return _call_0["goto"](_call_0, 'sending_declare_train_state_response', { -- shunt/nodes/marshal/main.yue:366
        idemp_tok = idemp_tok, -- shunt/nodes/marshal/main.yue:366
        recipient_id = pc_id, -- shunt/nodes/marshal/main.yue:367
        error_reason = error_reason -- shunt/nodes/marshal/main.yue:368
      }) -- shunt/nodes/marshal/main.yue:365
    end), -- shunt/nodes/marshal/main.yue:370
    on_sending_declare_train_state_response = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:370
      local idemp_tok, recipient_id, error_reason -- shunt/nodes/marshal/main.yue:371
      do -- shunt/nodes/marshal/main.yue:371
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/main.yue:375
        idemp_tok, recipient_id, error_reason = _obj_0.idemp_tok, _obj_0.recipient_id, _obj_0.error_reason -- shunt/nodes/marshal/main.yue:371
      end -- shunt/nodes/marshal/main.yue:375
      self.uplink:send_to(recipient_id, DeclareTrainStateResponse(idemp_tok, error_reason)) -- shunt/nodes/marshal/main.yue:376
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:377
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/main.yue:377
    end), -- shunt/nodes/marshal/main.yue:379
    on_changing_epoch = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:379
      local new_epoch = self.sm.state.new_epoch -- shunt/nodes/marshal/main.yue:380
      self.resource_orchestrator.events:enqueue({ -- shunt/nodes/marshal/main.yue:382
        type = 'new-epoch', -- shunt/nodes/marshal/main.yue:382
        new_epoch = new_epoch -- shunt/nodes/marshal/main.yue:383
      }) -- shunt/nodes/marshal/main.yue:381
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:384
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/main.yue:384
    end), -- shunt/nodes/marshal/main.yue:386
    on_applying_config = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:386
      local config = self.sm.state.config -- shunt/nodes/marshal/main.yue:387
      self.config = config -- shunt/nodes/marshal/main.yue:388
      local _call_0 = self.sm -- shunt/nodes/marshal/main.yue:389
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/main.yue:389
    end), -- shunt/nodes/marshal/main.yue:391
    run = F('() => !', function(self) -- shunt/nodes/marshal/main.yue:391
      return parallel.waitForAny(table.unpack(self:tasks())) -- shunt/nodes/marshal/main.yue:392
    end), -- shunt/nodes/marshal/main.yue:394
    tasks = F('() => [() -> !]', function(self) -- shunt/nodes/marshal/main.yue:394
      local _with_0 = { } -- shunt/nodes/marshal/main.yue:395
      if not running_tests() then -- shunt/nodes/marshal/main.yue:396
        do -- shunt/nodes/marshal/main.yue:397
          local _base_1 = self -- shunt/nodes/marshal/main.yue:397
          local _fn_0 = _base_1.run_steps -- shunt/nodes/marshal/main.yue:397
          _with_0[#_with_0 + 1] = _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:397
            return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:397
          end -- shunt/nodes/marshal/main.yue:397
        end -- shunt/nodes/marshal/main.yue:397
      end -- shunt/nodes/marshal/main.yue:396
      do -- shunt/nodes/marshal/main.yue:398
        local _base_1 = self -- shunt/nodes/marshal/main.yue:398
        local _fn_0 = _base_1.count_epochs -- shunt/nodes/marshal/main.yue:398
        _with_0[#_with_0 + 1] = _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:398
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:398
        end -- shunt/nodes/marshal/main.yue:398
      end -- shunt/nodes/marshal/main.yue:398
      do -- shunt/nodes/marshal/main.yue:399
        local _base_1 = self -- shunt/nodes/marshal/main.yue:399
        local _fn_0 = _base_1.listen_to_network -- shunt/nodes/marshal/main.yue:399
        _with_0[#_with_0 + 1] = _fn_0 and function(...) -- shunt/nodes/marshal/main.yue:399
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/main.yue:399
        end -- shunt/nodes/marshal/main.yue:399
      end -- shunt/nodes/marshal/main.yue:399
      return _with_0 -- shunt/nodes/marshal/main.yue:395
    end), -- shunt/nodes/marshal/main.yue:401
    run_steps = F('() => !', function(self) -- shunt/nodes/marshal/main.yue:401
      while true do -- shunt/nodes/marshal/main.yue:402
        self:step() -- shunt/nodes/marshal/main.yue:403
        if self.throttle then -- shunt/nodes/marshal/main.yue:405
          os.sleep(0.001) -- shunt/nodes/marshal/main.yue:406
        else -- shunt/nodes/marshal/main.yue:408
          coroutine.yield() -- shunt/nodes/marshal/main.yue:408
        end -- shunt/nodes/marshal/main.yue:405
      end -- shunt/nodes/marshal/main.yue:408
    end), -- shunt/nodes/marshal/main.yue:410
    count_epochs = F('() => !', function(self, initial_epoch) -- shunt/nodes/marshal/main.yue:410
      if initial_epoch == nil then -- shunt/nodes/marshal/main.yue:410
        initial_epoch = 1 -- shunt/nodes/marshal/main.yue:410
      end -- shunt/nodes/marshal/main.yue:410
      local EPOCH_PERIOD = 20 -- shunt/nodes/marshal/main.yue:411
      local epoch = initial_epoch -- shunt/nodes/marshal/main.yue:412
      while true do -- shunt/nodes/marshal/main.yue:413
        if self.do_count_epochs then -- shunt/nodes/marshal/main.yue:414
          self:send_new_epoch_event(epoch) -- shunt/nodes/marshal/main.yue:415
          epoch = epoch + 1 -- shunt/nodes/marshal/main.yue:416
          os.sleep(EPOCH_PERIOD) -- shunt/nodes/marshal/main.yue:417
        else -- shunt/nodes/marshal/main.yue:419
          coroutine.yield() -- shunt/nodes/marshal/main.yue:419
        end -- shunt/nodes/marshal/main.yue:414
      end -- shunt/nodes/marshal/main.yue:419
    end), -- shunt/nodes/marshal/main.yue:421
    send_new_epoch_event = F('(number) => <>', function(self, new_epoch) -- shunt/nodes/marshal/main.yue:421
      self.events:enqueue({ -- shunt/nodes/marshal/main.yue:423
        type = 'new-epoch', -- shunt/nodes/marshal/main.yue:423
        new_epoch = new_epoch -- shunt/nodes/marshal/main.yue:424
      }) -- shunt/nodes/marshal/main.yue:422
      coroutine.yield() -- shunt/nodes/marshal/main.yue:425
      return -- shunt/nodes/marshal/main.yue:426
    end), -- shunt/nodes/marshal/main.yue:428
    listen_to_network = F('() => !', function(self) -- shunt/nodes/marshal/main.yue:428
      while true do -- shunt/nodes/marshal/main.yue:429
        self:read_network() -- shunt/nodes/marshal/main.yue:430
      end -- shunt/nodes/marshal/main.yue:430
    end), -- shunt/nodes/marshal/main.yue:432
    read_network = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:432
      log(function() -- shunt/nodes/marshal/main.yue:433
        return "reading network..." -- shunt/nodes/marshal/main.yue:433
      end) -- shunt/nodes/marshal/main.yue:433
      local _, packet = self.uplink:receive_from_any() -- shunt/nodes/marshal/main.yue:434
      if not self.firewall:permits(packet) then -- shunt/nodes/marshal/main.yue:435
        return -- shunt/nodes/marshal/main.yue:436
      end -- shunt/nodes/marshal/main.yue:435
      return self.events:enqueue({ -- shunt/nodes/marshal/main.yue:438
        type = 'network-packet', -- shunt/nodes/marshal/main.yue:438
        packet = packet -- shunt/nodes/marshal/main.yue:439
      }) -- shunt/nodes/marshal/main.yue:439
    end), -- shunt/nodes/marshal/main.yue:441
    ut_stop_counting_epochs = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:441
      self.do_count_epochs = false -- shunt/nodes/marshal/main.yue:442
    end), -- shunt/nodes/marshal/main.yue:444
    ut_step = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:444
      if self.ut_step_num == nil then -- shunt/nodes/marshal/main.yue:445
        self.ut_step_num = 0 -- shunt/nodes/marshal/main.yue:445
      end -- shunt/nodes/marshal/main.yue:445
      self.ut_step_num = self.ut_step_num + 1 -- shunt/nodes/marshal/main.yue:446
      print("--- ut_step (" .. tostring(self.ut_step_num) .. ") ---") -- shunt/nodes/marshal/main.yue:447
      if self.ut_tasks == nil then -- shunt/nodes/marshal/main.yue:449
        do -- shunt/nodes/marshal/main.yue:449
          local _with_0 = RoundRobin() -- shunt/nodes/marshal/main.yue:449
          local _list_0 = self:tasks() -- shunt/nodes/marshal/main.yue:450
          for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:450
            local task = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:450
            _with_0:add(task) -- shunt/nodes/marshal/main.yue:451
          end -- shunt/nodes/marshal/main.yue:451
          self.ut_tasks = _with_0 -- shunt/nodes/marshal/main.yue:449
        end -- shunt/nodes/marshal/main.yue:449
      end -- shunt/nodes/marshal/main.yue:451
      self.ut_tasks:run_pass() -- shunt/nodes/marshal/main.yue:452
      return self:step() -- shunt/nodes/marshal/main.yue:454
    end), -- shunt/nodes/marshal/main.yue:456
    ut_epoch = F('() => number', function(self) -- shunt/nodes/marshal/main.yue:456
      return self.resource_orchestrator.epoch -- shunt/nodes/marshal/main.yue:457
    end), -- shunt/nodes/marshal/main.yue:459
    ut_set_epoch = F('(number) => <>', function(self, epoch) -- shunt/nodes/marshal/main.yue:459
      self.epoch = epoch -- shunt/nodes/marshal/main.yue:460
      assert(coroutine.resume(coroutine.create(function() -- shunt/nodes/marshal/main.yue:461
        return self:send_new_epoch_event(epoch) -- shunt/nodes/marshal/main.yue:462
      end))) -- shunt/nodes/marshal/main.yue:461
      return -- shunt/nodes/marshal/main.yue:463
    end), -- shunt/nodes/marshal/main.yue:465
    ut_factories = F('() => {string->Factory}', function(self) -- shunt/nodes/marshal/main.yue:465
      return self.resource_orchestrator.factories -- shunt/nodes/marshal/main.yue:465
    end), -- shunt/nodes/marshal/main.yue:467
    ut_trains = F('() => {string->TrainStatus}', function(self) -- shunt/nodes/marshal/main.yue:467
      return self.resource_orchestrator.trains -- shunt/nodes/marshal/main.yue:467
    end), -- shunt/nodes/marshal/main.yue:469
    ut_declare_train_lost = F('(string) => <>', function(self, train_name) -- shunt/nodes/marshal/main.yue:469
      return self.scheduler.promise_tracker:ut_declare_train_lost(train_name) -- shunt/nodes/marshal/main.yue:470
    end), -- shunt/nodes/marshal/main.yue:472
    ut_train_is_lost = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/main.yue:472
      return self.scheduler.promise_tracker:train_is_lost(train_name) -- shunt/nodes/marshal/main.yue:473
    end), -- shunt/nodes/marshal/main.yue:475
    ut_train_is_reserved = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/main.yue:475
      return self.scheduler.promise_tracker:train_is_promised(train_name) -- shunt/nodes/marshal/main.yue:476
    end), -- shunt/nodes/marshal/main.yue:478
    ut_config = F('() => MarshalConfig', function(self) -- shunt/nodes/marshal/main.yue:478
      return self.config -- shunt/nodes/marshal/main.yue:478
    end), -- shunt/nodes/marshal/main.yue:480
    ut_is_on_cooldown = F('(string, string) => boolean', function(self, factory_name, resource) -- shunt/nodes/marshal/main.yue:480
      return self.resource_orchestrator:is_on_cooldown(factory_name, resource) -- shunt/nodes/marshal/main.yue:481
    end), -- shunt/nodes/marshal/main.yue:483
    ut_active = F('() => boolean', function(self) -- shunt/nodes/marshal/main.yue:483
      if self.sm.state.name ~= 'waiting' then -- shunt/nodes/marshal/main.yue:484
        return true -- shunt/nodes/marshal/main.yue:485
      end -- shunt/nodes/marshal/main.yue:484
      if self.events:len() > 0 then -- shunt/nodes/marshal/main.yue:486
        return true -- shunt/nodes/marshal/main.yue:487
      end -- shunt/nodes/marshal/main.yue:486
      local _list_0 = self.child_components -- shunt/nodes/marshal/main.yue:488
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:488
        local child_component = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:488
        if child_component.sm.state.name ~= 'waiting' then -- shunt/nodes/marshal/main.yue:489
          return true -- shunt/nodes/marshal/main.yue:490
        end -- shunt/nodes/marshal/main.yue:489
        if child_component.events:len() > 0 then -- shunt/nodes/marshal/main.yue:491
          return true -- shunt/nodes/marshal/main.yue:492
        end -- shunt/nodes/marshal/main.yue:491
      end -- shunt/nodes/marshal/main.yue:492
      return false -- shunt/nodes/marshal/main.yue:493
    end) -- shunt/nodes/marshal/main.yue:124
  } -- shunt/nodes/marshal/main.yue:124
  if _base_0.__index == nil then -- shunt/nodes/marshal/main.yue:124
    _base_0.__index = _base_0 -- shunt/nodes/marshal/main.yue:124
  end -- shunt/nodes/marshal/main.yue:493
  _class_0 = setmetatable({ -- shunt/nodes/marshal/main.yue:124
    __init = F('(MarshalOpts) => <>', function(self, opts) -- shunt/nodes/marshal/main.yue:127
      local config, pc, uplink, rand, clock = opts.config, opts.pc, opts.uplink, opts.rand, opts.clock -- shunt/nodes/marshal/main.yue:128
      if rand == nil then -- shunt/nodes/marshal/main.yue:132
        rand = PseudoRandom() -- shunt/nodes/marshal/main.yue:132
      end -- shunt/nodes/marshal/main.yue:132
      if clock == nil then -- shunt/nodes/marshal/main.yue:133
        clock = MinecraftClock() -- shunt/nodes/marshal/main.yue:133
      end -- shunt/nodes/marshal/main.yue:133
      self.config = config -- shunt/nodes/marshal/main.yue:135
      self.pc = pc -- shunt/nodes/marshal/main.yue:136
      self.uplink = uplink -- shunt/nodes/marshal/main.yue:137
      self.rand = rand -- shunt/nodes/marshal/main.yue:138
      self.clock = clock -- shunt/nodes/marshal/main.yue:139
      self.do_count_epochs = T('boolean', true) -- shunt/nodes/marshal/main.yue:141
      self.throttle = T('boolean', HOST == 'minecraft') -- shunt/nodes/marshal/main.yue:142
      self.events = T('Queue', Queue('MarshalEvent')) -- shunt/nodes/marshal/main.yue:144
      self.scheduler = T('Scheduler', Scheduler({ -- shunt/nodes/marshal/main.yue:148
        clock = self.clock, -- shunt/nodes/marshal/main.yue:148
        resend_cooldown_seconds = self.config.resend_cooldown_seconds, -- shunt/nodes/marshal/main.yue:149
        rand = self.rand -- shunt/nodes/marshal/main.yue:150
      })) -- shunt/nodes/marshal/main.yue:146
      self.resource_orchestrator = T('ResourceOrchestrator', ResourceOrchestrator({ -- shunt/nodes/marshal/main.yue:153
        clock = clock, -- shunt/nodes/marshal/main.yue:153
        config = config, -- shunt/nodes/marshal/main.yue:154
        scheduler = self.scheduler, -- shunt/nodes/marshal/main.yue:155
        uplink = uplink -- shunt/nodes/marshal/main.yue:156
      })) -- shunt/nodes/marshal/main.yue:151
      self.upgrade_listener = T('UpgradeListener', UpgradeListener({ -- shunt/nodes/marshal/main.yue:159
        config = config, -- shunt/nodes/marshal/main.yue:159
        uplink = uplink -- shunt/nodes/marshal/main.yue:160
      })) -- shunt/nodes/marshal/main.yue:157
      self.config_listener = T('ConfigListener', ConfigListener({ -- shunt/nodes/marshal/main.yue:163
        config_type = 'MarshalConfig', -- shunt/nodes/marshal/main.yue:163
        target = self, -- shunt/nodes/marshal/main.yue:164
        uplink = uplink -- shunt/nodes/marshal/main.yue:165
      })) -- shunt/nodes/marshal/main.yue:161
      self.child_components = T('[Component]', { -- shunt/nodes/marshal/main.yue:168
        self.scheduler, -- shunt/nodes/marshal/main.yue:168
        self.resource_orchestrator, -- shunt/nodes/marshal/main.yue:169
        self.upgrade_listener, -- shunt/nodes/marshal/main.yue:170
        self.config_listener -- shunt/nodes/marshal/main.yue:171
      }) -- shunt/nodes/marshal/main.yue:167
      local allowed_packet_types = { -- shunt/nodes/marshal/main.yue:174
        MarshalIdentityRequest, -- shunt/nodes/marshal/main.yue:174
        DeclareTrainState -- shunt/nodes/marshal/main.yue:175
      } -- shunt/nodes/marshal/main.yue:173
      do -- shunt/nodes/marshal/main.yue:176
        local _with_0 = Firewall(allowed_packet_types) -- shunt/nodes/marshal/main.yue:176
        local _list_0 = self.child_components -- shunt/nodes/marshal/main.yue:177
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:177
          local child_component = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:177
          _with_0:add_child(child_component.firewall) -- shunt/nodes/marshal/main.yue:178
        end -- shunt/nodes/marshal/main.yue:178
        self.firewall = _with_0 -- shunt/nodes/marshal/main.yue:176
      end -- shunt/nodes/marshal/main.yue:176
      self.sm = self.__class:make_sm() -- shunt/nodes/marshal/main.yue:179
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/nodes/marshal/main.yue:180
    end), -- shunt/nodes/marshal/main.yue:124
    __base = _base_0, -- shunt/nodes/marshal/main.yue:124
    __name = "Marshal" -- shunt/nodes/marshal/main.yue:124
  }, { -- shunt/nodes/marshal/main.yue:124
    __index = _base_0, -- shunt/nodes/marshal/main.yue:124
    __call = function(cls, ...) -- shunt/nodes/marshal/main.yue:124
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/main.yue:124
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/main.yue:124
      return _self_0 -- shunt/nodes/marshal/main.yue:124
    end -- shunt/nodes/marshal/main.yue:124
  }) -- shunt/nodes/marshal/main.yue:124
  _base_0.__class = _class_0 -- shunt/nodes/marshal/main.yue:124
  local self = _class_0; -- shunt/nodes/marshal/main.yue:124
  self.SAVE_FILE = '.marshal-state.json' -- shunt/nodes/marshal/main.yue:125
  self.make_sm = F('() => StateMachine', function(self) -- shunt/nodes/marshal/main.yue:182
    return (StateMachineBuilder('marshal')):set_initial_state('waiting'):declare_endless():set_reporter(shallow_log_reporter):add((State('waiting')):add_transition_to('inspecting_packet'):add_transition_to('changing_epoch'):add_transition_to('applying_config')):add((State('inspecting_packet')):set_data_type([[{
          packet: Packet,
        }]]):add_transition_to('analysing_marshal_identity_request'):add_transition_to('analysing_declare_train_state'):add_transition_to('waiting')):add((State('analysing_marshal_identity_request')):set_data_type([[{
          packet: MarshalIdentityRequest,
        }]]):add_transition_to('sending_marshal_identity_response')):add((State('sending_marshal_identity_response')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          recipient_id: number,
          resp: number|string,
        }]]):add_transition_to('waiting')):add((State('analysing_declare_train_state')):set_data_type([[{
          packet: DeclareTrainState,
        }]]):add_transition_to('enqueueing_declare_train_state')):add((State('enqueueing_declare_train_state')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          pc_id: number,
          train_name: string,
          state: TrainState,
        }]]):add_transition_to('sending_declare_train_state_response')):add((State('sending_declare_train_state_response')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          recipient_id: number,
          error_reason: ?string
        }]]):add_transition_to('waiting')):add((State('changing_epoch')):set_data_type([[{
          new_epoch: number,
        }]]):add_transition_to('waiting')):add((State('applying_config')):set_data_type([[{
          config: MarshalConfig,
        }]]):add_transition_to('waiting')):build() -- shunt/nodes/marshal/main.yue:240
  end) -- shunt/nodes/marshal/main.yue:182
  Marshal = _class_0 -- shunt/nodes/marshal/main.yue:124
end -- shunt/nodes/marshal/main.yue:493
_module_0["Marshal"] = Marshal -- shunt/nodes/marshal/main.yue:124
do -- shunt/nodes/marshal/main.yue:495
  local _class_0 -- shunt/nodes/marshal/main.yue:495
  local _base_0 = { -- shunt/nodes/marshal/main.yue:495
    add = F('(thread | () -> any) => <>', function(self, task) -- shunt/nodes/marshal/main.yue:501
      assert(not self.started, "internal error: task added to round robin after execution commenced") -- shunt/nodes/marshal/main.yue:502
      if 'function' == type(task) then -- shunt/nodes/marshal/main.yue:504
        task = coroutine.create(task) -- shunt/nodes/marshal/main.yue:505
      end -- shunt/nodes/marshal/main.yue:504
      self.num_task_coroutines = self.num_task_coroutines + 1 -- shunt/nodes/marshal/main.yue:506
      do -- shunt/nodes/marshal/main.yue:507
        local _obj_0 = self.task_coroutines -- shunt/nodes/marshal/main.yue:507
        _obj_0[#_obj_0 + 1] = task -- shunt/nodes/marshal/main.yue:507
      end -- shunt/nodes/marshal/main.yue:507
    end), -- shunt/nodes/marshal/main.yue:509
    run_pass = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:509
      self.started = true -- shunt/nodes/marshal/main.yue:510
      local all_dead = true -- shunt/nodes/marshal/main.yue:512
      for i = 1, self.num_task_coroutines do -- shunt/nodes/marshal/main.yue:513
        local _continue_0 = false -- shunt/nodes/marshal/main.yue:514
        repeat -- shunt/nodes/marshal/main.yue:514
          local task = self.task_coroutines[i] -- shunt/nodes/marshal/main.yue:514
          if 'dead' == coroutine.status(task) then -- shunt/nodes/marshal/main.yue:515
            _continue_0 = true -- shunt/nodes/marshal/main.yue:516
            break -- shunt/nodes/marshal/main.yue:516
          end -- shunt/nodes/marshal/main.yue:515
          all_dead = false -- shunt/nodes/marshal/main.yue:517
          local ok, err = coroutine.resume(task) -- shunt/nodes/marshal/main.yue:519
          if not ok then -- shunt/nodes/marshal/main.yue:520
            error(err) -- shunt/nodes/marshal/main.yue:521
          end -- shunt/nodes/marshal/main.yue:520
          _continue_0 = true -- shunt/nodes/marshal/main.yue:514
        until true -- shunt/nodes/marshal/main.yue:521
        if not _continue_0 then -- shunt/nodes/marshal/main.yue:521
          break -- shunt/nodes/marshal/main.yue:521
        end -- shunt/nodes/marshal/main.yue:521
      end -- shunt/nodes/marshal/main.yue:521
      if all_dead then -- shunt/nodes/marshal/main.yue:522
        return error('internal error: all tasks are complete') -- shunt/nodes/marshal/main.yue:523
      end -- shunt/nodes/marshal/main.yue:522
    end) -- shunt/nodes/marshal/main.yue:495
  } -- shunt/nodes/marshal/main.yue:495
  if _base_0.__index == nil then -- shunt/nodes/marshal/main.yue:495
    _base_0.__index = _base_0 -- shunt/nodes/marshal/main.yue:495
  end -- shunt/nodes/marshal/main.yue:523
  _class_0 = setmetatable({ -- shunt/nodes/marshal/main.yue:495
    __init = F('() => <>', function(self) -- shunt/nodes/marshal/main.yue:496
      self.task_coroutines = T('{number->thread}', { }) -- shunt/nodes/marshal/main.yue:497
      self.num_task_coroutines = T('number', 0) -- shunt/nodes/marshal/main.yue:498
      self.started = T('boolean', false) -- shunt/nodes/marshal/main.yue:499
    end), -- shunt/nodes/marshal/main.yue:495
    __base = _base_0, -- shunt/nodes/marshal/main.yue:495
    __name = "RoundRobin" -- shunt/nodes/marshal/main.yue:495
  }, { -- shunt/nodes/marshal/main.yue:495
    __index = _base_0, -- shunt/nodes/marshal/main.yue:495
    __call = function(cls, ...) -- shunt/nodes/marshal/main.yue:495
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/main.yue:495
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/main.yue:495
      return _self_0 -- shunt/nodes/marshal/main.yue:495
    end -- shunt/nodes/marshal/main.yue:495
  }) -- shunt/nodes/marshal/main.yue:495
  _base_0.__class = _class_0 -- shunt/nodes/marshal/main.yue:495
  RoundRobin = _class_0 -- shunt/nodes/marshal/main.yue:495
end -- shunt/nodes/marshal/main.yue:523
spec(function() -- shunt/nodes/marshal/main.yue:525
  local TestClock = require('shunt.clock').TestClock -- shunt/nodes/marshal/main.yue:0
  local GetConfigRequest, SetConfigRequest -- shunt/nodes/marshal/main.yue:0
  do -- shunt/nodes/marshal/main.yue:0
    local _obj_0 = require('shunt.configurator.main') -- shunt/nodes/marshal/main.yue:0
    GetConfigRequest, SetConfigRequest = _obj_0.GetConfigRequest, _obj_0.SetConfigRequest -- shunt/nodes/marshal/main.yue:0
  end -- shunt/nodes/marshal/main.yue:0
  local ScheduleResponse = require('shunt.nodes.factory.main').ScheduleResponse -- shunt/nodes/marshal/main.yue:0
  local TestPcBackend = require('shunt.pc').TestPcBackend -- shunt/nodes/marshal/main.yue:0
  local describe, it, matchers -- shunt/nodes/marshal/main.yue:0
  do -- shunt/nodes/marshal/main.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/marshal/main.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/marshal/main.yue:0
  end -- shunt/nodes/marshal/main.yue:0
  local deep_eq, eq, has_fields, len, lt, matches = matchers.deep_eq, matchers.eq, matchers.has_fields, matchers.len, matchers.lt, matchers.matches -- shunt/nodes/marshal/main.yue:534
  return describe('Marshal', function() -- shunt/nodes/marshal/main.yue:536
    describe('\\on_new_epoch', function() -- shunt/nodes/marshal/main.yue:537
      return it('prunes lost factories', function() -- shunt/nodes/marshal/main.yue:538
        local test_phase = 'add-factories' -- shunt/nodes/marshal/main.yue:539
        local stockpile = { -- shunt/nodes/marshal/main.yue:541
          known = { -- shunt/nodes/marshal/main.yue:542
            { -- shunt/nodes/marshal/main.yue:542
              name = 'minecraft:dirt', -- shunt/nodes/marshal/main.yue:542
              stored = 64, -- shunt/nodes/marshal/main.yue:543
              shortage_amount = 32 -- shunt/nodes/marshal/main.yue:544
            } -- shunt/nodes/marshal/main.yue:542
          }, -- shunt/nodes/marshal/main.yue:541
          unknown = { -- shunt/nodes/marshal/main.yue:546
            { -- shunt/nodes/marshal/main.yue:546
              name = 'minecraft:wood_sword', -- shunt/nodes/marshal/main.yue:546
              stored = 1 -- shunt/nodes/marshal/main.yue:547
            } -- shunt/nodes/marshal/main.yue:546
          }, -- shunt/nodes/marshal/main.yue:545
          estimated_capacity = 64 -- shunt/nodes/marshal/main.yue:548
        } -- shunt/nodes/marshal/main.yue:540
        local EXPECTED_FACTORIES = 4 -- shunt/nodes/marshal/main.yue:549
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:552
          marshal = { -- shunt/nodes/marshal/main.yue:554
            network = 'mainline' -- shunt/nodes/marshal/main.yue:554
          } -- shunt/nodes/marshal/main.yue:553
        }, { -- shunt/nodes/marshal/main.yue:552
          __raw = '' -- shunt/nodes/marshal/main.yue:552
        }) -- shunt/nodes/marshal/main.yue:551
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:556
          to_receive = function() -- shunt/nodes/marshal/main.yue:556
            local _with_0 = { } -- shunt/nodes/marshal/main.yue:556
            if test_phase == 'global-disconnect' then -- shunt/nodes/marshal/main.yue:557
              return { } -- shunt/nodes/marshal/main.yue:558
            end -- shunt/nodes/marshal/main.yue:557
            local stations = F('(number) -> DetectedStations', function(i) -- shunt/nodes/marshal/main.yue:560
              if 'add-factories' == test_phase then -- shunt/nodes/marshal/main.yue:562
                local known = { -- shunt/nodes/marshal/main.yue:564
                  { -- shunt/nodes/marshal/main.yue:564
                    name = "station_" .. tostring(3 * i), -- shunt/nodes/marshal/main.yue:564
                    network = 'network_1', -- shunt/nodes/marshal/main.yue:565
                    type = 'outbound', -- shunt/nodes/marshal/main.yue:566
                    handles = 'dirt', -- shunt/nodes/marshal/main.yue:567
                    capacity = 1, -- shunt/nodes/marshal/main.yue:568
                    present_trains = { } -- shunt/nodes/marshal/main.yue:569
                  }, -- shunt/nodes/marshal/main.yue:564
                  { -- shunt/nodes/marshal/main.yue:570
                    name = "station_" .. tostring(3 * i + 1), -- shunt/nodes/marshal/main.yue:570
                    network = 'network_2', -- shunt/nodes/marshal/main.yue:571
                    type = 'inbound', -- shunt/nodes/marshal/main.yue:572
                    handles = 'dirt', -- shunt/nodes/marshal/main.yue:573
                    capacity = 1, -- shunt/nodes/marshal/main.yue:574
                    present_trains = { } -- shunt/nodes/marshal/main.yue:575
                  } -- shunt/nodes/marshal/main.yue:570
                } -- shunt/nodes/marshal/main.yue:563
                return { -- shunt/nodes/marshal/main.yue:576
                  known = known, -- shunt/nodes/marshal/main.yue:576
                  unknown = { } -- shunt/nodes/marshal/main.yue:576
                } -- shunt/nodes/marshal/main.yue:576
              elseif 'change-factory-stations' == test_phase then -- shunt/nodes/marshal/main.yue:577
                local known = { -- shunt/nodes/marshal/main.yue:579
                  { -- shunt/nodes/marshal/main.yue:579
                    name = "station_" .. tostring(3 * i), -- shunt/nodes/marshal/main.yue:579
                    network = 'network_1', -- shunt/nodes/marshal/main.yue:580
                    type = 'outbound', -- shunt/nodes/marshal/main.yue:581
                    handles = 'dirt', -- shunt/nodes/marshal/main.yue:582
                    capacity = 1, -- shunt/nodes/marshal/main.yue:583
                    present_trains = { } -- shunt/nodes/marshal/main.yue:584
                  }, -- shunt/nodes/marshal/main.yue:579
                  { -- shunt/nodes/marshal/main.yue:585
                    name = "station_" .. tostring(3 * i + 2), -- shunt/nodes/marshal/main.yue:585
                    network = 'network_3', -- shunt/nodes/marshal/main.yue:586
                    type = 'inbound', -- shunt/nodes/marshal/main.yue:587
                    handles = 'dirt', -- shunt/nodes/marshal/main.yue:588
                    capacity = 1, -- shunt/nodes/marshal/main.yue:589
                    present_trains = { } -- shunt/nodes/marshal/main.yue:590
                  } -- shunt/nodes/marshal/main.yue:585
                } -- shunt/nodes/marshal/main.yue:578
                return { -- shunt/nodes/marshal/main.yue:591
                  known = known, -- shunt/nodes/marshal/main.yue:591
                  unknown = { } -- shunt/nodes/marshal/main.yue:591
                } -- shunt/nodes/marshal/main.yue:591
              else -- shunt/nodes/marshal/main.yue:593
                return error("internal error: unrecognised test phase " .. tostring(test_phase)) -- shunt/nodes/marshal/main.yue:593
              end -- shunt/nodes/marshal/main.yue:593
            end) -- shunt/nodes/marshal/main.yue:560
            for i = 1, EXPECTED_FACTORIES do -- shunt/nodes/marshal/main.yue:594
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/main.yue:596
                from_id = i, -- shunt/nodes/marshal/main.yue:596
                packet = FactoryHeartbeat(i, "factory_" .. tostring(i), (stations(i)), stockpile) -- shunt/nodes/marshal/main.yue:597
              } -- shunt/nodes/marshal/main.yue:595
            end -- shunt/nodes/marshal/main.yue:597
            return _with_0 -- shunt/nodes/marshal/main.yue:556
          end -- shunt/nodes/marshal/main.yue:556
        })) -- shunt/nodes/marshal/main.yue:555
        local pc = Pc() -- shunt/nodes/marshal/main.yue:599
        local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:600
          config = config, -- shunt/nodes/marshal/main.yue:600
          pc = pc, -- shunt/nodes/marshal/main.yue:600
          uplink = uplink, -- shunt/nodes/marshal/main.yue:600
          clock = TestClock() -- shunt/nodes/marshal/main.yue:600
        }) -- shunt/nodes/marshal/main.yue:600
        _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:601
        for i = 1, 13 do -- shunt/nodes/marshal/main.yue:602
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:603
        end -- shunt/nodes/marshal/main.yue:603
        local epoch = _with_0:ut_epoch() -- shunt/nodes/marshal/main.yue:605
        local factories = _with_0:ut_factories(); -- shunt/nodes/marshal/main.yue:606
        require('shunt.spec')._assert_that([=[factories.factory_1]=], factories.factory_1, (has_fields({ -- shunt/nodes/marshal/main.yue:607
          name = eq('factory_1'), -- shunt/nodes/marshal/main.yue:607
          pc_id = eq(1), -- shunt/nodes/marshal/main.yue:607
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:607
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:607
            known = has_fields({ -- shunt/nodes/marshal/main.yue:607
              has_fields({ -- shunt/nodes/marshal/main.yue:607
                name = eq('station_3') -- shunt/nodes/marshal/main.yue:607
              }), -- shunt/nodes/marshal/main.yue:607
              has_fields({ -- shunt/nodes/marshal/main.yue:607
                name = eq('station_4') -- shunt/nodes/marshal/main.yue:607
              }) -- shunt/nodes/marshal/main.yue:607
            }), -- shunt/nodes/marshal/main.yue:607
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:607
          }), -- shunt/nodes/marshal/main.yue:607
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:607
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(607)); -- shunt/nodes/marshal/main.yue:607
        require('shunt.spec')._assert_that([=[factories.factory_2]=], factories.factory_2, (has_fields({ -- shunt/nodes/marshal/main.yue:617
          name = eq('factory_2'), -- shunt/nodes/marshal/main.yue:617
          pc_id = eq(2), -- shunt/nodes/marshal/main.yue:617
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:617
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:617
            known = has_fields({ -- shunt/nodes/marshal/main.yue:617
              has_fields({ -- shunt/nodes/marshal/main.yue:617
                name = eq("station_6") -- shunt/nodes/marshal/main.yue:617
              }), -- shunt/nodes/marshal/main.yue:617
              has_fields({ -- shunt/nodes/marshal/main.yue:617
                name = eq("station_7") -- shunt/nodes/marshal/main.yue:617
              }) -- shunt/nodes/marshal/main.yue:617
            }), -- shunt/nodes/marshal/main.yue:617
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:617
          }), -- shunt/nodes/marshal/main.yue:617
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:617
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(617)); -- shunt/nodes/marshal/main.yue:617
        require('shunt.spec')._assert_that([=[factories.factory_3]=], factories.factory_3, (has_fields({ -- shunt/nodes/marshal/main.yue:627
          name = eq('factory_3'), -- shunt/nodes/marshal/main.yue:627
          pc_id = eq(3), -- shunt/nodes/marshal/main.yue:627
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:627
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:627
            known = has_fields({ -- shunt/nodes/marshal/main.yue:627
              has_fields({ -- shunt/nodes/marshal/main.yue:627
                name = eq("station_9") -- shunt/nodes/marshal/main.yue:627
              }), -- shunt/nodes/marshal/main.yue:627
              has_fields({ -- shunt/nodes/marshal/main.yue:627
                name = eq("station_10") -- shunt/nodes/marshal/main.yue:627
              }) -- shunt/nodes/marshal/main.yue:627
            }), -- shunt/nodes/marshal/main.yue:627
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:627
          }), -- shunt/nodes/marshal/main.yue:627
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:627
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(627)); -- shunt/nodes/marshal/main.yue:627
        require('shunt.spec')._assert_that([=[factories.factory_4]=], factories.factory_4, (has_fields({ -- shunt/nodes/marshal/main.yue:637
          name = eq('factory_4'), -- shunt/nodes/marshal/main.yue:637
          pc_id = eq(4), -- shunt/nodes/marshal/main.yue:637
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:637
          stations = has_fields({ }, { -- shunt/nodes/marshal/main.yue:637
            known = has_fields({ -- shunt/nodes/marshal/main.yue:637
              has_fields({ -- shunt/nodes/marshal/main.yue:637
                name = eq("station_12") -- shunt/nodes/marshal/main.yue:637
              }), -- shunt/nodes/marshal/main.yue:637
              has_fields({ -- shunt/nodes/marshal/main.yue:637
                name = eq("station_13") -- shunt/nodes/marshal/main.yue:637
              }) -- shunt/nodes/marshal/main.yue:637
            }), -- shunt/nodes/marshal/main.yue:637
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:637
          }), -- shunt/nodes/marshal/main.yue:637
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:637
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(637)) -- shunt/nodes/marshal/main.yue:637
        test_phase = 'change-factory-stations' -- shunt/nodes/marshal/main.yue:648
        uplink.backend:reset() -- shunt/nodes/marshal/main.yue:649
        for _ = 1, 13 do -- shunt/nodes/marshal/main.yue:650
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:651
        end -- shunt/nodes/marshal/main.yue:651
        factories = _with_0:ut_factories(); -- shunt/nodes/marshal/main.yue:653
        require('shunt.spec')._assert_that([=[factories.factory_1]=], factories.factory_1, (has_fields({ -- shunt/nodes/marshal/main.yue:654
          name = eq('factory_1'), -- shunt/nodes/marshal/main.yue:654
          pc_id = eq(1), -- shunt/nodes/marshal/main.yue:654
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:654
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:654
            known = has_fields({ -- shunt/nodes/marshal/main.yue:654
              has_fields({ -- shunt/nodes/marshal/main.yue:654
                name = eq("station_3") -- shunt/nodes/marshal/main.yue:654
              }), -- shunt/nodes/marshal/main.yue:654
              has_fields({ -- shunt/nodes/marshal/main.yue:654
                name = eq("station_5") -- shunt/nodes/marshal/main.yue:654
              }) -- shunt/nodes/marshal/main.yue:654
            }), -- shunt/nodes/marshal/main.yue:654
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:654
          }), -- shunt/nodes/marshal/main.yue:654
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:654
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(654)); -- shunt/nodes/marshal/main.yue:654
        require('shunt.spec')._assert_that([=[factories.factory_2]=], factories.factory_2, (has_fields({ -- shunt/nodes/marshal/main.yue:664
          name = eq('factory_2'), -- shunt/nodes/marshal/main.yue:664
          pc_id = eq(2), -- shunt/nodes/marshal/main.yue:664
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:664
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:664
            known = has_fields({ -- shunt/nodes/marshal/main.yue:664
              has_fields({ -- shunt/nodes/marshal/main.yue:664
                name = eq("station_6") -- shunt/nodes/marshal/main.yue:664
              }), -- shunt/nodes/marshal/main.yue:664
              has_fields({ -- shunt/nodes/marshal/main.yue:664
                name = eq("station_8") -- shunt/nodes/marshal/main.yue:664
              }) -- shunt/nodes/marshal/main.yue:664
            }), -- shunt/nodes/marshal/main.yue:664
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:664
          }), -- shunt/nodes/marshal/main.yue:664
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:664
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(664)); -- shunt/nodes/marshal/main.yue:664
        require('shunt.spec')._assert_that([=[factories.factory_3]=], factories.factory_3, (has_fields({ -- shunt/nodes/marshal/main.yue:674
          name = eq('factory_3'), -- shunt/nodes/marshal/main.yue:674
          pc_id = eq(3), -- shunt/nodes/marshal/main.yue:674
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:674
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:674
            known = has_fields({ -- shunt/nodes/marshal/main.yue:674
              has_fields({ -- shunt/nodes/marshal/main.yue:674
                name = eq("station_9") -- shunt/nodes/marshal/main.yue:674
              }), -- shunt/nodes/marshal/main.yue:674
              has_fields({ -- shunt/nodes/marshal/main.yue:674
                name = eq("station_11") -- shunt/nodes/marshal/main.yue:674
              }) -- shunt/nodes/marshal/main.yue:674
            }), -- shunt/nodes/marshal/main.yue:674
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:674
          }), -- shunt/nodes/marshal/main.yue:674
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:674
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(674)); -- shunt/nodes/marshal/main.yue:674
        require('shunt.spec')._assert_that([=[factories.factory_4]=], factories.factory_4, (has_fields({ -- shunt/nodes/marshal/main.yue:684
          name = eq('factory_4'), -- shunt/nodes/marshal/main.yue:684
          pc_id = eq(4), -- shunt/nodes/marshal/main.yue:684
          last_seen_epoch = eq(epoch), -- shunt/nodes/marshal/main.yue:684
          stations = has_fields({ -- shunt/nodes/marshal/main.yue:684
            known = has_fields({ -- shunt/nodes/marshal/main.yue:684
              has_fields({ -- shunt/nodes/marshal/main.yue:684
                name = eq("station_12") -- shunt/nodes/marshal/main.yue:684
              }), -- shunt/nodes/marshal/main.yue:684
              has_fields({ -- shunt/nodes/marshal/main.yue:684
                name = eq("station_14") -- shunt/nodes/marshal/main.yue:684
              }) -- shunt/nodes/marshal/main.yue:684
            }), -- shunt/nodes/marshal/main.yue:684
            unknown = len(eq(0)) -- shunt/nodes/marshal/main.yue:684
          }), -- shunt/nodes/marshal/main.yue:684
          stockpile = deep_eq(stockpile) -- shunt/nodes/marshal/main.yue:684
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(684)) -- shunt/nodes/marshal/main.yue:684
        test_phase = 'global-disconnect' -- shunt/nodes/marshal/main.yue:695
        uplink.backend:reset() -- shunt/nodes/marshal/main.yue:696
        _with_0:ut_set_epoch(10) -- shunt/nodes/marshal/main.yue:697
        for _ = 1, 3 do -- shunt/nodes/marshal/main.yue:698
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:699
        end -- shunt/nodes/marshal/main.yue:699
        require('shunt.spec')._expect_that([=[\ut_factories!]=], _with_0:ut_factories(), (deep_eq({ })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(701)) -- shunt/nodes/marshal/main.yue:701
        return _with_0 -- shunt/nodes/marshal/main.yue:600
      end) -- shunt/nodes/marshal/main.yue:701
    end) -- shunt/nodes/marshal/main.yue:537
    it('respects the scheduler', function() end) -- shunt/nodes/marshal/main.yue:703
    describe('\\on_declare_train_state', function() -- shunt/nodes/marshal/main.yue:710
      it('handles lost and not lost trains', function() -- shunt/nodes/marshal/main.yue:711
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:712
        local PC_ID = 1 -- shunt/nodes/marshal/main.yue:714
        local TRAIN_NAME = 'some-train-name' -- shunt/nodes/marshal/main.yue:715
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:718
          marshal = { -- shunt/nodes/marshal/main.yue:720
            network = 'mainline' -- shunt/nodes/marshal/main.yue:720
          } -- shunt/nodes/marshal/main.yue:719
        }, { -- shunt/nodes/marshal/main.yue:718
          __raw = '' -- shunt/nodes/marshal/main.yue:718
        }) -- shunt/nodes/marshal/main.yue:717
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:722
          to_receive = { -- shunt/nodes/marshal/main.yue:723
            { -- shunt/nodes/marshal/main.yue:723
              from_id = PC_ID, -- shunt/nodes/marshal/main.yue:723
              packet = DeclareTrainState(idemp_tok, PC_ID, TRAIN_NAME, 'cleared') -- shunt/nodes/marshal/main.yue:724
            }, -- shunt/nodes/marshal/main.yue:723
            { -- shunt/nodes/marshal/main.yue:725
              from_id = PC_ID, -- shunt/nodes/marshal/main.yue:725
              packet = DeclareTrainState(idemp_tok, PC_ID, TRAIN_NAME, 'cleared') -- shunt/nodes/marshal/main.yue:726
            } -- shunt/nodes/marshal/main.yue:725
          } -- shunt/nodes/marshal/main.yue:722
        })) -- shunt/nodes/marshal/main.yue:721
        local pc = Pc() -- shunt/nodes/marshal/main.yue:727
        local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:728
          config = config, -- shunt/nodes/marshal/main.yue:728
          pc = pc, -- shunt/nodes/marshal/main.yue:728
          uplink = uplink, -- shunt/nodes/marshal/main.yue:728
          clock = TestClock() -- shunt/nodes/marshal/main.yue:728
        }) -- shunt/nodes/marshal/main.yue:728
        _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:729
        _with_0:ut_declare_train_lost(TRAIN_NAME); -- shunt/nodes/marshal/main.yue:730
        require('shunt.spec')._assert_that([=[(\ut_train_is_lost TRAIN_NAME)]=], (_with_0:ut_train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(731)) -- shunt/nodes/marshal/main.yue:731
        for _ = 1, 6 do -- shunt/nodes/marshal/main.yue:733
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:734
        end -- shunt/nodes/marshal/main.yue:734
        require('shunt.spec')._assert_that([=[(\ut_train_is_lost TRAIN_NAME)]=], (_with_0:ut_train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(735)); -- shunt/nodes/marshal/main.yue:735
        require('shunt.spec')._assert_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(736)); -- shunt/nodes/marshal/main.yue:736
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:737
          id = eq(PC_ID), -- shunt/nodes/marshal/main.yue:737
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:737
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:737
            error_reason = eq(nil) -- shunt/nodes/marshal/main.yue:737
          }), -- shunt/nodes/marshal/main.yue:737
          protocol = eq(DeclareTrainStateResponse:protocol()) -- shunt/nodes/marshal/main.yue:737
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(737)) -- shunt/nodes/marshal/main.yue:737
        for _ = 1, 4 do -- shunt/nodes/marshal/main.yue:744
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:745
        end -- shunt/nodes/marshal/main.yue:745
        require('shunt.spec')._assert_that([=[(\ut_train_is_lost TRAIN_NAME)]=], (_with_0:ut_train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(746)); -- shunt/nodes/marshal/main.yue:746
        require('shunt.spec')._assert_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(2))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(747)); -- shunt/nodes/marshal/main.yue:747
        require('shunt.spec')._expect_that([=[uplink.backend.sent[2]]=], uplink.backend.sent[2], (has_fields({ -- shunt/nodes/marshal/main.yue:748
          id = eq(PC_ID), -- shunt/nodes/marshal/main.yue:748
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:748
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:748
            error_reason = matches('was not lost') -- shunt/nodes/marshal/main.yue:748
          }), -- shunt/nodes/marshal/main.yue:748
          protocol = eq(DeclareTrainStateResponse:protocol()) -- shunt/nodes/marshal/main.yue:748
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(748)) -- shunt/nodes/marshal/main.yue:748
        return _with_0 -- shunt/nodes/marshal/main.yue:728
      end) -- shunt/nodes/marshal/main.yue:711
      return it('handles train reservations', function() -- shunt/nodes/marshal/main.yue:755
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:756
        local PC_ID = 1 -- shunt/nodes/marshal/main.yue:758
        local TRAIN_NAME = 'some-train-name' -- shunt/nodes/marshal/main.yue:759
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:762
          marshal = { -- shunt/nodes/marshal/main.yue:764
            network = 'mainline' -- shunt/nodes/marshal/main.yue:764
          } -- shunt/nodes/marshal/main.yue:763
        }, { -- shunt/nodes/marshal/main.yue:762
          __raw = '' -- shunt/nodes/marshal/main.yue:762
        }) -- shunt/nodes/marshal/main.yue:761
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:766
          to_receive = { -- shunt/nodes/marshal/main.yue:767
            { -- shunt/nodes/marshal/main.yue:767
              from_id = PC_ID, -- shunt/nodes/marshal/main.yue:767
              packet = DeclareTrainState(idemp_tok, PC_ID, TRAIN_NAME, 'reserved') -- shunt/nodes/marshal/main.yue:768
            }, -- shunt/nodes/marshal/main.yue:767
            { -- shunt/nodes/marshal/main.yue:769
              from_id = PC_ID, -- shunt/nodes/marshal/main.yue:769
              packet = DeclareTrainState(idemp_tok, PC_ID, TRAIN_NAME, 'reserved') -- shunt/nodes/marshal/main.yue:770
            } -- shunt/nodes/marshal/main.yue:769
          } -- shunt/nodes/marshal/main.yue:766
        })) -- shunt/nodes/marshal/main.yue:765
        local pc = Pc() -- shunt/nodes/marshal/main.yue:772
        local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:773
          config = config, -- shunt/nodes/marshal/main.yue:773
          pc = pc, -- shunt/nodes/marshal/main.yue:773
          uplink = uplink, -- shunt/nodes/marshal/main.yue:773
          clock = TestClock() -- shunt/nodes/marshal/main.yue:773
        }) -- shunt/nodes/marshal/main.yue:773
        _with_0:ut_stop_counting_epochs(); -- shunt/nodes/marshal/main.yue:774
        require('shunt.spec')._assert_that([=[(\ut_train_is_reserved TRAIN_NAME)]=], (_with_0:ut_train_is_reserved(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(775)) -- shunt/nodes/marshal/main.yue:775
        for _ = 1, 5 do -- shunt/nodes/marshal/main.yue:777
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:778
        end -- shunt/nodes/marshal/main.yue:778
        require('shunt.spec')._assert_that([=[(\ut_train_is_reserved TRAIN_NAME)]=], (_with_0:ut_train_is_reserved(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(779)); -- shunt/nodes/marshal/main.yue:779
        require('shunt.spec')._assert_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(780)); -- shunt/nodes/marshal/main.yue:780
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:781
          id = eq(PC_ID), -- shunt/nodes/marshal/main.yue:781
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:781
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:781
            error_reason = eq(nil) -- shunt/nodes/marshal/main.yue:781
          }), -- shunt/nodes/marshal/main.yue:781
          protocol = eq(DeclareTrainStateResponse:protocol()) -- shunt/nodes/marshal/main.yue:781
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(781)) -- shunt/nodes/marshal/main.yue:781
        for _ = 1, 5 do -- shunt/nodes/marshal/main.yue:789
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:790
        end -- shunt/nodes/marshal/main.yue:790
        require('shunt.spec')._assert_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(2))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(791)); -- shunt/nodes/marshal/main.yue:791
        require('shunt.spec')._expect_that([=[uplink.backend.sent[2]]=], uplink.backend.sent[2], (has_fields({ -- shunt/nodes/marshal/main.yue:792
          id = eq(PC_ID), -- shunt/nodes/marshal/main.yue:792
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:792
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:792
            error_reason = eq(nil) -- shunt/nodes/marshal/main.yue:792
          }), -- shunt/nodes/marshal/main.yue:792
          protocol = eq(DeclareTrainStateResponse:protocol()) -- shunt/nodes/marshal/main.yue:792
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(792)) -- shunt/nodes/marshal/main.yue:792
        return _with_0 -- shunt/nodes/marshal/main.yue:773
      end) -- shunt/nodes/marshal/main.yue:797
    end) -- shunt/nodes/marshal/main.yue:710
    describe('\\on_marshal_identity_request', function() -- shunt/nodes/marshal/main.yue:799
      it('responds to marshal requests', function() -- shunt/nodes/marshal/main.yue:800
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:801
        local REQUESTER_PC_ID = 1 -- shunt/nodes/marshal/main.yue:803
        local MARSHAL_PC_ID = 2 -- shunt/nodes/marshal/main.yue:804
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:807
          marshal = { -- shunt/nodes/marshal/main.yue:809
            network = 'mainline' -- shunt/nodes/marshal/main.yue:809
          } -- shunt/nodes/marshal/main.yue:808
        }, { -- shunt/nodes/marshal/main.yue:807
          __raw = '' -- shunt/nodes/marshal/main.yue:807
        }) -- shunt/nodes/marshal/main.yue:806
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:811
          to_receive = { -- shunt/nodes/marshal/main.yue:812
            { -- shunt/nodes/marshal/main.yue:812
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:812
              packet = MarshalIdentityRequest(idemp_tok, REQUESTER_PC_ID) -- shunt/nodes/marshal/main.yue:813
            } -- shunt/nodes/marshal/main.yue:812
          } -- shunt/nodes/marshal/main.yue:811
        })) -- shunt/nodes/marshal/main.yue:810
        local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:815
          id = function(self) -- shunt/nodes/marshal/main.yue:815
            return MARSHAL_PC_ID -- shunt/nodes/marshal/main.yue:815
          end -- shunt/nodes/marshal/main.yue:815
        })) -- shunt/nodes/marshal/main.yue:814
        do -- shunt/nodes/marshal/main.yue:816
          local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:816
            config = config, -- shunt/nodes/marshal/main.yue:816
            pc = pc, -- shunt/nodes/marshal/main.yue:816
            uplink = uplink, -- shunt/nodes/marshal/main.yue:816
            clock = TestClock() -- shunt/nodes/marshal/main.yue:816
          }) -- shunt/nodes/marshal/main.yue:816
          _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:817
          for _ = 1, 4 do -- shunt/nodes/marshal/main.yue:818
            _with_0:ut_step() -- shunt/nodes/marshal/main.yue:819
          end -- shunt/nodes/marshal/main.yue:819
        end -- shunt/nodes/marshal/main.yue:816
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(821)); -- shunt/nodes/marshal/main.yue:821
        return require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:822
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:822
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:822
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:822
            resp = eq(MARSHAL_PC_ID) -- shunt/nodes/marshal/main.yue:822
          }), -- shunt/nodes/marshal/main.yue:822
          protocol = eq(MarshalIdentityResponse:protocol()) -- shunt/nodes/marshal/main.yue:822
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(822)) -- shunt/nodes/marshal/main.yue:827
      end) -- shunt/nodes/marshal/main.yue:800
      return it('responds to factory requests', function() -- shunt/nodes/marshal/main.yue:829
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:830
        local REQUESTER_PC_ID = 1 -- shunt/nodes/marshal/main.yue:832
        local MARSHAL_PC_ID = 2 -- shunt/nodes/marshal/main.yue:833
        local FACTORY_NAME = 'factory' -- shunt/nodes/marshal/main.yue:834
        local FACTORY_PC_ID = 12345 -- shunt/nodes/marshal/main.yue:835
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:838
          marshal = { -- shunt/nodes/marshal/main.yue:840
            network = 'mainline' -- shunt/nodes/marshal/main.yue:840
          } -- shunt/nodes/marshal/main.yue:839
        }, { -- shunt/nodes/marshal/main.yue:838
          __raw = '' -- shunt/nodes/marshal/main.yue:838
        }) -- shunt/nodes/marshal/main.yue:837
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:842
          to_receive = { -- shunt/nodes/marshal/main.yue:843
            { -- shunt/nodes/marshal/main.yue:843
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:843
              packet = MarshalIdentityRequest(idemp_tok, REQUESTER_PC_ID, FACTORY_NAME) -- shunt/nodes/marshal/main.yue:844
            }, -- shunt/nodes/marshal/main.yue:843
            { -- shunt/nodes/marshal/main.yue:845
              from_id = FACTORY_PC_ID, -- shunt/nodes/marshal/main.yue:845
              packet = (function() -- shunt/nodes/marshal/main.yue:846
                local stations = { -- shunt/nodes/marshal/main.yue:848
                  known = { }, -- shunt/nodes/marshal/main.yue:848
                  unknown = { } -- shunt/nodes/marshal/main.yue:849
                } -- shunt/nodes/marshal/main.yue:847
                local stockpile = { -- shunt/nodes/marshal/main.yue:851
                  known = { }, -- shunt/nodes/marshal/main.yue:851
                  unknown = { }, -- shunt/nodes/marshal/main.yue:852
                  estimated_capacity = 0 -- shunt/nodes/marshal/main.yue:853
                } -- shunt/nodes/marshal/main.yue:850
                return FactoryHeartbeat(FACTORY_PC_ID, FACTORY_NAME, stations, stockpile) -- shunt/nodes/marshal/main.yue:854
              end)() -- shunt/nodes/marshal/main.yue:846
            }, -- shunt/nodes/marshal/main.yue:845
            { -- shunt/nodes/marshal/main.yue:855
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:855
              packet = MarshalIdentityRequest(idemp_tok, REQUESTER_PC_ID, FACTORY_NAME) -- shunt/nodes/marshal/main.yue:856
            } -- shunt/nodes/marshal/main.yue:855
          } -- shunt/nodes/marshal/main.yue:842
        })) -- shunt/nodes/marshal/main.yue:841
        local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:859
          id = function() -- shunt/nodes/marshal/main.yue:859
            return MARSHAL_PC_ID -- shunt/nodes/marshal/main.yue:859
          end -- shunt/nodes/marshal/main.yue:859
        })) -- shunt/nodes/marshal/main.yue:858
        do -- shunt/nodes/marshal/main.yue:860
          local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:860
            config = config, -- shunt/nodes/marshal/main.yue:860
            pc = pc, -- shunt/nodes/marshal/main.yue:860
            uplink = uplink, -- shunt/nodes/marshal/main.yue:860
            clock = TestClock() -- shunt/nodes/marshal/main.yue:860
          }) -- shunt/nodes/marshal/main.yue:860
          _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:861
          for _ = 1, 10 do -- shunt/nodes/marshal/main.yue:862
            _with_0:ut_step() -- shunt/nodes/marshal/main.yue:863
          end -- shunt/nodes/marshal/main.yue:863
        end -- shunt/nodes/marshal/main.yue:860
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(2))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(865)); -- shunt/nodes/marshal/main.yue:865
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:866
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:866
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:866
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:866
            resp = matches('no known factory') -- shunt/nodes/marshal/main.yue:866
          }), -- shunt/nodes/marshal/main.yue:866
          protocol = eq(MarshalIdentityResponse:protocol()) -- shunt/nodes/marshal/main.yue:866
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(866)); -- shunt/nodes/marshal/main.yue:866
        return require('shunt.spec')._expect_that([=[uplink.backend.sent[2]]=], uplink.backend.sent[2], (has_fields({ -- shunt/nodes/marshal/main.yue:872
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:872
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:872
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:872
            resp = eq(FACTORY_PC_ID) -- shunt/nodes/marshal/main.yue:872
          }), -- shunt/nodes/marshal/main.yue:872
          protocol = eq(MarshalIdentityResponse:protocol()) -- shunt/nodes/marshal/main.yue:872
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(872)) -- shunt/nodes/marshal/main.yue:877
      end) -- shunt/nodes/marshal/main.yue:877
    end) -- shunt/nodes/marshal/main.yue:799
    describe('\\on_get_config_request', function() -- shunt/nodes/marshal/main.yue:879
      return it('responds correctly', function() -- shunt/nodes/marshal/main.yue:880
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:881
        local REQUESTER_PC_ID = 1 -- shunt/nodes/marshal/main.yue:883
        local MARSHAL_PC_ID = 1 -- shunt/nodes/marshal/main.yue:884
        local RAW = '[config]\n' -- shunt/nodes/marshal/main.yue:885
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:888
          marshal = { -- shunt/nodes/marshal/main.yue:890
            network = 'mainline' -- shunt/nodes/marshal/main.yue:890
          } -- shunt/nodes/marshal/main.yue:889
        }, { -- shunt/nodes/marshal/main.yue:888
          __raw = RAW -- shunt/nodes/marshal/main.yue:888
        }) -- shunt/nodes/marshal/main.yue:887
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:892
          to_receive = { -- shunt/nodes/marshal/main.yue:893
            { -- shunt/nodes/marshal/main.yue:893
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:893
              packet = GetConfigRequest(idemp_tok, REQUESTER_PC_ID) -- shunt/nodes/marshal/main.yue:894
            } -- shunt/nodes/marshal/main.yue:893
          } -- shunt/nodes/marshal/main.yue:892
        })) -- shunt/nodes/marshal/main.yue:891
        local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:896
          id = function() -- shunt/nodes/marshal/main.yue:896
            return MARSHAL_PC_ID -- shunt/nodes/marshal/main.yue:896
          end -- shunt/nodes/marshal/main.yue:896
        })) -- shunt/nodes/marshal/main.yue:895
        do -- shunt/nodes/marshal/main.yue:897
          local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:897
            config = config, -- shunt/nodes/marshal/main.yue:897
            pc = pc, -- shunt/nodes/marshal/main.yue:897
            uplink = uplink, -- shunt/nodes/marshal/main.yue:897
            clock = TestClock() -- shunt/nodes/marshal/main.yue:897
          }) -- shunt/nodes/marshal/main.yue:897
          _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:898
          for _ = 1, 5 do -- shunt/nodes/marshal/main.yue:899
            _with_0:ut_step() -- shunt/nodes/marshal/main.yue:900
          end -- shunt/nodes/marshal/main.yue:900
        end -- shunt/nodes/marshal/main.yue:897
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(902)); -- shunt/nodes/marshal/main.yue:902
        return require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:903
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:903
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:903
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:903
            raw = eq(RAW) -- shunt/nodes/marshal/main.yue:903
          }), -- shunt/nodes/marshal/main.yue:903
          protocol = eq(GetConfigResponse:protocol()) -- shunt/nodes/marshal/main.yue:903
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(903)) -- shunt/nodes/marshal/main.yue:908
      end) -- shunt/nodes/marshal/main.yue:908
    end) -- shunt/nodes/marshal/main.yue:879
    describe('\\on_set_config_request', function() -- shunt/nodes/marshal/main.yue:910
      it('applies valid config', function() -- shunt/nodes/marshal/main.yue:911
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:912
        local REQUESTER_PC_ID = 1 -- shunt/nodes/marshal/main.yue:914
        local MARSHAL_PC_ID = 2 -- shunt/nodes/marshal/main.yue:915
        local NEW_RAW = [[          [marshal]
          key = 'value'
        ]] -- shunt/nodes/marshal/main.yue:916
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:922
          marshal = { } -- shunt/nodes/marshal/main.yue:923
        }, { -- shunt/nodes/marshal/main.yue:922
          __raw = '' -- shunt/nodes/marshal/main.yue:922
        }) -- shunt/nodes/marshal/main.yue:921
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:925
          to_receive = { -- shunt/nodes/marshal/main.yue:926
            { -- shunt/nodes/marshal/main.yue:926
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:926
              packet = SetConfigRequest(idemp_tok, REQUESTER_PC_ID, NEW_RAW) -- shunt/nodes/marshal/main.yue:927
            } -- shunt/nodes/marshal/main.yue:926
          } -- shunt/nodes/marshal/main.yue:925
        })) -- shunt/nodes/marshal/main.yue:924
        local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:930
          id = function() -- shunt/nodes/marshal/main.yue:930
            return MARSHAL_PC_ID -- shunt/nodes/marshal/main.yue:930
          end -- shunt/nodes/marshal/main.yue:930
        })) -- shunt/nodes/marshal/main.yue:929
        local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:931
          config = config, -- shunt/nodes/marshal/main.yue:931
          pc = pc, -- shunt/nodes/marshal/main.yue:931
          uplink = uplink, -- shunt/nodes/marshal/main.yue:931
          clock = TestClock() -- shunt/nodes/marshal/main.yue:931
        }) -- shunt/nodes/marshal/main.yue:931
        _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:932
        for _ = 1, 8 do -- shunt/nodes/marshal/main.yue:933
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:934
        end -- shunt/nodes/marshal/main.yue:934
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(936)); -- shunt/nodes/marshal/main.yue:936
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:937
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:937
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:937
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:937
            resp = eq(nil) -- shunt/nodes/marshal/main.yue:937
          }), -- shunt/nodes/marshal/main.yue:937
          protocol = eq(SetConfigResponse:protocol()) -- shunt/nodes/marshal/main.yue:937
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(937)); -- shunt/nodes/marshal/main.yue:937
        require('shunt.spec')._expect_that([=[\ut_config!]=], _with_0:ut_config(), (deep_eq({ -- shunt/nodes/marshal/main.yue:943
          marshal = { -- shunt/nodes/marshal/main.yue:943
            key = 'value' -- shunt/nodes/marshal/main.yue:943
          } -- shunt/nodes/marshal/main.yue:943
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(943)); -- shunt/nodes/marshal/main.yue:943
        require('shunt.spec')._expect_that([=[\ut_config!.<raw>]=], getmetatable(_with_0:ut_config()).__raw, (eq(NEW_RAW)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(946)) -- shunt/nodes/marshal/main.yue:946
        return _with_0 -- shunt/nodes/marshal/main.yue:931
      end) -- shunt/nodes/marshal/main.yue:911
      return it('rejects invalid config', function() -- shunt/nodes/marshal/main.yue:948
        local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/main.yue:949
        local REQUESTER_PC_ID = 1 -- shunt/nodes/marshal/main.yue:951
        local MARSHAL_PC_ID = 2 -- shunt/nodes/marshal/main.yue:952
        local NEW_RAW = '[invalid-config]\n' -- shunt/nodes/marshal/main.yue:953
        local ORIGINAL_RAW = [[          [marshal]
        ]] -- shunt/nodes/marshal/main.yue:954
        local config = setmetatable({ -- shunt/nodes/marshal/main.yue:959
          marshal = { } -- shunt/nodes/marshal/main.yue:960
        }, { -- shunt/nodes/marshal/main.yue:959
          __raw = ORIGINAL_RAW -- shunt/nodes/marshal/main.yue:959
        }) -- shunt/nodes/marshal/main.yue:958
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:962
          to_receive = { -- shunt/nodes/marshal/main.yue:963
            { -- shunt/nodes/marshal/main.yue:963
              from_id = REQUESTER_PC_ID, -- shunt/nodes/marshal/main.yue:963
              packet = SetConfigRequest(idemp_tok, REQUESTER_PC_ID, NEW_RAW) -- shunt/nodes/marshal/main.yue:964
            } -- shunt/nodes/marshal/main.yue:963
          } -- shunt/nodes/marshal/main.yue:962
        })) -- shunt/nodes/marshal/main.yue:961
        local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:966
          id = function() -- shunt/nodes/marshal/main.yue:966
            return MARSHAL_PC_ID -- shunt/nodes/marshal/main.yue:966
          end -- shunt/nodes/marshal/main.yue:966
        })) -- shunt/nodes/marshal/main.yue:965
        local _with_0 = Marshal({ -- shunt/nodes/marshal/main.yue:967
          config = config, -- shunt/nodes/marshal/main.yue:967
          pc = pc, -- shunt/nodes/marshal/main.yue:967
          uplink = uplink, -- shunt/nodes/marshal/main.yue:967
          clock = TestClock() -- shunt/nodes/marshal/main.yue:967
        }) -- shunt/nodes/marshal/main.yue:967
        _with_0:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:968
        for _ = 1, 5 do -- shunt/nodes/marshal/main.yue:969
          _with_0:ut_step() -- shunt/nodes/marshal/main.yue:970
        end -- shunt/nodes/marshal/main.yue:970
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(972)); -- shunt/nodes/marshal/main.yue:972
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/marshal/main.yue:973
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/marshal/main.yue:973
          packet = has_fields({ -- shunt/nodes/marshal/main.yue:973
            idemp_tok = eq(idemp_tok), -- shunt/nodes/marshal/main.yue:973
            error_reason = matches('at field %.marshal') -- shunt/nodes/marshal/main.yue:973
          }), -- shunt/nodes/marshal/main.yue:973
          protocol = eq(SetConfigResponse:protocol()) -- shunt/nodes/marshal/main.yue:973
        })), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(973)); -- shunt/nodes/marshal/main.yue:973
        require('shunt.spec')._expect_that([=[\ut_config!]=], _with_0:ut_config(), (deep_eq(config)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(979)); -- shunt/nodes/marshal/main.yue:979
        require('shunt.spec')._expect_that([=[\ut_config!.<raw>]=], getmetatable(_with_0:ut_config()).__raw, (eq(ORIGINAL_RAW)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(980)) -- shunt/nodes/marshal/main.yue:980
        return _with_0 -- shunt/nodes/marshal/main.yue:967
      end) -- shunt/nodes/marshal/main.yue:980
    end) -- shunt/nodes/marshal/main.yue:910
    return it('avoids spam', function() -- shunt/nodes/marshal/main.yue:982
      local RESOURCE = 'minecraft:dirt' -- shunt/nodes/marshal/main.yue:983
      local shortage_stations = { -- shunt/nodes/marshal/main.yue:985
        known = { -- shunt/nodes/marshal/main.yue:986
          { -- shunt/nodes/marshal/main.yue:986
            name = 'shortage_station', -- shunt/nodes/marshal/main.yue:986
            network = 'mainline', -- shunt/nodes/marshal/main.yue:987
            type = 'inbound', -- shunt/nodes/marshal/main.yue:988
            handles = RESOURCE, -- shunt/nodes/marshal/main.yue:989
            capacity = 1, -- shunt/nodes/marshal/main.yue:990
            present_trains = { -- shunt/nodes/marshal/main.yue:992
              'train' -- shunt/nodes/marshal/main.yue:992
            } -- shunt/nodes/marshal/main.yue:991
          } -- shunt/nodes/marshal/main.yue:986
        }, -- shunt/nodes/marshal/main.yue:985
        unknown = { } -- shunt/nodes/marshal/main.yue:993
      } -- shunt/nodes/marshal/main.yue:984
      local shortage_stockpile = { -- shunt/nodes/marshal/main.yue:995
        known = { -- shunt/nodes/marshal/main.yue:996
          { -- shunt/nodes/marshal/main.yue:996
            name = RESOURCE, -- shunt/nodes/marshal/main.yue:996
            stored = 0, -- shunt/nodes/marshal/main.yue:997
            shortage_amount = 64 -- shunt/nodes/marshal/main.yue:998
          } -- shunt/nodes/marshal/main.yue:996
        }, -- shunt/nodes/marshal/main.yue:995
        unknown = { }, -- shunt/nodes/marshal/main.yue:999
        estimated_capacity = 64 -- shunt/nodes/marshal/main.yue:1000
      } -- shunt/nodes/marshal/main.yue:994
      local shortage_factory = { -- shunt/nodes/marshal/main.yue:1002
        name = 'shortage_factory', -- shunt/nodes/marshal/main.yue:1002
        pc_id = 1, -- shunt/nodes/marshal/main.yue:1003
        last_seen_epoch = 0, -- shunt/nodes/marshal/main.yue:1004
        last_seen_epoch = 0, -- shunt/nodes/marshal/main.yue:1005
        stations = shortage_stations, -- shunt/nodes/marshal/main.yue:1006
        stockpile = shortage_stockpile -- shunt/nodes/marshal/main.yue:1007
      } -- shunt/nodes/marshal/main.yue:1001
      local shortage_heartbeat = FactoryHeartbeat(shortage_factory.pc_id, shortage_factory.name, shortage_stations, shortage_stockpile) -- shunt/nodes/marshal/main.yue:1008
      local surplus_stations = { -- shunt/nodes/marshal/main.yue:1014
        known = { -- shunt/nodes/marshal/main.yue:1015
          { -- shunt/nodes/marshal/main.yue:1015
            name = 'surplus_station', -- shunt/nodes/marshal/main.yue:1015
            network = 'mainline', -- shunt/nodes/marshal/main.yue:1016
            type = 'outbound', -- shunt/nodes/marshal/main.yue:1017
            handles = RESOURCE, -- shunt/nodes/marshal/main.yue:1018
            capacity = 1, -- shunt/nodes/marshal/main.yue:1019
            present_trains = { -- shunt/nodes/marshal/main.yue:1021
              'train' -- shunt/nodes/marshal/main.yue:1021
            } -- shunt/nodes/marshal/main.yue:1020
          } -- shunt/nodes/marshal/main.yue:1015
        }, -- shunt/nodes/marshal/main.yue:1014
        unknown = { } -- shunt/nodes/marshal/main.yue:1022
      } -- shunt/nodes/marshal/main.yue:1013
      local surplus_stockpile = { -- shunt/nodes/marshal/main.yue:1024
        known = { -- shunt/nodes/marshal/main.yue:1025
          { -- shunt/nodes/marshal/main.yue:1025
            name = RESOURCE, -- shunt/nodes/marshal/main.yue:1025
            stored = 128, -- shunt/nodes/marshal/main.yue:1026
            surplus_amount = 64 -- shunt/nodes/marshal/main.yue:1027
          } -- shunt/nodes/marshal/main.yue:1025
        }, -- shunt/nodes/marshal/main.yue:1024
        unknown = { }, -- shunt/nodes/marshal/main.yue:1028
        estimated_capacity = 128 -- shunt/nodes/marshal/main.yue:1029
      } -- shunt/nodes/marshal/main.yue:1023
      local surplus_factory = { -- shunt/nodes/marshal/main.yue:1031
        name = 'surplus_factory', -- shunt/nodes/marshal/main.yue:1031
        pc_id = 1, -- shunt/nodes/marshal/main.yue:1032
        last_seen_epoch = 0, -- shunt/nodes/marshal/main.yue:1033
        last_seen_epoch = 0, -- shunt/nodes/marshal/main.yue:1034
        stations = surplus_stations, -- shunt/nodes/marshal/main.yue:1035
        stockpile = surplus_stockpile -- shunt/nodes/marshal/main.yue:1036
      } -- shunt/nodes/marshal/main.yue:1030
      local surplus_heartbeat = FactoryHeartbeat(surplus_factory.pc_id, surplus_factory.name, surplus_stations, surplus_stockpile) -- shunt/nodes/marshal/main.yue:1037
      local test_phase = 'setup' -- shunt/nodes/marshal/main.yue:1042
      local uplink = Uplink((function() -- shunt/nodes/marshal/main.yue:1043
        local schedule_request_pc_id = nil -- shunt/nodes/marshal/main.yue:1044
        local schedule_request_idemp_tok = nil -- shunt/nodes/marshal/main.yue:1045
        return TestUplinkBackend({ -- shunt/nodes/marshal/main.yue:1047
          on_send = function(self, pc_id, pkt, protocol) -- shunt/nodes/marshal/main.yue:1047
            if protocol == 'ScheduleRequest' then -- shunt/nodes/marshal/main.yue:1048
              schedule_request_pc_id = pc_id -- shunt/nodes/marshal/main.yue:1049
              schedule_request_idemp_tok = pkt.idemp_tok -- shunt/nodes/marshal/main.yue:1050
            end -- shunt/nodes/marshal/main.yue:1048
            return true -- shunt/nodes/marshal/main.yue:1051
          end, -- shunt/nodes/marshal/main.yue:1047
          on_receive = function(self, protocol_filter, _) -- shunt/nodes/marshal/main.yue:1052
            if (schedule_request_pc_id ~= nil) then -- shunt/nodes/marshal/main.yue:1053
              assert((schedule_request_idemp_tok ~= nil), 'schedule request idemp tok not set') -- shunt/nodes/marshal/main.yue:1054
              local pc_id = schedule_request_pc_id -- shunt/nodes/marshal/main.yue:1056
              schedule_request_pc_id = nil -- shunt/nodes/marshal/main.yue:1057
              local idemp_tok = schedule_request_idemp_tok -- shunt/nodes/marshal/main.yue:1059
              schedule_request_idemp_tok = nil -- shunt/nodes/marshal/main.yue:1060
              local pkt = ScheduleResponse(idemp_tok, nil) -- shunt/nodes/marshal/main.yue:1062
              return pc_id, pkt, pkt.protocol -- shunt/nodes/marshal/main.yue:1063
            end -- shunt/nodes/marshal/main.yue:1053
            return nil, nil, nil -- shunt/nodes/marshal/main.yue:1064
          end, -- shunt/nodes/marshal/main.yue:1052
          to_receive = function() -- shunt/nodes/marshal/main.yue:1065
            local _with_0 = { } -- shunt/nodes/marshal/main.yue:1066
            if 'setup' == test_phase then -- shunt/nodes/marshal/main.yue:1068
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/main.yue:1070
                from_id = surplus_heartbeat.pc_id, -- shunt/nodes/marshal/main.yue:1070
                packet = surplus_heartbeat -- shunt/nodes/marshal/main.yue:1071
              } -- shunt/nodes/marshal/main.yue:1069
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/main.yue:1073
                from_id = shortage_heartbeat.pc_id, -- shunt/nodes/marshal/main.yue:1073
                packet = shortage_heartbeat -- shunt/nodes/marshal/main.yue:1074
              } -- shunt/nodes/marshal/main.yue:1072
            elseif 'spam-trigger' == test_phase then -- shunt/nodes/marshal/main.yue:1075
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/main.yue:1077
                from_id = shortage_heartbeat.pc_id, -- shunt/nodes/marshal/main.yue:1077
                packet = shortage_heartbeat -- shunt/nodes/marshal/main.yue:1078
              } -- shunt/nodes/marshal/main.yue:1076
            else -- shunt/nodes/marshal/main.yue:1080
              error("internal error: unknown test phase '" .. tostring(test_phase) .. "'") -- shunt/nodes/marshal/main.yue:1080
            end -- shunt/nodes/marshal/main.yue:1080
            return _with_0 -- shunt/nodes/marshal/main.yue:1066
          end -- shunt/nodes/marshal/main.yue:1065
        }) -- shunt/nodes/marshal/main.yue:1080
      end)()) -- shunt/nodes/marshal/main.yue:1043
      RESOURCE = 'minecraft:dirt' -- shunt/nodes/marshal/main.yue:1082
      local resend_cooldown_seconds = 4096 -- shunt/nodes/marshal/main.yue:1084
      local config = setmetatable({ -- shunt/nodes/marshal/main.yue:1086
        marshal = { -- shunt/nodes/marshal/main.yue:1088
          resend_cooldown_seconds = resend_cooldown_seconds -- shunt/nodes/marshal/main.yue:1088
        } -- shunt/nodes/marshal/main.yue:1087
      }, { -- shunt/nodes/marshal/main.yue:1086
        __raw = '' -- shunt/nodes/marshal/main.yue:1086
      }) -- shunt/nodes/marshal/main.yue:1085
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/main.yue:1090
      local clock = TestClock() -- shunt/nodes/marshal/main.yue:1091
      local pc = Pc(TestPcBackend({ -- shunt/nodes/marshal/main.yue:1093
        id = function(self) -- shunt/nodes/marshal/main.yue:1093
          return 0 -- shunt/nodes/marshal/main.yue:1093
        end -- shunt/nodes/marshal/main.yue:1093
      })) -- shunt/nodes/marshal/main.yue:1092
      local marshal = Marshal({ -- shunt/nodes/marshal/main.yue:1095
        config = config, -- shunt/nodes/marshal/main.yue:1095
        pc = pc, -- shunt/nodes/marshal/main.yue:1096
        uplink = uplink, -- shunt/nodes/marshal/main.yue:1097
        rand = rand, -- shunt/nodes/marshal/main.yue:1098
        clock = clock -- shunt/nodes/marshal/main.yue:1099
      }) -- shunt/nodes/marshal/main.yue:1094
      marshal:ut_stop_counting_epochs() -- shunt/nodes/marshal/main.yue:1100
      local candidates = F('() -> [Schedule]', function() -- shunt/nodes/marshal/main.yue:1102
        uplink.backend:reset() -- shunt/nodes/marshal/main.yue:1103
        local reached_inactivity = false -- shunt/nodes/marshal/main.yue:1105
        for i = 1, 25 do -- shunt/nodes/marshal/main.yue:1106
          marshal:ut_step() -- shunt/nodes/marshal/main.yue:1107
          if not marshal:ut_active() then -- shunt/nodes/marshal/main.yue:1108
            reached_inactivity = true -- shunt/nodes/marshal/main.yue:1109
            break -- shunt/nodes/marshal/main.yue:1110
          end -- shunt/nodes/marshal/main.yue:1108
        end -- shunt/nodes/marshal/main.yue:1110
        require('shunt.spec')._assert_that([=[reached_inactivity]=], reached_inactivity, (eq(true)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1111)) -- shunt/nodes/marshal/main.yue:1111
        local _with_0 = { } -- shunt/nodes/marshal/main.yue:1113
        local _list_0 = uplink.backend.sent -- shunt/nodes/marshal/main.yue:1114
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/main.yue:1114
          local _des_0 = _list_0[_index_0] -- shunt/nodes/marshal/main.yue:1114
          local protocol, schedule = _des_0.protocol, _des_0.packet.schedule -- shunt/nodes/marshal/main.yue:1114
          if protocol == 'ScheduleRequest' then -- shunt/nodes/marshal/main.yue:1115
            _with_0[#_with_0 + 1] = schedule -- shunt/nodes/marshal/main.yue:1116
          end -- shunt/nodes/marshal/main.yue:1115
        end -- shunt/nodes/marshal/main.yue:1116
        return _with_0 -- shunt/nodes/marshal/main.yue:1113
      end); -- shunt/nodes/marshal/main.yue:1102
      require('shunt.spec')._assert_that([=[#candidates!]=], #candidates(), (eq(1)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1118)); -- shunt/nodes/marshal/main.yue:1118
      require('shunt.spec')._expect_that([=[#candidates!]=], #candidates(), (eq(0)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1119)) -- shunt/nodes/marshal/main.yue:1119
      marshal.scheduler:ut_break_all_promises(); -- shunt/nodes/marshal/main.yue:1120
      require('shunt.spec')._expect_that([=[#candidates!]=], #candidates(), (eq(0)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1121)); -- shunt/nodes/marshal/main.yue:1121
      require('shunt.spec')._assert_that([=[(marshal\ut_is_on_cooldown shortage_factory.name, RESOURCE)]=], (marshal:ut_is_on_cooldown(shortage_factory.name, RESOURCE)), (eq(true)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1122)) -- shunt/nodes/marshal/main.yue:1122
      marshal.resource_orchestrator:ut_release_all_cooldowns() -- shunt/nodes/marshal/main.yue:1124
      marshal.scheduler:ut_break_all_promises(); -- shunt/nodes/marshal/main.yue:1125
      require('shunt.spec')._assert_that([=[#candidates!]=], #candidates(), (eq(1)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1126)); -- shunt/nodes/marshal/main.yue:1126
      require('shunt.spec')._expect_that([=[#candidates!]=], #candidates(), (eq(0)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1127)) -- shunt/nodes/marshal/main.yue:1127
      marshal.scheduler:ut_break_all_promises(); -- shunt/nodes/marshal/main.yue:1129
      require('shunt.spec')._assert_that([=[#candidates!]=], #candidates(), (eq(0)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1130)) -- shunt/nodes/marshal/main.yue:1130
      clock.time = clock.time + resend_cooldown_seconds; -- shunt/nodes/marshal/main.yue:1131
      return require('shunt.spec')._expect_that([=[#candidates!]=], #candidates(), (eq(1)), tostring("shunt/nodes/marshal/main.yue") .. ":" .. tostring(1132)) -- shunt/nodes/marshal/main.yue:1132
    end) -- shunt/nodes/marshal/main.yue:1132
  end) -- shunt/nodes/marshal/main.yue:1132
end) -- shunt/nodes/marshal/main.yue:525
return _module_0 -- shunt/nodes/marshal/main.yue:1132
end
package.preload['shunt.clock'] = function(...)
-- [yue]: shunt/clock.yue
local _module_0 = { } -- shunt/clock.yue:1
local declare_type, F -- shunt/clock.yue:0
do -- shunt/clock.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/clock.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/clock.yue:0
end -- shunt/clock.yue:0
declare_type('Clock', [[{
  now: () => number,
}]]) -- shunt/clock.yue:5
local MinecraftClock -- shunt/clock.yue:9
do -- shunt/clock.yue:9
  local _class_0 -- shunt/clock.yue:9
  local _base_0 = { -- shunt/clock.yue:9
    now = F('() => number', function(self) -- shunt/clock.yue:10
      return os.epoch() / 1000 -- shunt/clock.yue:11
    end) -- shunt/clock.yue:9
  } -- shunt/clock.yue:9
  if _base_0.__index == nil then -- shunt/clock.yue:9
    _base_0.__index = _base_0 -- shunt/clock.yue:9
  end -- shunt/clock.yue:11
  _class_0 = setmetatable({ -- shunt/clock.yue:9
    __init = function() end, -- shunt/clock.yue:9
    __base = _base_0, -- shunt/clock.yue:9
    __name = "MinecraftClock" -- shunt/clock.yue:9
  }, { -- shunt/clock.yue:9
    __index = _base_0, -- shunt/clock.yue:9
    __call = function(cls, ...) -- shunt/clock.yue:9
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clock.yue:9
      cls.__init(_self_0, ...) -- shunt/clock.yue:9
      return _self_0 -- shunt/clock.yue:9
    end -- shunt/clock.yue:9
  }) -- shunt/clock.yue:9
  _base_0.__class = _class_0 -- shunt/clock.yue:9
  MinecraftClock = _class_0 -- shunt/clock.yue:9
end -- shunt/clock.yue:11
_module_0["MinecraftClock"] = MinecraftClock -- shunt/clock.yue:9
local TestClock -- shunt/clock.yue:13
do -- shunt/clock.yue:13
  local _class_0 -- shunt/clock.yue:13
  local _base_0 = { -- shunt/clock.yue:13
    now = F('() => number', function(self) -- shunt/clock.yue:17
      return self.time -- shunt/clock.yue:18
    end) -- shunt/clock.yue:13
  } -- shunt/clock.yue:13
  if _base_0.__index == nil then -- shunt/clock.yue:13
    _base_0.__index = _base_0 -- shunt/clock.yue:13
  end -- shunt/clock.yue:18
  _class_0 = setmetatable({ -- shunt/clock.yue:13
    __init = F('() => <>', function(self) -- shunt/clock.yue:14
      self.time = 0 -- shunt/clock.yue:15
    end), -- shunt/clock.yue:13
    __base = _base_0, -- shunt/clock.yue:13
    __name = "TestClock" -- shunt/clock.yue:13
  }, { -- shunt/clock.yue:13
    __index = _base_0, -- shunt/clock.yue:13
    __call = function(cls, ...) -- shunt/clock.yue:13
      local _self_0 = setmetatable({ }, _base_0) -- shunt/clock.yue:13
      cls.__init(_self_0, ...) -- shunt/clock.yue:13
      return _self_0 -- shunt/clock.yue:13
    end -- shunt/clock.yue:13
  }) -- shunt/clock.yue:13
  _base_0.__class = _class_0 -- shunt/clock.yue:13
  TestClock = _class_0 -- shunt/clock.yue:13
end -- shunt/clock.yue:18
_module_0["TestClock"] = TestClock -- shunt/clock.yue:13
return _module_0 -- shunt/clock.yue:18
end
package.preload['shunt.cmd.declare'] = function(...)
-- [yue]: shunt/cmd/declare.yue
local _module_0 = { } -- shunt/cmd/declare.yue:1
local subcommand, main, Declarer -- shunt/cmd/declare.yue:1
local DeclareTrainState -- shunt/cmd/declare.yue:2
local DeclareTrainStateResponse -- shunt/cmd/declare.yue:3
local Flag, Param, Subcommand -- shunt/cmd/declare.yue:0
do -- shunt/cmd/declare.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/declare.yue:0
  Flag, Param, Subcommand = _obj_0.Flag, _obj_0.Param, _obj_0.Subcommand -- shunt/cmd/declare.yue:0
end -- shunt/cmd/declare.yue:0
local Pc = require('shunt.pc').Pc -- shunt/cmd/declare.yue:0
local IdempotenceToken, Packet, TIMEOUT, Uplink -- shunt/cmd/declare.yue:0
do -- shunt/cmd/declare.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/cmd/declare.yue:0
  IdempotenceToken, Packet, TIMEOUT, Uplink = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.TIMEOUT, _obj_0.Uplink -- shunt/cmd/declare.yue:0
end -- shunt/cmd/declare.yue:0
local declare_type, F -- shunt/cmd/declare.yue:0
do -- shunt/cmd/declare.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/declare.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/cmd/declare.yue:0
end -- shunt/cmd/declare.yue:0
local spec = require('shunt.spec').spec -- shunt/cmd/declare.yue:0
declare_type('DeclareArgs', [[{
  train: ?{
    name: string,
    state: TrainState,
  },
}]]) -- shunt/cmd/declare.yue:11
declare_type('TrainState', '"cleared"|"reserved"') -- shunt/cmd/declare.yue:17
do -- shunt/cmd/declare.yue:18
  local _with_0 = Subcommand('declare') -- shunt/cmd/declare.yue:18
  _with_0:description('make declarations about the state of the system') -- shunt/cmd/declare.yue:19
  _with_0:add((function() -- shunt/cmd/declare.yue:20
    local _with_1 = Subcommand('train') -- shunt/cmd/declare.yue:20
    _with_1:description('declare things about trains') -- shunt/cmd/declare.yue:21
    _with_1:add((function() -- shunt/cmd/declare.yue:22
      local _with_2 = Param('name') -- shunt/cmd/declare.yue:22
      _with_2:description('name of the train') -- shunt/cmd/declare.yue:23
      return _with_2 -- shunt/cmd/declare.yue:22
    end)()) -- shunt/cmd/declare.yue:22
    _with_1:add((function() -- shunt/cmd/declare.yue:24
      local _with_2 = Param('state') -- shunt/cmd/declare.yue:24
      _with_2:description('new state of the train') -- shunt/cmd/declare.yue:25
      _with_2:options({ -- shunt/cmd/declare.yue:27
        'cleared', -- shunt/cmd/declare.yue:27
        'reserved' -- shunt/cmd/declare.yue:28
      }) -- shunt/cmd/declare.yue:26
      return _with_2 -- shunt/cmd/declare.yue:24
    end)()) -- shunt/cmd/declare.yue:24
    return _with_1 -- shunt/cmd/declare.yue:20
  end)()) -- shunt/cmd/declare.yue:20
  subcommand = _with_0 -- shunt/cmd/declare.yue:18
end -- shunt/cmd/declare.yue:18
_module_0["subcommand"] = subcommand -- shunt/cmd/declare.yue:28
main = F('({}) -> <>', function(args) -- shunt/cmd/declare.yue:30
  local _with_0 = Declarer(Uplink(), Pc()) -- shunt/cmd/declare.yue:31
  local err -- shunt/cmd/declare.yue:32
  if (args.train ~= nil) then -- shunt/cmd/declare.yue:32
    local name, state -- shunt/cmd/declare.yue:33
    do -- shunt/cmd/declare.yue:33
      local _obj_0 = args.train -- shunt/cmd/declare.yue:33
      name, state = _obj_0.name, _obj_0.state -- shunt/cmd/declare.yue:33
    end -- shunt/cmd/declare.yue:33
    err = _with_0:declare_train_state(name, state) -- shunt/cmd/declare.yue:34
  else -- shunt/cmd/declare.yue:36
    err = error('internal error: nothing to declare') -- shunt/cmd/declare.yue:36
  end -- shunt/cmd/declare.yue:32
  if (err ~= nil) then -- shunt/cmd/declare.yue:38
    print("cannot make declaration: " .. tostring(err)) -- shunt/cmd/declare.yue:39
  end -- shunt/cmd/declare.yue:38
  return _with_0 -- shunt/cmd/declare.yue:31
end) -- shunt/cmd/declare.yue:30
_module_0["main"] = main -- shunt/cmd/declare.yue:39
do -- shunt/cmd/declare.yue:41
  local _class_0 -- shunt/cmd/declare.yue:41
  local _base_0 = { -- shunt/cmd/declare.yue:41
    declare_train_state = F('(string, TrainState) => ?string', function(self, train_name, state) -- shunt/cmd/declare.yue:44
      local idemp_tok = IdempotenceToken() -- shunt/cmd/declare.yue:45
      self.uplink:broadcast(DeclareTrainState(idemp_tok, self.pc:id(), train_name, state)) -- shunt/cmd/declare.yue:46
      local MAX_ATTEMPTS = 3 -- shunt/cmd/declare.yue:48
      for i = 1, MAX_ATTEMPTS do -- shunt/cmd/declare.yue:49
        local _continue_0 = false -- shunt/cmd/declare.yue:50
        repeat -- shunt/cmd/declare.yue:50
          if i > 1 then -- shunt/cmd/declare.yue:50
            print("awaiting response (attempt " .. tostring(i) .. "/" .. tostring(MAX_ATTEMPTS) .. ")") -- shunt/cmd/declare.yue:51
          end -- shunt/cmd/declare.yue:50
          local _, resp = self.uplink:receive_from_any(DeclareTrainStateResponse, { -- shunt/cmd/declare.yue:53
            timeout = 5 -- shunt/cmd/declare.yue:53
          }) -- shunt/cmd/declare.yue:53
          if resp == TIMEOUT then -- shunt/cmd/declare.yue:54
            _continue_0 = true -- shunt/cmd/declare.yue:55
            break -- shunt/cmd/declare.yue:55
          end -- shunt/cmd/declare.yue:54
          if resp.idemp_tok ~= idemp_tok then -- shunt/cmd/declare.yue:56
            _continue_0 = true -- shunt/cmd/declare.yue:57
            break -- shunt/cmd/declare.yue:57
          end -- shunt/cmd/declare.yue:56
          do -- shunt/cmd/declare.yue:58
            return resp.error_reason -- shunt/cmd/declare.yue:58
          end -- shunt/cmd/declare.yue:58
          _continue_0 = true -- shunt/cmd/declare.yue:50
        until true -- shunt/cmd/declare.yue:58
        if not _continue_0 then -- shunt/cmd/declare.yue:58
          break -- shunt/cmd/declare.yue:58
        end -- shunt/cmd/declare.yue:58
      end -- shunt/cmd/declare.yue:58
      return "no response from marshal after " .. tostring(MAX_ATTEMPTS) .. " attempts" -- shunt/cmd/declare.yue:59
    end) -- shunt/cmd/declare.yue:41
  } -- shunt/cmd/declare.yue:41
  if _base_0.__index == nil then -- shunt/cmd/declare.yue:41
    _base_0.__index = _base_0 -- shunt/cmd/declare.yue:41
  end -- shunt/cmd/declare.yue:59
  _class_0 = setmetatable({ -- shunt/cmd/declare.yue:41
    __init = F('(Uplink, Pc) => <>', function(self, uplink, pc) -- shunt/cmd/declare.yue:42
      self.uplink = uplink -- shunt/cmd/declare.yue:42
      self.pc = pc -- shunt/cmd/declare.yue:42
    end), -- shunt/cmd/declare.yue:41
    __base = _base_0, -- shunt/cmd/declare.yue:41
    __name = "Declarer" -- shunt/cmd/declare.yue:41
  }, { -- shunt/cmd/declare.yue:41
    __index = _base_0, -- shunt/cmd/declare.yue:41
    __call = function(cls, ...) -- shunt/cmd/declare.yue:41
      local _self_0 = setmetatable({ }, _base_0) -- shunt/cmd/declare.yue:41
      cls.__init(_self_0, ...) -- shunt/cmd/declare.yue:41
      return _self_0 -- shunt/cmd/declare.yue:41
    end -- shunt/cmd/declare.yue:41
  }) -- shunt/cmd/declare.yue:41
  _base_0.__class = _class_0 -- shunt/cmd/declare.yue:41
  Declarer = _class_0 -- shunt/cmd/declare.yue:41
end -- shunt/cmd/declare.yue:59
declare_type('DeclareTrainState', [[{
  idemp_tok: IdempotenceToken,
  pc_id: number,
  train_name: string,
  state: TrainState,
}]]) -- shunt/cmd/declare.yue:61
do -- shunt/cmd/declare.yue:67
  local _class_0 -- shunt/cmd/declare.yue:67
  local _parent_0 = Packet -- shunt/cmd/declare.yue:67
  local _base_0 = { } -- shunt/cmd/declare.yue:67
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/cmd/declare.yue:69
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/cmd/declare.yue:67
      _base_0[_key_0] = _val_0 -- shunt/cmd/declare.yue:67
    end -- shunt/cmd/declare.yue:67
  end -- shunt/cmd/declare.yue:69
  if _base_0.__index == nil then -- shunt/cmd/declare.yue:67
    _base_0.__index = _base_0 -- shunt/cmd/declare.yue:67
  end -- shunt/cmd/declare.yue:69
  setmetatable(_base_0, _parent_0.__base) -- shunt/cmd/declare.yue:67
  _class_0 = setmetatable({ -- shunt/cmd/declare.yue:67
    __init = F('(IdempotenceToken, number, string, TrainState) => <>', function(self, idemp_tok, pc_id, train_name, state) -- shunt/cmd/declare.yue:68
      self.idemp_tok = idemp_tok -- shunt/cmd/declare.yue:68
      self.pc_id = pc_id -- shunt/cmd/declare.yue:68
      self.train_name = train_name -- shunt/cmd/declare.yue:68
      self.state = state -- shunt/cmd/declare.yue:68
      return _class_0.__parent.__init(self) -- shunt/cmd/declare.yue:69
    end), -- shunt/cmd/declare.yue:67
    __base = _base_0, -- shunt/cmd/declare.yue:67
    __name = "DeclareTrainState", -- shunt/cmd/declare.yue:67
    __parent = _parent_0 -- shunt/cmd/declare.yue:67
  }, { -- shunt/cmd/declare.yue:67
    __index = function(cls, name) -- shunt/cmd/declare.yue:67
      local val = rawget(_base_0, name) -- shunt/cmd/declare.yue:67
      if val == nil then -- shunt/cmd/declare.yue:67
        local parent = rawget(cls, "__parent") -- shunt/cmd/declare.yue:67
        if parent then -- shunt/cmd/declare.yue:67
          return parent[name] -- shunt/cmd/declare.yue:67
        end -- shunt/cmd/declare.yue:67
      else -- shunt/cmd/declare.yue:67
        return val -- shunt/cmd/declare.yue:67
      end -- shunt/cmd/declare.yue:67
    end, -- shunt/cmd/declare.yue:67
    __call = function(cls, ...) -- shunt/cmd/declare.yue:67
      local _self_0 = setmetatable({ }, _base_0) -- shunt/cmd/declare.yue:67
      cls.__init(_self_0, ...) -- shunt/cmd/declare.yue:67
      return _self_0 -- shunt/cmd/declare.yue:67
    end -- shunt/cmd/declare.yue:67
  }) -- shunt/cmd/declare.yue:67
  _base_0.__class = _class_0 -- shunt/cmd/declare.yue:67
  if _parent_0.__inherited then -- shunt/cmd/declare.yue:67
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/cmd/declare.yue:67
  end -- shunt/cmd/declare.yue:67
  DeclareTrainState = _class_0 -- shunt/cmd/declare.yue:67
end -- shunt/cmd/declare.yue:69
_module_0["DeclareTrainState"] = DeclareTrainState -- shunt/cmd/declare.yue:67
declare_type('DeclareTrainStateResponse', [[{
  idemp_tok: IdempotenceToken,
  error_reason: ?string,
}]]) -- shunt/cmd/declare.yue:71
do -- shunt/cmd/declare.yue:75
  local _class_0 -- shunt/cmd/declare.yue:75
  local _parent_0 = Packet -- shunt/cmd/declare.yue:75
  local _base_0 = { } -- shunt/cmd/declare.yue:75
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/cmd/declare.yue:77
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/cmd/declare.yue:75
      _base_0[_key_0] = _val_0 -- shunt/cmd/declare.yue:75
    end -- shunt/cmd/declare.yue:75
  end -- shunt/cmd/declare.yue:77
  if _base_0.__index == nil then -- shunt/cmd/declare.yue:75
    _base_0.__index = _base_0 -- shunt/cmd/declare.yue:75
  end -- shunt/cmd/declare.yue:77
  setmetatable(_base_0, _parent_0.__base) -- shunt/cmd/declare.yue:75
  _class_0 = setmetatable({ -- shunt/cmd/declare.yue:75
    __init = F('(IdempotenceToken, ?string) => <>', function(self, idemp_tok, error_reason) -- shunt/cmd/declare.yue:76
      self.idemp_tok = idemp_tok -- shunt/cmd/declare.yue:76
      self.error_reason = error_reason -- shunt/cmd/declare.yue:76
      return _class_0.__parent.__init(self) -- shunt/cmd/declare.yue:77
    end), -- shunt/cmd/declare.yue:75
    __base = _base_0, -- shunt/cmd/declare.yue:75
    __name = "DeclareTrainStateResponse", -- shunt/cmd/declare.yue:75
    __parent = _parent_0 -- shunt/cmd/declare.yue:75
  }, { -- shunt/cmd/declare.yue:75
    __index = function(cls, name) -- shunt/cmd/declare.yue:75
      local val = rawget(_base_0, name) -- shunt/cmd/declare.yue:75
      if val == nil then -- shunt/cmd/declare.yue:75
        local parent = rawget(cls, "__parent") -- shunt/cmd/declare.yue:75
        if parent then -- shunt/cmd/declare.yue:75
          return parent[name] -- shunt/cmd/declare.yue:75
        end -- shunt/cmd/declare.yue:75
      else -- shunt/cmd/declare.yue:75
        return val -- shunt/cmd/declare.yue:75
      end -- shunt/cmd/declare.yue:75
    end, -- shunt/cmd/declare.yue:75
    __call = function(cls, ...) -- shunt/cmd/declare.yue:75
      local _self_0 = setmetatable({ }, _base_0) -- shunt/cmd/declare.yue:75
      cls.__init(_self_0, ...) -- shunt/cmd/declare.yue:75
      return _self_0 -- shunt/cmd/declare.yue:75
    end -- shunt/cmd/declare.yue:75
  }) -- shunt/cmd/declare.yue:75
  _base_0.__class = _class_0 -- shunt/cmd/declare.yue:75
  if _parent_0.__inherited then -- shunt/cmd/declare.yue:75
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/cmd/declare.yue:75
  end -- shunt/cmd/declare.yue:75
  DeclareTrainStateResponse = _class_0 -- shunt/cmd/declare.yue:75
end -- shunt/cmd/declare.yue:77
_module_0["DeclareTrainStateResponse"] = DeclareTrainStateResponse -- shunt/cmd/declare.yue:75
spec(function() -- shunt/cmd/declare.yue:79
  local TestPcBackend = require('shunt.pc').TestPcBackend -- shunt/cmd/declare.yue:0
  local TestUplinkBackend = require('shunt.peripheral.uplink').TestUplinkBackend -- shunt/cmd/declare.yue:0
  local describe, it, matchers -- shunt/cmd/declare.yue:0
  do -- shunt/cmd/declare.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/cmd/declare.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/cmd/declare.yue:0
  end -- shunt/cmd/declare.yue:0
  local deep_eq, eq, has_fields, len, lt, matches = matchers.deep_eq, matchers.eq, matchers.has_fields, matchers.len, matchers.lt, matchers.matches -- shunt/cmd/declare.yue:86
  return describe('Declarer', function() -- shunt/cmd/declare.yue:88
    return it('declares train states', function() -- shunt/cmd/declare.yue:89
      local PC_ID = 12345 -- shunt/cmd/declare.yue:90
      local ERR = 'some error message' -- shunt/cmd/declare.yue:91
      local idemp_tok -- shunt/cmd/declare.yue:92
      local uplink = Uplink(TestUplinkBackend({ -- shunt/cmd/declare.yue:94
        on_send = function(self, _, packet, _) -- shunt/cmd/declare.yue:94
          idemp_tok = packet.idemp_tok -- shunt/cmd/declare.yue:95
          return true -- shunt/cmd/declare.yue:96
        end, -- shunt/cmd/declare.yue:94
        on_broadcast = function(self, packet, _) -- shunt/cmd/declare.yue:97
          idemp_tok = packet.idemp_tok -- shunt/cmd/declare.yue:98
          return true -- shunt/cmd/declare.yue:99
        end, -- shunt/cmd/declare.yue:97
        to_receive = { -- shunt/cmd/declare.yue:101
          function() -- shunt/cmd/declare.yue:101
            local _with_0 = { } -- shunt/cmd/declare.yue:101
            _with_0.from_id = PC_ID -- shunt/cmd/declare.yue:102
            _with_0.packet = DeclareTrainStateResponse(idemp_tok, nil) -- shunt/cmd/declare.yue:103
            return _with_0 -- shunt/cmd/declare.yue:101
          end, -- shunt/cmd/declare.yue:101
          function() -- shunt/cmd/declare.yue:104
            local _with_0 = { } -- shunt/cmd/declare.yue:104
            _with_0.from_id = PC_ID -- shunt/cmd/declare.yue:105
            _with_0.packet = DeclareTrainStateResponse(idemp_tok, ERR) -- shunt/cmd/declare.yue:106
            return _with_0 -- shunt/cmd/declare.yue:104
          end -- shunt/cmd/declare.yue:104
        } -- shunt/cmd/declare.yue:100
      })) -- shunt/cmd/declare.yue:93
      local pc = Pc(TestPcBackend({ -- shunt/cmd/declare.yue:108
        id = function(self) -- shunt/cmd/declare.yue:108
          return 1 -- shunt/cmd/declare.yue:108
        end -- shunt/cmd/declare.yue:108
      })) -- shunt/cmd/declare.yue:107
      local _with_0 = Declarer(uplink, pc) -- shunt/cmd/declare.yue:109
      local TRAIN_NAME = 'test-train' -- shunt/cmd/declare.yue:110
      local TRAIN_STATE = 'cleared'; -- shunt/cmd/declare.yue:111
      require('shunt.spec')._expect_that([=[(\declare_train_state TRAIN_NAME, TRAIN_STATE)]=], (_with_0:declare_train_state(TRAIN_NAME, TRAIN_STATE)), (eq(nil)), tostring("shunt/cmd/declare.yue") .. ":" .. tostring(113)); -- shunt/cmd/declare.yue:113
      require('shunt.spec')._expect_that([=[(\declare_train_state TRAIN_NAME, TRAIN_STATE)]=], (_with_0:declare_train_state(TRAIN_NAME, TRAIN_STATE)), (eq(ERR)), tostring("shunt/cmd/declare.yue") .. ":" .. tostring(114)) -- shunt/cmd/declare.yue:114
      return _with_0 -- shunt/cmd/declare.yue:109
    end) -- shunt/cmd/declare.yue:114
  end) -- shunt/cmd/declare.yue:114
end) -- shunt/cmd/declare.yue:79
return _module_0 -- shunt/cmd/declare.yue:114
end
package.preload['shunt.nodes.factory.main'] = function(...)
-- [yue]: shunt/nodes/factory/main.yue
local _module_0 = { } -- shunt/nodes/factory/main.yue:1
local default_config, main, Factory -- shunt/nodes/factory/main.yue:1
local FactoryHeartbeat -- shunt/nodes/factory/main.yue:2
local ScheduleRequest -- shunt/nodes/factory/main.yue:3
local ScheduleResponse -- shunt/nodes/factory/main.yue:4
local HOST = require('shunt.compat').HOST -- shunt/nodes/factory/main.yue:0
local GetConfigRequest, GetConfigResponse, SetConfigRequest, SetConfigResponse -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.configurator.main') -- shunt/nodes/factory/main.yue:0
  GetConfigRequest, GetConfigResponse, SetConfigRequest, SetConfigResponse = _obj_0.GetConfigRequest, _obj_0.GetConfigResponse, _obj_0.SetConfigRequest, _obj_0.SetConfigResponse -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local fatal, log -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/nodes/factory/main.yue:0
  fatal, log = _obj_0.fatal, _obj_0.log -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local Pc = require('shunt.pc').Pc -- shunt/nodes/factory/main.yue:0
local MinecraftStationBackend, Station -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.peripheral.station') -- shunt/nodes/factory/main.yue:0
  MinecraftStationBackend, Station = _obj_0.MinecraftBackend, _obj_0.Station -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local Inventory, MinecraftInventoryBackend, Stockpile -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.peripheral.stockpile') -- shunt/nodes/factory/main.yue:0
  Inventory, MinecraftInventoryBackend, Stockpile = _obj_0.Inventory, _obj_0.MinecraftBackend, _obj_0.Stockpile -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local IdempotenceToken, Packet, Uplink -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/nodes/factory/main.yue:0
  IdempotenceToken, Packet, Uplink = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.Uplink -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local declare_type, F, is, T -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/factory/main.yue:0
  declare_type, F, is, T = _obj_0.declare_type, _obj_0.F, _obj_0.is, _obj_0.T -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local repr, spec -- shunt/nodes/factory/main.yue:0
do -- shunt/nodes/factory/main.yue:0
  local _obj_0 = require('shunt.spec') -- shunt/nodes/factory/main.yue:0
  repr, spec = _obj_0.repr, _obj_0.spec -- shunt/nodes/factory/main.yue:0
end -- shunt/nodes/factory/main.yue:0
local toml = require('shunt.toml') -- shunt/nodes/factory/main.yue:16
default_config = function() -- shunt/nodes/factory/main.yue:18
  local root_config = [=[[factory]
name = '<factory-name>'
]=] -- shunt/nodes/factory/main.yue:19
  local stockpile_config = F('(string) -> string', function(resource_name) -- shunt/nodes/factory/main.yue:23
    return "[[stockpile]]\nname = '" .. tostring(resource_name) .. "'\n# surplus_amount = 1152\n# shortage_amount = 576\n" -- shunt/nodes/factory/main.yue:27
  end) -- shunt/nodes/factory/main.yue:23
  local station_config = F('(string, [string]) -> string', function(station_name, resource_names) -- shunt/nodes/factory/main.yue:28
    return "[[stations]]\nname = '" .. tostring(station_name) .. "'\ntype = 'inbound' # or 'outbound'\nhandles = " .. tostring(table.concat((function() -- shunt/nodes/factory/main.yue:32
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:32
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:32
      for _index_0 = 1, #resource_names do -- shunt/nodes/factory/main.yue:32
        local name = resource_names[_index_0] -- shunt/nodes/factory/main.yue:32
        _accum_0[_len_0] = "'" .. tostring(name) .. "'" -- shunt/nodes/factory/main.yue:32
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:32
      end -- shunt/nodes/factory/main.yue:32
      return _accum_0 -- shunt/nodes/factory/main.yue:32
    end)(), '# or ')) .. "\nnetwork = 'mainline'\n" -- shunt/nodes/factory/main.yue:34
  end) -- shunt/nodes/factory/main.yue:28
  local resource_names, inventories_found -- shunt/nodes/factory/main.yue:35
  if 'minecraft' == HOST then -- shunt/nodes/factory/main.yue:36
    log(function() -- shunt/nodes/factory/main.yue:37
      return 'scanning inventories...' -- shunt/nodes/factory/main.yue:37
    end) -- shunt/nodes/factory/main.yue:37
    local inventories -- shunt/nodes/factory/main.yue:38
    do -- shunt/nodes/factory/main.yue:38
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:38
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:38
      local _list_0 = MinecraftInventoryBackend:find() -- shunt/nodes/factory/main.yue:38
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:38
        local backend = _list_0[_index_0] -- shunt/nodes/factory/main.yue:38
        _accum_0[_len_0] = Inventory(backend) -- shunt/nodes/factory/main.yue:38
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:38
      end -- shunt/nodes/factory/main.yue:38
      inventories = _accum_0 -- shunt/nodes/factory/main.yue:38
    end -- shunt/nodes/factory/main.yue:38
    log(function() -- shunt/nodes/factory/main.yue:39
      return "found " .. tostring(#inventories) .. " inventories" -- shunt/nodes/factory/main.yue:39
    end) -- shunt/nodes/factory/main.yue:39
    local stockpile = Stockpile(inventories) -- shunt/nodes/factory/main.yue:40
    log(function() -- shunt/nodes/factory/main.yue:42
      return 'scanning inventories...' -- shunt/nodes/factory/main.yue:42
    end) -- shunt/nodes/factory/main.yue:42
    local resources -- shunt/nodes/factory/main.yue:43
    do -- shunt/nodes/factory/main.yue:43
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:43
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:43
      local _list_0 = stockpile:content().stored_items -- shunt/nodes/factory/main.yue:43
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:43
        local stored_item = _list_0[_index_0] -- shunt/nodes/factory/main.yue:43
        _accum_0[_len_0] = stored_item.name -- shunt/nodes/factory/main.yue:43
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:43
      end -- shunt/nodes/factory/main.yue:43
      resources = _accum_0 -- shunt/nodes/factory/main.yue:43
    end -- shunt/nodes/factory/main.yue:43
    table.sort(resources) -- shunt/nodes/factory/main.yue:44
    log(function() -- shunt/nodes/factory/main.yue:45
      return "found " .. tostring(#resources) .. " resource(s)" -- shunt/nodes/factory/main.yue:45
    end) -- shunt/nodes/factory/main.yue:45
    resource_names, inventories_found = resources, #inventories > 0 -- shunt/nodes/factory/main.yue:46
  elseif 'native' == HOST then -- shunt/nodes/factory/main.yue:47
    resource_names, inventories_found = { -- shunt/nodes/factory/main.yue:48
      'test-resource' -- shunt/nodes/factory/main.yue:48
    }, true -- shunt/nodes/factory/main.yue:48
  else -- shunt/nodes/factory/main.yue:50
    resource_names, inventories_found = error("internal error: unknown host " .. tostring(HOST)) -- shunt/nodes/factory/main.yue:50
  end -- shunt/nodes/factory/main.yue:50
  local station_names -- shunt/nodes/factory/main.yue:52
  if 'minecraft' == HOST then -- shunt/nodes/factory/main.yue:53
    local stations -- shunt/nodes/factory/main.yue:54
    do -- shunt/nodes/factory/main.yue:54
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:54
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:54
      local _list_0 = MinecraftStationBackend:find() -- shunt/nodes/factory/main.yue:54
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:54
        local backend = _list_0[_index_0] -- shunt/nodes/factory/main.yue:54
        _accum_0[_len_0] = Station(backend) -- shunt/nodes/factory/main.yue:54
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:54
      end -- shunt/nodes/factory/main.yue:54
      stations = _accum_0 -- shunt/nodes/factory/main.yue:54
    end -- shunt/nodes/factory/main.yue:54
    log(function() -- shunt/nodes/factory/main.yue:55
      return "found " .. tostring(#stations) .. " station(s)" -- shunt/nodes/factory/main.yue:55
    end) -- shunt/nodes/factory/main.yue:55
    local seen_station_names = { } -- shunt/nodes/factory/main.yue:56
    for _index_0 = 1, #stations do -- shunt/nodes/factory/main.yue:57
      local station = stations[_index_0] -- shunt/nodes/factory/main.yue:57
      local err = station:validate() -- shunt/nodes/factory/main.yue:58
      if (err ~= nil) then -- shunt/nodes/factory/main.yue:59
        fatal(err) -- shunt/nodes/factory/main.yue:60
      end -- shunt/nodes/factory/main.yue:59
      seen_station_names[station:name()] = true -- shunt/nodes/factory/main.yue:61
    end -- shunt/nodes/factory/main.yue:61
    do -- shunt/nodes/factory/main.yue:63
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:63
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:63
      for station_name, _ in pairs(seen_station_names) do -- shunt/nodes/factory/main.yue:63
        _accum_0[_len_0] = station_name -- shunt/nodes/factory/main.yue:63
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:63
      end -- shunt/nodes/factory/main.yue:63
      station_names = _accum_0 -- shunt/nodes/factory/main.yue:63
    end -- shunt/nodes/factory/main.yue:63
    table.sort(station_names) -- shunt/nodes/factory/main.yue:64
    station_names = station_names -- shunt/nodes/factory/main.yue:65
  elseif 'native' == HOST then -- shunt/nodes/factory/main.yue:66
    station_names = { -- shunt/nodes/factory/main.yue:67
      'test-station' -- shunt/nodes/factory/main.yue:67
    } -- shunt/nodes/factory/main.yue:67
  else -- shunt/nodes/factory/main.yue:69
    station_names = error("internal error: unknown host " .. tostring(HOST)) -- shunt/nodes/factory/main.yue:69
  end -- shunt/nodes/factory/main.yue:69
  local issues = { -- shunt/nodes/factory/main.yue:72
    no_stations = #station_names == 0, -- shunt/nodes/factory/main.yue:72
    no_inventories = not inventories_found, -- shunt/nodes/factory/main.yue:73
    no_resources = #resource_names == 0 -- shunt/nodes/factory/main.yue:74
  } -- shunt/nodes/factory/main.yue:71
  local num_issues -- shunt/nodes/factory/main.yue:75
  do -- shunt/nodes/factory/main.yue:75
    num_issues = 0 -- shunt/nodes/factory/main.yue:76
    for _, present in pairs(issues) do -- shunt/nodes/factory/main.yue:77
      if present then -- shunt/nodes/factory/main.yue:78
        num_issues = num_issues + 1 -- shunt/nodes/factory/main.yue:79
      end -- shunt/nodes/factory/main.yue:78
    end -- shunt/nodes/factory/main.yue:79
    num_issues = num_issues -- shunt/nodes/factory/main.yue:80
  end -- shunt/nodes/factory/main.yue:80
  local config_fragments -- shunt/nodes/factory/main.yue:81
  do -- shunt/nodes/factory/main.yue:81
    local _with_0 = { } -- shunt/nodes/factory/main.yue:81
    if num_issues > 0 then -- shunt/nodes/factory/main.yue:82
      _with_0[#_with_0 + 1] = '# Issues detected! Please resolve the following:' -- shunt/nodes/factory/main.yue:83
      _with_0[#_with_0 + 1] = '#' -- shunt/nodes/factory/main.yue:84
    end -- shunt/nodes/factory/main.yue:82
    if issues.no_stations then -- shunt/nodes/factory/main.yue:85
      _with_0[#_with_0 + 1] = '# * No stations detected' -- shunt/nodes/factory/main.yue:86
    end -- shunt/nodes/factory/main.yue:85
    if issues.no_inventories then -- shunt/nodes/factory/main.yue:87
      _with_0[#_with_0 + 1] = '# * No inventories detected' -- shunt/nodes/factory/main.yue:88
    else -- shunt/nodes/factory/main.yue:89
      if issues.no_resources then -- shunt/nodes/factory/main.yue:89
        _with_0[#_with_0 + 1] = '# * No resources detected in inventories' -- shunt/nodes/factory/main.yue:90
      end -- shunt/nodes/factory/main.yue:89
    end -- shunt/nodes/factory/main.yue:87
    if num_issues > 0 then -- shunt/nodes/factory/main.yue:91
      _with_0[#_with_0 + 1] = '#' -- shunt/nodes/factory/main.yue:92
      _with_0[#_with_0 + 1] = '# Once resolved, run the following command to' -- shunt/nodes/factory/main.yue:93
      _with_0[#_with_0 + 1] = '# overwrite this config file:' -- shunt/nodes/factory/main.yue:94
      _with_0[#_with_0 + 1] = '#' -- shunt/nodes/factory/main.yue:95
      _with_0[#_with_0 + 1] = '# > shunt init factory --force' -- shunt/nodes/factory/main.yue:97
    end -- shunt/nodes/factory/main.yue:91
    _with_0[#_with_0 + 1] = root_config -- shunt/nodes/factory/main.yue:99
    for _index_0 = 1, #resource_names do -- shunt/nodes/factory/main.yue:100
      local resource_name = resource_names[_index_0] -- shunt/nodes/factory/main.yue:100
      _with_0[#_with_0 + 1] = stockpile_config(resource_name) -- shunt/nodes/factory/main.yue:101
    end -- shunt/nodes/factory/main.yue:101
    for _index_0 = 1, #station_names do -- shunt/nodes/factory/main.yue:102
      local station_name = station_names[_index_0] -- shunt/nodes/factory/main.yue:102
      _with_0[#_with_0 + 1] = station_config(station_name, resource_names) -- shunt/nodes/factory/main.yue:103
    end -- shunt/nodes/factory/main.yue:103
    config_fragments = _with_0 -- shunt/nodes/factory/main.yue:81
  end -- shunt/nodes/factory/main.yue:81
  return table.concat(config_fragments, '\n') -- shunt/nodes/factory/main.yue:104
end -- shunt/nodes/factory/main.yue:18
_module_0["default_config"] = default_config -- shunt/nodes/factory/main.yue:104
main = F('(FactoryConfig) -> <>', function(config) -- shunt/nodes/factory/main.yue:106
  print('starting factory') -- shunt/nodes/factory/main.yue:107
  local pc = Pc() -- shunt/nodes/factory/main.yue:109
  local stations -- shunt/nodes/factory/main.yue:111
  do -- shunt/nodes/factory/main.yue:111
    do -- shunt/nodes/factory/main.yue:112
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:112
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:112
      local _list_0 = MinecraftStationBackend:find() -- shunt/nodes/factory/main.yue:112
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:112
        local backend = _list_0[_index_0] -- shunt/nodes/factory/main.yue:112
        _accum_0[_len_0] = Station(backend) -- shunt/nodes/factory/main.yue:112
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:112
      end -- shunt/nodes/factory/main.yue:112
      stations = _accum_0 -- shunt/nodes/factory/main.yue:112
    end -- shunt/nodes/factory/main.yue:112
    if #stations == 0 then -- shunt/nodes/factory/main.yue:113
      fatal("cannot find any stations") -- shunt/nodes/factory/main.yue:114
    end -- shunt/nodes/factory/main.yue:113
    stations = stations -- shunt/nodes/factory/main.yue:115
  end -- shunt/nodes/factory/main.yue:115
  local stockpile -- shunt/nodes/factory/main.yue:117
  do -- shunt/nodes/factory/main.yue:117
    local inventories -- shunt/nodes/factory/main.yue:118
    do -- shunt/nodes/factory/main.yue:118
      local _accum_0 = { } -- shunt/nodes/factory/main.yue:118
      local _len_0 = 1 -- shunt/nodes/factory/main.yue:118
      local _list_0 = MinecraftInventoryBackend:find() -- shunt/nodes/factory/main.yue:118
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:118
        local backend = _list_0[_index_0] -- shunt/nodes/factory/main.yue:118
        _accum_0[_len_0] = Inventory(backend) -- shunt/nodes/factory/main.yue:118
        _len_0 = _len_0 + 1 -- shunt/nodes/factory/main.yue:118
      end -- shunt/nodes/factory/main.yue:118
      inventories = _accum_0 -- shunt/nodes/factory/main.yue:118
    end -- shunt/nodes/factory/main.yue:118
    if #inventories == 0 then -- shunt/nodes/factory/main.yue:119
      fatal('cannot find any inventories') -- shunt/nodes/factory/main.yue:120
    end -- shunt/nodes/factory/main.yue:119
    stockpile = Stockpile(inventories) -- shunt/nodes/factory/main.yue:121
  end -- shunt/nodes/factory/main.yue:121
  local _with_0 = Factory(config, pc, stations, stockpile, Uplink()) -- shunt/nodes/factory/main.yue:123
  _with_0:run() -- shunt/nodes/factory/main.yue:124
  return _with_0 -- shunt/nodes/factory/main.yue:123
end) -- shunt/nodes/factory/main.yue:106
_module_0["main"] = main -- shunt/nodes/factory/main.yue:124
declare_type('FactoryConfig', [[{
  factory: {
    name: string,
  },
  stockpile: [StockpileConfig],
  stations: [StationConfig],
}]]) -- shunt/nodes/factory/main.yue:126
declare_type('StockpileConfig', [[  {name: string}
  + StockpileLevelConfig
]]) -- shunt/nodes/factory/main.yue:133
declare_type('StockpileLevelConfig', [[  {
    surplus_amount: number,
    shortage_amount: ?number,
  } | {
    surplus_amount: ?number,
    shortage_amount: number,
  }
]]) -- shunt/nodes/factory/main.yue:137
declare_type('StationConfig', [[{
  name: string,
  type: "inbound"|"outbound",
  handles: string,
  network: string,
}]]) -- shunt/nodes/factory/main.yue:146
do -- shunt/nodes/factory/main.yue:152
  local _class_0 -- shunt/nodes/factory/main.yue:152
  local _base_0 = { -- shunt/nodes/factory/main.yue:152
    name = F('() => string', function(self) -- shunt/nodes/factory/main.yue:157
      return self.config.factory.name -- shunt/nodes/factory/main.yue:158
    end), -- shunt/nodes/factory/main.yue:160
    run = F('() => !', function(self) -- shunt/nodes/factory/main.yue:160
      self:send_heartbeat() -- shunt/nodes/factory/main.yue:161
      return parallel.waitForAny((function() -- shunt/nodes/factory/main.yue:162
        local _base_1 = self -- shunt/nodes/factory/main.yue:162
        local _fn_0 = _base_1.run_steps -- shunt/nodes/factory/main.yue:162
        return _fn_0 and function(...) -- shunt/nodes/factory/main.yue:162
          return _fn_0(_base_1, ...) -- shunt/nodes/factory/main.yue:162
        end -- shunt/nodes/factory/main.yue:162
      end)(), (function() -- shunt/nodes/factory/main.yue:163
        local _base_1 = self -- shunt/nodes/factory/main.yue:163
        local _fn_0 = _base_1.run_heartbeats -- shunt/nodes/factory/main.yue:163
        return _fn_0 and function(...) -- shunt/nodes/factory/main.yue:163
          return _fn_0(_base_1, ...) -- shunt/nodes/factory/main.yue:163
        end -- shunt/nodes/factory/main.yue:163
      end)(), (function() -- shunt/nodes/factory/main.yue:164
        local _base_1 = self -- shunt/nodes/factory/main.yue:164
        local _fn_0 = _base_1.run_peripheral_detection -- shunt/nodes/factory/main.yue:164
        return _fn_0 and function(...) -- shunt/nodes/factory/main.yue:164
          return _fn_0(_base_1, ...) -- shunt/nodes/factory/main.yue:164
        end -- shunt/nodes/factory/main.yue:164
      end)(), (function() -- shunt/nodes/factory/main.yue:165
        local _base_1 = self -- shunt/nodes/factory/main.yue:165
        local _fn_0 = _base_1.run_peripheral_detach_detection -- shunt/nodes/factory/main.yue:165
        return _fn_0 and function(...) -- shunt/nodes/factory/main.yue:165
          return _fn_0(_base_1, ...) -- shunt/nodes/factory/main.yue:165
        end -- shunt/nodes/factory/main.yue:165
      end)()) -- shunt/nodes/factory/main.yue:165
    end), -- shunt/nodes/factory/main.yue:168
    run_steps = F('() => !', function(self) -- shunt/nodes/factory/main.yue:168
      while true do -- shunt/nodes/factory/main.yue:169
        self:do_network_step() -- shunt/nodes/factory/main.yue:170
      end -- shunt/nodes/factory/main.yue:170
    end), -- shunt/nodes/factory/main.yue:172
    do_network_step = F('() => <>', function(self) -- shunt/nodes/factory/main.yue:172
      local from_id, packet = self.uplink:receive_from_any() -- shunt/nodes/factory/main.yue:173
      if not (from_id ~= nil) then -- shunt/nodes/factory/main.yue:174
        return -- shunt/nodes/factory/main.yue:175
      end -- shunt/nodes/factory/main.yue:174
      do -- shunt/nodes/factory/main.yue:177
        local _exp_0 = packet.protocol -- shunt/nodes/factory/main.yue:177
        if 'ScheduleRequest' == _exp_0 then -- shunt/nodes/factory/main.yue:178
          self:on_schedule_request(from_id, packet) -- shunt/nodes/factory/main.yue:179
        elseif 'GetConfigRequest' == _exp_0 then -- shunt/nodes/factory/main.yue:180
          self:on_get_config_request(packet) -- shunt/nodes/factory/main.yue:181
        elseif 'SetConfigRequest' == _exp_0 then -- shunt/nodes/factory/main.yue:182
          self:on_set_config_request(packet) -- shunt/nodes/factory/main.yue:183
        else -- shunt/nodes/factory/main.yue:185
          log(function() -- shunt/nodes/factory/main.yue:185
            return "ignoring " .. tostring(packet.protocol) .. " packet" -- shunt/nodes/factory/main.yue:185
          end) -- shunt/nodes/factory/main.yue:185
        end -- shunt/nodes/factory/main.yue:185
      end -- shunt/nodes/factory/main.yue:185
      return -- shunt/nodes/factory/main.yue:186
    end), -- shunt/nodes/factory/main.yue:188
    on_schedule_request = F('(number, Packet) => <>', function(self, requester, request) -- shunt/nodes/factory/main.yue:188
      log(function() -- shunt/nodes/factory/main.yue:189
        return 'handling schedule request' -- shunt/nodes/factory/main.yue:189
      end) -- shunt/nodes/factory/main.yue:189
      local idemp_tok, station_name, train_name, schedule = request.idemp_tok, request.station_name, request.train_name, request.schedule -- shunt/nodes/factory/main.yue:191
      local station = self:get_train_station(station_name, train_name) -- shunt/nodes/factory/main.yue:192
      if not (station ~= nil) then -- shunt/nodes/factory/main.yue:193
        self.uplink:send_to(requester, ScheduleResponse(idemp_tok, "no train " .. tostring(train_name) .. " at " .. tostring(station_name) .. " of " .. tostring(self:name()))) -- shunt/nodes/factory/main.yue:194
        return -- shunt/nodes/factory/main.yue:195
      end -- shunt/nodes/factory/main.yue:193
      self.uplink:send_to(requester, ScheduleResponse(idemp_tok, nil)) -- shunt/nodes/factory/main.yue:199
      station:apply_schedule(schedule) -- shunt/nodes/factory/main.yue:201
      return -- shunt/nodes/factory/main.yue:202
    end), -- shunt/nodes/factory/main.yue:204
    get_train_station = F('(string, string) => ?Station', function(self, station_name, train_name) -- shunt/nodes/factory/main.yue:204
      local _list_0 = self.stations -- shunt/nodes/factory/main.yue:205
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:205
        local station = _list_0[_index_0] -- shunt/nodes/factory/main.yue:205
        if station:name() == station_name and station:train_name() == train_name then -- shunt/nodes/factory/main.yue:206
          return station -- shunt/nodes/factory/main.yue:207
        end -- shunt/nodes/factory/main.yue:206
      end -- shunt/nodes/factory/main.yue:207
      return nil -- shunt/nodes/factory/main.yue:208
    end), -- shunt/nodes/factory/main.yue:210
    on_get_config_request = F('(GetConfigRequest) => <>', function(self, packet) -- shunt/nodes/factory/main.yue:210
      local idemp_tok, pc_id = packet.idemp_tok, packet.pc_id -- shunt/nodes/factory/main.yue:211
      return self.uplink:send_to(pc_id, GetConfigResponse(idemp_tok, getmetatable(self.config).__raw)) -- shunt/nodes/factory/main.yue:212
    end), -- shunt/nodes/factory/main.yue:214
    on_set_config_request = F('(SetConfigRequest) => <>', function(self, packet) -- shunt/nodes/factory/main.yue:214
      local idemp_tok, pc_id, raw = packet.idemp_tok, packet.pc_id, packet.raw -- shunt/nodes/factory/main.yue:215
      local config, err = toml.decode(raw) -- shunt/nodes/factory/main.yue:216
      if (err ~= nil) then -- shunt/nodes/factory/main.yue:217
        self.uplink:send_to(pc_id, SetConfigResponse(idemp_tok, err)) -- shunt/nodes/factory/main.yue:218
        return -- shunt/nodes/factory/main.yue:219
      end -- shunt/nodes/factory/main.yue:217
      local ok -- shunt/nodes/factory/main.yue:221
      ok, err = is('FactoryConfig', config) -- shunt/nodes/factory/main.yue:221
      if not ok then -- shunt/nodes/factory/main.yue:222
        self.uplink:send_to(pc_id, SetConfigResponse(idemp_tok, err)) -- shunt/nodes/factory/main.yue:223
        return -- shunt/nodes/factory/main.yue:224
      end -- shunt/nodes/factory/main.yue:222
      setmetatable(config, { }) -- shunt/nodes/factory/main.yue:226
      getmetatable(config).__raw = raw -- shunt/nodes/factory/main.yue:227
      self:set_config(config) -- shunt/nodes/factory/main.yue:228
      return self.uplink:send_to(pc_id, SetConfigResponse(idemp_tok, nil)) -- shunt/nodes/factory/main.yue:229
    end), -- shunt/nodes/factory/main.yue:231
    set_config = F('(FactoryConfig+StoredConfig) => <>', function(self, config) -- shunt/nodes/factory/main.yue:231
      self.config = config -- shunt/nodes/factory/main.yue:231
      local name = self:name() -- shunt/nodes/factory/main.yue:232
      if self.pc:name() ~= name then -- shunt/nodes/factory/main.yue:233
        return self.pc:set_name(name) -- shunt/nodes/factory/main.yue:234
      end -- shunt/nodes/factory/main.yue:233
    end), -- shunt/nodes/factory/main.yue:236
    run_heartbeats = F('() => !', function(self) -- shunt/nodes/factory/main.yue:236
      local HEARTBEAT_PERIOD = 10 -- shunt/nodes/factory/main.yue:237
      while true do -- shunt/nodes/factory/main.yue:238
        self:send_heartbeat() -- shunt/nodes/factory/main.yue:239
        os.sleep(HEARTBEAT_PERIOD) -- shunt/nodes/factory/main.yue:240
      end -- shunt/nodes/factory/main.yue:240
    end), -- shunt/nodes/factory/main.yue:242
    run_peripheral_detection = F('() => !', function(self) -- shunt/nodes/factory/main.yue:242
      while true do -- shunt/nodes/factory/main.yue:243
        os.pullEvent('peripheral') -- shunt/nodes/factory/main.yue:244
        self:send_heartbeat() -- shunt/nodes/factory/main.yue:245
      end -- shunt/nodes/factory/main.yue:245
    end), -- shunt/nodes/factory/main.yue:247
    run_peripheral_detach_detection = F('() => !', function(self) -- shunt/nodes/factory/main.yue:247
      while true do -- shunt/nodes/factory/main.yue:248
        os.pullEvent('peripheral_detach') -- shunt/nodes/factory/main.yue:249
        self:send_heartbeat() -- shunt/nodes/factory/main.yue:250
      end -- shunt/nodes/factory/main.yue:250
    end), -- shunt/nodes/factory/main.yue:252
    send_heartbeat = F('() => <>', function(self) -- shunt/nodes/factory/main.yue:252
      local stations = self:detect_stations() -- shunt/nodes/factory/main.yue:253
      local stockpile = self:detect_stockpile() -- shunt/nodes/factory/main.yue:254
      local heartbeat = FactoryHeartbeat(self.pc:id(), self:name(), stations, stockpile) -- shunt/nodes/factory/main.yue:255
      self.heartbeat_num = self.heartbeat_num + 1 -- shunt/nodes/factory/main.yue:257
      log(function() -- shunt/nodes/factory/main.yue:258
        return "sending heartbeat " .. tostring(self.heartbeat_num) .. ": " .. tostring(repr(heartbeat)) -- shunt/nodes/factory/main.yue:258
      end) -- shunt/nodes/factory/main.yue:258
      return self.uplink:broadcast(heartbeat) -- shunt/nodes/factory/main.yue:260
    end), -- shunt/nodes/factory/main.yue:262
    detect_stations = F('() => DetectedStations', function(self) -- shunt/nodes/factory/main.yue:262
      local detected_station_info -- shunt/nodes/factory/main.yue:265
      do -- shunt/nodes/factory/main.yue:265
        local _with_0 = { } -- shunt/nodes/factory/main.yue:265
        local _list_0 = self.stations -- shunt/nodes/factory/main.yue:266
        for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:266
          local station = _list_0[_index_0] -- shunt/nodes/factory/main.yue:266
          local name = station:name() -- shunt/nodes/factory/main.yue:267
          local info = _with_0[name] -- shunt/nodes/factory/main.yue:268
          if not (info ~= nil) then -- shunt/nodes/factory/main.yue:269
            do -- shunt/nodes/factory/main.yue:270
              local config = self:get_station_config(name) -- shunt/nodes/factory/main.yue:271
              local known = (config ~= nil) -- shunt/nodes/factory/main.yue:272
              info = { -- shunt/nodes/factory/main.yue:273
                name = name, -- shunt/nodes/factory/main.yue:273
                known = known, -- shunt/nodes/factory/main.yue:273
                capacity = 0, -- shunt/nodes/factory/main.yue:273
                present_trains = { } -- shunt/nodes/factory/main.yue:273
              } -- shunt/nodes/factory/main.yue:273
              if known then -- shunt/nodes/factory/main.yue:274
                do -- shunt/nodes/factory/main.yue:275
                  local _tab_0 = { } -- shunt/nodes/factory/main.yue:275
                  local _idx_0 = 1 -- shunt/nodes/factory/main.yue:275
                  for _key_0, _value_0 in pairs(config) do -- shunt/nodes/factory/main.yue:275
                    if _idx_0 == _key_0 then -- shunt/nodes/factory/main.yue:275
                      _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/factory/main.yue:275
                      _idx_0 = _idx_0 + 1 -- shunt/nodes/factory/main.yue:275
                    else -- shunt/nodes/factory/main.yue:275
                      _tab_0[_key_0] = _value_0 -- shunt/nodes/factory/main.yue:275
                    end -- shunt/nodes/factory/main.yue:275
                  end -- shunt/nodes/factory/main.yue:275
                  local _idx_1 = 1 -- shunt/nodes/factory/main.yue:275
                  for _key_0, _value_0 in pairs(info) do -- shunt/nodes/factory/main.yue:275
                    if _idx_1 == _key_0 then -- shunt/nodes/factory/main.yue:275
                      _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/factory/main.yue:275
                      _idx_1 = _idx_1 + 1 -- shunt/nodes/factory/main.yue:275
                    else -- shunt/nodes/factory/main.yue:275
                      _tab_0[_key_0] = _value_0 -- shunt/nodes/factory/main.yue:275
                    end -- shunt/nodes/factory/main.yue:275
                  end -- shunt/nodes/factory/main.yue:275
                  info = _tab_0 -- shunt/nodes/factory/main.yue:275
                end -- shunt/nodes/factory/main.yue:275
              end -- shunt/nodes/factory/main.yue:274
              _with_0[name] = info -- shunt/nodes/factory/main.yue:276
            end -- shunt/nodes/factory/main.yue:276
          end -- shunt/nodes/factory/main.yue:269
          local present_train = station:train_name() -- shunt/nodes/factory/main.yue:278
          if (present_train ~= nil) then -- shunt/nodes/factory/main.yue:279
            do -- shunt/nodes/factory/main.yue:280
              local _obj_0 = info.present_trains -- shunt/nodes/factory/main.yue:280
              _obj_0[#_obj_0 + 1] = present_train -- shunt/nodes/factory/main.yue:280
            end -- shunt/nodes/factory/main.yue:280
          end -- shunt/nodes/factory/main.yue:279
          info.capacity = info.capacity + 1 -- shunt/nodes/factory/main.yue:281
        end -- shunt/nodes/factory/main.yue:281
        detected_station_info = _with_0 -- shunt/nodes/factory/main.yue:265
      end -- shunt/nodes/factory/main.yue:265
      local _with_0 = { -- shunt/nodes/factory/main.yue:283
        known = { }, -- shunt/nodes/factory/main.yue:283
        unknown = { } -- shunt/nodes/factory/main.yue:283
      } -- shunt/nodes/factory/main.yue:283
      for _, station_info in pairs(detected_station_info) do -- shunt/nodes/factory/main.yue:284
        local known = station_info.known -- shunt/nodes/factory/main.yue:285
        station_info.known = nil -- shunt/nodes/factory/main.yue:286
        if known then -- shunt/nodes/factory/main.yue:288
          do -- shunt/nodes/factory/main.yue:289
            local _obj_0 = _with_0.known -- shunt/nodes/factory/main.yue:289
            _obj_0[#_obj_0 + 1] = station_info -- shunt/nodes/factory/main.yue:289
          end -- shunt/nodes/factory/main.yue:289
        else -- shunt/nodes/factory/main.yue:291
          do -- shunt/nodes/factory/main.yue:291
            local _obj_0 = _with_0.unknown -- shunt/nodes/factory/main.yue:291
            _obj_0[#_obj_0 + 1] = station_info -- shunt/nodes/factory/main.yue:291
          end -- shunt/nodes/factory/main.yue:291
        end -- shunt/nodes/factory/main.yue:288
      end -- shunt/nodes/factory/main.yue:291
      table.sort(_with_0.known, function(a, b) -- shunt/nodes/factory/main.yue:293
        return a.name < b.name -- shunt/nodes/factory/main.yue:293
      end) -- shunt/nodes/factory/main.yue:293
      table.sort(_with_0.unknown, function(a, b) -- shunt/nodes/factory/main.yue:294
        return a.name < b.name -- shunt/nodes/factory/main.yue:294
      end) -- shunt/nodes/factory/main.yue:294
      return _with_0 -- shunt/nodes/factory/main.yue:283
    end), -- shunt/nodes/factory/main.yue:296
    get_station_config = F('(string) => ?StationConfig', function(self, name) -- shunt/nodes/factory/main.yue:296
      local _list_0 = self.config.stations -- shunt/nodes/factory/main.yue:297
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:297
        local station_config = _list_0[_index_0] -- shunt/nodes/factory/main.yue:297
        if station_config.name == name then -- shunt/nodes/factory/main.yue:298
          return station_config -- shunt/nodes/factory/main.yue:299
        end -- shunt/nodes/factory/main.yue:298
      end -- shunt/nodes/factory/main.yue:299
      return nil -- shunt/nodes/factory/main.yue:300
    end), -- shunt/nodes/factory/main.yue:302
    detect_stockpile = F('() => DetectedStockpile', function(self) -- shunt/nodes/factory/main.yue:302
      local stored_items, estimated_capacity -- shunt/nodes/factory/main.yue:303
      do -- shunt/nodes/factory/main.yue:303
        local _obj_0 = self.stockpile:content() -- shunt/nodes/factory/main.yue:303
        stored_items, estimated_capacity = _obj_0.stored_items, _obj_0.estimated_capacity -- shunt/nodes/factory/main.yue:303
      end -- shunt/nodes/factory/main.yue:303
      local seen_resources = T('{string}', { }) -- shunt/nodes/factory/main.yue:305
      local expected_resource_configs = T('{string->StockpileConfig}', (function() -- shunt/nodes/factory/main.yue:306
        local _tbl_0 = { } -- shunt/nodes/factory/main.yue:306
        local _list_0 = self.config.stockpile -- shunt/nodes/factory/main.yue:306
        for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:306
          local cfg = _list_0[_index_0] -- shunt/nodes/factory/main.yue:306
          _tbl_0[cfg.name] = cfg -- shunt/nodes/factory/main.yue:306
        end -- shunt/nodes/factory/main.yue:306
        return _tbl_0 -- shunt/nodes/factory/main.yue:306
      end)()) -- shunt/nodes/factory/main.yue:306
      local _with_0 = { -- shunt/nodes/factory/main.yue:307
        known = { }, -- shunt/nodes/factory/main.yue:307
        unknown = { }, -- shunt/nodes/factory/main.yue:307
        estimated_capacity = estimated_capacity -- shunt/nodes/factory/main.yue:307
      } -- shunt/nodes/factory/main.yue:307
      for _index_0 = 1, #stored_items do -- shunt/nodes/factory/main.yue:308
        local stored_item = stored_items[_index_0] -- shunt/nodes/factory/main.yue:308
        seen_resources[stored_item.name] = true -- shunt/nodes/factory/main.yue:309
        local config = expected_resource_configs[stored_item.name] -- shunt/nodes/factory/main.yue:310
        if (config ~= nil) then -- shunt/nodes/factory/main.yue:311
          do -- shunt/nodes/factory/main.yue:312
            local _obj_0 = _with_0.known -- shunt/nodes/factory/main.yue:312
            do -- shunt/nodes/factory/main.yue:312
              local _tab_0 = { } -- shunt/nodes/factory/main.yue:312
              local _idx_0 = 1 -- shunt/nodes/factory/main.yue:312
              for _key_0, _value_0 in pairs(config) do -- shunt/nodes/factory/main.yue:312
                if _idx_0 == _key_0 then -- shunt/nodes/factory/main.yue:312
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/factory/main.yue:312
                  _idx_0 = _idx_0 + 1 -- shunt/nodes/factory/main.yue:312
                else -- shunt/nodes/factory/main.yue:312
                  _tab_0[_key_0] = _value_0 -- shunt/nodes/factory/main.yue:312
                end -- shunt/nodes/factory/main.yue:312
              end -- shunt/nodes/factory/main.yue:312
              local _idx_1 = 1 -- shunt/nodes/factory/main.yue:312
              for _key_0, _value_0 in pairs(stored_item) do -- shunt/nodes/factory/main.yue:312
                if _idx_1 == _key_0 then -- shunt/nodes/factory/main.yue:312
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/factory/main.yue:312
                  _idx_1 = _idx_1 + 1 -- shunt/nodes/factory/main.yue:312
                else -- shunt/nodes/factory/main.yue:312
                  _tab_0[_key_0] = _value_0 -- shunt/nodes/factory/main.yue:312
                end -- shunt/nodes/factory/main.yue:312
              end -- shunt/nodes/factory/main.yue:312
              _obj_0[#_obj_0 + 1] = _tab_0 -- shunt/nodes/factory/main.yue:312
            end -- shunt/nodes/factory/main.yue:312
          end -- shunt/nodes/factory/main.yue:312
        else -- shunt/nodes/factory/main.yue:314
          do -- shunt/nodes/factory/main.yue:314
            local _obj_0 = _with_0.unknown -- shunt/nodes/factory/main.yue:314
            _obj_0[#_obj_0 + 1] = stored_item -- shunt/nodes/factory/main.yue:314
          end -- shunt/nodes/factory/main.yue:314
        end -- shunt/nodes/factory/main.yue:311
      end -- shunt/nodes/factory/main.yue:314
      local _list_0 = self.config.stockpile -- shunt/nodes/factory/main.yue:316
      for _index_0 = 1, #_list_0 do -- shunt/nodes/factory/main.yue:316
        local config = _list_0[_index_0] -- shunt/nodes/factory/main.yue:316
        local _continue_0 = false -- shunt/nodes/factory/main.yue:317
        repeat -- shunt/nodes/factory/main.yue:317
          if seen_resources[config.name] then -- shunt/nodes/factory/main.yue:317
            _continue_0 = true -- shunt/nodes/factory/main.yue:318
            break -- shunt/nodes/factory/main.yue:318
          end -- shunt/nodes/factory/main.yue:317
          do -- shunt/nodes/factory/main.yue:319
            local _obj_0 = _with_0.known -- shunt/nodes/factory/main.yue:319
            do -- shunt/nodes/factory/main.yue:319
              local _tab_0 = { } -- shunt/nodes/factory/main.yue:319
              local _idx_0 = 1 -- shunt/nodes/factory/main.yue:319
              for _key_0, _value_0 in pairs(config) do -- shunt/nodes/factory/main.yue:319
                if _idx_0 == _key_0 then -- shunt/nodes/factory/main.yue:319
                  _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/factory/main.yue:319
                  _idx_0 = _idx_0 + 1 -- shunt/nodes/factory/main.yue:319
                else -- shunt/nodes/factory/main.yue:319
                  _tab_0[_key_0] = _value_0 -- shunt/nodes/factory/main.yue:319
                end -- shunt/nodes/factory/main.yue:319
              end -- shunt/nodes/factory/main.yue:319
              _tab_0.stored = 0 -- shunt/nodes/factory/main.yue:319
              _obj_0[#_obj_0 + 1] = _tab_0 -- shunt/nodes/factory/main.yue:319
            end -- shunt/nodes/factory/main.yue:319
          end -- shunt/nodes/factory/main.yue:319
          _continue_0 = true -- shunt/nodes/factory/main.yue:317
        until true -- shunt/nodes/factory/main.yue:319
        if not _continue_0 then -- shunt/nodes/factory/main.yue:319
          break -- shunt/nodes/factory/main.yue:319
        end -- shunt/nodes/factory/main.yue:319
      end -- shunt/nodes/factory/main.yue:319
      return _with_0 -- shunt/nodes/factory/main.yue:307
    end) -- shunt/nodes/factory/main.yue:152
  } -- shunt/nodes/factory/main.yue:152
  if _base_0.__index == nil then -- shunt/nodes/factory/main.yue:152
    _base_0.__index = _base_0 -- shunt/nodes/factory/main.yue:152
  end -- shunt/nodes/factory/main.yue:319
  _class_0 = setmetatable({ -- shunt/nodes/factory/main.yue:152
    __init = F('(FactoryConfig+StoredConfig, Pc, [Station], Stockpile, Uplink) => <>', function(self, config, pc, stations, stockpile, uplink) -- shunt/nodes/factory/main.yue:153
      self.pc = pc -- shunt/nodes/factory/main.yue:153
      self.stations = stations -- shunt/nodes/factory/main.yue:153
      self.stockpile = stockpile -- shunt/nodes/factory/main.yue:153
      self.uplink = uplink -- shunt/nodes/factory/main.yue:153
      self:set_config(config) -- shunt/nodes/factory/main.yue:154
      self.heartbeat_num = T('number', 0) -- shunt/nodes/factory/main.yue:155
    end), -- shunt/nodes/factory/main.yue:152
    __base = _base_0, -- shunt/nodes/factory/main.yue:152
    __name = "Factory" -- shunt/nodes/factory/main.yue:152
  }, { -- shunt/nodes/factory/main.yue:152
    __index = _base_0, -- shunt/nodes/factory/main.yue:152
    __call = function(cls, ...) -- shunt/nodes/factory/main.yue:152
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/factory/main.yue:152
      cls.__init(_self_0, ...) -- shunt/nodes/factory/main.yue:152
      return _self_0 -- shunt/nodes/factory/main.yue:152
    end -- shunt/nodes/factory/main.yue:152
  }) -- shunt/nodes/factory/main.yue:152
  _base_0.__class = _class_0 -- shunt/nodes/factory/main.yue:152
  Factory = _class_0 -- shunt/nodes/factory/main.yue:152
end -- shunt/nodes/factory/main.yue:319
declare_type('ScheduleRequest', [[  Packet + {
    idemp_tok: IdempotenceToken,
    station_name: string,
    train_name: string,
    schedule: Schedule,
  }
]]) -- shunt/nodes/factory/main.yue:321
do -- shunt/nodes/factory/main.yue:329
  local _class_0 -- shunt/nodes/factory/main.yue:329
  local _parent_0 = Packet -- shunt/nodes/factory/main.yue:329
  local _base_0 = { } -- shunt/nodes/factory/main.yue:329
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/nodes/factory/main.yue:331
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/nodes/factory/main.yue:329
      _base_0[_key_0] = _val_0 -- shunt/nodes/factory/main.yue:329
    end -- shunt/nodes/factory/main.yue:329
  end -- shunt/nodes/factory/main.yue:331
  if _base_0.__index == nil then -- shunt/nodes/factory/main.yue:329
    _base_0.__index = _base_0 -- shunt/nodes/factory/main.yue:329
  end -- shunt/nodes/factory/main.yue:331
  setmetatable(_base_0, _parent_0.__base) -- shunt/nodes/factory/main.yue:329
  _class_0 = setmetatable({ -- shunt/nodes/factory/main.yue:329
    __init = F('(IdempotenceToken, string, string, Schedule) => <>', function(self, idemp_tok, station_name, train_name, schedule) -- shunt/nodes/factory/main.yue:330
      self.idemp_tok = idemp_tok -- shunt/nodes/factory/main.yue:330
      self.station_name = station_name -- shunt/nodes/factory/main.yue:330
      self.train_name = train_name -- shunt/nodes/factory/main.yue:330
      self.schedule = schedule -- shunt/nodes/factory/main.yue:330
      return _class_0.__parent.__init(self) -- shunt/nodes/factory/main.yue:331
    end), -- shunt/nodes/factory/main.yue:329
    __base = _base_0, -- shunt/nodes/factory/main.yue:329
    __name = "ScheduleRequest", -- shunt/nodes/factory/main.yue:329
    __parent = _parent_0 -- shunt/nodes/factory/main.yue:329
  }, { -- shunt/nodes/factory/main.yue:329
    __index = function(cls, name) -- shunt/nodes/factory/main.yue:329
      local val = rawget(_base_0, name) -- shunt/nodes/factory/main.yue:329
      if val == nil then -- shunt/nodes/factory/main.yue:329
        local parent = rawget(cls, "__parent") -- shunt/nodes/factory/main.yue:329
        if parent then -- shunt/nodes/factory/main.yue:329
          return parent[name] -- shunt/nodes/factory/main.yue:329
        end -- shunt/nodes/factory/main.yue:329
      else -- shunt/nodes/factory/main.yue:329
        return val -- shunt/nodes/factory/main.yue:329
      end -- shunt/nodes/factory/main.yue:329
    end, -- shunt/nodes/factory/main.yue:329
    __call = function(cls, ...) -- shunt/nodes/factory/main.yue:329
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/factory/main.yue:329
      cls.__init(_self_0, ...) -- shunt/nodes/factory/main.yue:329
      return _self_0 -- shunt/nodes/factory/main.yue:329
    end -- shunt/nodes/factory/main.yue:329
  }) -- shunt/nodes/factory/main.yue:329
  _base_0.__class = _class_0 -- shunt/nodes/factory/main.yue:329
  if _parent_0.__inherited then -- shunt/nodes/factory/main.yue:329
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/nodes/factory/main.yue:329
  end -- shunt/nodes/factory/main.yue:329
  ScheduleRequest = _class_0 -- shunt/nodes/factory/main.yue:329
end -- shunt/nodes/factory/main.yue:331
_module_0["ScheduleRequest"] = ScheduleRequest -- shunt/nodes/factory/main.yue:329
declare_type('ScheduleResponse', [[  Packet + {
    idemp_tok: IdempotenceToken,
    error_reason: ?string,
  }
]]) -- shunt/nodes/factory/main.yue:333
do -- shunt/nodes/factory/main.yue:339
  local _class_0 -- shunt/nodes/factory/main.yue:339
  local _parent_0 = Packet -- shunt/nodes/factory/main.yue:339
  local _base_0 = { } -- shunt/nodes/factory/main.yue:339
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/nodes/factory/main.yue:341
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/nodes/factory/main.yue:339
      _base_0[_key_0] = _val_0 -- shunt/nodes/factory/main.yue:339
    end -- shunt/nodes/factory/main.yue:339
  end -- shunt/nodes/factory/main.yue:341
  if _base_0.__index == nil then -- shunt/nodes/factory/main.yue:339
    _base_0.__index = _base_0 -- shunt/nodes/factory/main.yue:339
  end -- shunt/nodes/factory/main.yue:341
  setmetatable(_base_0, _parent_0.__base) -- shunt/nodes/factory/main.yue:339
  _class_0 = setmetatable({ -- shunt/nodes/factory/main.yue:339
    __init = F('(IdempotenceToken, ?string) => <>', function(self, idemp_tok, error_reason) -- shunt/nodes/factory/main.yue:340
      self.idemp_tok = idemp_tok -- shunt/nodes/factory/main.yue:340
      self.error_reason = error_reason -- shunt/nodes/factory/main.yue:340
      return _class_0.__parent.__init(self) -- shunt/nodes/factory/main.yue:341
    end), -- shunt/nodes/factory/main.yue:339
    __base = _base_0, -- shunt/nodes/factory/main.yue:339
    __name = "ScheduleResponse", -- shunt/nodes/factory/main.yue:339
    __parent = _parent_0 -- shunt/nodes/factory/main.yue:339
  }, { -- shunt/nodes/factory/main.yue:339
    __index = function(cls, name) -- shunt/nodes/factory/main.yue:339
      local val = rawget(_base_0, name) -- shunt/nodes/factory/main.yue:339
      if val == nil then -- shunt/nodes/factory/main.yue:339
        local parent = rawget(cls, "__parent") -- shunt/nodes/factory/main.yue:339
        if parent then -- shunt/nodes/factory/main.yue:339
          return parent[name] -- shunt/nodes/factory/main.yue:339
        end -- shunt/nodes/factory/main.yue:339
      else -- shunt/nodes/factory/main.yue:339
        return val -- shunt/nodes/factory/main.yue:339
      end -- shunt/nodes/factory/main.yue:339
    end, -- shunt/nodes/factory/main.yue:339
    __call = function(cls, ...) -- shunt/nodes/factory/main.yue:339
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/factory/main.yue:339
      cls.__init(_self_0, ...) -- shunt/nodes/factory/main.yue:339
      return _self_0 -- shunt/nodes/factory/main.yue:339
    end -- shunt/nodes/factory/main.yue:339
  }) -- shunt/nodes/factory/main.yue:339
  _base_0.__class = _class_0 -- shunt/nodes/factory/main.yue:339
  if _parent_0.__inherited then -- shunt/nodes/factory/main.yue:339
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/nodes/factory/main.yue:339
  end -- shunt/nodes/factory/main.yue:339
  ScheduleResponse = _class_0 -- shunt/nodes/factory/main.yue:339
end -- shunt/nodes/factory/main.yue:341
_module_0["ScheduleResponse"] = ScheduleResponse -- shunt/nodes/factory/main.yue:339
declare_type('FactoryHeartbeat', [[{
  pc_id: number,
  name: string,
  stations: DetectedStations,
  stockpile: DetectedStockpile,
}]]) -- shunt/nodes/factory/main.yue:343
declare_type('DetectedStations', [[{
  known: [KnownDetectedStation],
  unknown: [UnknownDetectedStation],
}]]) -- shunt/nodes/factory/main.yue:349
declare_type('KnownDetectedStation', 'StationConfig + DetectedTrains') -- shunt/nodes/factory/main.yue:353
declare_type('UnknownDetectedStation', [[  { name: string }
  + DetectedTrains
]]) -- shunt/nodes/factory/main.yue:354
declare_type('DetectedTrains', [[{
  capacity: number,
  present_trains: [string],
}]]) -- shunt/nodes/factory/main.yue:358
declare_type('DetectedStockpile', [[{
  known: [StockpileItemInfo],
  unknown: [StoredItemInfo],
  estimated_capacity: number,
}]]) -- shunt/nodes/factory/main.yue:362
declare_type('StockpileItemInfo', 'StoredItemInfo + StockpileConfig') -- shunt/nodes/factory/main.yue:367
do -- shunt/nodes/factory/main.yue:368
  local _class_0 -- shunt/nodes/factory/main.yue:368
  local _parent_0 = Packet -- shunt/nodes/factory/main.yue:368
  local _base_0 = { } -- shunt/nodes/factory/main.yue:368
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/nodes/factory/main.yue:370
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/nodes/factory/main.yue:368
      _base_0[_key_0] = _val_0 -- shunt/nodes/factory/main.yue:368
    end -- shunt/nodes/factory/main.yue:368
  end -- shunt/nodes/factory/main.yue:370
  if _base_0.__index == nil then -- shunt/nodes/factory/main.yue:368
    _base_0.__index = _base_0 -- shunt/nodes/factory/main.yue:368
  end -- shunt/nodes/factory/main.yue:370
  setmetatable(_base_0, _parent_0.__base) -- shunt/nodes/factory/main.yue:368
  _class_0 = setmetatable({ -- shunt/nodes/factory/main.yue:368
    __init = F('(number, string, DetectedStations, DetectedStockpile) => <>', function(self, pc_id, name, stations, stockpile) -- shunt/nodes/factory/main.yue:369
      self.pc_id = pc_id -- shunt/nodes/factory/main.yue:369
      self.name = name -- shunt/nodes/factory/main.yue:369
      self.stations = stations -- shunt/nodes/factory/main.yue:369
      self.stockpile = stockpile -- shunt/nodes/factory/main.yue:369
      return _class_0.__parent.__init(self) -- shunt/nodes/factory/main.yue:370
    end), -- shunt/nodes/factory/main.yue:368
    __base = _base_0, -- shunt/nodes/factory/main.yue:368
    __name = "FactoryHeartbeat", -- shunt/nodes/factory/main.yue:368
    __parent = _parent_0 -- shunt/nodes/factory/main.yue:368
  }, { -- shunt/nodes/factory/main.yue:368
    __index = function(cls, name) -- shunt/nodes/factory/main.yue:368
      local val = rawget(_base_0, name) -- shunt/nodes/factory/main.yue:368
      if val == nil then -- shunt/nodes/factory/main.yue:368
        local parent = rawget(cls, "__parent") -- shunt/nodes/factory/main.yue:368
        if parent then -- shunt/nodes/factory/main.yue:368
          return parent[name] -- shunt/nodes/factory/main.yue:368
        end -- shunt/nodes/factory/main.yue:368
      else -- shunt/nodes/factory/main.yue:368
        return val -- shunt/nodes/factory/main.yue:368
      end -- shunt/nodes/factory/main.yue:368
    end, -- shunt/nodes/factory/main.yue:368
    __call = function(cls, ...) -- shunt/nodes/factory/main.yue:368
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/factory/main.yue:368
      cls.__init(_self_0, ...) -- shunt/nodes/factory/main.yue:368
      return _self_0 -- shunt/nodes/factory/main.yue:368
    end -- shunt/nodes/factory/main.yue:368
  }) -- shunt/nodes/factory/main.yue:368
  _base_0.__class = _class_0 -- shunt/nodes/factory/main.yue:368
  if _parent_0.__inherited then -- shunt/nodes/factory/main.yue:368
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/nodes/factory/main.yue:368
  end -- shunt/nodes/factory/main.yue:368
  FactoryHeartbeat = _class_0 -- shunt/nodes/factory/main.yue:368
end -- shunt/nodes/factory/main.yue:370
_module_0["FactoryHeartbeat"] = FactoryHeartbeat -- shunt/nodes/factory/main.yue:368
spec(function() -- shunt/nodes/factory/main.yue:372
  local TestPcBackend = require('shunt.pc').TestPcBackend -- shunt/nodes/factory/main.yue:0
  local TestStationBackend = require('shunt.peripheral.station').TestStationBackend -- shunt/nodes/factory/main.yue:0
  local TestInventoryBackend = require('shunt.peripheral.stockpile').TestInventoryBackend -- shunt/nodes/factory/main.yue:0
  local TestUplinkBackend = require('shunt.peripheral.uplink').TestUplinkBackend -- shunt/nodes/factory/main.yue:0
  local describe, it, matchers -- shunt/nodes/factory/main.yue:0
  do -- shunt/nodes/factory/main.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/factory/main.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/factory/main.yue:0
  end -- shunt/nodes/factory/main.yue:0
  local deep_eq, eq, has_fields, len, matches, some = matchers.deep_eq, matchers.eq, matchers.has_fields, matchers.len, matchers.matches, matchers.some -- shunt/nodes/factory/main.yue:381
  return describe('Factory', function() -- shunt/nodes/factory/main.yue:383
    it('resolves label and name mismatches', function() -- shunt/nodes/factory/main.yue:384
      local CONFIG_NAME = 'config-name' -- shunt/nodes/factory/main.yue:385
      local PC_NAME = 'pc-name' -- shunt/nodes/factory/main.yue:386
      local new_name = nil -- shunt/nodes/factory/main.yue:387
      local config = setmetatable({ -- shunt/nodes/factory/main.yue:390
        factory = { -- shunt/nodes/factory/main.yue:392
          name = CONFIG_NAME, -- shunt/nodes/factory/main.yue:392
          network = 'mainline' -- shunt/nodes/factory/main.yue:393
        }, -- shunt/nodes/factory/main.yue:391
        stockpile = { }, -- shunt/nodes/factory/main.yue:394
        stations = { } -- shunt/nodes/factory/main.yue:395
      }, { -- shunt/nodes/factory/main.yue:390
        __raw = '' -- shunt/nodes/factory/main.yue:390
      }) -- shunt/nodes/factory/main.yue:389
      local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:397
        name = function(self) -- shunt/nodes/factory/main.yue:397
          return PC_NAME -- shunt/nodes/factory/main.yue:397
        end, -- shunt/nodes/factory/main.yue:397
        set_name = function(self, name) -- shunt/nodes/factory/main.yue:398
          new_name = name -- shunt/nodes/factory/main.yue:399
        end -- shunt/nodes/factory/main.yue:398
      })) -- shunt/nodes/factory/main.yue:396
      local stations = { } -- shunt/nodes/factory/main.yue:400
      local stockpile = Stockpile({ -- shunt/nodes/factory/main.yue:401
        Inventory(TestInventoryBackend()) -- shunt/nodes/factory/main.yue:401
      }) -- shunt/nodes/factory/main.yue:401
      local uplink = Uplink(TestUplinkBackend()) -- shunt/nodes/factory/main.yue:402
      Factory(config, pc, stations, stockpile, uplink); -- shunt/nodes/factory/main.yue:404
      return require('shunt.spec')._expect_that([=[new_name]=], new_name, (eq(CONFIG_NAME)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(406)) -- shunt/nodes/factory/main.yue:406
    end) -- shunt/nodes/factory/main.yue:384
    it('responds to valid schedule requests', function() -- shunt/nodes/factory/main.yue:408
      local SERVER_ID = 12345 -- shunt/nodes/factory/main.yue:409
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/factory/main.yue:410
      local idemp_tok = IdempotenceToken() -- shunt/nodes/factory/main.yue:411
      local applied_schedules = { } -- shunt/nodes/factory/main.yue:412
      local STATION_NAME = 'test-station-name' -- shunt/nodes/factory/main.yue:414
      local schedule = { -- shunt/nodes/factory/main.yue:416
        cyclic = false, -- shunt/nodes/factory/main.yue:416
        entries = { -- shunt/nodes/factory/main.yue:418
          { -- shunt/nodes/factory/main.yue:418
            instruction = { -- shunt/nodes/factory/main.yue:419
              id = 'create:destination', -- shunt/nodes/factory/main.yue:419
              data = { -- shunt/nodes/factory/main.yue:420
                text = STATION_NAME -- shunt/nodes/factory/main.yue:420
              } -- shunt/nodes/factory/main.yue:420
            }, -- shunt/nodes/factory/main.yue:418
            conditions = { } -- shunt/nodes/factory/main.yue:421
          } -- shunt/nodes/factory/main.yue:418
        } -- shunt/nodes/factory/main.yue:417
      } -- shunt/nodes/factory/main.yue:415
      local PC_NAME = 'test-factory-name' -- shunt/nodes/factory/main.yue:423
      local config = setmetatable({ -- shunt/nodes/factory/main.yue:425
        factory = { -- shunt/nodes/factory/main.yue:427
          name = PC_NAME, -- shunt/nodes/factory/main.yue:427
          network = 'mainline' -- shunt/nodes/factory/main.yue:428
        }, -- shunt/nodes/factory/main.yue:426
        stockpile = { }, -- shunt/nodes/factory/main.yue:429
        stations = { } -- shunt/nodes/factory/main.yue:430
      }, { -- shunt/nodes/factory/main.yue:425
        __raw = '' -- shunt/nodes/factory/main.yue:425
      }) -- shunt/nodes/factory/main.yue:424
      local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:432
        id = function(self) -- shunt/nodes/factory/main.yue:432
          return PC_ID -- shunt/nodes/factory/main.yue:432
        end, -- shunt/nodes/factory/main.yue:432
        name = function(self) -- shunt/nodes/factory/main.yue:433
          return PC_NAME -- shunt/nodes/factory/main.yue:433
        end -- shunt/nodes/factory/main.yue:433
      })) -- shunt/nodes/factory/main.yue:431
      local stations = { -- shunt/nodes/factory/main.yue:435
        Station(TestStationBackend({ -- shunt/nodes/factory/main.yue:436
          name = function(self) -- shunt/nodes/factory/main.yue:436
            return STATION_NAME -- shunt/nodes/factory/main.yue:436
          end, -- shunt/nodes/factory/main.yue:436
          train_set_schedule = function(self, schedule) -- shunt/nodes/factory/main.yue:437
            applied_schedules[#applied_schedules + 1] = schedule -- shunt/nodes/factory/main.yue:438
            return true -- shunt/nodes/factory/main.yue:439
          end, -- shunt/nodes/factory/main.yue:437
          train_name = function(self) -- shunt/nodes/factory/main.yue:440
            return TRAIN_NAME -- shunt/nodes/factory/main.yue:440
          end -- shunt/nodes/factory/main.yue:440
        })) -- shunt/nodes/factory/main.yue:435
      } -- shunt/nodes/factory/main.yue:434
      local stockpile = Stockpile({ }) -- shunt/nodes/factory/main.yue:441
      local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/factory/main.yue:443
        to_receive = { -- shunt/nodes/factory/main.yue:444
          { -- shunt/nodes/factory/main.yue:444
            from_id = SERVER_ID, -- shunt/nodes/factory/main.yue:444
            packet = ScheduleRequest(idemp_tok, STATION_NAME, TRAIN_NAME, schedule) -- shunt/nodes/factory/main.yue:445
          } -- shunt/nodes/factory/main.yue:444
        } -- shunt/nodes/factory/main.yue:443
      })) -- shunt/nodes/factory/main.yue:442
      local factory = Factory(config, pc, stations, stockpile, uplink) -- shunt/nodes/factory/main.yue:446
      factory:do_network_step(); -- shunt/nodes/factory/main.yue:448
      require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(450)); -- shunt/nodes/factory/main.yue:450
      require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/factory/main.yue:451
        id = eq(SERVER_ID), -- shunt/nodes/factory/main.yue:451
        protocol = eq(ScheduleResponse:protocol()), -- shunt/nodes/factory/main.yue:451
        packet = has_fields({ -- shunt/nodes/factory/main.yue:451
          idemp_tok = eq(idemp_tok), -- shunt/nodes/factory/main.yue:451
          error_reason = eq(nil) -- shunt/nodes/factory/main.yue:451
        }) -- shunt/nodes/factory/main.yue:451
      })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(451)); -- shunt/nodes/factory/main.yue:451
      require('shunt.spec')._expect_that([=[applied_schedules]=], applied_schedules, (len(eq(1))), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(458)); -- shunt/nodes/factory/main.yue:458
      return require('shunt.spec')._expect_that([=[applied_schedules]=], applied_schedules, (deep_eq({ -- shunt/nodes/factory/main.yue:459
        schedule -- shunt/nodes/factory/main.yue:459
      })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(459)) -- shunt/nodes/factory/main.yue:459
    end) -- shunt/nodes/factory/main.yue:408
    it('responds to invalid schedule requests', function() -- shunt/nodes/factory/main.yue:461
      local SERVER_ID = 12345 -- shunt/nodes/factory/main.yue:462
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/factory/main.yue:463
      local idemp_tok = IdempotenceToken() -- shunt/nodes/factory/main.yue:464
      local STATION_NAME = 'test-station-name' -- shunt/nodes/factory/main.yue:466
      local schedule = { -- shunt/nodes/factory/main.yue:468
        cyclic = false, -- shunt/nodes/factory/main.yue:468
        entries = { -- shunt/nodes/factory/main.yue:470
          { -- shunt/nodes/factory/main.yue:470
            instruction = { -- shunt/nodes/factory/main.yue:471
              id = 'create:destination', -- shunt/nodes/factory/main.yue:471
              data = { -- shunt/nodes/factory/main.yue:472
                text = STATION_NAME -- shunt/nodes/factory/main.yue:472
              } -- shunt/nodes/factory/main.yue:472
            }, -- shunt/nodes/factory/main.yue:470
            conditions = { } -- shunt/nodes/factory/main.yue:473
          } -- shunt/nodes/factory/main.yue:470
        } -- shunt/nodes/factory/main.yue:469
      } -- shunt/nodes/factory/main.yue:467
      local FACTORY_NAME = 'test-factory-name' -- shunt/nodes/factory/main.yue:475
      local present_train_name = TRAIN_NAME -- shunt/nodes/factory/main.yue:476
      local config = setmetatable({ -- shunt/nodes/factory/main.yue:478
        factory = { -- shunt/nodes/factory/main.yue:480
          name = FACTORY_NAME, -- shunt/nodes/factory/main.yue:480
          network = 'mainline' -- shunt/nodes/factory/main.yue:481
        }, -- shunt/nodes/factory/main.yue:479
        stockpile = { }, -- shunt/nodes/factory/main.yue:482
        stations = { } -- shunt/nodes/factory/main.yue:483
      }, { -- shunt/nodes/factory/main.yue:478
        __raw = '' -- shunt/nodes/factory/main.yue:478
      }) -- shunt/nodes/factory/main.yue:477
      local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:485
        id = function(self) -- shunt/nodes/factory/main.yue:485
          return PC_ID -- shunt/nodes/factory/main.yue:485
        end, -- shunt/nodes/factory/main.yue:485
        name = function(self) -- shunt/nodes/factory/main.yue:486
          return FACTORY_NAME -- shunt/nodes/factory/main.yue:486
        end -- shunt/nodes/factory/main.yue:486
      })) -- shunt/nodes/factory/main.yue:484
      local stations = { -- shunt/nodes/factory/main.yue:488
        Station(TestStationBackend({ -- shunt/nodes/factory/main.yue:489
          name = function(self) -- shunt/nodes/factory/main.yue:489
            return 'some-other-station' -- shunt/nodes/factory/main.yue:489
          end, -- shunt/nodes/factory/main.yue:489
          train_set_schedule = function(self, schedule) -- shunt/nodes/factory/main.yue:490
            return error('train_set_schedule unexpectedly called') -- shunt/nodes/factory/main.yue:491
          end, -- shunt/nodes/factory/main.yue:490
          train_name = function(self) -- shunt/nodes/factory/main.yue:492
            return present_train_name -- shunt/nodes/factory/main.yue:492
          end -- shunt/nodes/factory/main.yue:492
        })) -- shunt/nodes/factory/main.yue:488
      } -- shunt/nodes/factory/main.yue:487
      local stockpile = Stockpile({ -- shunt/nodes/factory/main.yue:494
        Inventory(TestInventoryBackend({ -- shunt/nodes/factory/main.yue:495
          size = function(self) -- shunt/nodes/factory/main.yue:495
            return 1 -- shunt/nodes/factory/main.yue:495
          end, -- shunt/nodes/factory/main.yue:495
          slot_content = function(self, i) -- shunt/nodes/factory/main.yue:496
            require('shunt.spec')._assert_that([=[i]=], i, (eq(1)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(497)) -- shunt/nodes/factory/main.yue:497
            return { -- shunt/nodes/factory/main.yue:498
              count = 32, -- shunt/nodes/factory/main.yue:498
              displayName = 'Stone Bricks' -- shunt/nodes/factory/main.yue:498
            } -- shunt/nodes/factory/main.yue:498
          end, -- shunt/nodes/factory/main.yue:496
          slot_capacity = function(self, i) -- shunt/nodes/factory/main.yue:499
            require('shunt.spec')._assert_that([=[i]=], i, (eq(1)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(500)) -- shunt/nodes/factory/main.yue:500
            return 64 -- shunt/nodes/factory/main.yue:501
          end -- shunt/nodes/factory/main.yue:499
        })) -- shunt/nodes/factory/main.yue:494
      }) -- shunt/nodes/factory/main.yue:493
      local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/factory/main.yue:503
        to_receive = { -- shunt/nodes/factory/main.yue:504
          { -- shunt/nodes/factory/main.yue:504
            from_id = SERVER_ID, -- shunt/nodes/factory/main.yue:504
            packet = ScheduleRequest(idemp_tok, STATION_NAME, TRAIN_NAME, schedule) -- shunt/nodes/factory/main.yue:505
          } -- shunt/nodes/factory/main.yue:504
        } -- shunt/nodes/factory/main.yue:503
      })) -- shunt/nodes/factory/main.yue:502
      local factory = Factory(config, pc, stations, stockpile, uplink) -- shunt/nodes/factory/main.yue:506
      factory:do_network_step(); -- shunt/nodes/factory/main.yue:508
      require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(1))), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(510)); -- shunt/nodes/factory/main.yue:510
      return require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/factory/main.yue:511
        id = eq(SERVER_ID), -- shunt/nodes/factory/main.yue:511
        protocol = eq(ScheduleResponse:protocol()), -- shunt/nodes/factory/main.yue:511
        packet = has_fields({ -- shunt/nodes/factory/main.yue:511
          idemp_tok = eq(idemp_tok), -- shunt/nodes/factory/main.yue:511
          error_reason = some() -- shunt/nodes/factory/main.yue:511
        }) -- shunt/nodes/factory/main.yue:511
      })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(511)) -- shunt/nodes/factory/main.yue:516
    end) -- shunt/nodes/factory/main.yue:461
    describe('\\send_heartbeat', function() -- shunt/nodes/factory/main.yue:518
      return it('sends a heartbeat', function() -- shunt/nodes/factory/main.yue:519
        local SERVER_ID = 12345 -- shunt/nodes/factory/main.yue:520
        local PC_ID = 54321 -- shunt/nodes/factory/main.yue:521
        local PC_NAME = 'test-factory-name' -- shunt/nodes/factory/main.yue:522
        local config = setmetatable({ -- shunt/nodes/factory/main.yue:525
          factory = { -- shunt/nodes/factory/main.yue:527
            name = PC_NAME, -- shunt/nodes/factory/main.yue:527
            network = 'mainline' -- shunt/nodes/factory/main.yue:528
          }, -- shunt/nodes/factory/main.yue:526
          stockpile = { -- shunt/nodes/factory/main.yue:530
            { -- shunt/nodes/factory/main.yue:530
              name = 'minecraft:stone_bricks', -- shunt/nodes/factory/main.yue:530
              surplus_amount = 128 -- shunt/nodes/factory/main.yue:531
            }, -- shunt/nodes/factory/main.yue:530
            { -- shunt/nodes/factory/main.yue:532
              name = 'unseen_resource', -- shunt/nodes/factory/main.yue:532
              surplus_amount = 256 -- shunt/nodes/factory/main.yue:533
            } -- shunt/nodes/factory/main.yue:532
          }, -- shunt/nodes/factory/main.yue:529
          stations = { -- shunt/nodes/factory/main.yue:535
            { -- shunt/nodes/factory/main.yue:535
              name = 'known_station', -- shunt/nodes/factory/main.yue:535
              network = 'some-network', -- shunt/nodes/factory/main.yue:536
              type = 'inbound', -- shunt/nodes/factory/main.yue:537
              handles = 'minecraft:stone_bricks' -- shunt/nodes/factory/main.yue:538
            } -- shunt/nodes/factory/main.yue:535
          } -- shunt/nodes/factory/main.yue:534
        }, { -- shunt/nodes/factory/main.yue:525
          __raw = '' -- shunt/nodes/factory/main.yue:525
        }) -- shunt/nodes/factory/main.yue:524
        local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:540
          id = function(self) -- shunt/nodes/factory/main.yue:540
            return PC_ID -- shunt/nodes/factory/main.yue:540
          end, -- shunt/nodes/factory/main.yue:540
          name = function(self) -- shunt/nodes/factory/main.yue:541
            return PC_NAME -- shunt/nodes/factory/main.yue:541
          end -- shunt/nodes/factory/main.yue:541
        })) -- shunt/nodes/factory/main.yue:539
        local stations = { -- shunt/nodes/factory/main.yue:543
          Station(TestStationBackend({ -- shunt/nodes/factory/main.yue:544
            name = function(self) -- shunt/nodes/factory/main.yue:544
              return 'known_station' -- shunt/nodes/factory/main.yue:544
            end, -- shunt/nodes/factory/main.yue:544
            train_name = function(self) -- shunt/nodes/factory/main.yue:545
              return 'train_1' -- shunt/nodes/factory/main.yue:545
            end -- shunt/nodes/factory/main.yue:545
          })), -- shunt/nodes/factory/main.yue:543
          Station(TestStationBackend({ -- shunt/nodes/factory/main.yue:547
            name = function(self) -- shunt/nodes/factory/main.yue:547
              return 'unknown_station' -- shunt/nodes/factory/main.yue:547
            end, -- shunt/nodes/factory/main.yue:547
            train_name = function(self) -- shunt/nodes/factory/main.yue:548
              return 'train_2' -- shunt/nodes/factory/main.yue:548
            end -- shunt/nodes/factory/main.yue:548
          })) -- shunt/nodes/factory/main.yue:546
        } -- shunt/nodes/factory/main.yue:542
        local stockpile = Stockpile({ -- shunt/nodes/factory/main.yue:550
          Inventory(TestInventoryBackend({ -- shunt/nodes/factory/main.yue:551
            size = function(self) -- shunt/nodes/factory/main.yue:551
              return 2 -- shunt/nodes/factory/main.yue:551
            end, -- shunt/nodes/factory/main.yue:551
            list = function(self) -- shunt/nodes/factory/main.yue:552
              local _with_0 = { } -- shunt/nodes/factory/main.yue:553
              _with_0[#_with_0 + 1] = { -- shunt/nodes/factory/main.yue:554
                name = 'minecraft:stone_bricks', -- shunt/nodes/factory/main.yue:554
                count = 32 -- shunt/nodes/factory/main.yue:554
              } -- shunt/nodes/factory/main.yue:554
              _with_0[#_with_0 + 1] = { -- shunt/nodes/factory/main.yue:555
                name = 'minecraft:dirt', -- shunt/nodes/factory/main.yue:555
                count = 16 -- shunt/nodes/factory/main.yue:555
              } -- shunt/nodes/factory/main.yue:555
              return _with_0 -- shunt/nodes/factory/main.yue:553
            end, -- shunt/nodes/factory/main.yue:552
            slot_capacity = function(self, i) -- shunt/nodes/factory/main.yue:556
              return 64 -- shunt/nodes/factory/main.yue:556
            end -- shunt/nodes/factory/main.yue:556
          })) -- shunt/nodes/factory/main.yue:550
        }) -- shunt/nodes/factory/main.yue:549
        local uplink = Uplink(TestUplinkBackend()) -- shunt/nodes/factory/main.yue:557
        do -- shunt/nodes/factory/main.yue:558
          local _with_0 = Factory(config, pc, stations, stockpile, uplink) -- shunt/nodes/factory/main.yue:558
          _with_0:send_heartbeat() -- shunt/nodes/factory/main.yue:559
        end -- shunt/nodes/factory/main.yue:558
        require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (deep_eq({ })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(561)); -- shunt/nodes/factory/main.yue:561
        require('shunt.spec')._expect_that([=[uplink.backend.broadcasted]=], uplink.backend.broadcasted, (len(eq(1))), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(563)); -- shunt/nodes/factory/main.yue:563
        return require('shunt.spec')._expect_that([=[uplink.backend.broadcasted[1]]=], uplink.backend.broadcasted[1], (has_fields({ -- shunt/nodes/factory/main.yue:564
          protocol = eq(FactoryHeartbeat:protocol()), -- shunt/nodes/factory/main.yue:564
          packet = (function() -- shunt/nodes/factory/main.yue:564
            stations = { -- shunt/nodes/factory/main.yue:564
              known = { -- shunt/nodes/factory/main.yue:564
                { -- shunt/nodes/factory/main.yue:564
                  name = 'known_station', -- shunt/nodes/factory/main.yue:564
                  network = 'some-network', -- shunt/nodes/factory/main.yue:564
                  type = 'inbound', -- shunt/nodes/factory/main.yue:564
                  handles = 'minecraft:stone_bricks', -- shunt/nodes/factory/main.yue:564
                  capacity = 1, -- shunt/nodes/factory/main.yue:564
                  present_trains = { -- shunt/nodes/factory/main.yue:564
                    'train_1' -- shunt/nodes/factory/main.yue:564
                  } -- shunt/nodes/factory/main.yue:564
                } -- shunt/nodes/factory/main.yue:564
              }, -- shunt/nodes/factory/main.yue:564
              unknown = { -- shunt/nodes/factory/main.yue:564
                { -- shunt/nodes/factory/main.yue:564
                  name = 'unknown_station', -- shunt/nodes/factory/main.yue:564
                  capacity = 1, -- shunt/nodes/factory/main.yue:564
                  present_trains = { -- shunt/nodes/factory/main.yue:564
                    'train_2' -- shunt/nodes/factory/main.yue:564
                  } -- shunt/nodes/factory/main.yue:564
                } -- shunt/nodes/factory/main.yue:564
              } -- shunt/nodes/factory/main.yue:564
            } -- shunt/nodes/factory/main.yue:564
            local stockpile_info = { -- shunt/nodes/factory/main.yue:564
              known = { -- shunt/nodes/factory/main.yue:564
                { -- shunt/nodes/factory/main.yue:564
                  name = 'minecraft:stone_bricks', -- shunt/nodes/factory/main.yue:564
                  stored = 32, -- shunt/nodes/factory/main.yue:564
                  surplus_amount = 128 -- shunt/nodes/factory/main.yue:564
                }, -- shunt/nodes/factory/main.yue:564
                { -- shunt/nodes/factory/main.yue:564
                  name = 'unseen_resource', -- shunt/nodes/factory/main.yue:564
                  stored = 0, -- shunt/nodes/factory/main.yue:564
                  surplus_amount = 256 -- shunt/nodes/factory/main.yue:564
                } -- shunt/nodes/factory/main.yue:564
              }, -- shunt/nodes/factory/main.yue:564
              unknown = { -- shunt/nodes/factory/main.yue:564
                { -- shunt/nodes/factory/main.yue:564
                  name = 'minecraft:dirt', -- shunt/nodes/factory/main.yue:564
                  stored = 16 -- shunt/nodes/factory/main.yue:564
                } -- shunt/nodes/factory/main.yue:564
              }, -- shunt/nodes/factory/main.yue:564
              estimated_capacity = 128 -- shunt/nodes/factory/main.yue:564
            } -- shunt/nodes/factory/main.yue:564
            return deep_eq(FactoryHeartbeat(PC_ID, PC_NAME, stations, stockpile_info)) -- shunt/nodes/factory/main.yue:564
          end)() -- shunt/nodes/factory/main.yue:564
        })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(564)) -- shunt/nodes/factory/main.yue:594
      end) -- shunt/nodes/factory/main.yue:594
    end) -- shunt/nodes/factory/main.yue:518
    describe('\\on_get_config_request', function() -- shunt/nodes/factory/main.yue:596
      return it('responds correctly', function() -- shunt/nodes/factory/main.yue:597
        local idemp_tok = IdempotenceToken() -- shunt/nodes/factory/main.yue:598
        local REQUESTER_PC_ID = 1 -- shunt/nodes/factory/main.yue:600
        local FACTORY_PC_ID = 1 -- shunt/nodes/factory/main.yue:601
        local FACTORY_NAME = 'factory-name' -- shunt/nodes/factory/main.yue:602
        local RAW = '[config]\n' -- shunt/nodes/factory/main.yue:603
        local config = setmetatable({ -- shunt/nodes/factory/main.yue:606
          factory = { -- shunt/nodes/factory/main.yue:608
            name = FACTORY_NAME -- shunt/nodes/factory/main.yue:608
          }, -- shunt/nodes/factory/main.yue:607
          stockpile = { }, -- shunt/nodes/factory/main.yue:609
          stations = { } -- shunt/nodes/factory/main.yue:610
        }, { -- shunt/nodes/factory/main.yue:606
          __raw = RAW -- shunt/nodes/factory/main.yue:606
        }) -- shunt/nodes/factory/main.yue:605
        local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:612
          id = function(self) -- shunt/nodes/factory/main.yue:612
            return FACTORY_PC_ID -- shunt/nodes/factory/main.yue:612
          end, -- shunt/nodes/factory/main.yue:612
          name = function(self) -- shunt/nodes/factory/main.yue:613
            return FACTORY_NAME -- shunt/nodes/factory/main.yue:613
          end -- shunt/nodes/factory/main.yue:613
        })) -- shunt/nodes/factory/main.yue:611
        local stockpile = Stockpile({ }) -- shunt/nodes/factory/main.yue:614
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/factory/main.yue:616
          to_receive = { -- shunt/nodes/factory/main.yue:617
            { -- shunt/nodes/factory/main.yue:617
              from_id = REQUESTER_PC_ID, -- shunt/nodes/factory/main.yue:617
              packet = GetConfigRequest(idemp_tok, REQUESTER_PC_ID) -- shunt/nodes/factory/main.yue:618
            } -- shunt/nodes/factory/main.yue:617
          } -- shunt/nodes/factory/main.yue:616
        })) -- shunt/nodes/factory/main.yue:615
        local _with_0 = Factory(config, pc, { }, stockpile, uplink) -- shunt/nodes/factory/main.yue:619
        _with_0:do_network_step(); -- shunt/nodes/factory/main.yue:620
        require('shunt.spec')._assert_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (eq(1)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(622)); -- shunt/nodes/factory/main.yue:622
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/factory/main.yue:623
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/factory/main.yue:623
          packet = has_fields({ -- shunt/nodes/factory/main.yue:623
            idemp_tok = eq(idemp_tok), -- shunt/nodes/factory/main.yue:623
            raw = eq(RAW) -- shunt/nodes/factory/main.yue:623
          }), -- shunt/nodes/factory/main.yue:623
          protocol = eq(GetConfigResponse:protocol()) -- shunt/nodes/factory/main.yue:623
        })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(623)) -- shunt/nodes/factory/main.yue:623
        return _with_0 -- shunt/nodes/factory/main.yue:619
      end) -- shunt/nodes/factory/main.yue:628
    end) -- shunt/nodes/factory/main.yue:596
    return describe('\\on_set_config_request', function() -- shunt/nodes/factory/main.yue:630
      it('applies valid config', function() -- shunt/nodes/factory/main.yue:631
        local idemp_tok = IdempotenceToken() -- shunt/nodes/factory/main.yue:632
        local REQUESTER_PC_ID = 1 -- shunt/nodes/factory/main.yue:634
        local FACTORY_PC_ID = 1 -- shunt/nodes/factory/main.yue:635
        local FACTORY_NAME = 'factory-name' -- shunt/nodes/factory/main.yue:636
        local NEW_FACTORY_NAME = 'new-factory-name' -- shunt/nodes/factory/main.yue:638
        local NEW_RAW = "\n          [factory]\n          name = '" .. tostring(NEW_FACTORY_NAME) .. "'\n\n          # NB: these are usually arrays of tables, but for ease of testing,\n          # they are left empty\n          [stockpile]\n          [stations]\n        " -- shunt/nodes/factory/main.yue:639
        local config = setmetatable({ -- shunt/nodes/factory/main.yue:650
          factory = { -- shunt/nodes/factory/main.yue:652
            name = FACTORY_NAME -- shunt/nodes/factory/main.yue:652
          }, -- shunt/nodes/factory/main.yue:651
          stockpile = { }, -- shunt/nodes/factory/main.yue:653
          stations = { } -- shunt/nodes/factory/main.yue:654
        }, { -- shunt/nodes/factory/main.yue:650
          __raw = '' -- shunt/nodes/factory/main.yue:650
        }) -- shunt/nodes/factory/main.yue:649
        local pc = Pc(TestPcBackend((function() -- shunt/nodes/factory/main.yue:655
          local _with_0 = { } -- shunt/nodes/factory/main.yue:655
          local name = FACTORY_NAME -- shunt/nodes/factory/main.yue:656
          _with_0.id = function(self) -- shunt/nodes/factory/main.yue:657
            return FACTORY_PC_ID -- shunt/nodes/factory/main.yue:657
          end -- shunt/nodes/factory/main.yue:657
          _with_0.name = function(self) -- shunt/nodes/factory/main.yue:658
            return name -- shunt/nodes/factory/main.yue:658
          end -- shunt/nodes/factory/main.yue:658
          _with_0.set_name = function(self, new_name) -- shunt/nodes/factory/main.yue:659
            name = new_name -- shunt/nodes/factory/main.yue:660
          end -- shunt/nodes/factory/main.yue:659
          return _with_0 -- shunt/nodes/factory/main.yue:655
        end)())) -- shunt/nodes/factory/main.yue:655
        local stockpile = Stockpile({ }) -- shunt/nodes/factory/main.yue:661
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/factory/main.yue:663
          to_receive = { -- shunt/nodes/factory/main.yue:664
            { -- shunt/nodes/factory/main.yue:664
              from_id = REQUESTER_PC_ID, -- shunt/nodes/factory/main.yue:664
              packet = SetConfigRequest(idemp_tok, REQUESTER_PC_ID, NEW_RAW) -- shunt/nodes/factory/main.yue:665
            } -- shunt/nodes/factory/main.yue:664
          } -- shunt/nodes/factory/main.yue:663
        })) -- shunt/nodes/factory/main.yue:662
        local _with_0 = Factory(config, pc, { }, stockpile, uplink) -- shunt/nodes/factory/main.yue:666
        _with_0:do_network_step(); -- shunt/nodes/factory/main.yue:667
        require('shunt.spec')._assert_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (eq(1)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(669)); -- shunt/nodes/factory/main.yue:669
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/factory/main.yue:670
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/factory/main.yue:670
          packet = has_fields({ -- shunt/nodes/factory/main.yue:670
            idemp_tok = eq(idemp_tok), -- shunt/nodes/factory/main.yue:670
            error_reason = eq(nil) -- shunt/nodes/factory/main.yue:670
          }), -- shunt/nodes/factory/main.yue:670
          protocol = eq(SetConfigResponse:protocol()) -- shunt/nodes/factory/main.yue:670
        })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(670)); -- shunt/nodes/factory/main.yue:670
        require('shunt.spec')._expect_that([=[.config]=], _with_0.config, (deep_eq({ -- shunt/nodes/factory/main.yue:676
          factory = { -- shunt/nodes/factory/main.yue:676
            name = NEW_FACTORY_NAME -- shunt/nodes/factory/main.yue:676
          }, -- shunt/nodes/factory/main.yue:676
          stations = { }, -- shunt/nodes/factory/main.yue:676
          stockpile = { } -- shunt/nodes/factory/main.yue:676
        })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(676)); -- shunt/nodes/factory/main.yue:676
        require('shunt.spec')._expect_that([=[.config.<raw>]=], getmetatable(_with_0.config).__raw, (eq(NEW_RAW)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(681)); -- shunt/nodes/factory/main.yue:681
        require('shunt.spec')._expect_that([=[\name!]=], _with_0:name(), (eq(NEW_FACTORY_NAME)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(682)); -- shunt/nodes/factory/main.yue:682
        require('shunt.spec')._expect_that([=[pc\name!]=], pc:name(), (eq(NEW_FACTORY_NAME)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(683)) -- shunt/nodes/factory/main.yue:683
        return _with_0 -- shunt/nodes/factory/main.yue:666
      end) -- shunt/nodes/factory/main.yue:631
      return it('rejects invalid config', function() -- shunt/nodes/factory/main.yue:685
        local idemp_tok = IdempotenceToken() -- shunt/nodes/factory/main.yue:686
        local REQUESTER_PC_ID = 1 -- shunt/nodes/factory/main.yue:688
        local FACTORY_PC_ID = 1 -- shunt/nodes/factory/main.yue:689
        local FACTORY_NAME = 'factory-name' -- shunt/nodes/factory/main.yue:690
        local NEW_FACTORY_NAME = 'factory-name' -- shunt/nodes/factory/main.yue:692
        local NEW_RAW = '' -- shunt/nodes/factory/main.yue:693
        local ORIGINAL_RAW = 'original raw config' -- shunt/nodes/factory/main.yue:695
        local config = setmetatable({ -- shunt/nodes/factory/main.yue:697
          factory = { -- shunt/nodes/factory/main.yue:699
            name = FACTORY_NAME -- shunt/nodes/factory/main.yue:699
          }, -- shunt/nodes/factory/main.yue:698
          stockpile = { }, -- shunt/nodes/factory/main.yue:700
          stations = { } -- shunt/nodes/factory/main.yue:701
        }, { -- shunt/nodes/factory/main.yue:697
          __raw = ORIGINAL_RAW -- shunt/nodes/factory/main.yue:697
        }) -- shunt/nodes/factory/main.yue:696
        local pc = Pc(TestPcBackend({ -- shunt/nodes/factory/main.yue:703
          id = function(self) -- shunt/nodes/factory/main.yue:703
            return FACTORY_PC_ID -- shunt/nodes/factory/main.yue:703
          end, -- shunt/nodes/factory/main.yue:703
          name = function(self) -- shunt/nodes/factory/main.yue:704
            return FACTORY_NAME -- shunt/nodes/factory/main.yue:704
          end -- shunt/nodes/factory/main.yue:704
        })) -- shunt/nodes/factory/main.yue:702
        local stockpile = Stockpile({ }) -- shunt/nodes/factory/main.yue:705
        local uplink = Uplink(TestUplinkBackend({ -- shunt/nodes/factory/main.yue:707
          to_receive = { -- shunt/nodes/factory/main.yue:708
            { -- shunt/nodes/factory/main.yue:708
              from_id = REQUESTER_PC_ID, -- shunt/nodes/factory/main.yue:708
              packet = SetConfigRequest(idemp_tok, REQUESTER_PC_ID, NEW_RAW) -- shunt/nodes/factory/main.yue:709
            } -- shunt/nodes/factory/main.yue:708
          } -- shunt/nodes/factory/main.yue:707
        })) -- shunt/nodes/factory/main.yue:706
        local _with_0 = Factory(config, pc, { }, stockpile, uplink) -- shunt/nodes/factory/main.yue:710
        _with_0:do_network_step(); -- shunt/nodes/factory/main.yue:711
        require('shunt.spec')._assert_that([=[#uplink.backend.sent]=], #uplink.backend.sent, (eq(1)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(713)); -- shunt/nodes/factory/main.yue:713
        require('shunt.spec')._expect_that([=[uplink.backend.sent[1]]=], uplink.backend.sent[1], (has_fields({ -- shunt/nodes/factory/main.yue:714
          id = eq(REQUESTER_PC_ID), -- shunt/nodes/factory/main.yue:714
          packet = has_fields({ -- shunt/nodes/factory/main.yue:714
            idemp_tok = eq(idemp_tok), -- shunt/nodes/factory/main.yue:714
            error_reason = matches('expected table but got nil') -- shunt/nodes/factory/main.yue:714
          }), -- shunt/nodes/factory/main.yue:714
          protocol = eq(SetConfigResponse:protocol()) -- shunt/nodes/factory/main.yue:714
        })), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(714)); -- shunt/nodes/factory/main.yue:714
        require('shunt.spec')._expect_that([=[.config]=], _with_0.config, (deep_eq(config)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(720)); -- shunt/nodes/factory/main.yue:720
        require('shunt.spec')._expect_that([=[.config.<raw>]=], getmetatable(_with_0.config).__raw, (eq(ORIGINAL_RAW)), tostring("shunt/nodes/factory/main.yue") .. ":" .. tostring(721)) -- shunt/nodes/factory/main.yue:721
        return _with_0 -- shunt/nodes/factory/main.yue:710
      end) -- shunt/nodes/factory/main.yue:721
    end) -- shunt/nodes/factory/main.yue:721
  end) -- shunt/nodes/factory/main.yue:721
end) -- shunt/nodes/factory/main.yue:372
return _module_0 -- shunt/nodes/factory/main.yue:721
end
package.preload['shunt.peripheral.station'] = function(...)
-- [yue]: shunt/peripheral/station.yue
local _module_0 = { } -- shunt/peripheral/station.yue:1
local time_units, CARGO_INACTIVE_CONDITION, CARGO_INACTIVE_TIMEOUT, OVERALL_TIMEOUT -- shunt/peripheral/station.yue:1
local declare_type, F -- shunt/peripheral/station.yue:0
do -- shunt/peripheral/station.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/peripheral/station.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/peripheral/station.yue:0
end -- shunt/peripheral/station.yue:0
local spec = require('shunt.spec').spec -- shunt/peripheral/station.yue:0
declare_type('StationBackend', [[{
  name: () => StationName,
  set_name: (StationName) => <>,
  train_present: () => boolean,
  train_enroute: () => boolean,
  train_has_schedule: () => ?boolean,
  train_schedule: () => ?Schedule,
  train_set_schedule: (Schedule) => boolean,
  train_name: () => ?string,
}]]) -- shunt/peripheral/station.yue:6
declare_type('StationName', 'string') -- shunt/peripheral/station.yue:16
declare_type('Schedule', [[{
  cyclic: boolean,
  entries: [ScheduleEntry],
}]]) -- shunt/peripheral/station.yue:17
declare_type('ScheduleEntry', [=[{
  instruction: {
    id: "create:destination",
    data: { text: string },
  },
  conditions: [[{
    id: "create:idle"|"create:delay",
    data: {
      value: number,
      time_unit: TimeUnit,
    },
  }]]
}]=]) -- shunt/peripheral/station.yue:21
declare_type('TimeUnit', '0|1|2') -- shunt/peripheral/station.yue:34
declare_type('Resource', [[{
  id: () => string,
  kind: () => "cargo"|"player"
}]]) -- shunt/peripheral/station.yue:35
declare_type('Station', [[{
  name: () => StationName,
  train_name: () => ?string,
  apply_schedule: (Schedule) => boolean,
}]]) -- shunt/peripheral/station.yue:40
declare_type('StationInfo', [[{
  name: StationName,
  train_name: ?string,
}]]) -- shunt/peripheral/station.yue:45
local Station -- shunt/peripheral/station.yue:49
do -- shunt/peripheral/station.yue:49
  local _class_0 -- shunt/peripheral/station.yue:49
  local _base_0 = { -- shunt/peripheral/station.yue:49
    validate = F('() => ?string', function(self) -- shunt/peripheral/station.yue:52
      if self:name() == 'Track Station' then -- shunt/peripheral/station.yue:53
        return 'cannot use default station name "Track Station", please manually rename it' -- shunt/peripheral/station.yue:54
      end -- shunt/peripheral/station.yue:53
      return nil -- shunt/peripheral/station.yue:55
    end), -- shunt/peripheral/station.yue:57
    name = F('() => StationName', function(self) -- shunt/peripheral/station.yue:57
      return self.backend:name() -- shunt/peripheral/station.yue:58
    end), -- shunt/peripheral/station.yue:60
    train_name = F('() => ?string', function(self) -- shunt/peripheral/station.yue:60
      return self.backend:train_name() -- shunt/peripheral/station.yue:61
    end), -- shunt/peripheral/station.yue:63
    info = F('() => StationInfo', function(self) -- shunt/peripheral/station.yue:63
      local _with_0 = { } -- shunt/peripheral/station.yue:64
      _with_0.name = self.backend:name() -- shunt/peripheral/station.yue:65
      _with_0.train_name = self.backend:train_name() -- shunt/peripheral/station.yue:66
      return _with_0 -- shunt/peripheral/station.yue:64
    end), -- shunt/peripheral/station.yue:68
    apply_schedule = F('(Schedule) => boolean', function(self, schedule) -- shunt/peripheral/station.yue:68
      return self.backend:train_set_schedule(schedule) -- shunt/peripheral/station.yue:69
    end) -- shunt/peripheral/station.yue:49
  } -- shunt/peripheral/station.yue:49
  if _base_0.__index == nil then -- shunt/peripheral/station.yue:49
    _base_0.__index = _base_0 -- shunt/peripheral/station.yue:49
  end -- shunt/peripheral/station.yue:69
  _class_0 = setmetatable({ -- shunt/peripheral/station.yue:49
    __init = F('(?StationBackend) => <>', function(self, backend) -- shunt/peripheral/station.yue:50
      self.backend = backend -- shunt/peripheral/station.yue:50
    end), -- shunt/peripheral/station.yue:49
    __base = _base_0, -- shunt/peripheral/station.yue:49
    __name = "Station" -- shunt/peripheral/station.yue:49
  }, { -- shunt/peripheral/station.yue:49
    __index = _base_0, -- shunt/peripheral/station.yue:49
    __call = function(cls, ...) -- shunt/peripheral/station.yue:49
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/station.yue:49
      cls.__init(_self_0, ...) -- shunt/peripheral/station.yue:49
      return _self_0 -- shunt/peripheral/station.yue:49
    end -- shunt/peripheral/station.yue:49
  }) -- shunt/peripheral/station.yue:49
  _base_0.__class = _class_0 -- shunt/peripheral/station.yue:49
  Station = _class_0 -- shunt/peripheral/station.yue:49
end -- shunt/peripheral/station.yue:69
_module_0["Station"] = Station -- shunt/peripheral/station.yue:49
time_units = { -- shunt/peripheral/station.yue:72
  TICKS = 0, -- shunt/peripheral/station.yue:72
  SECONDS = 1, -- shunt/peripheral/station.yue:73
  MINUTES = 2 -- shunt/peripheral/station.yue:74
} -- shunt/peripheral/station.yue:71
_module_0["time_units"] = time_units -- shunt/peripheral/station.yue:74
CARGO_INACTIVE_CONDITION = { -- shunt/peripheral/station.yue:76
  id = "create:idle", -- shunt/peripheral/station.yue:76
  data = { -- shunt/peripheral/station.yue:78
    value = 5, -- shunt/peripheral/station.yue:78
    time_unit = time_units.SECONDS -- shunt/peripheral/station.yue:79
  } -- shunt/peripheral/station.yue:77
} -- shunt/peripheral/station.yue:75
CARGO_INACTIVE_TIMEOUT = { -- shunt/peripheral/station.yue:81
  id = "create:delay", -- shunt/peripheral/station.yue:81
  data = { -- shunt/peripheral/station.yue:83
    value = 15, -- shunt/peripheral/station.yue:83
    time_unit = time_units.SECONDS -- shunt/peripheral/station.yue:84
  } -- shunt/peripheral/station.yue:82
} -- shunt/peripheral/station.yue:80
OVERALL_TIMEOUT = { -- shunt/peripheral/station.yue:86
  id = "create:delay", -- shunt/peripheral/station.yue:86
  data = { -- shunt/peripheral/station.yue:88
    value = 30, -- shunt/peripheral/station.yue:88
    time_unit = time_units.SECONDS -- shunt/peripheral/station.yue:89
  } -- shunt/peripheral/station.yue:87
} -- shunt/peripheral/station.yue:85
declare_type('StationPeripheral', [[{
  getStationName: () => StationName,
}]]) -- shunt/peripheral/station.yue:91
local MinecraftBackend -- shunt/peripheral/station.yue:94
do -- shunt/peripheral/station.yue:94
  local _class_0 -- shunt/peripheral/station.yue:94
  local _base_0 = { -- shunt/peripheral/station.yue:94
    name = F('() => StationName', function(self) -- shunt/peripheral/station.yue:101
      return self.station.getStationName() -- shunt/peripheral/station.yue:102
    end), -- shunt/peripheral/station.yue:104
    set_name = F('(StationName) => <>', function(self, name) -- shunt/peripheral/station.yue:104
      return self.station.setStationName(name) -- shunt/peripheral/station.yue:105
    end), -- shunt/peripheral/station.yue:107
    train_present = F('() => boolean', function(self) -- shunt/peripheral/station.yue:107
      return self.station.isTrainPresent() -- shunt/peripheral/station.yue:108
    end), -- shunt/peripheral/station.yue:110
    train_enroute = F('() => boolean', function(self) -- shunt/peripheral/station.yue:110
      return self.station.isTrainEnroute() -- shunt/peripheral/station.yue:111
    end), -- shunt/peripheral/station.yue:113
    train_has_schedule = F('() => ?boolean', function(self) -- shunt/peripheral/station.yue:113
      local ret = nil -- shunt/peripheral/station.yue:114
xpcall(function() -- shunt/peripheral/station.yue:115
        ret = self.station.hasSchedule() -- shunt/peripheral/station.yue:116
      end, function(_) end) -- shunt/peripheral/station.yue:118
      return ret -- shunt/peripheral/station.yue:119
    end), -- shunt/peripheral/station.yue:121
    train_schedule = F('() => ?Schedule', function(self) -- shunt/peripheral/station.yue:121
      local schedule = nil -- shunt/peripheral/station.yue:122
xpcall(function() -- shunt/peripheral/station.yue:123
        schedule = self.station.getSchedule() -- shunt/peripheral/station.yue:124
      end, function(_) end) -- shunt/peripheral/station.yue:126
      return schedule -- shunt/peripheral/station.yue:127
    end), -- shunt/peripheral/station.yue:129
    train_set_schedule = F('(Schedule) => boolean', function(self, schedule) -- shunt/peripheral/station.yue:129
      local ret -- shunt/peripheral/station.yue:130
xpcall(function() -- shunt/peripheral/station.yue:131
        self.station.setSchedule(schedule) -- shunt/peripheral/station.yue:132
        ret = true -- shunt/peripheral/station.yue:133
      end, function(_) -- shunt/peripheral/station.yue:133
        ret = false -- shunt/peripheral/station.yue:135
      end) -- shunt/peripheral/station.yue:135
      return ret -- shunt/peripheral/station.yue:136
    end), -- shunt/peripheral/station.yue:138
    train_name = F('() => ?string', function(self) -- shunt/peripheral/station.yue:138
      local name = nil -- shunt/peripheral/station.yue:139
xpcall(function() -- shunt/peripheral/station.yue:140
        name = self.station.getTrainName() -- shunt/peripheral/station.yue:141
      end, function(err) end) -- shunt/peripheral/station.yue:143
      return name -- shunt/peripheral/station.yue:144
    end) -- shunt/peripheral/station.yue:94
  } -- shunt/peripheral/station.yue:94
  if _base_0.__index == nil then -- shunt/peripheral/station.yue:94
    _base_0.__index = _base_0 -- shunt/peripheral/station.yue:94
  end -- shunt/peripheral/station.yue:144
  _class_0 = setmetatable({ -- shunt/peripheral/station.yue:94
    __init = F('(StationPeripheral) => <>', function(self, station) -- shunt/peripheral/station.yue:99
      self.station = station -- shunt/peripheral/station.yue:99
    end), -- shunt/peripheral/station.yue:94
    __base = _base_0, -- shunt/peripheral/station.yue:94
    __name = "MinecraftBackend" -- shunt/peripheral/station.yue:94
  }, { -- shunt/peripheral/station.yue:94
    __index = _base_0, -- shunt/peripheral/station.yue:94
    __call = function(cls, ...) -- shunt/peripheral/station.yue:94
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/station.yue:94
      cls.__init(_self_0, ...) -- shunt/peripheral/station.yue:94
      return _self_0 -- shunt/peripheral/station.yue:94
    end -- shunt/peripheral/station.yue:94
  }) -- shunt/peripheral/station.yue:94
  _base_0.__class = _class_0 -- shunt/peripheral/station.yue:94
  local self = _class_0; -- shunt/peripheral/station.yue:94
  self.find = F('() => [StationBackend]', function(self) -- shunt/peripheral/station.yue:95
    local station_peripherals = { -- shunt/peripheral/station.yue:96
      peripheral.find('Create_Station') -- shunt/peripheral/station.yue:96
    } -- shunt/peripheral/station.yue:96
    local _accum_0 = { } -- shunt/peripheral/station.yue:97
    local _len_0 = 1 -- shunt/peripheral/station.yue:97
    for _index_0 = 1, #station_peripherals do -- shunt/peripheral/station.yue:97
      local peripheral = station_peripherals[_index_0] -- shunt/peripheral/station.yue:97
      _accum_0[_len_0] = MinecraftBackend(peripheral) -- shunt/peripheral/station.yue:97
      _len_0 = _len_0 + 1 -- shunt/peripheral/station.yue:97
    end -- shunt/peripheral/station.yue:97
    return _accum_0 -- shunt/peripheral/station.yue:97
  end) -- shunt/peripheral/station.yue:95
  MinecraftBackend = _class_0 -- shunt/peripheral/station.yue:94
end -- shunt/peripheral/station.yue:144
_module_0["MinecraftBackend"] = MinecraftBackend -- shunt/peripheral/station.yue:94
declare_type('TestStationBackendOpts', [[{
  name: ?() => StationName,
  set_name: ?(StationName) => <>,
  train_present: ?() => boolean,
  train_enroute: ?() => boolean,
  train_has_schedule: ?() => ?boolean,
  train_schedule: ?() => ?Schedule,
  train_set_schedule: ?(Schedule) => boolean,
  train_name: ?() => ?string,
}]]) -- shunt/peripheral/station.yue:146
local TestStationBackend -- shunt/peripheral/station.yue:156
do -- shunt/peripheral/station.yue:156
  local _class_0 -- shunt/peripheral/station.yue:156
  local _base_0 = { } -- shunt/peripheral/station.yue:156
  if _base_0.__index == nil then -- shunt/peripheral/station.yue:156
    _base_0.__index = _base_0 -- shunt/peripheral/station.yue:156
  end -- shunt/peripheral/station.yue:175
  _class_0 = setmetatable({ -- shunt/peripheral/station.yue:156
    __init = F('(?TestStationBackendOpts) => <>', function(self, opts) -- shunt/peripheral/station.yue:157
      if opts == nil then -- shunt/peripheral/station.yue:157
        opts = { } -- shunt/peripheral/station.yue:157
      end -- shunt/peripheral/station.yue:157
      local name, set_name, train_present, train_enroute, train_has_schedule, train_schedule, train_set_schedule, train_name = opts.name, opts.set_name, opts.train_present, opts.train_enroute, opts.train_has_schedule, opts.train_schedule, opts.train_set_schedule, opts.train_name -- shunt/peripheral/station.yue:158
      if name == nil then -- shunt/peripheral/station.yue:159
        name = function() -- shunt/peripheral/station.yue:159
          return error('name unimplemented') -- shunt/peripheral/station.yue:159
        end -- shunt/peripheral/station.yue:159
      end -- shunt/peripheral/station.yue:159
      if set_name == nil then -- shunt/peripheral/station.yue:160
        set_name = function() -- shunt/peripheral/station.yue:160
          return error('set_name unimplemented') -- shunt/peripheral/station.yue:160
        end -- shunt/peripheral/station.yue:160
      end -- shunt/peripheral/station.yue:160
      if train_present == nil then -- shunt/peripheral/station.yue:161
        train_present = function() -- shunt/peripheral/station.yue:161
          return error('train_present unimplemented') -- shunt/peripheral/station.yue:161
        end -- shunt/peripheral/station.yue:161
      end -- shunt/peripheral/station.yue:161
      if train_enroute == nil then -- shunt/peripheral/station.yue:162
        train_enroute = function() -- shunt/peripheral/station.yue:162
          return error('train_enroute unimplemented') -- shunt/peripheral/station.yue:162
        end -- shunt/peripheral/station.yue:162
      end -- shunt/peripheral/station.yue:162
      if train_has_schedule == nil then -- shunt/peripheral/station.yue:163
        train_has_schedule = function() -- shunt/peripheral/station.yue:163
          return error('train_has_schedule unimplemented') -- shunt/peripheral/station.yue:163
        end -- shunt/peripheral/station.yue:163
      end -- shunt/peripheral/station.yue:163
      if train_schedule == nil then -- shunt/peripheral/station.yue:164
        train_schedule = function() -- shunt/peripheral/station.yue:164
          return error('train_schedule unimplemented') -- shunt/peripheral/station.yue:164
        end -- shunt/peripheral/station.yue:164
      end -- shunt/peripheral/station.yue:164
      if train_set_schedule == nil then -- shunt/peripheral/station.yue:165
        train_set_schedule = function() -- shunt/peripheral/station.yue:165
          return error('train_set_schedule unimplemented') -- shunt/peripheral/station.yue:165
        end -- shunt/peripheral/station.yue:165
      end -- shunt/peripheral/station.yue:165
      if train_name == nil then -- shunt/peripheral/station.yue:166
        train_name = function() -- shunt/peripheral/station.yue:166
          return error('train_name unimplemented') -- shunt/peripheral/station.yue:166
        end -- shunt/peripheral/station.yue:166
      end -- shunt/peripheral/station.yue:166
      self.name = F('() => StationName', name) -- shunt/peripheral/station.yue:168
      self.set_name = F('(StationName) => <>', set_name) -- shunt/peripheral/station.yue:169
      self.train_present = F('() => boolean', train_present) -- shunt/peripheral/station.yue:170
      self.train_enroute = F('() => boolean', train_enroute) -- shunt/peripheral/station.yue:171
      self.train_has_schedule = F('() => ?boolean', train_has_schedule) -- shunt/peripheral/station.yue:172
      self.train_schedule = F('() => ?Schedule', train_schedule) -- shunt/peripheral/station.yue:173
      self.train_set_schedule = F('(Schedule) => boolean', train_set_schedule) -- shunt/peripheral/station.yue:174
      self.train_name = F('() => ?string', train_name) -- shunt/peripheral/station.yue:175
    end), -- shunt/peripheral/station.yue:156
    __base = _base_0, -- shunt/peripheral/station.yue:156
    __name = "TestStationBackend" -- shunt/peripheral/station.yue:156
  }, { -- shunt/peripheral/station.yue:156
    __index = _base_0, -- shunt/peripheral/station.yue:156
    __call = function(cls, ...) -- shunt/peripheral/station.yue:156
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/station.yue:156
      cls.__init(_self_0, ...) -- shunt/peripheral/station.yue:156
      return _self_0 -- shunt/peripheral/station.yue:156
    end -- shunt/peripheral/station.yue:156
  }) -- shunt/peripheral/station.yue:156
  _base_0.__class = _class_0 -- shunt/peripheral/station.yue:156
  TestStationBackend = _class_0 -- shunt/peripheral/station.yue:156
end -- shunt/peripheral/station.yue:175
_module_0["TestStationBackend"] = TestStationBackend -- shunt/peripheral/station.yue:156
spec(function() -- shunt/peripheral/station.yue:177
  local T = require('shunt.quicktype').T -- shunt/peripheral/station.yue:0
  local describe, it, matchers -- shunt/peripheral/station.yue:0
  do -- shunt/peripheral/station.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/peripheral/station.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/peripheral/station.yue:0
  end -- shunt/peripheral/station.yue:0
  local anything, errors, no_errors = matchers.anything, matchers.errors, matchers.no_errors -- shunt/peripheral/station.yue:183
  return describe('Station', function() -- shunt/peripheral/station.yue:185
    return describe('\\apply_schedule', function() -- shunt/peripheral/station.yue:186
      it('accepts valid schedules', function() -- shunt/peripheral/station.yue:187
        local station = Station(TestStationBackend({ -- shunt/peripheral/station.yue:189
          train_set_schedule = function(self, schedule) -- shunt/peripheral/station.yue:189
            T('Schedule', schedule) -- shunt/peripheral/station.yue:190
            return true -- shunt/peripheral/station.yue:191
          end -- shunt/peripheral/station.yue:189
        })) -- shunt/peripheral/station.yue:188
        local valid_schedule = { -- shunt/peripheral/station.yue:194
          cyclic = false, -- shunt/peripheral/station.yue:194
          entries = { -- shunt/peripheral/station.yue:196
            { -- shunt/peripheral/station.yue:196
              instruction = { -- shunt/peripheral/station.yue:197
                id = 'create:destination', -- shunt/peripheral/station.yue:197
                data = { -- shunt/peripheral/station.yue:198
                  text = 'from-station' -- shunt/peripheral/station.yue:198
                } -- shunt/peripheral/station.yue:198
              }, -- shunt/peripheral/station.yue:196
              conditions = { -- shunt/peripheral/station.yue:200
                { -- shunt/peripheral/station.yue:200
                  CARGO_INACTIVE_CONDITION, -- shunt/peripheral/station.yue:200
                  CARGO_INACTIVE_TIMEOUT -- shunt/peripheral/station.yue:200
                }, -- shunt/peripheral/station.yue:200
                { -- shunt/peripheral/station.yue:201
                  OVERALL_TIMEOUT -- shunt/peripheral/station.yue:201
                } -- shunt/peripheral/station.yue:201
              } -- shunt/peripheral/station.yue:199
            }, -- shunt/peripheral/station.yue:196
            { -- shunt/peripheral/station.yue:202
              instruction = { -- shunt/peripheral/station.yue:203
                id = 'create:destination', -- shunt/peripheral/station.yue:203
                data = { -- shunt/peripheral/station.yue:204
                  text = 'to-station' -- shunt/peripheral/station.yue:204
                } -- shunt/peripheral/station.yue:204
              }, -- shunt/peripheral/station.yue:202
              conditions = { -- shunt/peripheral/station.yue:206
                { -- shunt/peripheral/station.yue:206
                  CARGO_INACTIVE_CONDITION, -- shunt/peripheral/station.yue:206
                  CARGO_INACTIVE_TIMEOUT -- shunt/peripheral/station.yue:206
                }, -- shunt/peripheral/station.yue:206
                { -- shunt/peripheral/station.yue:207
                  OVERALL_TIMEOUT -- shunt/peripheral/station.yue:207
                } -- shunt/peripheral/station.yue:207
              } -- shunt/peripheral/station.yue:205
            } -- shunt/peripheral/station.yue:202
          } -- shunt/peripheral/station.yue:195
        }; -- shunt/peripheral/station.yue:193
        return require('shunt.spec')._expect_that([=[(-> station\apply_schedule valid_schedule)]=], (function() -- shunt/peripheral/station.yue:208
          return station:apply_schedule(valid_schedule) -- shunt/peripheral/station.yue:208
        end), (no_errors()), tostring("shunt/peripheral/station.yue") .. ":" .. tostring(208)) -- shunt/peripheral/station.yue:208
      end) -- shunt/peripheral/station.yue:187
      it('rejects invalid schedules', function() -- shunt/peripheral/station.yue:210
        local invalid_schedules = { -- shunt/peripheral/station.yue:212
          { }, -- shunt/peripheral/station.yue:212
          { -- shunt/peripheral/station.yue:213
            cyclic = '123' -- shunt/peripheral/station.yue:213
          }, -- shunt/peripheral/station.yue:213
          { -- shunt/peripheral/station.yue:214
            cyclic = false, -- shunt/peripheral/station.yue:214
            entries = { } -- shunt/peripheral/station.yue:214
          }, -- shunt/peripheral/station.yue:214
          { -- shunt/peripheral/station.yue:215
            cyclic = false, -- shunt/peripheral/station.yue:215
            entries = { -- shunt/peripheral/station.yue:215
              { } -- shunt/peripheral/station.yue:215
            } -- shunt/peripheral/station.yue:215
          }, -- shunt/peripheral/station.yue:215
          { -- shunt/peripheral/station.yue:216
            cyclic = false, -- shunt/peripheral/station.yue:216
            entries = { -- shunt/peripheral/station.yue:216
              { -- shunt/peripheral/station.yue:216
                instruction = 'asdf' -- shunt/peripheral/station.yue:216
              } -- shunt/peripheral/station.yue:216
            } -- shunt/peripheral/station.yue:216
          }, -- shunt/peripheral/station.yue:216
          { -- shunt/peripheral/station.yue:217
            cyclic = false, -- shunt/peripheral/station.yue:217
            entries = { -- shunt/peripheral/station.yue:217
              { -- shunt/peripheral/station.yue:217
                instruction = { -- shunt/peripheral/station.yue:217
                  id = 'asdf' -- shunt/peripheral/station.yue:217
                } -- shunt/peripheral/station.yue:217
              } -- shunt/peripheral/station.yue:217
            } -- shunt/peripheral/station.yue:217
          }, -- shunt/peripheral/station.yue:217
          { -- shunt/peripheral/station.yue:218
            cyclic = false, -- shunt/peripheral/station.yue:218
            entries = { -- shunt/peripheral/station.yue:218
              { -- shunt/peripheral/station.yue:218
                instruction = { -- shunt/peripheral/station.yue:218
                  id = 'create:destination', -- shunt/peripheral/station.yue:218
                  data = 'asdf' -- shunt/peripheral/station.yue:218
                } -- shunt/peripheral/station.yue:218
              } -- shunt/peripheral/station.yue:218
            } -- shunt/peripheral/station.yue:218
          }, -- shunt/peripheral/station.yue:218
          { -- shunt/peripheral/station.yue:219
            cyclic = false, -- shunt/peripheral/station.yue:219
            entries = { -- shunt/peripheral/station.yue:219
              { -- shunt/peripheral/station.yue:219
                instruction = { -- shunt/peripheral/station.yue:219
                  id = 'create:destination', -- shunt/peripheral/station.yue:219
                  data = { -- shunt/peripheral/station.yue:219
                    text = false -- shunt/peripheral/station.yue:219
                  } -- shunt/peripheral/station.yue:219
                } -- shunt/peripheral/station.yue:219
              } -- shunt/peripheral/station.yue:219
            } -- shunt/peripheral/station.yue:219
          }, -- shunt/peripheral/station.yue:219
          { -- shunt/peripheral/station.yue:220
            cyclic = false, -- shunt/peripheral/station.yue:220
            entries = { -- shunt/peripheral/station.yue:220
              { -- shunt/peripheral/station.yue:220
                instruction = { -- shunt/peripheral/station.yue:220
                  id = 'create:destination', -- shunt/peripheral/station.yue:220
                  data = { -- shunt/peripheral/station.yue:220
                    text = 'station' -- shunt/peripheral/station.yue:220
                  } -- shunt/peripheral/station.yue:220
                }, -- shunt/peripheral/station.yue:220
                conditions = { } -- shunt/peripheral/station.yue:220
              } -- shunt/peripheral/station.yue:220
            } -- shunt/peripheral/station.yue:220
          }, -- shunt/peripheral/station.yue:220
          { -- shunt/peripheral/station.yue:221
            cyclic = false, -- shunt/peripheral/station.yue:221
            entries = { -- shunt/peripheral/station.yue:221
              { -- shunt/peripheral/station.yue:221
                instruction = { -- shunt/peripheral/station.yue:221
                  id = 'create:destination', -- shunt/peripheral/station.yue:221
                  data = { -- shunt/peripheral/station.yue:221
                    text = 'station' -- shunt/peripheral/station.yue:221
                  } -- shunt/peripheral/station.yue:221
                }, -- shunt/peripheral/station.yue:221
                conditions = { -- shunt/peripheral/station.yue:221
                  { } -- shunt/peripheral/station.yue:221
                } -- shunt/peripheral/station.yue:221
              } -- shunt/peripheral/station.yue:221
            } -- shunt/peripheral/station.yue:221
          }, -- shunt/peripheral/station.yue:221
          { -- shunt/peripheral/station.yue:222
            cyclic = false, -- shunt/peripheral/station.yue:222
            entries = { -- shunt/peripheral/station.yue:222
              { -- shunt/peripheral/station.yue:222
                instruction = { -- shunt/peripheral/station.yue:222
                  id = 'create:destination', -- shunt/peripheral/station.yue:222
                  data = { -- shunt/peripheral/station.yue:222
                    text = 'station' -- shunt/peripheral/station.yue:222
                  } -- shunt/peripheral/station.yue:222
                }, -- shunt/peripheral/station.yue:222
                conditions = { -- shunt/peripheral/station.yue:222
                  { -- shunt/peripheral/station.yue:222
                    id = 'asdf' -- shunt/peripheral/station.yue:222
                  } -- shunt/peripheral/station.yue:222
                } -- shunt/peripheral/station.yue:222
              } -- shunt/peripheral/station.yue:222
            } -- shunt/peripheral/station.yue:222
          }, -- shunt/peripheral/station.yue:222
          { -- shunt/peripheral/station.yue:223
            cyclic = false, -- shunt/peripheral/station.yue:223
            entries = { -- shunt/peripheral/station.yue:223
              { -- shunt/peripheral/station.yue:223
                instruction = { -- shunt/peripheral/station.yue:223
                  id = 'create:destination', -- shunt/peripheral/station.yue:223
                  data = { -- shunt/peripheral/station.yue:223
                    text = 'station' -- shunt/peripheral/station.yue:223
                  } -- shunt/peripheral/station.yue:223
                }, -- shunt/peripheral/station.yue:223
                conditions = { -- shunt/peripheral/station.yue:223
                  { -- shunt/peripheral/station.yue:223
                    id = 'create:idle' -- shunt/peripheral/station.yue:223
                  } -- shunt/peripheral/station.yue:223
                } -- shunt/peripheral/station.yue:223
              } -- shunt/peripheral/station.yue:223
            } -- shunt/peripheral/station.yue:223
          }, -- shunt/peripheral/station.yue:223
          { -- shunt/peripheral/station.yue:224
            cyclic = false, -- shunt/peripheral/station.yue:224
            entries = { -- shunt/peripheral/station.yue:224
              { -- shunt/peripheral/station.yue:224
                instruction = { -- shunt/peripheral/station.yue:224
                  id = 'create:destination', -- shunt/peripheral/station.yue:224
                  data = { -- shunt/peripheral/station.yue:224
                    text = 'station' -- shunt/peripheral/station.yue:224
                  } -- shunt/peripheral/station.yue:224
                }, -- shunt/peripheral/station.yue:224
                conditions = { -- shunt/peripheral/station.yue:224
                  { -- shunt/peripheral/station.yue:224
                    id = 'create:idle', -- shunt/peripheral/station.yue:224
                    data = { } -- shunt/peripheral/station.yue:224
                  } -- shunt/peripheral/station.yue:224
                } -- shunt/peripheral/station.yue:224
              } -- shunt/peripheral/station.yue:224
            } -- shunt/peripheral/station.yue:224
          }, -- shunt/peripheral/station.yue:224
          { -- shunt/peripheral/station.yue:225
            cyclic = false, -- shunt/peripheral/station.yue:225
            entries = { -- shunt/peripheral/station.yue:225
              { -- shunt/peripheral/station.yue:225
                instruction = { -- shunt/peripheral/station.yue:225
                  id = 'create:destination', -- shunt/peripheral/station.yue:225
                  data = { -- shunt/peripheral/station.yue:225
                    text = 'station' -- shunt/peripheral/station.yue:225
                  } -- shunt/peripheral/station.yue:225
                }, -- shunt/peripheral/station.yue:225
                conditions = { -- shunt/peripheral/station.yue:225
                  { -- shunt/peripheral/station.yue:225
                    id = 'create:idle', -- shunt/peripheral/station.yue:225
                    data = { -- shunt/peripheral/station.yue:225
                      value = 'asdf' -- shunt/peripheral/station.yue:225
                    } -- shunt/peripheral/station.yue:225
                  } -- shunt/peripheral/station.yue:225
                } -- shunt/peripheral/station.yue:225
              } -- shunt/peripheral/station.yue:225
            } -- shunt/peripheral/station.yue:225
          }, -- shunt/peripheral/station.yue:225
          { -- shunt/peripheral/station.yue:226
            cyclic = false, -- shunt/peripheral/station.yue:226
            entries = { -- shunt/peripheral/station.yue:226
              { -- shunt/peripheral/station.yue:226
                instruction = { -- shunt/peripheral/station.yue:226
                  id = 'create:destination', -- shunt/peripheral/station.yue:226
                  data = { -- shunt/peripheral/station.yue:226
                    text = 'station' -- shunt/peripheral/station.yue:226
                  } -- shunt/peripheral/station.yue:226
                }, -- shunt/peripheral/station.yue:226
                conditions = { -- shunt/peripheral/station.yue:226
                  { -- shunt/peripheral/station.yue:226
                    id = 'create:idle', -- shunt/peripheral/station.yue:226
                    data = { -- shunt/peripheral/station.yue:226
                      value = 5 -- shunt/peripheral/station.yue:226
                    } -- shunt/peripheral/station.yue:226
                  } -- shunt/peripheral/station.yue:226
                } -- shunt/peripheral/station.yue:226
              } -- shunt/peripheral/station.yue:226
            } -- shunt/peripheral/station.yue:226
          }, -- shunt/peripheral/station.yue:226
          { -- shunt/peripheral/station.yue:227
            cyclic = false, -- shunt/peripheral/station.yue:227
            entries = { -- shunt/peripheral/station.yue:227
              { -- shunt/peripheral/station.yue:227
                instruction = { -- shunt/peripheral/station.yue:227
                  id = 'create:destination', -- shunt/peripheral/station.yue:227
                  data = { -- shunt/peripheral/station.yue:227
                    text = 'station' -- shunt/peripheral/station.yue:227
                  } -- shunt/peripheral/station.yue:227
                }, -- shunt/peripheral/station.yue:227
                conditions = { -- shunt/peripheral/station.yue:227
                  { -- shunt/peripheral/station.yue:227
                    id = 'create:idle', -- shunt/peripheral/station.yue:227
                    data = { -- shunt/peripheral/station.yue:227
                      value = 5, -- shunt/peripheral/station.yue:227
                      time_unit = 'asdf' -- shunt/peripheral/station.yue:227
                    } -- shunt/peripheral/station.yue:227
                  } -- shunt/peripheral/station.yue:227
                } -- shunt/peripheral/station.yue:227
              } -- shunt/peripheral/station.yue:227
            } -- shunt/peripheral/station.yue:227
          }, -- shunt/peripheral/station.yue:227
          { -- shunt/peripheral/station.yue:228
            cyclic = false, -- shunt/peripheral/station.yue:228
            entries = { -- shunt/peripheral/station.yue:228
              { -- shunt/peripheral/station.yue:228
                instruction = { -- shunt/peripheral/station.yue:228
                  id = 'create:destination', -- shunt/peripheral/station.yue:228
                  data = { -- shunt/peripheral/station.yue:228
                    text = 'station' -- shunt/peripheral/station.yue:228
                  } -- shunt/peripheral/station.yue:228
                }, -- shunt/peripheral/station.yue:228
                conditions = { -- shunt/peripheral/station.yue:228
                  { -- shunt/peripheral/station.yue:228
                    id = 'create:idle', -- shunt/peripheral/station.yue:228
                    data = { -- shunt/peripheral/station.yue:228
                      value = 5, -- shunt/peripheral/station.yue:228
                      time_unit = -1 -- shunt/peripheral/station.yue:228
                    } -- shunt/peripheral/station.yue:228
                  } -- shunt/peripheral/station.yue:228
                } -- shunt/peripheral/station.yue:228
              } -- shunt/peripheral/station.yue:228
            } -- shunt/peripheral/station.yue:228
          } -- shunt/peripheral/station.yue:228
        } -- shunt/peripheral/station.yue:211
        for _index_0 = 1, #invalid_schedules do -- shunt/peripheral/station.yue:229
          local invalid_schedule = invalid_schedules[_index_0] -- shunt/peripheral/station.yue:229
          require('shunt.spec')._expect_that([=[(-> station\apply_schedule invalid_schedule)]=], (function() -- shunt/peripheral/station.yue:230
            return station:apply_schedule(invalid_schedule) -- shunt/peripheral/station.yue:230
          end), (errors(anything())), tostring("shunt/peripheral/station.yue") .. ":" .. tostring(230)) -- shunt/peripheral/station.yue:230
        end -- shunt/peripheral/station.yue:230
      end) -- shunt/peripheral/station.yue:210
      return it('applies the given schedule in world', function() -- shunt/peripheral/station.yue:232
        if not _G.skip_minecraft_tests then -- shunt/peripheral/station.yue:233
          return -- shunt/peripheral/station.yue:234
        end -- shunt/peripheral/station.yue:233
      end) -- shunt/peripheral/station.yue:234
    end) -- shunt/peripheral/station.yue:234
  end) -- shunt/peripheral/station.yue:234
end) -- shunt/peripheral/station.yue:177
return _module_0 -- shunt/peripheral/station.yue:234
end
package.preload['shunt.peripheral.stockpile'] = function(...)
-- [yue]: shunt/peripheral/stockpile.yue
local _module_0 = { } -- shunt/peripheral/stockpile.yue:1
local log = require('shunt.logger').log -- shunt/peripheral/stockpile.yue:0
local declare_type, F, T -- shunt/peripheral/stockpile.yue:0
do -- shunt/peripheral/stockpile.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/peripheral/stockpile.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/peripheral/stockpile.yue:0
end -- shunt/peripheral/stockpile.yue:0
local spec = require('shunt.spec').spec -- shunt/peripheral/stockpile.yue:0
declare_type('SlotData', [[{
  name: string,
  count: number,
}]]) -- shunt/peripheral/stockpile.yue:7
declare_type('SlotContent', [[{
  displayName: string,
  count: number,
}]]) -- shunt/peripheral/stockpile.yue:11
declare_type('Stockpile', [[{
  content: () => StockpileContent,
}]]) -- shunt/peripheral/stockpile.yue:16
local Stockpile -- shunt/peripheral/stockpile.yue:19
do -- shunt/peripheral/stockpile.yue:19
  local _class_0 -- shunt/peripheral/stockpile.yue:19
  local _base_0 = { -- shunt/peripheral/stockpile.yue:19
    content = F('() => StockpileContent', function(self) -- shunt/peripheral/stockpile.yue:22
      log(function() -- shunt/peripheral/stockpile.yue:23
        return "gathering stockpile info from " .. tostring(#self.inventories) .. " inventories" -- shunt/peripheral/stockpile.yue:23
      end) -- shunt/peripheral/stockpile.yue:23
      local estimated_capacity = 0 -- shunt/peripheral/stockpile.yue:24
      local stored_items_by_name = { } -- shunt/peripheral/stockpile.yue:25
      local _list_0 = self.inventories -- shunt/peripheral/stockpile.yue:26
      for _index_0 = 1, #_list_0 do -- shunt/peripheral/stockpile.yue:26
        local inventory = _list_0[_index_0] -- shunt/peripheral/stockpile.yue:26
        estimated_capacity = estimated_capacity + inventory:gather_content(stored_items_by_name) -- shunt/peripheral/stockpile.yue:27
      end -- shunt/peripheral/stockpile.yue:27
      local stored_items -- shunt/peripheral/stockpile.yue:29
      do -- shunt/peripheral/stockpile.yue:29
        local _accum_0 = { } -- shunt/peripheral/stockpile.yue:29
        local _len_0 = 1 -- shunt/peripheral/stockpile.yue:29
        for _, content in pairs(stored_items_by_name) do -- shunt/peripheral/stockpile.yue:29
          _accum_0[_len_0] = content -- shunt/peripheral/stockpile.yue:29
          _len_0 = _len_0 + 1 -- shunt/peripheral/stockpile.yue:29
        end -- shunt/peripheral/stockpile.yue:29
        stored_items = _accum_0 -- shunt/peripheral/stockpile.yue:29
      end -- shunt/peripheral/stockpile.yue:29
      table.sort(stored_items, function(a, b) -- shunt/peripheral/stockpile.yue:30
        return a.name < b.name -- shunt/peripheral/stockpile.yue:31
      end) -- shunt/peripheral/stockpile.yue:30
      return { -- shunt/peripheral/stockpile.yue:32
        stored_items = stored_items, -- shunt/peripheral/stockpile.yue:32
        estimated_capacity = estimated_capacity -- shunt/peripheral/stockpile.yue:32
      } -- shunt/peripheral/stockpile.yue:32
    end) -- shunt/peripheral/stockpile.yue:19
  } -- shunt/peripheral/stockpile.yue:19
  if _base_0.__index == nil then -- shunt/peripheral/stockpile.yue:19
    _base_0.__index = _base_0 -- shunt/peripheral/stockpile.yue:19
  end -- shunt/peripheral/stockpile.yue:32
  _class_0 = setmetatable({ -- shunt/peripheral/stockpile.yue:19
    __init = F('([Inventory]) => <>', function(self, inventories) -- shunt/peripheral/stockpile.yue:20
      self.inventories = inventories -- shunt/peripheral/stockpile.yue:20
    end), -- shunt/peripheral/stockpile.yue:19
    __base = _base_0, -- shunt/peripheral/stockpile.yue:19
    __name = "Stockpile" -- shunt/peripheral/stockpile.yue:19
  }, { -- shunt/peripheral/stockpile.yue:19
    __index = _base_0, -- shunt/peripheral/stockpile.yue:19
    __call = function(cls, ...) -- shunt/peripheral/stockpile.yue:19
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/stockpile.yue:19
      cls.__init(_self_0, ...) -- shunt/peripheral/stockpile.yue:19
      return _self_0 -- shunt/peripheral/stockpile.yue:19
    end -- shunt/peripheral/stockpile.yue:19
  }) -- shunt/peripheral/stockpile.yue:19
  _base_0.__class = _class_0 -- shunt/peripheral/stockpile.yue:19
  Stockpile = _class_0 -- shunt/peripheral/stockpile.yue:19
end -- shunt/peripheral/stockpile.yue:32
_module_0["Stockpile"] = Stockpile -- shunt/peripheral/stockpile.yue:19
declare_type('Inventory', [[{
  gather_content: ({string->StoredItemInfo}) => number,
}]]) -- shunt/peripheral/stockpile.yue:34
declare_type('InventoryBackend', [[{
  size: () => number,
  slot_content: (number) => ?SlotContent,
  slot_capacity: (number) => number,
}]]) -- shunt/peripheral/stockpile.yue:37
local Inventory -- shunt/peripheral/stockpile.yue:42
do -- shunt/peripheral/stockpile.yue:42
  local _class_0 -- shunt/peripheral/stockpile.yue:42
  local _base_0 = { -- shunt/peripheral/stockpile.yue:42
    gather_content = F('({string->StoredItemInfo}) => number', function(self, stored_items_by_name) -- shunt/peripheral/stockpile.yue:45
      local total_populated_capacity = 0 -- shunt/peripheral/stockpile.yue:46
      local populated_slots = 0 -- shunt/peripheral/stockpile.yue:47
      local num_slots = self.backend:size() -- shunt/peripheral/stockpile.yue:48
      local slot_data = self.backend:list() -- shunt/peripheral/stockpile.yue:49
      for i = 1, num_slots do -- shunt/peripheral/stockpile.yue:51
        local _continue_0 = false -- shunt/peripheral/stockpile.yue:52
        repeat -- shunt/peripheral/stockpile.yue:52
          local slot = slot_data[i] -- shunt/peripheral/stockpile.yue:52
          if not (slot ~= nil) then -- shunt/peripheral/stockpile.yue:53
            _continue_0 = true -- shunt/peripheral/stockpile.yue:54
            break -- shunt/peripheral/stockpile.yue:54
          end -- shunt/peripheral/stockpile.yue:53
          populated_slots = populated_slots + 1 -- shunt/peripheral/stockpile.yue:55
          total_populated_capacity = total_populated_capacity + self.backend:slot_capacity(i) -- shunt/peripheral/stockpile.yue:56
          local name = slot.name -- shunt/peripheral/stockpile.yue:58
          if stored_items_by_name[name] == nil then -- shunt/peripheral/stockpile.yue:59
            stored_items_by_name[name] = T('StoredItemInfo', { -- shunt/peripheral/stockpile.yue:60
              name = name, -- shunt/peripheral/stockpile.yue:60
              stored = 0 -- shunt/peripheral/stockpile.yue:61
            }) -- shunt/peripheral/stockpile.yue:59
          end -- shunt/peripheral/stockpile.yue:61
          do -- shunt/peripheral/stockpile.yue:62
            local _with_0 = stored_items_by_name[name] -- shunt/peripheral/stockpile.yue:62
            _with_0.stored = _with_0.stored + slot.count -- shunt/peripheral/stockpile.yue:63
          end -- shunt/peripheral/stockpile.yue:62
          _continue_0 = true -- shunt/peripheral/stockpile.yue:52
        until true -- shunt/peripheral/stockpile.yue:63
        if not _continue_0 then -- shunt/peripheral/stockpile.yue:63
          break -- shunt/peripheral/stockpile.yue:63
        end -- shunt/peripheral/stockpile.yue:63
      end -- shunt/peripheral/stockpile.yue:63
      if populated_slots == 0 then -- shunt/peripheral/stockpile.yue:65
        return 64 * num_slots -- shunt/peripheral/stockpile.yue:66
      end -- shunt/peripheral/stockpile.yue:65
      return total_populated_capacity * num_slots / populated_slots -- shunt/peripheral/stockpile.yue:67
    end) -- shunt/peripheral/stockpile.yue:42
  } -- shunt/peripheral/stockpile.yue:42
  if _base_0.__index == nil then -- shunt/peripheral/stockpile.yue:42
    _base_0.__index = _base_0 -- shunt/peripheral/stockpile.yue:42
  end -- shunt/peripheral/stockpile.yue:67
  _class_0 = setmetatable({ -- shunt/peripheral/stockpile.yue:42
    __init = F('(InventoryBackend) => <>', function(self, backend) -- shunt/peripheral/stockpile.yue:43
      self.backend = backend -- shunt/peripheral/stockpile.yue:43
    end), -- shunt/peripheral/stockpile.yue:42
    __base = _base_0, -- shunt/peripheral/stockpile.yue:42
    __name = "Inventory" -- shunt/peripheral/stockpile.yue:42
  }, { -- shunt/peripheral/stockpile.yue:42
    __index = _base_0, -- shunt/peripheral/stockpile.yue:42
    __call = function(cls, ...) -- shunt/peripheral/stockpile.yue:42
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/stockpile.yue:42
      cls.__init(_self_0, ...) -- shunt/peripheral/stockpile.yue:42
      return _self_0 -- shunt/peripheral/stockpile.yue:42
    end -- shunt/peripheral/stockpile.yue:42
  }) -- shunt/peripheral/stockpile.yue:42
  _base_0.__class = _class_0 -- shunt/peripheral/stockpile.yue:42
  Inventory = _class_0 -- shunt/peripheral/stockpile.yue:42
end -- shunt/peripheral/stockpile.yue:67
_module_0["Inventory"] = Inventory -- shunt/peripheral/stockpile.yue:42
declare_type('StockpileContent', [[{
  stored_items: [StoredItemInfo],
  estimated_capacity: number,
}]]) -- shunt/peripheral/stockpile.yue:69
declare_type('StoredItemInfo', [[{
  name: string,
  stored: number,
}]]) -- shunt/peripheral/stockpile.yue:73
local MinecraftBackend -- shunt/peripheral/stockpile.yue:77
do -- shunt/peripheral/stockpile.yue:77
  local _class_0 -- shunt/peripheral/stockpile.yue:77
  local _base_0 = { -- shunt/peripheral/stockpile.yue:77
    size = F('() => number', function(self) -- shunt/peripheral/stockpile.yue:84
      return self.inventory.size() -- shunt/peripheral/stockpile.yue:85
    end), -- shunt/peripheral/stockpile.yue:87
    list = F('() => {number->SlotData}', function(self) -- shunt/peripheral/stockpile.yue:87
      return self.inventory.list() -- shunt/peripheral/stockpile.yue:88
    end), -- shunt/peripheral/stockpile.yue:90
    slot_content = F('(number) => ?SlotContent', function(self, slot_id) -- shunt/peripheral/stockpile.yue:90
      return self.inventory.getItemDetail(slot_id) -- shunt/peripheral/stockpile.yue:91
    end), -- shunt/peripheral/stockpile.yue:93
    slot_capacity = F('(number) => number', function(self, slot_id) -- shunt/peripheral/stockpile.yue:93
      return self.inventory.getItemLimit(slot_id) -- shunt/peripheral/stockpile.yue:94
    end) -- shunt/peripheral/stockpile.yue:77
  } -- shunt/peripheral/stockpile.yue:77
  if _base_0.__index == nil then -- shunt/peripheral/stockpile.yue:77
    _base_0.__index = _base_0 -- shunt/peripheral/stockpile.yue:77
  end -- shunt/peripheral/stockpile.yue:94
  _class_0 = setmetatable({ -- shunt/peripheral/stockpile.yue:77
    __init = function(self, inventory) -- shunt/peripheral/stockpile.yue:82
      self.inventory = inventory -- shunt/peripheral/stockpile.yue:82
    end, -- shunt/peripheral/stockpile.yue:77
    __base = _base_0, -- shunt/peripheral/stockpile.yue:77
    __name = "MinecraftBackend" -- shunt/peripheral/stockpile.yue:77
  }, { -- shunt/peripheral/stockpile.yue:77
    __index = _base_0, -- shunt/peripheral/stockpile.yue:77
    __call = function(cls, ...) -- shunt/peripheral/stockpile.yue:77
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/stockpile.yue:77
      cls.__init(_self_0, ...) -- shunt/peripheral/stockpile.yue:77
      return _self_0 -- shunt/peripheral/stockpile.yue:77
    end -- shunt/peripheral/stockpile.yue:77
  }) -- shunt/peripheral/stockpile.yue:77
  _base_0.__class = _class_0 -- shunt/peripheral/stockpile.yue:77
  local self = _class_0; -- shunt/peripheral/stockpile.yue:77
  self.find = F('() => [InventoryBackend]', function(self) -- shunt/peripheral/stockpile.yue:78
    local inventory_peripherals = { -- shunt/peripheral/stockpile.yue:79
      peripheral.find('inventory') -- shunt/peripheral/stockpile.yue:79
    } -- shunt/peripheral/stockpile.yue:79
    local _accum_0 = { } -- shunt/peripheral/stockpile.yue:80
    local _len_0 = 1 -- shunt/peripheral/stockpile.yue:80
    for _index_0 = 1, #inventory_peripherals do -- shunt/peripheral/stockpile.yue:80
      local peripheral = inventory_peripherals[_index_0] -- shunt/peripheral/stockpile.yue:80
      _accum_0[_len_0] = MinecraftBackend(peripheral) -- shunt/peripheral/stockpile.yue:80
      _len_0 = _len_0 + 1 -- shunt/peripheral/stockpile.yue:80
    end -- shunt/peripheral/stockpile.yue:80
    return _accum_0 -- shunt/peripheral/stockpile.yue:80
  end) -- shunt/peripheral/stockpile.yue:78
  MinecraftBackend = _class_0 -- shunt/peripheral/stockpile.yue:77
end -- shunt/peripheral/stockpile.yue:94
_module_0["MinecraftBackend"] = MinecraftBackend -- shunt/peripheral/stockpile.yue:77
declare_type('TestInventoryBackendOpts', [[{
  size: ?() => number,
  list: ?() => {number->SlotData},
  slot_content: ?(number) => ?SlotContent,
  slot_capacity: ?(number) => number,
}]]) -- shunt/peripheral/stockpile.yue:96
local TestInventoryBackend -- shunt/peripheral/stockpile.yue:102
do -- shunt/peripheral/stockpile.yue:102
  local _class_0 -- shunt/peripheral/stockpile.yue:102
  local _base_0 = { } -- shunt/peripheral/stockpile.yue:102
  if _base_0.__index == nil then -- shunt/peripheral/stockpile.yue:102
    _base_0.__index = _base_0 -- shunt/peripheral/stockpile.yue:102
  end -- shunt/peripheral/stockpile.yue:113
  _class_0 = setmetatable({ -- shunt/peripheral/stockpile.yue:102
    __init = F('(?TestInventoryBackendOpts) => <>', function(self, opts) -- shunt/peripheral/stockpile.yue:103
      if opts == nil then -- shunt/peripheral/stockpile.yue:103
        opts = { } -- shunt/peripheral/stockpile.yue:103
      end -- shunt/peripheral/stockpile.yue:103
      local size, list, slot_content, slot_capacity = opts.size, opts.list, opts.slot_content, opts.slot_capacity -- shunt/peripheral/stockpile.yue:104
      if size == nil then -- shunt/peripheral/stockpile.yue:105
        size = function() -- shunt/peripheral/stockpile.yue:105
          return error('size unimplemented') -- shunt/peripheral/stockpile.yue:105
        end -- shunt/peripheral/stockpile.yue:105
      end -- shunt/peripheral/stockpile.yue:105
      if list == nil then -- shunt/peripheral/stockpile.yue:106
        list = function() -- shunt/peripheral/stockpile.yue:106
          return error('list unimplemented') -- shunt/peripheral/stockpile.yue:106
        end -- shunt/peripheral/stockpile.yue:106
      end -- shunt/peripheral/stockpile.yue:106
      if slot_content == nil then -- shunt/peripheral/stockpile.yue:107
        slot_content = function() -- shunt/peripheral/stockpile.yue:107
          return error('slot_content unimplemented') -- shunt/peripheral/stockpile.yue:107
        end -- shunt/peripheral/stockpile.yue:107
      end -- shunt/peripheral/stockpile.yue:107
      if slot_capacity == nil then -- shunt/peripheral/stockpile.yue:108
        slot_capacity = function() -- shunt/peripheral/stockpile.yue:108
          return error('slot_capacity unimplemented') -- shunt/peripheral/stockpile.yue:108
        end -- shunt/peripheral/stockpile.yue:108
      end -- shunt/peripheral/stockpile.yue:108
      self.size = F('() => number', size) -- shunt/peripheral/stockpile.yue:110
      self.list = F('() => {number->SlotData}', list) -- shunt/peripheral/stockpile.yue:111
      self.slot_content = F('(number) => ?SlotContent', slot_content) -- shunt/peripheral/stockpile.yue:112
      self.slot_capacity = F('(number) => number', slot_capacity) -- shunt/peripheral/stockpile.yue:113
    end), -- shunt/peripheral/stockpile.yue:102
    __base = _base_0, -- shunt/peripheral/stockpile.yue:102
    __name = "TestInventoryBackend" -- shunt/peripheral/stockpile.yue:102
  }, { -- shunt/peripheral/stockpile.yue:102
    __index = _base_0, -- shunt/peripheral/stockpile.yue:102
    __call = function(cls, ...) -- shunt/peripheral/stockpile.yue:102
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/stockpile.yue:102
      cls.__init(_self_0, ...) -- shunt/peripheral/stockpile.yue:102
      return _self_0 -- shunt/peripheral/stockpile.yue:102
    end -- shunt/peripheral/stockpile.yue:102
  }) -- shunt/peripheral/stockpile.yue:102
  _base_0.__class = _class_0 -- shunt/peripheral/stockpile.yue:102
  TestInventoryBackend = _class_0 -- shunt/peripheral/stockpile.yue:102
end -- shunt/peripheral/stockpile.yue:113
_module_0["TestInventoryBackend"] = TestInventoryBackend -- shunt/peripheral/stockpile.yue:102
spec(function() -- shunt/peripheral/stockpile.yue:115
  local describe, it, matchers -- shunt/peripheral/stockpile.yue:0
  do -- shunt/peripheral/stockpile.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/peripheral/stockpile.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/peripheral/stockpile.yue:0
  end -- shunt/peripheral/stockpile.yue:0
  local deep_eq, eq, errors, gt, has_fields, le, lt, matches = matchers.deep_eq, matchers.eq, matchers.errors, matchers.gt, matchers.has_fields, matchers.le, matchers.lt, matchers.matches -- shunt/peripheral/stockpile.yue:120
  return describe('Stockpile', function() -- shunt/peripheral/stockpile.yue:122
    return describe('\\content', function() -- shunt/peripheral/stockpile.yue:123
      it('returns all content', function() -- shunt/peripheral/stockpile.yue:124
        local name1 = 'minecraft:diamond_axe' -- shunt/peripheral/stockpile.yue:125
        local name2 = 'minecraft:enchanting_table' -- shunt/peripheral/stockpile.yue:126
        local name3 = 'minecraft:fishing_rod' -- shunt/peripheral/stockpile.yue:127
        local inventory1 = Inventory(TestInventoryBackend({ -- shunt/peripheral/stockpile.yue:129
          size = function(self) -- shunt/peripheral/stockpile.yue:129
            return 4 -- shunt/peripheral/stockpile.yue:129
          end, -- shunt/peripheral/stockpile.yue:129
          list = function(self) -- shunt/peripheral/stockpile.yue:130
            local _with_0 = { } -- shunt/peripheral/stockpile.yue:131
            for i = 1, self:size() do -- shunt/peripheral/stockpile.yue:132
              local name -- shunt/peripheral/stockpile.yue:133
              if i % 2 == 1 then -- shunt/peripheral/stockpile.yue:133
                name = name1 -- shunt/peripheral/stockpile.yue:134
              else -- shunt/peripheral/stockpile.yue:136
                name = name2 -- shunt/peripheral/stockpile.yue:136
              end -- shunt/peripheral/stockpile.yue:133
              _with_0[i] = { -- shunt/peripheral/stockpile.yue:137
                name = name, -- shunt/peripheral/stockpile.yue:137
                count = 16 * i -- shunt/peripheral/stockpile.yue:137
              } -- shunt/peripheral/stockpile.yue:137
            end -- shunt/peripheral/stockpile.yue:137
            return _with_0 -- shunt/peripheral/stockpile.yue:131
          end, -- shunt/peripheral/stockpile.yue:130
          slot_capacity = function(self, slot_id) -- shunt/peripheral/stockpile.yue:138
            return 32 * slot_id -- shunt/peripheral/stockpile.yue:139
          end -- shunt/peripheral/stockpile.yue:138
        })) -- shunt/peripheral/stockpile.yue:128
        local inventory2 = Inventory(TestInventoryBackend({ -- shunt/peripheral/stockpile.yue:141
          size = function(self) -- shunt/peripheral/stockpile.yue:141
            return 4 -- shunt/peripheral/stockpile.yue:141
          end, -- shunt/peripheral/stockpile.yue:141
          list = function(self) -- shunt/peripheral/stockpile.yue:142
            local _with_0 = { } -- shunt/peripheral/stockpile.yue:143
            for i = 1, self:size() do -- shunt/peripheral/stockpile.yue:144
              local name -- shunt/peripheral/stockpile.yue:145
              if i % 2 == 1 then -- shunt/peripheral/stockpile.yue:145
                name = name2 -- shunt/peripheral/stockpile.yue:146
              else -- shunt/peripheral/stockpile.yue:148
                name = name3 -- shunt/peripheral/stockpile.yue:148
              end -- shunt/peripheral/stockpile.yue:145
              _with_0[i] = { -- shunt/peripheral/stockpile.yue:149
                name = name, -- shunt/peripheral/stockpile.yue:149
                count = 3 + 16 * i -- shunt/peripheral/stockpile.yue:149
              } -- shunt/peripheral/stockpile.yue:149
            end -- shunt/peripheral/stockpile.yue:149
            return _with_0 -- shunt/peripheral/stockpile.yue:143
          end, -- shunt/peripheral/stockpile.yue:142
          slot_capacity = function(self, slot_id) -- shunt/peripheral/stockpile.yue:150
            return 3 + 32 * slot_id -- shunt/peripheral/stockpile.yue:151
          end -- shunt/peripheral/stockpile.yue:150
        })) -- shunt/peripheral/stockpile.yue:140
        local stockpile = Stockpile({ -- shunt/peripheral/stockpile.yue:153
          inventory1, -- shunt/peripheral/stockpile.yue:153
          inventory2 -- shunt/peripheral/stockpile.yue:154
        }) -- shunt/peripheral/stockpile.yue:152
        local content = stockpile:content(); -- shunt/peripheral/stockpile.yue:156
        return require('shunt.spec')._expect_that([=[content]=], content, (has_fields({ -- shunt/peripheral/stockpile.yue:157
          estimated_capacity = eq(0 + 32 * (1 + 3) + 32 * (1 + 2 + 3 + 4) + 3 * 2 + 32 * (2 + 4) + 3 * 2), -- shunt/peripheral/stockpile.yue:157
          stored_items = deep_eq({ -- shunt/peripheral/stockpile.yue:157
            { -- shunt/peripheral/stockpile.yue:157
              name = name1, -- shunt/peripheral/stockpile.yue:157
              stored = 16 * (1 + 3) -- shunt/peripheral/stockpile.yue:157
            }, -- shunt/peripheral/stockpile.yue:157
            { -- shunt/peripheral/stockpile.yue:157
              name = name2, -- shunt/peripheral/stockpile.yue:157
              stored = 16 * (1 + 2 + 3 + 4) + 3 * 2 -- shunt/peripheral/stockpile.yue:157
            }, -- shunt/peripheral/stockpile.yue:157
            { -- shunt/peripheral/stockpile.yue:157
              name = name3, -- shunt/peripheral/stockpile.yue:157
              stored = 16 * (2 + 4) + 3 * 2 -- shunt/peripheral/stockpile.yue:157
            } -- shunt/peripheral/stockpile.yue:157
          }) -- shunt/peripheral/stockpile.yue:157
        })), tostring("shunt/peripheral/stockpile.yue") .. ":" .. tostring(157)) -- shunt/peripheral/stockpile.yue:168
      end) -- shunt/peripheral/stockpile.yue:124
      it('estimates remaining capacity', function() -- shunt/peripheral/stockpile.yue:170
        local inventory = Inventory(TestInventoryBackend({ -- shunt/peripheral/stockpile.yue:172
          size = function(self) -- shunt/peripheral/stockpile.yue:172
            return 3 -- shunt/peripheral/stockpile.yue:172
          end, -- shunt/peripheral/stockpile.yue:172
          list = function(self) -- shunt/peripheral/stockpile.yue:173
            local _with_0 = { } -- shunt/peripheral/stockpile.yue:174
            _with_0[1] = { -- shunt/peripheral/stockpile.yue:175
              name = 'minecraft:oak_planks', -- shunt/peripheral/stockpile.yue:175
              count = 16 -- shunt/peripheral/stockpile.yue:175
            } -- shunt/peripheral/stockpile.yue:175
            _with_0[2] = { -- shunt/peripheral/stockpile.yue:176
              name = 'minecraft:oak_sign', -- shunt/peripheral/stockpile.yue:176
              count = 32 -- shunt/peripheral/stockpile.yue:176
            } -- shunt/peripheral/stockpile.yue:176
            _with_0[3] = nil -- shunt/peripheral/stockpile.yue:177
            return _with_0 -- shunt/peripheral/stockpile.yue:174
          end, -- shunt/peripheral/stockpile.yue:173
          slot_capacity = function(self, slot_id) -- shunt/peripheral/stockpile.yue:178
            if 1 == slot_id then -- shunt/peripheral/stockpile.yue:180
              return 64 -- shunt/peripheral/stockpile.yue:181
            elseif 2 == slot_id then -- shunt/peripheral/stockpile.yue:182
              return 16 -- shunt/peripheral/stockpile.yue:183
            elseif 3 == slot_id then -- shunt/peripheral/stockpile.yue:184
              return 64 -- shunt/peripheral/stockpile.yue:185
            else -- shunt/peripheral/stockpile.yue:187
              return error("internal error: unexpected slot_id: " .. tostring(slot_id)) -- shunt/peripheral/stockpile.yue:187
            end -- shunt/peripheral/stockpile.yue:187
          end -- shunt/peripheral/stockpile.yue:178
        })) -- shunt/peripheral/stockpile.yue:171
        local stockpile = Stockpile({ -- shunt/peripheral/stockpile.yue:189
          inventory -- shunt/peripheral/stockpile.yue:189
        }) -- shunt/peripheral/stockpile.yue:188
        local content = stockpile:content(); -- shunt/peripheral/stockpile.yue:191
        require('shunt.spec')._expect_that([=[content]=], content, (has_fields({ -- shunt/peripheral/stockpile.yue:192
          estimated_capacity = gt(64 + 16) -- shunt/peripheral/stockpile.yue:192
        })), tostring("shunt/peripheral/stockpile.yue") .. ":" .. tostring(192)); -- shunt/peripheral/stockpile.yue:192
        return require('shunt.spec')._expect_that([=[content]=], content, (has_fields({ -- shunt/peripheral/stockpile.yue:194
          estimated_capacity = lt(64 * 3) -- shunt/peripheral/stockpile.yue:194
        })), tostring("shunt/peripheral/stockpile.yue") .. ":" .. tostring(194)) -- shunt/peripheral/stockpile.yue:195
      end) -- shunt/peripheral/stockpile.yue:170
      return it('estimates empty stockpiles', function() -- shunt/peripheral/stockpile.yue:197
        local SIZE = 10 -- shunt/peripheral/stockpile.yue:198
        local inventory = Inventory(TestInventoryBackend({ -- shunt/peripheral/stockpile.yue:200
          size = function(self) -- shunt/peripheral/stockpile.yue:200
            return SIZE -- shunt/peripheral/stockpile.yue:200
          end, -- shunt/peripheral/stockpile.yue:200
          list = function(self) -- shunt/peripheral/stockpile.yue:201
            return { } -- shunt/peripheral/stockpile.yue:201
          end -- shunt/peripheral/stockpile.yue:201
        })) -- shunt/peripheral/stockpile.yue:199
        local stockpile = Stockpile({ -- shunt/peripheral/stockpile.yue:203
          inventory -- shunt/peripheral/stockpile.yue:203
        }) -- shunt/peripheral/stockpile.yue:202
        local content = stockpile:content(); -- shunt/peripheral/stockpile.yue:205
        require('shunt.spec')._expect_that([=[content]=], content, (has_fields({ -- shunt/peripheral/stockpile.yue:206
          estimated_capacity = gt(0) -- shunt/peripheral/stockpile.yue:206
        })), tostring("shunt/peripheral/stockpile.yue") .. ":" .. tostring(206)); -- shunt/peripheral/stockpile.yue:206
        return require('shunt.spec')._expect_that([=[content]=], content, (has_fields({ -- shunt/peripheral/stockpile.yue:208
          estimated_capacity = le(64 * SIZE) -- shunt/peripheral/stockpile.yue:208
        })), tostring("shunt/peripheral/stockpile.yue") .. ":" .. tostring(208)) -- shunt/peripheral/stockpile.yue:209
      end) -- shunt/peripheral/stockpile.yue:209
    end) -- shunt/peripheral/stockpile.yue:209
  end) -- shunt/peripheral/stockpile.yue:209
end) -- shunt/peripheral/stockpile.yue:115
return _module_0 -- shunt/peripheral/stockpile.yue:209
end
package.preload['shunt.nodes.marshal.resource_orchestrator.main'] = function(...)
-- [yue]: shunt/nodes/marshal/resource_orchestrator/main.yue
local _module_0 = { } -- shunt/nodes/marshal/resource_orchestrator/main.yue:1
local Queue = require('shunt.data.queue').Queue -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local Firewall = require('shunt.firewall').Firewall -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local log = require('shunt.logger').log -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local FactoryHeartbeat, ScheduleRequest, ScheduleResponse -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  local _obj_0 = require('shunt.nodes.factory.main') -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  FactoryHeartbeat, ScheduleRequest, ScheduleResponse = _obj_0.FactoryHeartbeat, _obj_0.ScheduleRequest, _obj_0.ScheduleResponse -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local IdempotenceToken = require('shunt.peripheral.uplink').IdempotenceToken -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local declare_type, F, T -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
local shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  local _obj_0 = require('shunt.state') -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
  shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder = _obj_0.shallow_log_reporter, _obj_0.State, _obj_0.StateMachineBuilder, _obj_0.StateResponsesBuilder -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/main.yue:0
declare_type('ResourceOrchestrator', [[  NetworkComponent + {
    factory: (string) => ?Factory,
    train_is_known: (string) => boolean,
  }
]]) -- shunt/nodes/marshal/resource_orchestrator/main.yue:11
declare_type('ResourceOrchestratorEvent', [[{
  type: "network-packet",
  packet: Packet,
} | {
  type: "new-epoch",
  new_epoch: number,
} | {
  type: "new-config",
  config: MarshalConfig,
}]]) -- shunt/nodes/marshal/resource_orchestrator/main.yue:17
declare_type('ResourceOrchestratorOpts', [[{
  clock: Clock,
  config: MarshalConfig,
  scheduler: Scheduler,
  uplink: Uplink,
}]]) -- shunt/nodes/marshal/resource_orchestrator/main.yue:27
local ResourceOrchestrator -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
do -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  local _class_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  local _base_0 = { -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    make_sm = F('() => StateMachine', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:59
      return (StateMachineBuilder('resource_orchestrator')):set_initial_state('waiting'):declare_endless():set_reporter(shallow_log_reporter):add((State('waiting')):add_transition_to('inspecting_packet'):add_transition_to('changing_epoch'):add_transition_to('applying_config')):add((State('inspecting_packet')):set_data_type([[{
          packet: Packet
        }]]):add_transition_to('analysing_factory_heartbeat'):add_transition_to('waiting')):add((State('analysing_factory_heartbeat')):set_data_type([[{
          packet: FactoryHeartbeat,
        }]]):add_transition_to('managing_resources'):add_transition_to('waiting')):add((State('managing_resources')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
        }]]):add_transition_to('managing_resource'):add_transition_to('waiting')):add((State('managing_resource')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
        }]]):add_transition_to('generating_schedule')):add((State('generating_schedule')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
          schedule_generator: ScheduleGenerator,
          attempt: number,
        }]]):add_transition_to('sending_schedule'):add_transition_to('managing_resources')):add((State('sending_schedule')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
          schedule_generator: ScheduleGenerator,
          attempt: number,
          candidate: ScheduleCandidate,
        }]]):add_transition_to('awaiting_schedule_response')):add((State('awaiting_schedule_response')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
          schedule_generator: ScheduleGenerator,
          attempt: number,
          idemp_tok: IdempotenceToken,
          deadline: number,
        }]]):add_transition_to('analysing_schedule_response'):add_transition_to('schedule_not_applied')):add((State('analysing_schedule_response')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
          schedule_generator: ScheduleGenerator,
          attempt: number,
          packet: ScheduleResponse,
        }]]):add_transition_to('schedule_applied'):add_transition_to('schedule_not_applied')):add((State('schedule_applied')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
        }]]):add_transition_to('managing_resources')):add((State('schedule_not_applied')):set_data_type([[{
          factory: Factory,
          low_resources: Queue,
          low_resource: string,
          schedule_generator: ScheduleGenerator,
          attempt: number,
          cause: string,
        }]]):add_transition_to('generating_schedule'):add_transition_to('managing_resources')):add((State('changing_epoch')):set_data_type([[{
          new_epoch: number,
        }]]):add_transition_to('waiting')):add((State('applying_config')):set_data_type([[{
          config: MarshalConfig
        }]]):add_transition_to('waiting')):build() -- shunt/nodes/marshal/resource_orchestrator/main.yue:165
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:167
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/nodes/marshal/resource_orchestrator/main.yue:167
      return (StateResponsesBuilder(sm)):add('waiting', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
        local _fn_0 = _base_1.on_waiting -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:169
      end)()):add('inspecting_packet', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
        local _fn_0 = _base_1.on_inspecting_packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:170
      end)()):add('changing_epoch', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
        local _fn_0 = _base_1.on_changing_epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:171
      end)()):add('applying_config', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
        local _fn_0 = _base_1.on_applying_config -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:172
      end)()):add('analysing_factory_heartbeat', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
        local _fn_0 = _base_1.on_analysing_factory_heartbeat -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:173
      end)()):add('managing_resources', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
        local _fn_0 = _base_1.on_managing_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:174
      end)()):add('managing_resource', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
        local _fn_0 = _base_1.on_managing_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:175
      end)()):add('generating_schedule', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
        local _fn_0 = _base_1.on_generating_schedule -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:176
      end)()):add('sending_schedule', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
        local _fn_0 = _base_1.on_sending_schedule -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:177
      end)()):add('awaiting_schedule_response', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
        local _fn_0 = _base_1.on_awaiting_schedule_response -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:178
      end)()):add('analysing_schedule_response', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
        local _fn_0 = _base_1.on_analysing_schedule_response -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:179
      end)()):add('schedule_applied', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
        local _fn_0 = _base_1.on_schedule_applied -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:180
      end)()):add('schedule_not_applied', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
        local _fn_0 = _base_1.on_schedule_not_applied -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:181
      end)()):build() -- shunt/nodes/marshal/resource_orchestrator/main.yue:182
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:184
    factory = F('(string) => ?Factory', function(self, name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:184
      return self.factories[name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:185
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:187
    train_is_known = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:187
      return (self.trains[train_name] ~= nil) -- shunt/nodes/marshal/resource_orchestrator/main.yue:188
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:190
    step = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:190
      return self.sm_responses[self.sm.state.name]() -- shunt/nodes/marshal/resource_orchestrator/main.yue:191
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:193
    on_waiting = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:193
      local event = self.events:dequeue() -- shunt/nodes/marshal/resource_orchestrator/main.yue:194
      if not (event ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:195
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:196
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:195
      local _exp_0 = event.type -- shunt/nodes/marshal/resource_orchestrator/main.yue:197
      if 'network-packet' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:198
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:199
        return _call_0["goto"](_call_0, 'inspecting_packet', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:200
          packet = event.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:200
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:199
      elseif 'new-epoch' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:201
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:202
        return _call_0["goto"](_call_0, 'changing_epoch', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:203
          new_epoch = event.new_epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:203
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:202
      elseif 'new-config' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:204
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:205
        return _call_0["goto"](_call_0, 'changing_config', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:206
          config = event.config -- shunt/nodes/marshal/resource_orchestrator/main.yue:206
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:205
      else -- shunt/nodes/marshal/resource_orchestrator/main.yue:208
        return error("internal error: unrecognised event type '" .. tostring(event.type) .. "'") -- shunt/nodes/marshal/resource_orchestrator/main.yue:208
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:208
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:210
    on_inspecting_packet = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:210
      local packet = self.sm.state.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:211
      local _exp_0 = packet.protocol -- shunt/nodes/marshal/resource_orchestrator/main.yue:212
      if 'FactoryHeartbeat' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:213
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:214
        return _call_0["goto"](_call_0, 'analysing_factory_heartbeat', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:215
          packet = packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:215
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:214
      elseif 'ScheduleResponse' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:216
        log(function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:217
          return "ignoring unexpected ScheduleResponse" -- shunt/nodes/marshal/resource_orchestrator/main.yue:217
        end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:217
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:218
        return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/main.yue:218
      else -- shunt/nodes/marshal/resource_orchestrator/main.yue:220
        return error("internal error: unrecognised protocol '" .. tostring(event.type) .. "'") -- shunt/nodes/marshal/resource_orchestrator/main.yue:220
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:220
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:222
    on_analysing_factory_heartbeat = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:222
      local packet = self.sm.state.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:223
      local factory = self:update_system_state(packet) -- shunt/nodes/marshal/resource_orchestrator/main.yue:224
      local low_resources = self:get_low_resources_queue(factory.stockpile) -- shunt/nodes/marshal/resource_orchestrator/main.yue:225
      if low_resources:len() == 0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:226
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:227
        _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/main.yue:227
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:228
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:226
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:229
      return _call_0["goto"](_call_0, 'managing_resources', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:230
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:230
        low_resources = low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:231
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:229
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:233
    update_system_state = F('(FactoryHeartbeat) => Factory', function(self, heartbeat) -- shunt/nodes/marshal/resource_orchestrator/main.yue:233
      local pc_id, name, stations, stockpile = heartbeat.pc_id, heartbeat.name, heartbeat.stations, heartbeat.stockpile -- shunt/nodes/marshal/resource_orchestrator/main.yue:234
      local factory_status = self.factories[name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:236
      local seen_before = (factory_status ~= nil) -- shunt/nodes/marshal/resource_orchestrator/main.yue:237
      self.factories[name] = T('Factory', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
        local _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
        if factory_status ~= nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
          _with_0 = factory_status -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
        else -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
          _with_0 = { -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
            name = name, -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
            pc_id = pc_id -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
          } -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
        if seen_before and pc_id ~= _with_0.pc_id then -- shunt/nodes/marshal/resource_orchestrator/main.yue:239
          log(function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:240
            return "temporarily ignoring possible imposter for factory " .. tostring(name) .. ": last known PC was #" .. tostring(_with_0.pc_id) .. ", got " .. tostring(pc_id) -- shunt/nodes/marshal/resource_orchestrator/main.yue:240
          end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:240
          return -- shunt/nodes/marshal/resource_orchestrator/main.yue:241
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:239
        _with_0.last_seen_epoch = self.epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:243
        _with_0.stations = stations -- shunt/nodes/marshal/resource_orchestrator/main.yue:244
        _with_0.present_trains = present_trains -- shunt/nodes/marshal/resource_orchestrator/main.yue:245
        _with_0.stockpile = stockpile -- shunt/nodes/marshal/resource_orchestrator/main.yue:246
        return _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
      end)()) -- shunt/nodes/marshal/resource_orchestrator/main.yue:238
      local _list_0 = stations.known -- shunt/nodes/marshal/resource_orchestrator/main.yue:248
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/main.yue:248
        local station = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/main.yue:248
        local _list_1 = station.present_trains -- shunt/nodes/marshal/resource_orchestrator/main.yue:249
        for _index_1 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/main.yue:249
          local present_train = _list_1[_index_1] -- shunt/nodes/marshal/resource_orchestrator/main.yue:249
          self:declare_train_seen(present_train, name, station.name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:250
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:250
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:250
      local _list_1 = stations.unknown -- shunt/nodes/marshal/resource_orchestrator/main.yue:251
      for _index_0 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/main.yue:251
        local station = _list_1[_index_0] -- shunt/nodes/marshal/resource_orchestrator/main.yue:251
        local _list_2 = station.present_trains -- shunt/nodes/marshal/resource_orchestrator/main.yue:252
        for _index_1 = 1, #_list_2 do -- shunt/nodes/marshal/resource_orchestrator/main.yue:252
          local present_train = _list_2[_index_1] -- shunt/nodes/marshal/resource_orchestrator/main.yue:252
          self:declare_train_seen(present_train, name, station.name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:253
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:253
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:253
      return self.factories[name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:255
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:257
    declare_train_seen = F('(string, string, string) => <>', function(self, train_name, factory_name, station_name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:257
      self.trains[train_name] = T('TrainStatus', (function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
        local _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
        do -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
          local _exp_0 = self.trains[train_name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
          if _exp_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
            _with_0 = _exp_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
          else -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
            _with_0 = { -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
              name = train_name -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
            } -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
          end -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
        _with_0.last_seen_epoch = self.epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:259
        _with_0.last_seen_at_factory = factory_name -- shunt/nodes/marshal/resource_orchestrator/main.yue:260
        _with_0.last_seen_at_station = station_name -- shunt/nodes/marshal/resource_orchestrator/main.yue:261
        return _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
      end)()) -- shunt/nodes/marshal/resource_orchestrator/main.yue:258
      return self.scheduler.promise_tracker:declare_train_seen(train_name, station_name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:262
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:264
    get_low_resources_queue = F('(DetectedStockpile) => Queue', function(self, stockpile) -- shunt/nodes/marshal/resource_orchestrator/main.yue:264
      local _with_0 = Queue('string') -- shunt/nodes/marshal/resource_orchestrator/main.yue:265
      local _list_0 = stockpile.known -- shunt/nodes/marshal/resource_orchestrator/main.yue:266
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/main.yue:266
        local resource = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/main.yue:266
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/main.yue:267
        repeat -- shunt/nodes/marshal/resource_orchestrator/main.yue:267
          if not (resource.shortage_amount ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:267
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/main.yue:268
            break -- shunt/nodes/marshal/resource_orchestrator/main.yue:268
          end -- shunt/nodes/marshal/resource_orchestrator/main.yue:267
          if resource.stored >= resource.shortage_amount then -- shunt/nodes/marshal/resource_orchestrator/main.yue:269
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/main.yue:270
            break -- shunt/nodes/marshal/resource_orchestrator/main.yue:270
          end -- shunt/nodes/marshal/resource_orchestrator/main.yue:269
          _with_0:enqueue(resource.name) -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/main.yue:267
        until true -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
          break -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:271
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:265
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:273
    on_managing_resources = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:273
      local factory, low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:274
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:274
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:274
        factory, low_resources = _obj_0.factory, _obj_0.low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:274
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:274
      local low_resource = low_resources:dequeue() -- shunt/nodes/marshal/resource_orchestrator/main.yue:275
      if not (low_resource ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:276
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:277
        _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/main.yue:277
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:278
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:276
      if self:is_on_cooldown(factory.name, low_resource) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:279
        log(function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:280
          return "skipping scheduling: factory " .. tostring(factory.name) .. " is on a " .. tostring(low_resource) .. " cooldown" -- shunt/nodes/marshal/resource_orchestrator/main.yue:280
        end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:280
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:281
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:279
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:282
      return _call_0["goto"](_call_0, 'managing_resource', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:283
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:283
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:284
        low_resource = low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:285
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:282
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:287
    apply_cooldown = F('(string, string) => <>', function(self, factory_name, resource) -- shunt/nodes/marshal/resource_orchestrator/main.yue:287
      local _obj_0 = self.resend_cooldowns -- shunt/nodes/marshal/resource_orchestrator/main.yue:288
      if _obj_0[factory_name] == nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:288
        _obj_0[factory_name] = { } -- shunt/nodes/marshal/resource_orchestrator/main.yue:288
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:288
      local _obj_1 = self.resend_cooldowns[factory_name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:289
      if _obj_1[resource] == nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:289
        do -- shunt/nodes/marshal/resource_orchestrator/main.yue:289
          _obj_1[resource] = self.clock:now() + self.config.marshal.resend_cooldown_seconds -- shunt/nodes/marshal/resource_orchestrator/main.yue:290
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:290
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:290
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:292
    is_on_cooldown = F('(string, string) => boolean', function(self, factory_name, resource) -- shunt/nodes/marshal/resource_orchestrator/main.yue:292
      local factory_cooldowns = self.resend_cooldowns[factory_name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:293
      if not (factory_cooldowns ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:294
        return false -- shunt/nodes/marshal/resource_orchestrator/main.yue:295
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:294
      local deadline = factory_cooldowns[resource] -- shunt/nodes/marshal/resource_orchestrator/main.yue:297
      if not (deadline ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:298
        return false -- shunt/nodes/marshal/resource_orchestrator/main.yue:299
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:298
      local on_cooldown = self.clock:now() < deadline -- shunt/nodes/marshal/resource_orchestrator/main.yue:300
      if not on_cooldown then -- shunt/nodes/marshal/resource_orchestrator/main.yue:301
        factory_cooldowns[resource] = nil -- shunt/nodes/marshal/resource_orchestrator/main.yue:302
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:301
      return on_cooldown -- shunt/nodes/marshal/resource_orchestrator/main.yue:303
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:305
    clear_cooldown = F('(string, string) => <>', function(self, factory_name, resource) -- shunt/nodes/marshal/resource_orchestrator/main.yue:305
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:306
        local _with_0 = self.resend_cooldowns[factory_name] -- shunt/nodes/marshal/resource_orchestrator/main.yue:306
        if _with_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:306
          _with_0[resource] = nil -- shunt/nodes/marshal/resource_orchestrator/main.yue:307
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:306
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:306
      return -- shunt/nodes/marshal/resource_orchestrator/main.yue:308
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:310
    on_managing_resource = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:310
      local factory, low_resources, low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:311
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:311
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:311
        factory, low_resources, low_resource = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:311
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:311
      local factories -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
        local _accum_0 = { } -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
        local _len_0 = 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
        for _, factory in pairs(self.factories) do -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
          _accum_0[_len_0] = factory -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
          _len_0 = _len_0 + 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
        factories = _accum_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:312
      local schedule_generator = self.scheduler:schedule_generator(low_resource, factory, factories) -- shunt/nodes/marshal/resource_orchestrator/main.yue:313
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:316
      return _call_0["goto"](_call_0, 'generating_schedule', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:317
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:317
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:318
        low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:319
        schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:320
        attempt = 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:321
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:316
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:323
    on_generating_schedule = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:323
      local factory, low_resources, low_resource, schedule_generator, attempt -- shunt/nodes/marshal/resource_orchestrator/main.yue:324
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:324
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:330
        factory, low_resources, low_resource, schedule_generator, attempt = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource, _obj_0.schedule_generator, _obj_0.attempt -- shunt/nodes/marshal/resource_orchestrator/main.yue:324
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:330
      local candidate, can_continue = schedule_generator:try_generate_schedule() -- shunt/nodes/marshal/resource_orchestrator/main.yue:331
      if not (candidate ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:332
        if can_continue then -- shunt/nodes/marshal/resource_orchestrator/main.yue:333
          return -- shunt/nodes/marshal/resource_orchestrator/main.yue:334
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:333
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:335
        _call_0["goto"](_call_0, 'managing_resources', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:336
          factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:336
          low_resources = low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:337
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:335
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:338
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:332
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:339
      return _call_0["goto"](_call_0, 'sending_schedule', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:340
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:340
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:341
        low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:342
        schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:343
        attempt = attempt, -- shunt/nodes/marshal/resource_orchestrator/main.yue:344
        candidate = candidate -- shunt/nodes/marshal/resource_orchestrator/main.yue:345
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:339
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:347
    on_sending_schedule = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:347
      local factory, low_resources, low_resource, schedule_generator, attempt, candidate -- shunt/nodes/marshal/resource_orchestrator/main.yue:348
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:348
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:355
        factory, low_resources, low_resource, schedule_generator, attempt, candidate = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource, _obj_0.schedule_generator, _obj_0.attempt, _obj_0.candidate -- shunt/nodes/marshal/resource_orchestrator/main.yue:348
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:355
      local factory_name, factory_pc_id, station_name, train_name, schedule = candidate.train_addr.factory.name, candidate.train_addr.factory.pc_id, candidate.train_addr.station.name, candidate.train_addr.name, candidate.schedule -- shunt/nodes/marshal/resource_orchestrator/main.yue:356
      local idemp_tok = IdempotenceToken() -- shunt/nodes/marshal/resource_orchestrator/main.yue:366
      local deadline = self.clock:now() + 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:368
      self.uplink:send_to(factory_pc_id, ScheduleRequest(idemp_tok, station_name, train_name, schedule)) -- shunt/nodes/marshal/resource_orchestrator/main.yue:369
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:370
      return _call_0["goto"](_call_0, 'awaiting_schedule_response', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:371
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:371
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:372
        low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:373
        schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:374
        attempt = attempt, -- shunt/nodes/marshal/resource_orchestrator/main.yue:375
        idemp_tok = idemp_tok, -- shunt/nodes/marshal/resource_orchestrator/main.yue:376
        deadline = deadline -- shunt/nodes/marshal/resource_orchestrator/main.yue:377
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:370
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:379
    on_awaiting_schedule_response = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:379
      local factory, low_resources, low_resource, schedule_generator, attempt, idemp_tok, deadline -- shunt/nodes/marshal/resource_orchestrator/main.yue:380
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:380
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:388
        factory, low_resources, low_resource, schedule_generator, attempt, idemp_tok, deadline = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource, _obj_0.schedule_generator, _obj_0.attempt, _obj_0.idemp_tok, _obj_0.deadline -- shunt/nodes/marshal/resource_orchestrator/main.yue:380
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:388
      if self.clock:now() > deadline then -- shunt/nodes/marshal/resource_orchestrator/main.yue:389
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:390
        _call_0["goto"](_call_0, 'schedule_not_applied', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:391
          factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:391
          low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:392
          low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:393
          schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:394
          attempt = attempt, -- shunt/nodes/marshal/resource_orchestrator/main.yue:395
          cause = 'request timeout' -- shunt/nodes/marshal/resource_orchestrator/main.yue:396
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:390
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:397
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:389
      local event = self.events:extract(F('(ResourceOrchestratorEvent) -> boolean', function(event) -- shunt/nodes/marshal/resource_orchestrator/main.yue:399
        if event.type ~= 'network-packet' then -- shunt/nodes/marshal/resource_orchestrator/main.yue:400
          return false -- shunt/nodes/marshal/resource_orchestrator/main.yue:401
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:400
        local packet = event.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:402
        if packet.protocol ~= 'ScheduleResponse' then -- shunt/nodes/marshal/resource_orchestrator/main.yue:403
          return false -- shunt/nodes/marshal/resource_orchestrator/main.yue:404
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:403
        if packet.idemp_tok ~= idemp_tok then -- shunt/nodes/marshal/resource_orchestrator/main.yue:405
          return false -- shunt/nodes/marshal/resource_orchestrator/main.yue:406
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:405
        return true -- shunt/nodes/marshal/resource_orchestrator/main.yue:407
      end)) -- shunt/nodes/marshal/resource_orchestrator/main.yue:399
      if not (event ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:408
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:409
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:408
      local packet = event.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:410
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:411
      return _call_0["goto"](_call_0, 'analysing_schedule_response', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:412
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:412
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:413
        low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:414
        schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:415
        attempt = attempt, -- shunt/nodes/marshal/resource_orchestrator/main.yue:416
        packet = packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:417
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:411
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:419
    on_analysing_schedule_response = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:419
      local factory, low_resources, low_resource, schedule_generator, attempt, packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:420
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:420
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:427
        factory, low_resources, low_resource, schedule_generator, attempt, packet = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource, _obj_0.schedule_generator, _obj_0.attempt, _obj_0.packet -- shunt/nodes/marshal/resource_orchestrator/main.yue:420
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:427
      local error_reason = packet.error_reason -- shunt/nodes/marshal/resource_orchestrator/main.yue:428
      if (error_reason ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/main.yue:429
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:430
        return _call_0["goto"](_call_0, 'schedule_not_applied', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:431
          factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:431
          low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:432
          low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:433
          schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:434
          attempt = attempt, -- shunt/nodes/marshal/resource_orchestrator/main.yue:435
          cause = error_reason -- shunt/nodes/marshal/resource_orchestrator/main.yue:436
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:430
      else -- shunt/nodes/marshal/resource_orchestrator/main.yue:438
        schedule_generator:end_generation() -- shunt/nodes/marshal/resource_orchestrator/main.yue:438
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:439
        return _call_0["goto"](_call_0, 'schedule_applied', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:440
          factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:440
          low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:441
          low_resource = low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:442
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:439
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:429
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:444
    on_schedule_applied = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:444
      local factory, low_resources, low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:445
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:445
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:449
        factory, low_resources, low_resource = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource -- shunt/nodes/marshal/resource_orchestrator/main.yue:445
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:449
      self:apply_cooldown(factory.name, low_resource) -- shunt/nodes/marshal/resource_orchestrator/main.yue:450
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:451
      return _call_0["goto"](_call_0, 'managing_resources', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:452
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:452
        low_resources = low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:453
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:451
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:455
    on_schedule_not_applied = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:455
      local factory, low_resources, low_resource, schedule_generator, attempt, cause -- shunt/nodes/marshal/resource_orchestrator/main.yue:456
      do -- shunt/nodes/marshal/resource_orchestrator/main.yue:456
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/main.yue:463
        factory, low_resources, low_resource, schedule_generator, attempt, cause = _obj_0.factory, _obj_0.low_resources, _obj_0.low_resource, _obj_0.schedule_generator, _obj_0.attempt, _obj_0.cause -- shunt/nodes/marshal/resource_orchestrator/main.yue:456
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:463
      log(function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:464
        return "failed to arrange delivery of " .. tostring(low_resource) .. " to " .. tostring(factory.name) .. ": " .. tostring(cause) -- shunt/nodes/marshal/resource_orchestrator/main.yue:465
      end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:464
      if attempt >= 10 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:466
        log(function() -- shunt/nodes/marshal/resource_orchestrator/main.yue:467
          return "cannot arrange delivery of " .. tostring(low_resource) .. " to " .. tostring(factory.name) .. ", giving up after " .. tostring(attempt) .. " attempts" -- shunt/nodes/marshal/resource_orchestrator/main.yue:467
        end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:467
        schedule_generator:end_generation() -- shunt/nodes/marshal/resource_orchestrator/main.yue:468
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:469
        _call_0["goto"](_call_0, 'managing_resources', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:470
          factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:470
          low_resources = low_resources -- shunt/nodes/marshal/resource_orchestrator/main.yue:471
        }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:469
        return -- shunt/nodes/marshal/resource_orchestrator/main.yue:472
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:466
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:473
      return _call_0["goto"](_call_0, 'generating_schedule', { -- shunt/nodes/marshal/resource_orchestrator/main.yue:474
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/main.yue:474
        low_resources = low_resources, -- shunt/nodes/marshal/resource_orchestrator/main.yue:475
        low_resource = low_resource, -- shunt/nodes/marshal/resource_orchestrator/main.yue:476
        schedule_generator = schedule_generator, -- shunt/nodes/marshal/resource_orchestrator/main.yue:477
        attempt = attempt + 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:478
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:473
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:480
    on_changing_epoch = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:480
      local new_epoch = self.sm.state.new_epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:481
      self.epoch = new_epoch -- shunt/nodes/marshal/resource_orchestrator/main.yue:482
      self:prune_factories() -- shunt/nodes/marshal/resource_orchestrator/main.yue:483
      self:prune_trains() -- shunt/nodes/marshal/resource_orchestrator/main.yue:484
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:485
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/main.yue:485
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:487
    prune_factories = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:487
      local LIFETIME_EPOCHS = 1 -- shunt/nodes/marshal/resource_orchestrator/main.yue:488
      self.factories = T('{string->Factory}', self:prune_statuses(self.factories, LIFETIME_EPOCHS)) -- shunt/nodes/marshal/resource_orchestrator/main.yue:489
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:491
    prune_trains = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:491
      local LIFETIME_EPOCHS = 10 -- shunt/nodes/marshal/resource_orchestrator/main.yue:492
      self.trains = T('{string->TrainStatus}', self:prune_statuses(self.trains, LIFETIME_EPOCHS)) -- shunt/nodes/marshal/resource_orchestrator/main.yue:493
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:495
    prune_statuses = F('({string->{last_seen_epoch: number}}, number) => {string->{}}', function(self, statuses, lifetime_epochs) -- shunt/nodes/marshal/resource_orchestrator/main.yue:495
      local death_horizon_epoch = self.epoch - lifetime_epochs -- shunt/nodes/marshal/resource_orchestrator/main.yue:496
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/main.yue:497
      for name, status in pairs(statuses) do -- shunt/nodes/marshal/resource_orchestrator/main.yue:498
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/main.yue:499
        repeat -- shunt/nodes/marshal/resource_orchestrator/main.yue:499
          if status.last_seen_epoch < death_horizon_epoch then -- shunt/nodes/marshal/resource_orchestrator/main.yue:499
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/main.yue:500
            break -- shunt/nodes/marshal/resource_orchestrator/main.yue:500
          end -- shunt/nodes/marshal/resource_orchestrator/main.yue:499
          _with_0[name] = status -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/main.yue:499
        until true -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
          break -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
        end -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
      end -- shunt/nodes/marshal/resource_orchestrator/main.yue:501
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:497
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:503
    on_applying_config = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:503
      local config = self.sm.state.config -- shunt/nodes/marshal/resource_orchestrator/main.yue:504
      self.config = config -- shunt/nodes/marshal/resource_orchestrator/main.yue:505
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/main.yue:506
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/main.yue:506
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:508
    ut_release_all_cooldowns = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/main.yue:508
      self.resend_cooldowns = { } -- shunt/nodes/marshal/resource_orchestrator/main.yue:509
    end) -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  } -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  if _base_0.__index == nil then -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    _base_0.__index = _base_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  end -- shunt/nodes/marshal/resource_orchestrator/main.yue:509
  _class_0 = setmetatable({ -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    __init = F('(ResourceOrchestratorOpts) => <>', function(self, opts) -- shunt/nodes/marshal/resource_orchestrator/main.yue:34
      local clock, config, scheduler, uplink = opts.clock, opts.config, opts.scheduler, opts.uplink -- shunt/nodes/marshal/resource_orchestrator/main.yue:35
      self.clock = clock -- shunt/nodes/marshal/resource_orchestrator/main.yue:41
      self.config = config -- shunt/nodes/marshal/resource_orchestrator/main.yue:42
      self.scheduler = scheduler -- shunt/nodes/marshal/resource_orchestrator/main.yue:43
      self.uplink = uplink -- shunt/nodes/marshal/resource_orchestrator/main.yue:44
      self.epoch = T('number', 0) -- shunt/nodes/marshal/resource_orchestrator/main.yue:46
      self.factories = T('{string->Factory}', { }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:48
      self.trains = T('{string->TrainStatus}', { }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:49
      self.resend_cooldowns = T('{string->{string->number}}', { }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:50
      self.firewall = Firewall({ -- shunt/nodes/marshal/resource_orchestrator/main.yue:53
        FactoryHeartbeat, -- shunt/nodes/marshal/resource_orchestrator/main.yue:53
        ScheduleResponse -- shunt/nodes/marshal/resource_orchestrator/main.yue:54
      }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:52
      self.events = Queue('ResourceOrchestratorEvent') -- shunt/nodes/marshal/resource_orchestrator/main.yue:55
      self.sm = self.__class:make_sm() -- shunt/nodes/marshal/resource_orchestrator/main.yue:56
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/nodes/marshal/resource_orchestrator/main.yue:57
    end), -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    __base = _base_0, -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    __name = "ResourceOrchestrator" -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  }, { -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    __index = _base_0, -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    __call = function(cls, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
      return _self_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
    end -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  }) -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  _base_0.__class = _class_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
  ResourceOrchestrator = _class_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
end -- shunt/nodes/marshal/resource_orchestrator/main.yue:509
_module_0["ResourceOrchestrator"] = ResourceOrchestrator -- shunt/nodes/marshal/resource_orchestrator/main.yue:33
return _module_0 -- shunt/nodes/marshal/resource_orchestrator/main.yue:509
end
package.preload['shunt.nodes.marshal.resource_orchestrator.promise_tracker'] = function(...)
-- [yue]: shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue
local _module_0 = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:1
local MinecraftClock = require('shunt.clock').MinecraftClock -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
local log, trace -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  log, trace = _obj_0.log, _obj_0.trace -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
local declare_type, F, T -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
local spec = require('shunt.spec').spec -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
declare_type('PromiseTracker', [[{
  promise: (string, [PromiseStation], ?number, ?number) => Promise,
  break_promise: (Promise) => <>,
  train_is_promised: (string) => boolean,
  station_is_fully_promised: (string) => boolean,
  declare_train_seen: (string, string) => <>,
}]]) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:8
declare_type('Promise', [[{
  id: number,
  train: string,
  stations: ?[PromiseStation],
  should_approach_index: number,
  deadline: ?number,
  max_step_duration: number,
  lost: boolean,
}]]) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:15
declare_type('PromiseStation', [[{
  name: string,
  capacity: number,
}]]) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:24
declare_type('PromiseSet', [[{
  count: number,
  promises: {number},
}]]) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:28
declare_type('PromiseTrackerSnapshot', '[Promise]') -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:32
local PromiseTracker -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  local _class_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  local _base_0 = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    snapshot = F('() => PromiseTrackerSnapshot', function(self) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:40
      local promises -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
        local _accum_0 = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
        local _len_0 = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
        for _, promise in pairs(self.promises) do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
          _accum_0[_len_0] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
          _len_0 = _len_0 + 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
        promises = _accum_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:41
      table.sort(promises, function(a, b) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:42
        return a.id < b.id -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:42
      end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:42
      return promises -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:43
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:45
    load_snapshot = F('(PromiseTrackerSnapshot) => <>', function(self, raw_promises) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:45
      self.promises = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:46
      self.train_promises = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:47
      self.station_promise_sets = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:48
      self.train_lost_promises = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:49
      for _index_0 = 1, #raw_promises do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:50
        local raw_promise = raw_promises[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:50
        self.promises[raw_promise.id] = raw_promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:52
        self.train_promises[raw_promise.train] = raw_promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:53
        if raw_promise.lost then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:54
          self.train_lost_promises[raw_promise.train] = raw_promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:55
        else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:56
          if (raw_promise.stations ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:56
            local _list_0 = raw_promise.stations -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:57
            for _index_1 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:57
              local station = _list_0[_index_1] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:57
              local _obj_0 = self.station_promise_sets -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
              local _update_0 = station.name -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
              if _obj_0[_update_0] == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
                _obj_0[_update_0] = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
                  count = 0, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
                  promises = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
                } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
              end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:58
              local _obj_1 = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:59
              _obj_1.count = _obj_1.count + 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:59
              self.station_promise_sets[station.name].promises[raw_promise.id] = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:60
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:60
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:56
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:54
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:60
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
    promise = F('(string, [PromiseStation], ?number, ?number) => Promise', function(self, train, stations, max_step_duration, max_unload_duration) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
      if max_step_duration == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
        max_step_duration = 30 * 60 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
      if max_unload_duration == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
        max_unload_duration = 60 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:62
      return self:_promise(train, stations, max_step_duration, max_unload_duration) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:63
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:65
    reserve = F('(string) => <>', function(self, train) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:65
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
        local promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
        do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
          local _exp_0 = self.train_promises[train] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
          if _exp_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
            promise = _exp_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
          else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
            promise = self.train_lost_promises[train] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
        if promise then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
          self:break_promise(promise) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:67
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:66
      self:_promise(train) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:68
      return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:69
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
    _promise = F('(string, ?[PromiseStation], ?number, ?number) => Promise', function(self, train, stations, max_step_duration, max_unload_duration) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
      if max_step_duration == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
        max_step_duration = 30 * 60 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
      if max_unload_duration == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
        max_unload_duration = 60 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:71
      if (self.train_promises[train] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:72
        error("internal error: cannot promise already-promised train '" .. tostring(train) .. "'") -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:73
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:72
      local id = self:_generate_id() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:75
      local deadline = self.clock:now() + max_step_duration -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:76
      local promise = T('Promise', { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:78
        id = id, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:78
        train = train, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:79
        stations = stations, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:80
        should_approach_index = 1, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:81
        deadline = deadline, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:82
        max_step_duration = max_step_duration, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:83
        max_unload_duration = max_unload_duration, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:84
        lost = false -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:85
      }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:77
      self.promises[id] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:86
      self.train_promises[promise.train] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:87
      if (stations ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:88
        for _index_0 = 1, #stations do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:89
          local station = stations[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:89
          local promise_set -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
          do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
            local _exp_0 = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
            if _exp_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
              promise_set = _exp_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
            else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
              do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:90
                promise_set = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:92
                  count = 0, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:92
                  promises = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:93
                } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:91
                self.station_promise_sets[station.name] = promise_set -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:94
                promise_set = promise_set -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:95
              end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:95
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:95
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:95
          promise_set.count = promise_set.count + 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:97
          promise_set.promises[id] = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:98
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:98
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:88
      return promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:99
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:101
    _generate_id = F('() => number', function(self) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:101
      local id -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:102
      repeat -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:103
        id = self.rand:random(2000000) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:104
      until not (self.promises[id] ~= nil) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:105
      return id -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:106
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:108
    break_promise = F('(Promise) => <>', function(self, promise) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:108
      local id = promise.id -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:109
      self.promises[id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:110
      self.train_lost_promises[promise.train] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:111
      self.train_promises[promise.train] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:112
      if not (promise.stations ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:113
        return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:114
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:113
      local _list_0 = promise.stations -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:115
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:115
        local station = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:115
        do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:116
          local _with_0 = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:116
          if _with_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:116
            if (_with_0.promises[id] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:117
              _with_0.count = _with_0.count - 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:118
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:117
            _with_0.promises[id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:119
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:116
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:116
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:119
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:121
    train_is_promised = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:121
      self:_prune() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:122
      return (self.train_promises[train_name] ~= nil) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:123
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:125
    train_is_lost = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:125
      self:_prune() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:126
      if (self.train_lost_promises[train_name] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:127
        log(function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:128
          return "train " .. tostring(train_name) .. " was lost!" -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:128
        end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:128
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:127
      return (self.train_lost_promises[train_name] ~= nil) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:129
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:131
    declare_train_found = F('(string) => ?string', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:131
      local promise = self.train_lost_promises[train_name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:132
      if not (promise ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:133
        return "train '" .. tostring(train_name) .. "' was not lost" -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:134
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:133
      return self:break_promise(promise) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:135
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:137
    station_is_fully_promised = F('(PromiseStation) => boolean', function(self, station) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:137
      self:_prune() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:138
      local promise_set = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:140
      if not (promise_set ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:141
        return false -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:142
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:141
      return promise_set.count >= station.capacity -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:143
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:145
    promise_valid = F('(Promise) => boolean', function(self, promise) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:145
      if not (promise.deadline ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:146
        return true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:147
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:146
      if not (self.promises[promise.id] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:148
        return false -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:149
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:148
      return self.clock:now() < promise.deadline -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:150
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:152
    declare_train_seen = F('(string, string) => <>', function(self, train_name, station_name) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:152
      trace("declaring train " .. tostring(train_name) .. " seen at " .. tostring(station_name)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:153
      local promise = self.train_promises[train_name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:154
      if not (promise ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:155
        return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:156
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:155
      if promise.lost or (self.train_lost_promises[train_name] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:157
        return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:158
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:157
      if not (promise.stations ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:160
        return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:161
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:160
      if promise.stations[promise.should_approach_index].name == station_name then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:164
        local promise_set = self.station_promise_sets[station_name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:165
        if (promise_set.promises[promise.id] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:166
          promise_set.count = promise_set.count - 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:167
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:166
        promise_set.promises[promise.id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:168
        promise.should_approach_index = promise.should_approach_index + 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:170
        local max_duration -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:172
        if promise.should_approach_index <= #promise.stations then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:172
          max_duration = promise.max_step_duration -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:173
        else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:175
          max_duration = promise.max_unload_duration -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:175
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:172
        promise.deadline = self.clock:now() + max_duration -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:176
      elseif (function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
        local _obj_0 = promise.stations[promise.should_approach_index - 1] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
        if _obj_0 ~= nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
          return _obj_0.name -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
        return nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
      end)() == station_name then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:177
        trace("repeat-observation of " .. tostring(promise.train) .. " at " .. tostring(promise.stations[promise.should_approach_index - 1].name) .. " (this is index " .. tostring(promise.should_approach_index) .. " of " .. tostring(#promise.stations) .. ")") -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:179
      else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:181
        trace("train reached unexpected station: " .. tostring(station_name) .. " (expected " .. tostring(promise.stations[promise.should_approach_index]) .. ", but would also have accepted " .. tostring(promise.stations[promise.should_approach_index - 1]) .. ")") -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:181
        promise.lost = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:182
        self.train_lost_promises[train_name] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:183
        local _list_0 = promise.stations -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:186
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:186
          local station = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:186
          local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:187
          repeat -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:187
            local promise_set = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:187
            if not (promise_set ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:188
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:189
              break -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:189
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:188
            if (promise_set.promises[promise.id] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:190
              promise_set.count = promise_set.count - 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:191
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:190
            promise_set.promises[promise.id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:187
          until true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
          if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
            break -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:192
        promise.deadline = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:195
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:195
      return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:196
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:198
    _prune = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:198
      local ids_to_prune -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:199
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:199
        local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:199
        for id, promise in pairs(self.promises) do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:200
          if not self:promise_valid(promise) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:201
            _with_0[#_with_0 + 1] = id -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:202
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:201
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:202
        ids_to_prune = _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:199
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:199
      local now = self.clock:now() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:204
      for _index_0 = 1, #ids_to_prune do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:205
        local id = ids_to_prune[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:205
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:206
        repeat -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:206
          local promise = self.promises[id] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:206
          trace("pruning promise for " .. tostring(promise.train)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:207
          local deadline_expired = (promise.deadline ~= nil) and now >= promise.deadline -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:209
          if deadline_expired then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:210
            local schedule_complete = (promise.stations ~= nil) and promise.should_approach_index >= #promise.stations -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:211
            if schedule_complete then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:212
              trace("schedule was completed") -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:213
              self.promises[id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:214
              self.train_promises[promise.train] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:215
            else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:217
              trace("train " .. tostring(promise.train) .. " was lost (deadline expiry)") -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:217
              promise.lost = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:218
              self.train_lost_promises[promise.train] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:219
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:212
          else -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:221
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:221
            break -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:221
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:210
          if not (promise.stations ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:223
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:224
            break -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:224
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:223
          local _list_0 = promise.stations -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:225
          for _index_1 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:225
            local station = _list_0[_index_1] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:225
            local promise_set = self.station_promise_sets[station.name] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:226
            if (promise_set.promises[id] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:227
              promise_set.count = promise_set.count - 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:228
            end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:227
            promise_set.promises[id] = nil -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
          end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:206
        until true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
          break -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:229
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:231
    ut_break_all_promises = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:231
      local promises -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
        local _accum_0 = { } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
        local _len_0 = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
        for _, promise in pairs(self.promises) do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
          _accum_0[_len_0] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
          _len_0 = _len_0 + 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
        end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
        promises = _accum_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:232
      for _index_0 = 1, #promises do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:233
        local promise = promises[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:233
        self:break_promise(promise) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:234
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:234
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:236
    ut_declare_train_lost = F('(string) => <>', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:236
      local DUMMY_STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:238
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:238
          name = 'dummy-station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:238
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:239
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:238
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:240
          name = 'dummy-station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:240
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:241
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:240
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:237
      local promise = self:promise(train_name, DUMMY_STATIONS) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:242
      promise.lost = true -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:243
      self.train_lost_promises[train_name] = promise -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:244
      assert(self:train_is_lost(train_name)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:245
      return -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:246
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  if _base_0.__index == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    _base_0.__index = _base_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:246
  _class_0 = setmetatable({ -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    __init = F('(Random, ?Clock) => <>', function(self, rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
      if clock == nil then -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
        clock = MinecraftClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
      self.rand = rand -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
      self.clock = clock -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:34
      self.promises = T('{number->Promise}', { }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:35
      self.train_promises = T('{string->Promise}', { }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:36
      self.station_promise_sets = T('{string->PromiseSet}', { }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:37
      self.train_lost_promises = T('{string->Promise}', { }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:38
    end), -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    __base = _base_0, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    __name = "PromiseTracker" -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  }, { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    __index = _base_0, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    __call = function(cls, ...) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
      return _self_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
    end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  }) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  _base_0.__class = _class_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
  PromiseTracker = _class_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:246
_module_0["PromiseTracker"] = PromiseTracker -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:33
spec(function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:248
  local TestClock = require('shunt.clock').TestClock -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local HOST = require('shunt.compat').HOST -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local PseudoRandom = require('shunt.nodes.marshal.util.pseudo_random').PseudoRandom -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local describe, it, matchers -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:0
  local deep_eq, eq = matchers.deep_eq, matchers.eq -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:256
  return describe('PromiseTracker', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:258
    it('makes and breaks promises', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:259
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:260
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:261
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:262
      local TRAIN_NAME_1 = 'test_train_name_1' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:263
      local STATIONS_1 = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:265
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:265
          name = 'bank-gold-outbound', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:265
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:266
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:265
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:267
          name = 'tower-hill-gold-inbound', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:267
          capacity = 2 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:268
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:267
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:264
      local TRAIN_NAME_2 = 'test_train_name_2' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:269
      local STATIONS_2 = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:271
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:271
          name = 'canary-wharf-gold-outbound', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:271
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:272
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:271
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:273
          name = 'tower-hill-gold-inbound', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:273
          capacity = 2 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:274
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:273
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:270
      local promise_1 = _with_0:promise(TRAIN_NAME_1, STATIONS_1); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:276
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME_1)]=], (_with_0:train_is_promised(TRAIN_NAME_1)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(277)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:277
      for _index_0 = 1, #STATIONS_1 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:278
        local station = STATIONS_1[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:278
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(station.capacity == 1)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(279)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:279
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:279
      for _index_0 = 1, #STATIONS_2 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:280
        local station = STATIONS_2[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:280
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(281)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:281
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:281
      local promise_2 = _with_0:promise(TRAIN_NAME_2, STATIONS_2) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:283
      for _index_0 = 1, #STATIONS_1 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:284
        local station = STATIONS_1[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:284
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(285)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:285
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:285
      for _index_0 = 1, #STATIONS_2 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:286
        local station = STATIONS_2[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:286
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(287)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:287
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:287
      _with_0:break_promise(promise_1) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:289
      for _index_0 = 1, #STATIONS_1 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:290
        local station = STATIONS_1[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:290
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(291)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:291
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:291
      for _index_0 = 1, #STATIONS_2 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:292
        local station = STATIONS_2[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:292
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(station.capacity == 1)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(293)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:293
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:293
      _with_0:break_promise(promise_2) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:295
      for _index_0 = 1, #STATIONS_1 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:296
        local station = STATIONS_1[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:296
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(297)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:297
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:297
      for _index_0 = 1, #STATIONS_2 do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:298
        local station = STATIONS_2[_index_0] -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:298
        require('shunt.spec')._expect_that([=[(\station_is_fully_promised station)]=], (_with_0:station_is_fully_promised(station)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(299)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:299
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:299
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:262
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:259
    it('handles valid train arrival', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:301
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:302
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:303
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:304
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:305
      local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:307
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:307
          name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:307
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:308
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:307
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:309
          name = 'station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:309
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:310
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:309
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:306
      local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:311
      local MAX_UNLOAD_DURATION = 10; -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:312
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(314)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:314
      _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:316
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(317)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:317
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(318)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:318
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(319)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:319
      clock.time = clock.time + (MAX_STEP_DURATION - 1) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:320
      _with_0:declare_train_seen(TRAIN_NAME, 'station-1'); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:322
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(323)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:323
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(324)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:324
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(325)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:325
      clock.time = clock.time + (MAX_STEP_DURATION - 1) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:326
      _with_0:declare_train_seen(TRAIN_NAME, 'station-1'); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:328
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(329)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:329
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(330)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:330
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(331)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:331
      clock.time = clock.time + (MAX_STEP_DURATION - 1) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:332
      _with_0:declare_train_seen(TRAIN_NAME, 'station-2'); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:334
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(335)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:335
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(336)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:336
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(337)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:337
      clock.time = clock.time + (MAX_UNLOAD_DURATION - 1); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:339
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(340)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:340
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(341)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:341
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(342)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:342
      clock.time = clock.time + 1; -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:344
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(345)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:345
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(346)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:346
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[2])]=], (_with_0:station_is_fully_promised(STATIONS[2])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(347)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:347
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:304
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:301
    it('handles invalid train arrival', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:349
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:350
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:351
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:352
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:353
      local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:355
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:355
          name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:355
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:356
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:355
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:354
      local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:357
      local MAX_UNLOAD_DURATION = 10 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:358
      local promise = _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:359
      require('shunt.spec')._assert_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(361)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:361
      _with_0:declare_train_seen(TRAIN_NAME, 'unrelated-station'); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:363
      require('shunt.spec')._expect_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(364)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:364
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(365)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:365
      _with_0:break_promise(promise); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:367
      require('shunt.spec')._expect_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(368)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:368
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(369)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:369
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:352
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:349
    it('handles promise expiry', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:371
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:372
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:373
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:374
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:375
      local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:377
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:377
          name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:377
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:378
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:377
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:379
          name = 'station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:379
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:380
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:379
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:376
      local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:381
      local MAX_UNLOAD_DURATION = 10 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:382
      local promise = _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:383
      require('shunt.spec')._assert_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(385)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:385
      require('shunt.spec')._assert_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(386)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:386
      require('shunt.spec')._expect_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(387)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:387
      clock.time = clock.time + MAX_STEP_DURATION; -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:389
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(391)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:391
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(392)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:392
      require('shunt.spec')._expect_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(393)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:393
      _with_0:break_promise(promise); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:395
      require('shunt.spec')._expect_that([=[(\train_is_promised TRAIN_NAME)]=], (_with_0:train_is_promised(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(397)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:397
      require('shunt.spec')._expect_that([=[(\station_is_fully_promised STATIONS[1])]=], (_with_0:station_is_fully_promised(STATIONS[1])), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(398)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:398
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:374
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:371
    it('handles unseen trains', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:400
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:401
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:402
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:403
      require('shunt.spec')._expect_that([=[(\train_is_promised 'spurious-train')]=], (_with_0:train_is_promised('spurious-train')), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(404)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:404
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:403
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:400
    it('handles finding lost trains', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:406
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:407
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:408
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:409
      local TRAIN_NAME = 'test-train-name'; -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:410
      require('shunt.spec')._expect_that([=[(\declare_train_found TRAIN_NAME)]=], (_with_0:declare_train_found(TRAIN_NAME)), (eq("train '" .. tostring(TRAIN_NAME) .. "' was not lost")), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(412)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:412
      local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:415
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:415
          name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:415
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:416
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:415
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:417
          name = 'station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:417
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:418
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:417
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:414
      local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:419
      local MAX_UNLOAD_DURATION = 10 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:420
      _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:421
      clock.time = clock.time + (2 * MAX_STEP_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:423
      require('shunt.spec')._assert_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(425)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:425
      require('shunt.spec')._expect_that([=[(\declare_train_found TRAIN_NAME)]=], (_with_0:declare_train_found(TRAIN_NAME)), (eq(nil)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(426)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:426
      require('shunt.spec')._expect_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(427)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:427
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:409
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:406
    it('handles train reservation requests', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:429
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:430
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:431
      local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:432
      local TRAIN_NAME = 'test-train-name' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:433
      local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:436
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:436
          name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:436
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:437
        }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:436
        { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:438
          name = 'station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:438
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:439
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:438
      } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:435
      local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:440
      local MAX_UNLOAD_DURATION = 10 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:441
      _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:442
      clock.time = clock.time + (2 * MAX_STEP_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:444
      require('shunt.spec')._assert_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(445)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:445
      _with_0:reserve(TRAIN_NAME); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:447
      require('shunt.spec')._expect_that([=[(\train_is_promised 'test-train-name')]=], (_with_0:train_is_promised('test-train-name')), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(448)); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:448
      require('shunt.spec')._assert_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(449)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:449
      clock.time = clock.time + 2000000; -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:451
      require('shunt.spec')._expect_that([=[(\train_is_promised 'test-train-name')]=], (_with_0:train_is_promised('test-train-name')), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(452)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:452
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:432
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:429
    return it('survives snapshotting', function() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:454
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:455
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:456
      local promise_tracker -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:457
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:457
        local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:457
        local TRAIN_NAME = 'test-train-name' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:458
        local TRAIN_NAME_2 = 'test-train-name-2' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:459
        local TRAIN_NAME_3 = 'test-train-name-3' -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:460
        local STATIONS = { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:463
          { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:463
            name = 'station-1', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:463
            capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:464
          }, -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:463
          { -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:465
            name = 'station-2', -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:465
            capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:466
          } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:465
        } -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:462
        local MAX_STEP_DURATION = 100 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:467
        local MAX_UNLOAD_DURATION = 10 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:468
        _with_0:promise(TRAIN_NAME, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:469
        _with_0:reserve(TRAIN_NAME_2) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:470
        clock.time = clock.time + (2 * MAX_STEP_DURATION); -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:472
        require('shunt.spec')._assert_that([=[(\train_is_lost TRAIN_NAME)]=], (_with_0:train_is_lost(TRAIN_NAME)), (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(473)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:473
        _with_0:promise(TRAIN_NAME_3, STATIONS, MAX_STEP_DURATION, MAX_UNLOAD_DURATION) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:475
        promise_tracker = _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:457
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:457
      local save_data = promise_tracker:snapshot() -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:477
      local loaded_promise_tracker -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:478
      do -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:478
        local _with_0 = PromiseTracker(rand, clock) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:478
        _with_0:load_snapshot(save_data) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:479
        loaded_promise_tracker = _with_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:478
      end -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:478
      return require('shunt.spec')._assert_that([=[loaded_promise_tracker]=], loaded_promise_tracker, (deep_eq(promise_tracker)), tostring("shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue") .. ":" .. tostring(480)) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:480
    end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:480
  end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:480
end) -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:248
return _module_0 -- shunt/nodes/marshal/resource_orchestrator/promise_tracker.yue:480
end
package.preload['shunt.nodes.marshal.util.pseudo_random'] = function(...)
-- [yue]: shunt/nodes/marshal/util/pseudo_random.yue
local _module_0 = { } -- shunt/nodes/marshal/util/pseudo_random.yue:1
local declare_type, F -- shunt/nodes/marshal/util/pseudo_random.yue:0
do -- shunt/nodes/marshal/util/pseudo_random.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/marshal/util/pseudo_random.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/nodes/marshal/util/pseudo_random.yue:0
end -- shunt/nodes/marshal/util/pseudo_random.yue:0
local spec = require('shunt.spec').spec -- shunt/nodes/marshal/util/pseudo_random.yue:0
declare_type('Random', [[{
  random: (number) => number,
  pick: ([some]) => ?some,
  shuffle: ([some]) => <>,
}]]) -- shunt/nodes/marshal/util/pseudo_random.yue:6
local PseudoRandom -- shunt/nodes/marshal/util/pseudo_random.yue:11
do -- shunt/nodes/marshal/util/pseudo_random.yue:11
  local _class_0 -- shunt/nodes/marshal/util/pseudo_random.yue:11
  local _base_0 = { -- shunt/nodes/marshal/util/pseudo_random.yue:11
    random = F('(number) => number', function(self, max) -- shunt/nodes/marshal/util/pseudo_random.yue:14
      self.state = (47328190 * self.state + 1000003) % 2147483647 -- shunt/nodes/marshal/util/pseudo_random.yue:15
      return 1 + self.state % max -- shunt/nodes/marshal/util/pseudo_random.yue:16
    end), -- shunt/nodes/marshal/util/pseudo_random.yue:18
    pick = F('([some]) => ?some', function(self, options) -- shunt/nodes/marshal/util/pseudo_random.yue:18
      if #options == 0 then -- shunt/nodes/marshal/util/pseudo_random.yue:19
        return nil -- shunt/nodes/marshal/util/pseudo_random.yue:20
      end -- shunt/nodes/marshal/util/pseudo_random.yue:19
      return options[self:random(#options)] -- shunt/nodes/marshal/util/pseudo_random.yue:21
    end), -- shunt/nodes/marshal/util/pseudo_random.yue:23
    shuffle = F('([some]) => <>', function(self, list) -- shunt/nodes/marshal/util/pseudo_random.yue:23
      local n = #list -- shunt/nodes/marshal/util/pseudo_random.yue:24
      for i = 1, n do -- shunt/nodes/marshal/util/pseudo_random.yue:25
        local new_index = self:random(n) -- shunt/nodes/marshal/util/pseudo_random.yue:26
        list[i], list[new_index] = list[new_index], list[i] -- shunt/nodes/marshal/util/pseudo_random.yue:27
      end -- shunt/nodes/marshal/util/pseudo_random.yue:27
    end) -- shunt/nodes/marshal/util/pseudo_random.yue:11
  } -- shunt/nodes/marshal/util/pseudo_random.yue:11
  if _base_0.__index == nil then -- shunt/nodes/marshal/util/pseudo_random.yue:11
    _base_0.__index = _base_0 -- shunt/nodes/marshal/util/pseudo_random.yue:11
  end -- shunt/nodes/marshal/util/pseudo_random.yue:27
  _class_0 = setmetatable({ -- shunt/nodes/marshal/util/pseudo_random.yue:11
    __init = F('(?number) => <>', function(self, state) -- shunt/nodes/marshal/util/pseudo_random.yue:12
      if state == nil then -- shunt/nodes/marshal/util/pseudo_random.yue:12
        state = math.random(2147483647) -- shunt/nodes/marshal/util/pseudo_random.yue:12
      end -- shunt/nodes/marshal/util/pseudo_random.yue:12
      self.state = state -- shunt/nodes/marshal/util/pseudo_random.yue:12
    end), -- shunt/nodes/marshal/util/pseudo_random.yue:11
    __base = _base_0, -- shunt/nodes/marshal/util/pseudo_random.yue:11
    __name = "PseudoRandom" -- shunt/nodes/marshal/util/pseudo_random.yue:11
  }, { -- shunt/nodes/marshal/util/pseudo_random.yue:11
    __index = _base_0, -- shunt/nodes/marshal/util/pseudo_random.yue:11
    __call = function(cls, ...) -- shunt/nodes/marshal/util/pseudo_random.yue:11
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/util/pseudo_random.yue:11
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/util/pseudo_random.yue:11
      return _self_0 -- shunt/nodes/marshal/util/pseudo_random.yue:11
    end -- shunt/nodes/marshal/util/pseudo_random.yue:11
  }) -- shunt/nodes/marshal/util/pseudo_random.yue:11
  _base_0.__class = _class_0 -- shunt/nodes/marshal/util/pseudo_random.yue:11
  PseudoRandom = _class_0 -- shunt/nodes/marshal/util/pseudo_random.yue:11
end -- shunt/nodes/marshal/util/pseudo_random.yue:27
_module_0["PseudoRandom"] = PseudoRandom -- shunt/nodes/marshal/util/pseudo_random.yue:11
spec(function() -- shunt/nodes/marshal/util/pseudo_random.yue:29
  local describe, it, matchers -- shunt/nodes/marshal/util/pseudo_random.yue:0
  do -- shunt/nodes/marshal/util/pseudo_random.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/marshal/util/pseudo_random.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/marshal/util/pseudo_random.yue:0
  end -- shunt/nodes/marshal/util/pseudo_random.yue:0
  local contains_value, deep_eq, eq, ge, gt, le = matchers.contains_value, matchers.deep_eq, matchers.eq, matchers.ge, matchers.gt, matchers.le -- shunt/nodes/marshal/util/pseudo_random.yue:34
  return describe('PseudoRandom', function() -- shunt/nodes/marshal/util/pseudo_random.yue:36
    describe('\\random', function() -- shunt/nodes/marshal/util/pseudo_random.yue:37
      it('returns expected values', function() -- shunt/nodes/marshal/util/pseudo_random.yue:38
        local _with_0 = PseudoRandom() -- shunt/nodes/marshal/util/pseudo_random.yue:39
        local ATTEMPTS = 100 -- shunt/nodes/marshal/util/pseudo_random.yue:40
        local MAX = 5 -- shunt/nodes/marshal/util/pseudo_random.yue:41
        local values = { } -- shunt/nodes/marshal/util/pseudo_random.yue:42
        for _ = 1, ATTEMPTS do -- shunt/nodes/marshal/util/pseudo_random.yue:43
          values[#values + 1] = _with_0:random(MAX) -- shunt/nodes/marshal/util/pseudo_random.yue:44
        end -- shunt/nodes/marshal/util/pseudo_random.yue:44
        local max = -1 -- shunt/nodes/marshal/util/pseudo_random.yue:46
        local min = 100 * MAX -- shunt/nodes/marshal/util/pseudo_random.yue:47
        for _index_0 = 1, #values do -- shunt/nodes/marshal/util/pseudo_random.yue:48
          local value = values[_index_0] -- shunt/nodes/marshal/util/pseudo_random.yue:48
          if max < value then -- shunt/nodes/marshal/util/pseudo_random.yue:49
            max = value -- shunt/nodes/marshal/util/pseudo_random.yue:50
          end -- shunt/nodes/marshal/util/pseudo_random.yue:49
          if min > value then -- shunt/nodes/marshal/util/pseudo_random.yue:51
            min = value -- shunt/nodes/marshal/util/pseudo_random.yue:52
          end -- shunt/nodes/marshal/util/pseudo_random.yue:51
        end -- shunt/nodes/marshal/util/pseudo_random.yue:52
        require('shunt.spec')._expect_that([=[min]=], min, (ge(1)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(53)); -- shunt/nodes/marshal/util/pseudo_random.yue:53
        require('shunt.spec')._expect_that([=[max]=], max, (le(MAX)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(54)) -- shunt/nodes/marshal/util/pseudo_random.yue:54
        return _with_0 -- shunt/nodes/marshal/util/pseudo_random.yue:39
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:38
      it('returns different values', function() -- shunt/nodes/marshal/util/pseudo_random.yue:56
        local _with_0 = PseudoRandom() -- shunt/nodes/marshal/util/pseudo_random.yue:57
        local ATTEMPTS = 100 -- shunt/nodes/marshal/util/pseudo_random.yue:58
        local MAX = 5 -- shunt/nodes/marshal/util/pseudo_random.yue:59
        local seen = { } -- shunt/nodes/marshal/util/pseudo_random.yue:60
        local num_unique = 0 -- shunt/nodes/marshal/util/pseudo_random.yue:61
        for _ = 1, ATTEMPTS do -- shunt/nodes/marshal/util/pseudo_random.yue:62
          local _continue_0 = false -- shunt/nodes/marshal/util/pseudo_random.yue:63
          repeat -- shunt/nodes/marshal/util/pseudo_random.yue:63
            local value = _with_0:random(MAX) -- shunt/nodes/marshal/util/pseudo_random.yue:63
            if seen[value] then -- shunt/nodes/marshal/util/pseudo_random.yue:64
              _continue_0 = true -- shunt/nodes/marshal/util/pseudo_random.yue:65
              break -- shunt/nodes/marshal/util/pseudo_random.yue:65
            end -- shunt/nodes/marshal/util/pseudo_random.yue:64
            num_unique = num_unique + 1 -- shunt/nodes/marshal/util/pseudo_random.yue:66
            _continue_0 = true -- shunt/nodes/marshal/util/pseudo_random.yue:63
          until true -- shunt/nodes/marshal/util/pseudo_random.yue:66
          if not _continue_0 then -- shunt/nodes/marshal/util/pseudo_random.yue:66
            break -- shunt/nodes/marshal/util/pseudo_random.yue:66
          end -- shunt/nodes/marshal/util/pseudo_random.yue:66
        end -- shunt/nodes/marshal/util/pseudo_random.yue:66
        require('shunt.spec')._expect_that([=[num_unique]=], num_unique, (gt(1)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(68)) -- shunt/nodes/marshal/util/pseudo_random.yue:68
        return _with_0 -- shunt/nodes/marshal/util/pseudo_random.yue:57
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:56
      return it('is reentrant', function() -- shunt/nodes/marshal/util/pseudo_random.yue:70
        local SEED = 12345 -- shunt/nodes/marshal/util/pseudo_random.yue:71
        local MAX = 1000000 -- shunt/nodes/marshal/util/pseudo_random.yue:72
        local rand1 = PseudoRandom(SEED) -- shunt/nodes/marshal/util/pseudo_random.yue:73
        local rand2 = PseudoRandom(SEED) -- shunt/nodes/marshal/util/pseudo_random.yue:74
        local values1 = { } -- shunt/nodes/marshal/util/pseudo_random.yue:76
        local values2 = { } -- shunt/nodes/marshal/util/pseudo_random.yue:77
        for _ = 1, 100 do -- shunt/nodes/marshal/util/pseudo_random.yue:78
          values1[#values1 + 1] = rand1:random(MAX) -- shunt/nodes/marshal/util/pseudo_random.yue:79
          values2[#values2 + 1] = rand2:random(MAX) -- shunt/nodes/marshal/util/pseudo_random.yue:80
        end -- shunt/nodes/marshal/util/pseudo_random.yue:80
        return require('shunt.spec')._expect_that([=[values1]=], values1, (deep_eq(values2)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(82)) -- shunt/nodes/marshal/util/pseudo_random.yue:82
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:82
    end) -- shunt/nodes/marshal/util/pseudo_random.yue:37
    describe('\\pick', function() -- shunt/nodes/marshal/util/pseudo_random.yue:84
      it('returns nil on empty input', function() -- shunt/nodes/marshal/util/pseudo_random.yue:85
        return require('shunt.spec')._expect_that([=[(PseudoRandom!\pick {})]=], (PseudoRandom():pick({ })), (eq(nil)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(86)) -- shunt/nodes/marshal/util/pseudo_random.yue:86
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:85
      it('selects a present element', function() -- shunt/nodes/marshal/util/pseudo_random.yue:88
        return require('shunt.spec')._expect_that([=[(PseudoRandom!\pick {'a'})]=], (PseudoRandom():pick({ -- shunt/nodes/marshal/util/pseudo_random.yue:89
          'a' -- shunt/nodes/marshal/util/pseudo_random.yue:89
        })), (eq('a')), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(89)) -- shunt/nodes/marshal/util/pseudo_random.yue:89
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:88
      return it('selects different elements', function() -- shunt/nodes/marshal/util/pseudo_random.yue:91
        local elems -- shunt/nodes/marshal/util/pseudo_random.yue:92
        do -- shunt/nodes/marshal/util/pseudo_random.yue:92
          local _accum_0 = { } -- shunt/nodes/marshal/util/pseudo_random.yue:92
          local _len_0 = 1 -- shunt/nodes/marshal/util/pseudo_random.yue:92
          for i = 1, 100 do -- shunt/nodes/marshal/util/pseudo_random.yue:92
            _accum_0[_len_0] = tostring(i) -- shunt/nodes/marshal/util/pseudo_random.yue:92
            _len_0 = _len_0 + 1 -- shunt/nodes/marshal/util/pseudo_random.yue:92
          end -- shunt/nodes/marshal/util/pseudo_random.yue:92
          elems = _accum_0 -- shunt/nodes/marshal/util/pseudo_random.yue:92
        end -- shunt/nodes/marshal/util/pseudo_random.yue:92
        local seen = { } -- shunt/nodes/marshal/util/pseudo_random.yue:93
        local unique_elems = { } -- shunt/nodes/marshal/util/pseudo_random.yue:94
        local rand = PseudoRandom() -- shunt/nodes/marshal/util/pseudo_random.yue:95
        for i = 1, #elems do -- shunt/nodes/marshal/util/pseudo_random.yue:96
          local elem = rand:pick(elems) -- shunt/nodes/marshal/util/pseudo_random.yue:97
          if not seen[elem] then -- shunt/nodes/marshal/util/pseudo_random.yue:98
            unique_elems[#unique_elems + 1] = elem -- shunt/nodes/marshal/util/pseudo_random.yue:99
          end -- shunt/nodes/marshal/util/pseudo_random.yue:98
          seen[elem] = true -- shunt/nodes/marshal/util/pseudo_random.yue:100
        end -- shunt/nodes/marshal/util/pseudo_random.yue:100
        return require('shunt.spec')._expect_that([=[#unique_elems]=], #unique_elems, (gt(1)), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(102)) -- shunt/nodes/marshal/util/pseudo_random.yue:102
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:102
    end) -- shunt/nodes/marshal/util/pseudo_random.yue:84
    return describe('\\shuffle', function() -- shunt/nodes/marshal/util/pseudo_random.yue:104
      return it('retains all elements', function() -- shunt/nodes/marshal/util/pseudo_random.yue:105
        local elems = { -- shunt/nodes/marshal/util/pseudo_random.yue:106
          'a', -- shunt/nodes/marshal/util/pseudo_random.yue:106
          'b', -- shunt/nodes/marshal/util/pseudo_random.yue:106
          'c', -- shunt/nodes/marshal/util/pseudo_random.yue:106
          'd' -- shunt/nodes/marshal/util/pseudo_random.yue:106
        } -- shunt/nodes/marshal/util/pseudo_random.yue:106
        local elems2 -- shunt/nodes/marshal/util/pseudo_random.yue:107
        do -- shunt/nodes/marshal/util/pseudo_random.yue:107
          local _tab_0 = { } -- shunt/nodes/marshal/util/pseudo_random.yue:107
          local _idx_0 = 1 -- shunt/nodes/marshal/util/pseudo_random.yue:107
          for _key_0, _value_0 in pairs(elems) do -- shunt/nodes/marshal/util/pseudo_random.yue:107
            if _idx_0 == _key_0 then -- shunt/nodes/marshal/util/pseudo_random.yue:107
              _tab_0[#_tab_0 + 1] = _value_0 -- shunt/nodes/marshal/util/pseudo_random.yue:107
              _idx_0 = _idx_0 + 1 -- shunt/nodes/marshal/util/pseudo_random.yue:107
            else -- shunt/nodes/marshal/util/pseudo_random.yue:107
              _tab_0[_key_0] = _value_0 -- shunt/nodes/marshal/util/pseudo_random.yue:107
            end -- shunt/nodes/marshal/util/pseudo_random.yue:107
          end -- shunt/nodes/marshal/util/pseudo_random.yue:107
          elems2 = _tab_0 -- shunt/nodes/marshal/util/pseudo_random.yue:107
        end -- shunt/nodes/marshal/util/pseudo_random.yue:107
        PseudoRandom():shuffle(elems2) -- shunt/nodes/marshal/util/pseudo_random.yue:108
        for _index_0 = 1, #elems do -- shunt/nodes/marshal/util/pseudo_random.yue:109
          local elem = elems[_index_0] -- shunt/nodes/marshal/util/pseudo_random.yue:109
          require('shunt.spec')._expect_that([=[elems2]=], elems2, (contains_value(eq(elem))), tostring("shunt/nodes/marshal/util/pseudo_random.yue") .. ":" .. tostring(110)) -- shunt/nodes/marshal/util/pseudo_random.yue:110
        end -- shunt/nodes/marshal/util/pseudo_random.yue:110
      end) -- shunt/nodes/marshal/util/pseudo_random.yue:110
    end) -- shunt/nodes/marshal/util/pseudo_random.yue:110
  end) -- shunt/nodes/marshal/util/pseudo_random.yue:110
end) -- shunt/nodes/marshal/util/pseudo_random.yue:29
return _module_0 -- shunt/nodes/marshal/util/pseudo_random.yue:110
end
package.preload['shunt.nodes.marshal.resource_orchestrator.scheduler'] = function(...)
-- [yue]: shunt/nodes/marshal/resource_orchestrator/scheduler.yue
local _module_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1
local ScheduleGenerator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:2
local ScheduleGeneratorImpl -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:3
local Queue = require('shunt.data.queue').Queue -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local Firewall = require('shunt.firewall').Firewall -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local log, trace -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  log, trace = _obj_0.log, _obj_0.trace -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local PromiseTracker = require('shunt.nodes.marshal.resource_orchestrator.promise_tracker').PromiseTracker -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local PseudoRandom = require('shunt.nodes.marshal.util.pseudo_random').PseudoRandom -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local time_units = require('shunt.peripheral.station').time_units -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local declare_type, F, T -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local spec = require('shunt.spec').spec -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
local shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  local _obj_0 = require('shunt.state') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder = _obj_0.shallow_log_reporter, _obj_0.State, _obj_0.StateMachineBuilder, _obj_0.StateResponsesBuilder -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
declare_type('Scheduler', [[{
  events: Queue,
  schedule_generator: (string, Factory, [Factory]) => ScheduleGenerator,
  train_is_lost: (string) => boolean,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:15
declare_type('ScheduleCandidate', [[{
  train_addr: TrainAddress,
  inbound_station_addr: StationAddress,
  outbound_station_addr: StationAddress,
  schedule: Schedule,
  info: {
    inbound_factory_name: string,
    resource: string,
  },
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:20
declare_type('TrainAddress', [[  { name: string }
  + StationAddress
]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:30
declare_type('SchedulerEvent', [[{
  type: "network-packet",
  packet: Packet,
} | {
  type: "start-scheduling",
  schedule_generator: ScheduleGenerator,
} | {
  type: "declare-train-state",
  train_name: string,
  state: TrainState,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:34
declare_type('SchedulerOpts', [[{
  clock: Clock,
  rand: Random,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:45
local Scheduler -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  local _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  local _base_0 = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:97
      return (StateResponsesBuilder(sm)):add('waiting', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
        local _fn_0 = _base_1.on_waiting -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:99
      end)()):add('inspecting_packet', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
        local _fn_0 = _base_1.on_inspecting_packet -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:100
      end)()):add('analysing_factory_heartbeat', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
        local _fn_0 = _base_1.on_analysing_factory_heartbeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:101
      end)()):add('scheduling', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
        local _fn_0 = _base_1.on_scheduling -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:102
      end)()):add('enacting_train_state_declaration', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
        local _fn_0 = _base_1.on_enacting_train_state_declaration -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:103
      end)()):build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:104
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:106
    step = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:106
      return self.sm_responses[self.sm.state.name]() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:107
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:111
    on_waiting = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:111
      local event = self.events:dequeue() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:112
      if not (event ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:113
        return -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:114
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:113
      local _exp_0 = event.type -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:115
      if 'network-packet' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:116
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:117
        return _call_0["goto"](_call_0, 'inspecting_packet', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:118
          packet = event.packet -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:118
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:117
      elseif 'start-scheduling' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:119
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:120
        return _call_0["goto"](_call_0, 'scheduling', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:121
          schedule_generator = event.schedule_generator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:121
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:120
      elseif 'declare-train-state' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:122
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:123
        return _call_0["goto"](_call_0, 'enacting_train_state_declaration', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:124
          train_name = event.train_name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:124
          state = event.state -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:125
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:123
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:127
        return error("internal error: unrecognised event type '" .. tostring(event.type) .. "'") -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:127
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:127
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:129
    on_inspecting_packet = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:129
      local packet = self.sm.state.packet -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:130
      local _exp_0 = packet.protocol -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:131
      if 'FactoryHeartbeat' == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:132
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:133
        return _call_0["goto"](_call_0, 'analysing_factory_heartbeat', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:134
          packet = event.packet -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:134
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:133
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:136
        return error("internal error: unrecognised protocol '" .. tostring(event.type) .. "'") -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:136
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:136
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:138
    on_analysing_factory_heartbeat = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:138
      local stations = self.sm.state.packet.stations -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:139
      local lost_trains -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:143
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:143
        local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:143
        local _list_0 = stations.known -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:144
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:144
          local station = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:144
          local _list_1 = station.present_trains -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:145
          for _index_1 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:145
            local train = _list_1[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:145
            if self:train_is_lost(train) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:146
              _with_0[#_with_0 + 1] = train -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:147
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:146
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:147
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:147
        lost_trains = _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:143
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:143
      for _index_0 = 1, #lost_trains do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:148
        local lost_train = lost_trains[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:148
        log(function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:149
          return "train '" .. tostring(lost_train) .. "' was lost. It will be ignored until manually cleared for use" -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:149
        end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:149
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:149
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:150
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:150
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:152
    on_scheduling = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:152
      local schedule_generator = self.sm.state.schedule_generator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:153
      if schedule_generator.done then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:155
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:156
        return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:156
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:155
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:158
    on_enacting_train_state_declaration = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:158
      local train_name, state -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:159
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:159
        local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:159
        train_name, state = _obj_0.train_name, _obj_0.state -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:159
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:159
      local error_reason -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:160
      if 'cleared' == state then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:161
        error_reason = self.promise_tracker:declare_train_found(train_name) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:162
      elseif 'reserved' == state then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:163
        self.promise_tracker:reserve(train_name) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:164
        error_reason = nil -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:165
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:167
        error_reason = "internal error: unknown train state '" .. tostring(state) .. "'" -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:167
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:167
      if (error_reason ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:168
        log(function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:169
          return "cannot enact train state '" .. tostring(train_name) .. "'='" .. tostring(state) .. "': " .. tostring(error_reason) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:170
        end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:169
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:168
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:172
      return _call_0["goto"](_call_0, 'waiting') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:172
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:174
    schedule_generator = F('(string, Factory, [Factory]) => ScheduleGenerator', function(self, resource, factory, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:174
      local schedule_generator = ScheduleGenerator({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:176
        factories = factories, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:176
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:177
        parent_scheduler = self, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:178
        rand = self.rand, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:179
        resource = resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:180
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:175
      self.events:enqueue({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:182
        type = 'start-scheduling', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:182
        schedule_generator = schedule_generator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:183
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:181
      return schedule_generator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:184
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:186
    train_is_lost = F('(string) => boolean', function(self, train_name) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:186
      return self.promise_tracker:train_is_lost(train_name) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:187
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:189
    ut_break_all_promises = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:189
      return self.promise_tracker:ut_break_all_promises() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:190
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:192
    ut_promise = F('(string, [PromiseStation]) => Promise', function(self, train, stations) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:192
      return self.promise_tracker:promise(train, stations) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:193
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:195
    ut_break_promise = F('(Promise) => <>', function(self, promise) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:195
      return self.promise_tracker:break_promise(promise) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:196
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  if _base_0.__index == nil then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    _base_0.__index = _base_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:196
  _class_0 = setmetatable({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    __init = F('(SchedulerOpts) => <>', function(self, opts) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:50
      local clock, rand = opts.clock, opts.rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:51
      self.clock = clock -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:55
      self.rand = rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:56
      self.promise_tracker = PromiseTracker(self.rand, self.clock) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:57
      self.firewall = Firewall({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:60
        FactoryHeartbeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:60
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:59
      self.events = Queue('SchedulerEvent') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:61
      self.sm = self.__class:make_sm() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:62
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:63
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    __base = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    __name = "Scheduler" -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  }, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    __index = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    __call = function(cls, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
      return _self_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
    end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  _base_0.__class = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  local self = _class_0; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
  self.make_sm = F('() => StateMachine', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:65
    return (StateMachineBuilder('scheduler')):set_initial_state('waiting'):declare_endless():set_reporter(shallow_log_reporter):add((State('waiting')):add_transition_to('inspecting_packet'):add_transition_to('scheduling'):add_transition_to('enacting_train_state_declaration')):add((State('inspecting_packet')):set_data_type([[{
          packet: Packet,
        }]]):add_transition_to('analysing_factory_heartbeat')):add((State('analysing_factory_heartbeat')):set_data_type([[{
          packet: FactoryHeartbeat,
        }]]):add_transition_to('waiting')):add((State('scheduling')):set_data_type([[{
          schedule_generator: ScheduleGenerator,
        }]]):add_transition_to('waiting')):add((State('enacting_train_state_declaration')):set_data_type([[{
          train_name: string,
          state: TrainState,
        }]]):add_transition_to('waiting')):build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:95
  end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:65
  self.DEFAULT_RESEND_COOLDOWN_SECONDS = 90 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:109
  Scheduler = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:196
_module_0["Scheduler"] = Scheduler -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:49
declare_type('ScheduleGenerator', [[{
  try_generate_schedule: () => <?ScheduleCandidate, boolean>,
  end_generation: () => <>,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:198
declare_type('ScheduleGeneratorOpts', [[{
  factories: [Factory],
  factory: Factory,
  parent_scheduler: Scheduler,
  rand: Random,
  resource: string,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:202
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  local _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  local _base_0 = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:251
      return (StateResponsesBuilder(sm)):add('generating_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
        local _fn_0 = _base_1.on_generating_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:253
      end)()):add('proposing_schedule', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
        local _fn_0 = _base_1.on_proposing_schedule -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:254
      end)()):add('out_of_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
        local _fn_0 = _base_1.on_out_of_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:255
      end)()):build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:256
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:258
    try_generate_schedule = F('() => <?ScheduleCandidate, boolean>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:258
      self:step() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:259
      local states = self.sm.states -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:260
      local _exp_0 = self.sm.state.name -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:261
      if states.generating_schedules == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:262
        return nil, true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:263
      elseif states.proposing_schedule == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:264
        return self.sm.state.schedule, true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:265
      elseif states.out_of_schedules == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:266
        self:end_generation() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:267
        return nil, false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:268
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:270
        return error("internal error: unexpected state '" .. tostring(self.sm.state.name) .. "'") -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:270
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:270
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:272
    step = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:272
      if self.parent_scheduler.sm.state.name ~= 'scheduling' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:273
        return -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:274
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:273
      return self.sm_responses[self.sm.state.name]() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:275
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:277
    end_generation = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:277
      if self.done then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:278
        return -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:279
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:278
      self.done = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:280
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:281
      return _call_0["end"](_call_0) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:281
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:283
    on_generating_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:283
      self.inner:step() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:284
      local states = self.inner.sm.states -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:285
      local _exp_0 = self.inner.sm.state.name -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:286
      if states.generating_inbound_local_schedules == _exp_0 or states.generating_outbound_local_schedules == _exp_0 or states.generating_global_schedules == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:287
        if self.sm.state.name ~= 'generating_schedules' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:288
          local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:289
          return _call_0["goto"](_call_0, 'generating_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:289
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:288
      elseif states.proposing_inbound_local_schedules == _exp_0 or states.proposing_outbound_local_schedules == _exp_0 or states.proposing_global_schedules == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:290
        if self.sm.state.name == self.sm.states.proposing_schedule then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:291
          local inbound_factory_name, resource, promise -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:292
          do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:292
            local _obj_0 = self.sm.state -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:298
            inbound_factory_name, resource, promise = _obj_0.schedule.info.inbound_factory_name, _obj_0.schedule.info.resource, _obj_0.promise -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:292
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:298
          self.parent_scheduler.promise_tracker:break_promise(promise) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:299
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:291
        local schedules = self.inner.sm.state.schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:301
        do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:302
          local _with_0 = Queue('ScheduleCandidate') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:302
          for _index_0 = 1, #schedules do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:303
            local schedule = schedules[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:303
            _with_0:enqueue(schedule) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:304
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:304
          schedules = _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:302
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:302
        do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:305
          local schedule = schedules:dequeue() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:305
          if schedule then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:305
            local train_name, inbound_station_addr, outbound_station_addr, inbound_factory_name, resource = schedule.train_addr.name, schedule.inbound_station_addr, schedule.outbound_station_addr, schedule.info.inbound_factory_name, schedule.info.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:306
            local promise = self.parent_scheduler.promise_tracker:promise(train_name, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:316
              inbound_station_addr.station, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:316
              outbound_station_addr.station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:317
            }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:315
            local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:318
            return _call_0["goto"](_call_0, 'proposing_schedule', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:319
              schedule = schedule, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:319
              schedules = schedules, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:320
              promise = promise -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:321
            }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:318
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:305
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:305
      elseif states.out_of_schedules == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:322
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:323
        return _call_0["goto"](_call_0, 'out_of_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:323
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:325
        return error("internal error: unexpected inner state '" .. tostring(self.inner.sm.state.name) .. "'") -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:325
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:325
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:327
    on_proposing_schedule = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:327
      local schedules = self.sm.state.schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:328
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:329
        local schedule = schedules:dequeue() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:329
        if schedule then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:329
          local train_name, inbound_station_addr, outbound_station_addr, inbound_factory_name, resource = schedule.train_addr.name, schedule.inbound_station_addr, schedule.outbound_station_addr, schedule.info.inbound_factory_name, schedule.info.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:330
          local promise = self.parent_scheduler.promise_tracker:promise(train_name, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:340
            inbound_station_addr.station, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:340
            outbound_station_addr.station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:341
          }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:339
          local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:342
          return _call_0["goto"](_call_0, 'proposing_schedule', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:343
            schedule = schedule, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:343
            schedules = schedules, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:344
            promise = promise -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:345
          }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:342
        else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:347
          local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:347
          return _call_0["goto"](_call_0, 'generating_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:347
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:329
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:329
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:349
    on_out_of_schedules = F('() => <>', function(self) end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  if _base_0.__index == nil then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    _base_0.__index = _base_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:349
  _class_0 = setmetatable({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    __init = F('(ScheduleGeneratorOpts) => <>', function(self, opts) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:210
      local factories, factory, parent_scheduler, rand, resource = opts.factories, opts.factory, opts.parent_scheduler, opts.rand, opts.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:211
      self.parent_scheduler = parent_scheduler -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:218
      self.inner = ScheduleGeneratorImpl({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:220
        factories = factories, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:220
        factory = factory, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:221
        promise_tracker = parent_scheduler.promise_tracker, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:222
        rand = rand, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:223
        resource = resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:224
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:219
      self.done = T('boolean', false) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:226
      self.sm = self.__class:make_sm() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:228
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:229
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    __base = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    __name = "ScheduleGenerator" -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  }, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    __index = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    __call = function(cls, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
      return _self_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
    end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  _base_0.__class = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  local self = _class_0; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
  self.make_sm = F('() => StateMachine', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:231
    if self.sm_builder == nil then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:232
      self.sm_builder = (StateMachineBuilder('schedule_generator')):set_initial_state('generating_schedules'):set_reporter(shallow_log_reporter):add((State('generating_schedules')):add_transition_to('proposing_schedule'):add_transition_to('out_of_schedules')):add((State('proposing_schedule')):set_data_type([[{
          schedule: ScheduleCandidate,
          schedules: Queue,
          promise: Promise,
        }]]):add_transition_to('generating_schedules'):add_transition_to('proposing_schedule'):declare_end_state()):add((State('out_of_schedules')):declare_end_state()) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:232
    end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:248
    return self.sm_builder:build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:249
  end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:231
  ScheduleGenerator = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:349
_module_0["ScheduleGenerator"] = ScheduleGenerator -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:209
declare_type('ScheduleGeneratorImplOpts', [[{
  factories: [Factory],
  factory: Factory,
  promise_tracker: PromiseTracker,
  rand: Random,
  resource: string,
}]]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:351
do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  local _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  local _base_0 = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    _inbound_station_addrs = F('(string, Factory) => [StationAddress]', function(self, resource, factory) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:390
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:391
      local _list_0 = factory.stations.known -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:392
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:392
        local station = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:392
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:393
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:393
          if station.type ~= 'inbound' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:393
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:394
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:394
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:393
          if station.handles ~= resource then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:395
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:396
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:396
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:395
          if self.promise_tracker:station_is_fully_promised(station) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:397
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:398
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:398
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:397
          _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
            factory = factory, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
            station = station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:393
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:399
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:391
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:401
    _outbound_station_addrs = F('(string, [string], [Factory]) => <[StationAddress], {string->[StationAddress]}>', function(self, resource, networks, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:401
      local addrs = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:402
      local addrs_by_network = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:403
      for _index_0 = 1, #networks do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:404
        local network = networks[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:404
        addrs = self:_outbound_station_addrs_on_network(resource, network, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:405
        addrs_by_network[network] = addrs -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:406
        for _index_1 = 1, #addrs do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:407
          local addr = addrs[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:407
          addrs[#addrs + 1] = addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:408
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:408
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:408
      return addrs, addrs_by_network -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:409
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:411
    _outbound_station_addrs_on_network = F('(string, string, [Factory]) => [StationAddress]', function(self, resource, network, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:411
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:412
      for _index_0 = 1, #factories do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:413
        local factory = factories[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:413
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:414
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:414
          if not self:_factory_has_surplus_resource(resource, factory) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:414
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:415
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:415
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:414
          local _list_0 = factory.stations.known -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:417
          for _index_1 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:417
            local station = _list_0[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:417
            local _continue_1 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:418
            repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:418
              if station.handles ~= resource then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:418
                _continue_1 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:419
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:419
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:418
              if station.type ~= 'outbound' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:420
                _continue_1 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:421
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:421
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:420
              if station.network ~= network then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:422
                _continue_1 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:423
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:423
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:422
              if self.promise_tracker:station_is_fully_promised(station) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:424
                _continue_1 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:425
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:425
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:424
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
                factory = factory, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
                station = station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
              _continue_1 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:418
            until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
            if not _continue_1 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:414
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:426
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:412
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:428
    _factory_has_surplus_resource = F('(string, Factory) => boolean', function(self, resource, factory) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:428
      local _list_0 = factory.stockpile.known -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:429
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:429
        local detected_resource = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:429
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:430
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:430
          if detected_resource.name ~= resource then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:430
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:431
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:431
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:430
          if not (detected_resource.surplus_amount ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:432
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:433
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:433
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:432
          if detected_resource.stored < detected_resource.surplus_amount then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:434
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:435
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:435
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:434
          do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
            return true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:430
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:436
      return false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:437
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:439
    _free_station_addrs_by_network = F('([StationAddress]) => {string->[StationAddress]}', function(self, addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:439
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:440
      for _index_0 = 1, #addrs do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:441
        local addr = addrs[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:441
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:442
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:442
          local station = addr.station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:442
          if #station.present_trains >= station.capacity then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:443
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:444
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:444
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:443
          local network = station.network -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:446
          if not (_with_0[network] ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:447
            _with_0[network] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:448
              addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:448
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:448
          else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
            do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
              local _obj_0 = _with_0[network] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
              _obj_0[#_obj_0 + 1] = addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:447
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:442
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:450
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:440
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:487
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:487
      return (StateResponsesBuilder(sm)):add('generating_inbound_local_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
        local _fn_0 = _base_1.on_generating_inbound_local_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:489
      end)()):add('proposing_inbound_local_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
        local _fn_0 = _base_1.on_proposing_inbound_local_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:490
      end)()):add('generating_outbound_local_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
        local _fn_0 = _base_1.on_generating_outbound_local_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:491
      end)()):add('proposing_outbound_local_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
        local _fn_0 = _base_1.on_proposing_outbound_local_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:492
      end)()):add('generating_global_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
        local _fn_0 = _base_1.on_generating_global_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:493
      end)()):add('proposing_global_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
        local _fn_0 = _base_1.on_proposing_global_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:494
      end)()):add('out_of_schedules', (function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
        local _base_1 = self -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
        local _fn_0 = _base_1.on_out_of_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
        return _fn_0 and function(...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
          return _fn_0(_base_1, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:495
      end)()):build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:496
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:498
    step = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:498
      return self.sm_responses[self.sm.state.name]() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:499
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:501
    on_generating_inbound_local_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:501
      local schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:502
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:502
        local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:502
        local _list_0 = self.inbound_station_addrs -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:503
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:503
          local inbound_station_addr = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:503
          local station = inbound_station_addr.station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:504
          local _list_1 = station.present_trains -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:505
          for _index_1 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:505
            local train_name = _list_1[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:505
            local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:506
            repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:506
              if self.promise_tracker:train_is_promised(train_name) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:506
                _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:507
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:507
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:506
              local outbound_station_addr = self.rand:pick(self.outbound_station_addrs_by_network[station.network]) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:509
              if not (outbound_station_addr ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:510
                _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:511
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:511
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:510
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:514
                train_addr = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:515
                  name = train_name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:515
                  station = station, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:516
                  factory = self.factory -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:517
                }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:514
                inbound_station_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:518
                outbound_station_addr = outbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:519
                schedule = self:_train_schedule({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:521
                  inbound_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:521
                  outbound_addr = outbound_station_addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:522
                }), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:520
                info = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:524
                  inbound_factory_name = inbound_station_addr.factory.name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:524
                  resource = self.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
                } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:523
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:513
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:506
            until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
            if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:525
        schedules = _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:502
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:502
      schedules = self:make_schedules_unique(schedules) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:526
      if #schedules > 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:527
        self.rand:shuffle(schedules) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:528
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:529
        return _call_0["goto"](_call_0, 'proposing_inbound_local_schedules', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:530
          schedules = schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:530
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:529
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:532
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:532
        return _call_0["goto"](_call_0, 'generating_outbound_local_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:532
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:527
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:534
    on_proposing_inbound_local_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:534
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:535
      return _call_0["goto"](_call_0, 'generating_outbound_local_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:535
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:537
    on_generating_outbound_local_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:537
      local schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:538
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:538
        local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:538
        local _list_0 = self.outbound_station_addrs -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:539
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:539
          local outbound_station_addr = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:539
          local factory, station = outbound_station_addr.factory, outbound_station_addr.station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:540
          local _list_1 = outbound_station_addr.station.present_trains -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:542
          for _index_1 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:542
            local train_name = _list_1[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:542
            local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:543
            repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:543
              if self.promise_tracker:train_is_promised(train_name) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:543
                _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:544
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:544
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:543
              local inbound_station_addrs = self.free_inbound_station_addrs_by_network[outbound_station_addr.station.network] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:546
              if not (inbound_station_addrs ~= nil) or #inbound_station_addrs == 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:547
                _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:548
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:548
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:547
              local inbound_station_addr = self.rand:pick(inbound_station_addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:549
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:552
                train_addr = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:553
                  name = train_name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:553
                  station = station, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:554
                  factory = factory -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:555
                }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:552
                inbound_station_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:556
                outbound_station_addr = outbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:557
                schedule = self:_train_schedule({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:559
                  inbound_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:559
                  outbound_addr = outbound_station_addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:560
                }), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:558
                info = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:562
                  inbound_factory_name = inbound_station_addr.factory.name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:562
                  resource = self.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
                } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:561
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:551
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:543
            until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
            if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:563
        schedules = _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:538
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:538
      schedules = self:make_schedules_unique(schedules) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:564
      if #schedules > 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:565
        self.rand:shuffle(schedules) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:566
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:567
        return _call_0["goto"](_call_0, 'proposing_outbound_local_schedules', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:568
          schedules = schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:568
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:567
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:570
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:570
        return _call_0["goto"](_call_0, 'generating_global_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:570
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:565
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:572
    on_proposing_outbound_local_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:572
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:573
      return _call_0["goto"](_call_0, 'generating_global_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:573
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:575
    on_generating_global_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:575
      local train_addrs = self:_train_addrs() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:576
      local schedules = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:578
      for _ = 1, 25 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:579
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:580
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:580
          local train_addr = self.rand:pick(train_addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:580
          if not (train_addr ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:581
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:582
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:581
          local network = train_addr.station.network -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:584
          local inbound_station_addrs = self.free_inbound_station_addrs_by_network[network] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:586
          if not (inbound_station_addrs ~= nil) or #inbound_station_addrs == 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:587
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:588
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:588
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:587
          local inbound_station_addr = self.rand:pick(inbound_station_addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:589
          local outbound_station_addrs = self.outbound_station_addrs_by_network[network] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:591
          if not (outbound_station_addrs ~= nil) or #outbound_station_addrs == 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:592
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:593
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:593
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:592
          local outbound_station_addr = self.rand:pick(outbound_station_addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:594
          local schedule = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:597
            train_addr = train_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:597
            inbound_station_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:598
            outbound_station_addr = outbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:599
            schedule = self:_train_schedule({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:601
              inbound_addr = inbound_station_addr, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:601
              outbound_addr = outbound_station_addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:602
            }), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:600
            info = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:604
              inbound_factory_name = inbound_station_addr.factory.name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:604
              resource = self.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:605
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:603
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:596
          if not self:_already_proposed(schedule) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:606
            schedules[#schedules + 1] = schedule -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:607
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:606
          do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
            local _obj_0 = self.already_proposed_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
            _obj_0[#_obj_0 + 1] = schedule -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:580
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:608
      if #schedules > 0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:609
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:610
        return _call_0["goto"](_call_0, 'proposing_global_schedules', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:611
          schedules = schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:611
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:610
      else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:613
        local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:613
        return _call_0["goto"](_call_0, 'out_of_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:613
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:609
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:615
    _train_addrs = F('() => [TrainAddress]', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:615
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:616
      local _list_0 = self.factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:617
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:617
        local factory = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:617
        local _list_1 = factory.stations.known -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:618
        for _index_1 = 1, #_list_1 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:618
          local station = _list_1[_index_1] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:618
          local _list_2 = station.present_trains -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:619
          for _index_2 = 1, #_list_2 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:619
            local name = _list_2[_index_2] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:619
            local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:620
            repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:620
              if self.promise_tracker:train_is_promised(name) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:620
                _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:621
                break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:621
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:620
              _with_0[#_with_0 + 1] = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:623
                factory = factory, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:623
                station = station, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:624
                name = name -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:622
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:620
            until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
            if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:625
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:616
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:627
    _train_schedule = F('({outbound_addr: StationAddress, inbound_addr: StationAddress}) => Schedule', function(self, conf) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:627
      local outbound_addr, inbound_addr = conf.outbound_addr, conf.inbound_addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:628
      return { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:630
        cyclic = false, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:630
        entries = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:633
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:633
            instruction = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:634
              id = 'create:destination', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:634
              data = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:636
                text = outbound_addr.station.name -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:636
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:635
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:633
            conditions = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:638
              { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:638
                self.__class.MIN_WAIT_REACHED, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:638
                self.__class.CARGO_INACTIVE -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:638
              }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:638
              { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:639
                self.__class.MAX_WAIT_REACHED -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:639
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:639
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:637
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:633
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:640
            instruction = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:641
              id = 'create:destination', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:641
              data = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:643
                text = inbound_addr.station.name -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:643
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:642
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:640
            conditions = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:645
              { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:645
                self.__class.MAX_WAIT_REACHED -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:645
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:645
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:644
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:640
        } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:631
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:646
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:664
    on_proposing_global_schedules = F('() => <>', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:664
      local _call_0 = self.sm -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:665
      return _call_0["goto"](_call_0, 'out_of_schedules') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:665
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:667
    make_schedules_unique = F('([ScheduleCandidate]) => [ScheduleCandidate]', function(self, schedules) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:667
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:668
      for _index_0 = 1, #schedules do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:669
        local schedule = schedules[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:669
        if not self:_already_proposed(schedule) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:670
          _with_0[#_with_0 + 1] = schedule -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:671
          do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:672
            local _obj_0 = self.already_proposed_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:672
            _obj_0[#_obj_0 + 1] = schedule -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:672
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:672
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:670
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:672
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:668
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:674
    _already_proposed = F('(ScheduleCandidate) => boolean', function(self, candidate) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:674
      local inbound_station_addr, outbound_station_addr, train_addr = candidate.inbound_station_addr, candidate.outbound_station_addr, candidate.train_addr -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:675
      local _list_0 = self.already_proposed_schedules -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:680
      for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:680
        local prior = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:680
        local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:681
        repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:681
          if prior.inbound_station_addr.station.name ~= inbound_station_addr.station.name then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:681
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:682
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:682
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:681
          if prior.outbound_station_addr.station.name ~= outbound_station_addr.station.name then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:683
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:684
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:684
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:683
          if prior.train_addr.name ~= train_addr.name then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:685
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:686
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:686
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:685
          do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
            return true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
          _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:681
        until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
        if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:687
      return false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:688
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:690
    on_out_of_schedules = F('() => <>', function(self) end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  if _base_0.__index == nil then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    _base_0.__index = _base_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:690
  _class_0 = setmetatable({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    __init = F('(ScheduleGeneratorImplOpts) => <>', function(self, opts) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:359
      local factories, factory, promise_tracker, rand, resource = opts.factories, opts.factory, opts.promise_tracker, opts.rand, opts.resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:360
      self.factories = factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:367
      self.factory = factory -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:368
      self.promise_tracker = promise_tracker -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:369
      self.resource = resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:370
      self.rand = rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:371
      self.already_proposed_schedules = T('[ScheduleCandidate]', { }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:373
      self.sm = self.__class:make_sm() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:375
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:376
      self.inbound_station_addrs = self:_inbound_station_addrs(resource, factory) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:378
      local networks -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:379
      do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:379
        local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:379
        local seen_networks = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:380
        local _list_0 = self.inbound_station_addrs -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:381
        for _index_0 = 1, #_list_0 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:381
          local inbound_station_addr = _list_0[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:381
          local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:382
          repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:382
            local network = inbound_station_addr.station.network -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:382
            if seen_networks[network] then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:383
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:384
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:384
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:383
            seen_networks[network] = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:385
            _with_0[#_with_0 + 1] = network -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:382
          until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
          if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:386
        networks = _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:379
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:379
      self.free_inbound_station_addrs_by_network = self:_free_station_addrs_by_network(self.inbound_station_addrs) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:387
      self.outbound_station_addrs, self.outbound_station_addrs_by_network = self:_outbound_station_addrs(resource, networks, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:388
    end), -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    __base = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    __name = "ScheduleGeneratorImpl" -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  }, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    __index = _base_0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    __call = function(cls, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
      cls.__init(_self_0, ...) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
      return _self_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
    end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  _base_0.__class = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  local self = _class_0; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
  self.make_sm = F('() => StateMachine', function(self) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:452
    return (StateMachineBuilder('schedule_generator_impl')):set_initial_state('generating_inbound_local_schedules'):set_reporter(shallow_log_reporter):add((State('generating_inbound_local_schedules')):add_transition_to('proposing_inbound_local_schedules'):add_transition_to('generating_outbound_local_schedules')):add((State('proposing_inbound_local_schedules')):set_data_type([[{
          schedules: [ScheduleCandidate],
        }]]):add_transition_to('generating_outbound_local_schedules'):declare_end_state()):add((State('generating_outbound_local_schedules')):add_transition_to('proposing_outbound_local_schedules'):add_transition_to('generating_global_schedules')):add((State('proposing_outbound_local_schedules')):set_data_type([[{
          schedules: [ScheduleCandidate],
        }]]):add_transition_to('generating_global_schedules'):declare_end_state()):add((State('generating_global_schedules')):add_transition_to('proposing_global_schedules'):add_transition_to('out_of_schedules')):add((State('proposing_global_schedules')):set_data_type([[{
          schedules: [ScheduleCandidate],
        }]]):add_transition_to('out_of_schedules'):declare_end_state()):add((State('out_of_schedules')):declare_end_state()):build() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:485
  end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:452
  self.CARGO_INACTIVE = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:649
    id = "create:idle", -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:649
    data = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:651
      value = 5, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:651
      time_unit = time_units.SECONDS -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:652
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:650
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:648
  self.MIN_WAIT_REACHED = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:654
    id = "create:delay", -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:654
    data = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:656
      value = 15, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:656
      time_unit = time_units.SECONDS -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:657
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:655
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:653
  self.MAX_WAIT_REACHED = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:659
    id = "create:delay", -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:659
    data = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:661
      value = 30, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:661
      time_unit = time_units.SECONDS -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:662
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:660
  } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:658
  ScheduleGeneratorImpl = _class_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:690
_module_0["ScheduleGeneratorImpl"] = ScheduleGeneratorImpl -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:358
spec(function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:692
  local TestClock = require('shunt.clock').TestClock -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  local describe, it, matchers -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:0
  local deep_eq, eq, ge, gt, has_fields, le, len, lt, matches, not_ = matchers.deep_eq, matchers.eq, matchers.ge, matchers.gt, matchers.has_fields, matchers.le, matchers.len, matchers.lt, matchers.matches, matchers.not_ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:698
  return describe('Scheduler', function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:700
    local resource = 'minecraft:stone_bricks' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:701
    local network = 'mainline' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:702
    local inbound_station_name_1 = 'inbound_station-1' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:703
    local inbound_station_name_2 = 'inbound_station-2' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:704
    local factory_with_shortage_of_resource = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:706
      name = 'factory_with_shortage', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:706
      pc_id = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:707
      operational = true, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:708
      last_seen_epoch = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:709
      stations = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:711
        known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:712
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:712
            name = inbound_station_name_1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:712
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:713
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:714
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:715
            capacity = 3, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:716
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:718
              'valid_inbound_local_train_1', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:718
              'valid_inbound_local_train_2' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:719
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:717
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:712
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:720
            name = inbound_station_name_2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:720
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:721
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:722
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:723
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:724
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:726
              'valid_inbound_local_train_3', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:726
              'valid_inbound_local_train_4' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:727
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:725
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:720
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:728
            name = 'wrong_type_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:728
            type = 'outbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:729
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:730
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:731
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:732
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:734
              'wrong_type_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:734
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:733
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:728
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:735
            name = 'wrong_resource_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:735
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:736
            handles = 'minecraft:diamond_axe', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:737
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:738
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:739
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:741
              'wrong_resource_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:741
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:740
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:735
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:742
            name = 'wrong_network_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:742
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:743
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:744
            network = 'wrong_shortage_network', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:745
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:746
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:748
              'wrong_network_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:748
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:747
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:742
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:749
            name = 'no_trains_inbound_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:749
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:750
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:751
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:752
            capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:753
            present_trains = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:754
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:749
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:711
        unknown = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:756
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:756
            name = 'unknown_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:756
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:757
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:759
              'unknown_station_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:759
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:758
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:756
        } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:755
      }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:710
      stockpile = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:761
        known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:762
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:762
            name = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:762
            stored = 64, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:763
            shortage_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:764
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:762
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:765
            name = 'minecraft:iron_ingot', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:765
            stored = 256, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:766
            shortage_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:767
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:765
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:768
            name = 'minecraft:gold_ingot', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:768
            stored = 64, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:769
            surplus_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:770
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:768
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:771
            name = 'minecraft:diamond', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:771
            stored = 256, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:772
            surplus_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:773
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:771
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:761
        unknown = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:775
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:775
            name = 'minecraft:dirt', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:775
            stored = 64 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:776
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:775
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:774
        estimated_capacity = 64 * 9 * 3 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:777
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:760
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:705
    local outbound_station_name = 'outbound_station' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:779
    local factory_with_surplus_of_resource = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:781
      name = 'factory_with_surplus', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:781
      pc_id = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:782
      operational = true, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:783
      last_seen_epoch = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:784
      stations = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:786
        known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:787
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:787
            name = outbound_station_name, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:787
            type = 'outbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:788
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:789
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:790
            capacity = 3, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:791
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:793
              'valid_outbound_local_train_1', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:793
              'valid_outbound_local_train_2' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:794
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:792
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:787
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:795
            name = 'wrong_type_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:795
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:796
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:797
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:798
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:799
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:801
              'wrong_type_surplus_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:801
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:800
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:795
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:802
            name = 'wrong_resource_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:802
            type = 'outbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:803
            handles = 'minecraft:diamond_axe', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:804
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:805
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:806
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:808
              'wrong_resource_surplus_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:808
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:807
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:802
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:809
            name = 'wrong_network_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:809
            type = 'outbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:810
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:811
            network = 'wrong_surplus_network', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:812
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:813
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:815
              'wrong_network_surplus_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:815
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:814
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:809
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:816
            name = 'no_trains_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:816
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:817
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:818
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:819
            capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:820
            present_trains = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:821
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:816
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:822
            name = 'full_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:822
            type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:823
            handles = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:824
            network = network, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:825
            capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:826
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:828
              'full_surplus_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:828
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:827
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:822
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:786
        unknown = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:830
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:830
            name = 'unknown_surplus_station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:830
            capacity = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:831
            present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:833
              'unknown_station_surplus_train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:833
            } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:832
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:830
        } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:829
      }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:785
      stockpile = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:835
        known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:836
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:836
            name = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:836
            stored = 2048, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:837
            surplus_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:838
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:836
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:839
            name = 'minecraft:iron_ingot', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:839
            stored = 256, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:840
            shortage_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:841
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:839
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:842
            name = 'minecraft:gold_ingot', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:842
            stored = 64, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:843
            surplus_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:844
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:842
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:845
            name = 'minecraft:diamond', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:845
            stored = 256, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:846
            surplus_amount = 128 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:847
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:845
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:835
        unknown = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:849
          { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:849
            name = 'minecraft:dirt', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:849
            stored = 64 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:850
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:849
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:848
        estimated_capacity = 64 * 9 * 3 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:851
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:834
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:780
    local factories = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:853
      factory_with_shortage_of_resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:853
      factory_with_surplus_of_resource -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:854
    } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:852
    local candidate_repr = F('(ScheduleCandidate) -> string', function(candidate) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:856
      return tostring(candidate.train_addr.name) .. ":" .. tostring(candidate.outbound_station_addr.station.name) .. "->" .. tostring(candidate.inbound_station_addr.station.name) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:857
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:856
    local gather_candidates = F('({scheduler: Scheduler, resource: string, factory: Factory, factories: [Factory]}) -> [ScheduleCandidate]', function(opts) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:859
      local scheduler, factory -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:860
      scheduler, resource, factory, factories = opts.scheduler, opts.resource, opts.factory, opts.factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:860
      local _with_0 = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:866
      local schedule_generator = scheduler:schedule_generator(resource, factory, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:867
      for _ = 1, 10 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:871
        if scheduler.sm.state.name == 'scheduling' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:872
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:873
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:872
        scheduler:step() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:874
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:874
      require('shunt.spec')._assert_that([=[scheduler.sm.state.name]=], scheduler.sm.state.name, (eq('scheduling')), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(875)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:875
      local generation_ended = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:877
      for i = 1, 100 do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:878
        local candidate, can_continue = schedule_generator:try_generate_schedule() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:879
        _with_0[#_with_0 + 1] = candidate -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:880
        if not can_continue then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:881
          generation_ended = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:882
          break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:883
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:881
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:883
      require('shunt.spec')._assert_that([=[generation_ended]=], generation_ended, (eq(true)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(884)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:884
      return _with_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:866
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:859
    it('emits valid schedules', function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:886
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:887
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:888
      local scheduler = Scheduler({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:889
        clock = clock, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:889
        rand = rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:889
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:889
      local schedule_generator = scheduler:schedule_generator(resource, factory_with_shortage_of_resource, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:890
      local candidates = gather_candidates({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:893
        scheduler = scheduler, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:893
        resource = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:894
        factory = factory_with_shortage_of_resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:895
        factories = factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:896
      }); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:892
      require('shunt.spec')._assert_that([=[candidates]=], candidates, (len(gt(0))), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(897)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:897
      for _index_0 = 1, #candidates do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:899
        local candidate = candidates[_index_0] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:899
        require('shunt.spec')._expect_that([=[candidate.schedule.cyclic]=], candidate.schedule.cyclic, (eq(false)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(900)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:900
        local goto_inbound_instruction_index -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:902
        local goto_outbound_instruction_index -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:903
        for i = 1, #candidate.schedule.entries do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:905
          local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:906
          repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:906
            local entry = candidate.schedule.entries[i] -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:906
            if entry.instruction.id ~= 'create:destination' then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:908
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:909
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:909
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:908
            local station_name = entry.instruction.data.text -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:911
            if station_name:match('inbound') then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:912
              if (goto_inbound_instruction_index ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:913
                error('schedule heads to inbound multiple times') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:914
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:913
              goto_inbound_instruction_index = i -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:915
            else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:916
              if station_name:match('outbound') then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:916
                if (goto_outbound_instruction_index ~= nil) then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:917
                  error('schedule heads to outbound multiple times') -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:918
                end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:917
                goto_outbound_instruction_index = i -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:919
              else -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:921
                error("unexpected station: " .. tostring(station_name)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:921
              end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:916
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:912
            require('shunt.spec')._expect_that([=[#entry.conditions]=], #entry.conditions, (gt(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(923)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:906
          until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
          if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:923
        require('shunt.spec')._expect_that([=[goto_outbound_instruction_index]=], goto_outbound_instruction_index, (not_(eq(nil))), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(925)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:925
        require('shunt.spec')._expect_that([=[goto_inbound_instruction_index]=], goto_inbound_instruction_index, (not_(eq(nil))), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(926)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:926
        require('shunt.spec')._expect_that([=[goto_outbound_instruction_index]=], goto_outbound_instruction_index, (lt(goto_inbound_instruction_index)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(927)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:927
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:927
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:886
    it('emits unique schedules', function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:929
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:930
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:931
      local scheduler = Scheduler({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:932
        clock = clock, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:932
        rand = rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:932
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:932
      local schedule_generator = scheduler:schedule_generator(resource, factory_with_shortage_of_resource, factories) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:933
      local candidates = gather_candidates({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:936
        scheduler = scheduler, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:936
        resource = resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:937
        factory = factory_with_shortage_of_resource, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:938
        factories = factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:939
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:935
      for i = 1, #candidates do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:940
        for j = 1, #candidates do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:941
          local _continue_0 = false -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:942
          repeat -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:942
            if i == j then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:942
              _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:943
              break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:943
            end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:942
            require('shunt.spec')._assert_that([=[candidates[i]]=], candidates[i], (not_(deep_eq(candidates[j]))), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(944)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
            _continue_0 = true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:942
          until true -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
          if not _continue_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
            break -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:944
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:929
    it('respects promised trains', function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:946
      local rand = PseudoRandom(12345) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:947
      local clock = TestClock() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:948
      local RESOURCE = 'minecraft:stone_pickaxe' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:950
      local NETWORK = 'mainline' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:951
      local inbound_station = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:953
        name = 'inbound-station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:953
        type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:954
        handles = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:955
        network = NETWORK, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:956
        capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:957
        present_trains = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:958
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:952
      local outbound_station = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:960
        name = 'outbound-station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:960
        type = 'outbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:961
        handles = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:962
        network = NETWORK, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:963
        capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:964
        present_trains = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:965
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:959
      local unrelated_station = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:967
        name = 'unrelated-station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:967
        type = 'inbound', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:968
        handles = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:969
        network = NETWORK, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:970
        capacity = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:971
        present_trains = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:972
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:966
      factories = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:974
        { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:974
          name = 'factory-with-shortage', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:974
          pc_id = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:975
          operational = true, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:976
          last_seen_epoch = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:977
          stations = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:979
            known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:980
              inbound_station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:980
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:979
            unknown = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:981
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:978
          stockpile = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:983
            known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:984
              { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:984
                name = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:984
                stored = 0, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:985
                shortage_amount = 10 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:986
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:984
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:983
            unknown = { }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:987
            estimated_capacity = 12345 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:988
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:982
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:974
        { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:989
          name = 'factory-with-surplus', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:989
          pc_id = 2, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:990
          operational = true, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:991
          last_seen_epoch = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:992
          stations = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:994
            known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:995
              outbound_station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:995
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:994
            unknown = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:996
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:993
          stockpile = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:998
            known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:999
              { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:999
                name = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:999
                stored = 100, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1000
                surplus_amount = 10 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1001
              } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:999
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:998
            unknown = { }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1002
            estimated_capacity = 12345 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1003
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:997
        }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:989
        { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1004
          name = 'siding', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1004
          pc_id = 3, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1005
          operational = true, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1006
          last_seen_epoch = 1, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1007
          stations = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1009
            known = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1010
              unrelated_station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1010
            }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1009
            unknown = { } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1011
          }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1008
          stockpile = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1013
            known = { }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1013
            unknown = { }, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1014
            estimated_capacity = 0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1015
          } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1012
        } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1004
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:973
      local scheduler = Scheduler({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1017
        clock = clock, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1017
        rand = rand -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1017
      }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1017
      local get_candidates -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1018
      get_candidates = function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1018
        local ret = gather_candidates({ -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1020
          scheduler = scheduler, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1020
          resource = RESOURCE, -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1021
          factory = factories[1], -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1022
          factories = factories -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1023
        }) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1019
        scheduler:ut_break_all_promises() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1024
        return ret -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1025
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1018
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1027)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1027
      factories[1].stations.known[1].present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1029
        'free-train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1029
      }; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1029
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(1)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1030)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1030
      local promise = scheduler:ut_promise('unrelated-train', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1032
        inbound_station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1032
      }); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1032
      require('shunt.spec')._assert_that([=[#(get_candidates promise)]=], #(get_candidates(promise)), (eq(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1033)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1033
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(1)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1035)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1035
      factories[1].stations.known[1].present_trains = { }; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1037
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1038)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1038
      factories[2].stations.known[1].present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1040
        'free-train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1040
      }; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1040
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(1)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1041)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1041
      promise = scheduler:ut_promise('unrelated-train', { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1043
        outbound_station -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1043
      }); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1043
      require('shunt.spec')._assert_that([=[#(get_candidates promise)]=], #(get_candidates(promise)), (eq(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1044)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1044
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(1)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1045)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1045
      local PROMISED_TRAIN = 'promised-train' -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1047
      factories[2].stations.known[1].present_trains = { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1048
        PROMISED_TRAIN -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1048
      } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1048
      promise = scheduler:ut_promise(PROMISED_TRAIN, { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1051
        { -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1051
          name = 'other-station', -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1051
          capacity = 1 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1052
        } -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1051
      }); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1050
      require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(0)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1053)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1053
      scheduler:ut_break_promise(promise); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1054
      return require('shunt.spec')._assert_that([=[#get_candidates!]=], #get_candidates(), (eq(1)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1055)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1055
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:946
    return it('defines sound waiting conditions', function() -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1057
      local CARGO_INACTIVE, MIN_WAIT_REACHED, MAX_WAIT_REACHED = ScheduleGeneratorImpl.CARGO_INACTIVE, ScheduleGeneratorImpl.MIN_WAIT_REACHED, ScheduleGeneratorImpl.MAX_WAIT_REACHED -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1058
      local DEFAULT_RESEND_COOLDOWN_SECONDS = Scheduler.DEFAULT_RESEND_COOLDOWN_SECONDS; -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1063
      require('shunt.spec')._expect_that([=[CARGO_INACTIVE.id]=], CARGO_INACTIVE.id, (eq('create:idle')), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1065)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1065
      require('shunt.spec')._expect_that([=[MIN_WAIT_REACHED.id]=], MIN_WAIT_REACHED.id, (eq('create:delay')), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1066)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1066
      require('shunt.spec')._expect_that([=[MAX_WAIT_REACHED.id]=], MAX_WAIT_REACHED.id, (eq('create:delay')), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1067)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1067
      local implied_time -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1069
      implied_time = function(condition) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1069
        local scale -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1070
        do -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1070
          local _exp_0 = condition.data.time_unit -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1070
          if time_units.TICKS == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1071
            scale = 0.05 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1072
          elseif time_units.SECONDS == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1073
            scale = 1 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1074
          elseif time_units.MINUTES == _exp_0 then -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1075
            scale = 60 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1076
          end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1076
        end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1076
        return scale * condition.data.value -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1077
      end -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1069
      local cargo_inactive_time = implied_time(CARGO_INACTIVE) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1078
      local min_wait_reached_time = implied_time(MIN_WAIT_REACHED) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1079
      local max_wait_reached_time = implied_time(MAX_WAIT_REACHED); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1080
      require('shunt.spec')._assert_that([=[cargo_inactive_time]=], cargo_inactive_time, (lt(min_wait_reached_time)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1081)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1081
      require('shunt.spec')._assert_that([=[min_wait_reached_time]=], min_wait_reached_time, (lt(max_wait_reached_time)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1082)); -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1082
      return require('shunt.spec')._assert_that([=[DEFAULT_RESEND_COOLDOWN_SECONDS]=], DEFAULT_RESEND_COOLDOWN_SECONDS, (gt(2 * max_wait_reached_time)), tostring("shunt/nodes/marshal/resource_orchestrator/scheduler.yue") .. ":" .. tostring(1084)) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1084
    end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1084
  end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1084
end) -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:692
return _module_0 -- shunt/nodes/marshal/resource_orchestrator/scheduler.yue:1090
end
package.preload['shunt.upgrade.listener'] = function(...)
-- [yue]: shunt/upgrade/listener.yue
local _module_0 = { } -- shunt/upgrade/listener.yue:1
local Queue = require('shunt.data.queue').Queue -- shunt/upgrade/listener.yue:0
local Firewall = require('shunt.firewall').Firewall -- shunt/upgrade/listener.yue:0
local log, trace -- shunt/upgrade/listener.yue:0
do -- shunt/upgrade/listener.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/upgrade/listener.yue:0
  log, trace = _obj_0.log, _obj_0.trace -- shunt/upgrade/listener.yue:0
end -- shunt/upgrade/listener.yue:0
local declare_type, F, T -- shunt/upgrade/listener.yue:0
do -- shunt/upgrade/listener.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/upgrade/listener.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/upgrade/listener.yue:0
end -- shunt/upgrade/listener.yue:0
local shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder -- shunt/upgrade/listener.yue:0
do -- shunt/upgrade/listener.yue:0
  local _obj_0 = require('shunt.state') -- shunt/upgrade/listener.yue:0
  shallow_log_reporter, State, StateMachineBuilder, StateResponsesBuilder = _obj_0.shallow_log_reporter, _obj_0.State, _obj_0.StateMachineBuilder, _obj_0.StateResponsesBuilder -- shunt/upgrade/listener.yue:0
end -- shunt/upgrade/listener.yue:0
local MarshalBumpRelease = require('shunt.upgrade.instigator').MarshalBumpRelease -- shunt/upgrade/listener.yue:0
local CurrentReleaseRequest, CurrentReleaseResponse -- shunt/upgrade/listener.yue:0
do -- shunt/upgrade/listener.yue:0
  local _obj_0 = require('shunt.upgrade.monitor') -- shunt/upgrade/listener.yue:0
  CurrentReleaseRequest, CurrentReleaseResponse = _obj_0.CurrentReleaseRequest, _obj_0.CurrentReleaseResponse -- shunt/upgrade/listener.yue:0
end -- shunt/upgrade/listener.yue:0
local MinecraftRebooter, RebootRequest -- shunt/upgrade/listener.yue:0
do -- shunt/upgrade/listener.yue:0
  local _obj_0 = require('shunt.upgrade.rebooter') -- shunt/upgrade/listener.yue:0
  MinecraftRebooter, RebootRequest = _obj_0.MinecraftRebooter, _obj_0.RebootRequest -- shunt/upgrade/listener.yue:0
end -- shunt/upgrade/listener.yue:0
local Tester = require('shunt.upgrade.tester').Tester -- shunt/upgrade/listener.yue:0
local VERSION = require('shunt.version').VERSION -- shunt/upgrade/listener.yue:0
declare_type('UpgradeListener', 'NetworkComponent') -- shunt/upgrade/listener.yue:14
declare_type('UpgradeListenerKind', '"leader"|"follower"') -- shunt/upgrade/listener.yue:15
declare_type('UpgradeListenerEvent', [[{
  type: "network-packet",
  packet: Packet,
}]]) -- shunt/upgrade/listener.yue:16
declare_type('UpgradeListenerOpts', [[{
  config: UpgradeListenerConfig,
  uplink: Uplink,
  rebooter: ?Rebooter,
}]]) -- shunt/upgrade/listener.yue:20
declare_type('UpgradeListenerConfig', [[{
  marshal: ?{},
}]]) -- shunt/upgrade/listener.yue:25
local UpgradeListener -- shunt/upgrade/listener.yue:28
do -- shunt/upgrade/listener.yue:28
  local _class_0 -- shunt/upgrade/listener.yue:28
  local _base_0 = { -- shunt/upgrade/listener.yue:28
    make_sm_responses = F('(StateMachine) => StateResponses', function(self, sm) -- shunt/upgrade/listener.yue:112
      return (StateResponsesBuilder(sm)):add('waiting', (function() -- shunt/upgrade/listener.yue:114
        local _base_1 = self -- shunt/upgrade/listener.yue:114
        local _fn_0 = _base_1.on_waiting -- shunt/upgrade/listener.yue:114
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:114
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:114
        end -- shunt/upgrade/listener.yue:114
      end)()):add('inspecting_packet', (function() -- shunt/upgrade/listener.yue:115
        local _base_1 = self -- shunt/upgrade/listener.yue:115
        local _fn_0 = _base_1.on_inspecting_packet -- shunt/upgrade/listener.yue:115
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:115
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:115
        end -- shunt/upgrade/listener.yue:115
      end)()):add('analysing_current_release_request', (function() -- shunt/upgrade/listener.yue:116
        local _base_1 = self -- shunt/upgrade/listener.yue:116
        local _fn_0 = _base_1.on_analysing_current_release_request -- shunt/upgrade/listener.yue:116
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:116
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:116
        end -- shunt/upgrade/listener.yue:116
      end)()):add('sending_current_release_response', (function() -- shunt/upgrade/listener.yue:117
        local _base_1 = self -- shunt/upgrade/listener.yue:117
        local _fn_0 = _base_1.on_sending_current_release_response -- shunt/upgrade/listener.yue:117
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:117
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:117
        end -- shunt/upgrade/listener.yue:117
      end)()):add('analysing_reboot_request', (function() -- shunt/upgrade/listener.yue:118
        local _base_1 = self -- shunt/upgrade/listener.yue:118
        local _fn_0 = _base_1.on_analysing_reboot_request -- shunt/upgrade/listener.yue:118
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:118
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:118
        end -- shunt/upgrade/listener.yue:118
      end)()):add('analysing_update', (function() -- shunt/upgrade/listener.yue:119
        local _base_1 = self -- shunt/upgrade/listener.yue:119
        local _fn_0 = _base_1.on_analysing_update -- shunt/upgrade/listener.yue:119
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:119
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:119
        end -- shunt/upgrade/listener.yue:119
      end)()):add('testing_update', (function() -- shunt/upgrade/listener.yue:120
        local _base_1 = self -- shunt/upgrade/listener.yue:120
        local _fn_0 = _base_1.on_testing_update -- shunt/upgrade/listener.yue:120
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:120
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:120
        end -- shunt/upgrade/listener.yue:120
      end)()):add('applying_update', (function() -- shunt/upgrade/listener.yue:121
        local _base_1 = self -- shunt/upgrade/listener.yue:121
        local _fn_0 = _base_1.on_applying_update -- shunt/upgrade/listener.yue:121
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:121
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:121
        end -- shunt/upgrade/listener.yue:121
      end)()):add('broadcasting_reboot', (function() -- shunt/upgrade/listener.yue:122
        local _base_1 = self -- shunt/upgrade/listener.yue:122
        local _fn_0 = _base_1.on_broadcasting_reboot -- shunt/upgrade/listener.yue:122
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:122
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:122
        end -- shunt/upgrade/listener.yue:122
      end)()):add('rejecting_update', (function() -- shunt/upgrade/listener.yue:123
        local _base_1 = self -- shunt/upgrade/listener.yue:123
        local _fn_0 = _base_1.on_rejecting_update -- shunt/upgrade/listener.yue:123
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:123
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:123
        end -- shunt/upgrade/listener.yue:123
      end)()):add('rebooting', (function() -- shunt/upgrade/listener.yue:124
        local _base_1 = self -- shunt/upgrade/listener.yue:124
        local _fn_0 = _base_1.on_rebooting -- shunt/upgrade/listener.yue:124
        return _fn_0 and function(...) -- shunt/upgrade/listener.yue:124
          return _fn_0(_base_1, ...) -- shunt/upgrade/listener.yue:124
        end -- shunt/upgrade/listener.yue:124
      end)()):build() -- shunt/upgrade/listener.yue:125
    end), -- shunt/upgrade/listener.yue:127
    step = F('() => <>', function(self) -- shunt/upgrade/listener.yue:127
      return self.sm_responses[self.sm.state.name]() -- shunt/upgrade/listener.yue:128
    end), -- shunt/upgrade/listener.yue:130
    on_waiting = F('() => <>', function(self) -- shunt/upgrade/listener.yue:130
      local event = self.events:dequeue() -- shunt/upgrade/listener.yue:131
      if not (event ~= nil) then -- shunt/upgrade/listener.yue:132
        return -- shunt/upgrade/listener.yue:133
      end -- shunt/upgrade/listener.yue:132
      local _exp_0 = event.type -- shunt/upgrade/listener.yue:134
      if 'network-packet' == _exp_0 then -- shunt/upgrade/listener.yue:135
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:136
        return _call_0["goto"](_call_0, 'inspecting_packet', { -- shunt/upgrade/listener.yue:137
          packet = event.packet -- shunt/upgrade/listener.yue:137
        }) -- shunt/upgrade/listener.yue:136
      else -- shunt/upgrade/listener.yue:139
        return error("internal error: unrecognised event type '" .. tostring(event.type) .. "'") -- shunt/upgrade/listener.yue:139
      end -- shunt/upgrade/listener.yue:139
    end), -- shunt/upgrade/listener.yue:141
    on_inspecting_packet = F('() => <>', function(self) -- shunt/upgrade/listener.yue:141
      local packet = self.sm.state.packet -- shunt/upgrade/listener.yue:142
      local _exp_0 = packet.protocol -- shunt/upgrade/listener.yue:143
      if 'CurrentReleaseResponse' == _exp_0 then -- shunt/upgrade/listener.yue:144
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:145
        return _call_0["goto"](_call_0, 'analysing_current_release_request', { -- shunt/upgrade/listener.yue:146
          packet = packet -- shunt/upgrade/listener.yue:146
        }) -- shunt/upgrade/listener.yue:145
      elseif 'RebootRequest' == _exp_0 then -- shunt/upgrade/listener.yue:147
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:148
        return _call_0["goto"](_call_0, 'analysing_reboot_request', { -- shunt/upgrade/listener.yue:149
          packet = packet -- shunt/upgrade/listener.yue:149
        }) -- shunt/upgrade/listener.yue:148
      elseif 'MarshalBumpRelease' == _exp_0 then -- shunt/upgrade/listener.yue:150
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:151
        return _call_0["goto"](_call_0, 'analysing_update', { -- shunt/upgrade/listener.yue:152
          packet = packet -- shunt/upgrade/listener.yue:152
        }) -- shunt/upgrade/listener.yue:151
      else -- shunt/upgrade/listener.yue:154
        return error("internal error: unrecognised protocol '" .. tostring(event.type) .. "'") -- shunt/upgrade/listener.yue:154
      end -- shunt/upgrade/listener.yue:154
    end), -- shunt/upgrade/listener.yue:156
    on_analysing_current_release_request = F('() => <>', function(self) -- shunt/upgrade/listener.yue:156
      local idemp_tok, pc_id -- shunt/upgrade/listener.yue:157
      do -- shunt/upgrade/listener.yue:157
        local _obj_0 = self.sm.state -- shunt/upgrade/listener.yue:161
        idemp_tok, pc_id = _obj_0.packet.idemp_tok, _obj_0.packet.pc_id -- shunt/upgrade/listener.yue:157
      end -- shunt/upgrade/listener.yue:161
      local current_release = self:current_release() -- shunt/upgrade/listener.yue:162
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:163
      return _call_0["goto"](_call_0, 'sending_current_release_response', { -- shunt/upgrade/listener.yue:164
        idemp_tok = idemp_tok, -- shunt/upgrade/listener.yue:164
        recipient_id = pc_id, -- shunt/upgrade/listener.yue:165
        current_release = current_release -- shunt/upgrade/listener.yue:166
      }) -- shunt/upgrade/listener.yue:163
    end), -- shunt/upgrade/listener.yue:168
    current_release = F('() => Release', function(self) -- shunt/upgrade/listener.yue:168
      if self.kind ~= 'leader' then -- shunt/upgrade/listener.yue:169
        error('internal error: non-leader requested current release') -- shunt/upgrade/listener.yue:170
      end -- shunt/upgrade/listener.yue:169
      if (self._current_release ~= nil) then -- shunt/upgrade/listener.yue:171
        return self._current_release -- shunt/upgrade/listener.yue:172
      end -- shunt/upgrade/listener.yue:171
      local content -- shunt/upgrade/listener.yue:174
      do -- shunt/upgrade/listener.yue:174
        do -- shunt/upgrade/listener.yue:175
          local _with_0 = assert(io.open('shunt', 'r')) -- shunt/upgrade/listener.yue:175
          content = assert(_with_0:read('*a')) -- shunt/upgrade/listener.yue:176
          assert(_with_0:close()) -- shunt/upgrade/listener.yue:177
        end -- shunt/upgrade/listener.yue:175
        content = content -- shunt/upgrade/listener.yue:178
      end -- shunt/upgrade/listener.yue:178
      self._current_release = T('Release', { -- shunt/upgrade/listener.yue:180
        file = 'shunt', -- shunt/upgrade/listener.yue:180
        version = VERSION, -- shunt/upgrade/listener.yue:181
        content = content -- shunt/upgrade/listener.yue:182
      }) -- shunt/upgrade/listener.yue:179
      return self._current_release -- shunt/upgrade/listener.yue:183
    end), -- shunt/upgrade/listener.yue:185
    on_sending_current_release_response = F('() => <>', function(self) -- shunt/upgrade/listener.yue:185
      local idemp_tok, recipient_id, current_release -- shunt/upgrade/listener.yue:186
      do -- shunt/upgrade/listener.yue:186
        local _obj_0 = self.sm.state -- shunt/upgrade/listener.yue:190
        idemp_tok, recipient_id, current_release = _obj_0.idemp_tok, _obj_0.recipient_id, _obj_0.current_release -- shunt/upgrade/listener.yue:186
      end -- shunt/upgrade/listener.yue:190
      self.uplink:send_to(recipient_id, CurrentReleaseResponse(idemp_tok, current_release)) -- shunt/upgrade/listener.yue:191
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:192
      return _call_0["goto"](_call_0, 'waiting') -- shunt/upgrade/listener.yue:192
    end), -- shunt/upgrade/listener.yue:194
    on_analysing_reboot_request = F('() => <>', function(self) -- shunt/upgrade/listener.yue:194
      local packet = self.sm.state.packet -- shunt/upgrade/listener.yue:195
      assert(packet) -- shunt/upgrade/listener.yue:196
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:197
      return _call_0["goto"](_call_0, 'rebooting') -- shunt/upgrade/listener.yue:197
    end), -- shunt/upgrade/listener.yue:199
    on_analysing_update = F('() => <>', function(self) -- shunt/upgrade/listener.yue:199
      local pc_id, release -- shunt/upgrade/listener.yue:200
      do -- shunt/upgrade/listener.yue:200
        local _obj_0 = self.sm.state -- shunt/upgrade/listener.yue:204
        pc_id, release = _obj_0.packet.pc_id, _obj_0.packet.release -- shunt/upgrade/listener.yue:200
      end -- shunt/upgrade/listener.yue:204
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:205
      return _call_0["goto"](_call_0, 'testing_update', { -- shunt/upgrade/listener.yue:206
        instigator_id = pc_id, -- shunt/upgrade/listener.yue:206
        release = release -- shunt/upgrade/listener.yue:207
      }) -- shunt/upgrade/listener.yue:205
    end), -- shunt/upgrade/listener.yue:209
    on_testing_update = F('() => <>', function(self) -- shunt/upgrade/listener.yue:209
      local instigator_id, release -- shunt/upgrade/listener.yue:210
      do -- shunt/upgrade/listener.yue:210
        local _obj_0 = self.sm.state -- shunt/upgrade/listener.yue:210
        instigator_id, release = _obj_0.instigator_id, _obj_0.release -- shunt/upgrade/listener.yue:210
      end -- shunt/upgrade/listener.yue:210
      if #release.content > fs.getFreeSpace('/') then -- shunt/upgrade/listener.yue:211
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:212
        _call_0["goto"](_call_0, 'rejecting_update', { -- shunt/upgrade/listener.yue:213
          instigator_id = instigator_id, -- shunt/upgrade/listener.yue:213
          cause = "cannot upgrade: too little space, need " .. tostring(#release.content) .. ", but only " .. tostring(fs.getFreeSpace('/')) .. "/" .. tostring(fs.getCapacity('/')) .. " available" -- shunt/upgrade/listener.yue:214
        }) -- shunt/upgrade/listener.yue:212
        return -- shunt/upgrade/listener.yue:215
      end -- shunt/upgrade/listener.yue:211
      local ok, err = self:test(release) -- shunt/upgrade/listener.yue:217
      if not ok then -- shunt/upgrade/listener.yue:218
        local _call_0 = self.sm -- shunt/upgrade/listener.yue:219
        _call_0["goto"](_call_0, 'rejecting_update', { -- shunt/upgrade/listener.yue:220
          instigator_id = instigator_id, -- shunt/upgrade/listener.yue:220
          cause = "cannot upgrade: " .. tostring(err) -- shunt/upgrade/listener.yue:221
        }) -- shunt/upgrade/listener.yue:219
        return -- shunt/upgrade/listener.yue:222
      end -- shunt/upgrade/listener.yue:218
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:224
      return _call_0["goto"](_call_0, 'applying_update', { -- shunt/upgrade/listener.yue:225
        release = release -- shunt/upgrade/listener.yue:225
      }) -- shunt/upgrade/listener.yue:224
    end), -- shunt/upgrade/listener.yue:227
    on_applying_update = F('() => <>', function(self) -- shunt/upgrade/listener.yue:227
      local release = self.sm.state.release -- shunt/upgrade/listener.yue:228
      self._current_release = release -- shunt/upgrade/listener.yue:230
      do -- shunt/upgrade/listener.yue:231
        local _with_0 = assert(io.open(release.file, 'w+')) -- shunt/upgrade/listener.yue:231
        assert(_with_0:write(release.content)) -- shunt/upgrade/listener.yue:232
        assert(_with_0:close()) -- shunt/upgrade/listener.yue:233
      end -- shunt/upgrade/listener.yue:231
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:235
      return _call_0["goto"](_call_0, 'broadcasting_reboot') -- shunt/upgrade/listener.yue:235
    end), -- shunt/upgrade/listener.yue:237
    on_broadcasting_reboot = F('() => <>', function(self) -- shunt/upgrade/listener.yue:237
      self.uplink:deafen() -- shunt/upgrade/listener.yue:238
      self.uplink:broadcast(RebootRequest()) -- shunt/upgrade/listener.yue:239
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:240
      return _call_0["goto"](_call_0, 'rebooting') -- shunt/upgrade/listener.yue:240
    end), -- shunt/upgrade/listener.yue:242
    on_rejecting_update = F('() => <>', function(self) -- shunt/upgrade/listener.yue:242
      local instigator_id, cause -- shunt/upgrade/listener.yue:243
      do -- shunt/upgrade/listener.yue:243
        local _obj_0 = self.sm.state -- shunt/upgrade/listener.yue:243
        instigator_id, cause = _obj_0.instigator_id, _obj_0.cause -- shunt/upgrade/listener.yue:243
      end -- shunt/upgrade/listener.yue:243
      self.uplink:send_to(instigator_id, UpdateRejection(cause)) -- shunt/upgrade/listener.yue:244
      local _call_0 = self.sm -- shunt/upgrade/listener.yue:245
      return _call_0["goto"](_call_0, 'waiting') -- shunt/upgrade/listener.yue:245
    end), -- shunt/upgrade/listener.yue:247
    on_rebooting = F('() => <>', function(self) -- shunt/upgrade/listener.yue:247
      return self.rebooter:reboot() -- shunt/upgrade/listener.yue:248
    end) -- shunt/upgrade/listener.yue:28
  } -- shunt/upgrade/listener.yue:28
  local _list_0 = { -- shunt/upgrade/listener.yue:28
    Tester -- shunt/upgrade/listener.yue:28
  } -- shunt/upgrade/listener.yue:28
  for _index_0 = 1, #_list_0 do -- shunt/upgrade/listener.yue:248
    local _item_0 = _list_0[_index_0] -- shunt/upgrade/listener.yue:28
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/upgrade/listener.yue:28
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/upgrade/listener.yue:248
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/upgrade/listener.yue:28
        _base_0[_key_0] = _val_0 -- shunt/upgrade/listener.yue:28
      end -- shunt/upgrade/listener.yue:28
    end -- shunt/upgrade/listener.yue:248
  end -- shunt/upgrade/listener.yue:248
  if _base_0.__index == nil then -- shunt/upgrade/listener.yue:28
    _base_0.__index = _base_0 -- shunt/upgrade/listener.yue:28
  end -- shunt/upgrade/listener.yue:248
  _class_0 = setmetatable({ -- shunt/upgrade/listener.yue:28
    __init = F('(UpgradeListenerOpts) => <>', function(self, opts) -- shunt/upgrade/listener.yue:29
      local config, uplink, rebooter = opts.config, opts.uplink, opts.rebooter -- shunt/upgrade/listener.yue:30
      if rebooter == nil then -- shunt/upgrade/listener.yue:33
        rebooter = MinecraftRebooter() -- shunt/upgrade/listener.yue:33
      end -- shunt/upgrade/listener.yue:33
      self.config = config -- shunt/upgrade/listener.yue:35
      self.uplink = uplink -- shunt/upgrade/listener.yue:36
      self.rebooter = rebooter -- shunt/upgrade/listener.yue:37
      self.kind = T('UpgradeListenerKind', (function() -- shunt/upgrade/listener.yue:39
        if (config.marshal ~= nil) then -- shunt/upgrade/listener.yue:39
          return 'leader' -- shunt/upgrade/listener.yue:40
        else -- shunt/upgrade/listener.yue:42
          return 'follower' -- shunt/upgrade/listener.yue:42
        end -- shunt/upgrade/listener.yue:39
      end)()) -- shunt/upgrade/listener.yue:39
      self._current_release = T('?Release', nil) -- shunt/upgrade/listener.yue:43
      self.firewall = Firewall({ -- shunt/upgrade/listener.yue:46
        CurrentReleaseRequest, -- shunt/upgrade/listener.yue:46
        MarshalBumpRelease, -- shunt/upgrade/listener.yue:47
        RebootRequest -- shunt/upgrade/listener.yue:48
      }) -- shunt/upgrade/listener.yue:45
      self.events = Queue('UpgradeListenerEvent') -- shunt/upgrade/listener.yue:49
      self.sm = self.__class:make_sm() -- shunt/upgrade/listener.yue:50
      self.sm_responses = self:make_sm_responses(self.sm) -- shunt/upgrade/listener.yue:51
    end), -- shunt/upgrade/listener.yue:28
    __base = _base_0, -- shunt/upgrade/listener.yue:28
    __name = "UpgradeListener" -- shunt/upgrade/listener.yue:28
  }, { -- shunt/upgrade/listener.yue:28
    __index = _base_0, -- shunt/upgrade/listener.yue:28
    __call = function(cls, ...) -- shunt/upgrade/listener.yue:28
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/listener.yue:28
      cls.__init(_self_0, ...) -- shunt/upgrade/listener.yue:28
      return _self_0 -- shunt/upgrade/listener.yue:28
    end -- shunt/upgrade/listener.yue:28
  }) -- shunt/upgrade/listener.yue:28
  _base_0.__class = _class_0 -- shunt/upgrade/listener.yue:28
  local self = _class_0; -- shunt/upgrade/listener.yue:28
  self.make_sm = F('() => StateMachine', function(self) -- shunt/upgrade/listener.yue:53
    return (StateMachineBuilder('upgrade_listener')):set_initial_state('waiting'):set_reporter(shallow_log_reporter):add((State('waiting')):add_transition_to('inspecting_packet')):add((State('inspecting_packet')):set_data_type([[{
          packet: Packet,
        }]]):add_transition_to('analysing_current_release_request'):add_transition_to('analysing_reboot_request'):add_transition_to('analysing_update')):add((State('analysing_current_release_request')):set_data_type([[{
          packet: CurrentReleaseRequest,
        }]]):add_transition_to('sending_current_release_response')):add((State('sending_current_release_response')):set_data_type([[{
          idemp_tok: IdempotenceToken,
          recipient_id: number,
          current_release: Release,
        }]]):add_transition_to('waiting')):add((State('analysing_reboot_request')):set_data_type([[{
          packet: RebootRequest,
        }]]):add_transition_to('rebooting')):add((State('analysing_update')):set_data_type([[{
          packet: MarshalBumpRelease,
        }]]):add_transition_to('testing_update')):add((State('testing_update')):set_data_type([[{
          instigator_id: number,
          release: Release,
        }]]):add_transition_to('applying_update'):add_transition_to('rejecting_update')):add((State('applying_update')):set_data_type([[{
          release: Release,
        }]]):add_transition_to('broadcasting_reboot')):add((State('broadcasting_reboot')):add_transition_to('rebooting')):add((State('rejecting_update')):set_data_type([[{
          instigator_id: number,
          cause: string,
        }]]):add_transition_to('waiting')):add((State('rebooting')):declare_end_state()):build() -- shunt/upgrade/listener.yue:110
  end) -- shunt/upgrade/listener.yue:53
  UpgradeListener = _class_0 -- shunt/upgrade/listener.yue:28
end -- shunt/upgrade/listener.yue:248
_module_0["UpgradeListener"] = UpgradeListener -- shunt/upgrade/listener.yue:28
return _module_0 -- shunt/upgrade/listener.yue:248
end
package.preload['shunt.upgrade.instigator'] = function(...)
-- [yue]: shunt/upgrade/instigator.yue
local _module_0 = { } -- shunt/upgrade/instigator.yue:1
local MarshalBumpRelease -- shunt/upgrade/instigator.yue:2
local fatal, log -- shunt/upgrade/instigator.yue:0
do -- shunt/upgrade/instigator.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/upgrade/instigator.yue:0
  fatal, log = _obj_0.fatal, _obj_0.log -- shunt/upgrade/instigator.yue:0
end -- shunt/upgrade/instigator.yue:0
local IdempotenceToken, Packet, TIMEOUT, Uplink -- shunt/upgrade/instigator.yue:0
do -- shunt/upgrade/instigator.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/upgrade/instigator.yue:0
  IdempotenceToken, Packet, TIMEOUT, Uplink = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.TIMEOUT, _obj_0.Uplink -- shunt/upgrade/instigator.yue:0
end -- shunt/upgrade/instigator.yue:0
local declare_type, F -- shunt/upgrade/instigator.yue:0
do -- shunt/upgrade/instigator.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/upgrade/instigator.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/upgrade/instigator.yue:0
end -- shunt/upgrade/instigator.yue:0
local spec = require('shunt.spec').spec -- shunt/upgrade/instigator.yue:0
local MinecraftRebooter, RebootRequest -- shunt/upgrade/instigator.yue:0
do -- shunt/upgrade/instigator.yue:0
  local _obj_0 = require('shunt.upgrade.rebooter') -- shunt/upgrade/instigator.yue:0
  MinecraftRebooter, RebootRequest = _obj_0.MinecraftRebooter, _obj_0.RebootRequest -- shunt/upgrade/instigator.yue:0
end -- shunt/upgrade/instigator.yue:0
local Tester = require('shunt.upgrade.tester').Tester -- shunt/upgrade/instigator.yue:0
declare_type('InstigatorOpts', [[{
  config: ?{},
  pc: Pc,
  rebooter: ?Rebooter,
  release: Release,
  uplink: ?Uplink,
}]]) -- shunt/upgrade/instigator.yue:11
local Instigator -- shunt/upgrade/instigator.yue:18
do -- shunt/upgrade/instigator.yue:18
  local _class_0 -- shunt/upgrade/instigator.yue:18
  local _base_0 = { -- shunt/upgrade/instigator.yue:18
    upgrade = F('(?"no-prompt") => <>', function(self, prompt) -- shunt/upgrade/instigator.yue:36
      assert(self:test(self.release)) -- shunt/upgrade/instigator.yue:37
      if prompt ~= 'no-prompt' then -- shunt/upgrade/instigator.yue:39
        local resp -- shunt/upgrade/instigator.yue:40
        while resp ~= '' do -- shunt/upgrade/instigator.yue:41
          print("ready to upgrade to version " .. tostring(self.release.version)) -- shunt/upgrade/instigator.yue:42
          print('press [ENTER] to deploy') -- shunt/upgrade/instigator.yue:43
          resp = io.read('*l') -- shunt/upgrade/instigator.yue:44
        end -- shunt/upgrade/instigator.yue:44
      end -- shunt/upgrade/instigator.yue:39
      self:bump_marshal(self.release) -- shunt/upgrade/instigator.yue:45
      if self:await_reboot_request() then -- shunt/upgrade/instigator.yue:47
        return self:reboot() -- shunt/upgrade/instigator.yue:48
      end -- shunt/upgrade/instigator.yue:47
    end), -- shunt/upgrade/instigator.yue:50
    bump_marshal = F('(Release) => <>', function(self, release) -- shunt/upgrade/instigator.yue:50
      log(function() -- shunt/upgrade/instigator.yue:51
        return 'bumping marshal...' -- shunt/upgrade/instigator.yue:51
      end) -- shunt/upgrade/instigator.yue:51
      self.uplink:broadcast(MarshalBumpRelease(release, self.pc:id())) -- shunt/upgrade/instigator.yue:52
      return -- shunt/upgrade/instigator.yue:53
    end), -- shunt/upgrade/instigator.yue:55
    await_reboot_request = F('() => boolean', function(self) -- shunt/upgrade/instigator.yue:55
      log(function() -- shunt/upgrade/instigator.yue:56
        return 'awaiting reboot request...' -- shunt/upgrade/instigator.yue:56
      end) -- shunt/upgrade/instigator.yue:56
      local MAX_ATTEMPTS = 3 -- shunt/upgrade/instigator.yue:57
      for i = 1, MAX_ATTEMPTS do -- shunt/upgrade/instigator.yue:58
        if i > 1 then -- shunt/upgrade/instigator.yue:59
          print("awaiting reboot request (attempt " .. tostring(i) .. "/" .. tostring(MAX_ATTEMPTS) .. ")") -- shunt/upgrade/instigator.yue:60
        end -- shunt/upgrade/instigator.yue:59
        local ok, err = self.uplink:receive_from_any(RebootRequest, { -- shunt/upgrade/instigator.yue:62
          timeout = 5 -- shunt/upgrade/instigator.yue:62
        }) -- shunt/upgrade/instigator.yue:62
        if ok then -- shunt/upgrade/instigator.yue:63
          return true -- shunt/upgrade/instigator.yue:64
        end -- shunt/upgrade/instigator.yue:63
        if err ~= TIMEOUT then -- shunt/upgrade/instigator.yue:65
          fatal(err) -- shunt/upgrade/instigator.yue:66
        end -- shunt/upgrade/instigator.yue:65
      end -- shunt/upgrade/instigator.yue:66
      print("marshal did not issue reboot request") -- shunt/upgrade/instigator.yue:67
      return false -- shunt/upgrade/instigator.yue:68
    end), -- shunt/upgrade/instigator.yue:70
    reboot = F('() => !', function(self) -- shunt/upgrade/instigator.yue:70
      return self.rebooter:reboot() -- shunt/upgrade/instigator.yue:71
    end) -- shunt/upgrade/instigator.yue:18
  } -- shunt/upgrade/instigator.yue:18
  local _list_0 = { -- shunt/upgrade/instigator.yue:18
    Tester -- shunt/upgrade/instigator.yue:18
  } -- shunt/upgrade/instigator.yue:18
  for _index_0 = 1, #_list_0 do -- shunt/upgrade/instigator.yue:71
    local _item_0 = _list_0[_index_0] -- shunt/upgrade/instigator.yue:18
    local _cls_0, _mixin_0 = (_item_0.__base ~= nil), _item_0.__base or _item_0 -- shunt/upgrade/instigator.yue:18
    for _key_0, _val_0 in pairs(_mixin_0) do -- shunt/upgrade/instigator.yue:71
      if _base_0[_key_0] == nil and (not _cls_0 or not _key_0:match("^__")) then -- shunt/upgrade/instigator.yue:18
        _base_0[_key_0] = _val_0 -- shunt/upgrade/instigator.yue:18
      end -- shunt/upgrade/instigator.yue:18
    end -- shunt/upgrade/instigator.yue:71
  end -- shunt/upgrade/instigator.yue:71
  if _base_0.__index == nil then -- shunt/upgrade/instigator.yue:18
    _base_0.__index = _base_0 -- shunt/upgrade/instigator.yue:18
  end -- shunt/upgrade/instigator.yue:71
  _class_0 = setmetatable({ -- shunt/upgrade/instigator.yue:18
    __init = F('(InstigatorOpts) => <>', function(self, opts) -- shunt/upgrade/instigator.yue:19
      local config, pc, release, uplink, rebooter = opts.config, opts.pc, opts.release, opts.uplink, opts.rebooter -- shunt/upgrade/instigator.yue:20
      if uplink == nil then -- shunt/upgrade/instigator.yue:24
        uplink = Uplink() -- shunt/upgrade/instigator.yue:24
      end -- shunt/upgrade/instigator.yue:24
      if rebooter == nil then -- shunt/upgrade/instigator.yue:25
        rebooter = MinecraftRebooter() -- shunt/upgrade/instigator.yue:25
      end -- shunt/upgrade/instigator.yue:25
      self.config = config -- shunt/upgrade/instigator.yue:27
      self.pc = pc -- shunt/upgrade/instigator.yue:28
      self.release = release -- shunt/upgrade/instigator.yue:29
      self.uplink = uplink -- shunt/upgrade/instigator.yue:30
      self.rebooter = rebooter -- shunt/upgrade/instigator.yue:31
      if ((function() -- shunt/upgrade/instigator.yue:33
        if config ~= nil then -- shunt/upgrade/instigator.yue:33
          return config.marshal -- shunt/upgrade/instigator.yue:33
        end -- shunt/upgrade/instigator.yue:33
        return nil -- shunt/upgrade/instigator.yue:33
      end)() ~= nil) then -- shunt/upgrade/instigator.yue:33
        return fatal('cannot instigate upgrade from marshal') -- shunt/upgrade/instigator.yue:34
      end -- shunt/upgrade/instigator.yue:33
    end), -- shunt/upgrade/instigator.yue:18
    __base = _base_0, -- shunt/upgrade/instigator.yue:18
    __name = "Instigator" -- shunt/upgrade/instigator.yue:18
  }, { -- shunt/upgrade/instigator.yue:18
    __index = _base_0, -- shunt/upgrade/instigator.yue:18
    __call = function(cls, ...) -- shunt/upgrade/instigator.yue:18
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/instigator.yue:18
      cls.__init(_self_0, ...) -- shunt/upgrade/instigator.yue:18
      return _self_0 -- shunt/upgrade/instigator.yue:18
    end -- shunt/upgrade/instigator.yue:18
  }) -- shunt/upgrade/instigator.yue:18
  _base_0.__class = _class_0 -- shunt/upgrade/instigator.yue:18
  Instigator = _class_0 -- shunt/upgrade/instigator.yue:18
end -- shunt/upgrade/instigator.yue:71
_module_0["Instigator"] = Instigator -- shunt/upgrade/instigator.yue:18
do -- shunt/upgrade/instigator.yue:73
  local _class_0 -- shunt/upgrade/instigator.yue:73
  local _parent_0 = Packet -- shunt/upgrade/instigator.yue:73
  local _base_0 = { } -- shunt/upgrade/instigator.yue:73
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/upgrade/instigator.yue:75
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/upgrade/instigator.yue:73
      _base_0[_key_0] = _val_0 -- shunt/upgrade/instigator.yue:73
    end -- shunt/upgrade/instigator.yue:73
  end -- shunt/upgrade/instigator.yue:75
  if _base_0.__index == nil then -- shunt/upgrade/instigator.yue:73
    _base_0.__index = _base_0 -- shunt/upgrade/instigator.yue:73
  end -- shunt/upgrade/instigator.yue:75
  setmetatable(_base_0, _parent_0.__base) -- shunt/upgrade/instigator.yue:73
  _class_0 = setmetatable({ -- shunt/upgrade/instigator.yue:73
    __init = F('(Release, number) => <>', function(self, release, pc_id) -- shunt/upgrade/instigator.yue:74
      self.release = release -- shunt/upgrade/instigator.yue:74
      self.pc_id = pc_id -- shunt/upgrade/instigator.yue:74
      return _class_0.__parent.__init(self) -- shunt/upgrade/instigator.yue:75
    end), -- shunt/upgrade/instigator.yue:73
    __base = _base_0, -- shunt/upgrade/instigator.yue:73
    __name = "MarshalBumpRelease", -- shunt/upgrade/instigator.yue:73
    __parent = _parent_0 -- shunt/upgrade/instigator.yue:73
  }, { -- shunt/upgrade/instigator.yue:73
    __index = function(cls, name) -- shunt/upgrade/instigator.yue:73
      local val = rawget(_base_0, name) -- shunt/upgrade/instigator.yue:73
      if val == nil then -- shunt/upgrade/instigator.yue:73
        local parent = rawget(cls, "__parent") -- shunt/upgrade/instigator.yue:73
        if parent then -- shunt/upgrade/instigator.yue:73
          return parent[name] -- shunt/upgrade/instigator.yue:73
        end -- shunt/upgrade/instigator.yue:73
      else -- shunt/upgrade/instigator.yue:73
        return val -- shunt/upgrade/instigator.yue:73
      end -- shunt/upgrade/instigator.yue:73
    end, -- shunt/upgrade/instigator.yue:73
    __call = function(cls, ...) -- shunt/upgrade/instigator.yue:73
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/instigator.yue:73
      cls.__init(_self_0, ...) -- shunt/upgrade/instigator.yue:73
      return _self_0 -- shunt/upgrade/instigator.yue:73
    end -- shunt/upgrade/instigator.yue:73
  }) -- shunt/upgrade/instigator.yue:73
  _base_0.__class = _class_0 -- shunt/upgrade/instigator.yue:73
  if _parent_0.__inherited then -- shunt/upgrade/instigator.yue:73
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/upgrade/instigator.yue:73
  end -- shunt/upgrade/instigator.yue:73
  MarshalBumpRelease = _class_0 -- shunt/upgrade/instigator.yue:73
end -- shunt/upgrade/instigator.yue:75
_module_0["MarshalBumpRelease"] = MarshalBumpRelease -- shunt/upgrade/instigator.yue:73
spec(function() -- shunt/upgrade/instigator.yue:77
  local Pc, TestPcBackend -- shunt/upgrade/instigator.yue:0
  do -- shunt/upgrade/instigator.yue:0
    local _obj_0 = require('shunt.pc') -- shunt/upgrade/instigator.yue:0
    Pc, TestPcBackend = _obj_0.Pc, _obj_0.TestPcBackend -- shunt/upgrade/instigator.yue:0
  end -- shunt/upgrade/instigator.yue:0
  local TestUplinkBackend = require('shunt.peripheral.uplink').TestUplinkBackend -- shunt/upgrade/instigator.yue:0
  local describe, it, matchers -- shunt/upgrade/instigator.yue:0
  do -- shunt/upgrade/instigator.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/upgrade/instigator.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/upgrade/instigator.yue:0
  end -- shunt/upgrade/instigator.yue:0
  local deep_eq, eq, errors, has_fields, len, matches = matchers.deep_eq, matchers.eq, matchers.errors, matchers.has_fields, matchers.len, matchers.matches -- shunt/upgrade/instigator.yue:84
  local TestRebooter -- shunt/upgrade/instigator.yue:86
  do -- shunt/upgrade/instigator.yue:86
    local _class_0 -- shunt/upgrade/instigator.yue:86
    local _base_0 = { -- shunt/upgrade/instigator.yue:86
      reboot = function(self) -- shunt/upgrade/instigator.yue:89
        return error(self.__class.marker) -- shunt/upgrade/instigator.yue:90
      end -- shunt/upgrade/instigator.yue:86
    } -- shunt/upgrade/instigator.yue:86
    if _base_0.__index == nil then -- shunt/upgrade/instigator.yue:86
      _base_0.__index = _base_0 -- shunt/upgrade/instigator.yue:86
    end -- shunt/upgrade/instigator.yue:90
    _class_0 = setmetatable({ -- shunt/upgrade/instigator.yue:86
      __init = function() end, -- shunt/upgrade/instigator.yue:86
      __base = _base_0, -- shunt/upgrade/instigator.yue:86
      __name = "TestRebooter" -- shunt/upgrade/instigator.yue:86
    }, { -- shunt/upgrade/instigator.yue:86
      __index = _base_0, -- shunt/upgrade/instigator.yue:86
      __call = function(cls, ...) -- shunt/upgrade/instigator.yue:86
        local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/instigator.yue:86
        cls.__init(_self_0, ...) -- shunt/upgrade/instigator.yue:86
        return _self_0 -- shunt/upgrade/instigator.yue:86
      end -- shunt/upgrade/instigator.yue:86
    }) -- shunt/upgrade/instigator.yue:86
    _base_0.__class = _class_0 -- shunt/upgrade/instigator.yue:86
    local self = _class_0; -- shunt/upgrade/instigator.yue:86
    self.marker = 'REBOOTING' -- shunt/upgrade/instigator.yue:87
    TestRebooter = _class_0 -- shunt/upgrade/instigator.yue:86
  end -- shunt/upgrade/instigator.yue:90
  return describe('Instigator', function() -- shunt/upgrade/instigator.yue:92
    return it('instigates valid updates', function() -- shunt/upgrade/instigator.yue:93
      local config = { } -- shunt/upgrade/instigator.yue:94
      local release = { -- shunt/upgrade/instigator.yue:96
        file = 'shunt', -- shunt/upgrade/instigator.yue:96
        version = '9999999999999999', -- shunt/upgrade/instigator.yue:97
        content = '' -- shunt/upgrade/instigator.yue:98
      } -- shunt/upgrade/instigator.yue:95
      local PC_ID = 12345 -- shunt/upgrade/instigator.yue:99
      local last_idemp_tok = nil -- shunt/upgrade/instigator.yue:101
      local uplink = Uplink(TestUplinkBackend({ -- shunt/upgrade/instigator.yue:103
        to_receive = { -- shunt/upgrade/instigator.yue:104
          { -- shunt/upgrade/instigator.yue:104
            from_id = 1, -- shunt/upgrade/instigator.yue:104
            packet = RebootRequest() -- shunt/upgrade/instigator.yue:105
          } -- shunt/upgrade/instigator.yue:104
        }, -- shunt/upgrade/instigator.yue:103
        on_send = function(self, id, packet, protocol) -- shunt/upgrade/instigator.yue:106
          last_idemp_tok = packet.idemp_tok -- shunt/upgrade/instigator.yue:107
          return true -- shunt/upgrade/instigator.yue:108
        end -- shunt/upgrade/instigator.yue:106
      })) -- shunt/upgrade/instigator.yue:102
      local pc = Pc(TestPcBackend({ -- shunt/upgrade/instigator.yue:111
        id = function(self) -- shunt/upgrade/instigator.yue:111
          return PC_ID -- shunt/upgrade/instigator.yue:111
        end -- shunt/upgrade/instigator.yue:111
      })) -- shunt/upgrade/instigator.yue:110
      local rebooter = TestRebooter() -- shunt/upgrade/instigator.yue:112
      local upgrader = Instigator({ -- shunt/upgrade/instigator.yue:114
        config = config, -- shunt/upgrade/instigator.yue:114
        pc = pc, -- shunt/upgrade/instigator.yue:115
        rebooter = rebooter, -- shunt/upgrade/instigator.yue:116
        release = release, -- shunt/upgrade/instigator.yue:117
        uplink = uplink -- shunt/upgrade/instigator.yue:118
      }); -- shunt/upgrade/instigator.yue:113
      require('shunt.spec')._expect_that([=[(-> upgrader\upgrade 'no-prompt')]=], (function() -- shunt/upgrade/instigator.yue:119
        return upgrader:upgrade('no-prompt') -- shunt/upgrade/instigator.yue:119
      end), (errors(matches(TestRebooter.marker))), tostring("shunt/upgrade/instigator.yue") .. ":" .. tostring(119)); -- shunt/upgrade/instigator.yue:119
      require('shunt.spec')._expect_that([=[uplink.backend.sent]=], uplink.backend.sent, (len(eq(0))), tostring("shunt/upgrade/instigator.yue") .. ":" .. tostring(121)); -- shunt/upgrade/instigator.yue:121
      require('shunt.spec')._expect_that([=[uplink.backend.broadcasted]=], uplink.backend.broadcasted, (len(eq(1))), tostring("shunt/upgrade/instigator.yue") .. ":" .. tostring(122)); -- shunt/upgrade/instigator.yue:122
      return require('shunt.spec')._expect_that([=[uplink.backend.broadcasted[1]]=], uplink.backend.broadcasted[1], (has_fields({ -- shunt/upgrade/instigator.yue:123
        protocol = eq('MarshalBumpRelease'), -- shunt/upgrade/instigator.yue:123
        packet = has_fields({ -- shunt/upgrade/instigator.yue:123
          protocol = eq('MarshalBumpRelease'), -- shunt/upgrade/instigator.yue:123
          pc_id = eq(PC_ID), -- shunt/upgrade/instigator.yue:123
          release = deep_eq(release) -- shunt/upgrade/instigator.yue:123
        }) -- shunt/upgrade/instigator.yue:123
      })), tostring("shunt/upgrade/instigator.yue") .. ":" .. tostring(123)) -- shunt/upgrade/instigator.yue:128
    end) -- shunt/upgrade/instigator.yue:128
  end) -- shunt/upgrade/instigator.yue:128
end) -- shunt/upgrade/instigator.yue:77
return _module_0 -- shunt/upgrade/instigator.yue:128
end
package.preload['shunt.upgrade.rebooter'] = function(...)
-- [yue]: shunt/upgrade/rebooter.yue
local _module_0 = { } -- shunt/upgrade/rebooter.yue:1
local log = require('shunt.logger').log -- shunt/upgrade/rebooter.yue:0
local Packet = require('shunt.peripheral.uplink').Packet -- shunt/upgrade/rebooter.yue:0
local declare_type, F -- shunt/upgrade/rebooter.yue:0
do -- shunt/upgrade/rebooter.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/upgrade/rebooter.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/upgrade/rebooter.yue:0
end -- shunt/upgrade/rebooter.yue:0
declare_type('Rebooter', [[{
  reboot: () => !,
}]]) -- shunt/upgrade/rebooter.yue:7
local MinecraftRebooter -- shunt/upgrade/rebooter.yue:11
do -- shunt/upgrade/rebooter.yue:11
  local _class_0 -- shunt/upgrade/rebooter.yue:11
  local _base_0 = { -- shunt/upgrade/rebooter.yue:11
    reboot = F('() => !', function(self) -- shunt/upgrade/rebooter.yue:12
      log(function() -- shunt/upgrade/rebooter.yue:13
        return 'rebooting' -- shunt/upgrade/rebooter.yue:13
      end) -- shunt/upgrade/rebooter.yue:13
      return os.reboot() -- shunt/upgrade/rebooter.yue:14
    end) -- shunt/upgrade/rebooter.yue:11
  } -- shunt/upgrade/rebooter.yue:11
  if _base_0.__index == nil then -- shunt/upgrade/rebooter.yue:11
    _base_0.__index = _base_0 -- shunt/upgrade/rebooter.yue:11
  end -- shunt/upgrade/rebooter.yue:14
  _class_0 = setmetatable({ -- shunt/upgrade/rebooter.yue:11
    __init = function() end, -- shunt/upgrade/rebooter.yue:11
    __base = _base_0, -- shunt/upgrade/rebooter.yue:11
    __name = "MinecraftRebooter" -- shunt/upgrade/rebooter.yue:11
  }, { -- shunt/upgrade/rebooter.yue:11
    __index = _base_0, -- shunt/upgrade/rebooter.yue:11
    __call = function(cls, ...) -- shunt/upgrade/rebooter.yue:11
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/rebooter.yue:11
      cls.__init(_self_0, ...) -- shunt/upgrade/rebooter.yue:11
      return _self_0 -- shunt/upgrade/rebooter.yue:11
    end -- shunt/upgrade/rebooter.yue:11
  }) -- shunt/upgrade/rebooter.yue:11
  _base_0.__class = _class_0 -- shunt/upgrade/rebooter.yue:11
  MinecraftRebooter = _class_0 -- shunt/upgrade/rebooter.yue:11
end -- shunt/upgrade/rebooter.yue:14
_module_0["MinecraftRebooter"] = MinecraftRebooter -- shunt/upgrade/rebooter.yue:11
local RebootRequest -- shunt/upgrade/rebooter.yue:16
do -- shunt/upgrade/rebooter.yue:16
  local _class_0 -- shunt/upgrade/rebooter.yue:16
  local _parent_0 = Packet -- shunt/upgrade/rebooter.yue:16
  local _base_0 = { } -- shunt/upgrade/rebooter.yue:16
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/upgrade/rebooter.yue:16
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/upgrade/rebooter.yue:16
      _base_0[_key_0] = _val_0 -- shunt/upgrade/rebooter.yue:16
    end -- shunt/upgrade/rebooter.yue:16
  end -- shunt/upgrade/rebooter.yue:16
  if _base_0.__index == nil then -- shunt/upgrade/rebooter.yue:16
    _base_0.__index = _base_0 -- shunt/upgrade/rebooter.yue:16
  end -- shunt/upgrade/rebooter.yue:16
  setmetatable(_base_0, _parent_0.__base) -- shunt/upgrade/rebooter.yue:16
  _class_0 = setmetatable({ -- shunt/upgrade/rebooter.yue:16
    __init = function(self, ...) -- shunt/upgrade/rebooter.yue:16
      return _class_0.__parent.__init(self, ...) -- shunt/upgrade/rebooter.yue:16
    end, -- shunt/upgrade/rebooter.yue:16
    __base = _base_0, -- shunt/upgrade/rebooter.yue:16
    __name = "RebootRequest", -- shunt/upgrade/rebooter.yue:16
    __parent = _parent_0 -- shunt/upgrade/rebooter.yue:16
  }, { -- shunt/upgrade/rebooter.yue:16
    __index = function(cls, name) -- shunt/upgrade/rebooter.yue:16
      local val = rawget(_base_0, name) -- shunt/upgrade/rebooter.yue:16
      if val == nil then -- shunt/upgrade/rebooter.yue:16
        local parent = rawget(cls, "__parent") -- shunt/upgrade/rebooter.yue:16
        if parent then -- shunt/upgrade/rebooter.yue:16
          return parent[name] -- shunt/upgrade/rebooter.yue:16
        end -- shunt/upgrade/rebooter.yue:16
      else -- shunt/upgrade/rebooter.yue:16
        return val -- shunt/upgrade/rebooter.yue:16
      end -- shunt/upgrade/rebooter.yue:16
    end, -- shunt/upgrade/rebooter.yue:16
    __call = function(cls, ...) -- shunt/upgrade/rebooter.yue:16
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/rebooter.yue:16
      cls.__init(_self_0, ...) -- shunt/upgrade/rebooter.yue:16
      return _self_0 -- shunt/upgrade/rebooter.yue:16
    end -- shunt/upgrade/rebooter.yue:16
  }) -- shunt/upgrade/rebooter.yue:16
  _base_0.__class = _class_0 -- shunt/upgrade/rebooter.yue:16
  if _parent_0.__inherited then -- shunt/upgrade/rebooter.yue:16
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/upgrade/rebooter.yue:16
  end -- shunt/upgrade/rebooter.yue:16
  RebootRequest = _class_0 -- shunt/upgrade/rebooter.yue:16
end -- shunt/upgrade/rebooter.yue:16
_module_0["RebootRequest"] = RebootRequest -- shunt/upgrade/rebooter.yue:16
return _module_0 -- shunt/upgrade/rebooter.yue:16
end
package.preload['shunt.upgrade.tester'] = function(...)
-- [yue]: shunt/upgrade/tester.yue
local _module_0 = { } -- shunt/upgrade/tester.yue:1
local execute = require('shunt.execute').execute -- shunt/upgrade/tester.yue:0
local log = require('shunt.logger').log -- shunt/upgrade/tester.yue:0
local F = require('shunt.quicktype').F -- shunt/upgrade/tester.yue:0
local spec = require('shunt.spec').spec -- shunt/upgrade/tester.yue:0
local Tester -- shunt/upgrade/tester.yue:8
do -- shunt/upgrade/tester.yue:8
  local _class_0 -- shunt/upgrade/tester.yue:8
  local _base_0 = { -- shunt/upgrade/tester.yue:8
    test = F('(Release) => <boolean, ?string>', function(self, release) -- shunt/upgrade/tester.yue:9
      log(function() -- shunt/upgrade/tester.yue:10
        return 'testing...' -- shunt/upgrade/tester.yue:10
      end) -- shunt/upgrade/tester.yue:10
      log(function() -- shunt/upgrade/tester.yue:11
        return "writing " .. tostring(#release.content) .. " bytes into disk with " .. tostring(fs.getFreeSpace('/')) .. "/" .. tostring(fs.getCapacity('/')) .. " free space" -- shunt/upgrade/tester.yue:11
      end) -- shunt/upgrade/tester.yue:11
      local tmp_path = os.tmpname() -- shunt/upgrade/tester.yue:13
      do -- shunt/upgrade/tester.yue:14
        local _with_0 = assert(io.open(tmp_path, 'w+')) -- shunt/upgrade/tester.yue:14
        _with_0:write(release.content) -- shunt/upgrade/tester.yue:15
        assert(_with_0:close()) -- shunt/upgrade/tester.yue:16
      end -- shunt/upgrade/tester.yue:14
      local write_ok = false -- shunt/upgrade/tester.yue:17
      do -- shunt/upgrade/tester.yue:18
        local _with_0 = io.open(tmp_path, 'r') -- shunt/upgrade/tester.yue:18
        if _with_0 ~= nil then -- shunt/upgrade/tester.yue:18
          write_ok = release.content == _with_0:read('*a') -- shunt/upgrade/tester.yue:19
          assert(_with_0:close()) -- shunt/upgrade/tester.yue:20
        end -- shunt/upgrade/tester.yue:18
      end -- shunt/upgrade/tester.yue:18
      local testing_ok -- shunt/upgrade/tester.yue:21
      if write_ok then -- shunt/upgrade/tester.yue:22
        testing_ok = execute(tmp_path, 'test', '--force-error-on-bad-exit') -- shunt/upgrade/tester.yue:23
      end -- shunt/upgrade/tester.yue:22
      assert(os.remove(tmp_path)) -- shunt/upgrade/tester.yue:24
      if not write_ok then -- shunt/upgrade/tester.yue:26
        return false, "cannot test upgrade: could could not write file to disk" -- shunt/upgrade/tester.yue:27
      end -- shunt/upgrade/tester.yue:26
      if not testing_ok then -- shunt/upgrade/tester.yue:28
        return false, "testing failed" -- shunt/upgrade/tester.yue:29
      end -- shunt/upgrade/tester.yue:28
      return true, nil -- shunt/upgrade/tester.yue:30
    end) -- shunt/upgrade/tester.yue:8
  } -- shunt/upgrade/tester.yue:8
  if _base_0.__index == nil then -- shunt/upgrade/tester.yue:8
    _base_0.__index = _base_0 -- shunt/upgrade/tester.yue:8
  end -- shunt/upgrade/tester.yue:30
  _class_0 = setmetatable({ -- shunt/upgrade/tester.yue:8
    __init = function() end, -- shunt/upgrade/tester.yue:8
    __base = _base_0, -- shunt/upgrade/tester.yue:8
    __name = "Tester" -- shunt/upgrade/tester.yue:8
  }, { -- shunt/upgrade/tester.yue:8
    __index = _base_0, -- shunt/upgrade/tester.yue:8
    __call = function(cls, ...) -- shunt/upgrade/tester.yue:8
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/tester.yue:8
      cls.__init(_self_0, ...) -- shunt/upgrade/tester.yue:8
      return _self_0 -- shunt/upgrade/tester.yue:8
    end -- shunt/upgrade/tester.yue:8
  }) -- shunt/upgrade/tester.yue:8
  _base_0.__class = _class_0 -- shunt/upgrade/tester.yue:8
  Tester = _class_0 -- shunt/upgrade/tester.yue:8
end -- shunt/upgrade/tester.yue:30
_module_0["Tester"] = Tester -- shunt/upgrade/tester.yue:8
spec(function() -- shunt/upgrade/tester.yue:32
  local describe, it, matchers -- shunt/upgrade/tester.yue:0
  do -- shunt/upgrade/tester.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/upgrade/tester.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/upgrade/tester.yue:0
  end -- shunt/upgrade/tester.yue:0
  local eq, has_type = matchers.eq, matchers.has_type -- shunt/upgrade/tester.yue:37
  return describe('Tester', function() -- shunt/upgrade/tester.yue:39
    it('accepts valid releases', function() -- shunt/upgrade/tester.yue:40
      local release = { -- shunt/upgrade/tester.yue:42
        file = 'shunt', -- shunt/upgrade/tester.yue:42
        version = '12345', -- shunt/upgrade/tester.yue:43
        content = [[]] -- shunt/upgrade/tester.yue:44
      } -- shunt/upgrade/tester.yue:41
      local ok, err = Tester():test(release); -- shunt/upgrade/tester.yue:46
      require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(47)); -- shunt/upgrade/tester.yue:47
      return require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(48)) -- shunt/upgrade/tester.yue:48
    end) -- shunt/upgrade/tester.yue:40
    if _G.run_ugly_tests then -- shunt/upgrade/tester.yue:50
      it('rejects invalid releases', function() -- shunt/upgrade/tester.yue:58
        local release = { -- shunt/upgrade/tester.yue:60
          file = 'shunt', -- shunt/upgrade/tester.yue:60
          version = '12345', -- shunt/upgrade/tester.yue:61
          content = [[            error('MARKER_ERROR')
          ]] -- shunt/upgrade/tester.yue:62
        } -- shunt/upgrade/tester.yue:59
        local ok, err = Tester():test(release); -- shunt/upgrade/tester.yue:66
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(67)); -- shunt/upgrade/tester.yue:67
        return require('shunt.spec')._expect_that([=[err]=], err, (has_type('string')), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(68)) -- shunt/upgrade/tester.yue:68
      end) -- shunt/upgrade/tester.yue:58
      return it('executes the test command', function() -- shunt/upgrade/tester.yue:70
        local release = { -- shunt/upgrade/tester.yue:72
          file = 'frieght', -- shunt/upgrade/tester.yue:72
          version = '12345', -- shunt/upgrade/tester.yue:73
          content = [[            for i = 1, select('#', ...) do
              if select(i, ...) == 'test' then
                return
              end
            end
            error("must pass 'test' to shunt")
          ]] -- shunt/upgrade/tester.yue:74
        } -- shunt/upgrade/tester.yue:71
        local ok, err = Tester():test(release); -- shunt/upgrade/tester.yue:82
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(83)); -- shunt/upgrade/tester.yue:83
        return require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/upgrade/tester.yue") .. ":" .. tostring(84)) -- shunt/upgrade/tester.yue:84
      end) -- shunt/upgrade/tester.yue:84
    end -- shunt/upgrade/tester.yue:50
  end) -- shunt/upgrade/tester.yue:84
end) -- shunt/upgrade/tester.yue:32
return _module_0 -- shunt/upgrade/tester.yue:84
end
package.preload['shunt.execute'] = function(...)
-- [yue]: shunt/execute.yue
local _module_0 = { } -- shunt/execute.yue:1
local execute, execute_native, execute_minecraft -- shunt/execute.yue:1
local HOST, LUA -- shunt/execute.yue:0
do -- shunt/execute.yue:0
  local _obj_0 = require('shunt.compat') -- shunt/execute.yue:0
  HOST, LUA = _obj_0.HOST, _obj_0.LUA -- shunt/execute.yue:0
end -- shunt/execute.yue:0
local F = require('shunt.quicktype').F -- shunt/execute.yue:0
execute = F('(string, string...) -> boolean', function(prog, ...) -- shunt/execute.yue:6
  local cmd_parts = { -- shunt/execute.yue:7
    prog, -- shunt/execute.yue:7
    ... -- shunt/execute.yue:7
  } -- shunt/execute.yue:7
  for _index_0 = 1, #cmd_parts do -- shunt/execute.yue:8
    local cmd_part = cmd_parts[_index_0] -- shunt/execute.yue:8
    if cmd_part:match('["\']') then -- shunt/execute.yue:9
      error("cannot execute " .. tostring(prog) .. ": argument '" .. tostring(cmd_part) .. "' invalid") -- shunt/execute.yue:10
    end -- shunt/execute.yue:9
  end -- shunt/execute.yue:10
  if 'native' == HOST then -- shunt/execute.yue:13
    return execute_native(prog, ...) -- shunt/execute.yue:14
  elseif 'minecraft' == HOST then -- shunt/execute.yue:15
    return execute_minecraft(prog, ...) -- shunt/execute.yue:16
  else -- shunt/execute.yue:18
    return error("internal error: unknown host " .. tostring(HOST)) -- shunt/execute.yue:18
  end -- shunt/execute.yue:18
end) -- shunt/execute.yue:6
_module_0["execute"] = execute -- shunt/execute.yue:18
execute_native = F('(string, string...) -> boolean', function(...) -- shunt/execute.yue:20
  if _VERSION == 'Lua 5.1' then -- shunt/execute.yue:21
    local rc = os.execute(table.concat({ -- shunt/execute.yue:22
      LUA, -- shunt/execute.yue:22
      ... -- shunt/execute.yue:22
    }, ' ')) -- shunt/execute.yue:22
    return rc == 0 -- shunt/execute.yue:23
  end -- shunt/execute.yue:21
  local cmd = table.concat({ -- shunt/execute.yue:26
    LUA, -- shunt/execute.yue:26
    ... -- shunt/execute.yue:26
  }, ' ') -- shunt/execute.yue:26
  local ok -- shunt/execute.yue:27
  do -- shunt/execute.yue:28
    local _with_0 = assert(io.popen(cmd)) -- shunt/execute.yue:28
    _with_0:read('*a') -- shunt/execute.yue:29
    local _, _ -- shunt/execute.yue:30
    ok, _, _ = _with_0:close() -- shunt/execute.yue:30
  end -- shunt/execute.yue:28
  if ok ~= nil then -- shunt/execute.yue:31
    return ok -- shunt/execute.yue:31
  else -- shunt/execute.yue:31
    return false -- shunt/execute.yue:31
  end -- shunt/execute.yue:31
end) -- shunt/execute.yue:20
execute_minecraft = F('(string, string...) -> boolean', function(...) -- shunt/execute.yue:33
  local rc = shell.execute(...) -- shunt/execute.yue:34
  return rc -- shunt/execute.yue:35
end) -- shunt/execute.yue:33
return _module_0 -- shunt/execute.yue:35
end
package.preload['shunt.upgrade.monitor'] = function(...)
-- [yue]: shunt/upgrade/monitor.yue
local _module_0 = { } -- shunt/upgrade/monitor.yue:1
local CurrentReleaseRequest -- shunt/upgrade/monitor.yue:2
local CurrentReleaseResponse -- shunt/upgrade/monitor.yue:3
local log, trace -- shunt/upgrade/monitor.yue:0
do -- shunt/upgrade/monitor.yue:0
  local _obj_0 = require('shunt.logger') -- shunt/upgrade/monitor.yue:0
  log, trace = _obj_0.log, _obj_0.trace -- shunt/upgrade/monitor.yue:0
end -- shunt/upgrade/monitor.yue:0
local IdempotenceToken, Packet, TIMEOUT -- shunt/upgrade/monitor.yue:0
do -- shunt/upgrade/monitor.yue:0
  local _obj_0 = require('shunt.peripheral.uplink') -- shunt/upgrade/monitor.yue:0
  IdempotenceToken, Packet, TIMEOUT = _obj_0.IdempotenceToken, _obj_0.Packet, _obj_0.TIMEOUT -- shunt/upgrade/monitor.yue:0
end -- shunt/upgrade/monitor.yue:0
local declare_type, F -- shunt/upgrade/monitor.yue:0
do -- shunt/upgrade/monitor.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/upgrade/monitor.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/upgrade/monitor.yue:0
end -- shunt/upgrade/monitor.yue:0
local VERSION = require('shunt.version').VERSION -- shunt/upgrade/monitor.yue:0
declare_type('UpgradeMonitorConfig', [[{
  marshal: ?{},
}]]) -- shunt/upgrade/monitor.yue:10
declare_type('UpgradeMonitorOpts', [[{
  config: UpgradeMonitorConfig,
  pc: Pc,
  uplink: Uplink,
}]]) -- shunt/upgrade/monitor.yue:13
local UpgradeMonitor -- shunt/upgrade/monitor.yue:18
do -- shunt/upgrade/monitor.yue:18
  local _class_0 -- shunt/upgrade/monitor.yue:18
  local _base_0 = { -- shunt/upgrade/monitor.yue:18
    upgrade_available = F('() => boolean', function(self) -- shunt/upgrade/monitor.yue:31
      if self.is_marshal then -- shunt/upgrade/monitor.yue:32
        return false -- shunt/upgrade/monitor.yue:33
      end -- shunt/upgrade/monitor.yue:32
      local release = self:get_latest_release() -- shunt/upgrade/monitor.yue:35
      if release.version <= VERSION then -- shunt/upgrade/monitor.yue:36
        return false -- shunt/upgrade/monitor.yue:37
      end -- shunt/upgrade/monitor.yue:36
      self.new_release = release -- shunt/upgrade/monitor.yue:38
      return true -- shunt/upgrade/monitor.yue:39
    end), -- shunt/upgrade/monitor.yue:41
    upgrade_now = F('() => !', function(self) -- shunt/upgrade/monitor.yue:41
      log(function() -- shunt/upgrade/monitor.yue:42
        return "upgrading to version " .. tostring(self.new_release.version) -- shunt/upgrade/monitor.yue:42
      end) -- shunt/upgrade/monitor.yue:42
      self.uplink:deafen() -- shunt/upgrade/monitor.yue:43
      do -- shunt/upgrade/monitor.yue:44
        local _with_0 = assert(io.open(self.new_release.file, 'w+')) -- shunt/upgrade/monitor.yue:44
        _with_0:write(self.new_release.content) -- shunt/upgrade/monitor.yue:45
        assert(_with_0:close()) -- shunt/upgrade/monitor.yue:46
      end -- shunt/upgrade/monitor.yue:44
      return os.reboot() -- shunt/upgrade/monitor.yue:47
    end), -- shunt/upgrade/monitor.yue:49
    get_latest_release = F('() => Release', function(self) -- shunt/upgrade/monitor.yue:49
      local attempt = 0 -- shunt/upgrade/monitor.yue:50
      local idemp_tok = IdempotenceToken() -- shunt/upgrade/monitor.yue:51
      while true do -- shunt/upgrade/monitor.yue:52
        local _continue_0 = false -- shunt/upgrade/monitor.yue:53
        repeat -- shunt/upgrade/monitor.yue:53
          attempt = attempt + 1 -- shunt/upgrade/monitor.yue:53
          if attempt > 1 then -- shunt/upgrade/monitor.yue:54
            trace("getting release from marshal, attempt " .. tostring(attempt)) -- shunt/upgrade/monitor.yue:55
          end -- shunt/upgrade/monitor.yue:54
          self.uplink:broadcast(CurrentReleaseRequest(idemp_tok, self.pc:id())) -- shunt/upgrade/monitor.yue:57
          local marshal_id, pkt_or_err = self.uplink:receive_from_any(CurrentReleaseResponse, { -- shunt/upgrade/monitor.yue:58
            timeout = 10 -- shunt/upgrade/monitor.yue:58
          }) -- shunt/upgrade/monitor.yue:58
          if not (marshal_id ~= nil) then -- shunt/upgrade/monitor.yue:59
            if pkt_or_err ~= TIMEOUT then -- shunt/upgrade/monitor.yue:60
              trace("ignoring error whilst getting update: " .. tostring(pkt_or_err)) -- shunt/upgrade/monitor.yue:61
              os.sleep((math.random(1000)) / 100) -- shunt/upgrade/monitor.yue:63
            else -- shunt/upgrade/monitor.yue:65
              trace('TIMEOUT') -- shunt/upgrade/monitor.yue:65
            end -- shunt/upgrade/monitor.yue:60
            _continue_0 = true -- shunt/upgrade/monitor.yue:66
            break -- shunt/upgrade/monitor.yue:66
          end -- shunt/upgrade/monitor.yue:59
          if pkt_or_err.idemp_tok == idemp_tok then -- shunt/upgrade/monitor.yue:67
            trace("got release!") -- shunt/upgrade/monitor.yue:68
            return pkt_or_err.release -- shunt/upgrade/monitor.yue:69
          end -- shunt/upgrade/monitor.yue:67
          trace("expected " .. tostring(idemp_tok) .. " but got " .. tostring(pkt_or_err.idemp_tok) .. " (match? " .. tostring(pkt_or_err.idemp_tok == idemp_tok) .. ")") -- shunt/upgrade/monitor.yue:70
          _continue_0 = true -- shunt/upgrade/monitor.yue:53
        until true -- shunt/upgrade/monitor.yue:70
        if not _continue_0 then -- shunt/upgrade/monitor.yue:70
          break -- shunt/upgrade/monitor.yue:70
        end -- shunt/upgrade/monitor.yue:70
      end -- shunt/upgrade/monitor.yue:70
    end) -- shunt/upgrade/monitor.yue:18
  } -- shunt/upgrade/monitor.yue:18
  if _base_0.__index == nil then -- shunt/upgrade/monitor.yue:18
    _base_0.__index = _base_0 -- shunt/upgrade/monitor.yue:18
  end -- shunt/upgrade/monitor.yue:70
  _class_0 = setmetatable({ -- shunt/upgrade/monitor.yue:18
    __init = F('(UpgradeMonitorOpts) => <>', function(self, opts) -- shunt/upgrade/monitor.yue:19
      local config, pc, uplink = opts.config, opts.pc, opts.uplink -- shunt/upgrade/monitor.yue:20
      self.pc = pc -- shunt/upgrade/monitor.yue:25
      self.uplink = uplink -- shunt/upgrade/monitor.yue:26
      self.is_marshal = (config.marshal ~= nil) -- shunt/upgrade/monitor.yue:28
      self.new_release = nil -- shunt/upgrade/monitor.yue:29
    end), -- shunt/upgrade/monitor.yue:18
    __base = _base_0, -- shunt/upgrade/monitor.yue:18
    __name = "UpgradeMonitor" -- shunt/upgrade/monitor.yue:18
  }, { -- shunt/upgrade/monitor.yue:18
    __index = _base_0, -- shunt/upgrade/monitor.yue:18
    __call = function(cls, ...) -- shunt/upgrade/monitor.yue:18
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/monitor.yue:18
      cls.__init(_self_0, ...) -- shunt/upgrade/monitor.yue:18
      return _self_0 -- shunt/upgrade/monitor.yue:18
    end -- shunt/upgrade/monitor.yue:18
  }) -- shunt/upgrade/monitor.yue:18
  _base_0.__class = _class_0 -- shunt/upgrade/monitor.yue:18
  UpgradeMonitor = _class_0 -- shunt/upgrade/monitor.yue:18
end -- shunt/upgrade/monitor.yue:70
_module_0["UpgradeMonitor"] = UpgradeMonitor -- shunt/upgrade/monitor.yue:18
declare_type('CurrentReleaseRequest', [[{
  idemp_tok: number,
  pc_id: number,
}]]) -- shunt/upgrade/monitor.yue:72
do -- shunt/upgrade/monitor.yue:76
  local _class_0 -- shunt/upgrade/monitor.yue:76
  local _parent_0 = Packet -- shunt/upgrade/monitor.yue:76
  local _base_0 = { } -- shunt/upgrade/monitor.yue:76
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/upgrade/monitor.yue:78
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/upgrade/monitor.yue:76
      _base_0[_key_0] = _val_0 -- shunt/upgrade/monitor.yue:76
    end -- shunt/upgrade/monitor.yue:76
  end -- shunt/upgrade/monitor.yue:78
  if _base_0.__index == nil then -- shunt/upgrade/monitor.yue:76
    _base_0.__index = _base_0 -- shunt/upgrade/monitor.yue:76
  end -- shunt/upgrade/monitor.yue:78
  setmetatable(_base_0, _parent_0.__base) -- shunt/upgrade/monitor.yue:76
  _class_0 = setmetatable({ -- shunt/upgrade/monitor.yue:76
    __init = F('(IdempotenceToken, number) => <>', function(self, idemp_tok, pc_id) -- shunt/upgrade/monitor.yue:77
      self.idemp_tok = idemp_tok -- shunt/upgrade/monitor.yue:77
      self.pc_id = pc_id -- shunt/upgrade/monitor.yue:77
      return _class_0.__parent.__init(self) -- shunt/upgrade/monitor.yue:78
    end), -- shunt/upgrade/monitor.yue:76
    __base = _base_0, -- shunt/upgrade/monitor.yue:76
    __name = "CurrentReleaseRequest", -- shunt/upgrade/monitor.yue:76
    __parent = _parent_0 -- shunt/upgrade/monitor.yue:76
  }, { -- shunt/upgrade/monitor.yue:76
    __index = function(cls, name) -- shunt/upgrade/monitor.yue:76
      local val = rawget(_base_0, name) -- shunt/upgrade/monitor.yue:76
      if val == nil then -- shunt/upgrade/monitor.yue:76
        local parent = rawget(cls, "__parent") -- shunt/upgrade/monitor.yue:76
        if parent then -- shunt/upgrade/monitor.yue:76
          return parent[name] -- shunt/upgrade/monitor.yue:76
        end -- shunt/upgrade/monitor.yue:76
      else -- shunt/upgrade/monitor.yue:76
        return val -- shunt/upgrade/monitor.yue:76
      end -- shunt/upgrade/monitor.yue:76
    end, -- shunt/upgrade/monitor.yue:76
    __call = function(cls, ...) -- shunt/upgrade/monitor.yue:76
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/monitor.yue:76
      cls.__init(_self_0, ...) -- shunt/upgrade/monitor.yue:76
      return _self_0 -- shunt/upgrade/monitor.yue:76
    end -- shunt/upgrade/monitor.yue:76
  }) -- shunt/upgrade/monitor.yue:76
  _base_0.__class = _class_0 -- shunt/upgrade/monitor.yue:76
  if _parent_0.__inherited then -- shunt/upgrade/monitor.yue:76
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/upgrade/monitor.yue:76
  end -- shunt/upgrade/monitor.yue:76
  CurrentReleaseRequest = _class_0 -- shunt/upgrade/monitor.yue:76
end -- shunt/upgrade/monitor.yue:78
_module_0["CurrentReleaseRequest"] = CurrentReleaseRequest -- shunt/upgrade/monitor.yue:76
do -- shunt/upgrade/monitor.yue:80
  local _class_0 -- shunt/upgrade/monitor.yue:80
  local _parent_0 = Packet -- shunt/upgrade/monitor.yue:80
  local _base_0 = { } -- shunt/upgrade/monitor.yue:80
  for _key_0, _val_0 in pairs(_parent_0.__base) do -- shunt/upgrade/monitor.yue:82
    if _base_0[_key_0] == nil and _key_0:match("^__") and not (_key_0 == "__index" and _val_0 == _parent_0.__base) then -- shunt/upgrade/monitor.yue:80
      _base_0[_key_0] = _val_0 -- shunt/upgrade/monitor.yue:80
    end -- shunt/upgrade/monitor.yue:80
  end -- shunt/upgrade/monitor.yue:82
  if _base_0.__index == nil then -- shunt/upgrade/monitor.yue:80
    _base_0.__index = _base_0 -- shunt/upgrade/monitor.yue:80
  end -- shunt/upgrade/monitor.yue:82
  setmetatable(_base_0, _parent_0.__base) -- shunt/upgrade/monitor.yue:80
  _class_0 = setmetatable({ -- shunt/upgrade/monitor.yue:80
    __init = F('(IdempotenceToken, Release) => <>', function(self, idemp_tok, release) -- shunt/upgrade/monitor.yue:81
      self.idemp_tok = idemp_tok -- shunt/upgrade/monitor.yue:81
      self.release = release -- shunt/upgrade/monitor.yue:81
      return _class_0.__parent.__init(self) -- shunt/upgrade/monitor.yue:82
    end), -- shunt/upgrade/monitor.yue:80
    __base = _base_0, -- shunt/upgrade/monitor.yue:80
    __name = "CurrentReleaseResponse", -- shunt/upgrade/monitor.yue:80
    __parent = _parent_0 -- shunt/upgrade/monitor.yue:80
  }, { -- shunt/upgrade/monitor.yue:80
    __index = function(cls, name) -- shunt/upgrade/monitor.yue:80
      local val = rawget(_base_0, name) -- shunt/upgrade/monitor.yue:80
      if val == nil then -- shunt/upgrade/monitor.yue:80
        local parent = rawget(cls, "__parent") -- shunt/upgrade/monitor.yue:80
        if parent then -- shunt/upgrade/monitor.yue:80
          return parent[name] -- shunt/upgrade/monitor.yue:80
        end -- shunt/upgrade/monitor.yue:80
      else -- shunt/upgrade/monitor.yue:80
        return val -- shunt/upgrade/monitor.yue:80
      end -- shunt/upgrade/monitor.yue:80
    end, -- shunt/upgrade/monitor.yue:80
    __call = function(cls, ...) -- shunt/upgrade/monitor.yue:80
      local _self_0 = setmetatable({ }, _base_0) -- shunt/upgrade/monitor.yue:80
      cls.__init(_self_0, ...) -- shunt/upgrade/monitor.yue:80
      return _self_0 -- shunt/upgrade/monitor.yue:80
    end -- shunt/upgrade/monitor.yue:80
  }) -- shunt/upgrade/monitor.yue:80
  _base_0.__class = _class_0 -- shunt/upgrade/monitor.yue:80
  if _parent_0.__inherited then -- shunt/upgrade/monitor.yue:80
    _parent_0.__inherited(_parent_0, _class_0) -- shunt/upgrade/monitor.yue:80
  end -- shunt/upgrade/monitor.yue:80
  CurrentReleaseResponse = _class_0 -- shunt/upgrade/monitor.yue:80
end -- shunt/upgrade/monitor.yue:82
_module_0["CurrentReleaseResponse"] = CurrentReleaseResponse -- shunt/upgrade/monitor.yue:80
return _module_0 -- shunt/upgrade/monitor.yue:82
end
package.preload['shunt.cmd.disable'] = function(...)
-- [yue]: shunt/cmd/disable.yue
local _module_0 = { } -- shunt/cmd/disable.yue:1
local subcommand, main, remove_files -- shunt/cmd/disable.yue:1
local Flag, Subcommand -- shunt/cmd/disable.yue:0
do -- shunt/cmd/disable.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/disable.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/cmd/disable.yue:0
end -- shunt/cmd/disable.yue:0
local _startup_script = require('shunt.cmd.enable')._startup_script -- shunt/cmd/disable.yue:0
local F = require('shunt.quicktype').F -- shunt/cmd/disable.yue:0
do -- shunt/cmd/disable.yue:7
  local _with_0 = Subcommand('disable') -- shunt/cmd/disable.yue:7
  _with_0:description('disable shunt on startup') -- shunt/cmd/disable.yue:8
  _with_0:add((function() -- shunt/cmd/disable.yue:9
    local _with_1 = Flag('force') -- shunt/cmd/disable.yue:9
    _with_1:description('delete edited config') -- shunt/cmd/disable.yue:10
    return _with_1 -- shunt/cmd/disable.yue:9
  end)()) -- shunt/cmd/disable.yue:9
  subcommand = _with_0 -- shunt/cmd/disable.yue:7
end -- shunt/cmd/disable.yue:7
_module_0["subcommand"] = subcommand -- shunt/cmd/disable.yue:10
main = F('({}) -> <>', function(args) -- shunt/cmd/disable.yue:12
  if args.force then -- shunt/cmd/disable.yue:13
    remove_files(true) -- shunt/cmd/disable.yue:14
    return -- shunt/cmd/disable.yue:15
  end -- shunt/cmd/disable.yue:13
  local content -- shunt/cmd/disable.yue:17
  do -- shunt/cmd/disable.yue:18
    local _with_0 = io.open('startup.lua', 'r') -- shunt/cmd/disable.yue:18
    if _with_0 ~= nil then -- shunt/cmd/disable.yue:18
      content = assert(_with_0:read('*a')) -- shunt/cmd/disable.yue:19
      assert(_with_0:close()) -- shunt/cmd/disable.yue:20
    end -- shunt/cmd/disable.yue:18
  end -- shunt/cmd/disable.yue:18
  if not (content ~= nil) then -- shunt/cmd/disable.yue:21
    print('cannot disable shunt: startup.lua missing') -- shunt/cmd/disable.yue:22
    return -- shunt/cmd/disable.yue:23
  end -- shunt/cmd/disable.yue:21
  if content ~= _startup_script then -- shunt/cmd/disable.yue:25
    print('cannot disable shunt: startup script contains changes\nrerun with --force to delete anyway') -- shunt/cmd/disable.yue:26
    return -- shunt/cmd/disable.yue:27
  end -- shunt/cmd/disable.yue:25
  remove_files(false) -- shunt/cmd/disable.yue:29
  return -- shunt/cmd/disable.yue:30
end) -- shunt/cmd/disable.yue:12
_module_0["main"] = main -- shunt/cmd/disable.yue:30
remove_files = F('(boolean) -> <>', function(force) -- shunt/cmd/disable.yue:32
  local remove_with_force -- shunt/cmd/disable.yue:33
  if force then -- shunt/cmd/disable.yue:33
    remove_with_force = function(path) -- shunt/cmd/disable.yue:34
      os.remove(path) -- shunt/cmd/disable.yue:35
      return -- shunt/cmd/disable.yue:36
    end -- shunt/cmd/disable.yue:34
  else -- shunt/cmd/disable.yue:38
    remove_with_force = function(path) -- shunt/cmd/disable.yue:38
      assert((os.remove(path)), "cannot remove " .. tostring(path)) -- shunt/cmd/disable.yue:39
      return -- shunt/cmd/disable.yue:40
    end -- shunt/cmd/disable.yue:38
  end -- shunt/cmd/disable.yue:33
  remove_with_force('startup.lua') -- shunt/cmd/disable.yue:42
  return remove_with_force('shunt.toml') -- shunt/cmd/disable.yue:43
end) -- shunt/cmd/disable.yue:32
return _module_0 -- shunt/cmd/disable.yue:43
end
package.preload['shunt.cmd.enable'] = function(...)
-- [yue]: shunt/cmd/enable.yue
local _module_0 = { } -- shunt/cmd/enable.yue:1
local subcommand, main, _startup_script -- shunt/cmd/enable.yue:1
local Flag, Subcommand -- shunt/cmd/enable.yue:0
do -- shunt/cmd/enable.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/enable.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/cmd/enable.yue:0
end -- shunt/cmd/enable.yue:0
local F = require('shunt.quicktype').F -- shunt/cmd/enable.yue:0
do -- shunt/cmd/enable.yue:6
  local _with_0 = Subcommand('enable') -- shunt/cmd/enable.yue:6
  _with_0:description('enable shunt on startup') -- shunt/cmd/enable.yue:7
  _with_0:add((function() -- shunt/cmd/enable.yue:8
    local _with_1 = Flag('force') -- shunt/cmd/enable.yue:8
    _with_1:description('overwrite existing config') -- shunt/cmd/enable.yue:9
    return _with_1 -- shunt/cmd/enable.yue:8
  end)()) -- shunt/cmd/enable.yue:8
  _with_0:add((function() -- shunt/cmd/enable.yue:10
    local _with_1 = Flag('start') -- shunt/cmd/enable.yue:10
    _with_1:short(nil) -- shunt/cmd/enable.yue:11
    _with_1:description('start running immediately') -- shunt/cmd/enable.yue:12
    return _with_1 -- shunt/cmd/enable.yue:10
  end)()) -- shunt/cmd/enable.yue:10
  subcommand = _with_0 -- shunt/cmd/enable.yue:6
end -- shunt/cmd/enable.yue:6
_module_0["subcommand"] = subcommand -- shunt/cmd/enable.yue:12
main = F('({}) -> <>', function(args) -- shunt/cmd/enable.yue:14
  if not args.force then -- shunt/cmd/enable.yue:15
    do -- shunt/cmd/enable.yue:16
      local _with_0 = io.open('startup.lua', 'r') -- shunt/cmd/enable.yue:16
      if _with_0 ~= nil then -- shunt/cmd/enable.yue:16
        _with_0:close() -- shunt/cmd/enable.yue:17
        print('cannot enable shunt: existing startup script detected\nre-run with --force to overwrite') -- shunt/cmd/enable.yue:18
        return -- shunt/cmd/enable.yue:19
      end -- shunt/cmd/enable.yue:16
    end -- shunt/cmd/enable.yue:16
  end -- shunt/cmd/enable.yue:15
  do -- shunt/cmd/enable.yue:21
    local _with_0 = assert(io.open('startup.lua', 'w+')) -- shunt/cmd/enable.yue:21
    assert(_with_0:write(_startup_script)) -- shunt/cmd/enable.yue:22
    assert(_with_0:close()) -- shunt/cmd/enable.yue:23
  end -- shunt/cmd/enable.yue:21
  if args.start then -- shunt/cmd/enable.yue:25
    do -- shunt/cmd/enable.yue:26
      local _obj_0 = os.reboot -- shunt/cmd/enable.yue:26
      if _obj_0 ~= nil then -- shunt/cmd/enable.yue:26
        _obj_0() -- shunt/cmd/enable.yue:26
      end -- shunt/cmd/enable.yue:26
    end -- shunt/cmd/enable.yue:26
  end -- shunt/cmd/enable.yue:25
  return -- shunt/cmd/enable.yue:27
end) -- shunt/cmd/enable.yue:14
_module_0["main"] = main -- shunt/cmd/enable.yue:27
_startup_script = [[settings.set('motd.enable', false)
shell.run('shunt start')
]] -- shunt/cmd/enable.yue:29
_module_0["_startup_script"] = _startup_script -- shunt/cmd/enable.yue:32
return _module_0 -- shunt/cmd/enable.yue:32
end
package.preload['shunt.cmd.edit'] = function(...)
-- [yue]: shunt/cmd/edit.yue
local _module_0 = { } -- shunt/cmd/edit.yue:1
local subcommand, main -- shunt/cmd/edit.yue:1
local Flag, Param, Subcommand -- shunt/cmd/edit.yue:0
do -- shunt/cmd/edit.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/edit.yue:0
  Flag, Param, Subcommand = _obj_0.Flag, _obj_0.Param, _obj_0.Subcommand -- shunt/cmd/edit.yue:0
end -- shunt/cmd/edit.yue:0
local Configurator = require('shunt.configurator.main').Configurator -- shunt/cmd/edit.yue:0
local declare_type, F -- shunt/cmd/edit.yue:0
do -- shunt/cmd/edit.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/edit.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/cmd/edit.yue:0
end -- shunt/cmd/edit.yue:0
do -- shunt/cmd/edit.yue:7
  local _with_0 = Subcommand('edit') -- shunt/cmd/edit.yue:7
  _with_0:description('remotely configure a shunt instance') -- shunt/cmd/edit.yue:8
  _with_0:add((function() -- shunt/cmd/edit.yue:9
    local _with_1 = Subcommand('marshal') -- shunt/cmd/edit.yue:9
    _with_1:description('edit the marshal') -- shunt/cmd/edit.yue:10
    return _with_1 -- shunt/cmd/edit.yue:9
  end)()) -- shunt/cmd/edit.yue:9
  _with_0:add((function() -- shunt/cmd/edit.yue:11
    local _with_1 = Subcommand('factory') -- shunt/cmd/edit.yue:11
    _with_1:description('edit a factory') -- shunt/cmd/edit.yue:12
    _with_1:add((function() -- shunt/cmd/edit.yue:13
      local _with_2 = Param('which') -- shunt/cmd/edit.yue:13
      _with_2:description('the name of the factory to edit') -- shunt/cmd/edit.yue:14
      return _with_2 -- shunt/cmd/edit.yue:13
    end)()) -- shunt/cmd/edit.yue:13
    return _with_1 -- shunt/cmd/edit.yue:11
  end)()) -- shunt/cmd/edit.yue:11
  subcommand = _with_0 -- shunt/cmd/edit.yue:7
end -- shunt/cmd/edit.yue:7
_module_0["subcommand"] = subcommand -- shunt/cmd/edit.yue:14
declare_type('EditArgs', [[{
  marshal: ?EditMarshalArgs,
  factory: ?EditFactoryArgs,
}]]) -- shunt/cmd/edit.yue:16
declare_type('EditMarshalArgs', '{}') -- shunt/cmd/edit.yue:20
declare_type('EditFactoryArgs', [[{
  which: string,
}]]) -- shunt/cmd/edit.yue:21
main = F('(EditArgs) -> <>', function(args) -- shunt/cmd/edit.yue:24
  local configurator = Configurator() -- shunt/cmd/edit.yue:25
  local what -- shunt/cmd/edit.yue:27
  if (args.marshal ~= nil) then -- shunt/cmd/edit.yue:27
    what = 'marshal' -- shunt/cmd/edit.yue:28
  else -- shunt/cmd/edit.yue:30
    what = args.factory.which -- shunt/cmd/edit.yue:30
  end -- shunt/cmd/edit.yue:27
  local id, err = configurator:get_pc_id(what) -- shunt/cmd/edit.yue:31
  if (err ~= nil) then -- shunt/cmd/edit.yue:32
    print(err) -- shunt/cmd/edit.yue:33
    return -- shunt/cmd/edit.yue:34
  end -- shunt/cmd/edit.yue:32
  err = configurator:configure(id) -- shunt/cmd/edit.yue:36
  if (err ~= nil) then -- shunt/cmd/edit.yue:37
    print(err) -- shunt/cmd/edit.yue:38
    return -- shunt/cmd/edit.yue:39
  end -- shunt/cmd/edit.yue:37
end) -- shunt/cmd/edit.yue:24
_module_0["main"] = main -- shunt/cmd/edit.yue:39
return _module_0 -- shunt/cmd/edit.yue:39
end
package.preload['shunt.cmd.flash'] = function(...)
-- [yue]: shunt/cmd/flash.yue
local _module_0 = { } -- shunt/cmd/flash.yue:1
local subcommand, main, ShuntFlasher, startup_script -- shunt/cmd/flash.yue:1
local Param, Subcommand -- shunt/cmd/flash.yue:0
do -- shunt/cmd/flash.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/flash.yue:0
  Param, Subcommand = _obj_0.Param, _obj_0.Subcommand -- shunt/cmd/flash.yue:0
end -- shunt/cmd/flash.yue:0
local Drive = require('shunt.peripheral.drive').Drive -- shunt/cmd/flash.yue:0
local declare_type, F -- shunt/cmd/flash.yue:0
do -- shunt/cmd/flash.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/flash.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/cmd/flash.yue:0
end -- shunt/cmd/flash.yue:0
local spec = require('shunt.spec').spec -- shunt/cmd/flash.yue:0
do -- shunt/cmd/flash.yue:8
  local _with_0 = Subcommand('flash') -- shunt/cmd/flash.yue:8
  _with_0:description('create an installer disk') -- shunt/cmd/flash.yue:9
  _with_0:add((function() -- shunt/cmd/flash.yue:10
    local _with_1 = Param('drive') -- shunt/cmd/flash.yue:10
    _with_1:description('the drive containing the disk to flash. If omitted, shunt searches for a drive') -- shunt/cmd/flash.yue:11
    _with_1:default(nil) -- shunt/cmd/flash.yue:12
    return _with_1 -- shunt/cmd/flash.yue:10
  end)()) -- shunt/cmd/flash.yue:10
  subcommand = _with_0 -- shunt/cmd/flash.yue:8
end -- shunt/cmd/flash.yue:8
_module_0["subcommand"] = subcommand -- shunt/cmd/flash.yue:12
declare_type('FlashArgs', [[{
  drive: ?string,
}]]) -- shunt/cmd/flash.yue:14
main = F('(FlashArgs) -> <>', function(args) -- shunt/cmd/flash.yue:17
  local drive = args.drive -- shunt/cmd/flash.yue:18
xpcall(function() -- shunt/cmd/flash.yue:20
    local flasher = ShuntFlasher(Drive(drive)) -- shunt/cmd/flash.yue:21
    return flasher:flash() -- shunt/cmd/flash.yue:22
  end, function(err) -- shunt/cmd/flash.yue:22
    return print(err) -- shunt/cmd/flash.yue:24
  end) -- shunt/cmd/flash.yue:24
  return -- shunt/cmd/flash.yue:25
end) -- shunt/cmd/flash.yue:17
_module_0["main"] = main -- shunt/cmd/flash.yue:25
do -- shunt/cmd/flash.yue:27
  local _class_0 -- shunt/cmd/flash.yue:27
  local _base_0 = { -- shunt/cmd/flash.yue:27
    flash = F('(?string) => <>', function(self, input_dir) -- shunt/cmd/flash.yue:32
      if input_dir == nil then -- shunt/cmd/flash.yue:32
        input_dir = '' -- shunt/cmd/flash.yue:32
      end -- shunt/cmd/flash.yue:32
      if not self.drive:set_disk_label(self.__class.label) then -- shunt/cmd/flash.yue:33
        error('cannot flash disk: cannot set disk label') -- shunt/cmd/flash.yue:34
      end -- shunt/cmd/flash.yue:33
      local current_label = self.drive:disk_label() -- shunt/cmd/flash.yue:35
      if not (current_label ~= nil) then -- shunt/cmd/flash.yue:36
        error('cannot flash disk: no disk present') -- shunt/cmd/flash.yue:37
      end -- shunt/cmd/flash.yue:36
      if current_label ~= self.__class.label then -- shunt/cmd/flash.yue:38
        error('cannot flash disk: cannot set disk label') -- shunt/cmd/flash.yue:39
      end -- shunt/cmd/flash.yue:38
      local mount_path = self.drive:mount_path() -- shunt/cmd/flash.yue:41
      if not (mount_path ~= nil) then -- shunt/cmd/flash.yue:42
        error('cannot flash disk: not mounted') -- shunt/cmd/flash.yue:43
      end -- shunt/cmd/flash.yue:42
      local shunt_content -- shunt/cmd/flash.yue:44
      do -- shunt/cmd/flash.yue:44
        do -- shunt/cmd/flash.yue:45
          local _with_0 = assert(io.open(tostring(input_dir) .. "/shunt", 'r')) -- shunt/cmd/flash.yue:45
          shunt_content = assert(_with_0:read('*a')) -- shunt/cmd/flash.yue:46
          assert(_with_0:close()) -- shunt/cmd/flash.yue:47
        end -- shunt/cmd/flash.yue:45
        shunt_content = shunt_content -- shunt/cmd/flash.yue:48
      end -- shunt/cmd/flash.yue:48
      local startup_script_content = startup_script(self.__class.label) -- shunt/cmd/flash.yue:50
      local disk_free_space = fs.getFreeSpace(mount_path) -- shunt/cmd/flash.yue:52
      local required_disk_space = #shunt_content + #startup_script_content -- shunt/cmd/flash.yue:53
      if disk_free_space < required_disk_space then -- shunt/cmd/flash.yue:54
        error("cannot flash disk: insufficient space, need " .. tostring(required_disk_space) .. "B but only " .. tostring(disk_free_space) .. "B available") -- shunt/cmd/flash.yue:55
      end -- shunt/cmd/flash.yue:54
      do -- shunt/cmd/flash.yue:57
        local _with_0 = assert(io.open(tostring(mount_path) .. "/shunt", 'w+')) -- shunt/cmd/flash.yue:57
        assert(_with_0:write(shunt_content)) -- shunt/cmd/flash.yue:58
        assert(_with_0:close()) -- shunt/cmd/flash.yue:59
      end -- shunt/cmd/flash.yue:57
      do -- shunt/cmd/flash.yue:61
        local _with_0 = assert(io.open(tostring(mount_path) .. "/startup.lua", 'w+')) -- shunt/cmd/flash.yue:61
        assert(_with_0:write(startup_script_content)) -- shunt/cmd/flash.yue:62
        assert(_with_0:close()) -- shunt/cmd/flash.yue:63
      end -- shunt/cmd/flash.yue:61
      return -- shunt/cmd/flash.yue:64
    end) -- shunt/cmd/flash.yue:27
  } -- shunt/cmd/flash.yue:27
  if _base_0.__index == nil then -- shunt/cmd/flash.yue:27
    _base_0.__index = _base_0 -- shunt/cmd/flash.yue:27
  end -- shunt/cmd/flash.yue:64
  _class_0 = setmetatable({ -- shunt/cmd/flash.yue:27
    __init = F('(Drive) => <>', function(self, drive) -- shunt/cmd/flash.yue:28
      self.drive = drive -- shunt/cmd/flash.yue:28
    end), -- shunt/cmd/flash.yue:27
    __base = _base_0, -- shunt/cmd/flash.yue:27
    __name = "ShuntFlasher" -- shunt/cmd/flash.yue:27
  }, { -- shunt/cmd/flash.yue:27
    __index = _base_0, -- shunt/cmd/flash.yue:27
    __call = function(cls, ...) -- shunt/cmd/flash.yue:27
      local _self_0 = setmetatable({ }, _base_0) -- shunt/cmd/flash.yue:27
      cls.__init(_self_0, ...) -- shunt/cmd/flash.yue:27
      return _self_0 -- shunt/cmd/flash.yue:27
    end -- shunt/cmd/flash.yue:27
  }) -- shunt/cmd/flash.yue:27
  _base_0.__class = _class_0 -- shunt/cmd/flash.yue:27
  local self = _class_0; -- shunt/cmd/flash.yue:27
  self.label = 'shunt installer' -- shunt/cmd/flash.yue:30
  ShuntFlasher = _class_0 -- shunt/cmd/flash.yue:27
end -- shunt/cmd/flash.yue:64
startup_script = F('(string) -> string', function(label) -- shunt/cmd/flash.yue:66
  local lines = { -- shunt/cmd/flash.yue:68
    "term.clear()", -- shunt/cmd/flash.yue:68
    "term.setCursorPos(1, 1)", -- shunt/cmd/flash.yue:69
    "local installer_header = '--- shunt installer ---'", -- shunt/cmd/flash.yue:70
    "print(('-'):rep(#installer_header))", -- shunt/cmd/flash.yue:71
    "print(installer_header)", -- shunt/cmd/flash.yue:72
    "print(('-'):rep(#installer_header))", -- shunt/cmd/flash.yue:73
    "print('')", -- shunt/cmd/flash.yue:74
    "print('Welcome to the shunt installer!')", -- shunt/cmd/flash.yue:75
    "while true do", -- shunt/cmd/flash.yue:76
    "  print('')", -- shunt/cmd/flash.yue:77
    "  print('Options:')", -- shunt/cmd/flash.yue:78
    "  print(\"* To install shunt, type `y' then hit <enter>\")", -- shunt/cmd/flash.yue:79
    "  print(\"* To cancel, type `n' then hit <enter>\")", -- shunt/cmd/flash.yue:80
    "  print('')", -- shunt/cmd/flash.yue:81
    "  io.write('$ ')", -- shunt/cmd/flash.yue:82
    "  local resp = io.read('*l'):sub(1, 1):lower()", -- shunt/cmd/flash.yue:83
    "  print('')", -- shunt/cmd/flash.yue:84
    "", -- shunt/cmd/flash.yue:85
    "  if resp == 'y' then", -- shunt/cmd/flash.yue:86
    "    break", -- shunt/cmd/flash.yue:87
    "  elseif resp == 'n' then", -- shunt/cmd/flash.yue:88
    "    print('aborting install')", -- shunt/cmd/flash.yue:89
    "    return", -- shunt/cmd/flash.yue:90
    "  end", -- shunt/cmd/flash.yue:91
    "  print('! response \\'' .. resp .. '\\' unrecognised')", -- shunt/cmd/flash.yue:92
    "end", -- shunt/cmd/flash.yue:93
    "", -- shunt/cmd/flash.yue:94
    "local disk_mount_path = nil", -- shunt/cmd/flash.yue:95
    "do", -- shunt/cmd/flash.yue:96
    "  disk_drive = peripheral.find('drive', function(_, drive)", -- shunt/cmd/flash.yue:97
    "    disk_mount_path = drive.getMountPath()", -- shunt/cmd/flash.yue:98
    "    return drive.getDiskLabel() == '" .. tostring(label) .. "'", -- shunt/cmd/flash.yue:99
    "  end)", -- shunt/cmd/flash.yue:100
    "end", -- shunt/cmd/flash.yue:101
    "assert(disk_mount_path, 'unable to find disk where label=" .. tostring(label) .. "')", -- shunt/cmd/flash.yue:102
    "", -- shunt/cmd/flash.yue:103
    "-- Copy files", -- shunt/cmd/flash.yue:104
    "print('Copying ' .. disk_mount_path .. '/shunt -> /shunt ...')", -- shunt/cmd/flash.yue:105
    "local shunt_dest = assert(io.open('shunt', 'w+'))", -- shunt/cmd/flash.yue:106
    "for line in io.lines(disk_mount_path .. '/shunt') do", -- shunt/cmd/flash.yue:107
    "  assert(shunt_dest:write(line))", -- shunt/cmd/flash.yue:108
    "  assert(shunt_dest:write('\\n'))", -- shunt/cmd/flash.yue:109
    "end", -- shunt/cmd/flash.yue:110
    "assert(shunt_dest:close())", -- shunt/cmd/flash.yue:111
    "print('Done!')" -- shunt/cmd/flash.yue:112
  } -- shunt/cmd/flash.yue:67
  return table.concat(lines, '\n') -- shunt/cmd/flash.yue:113
end) -- shunt/cmd/flash.yue:66
spec(function() -- shunt/cmd/flash.yue:115
  local TestDrive = require('shunt.peripheral.drive').TestDrive -- shunt/cmd/flash.yue:0
  local describe, it, matchers -- shunt/cmd/flash.yue:0
  do -- shunt/cmd/flash.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/cmd/flash.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/cmd/flash.yue:0
  end -- shunt/cmd/flash.yue:0
  local eq, gt, len = matchers.eq, matchers.gt, matchers.len -- shunt/cmd/flash.yue:121
  describe('Flasher', function() -- shunt/cmd/flash.yue:123
    return it('flashes the given drive', function() -- shunt/cmd/flash.yue:124
      local TEMP_PATH = '.test' -- shunt/cmd/flash.yue:125
      local MOUNT_PATH = tostring(TEMP_PATH) .. "/mnt" -- shunt/cmd/flash.yue:126
      fs.makeDir(TEMP_PATH) -- shunt/cmd/flash.yue:127
      fs.makeDir(MOUNT_PATH) -- shunt/cmd/flash.yue:128
      local EXPECTED_CONTENT = 'expected-content' -- shunt/cmd/flash.yue:130
      do -- shunt/cmd/flash.yue:132
        local _with_0 = assert(io.open(tostring(TEMP_PATH) .. "/shunt", 'w+')) -- shunt/cmd/flash.yue:132
        assert(_with_0:write(EXPECTED_CONTENT)) -- shunt/cmd/flash.yue:133
        assert(_with_0:close()) -- shunt/cmd/flash.yue:134
      end -- shunt/cmd/flash.yue:132
      local disk_label = nil -- shunt/cmd/flash.yue:136
      local flasher = ShuntFlasher(TestDrive({ -- shunt/cmd/flash.yue:138
        is_disk_present = function(self) -- shunt/cmd/flash.yue:138
          return true -- shunt/cmd/flash.yue:138
        end, -- shunt/cmd/flash.yue:138
        mount_path = function(self) -- shunt/cmd/flash.yue:139
          return MOUNT_PATH -- shunt/cmd/flash.yue:139
        end, -- shunt/cmd/flash.yue:139
        disk_label = function(self) -- shunt/cmd/flash.yue:140
          return disk_label -- shunt/cmd/flash.yue:140
        end, -- shunt/cmd/flash.yue:140
        set_disk_label = function(self, label) -- shunt/cmd/flash.yue:141
          disk_label = label -- shunt/cmd/flash.yue:142
          return true -- shunt/cmd/flash.yue:143
        end -- shunt/cmd/flash.yue:141
      })) -- shunt/cmd/flash.yue:137
      flasher:flash(TEMP_PATH) -- shunt/cmd/flash.yue:144
      local shunt_content = nil -- shunt/cmd/flash.yue:146
      do -- shunt/cmd/flash.yue:147
        local _with_0 = io.open(tostring(MOUNT_PATH) .. "/shunt", 'r') -- shunt/cmd/flash.yue:147
        if _with_0 ~= nil then -- shunt/cmd/flash.yue:147
          shunt_content = assert(_with_0:read('*a')) -- shunt/cmd/flash.yue:148
          assert(_with_0:close()) -- shunt/cmd/flash.yue:149
        end -- shunt/cmd/flash.yue:147
      end -- shunt/cmd/flash.yue:147
      require('shunt.spec')._expect_that([=[shunt_content]=], shunt_content, (eq(EXPECTED_CONTENT)), tostring("shunt/cmd/flash.yue") .. ":" .. tostring(150)) -- shunt/cmd/flash.yue:150
      local startup_content = nil -- shunt/cmd/flash.yue:152
      do -- shunt/cmd/flash.yue:153
        local _with_0 = io.open(tostring(MOUNT_PATH) .. "/startup.lua", 'r') -- shunt/cmd/flash.yue:153
        if _with_0 ~= nil then -- shunt/cmd/flash.yue:153
          startup_content = assert(_with_0:read('*a')) -- shunt/cmd/flash.yue:154
          assert(_with_0:close()) -- shunt/cmd/flash.yue:155
        end -- shunt/cmd/flash.yue:153
      end -- shunt/cmd/flash.yue:153
      require('shunt.spec')._expect_that([=[startup_content]=], startup_content, (len(gt(0))), tostring("shunt/cmd/flash.yue") .. ":" .. tostring(156)) -- shunt/cmd/flash.yue:156
      assert(os.remove(tostring(MOUNT_PATH) .. "/shunt")) -- shunt/cmd/flash.yue:158
      assert(os.remove(tostring(MOUNT_PATH) .. "/startup.lua")) -- shunt/cmd/flash.yue:159
      assert(os.remove(MOUNT_PATH)) -- shunt/cmd/flash.yue:160
      assert(os.remove(tostring(TEMP_PATH) .. "/shunt")) -- shunt/cmd/flash.yue:161
      return assert(os.remove(TEMP_PATH)) -- shunt/cmd/flash.yue:162
    end) -- shunt/cmd/flash.yue:162
  end) -- shunt/cmd/flash.yue:123
  return describe('startup_script', function() -- shunt/cmd/flash.yue:164
    return it('has expected value', function() -- shunt/cmd/flash.yue:165
      local LABEL = 'expected_label' -- shunt/cmd/flash.yue:166
      local expected_lines = { -- shunt/cmd/flash.yue:168
        "term.clear()", -- shunt/cmd/flash.yue:168
        "term.setCursorPos(1, 1)", -- shunt/cmd/flash.yue:169
        "local installer_header = '--- shunt installer ---'", -- shunt/cmd/flash.yue:170
        "print(('-'):rep(#installer_header))", -- shunt/cmd/flash.yue:171
        "print(installer_header)", -- shunt/cmd/flash.yue:172
        "print(('-'):rep(#installer_header))", -- shunt/cmd/flash.yue:173
        "print('')", -- shunt/cmd/flash.yue:174
        "print('Welcome to the shunt installer!')", -- shunt/cmd/flash.yue:175
        "while true do", -- shunt/cmd/flash.yue:176
        "  print('')", -- shunt/cmd/flash.yue:177
        "  print('Options:')", -- shunt/cmd/flash.yue:178
        "  print(\"* To install shunt, type `y' then hit <enter>\")", -- shunt/cmd/flash.yue:179
        "  print(\"* To cancel, type `n' then hit <enter>\")", -- shunt/cmd/flash.yue:180
        "  print('')", -- shunt/cmd/flash.yue:181
        "  io.write('$ ')", -- shunt/cmd/flash.yue:182
        "  local resp = io.read('*l'):sub(1, 1):lower()", -- shunt/cmd/flash.yue:183
        "  print('')", -- shunt/cmd/flash.yue:184
        "", -- shunt/cmd/flash.yue:185
        "  if resp == 'y' then", -- shunt/cmd/flash.yue:186
        "    break", -- shunt/cmd/flash.yue:187
        "  elseif resp == 'n' then", -- shunt/cmd/flash.yue:188
        "    print('aborting install')", -- shunt/cmd/flash.yue:189
        "    return", -- shunt/cmd/flash.yue:190
        "  end", -- shunt/cmd/flash.yue:191
        "  print('! response \\'' .. resp .. '\\' unrecognised')", -- shunt/cmd/flash.yue:192
        "end", -- shunt/cmd/flash.yue:193
        "", -- shunt/cmd/flash.yue:194
        "local disk_mount_path = nil", -- shunt/cmd/flash.yue:195
        "do", -- shunt/cmd/flash.yue:196
        "  disk_drive = peripheral.find('drive', function(_, drive)", -- shunt/cmd/flash.yue:197
        "    disk_mount_path = drive.getMountPath()", -- shunt/cmd/flash.yue:198
        "    return drive.getDiskLabel() == '" .. tostring(LABEL) .. "'", -- shunt/cmd/flash.yue:199
        "  end)", -- shunt/cmd/flash.yue:200
        "end", -- shunt/cmd/flash.yue:201
        "assert(disk_mount_path, 'unable to find disk where label=" .. tostring(LABEL) .. "')", -- shunt/cmd/flash.yue:202
        "", -- shunt/cmd/flash.yue:203
        "-- Copy files", -- shunt/cmd/flash.yue:204
        "print('Copying ' .. disk_mount_path .. '/shunt -> /shunt ...')", -- shunt/cmd/flash.yue:205
        "local shunt_dest = assert(io.open('shunt', 'w+'))", -- shunt/cmd/flash.yue:206
        "for line in io.lines(disk_mount_path .. '/shunt') do", -- shunt/cmd/flash.yue:207
        "  assert(shunt_dest:write(line))", -- shunt/cmd/flash.yue:208
        "  assert(shunt_dest:write('\\n'))", -- shunt/cmd/flash.yue:209
        "end", -- shunt/cmd/flash.yue:210
        "assert(shunt_dest:close())", -- shunt/cmd/flash.yue:211
        "print('Done!')" -- shunt/cmd/flash.yue:212
      } -- shunt/cmd/flash.yue:167
      local expected_content = table.concat(expected_lines, '\n'); -- shunt/cmd/flash.yue:213
      return require('shunt.spec')._expect_that([=[(startup_script LABEL)]=], (startup_script(LABEL)), (eq(expected_content)), tostring("shunt/cmd/flash.yue") .. ":" .. tostring(214)) -- shunt/cmd/flash.yue:214
    end) -- shunt/cmd/flash.yue:214
  end) -- shunt/cmd/flash.yue:214
end) -- shunt/cmd/flash.yue:115
return _module_0 -- shunt/cmd/flash.yue:214
end
package.preload['shunt.peripheral.drive'] = function(...)
-- [yue]: shunt/peripheral/drive.yue
local _module_0 = { } -- shunt/peripheral/drive.yue:1
local MinecraftBackend -- shunt/peripheral/drive.yue:2
local declare_type, F -- shunt/peripheral/drive.yue:0
do -- shunt/peripheral/drive.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/peripheral/drive.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/peripheral/drive.yue:0
end -- shunt/peripheral/drive.yue:0
declare_type('Drive', [[{
  is_disk_present: () => boolean,
  mount_path: () => ?string,
  disk_label: () => ?string,
  set_disk_label: (?string) => boolean,
}]]) -- shunt/peripheral/drive.yue:6
local Drive -- shunt/peripheral/drive.yue:12
do -- shunt/peripheral/drive.yue:12
  local _class_0 -- shunt/peripheral/drive.yue:12
  local _base_0 = { -- shunt/peripheral/drive.yue:12
    is_disk_present = F('() => boolean', function(self) -- shunt/peripheral/drive.yue:30
      return self.drive.isDiskPresent() -- shunt/peripheral/drive.yue:31
    end), -- shunt/peripheral/drive.yue:33
    mount_path = F('() => ?string', function(self) -- shunt/peripheral/drive.yue:33
      return self.drive.getMountPath() -- shunt/peripheral/drive.yue:34
    end), -- shunt/peripheral/drive.yue:36
    disk_label = F('() => ?string', function(self) -- shunt/peripheral/drive.yue:36
      return self.drive.getDiskLabel() -- shunt/peripheral/drive.yue:37
    end), -- shunt/peripheral/drive.yue:39
    set_disk_label = F('(?string) => boolean', function(self, label) -- shunt/peripheral/drive.yue:39
      local ret -- shunt/peripheral/drive.yue:40
xpcall(function() -- shunt/peripheral/drive.yue:41
        self.drive.setDiskLabel(label) -- shunt/peripheral/drive.yue:42
        ret = true -- shunt/peripheral/drive.yue:43
      end, function(_) -- shunt/peripheral/drive.yue:43
        ret = false -- shunt/peripheral/drive.yue:45
      end) -- shunt/peripheral/drive.yue:45
      return ret -- shunt/peripheral/drive.yue:46
    end) -- shunt/peripheral/drive.yue:12
  } -- shunt/peripheral/drive.yue:12
  if _base_0.__index == nil then -- shunt/peripheral/drive.yue:12
    _base_0.__index = _base_0 -- shunt/peripheral/drive.yue:12
  end -- shunt/peripheral/drive.yue:46
  _class_0 = setmetatable({ -- shunt/peripheral/drive.yue:12
    __init = F('(?string) => <>', function(self, direction) -- shunt/peripheral/drive.yue:13
      local drive -- shunt/peripheral/drive.yue:14
      if (direction ~= nil) then -- shunt/peripheral/drive.yue:15
        if 'drive' ~= peripheral.getType(direction) then -- shunt/peripheral/drive.yue:16
          error("no drive attached to " .. tostring(direction)) -- shunt/peripheral/drive.yue:17
        end -- shunt/peripheral/drive.yue:16
        drive = peripheral.wrap(direction) -- shunt/peripheral/drive.yue:18
        if not (drive ~= nil) then -- shunt/peripheral/drive.yue:19
          error("no drive attached to " .. tostring(direction)) -- shunt/peripheral/drive.yue:20
        end -- shunt/peripheral/drive.yue:19
      else -- shunt/peripheral/drive.yue:22
        local drives = { -- shunt/peripheral/drive.yue:22
          peripheral.find('drive') -- shunt/peripheral/drive.yue:22
        } -- shunt/peripheral/drive.yue:22
        if #drives == 0 then -- shunt/peripheral/drive.yue:23
          error('no drives attached') -- shunt/peripheral/drive.yue:24
        end -- shunt/peripheral/drive.yue:23
        if #drives > 1 then -- shunt/peripheral/drive.yue:25
          error('too many drives attached') -- shunt/peripheral/drive.yue:26
        end -- shunt/peripheral/drive.yue:25
        drive = drives[1] -- shunt/peripheral/drive.yue:27
      end -- shunt/peripheral/drive.yue:15
      self.drive = drive -- shunt/peripheral/drive.yue:28
    end), -- shunt/peripheral/drive.yue:12
    __base = _base_0, -- shunt/peripheral/drive.yue:12
    __name = "Drive" -- shunt/peripheral/drive.yue:12
  }, { -- shunt/peripheral/drive.yue:12
    __index = _base_0, -- shunt/peripheral/drive.yue:12
    __call = function(cls, ...) -- shunt/peripheral/drive.yue:12
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/drive.yue:12
      cls.__init(_self_0, ...) -- shunt/peripheral/drive.yue:12
      return _self_0 -- shunt/peripheral/drive.yue:12
    end -- shunt/peripheral/drive.yue:12
  }) -- shunt/peripheral/drive.yue:12
  _base_0.__class = _class_0 -- shunt/peripheral/drive.yue:12
  Drive = _class_0 -- shunt/peripheral/drive.yue:12
end -- shunt/peripheral/drive.yue:46
_module_0["Drive"] = Drive -- shunt/peripheral/drive.yue:12
declare_type('TestDriveOpts', [[{
  is_disk_present: ?() => boolean,
  mount_path: ?() => ?string,
  disk_label: ?() => ?string,
  set_disk_label: ?(?string) => boolean,
}]]) -- shunt/peripheral/drive.yue:48
local TestDrive -- shunt/peripheral/drive.yue:54
do -- shunt/peripheral/drive.yue:54
  local _class_0 -- shunt/peripheral/drive.yue:54
  local _base_0 = { } -- shunt/peripheral/drive.yue:54
  if _base_0.__index == nil then -- shunt/peripheral/drive.yue:54
    _base_0.__index = _base_0 -- shunt/peripheral/drive.yue:54
  end -- shunt/peripheral/drive.yue:65
  _class_0 = setmetatable({ -- shunt/peripheral/drive.yue:54
    __init = F('(TestDriveOpts) => <>', function(self, opts) -- shunt/peripheral/drive.yue:55
      local is_disk_present, mount_path, disk_label, set_disk_label = opts.is_disk_present, opts.mount_path, opts.disk_label, opts.set_disk_label -- shunt/peripheral/drive.yue:56
      if is_disk_present == nil then -- shunt/peripheral/drive.yue:57
        is_disk_present = function() -- shunt/peripheral/drive.yue:57
          return error("is_disk_present unimplemented") -- shunt/peripheral/drive.yue:57
        end -- shunt/peripheral/drive.yue:57
      end -- shunt/peripheral/drive.yue:57
      if mount_path == nil then -- shunt/peripheral/drive.yue:58
        mount_path = function() -- shunt/peripheral/drive.yue:58
          return error("mount_path unimplemented") -- shunt/peripheral/drive.yue:58
        end -- shunt/peripheral/drive.yue:58
      end -- shunt/peripheral/drive.yue:58
      if disk_label == nil then -- shunt/peripheral/drive.yue:59
        disk_label = function() -- shunt/peripheral/drive.yue:59
          return error("disk_label unimplemented") -- shunt/peripheral/drive.yue:59
        end -- shunt/peripheral/drive.yue:59
      end -- shunt/peripheral/drive.yue:59
      if set_disk_label == nil then -- shunt/peripheral/drive.yue:60
        set_disk_label = function() -- shunt/peripheral/drive.yue:60
          return error("set_disk_label unimplemented") -- shunt/peripheral/drive.yue:60
        end -- shunt/peripheral/drive.yue:60
      end -- shunt/peripheral/drive.yue:60
      self.is_disk_present = is_disk_present -- shunt/peripheral/drive.yue:62
      self.mount_path = mount_path -- shunt/peripheral/drive.yue:63
      self.disk_label = disk_label -- shunt/peripheral/drive.yue:64
      self.set_disk_label = set_disk_label -- shunt/peripheral/drive.yue:65
    end), -- shunt/peripheral/drive.yue:54
    __base = _base_0, -- shunt/peripheral/drive.yue:54
    __name = "TestDrive" -- shunt/peripheral/drive.yue:54
  }, { -- shunt/peripheral/drive.yue:54
    __index = _base_0, -- shunt/peripheral/drive.yue:54
    __call = function(cls, ...) -- shunt/peripheral/drive.yue:54
      local _self_0 = setmetatable({ }, _base_0) -- shunt/peripheral/drive.yue:54
      cls.__init(_self_0, ...) -- shunt/peripheral/drive.yue:54
      return _self_0 -- shunt/peripheral/drive.yue:54
    end -- shunt/peripheral/drive.yue:54
  }) -- shunt/peripheral/drive.yue:54
  _base_0.__class = _class_0 -- shunt/peripheral/drive.yue:54
  TestDrive = _class_0 -- shunt/peripheral/drive.yue:54
end -- shunt/peripheral/drive.yue:65
_module_0["TestDrive"] = TestDrive -- shunt/peripheral/drive.yue:54
return _module_0 -- shunt/peripheral/drive.yue:65
end
package.preload['shunt.cmd.init'] = function(...)
-- [yue]: shunt/cmd/init.yue
local _module_0 = { } -- shunt/cmd/init.yue:1
local display, factory, ledger, marshal, subcommand, default_config_by_type, main -- shunt/cmd/init.yue:1
local Flag, Param, Subcommand -- shunt/cmd/init.yue:0
do -- shunt/cmd/init.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/init.yue:0
  Flag, Param, Subcommand = _obj_0.Flag, _obj_0.Param, _obj_0.Subcommand -- shunt/cmd/init.yue:0
end -- shunt/cmd/init.yue:0
local CONFIG_FILE = require('shunt.config').CONFIG_FILE -- shunt/cmd/init.yue:0
local ABORT, Editor -- shunt/cmd/init.yue:0
do -- shunt/cmd/init.yue:0
  local _obj_0 = require('shunt.configurator.editor') -- shunt/cmd/init.yue:0
  ABORT, Editor = _obj_0.ABORT, _obj_0.Editor -- shunt/cmd/init.yue:0
end -- shunt/cmd/init.yue:0
local Configurator = require('shunt.configurator.main').Configurator -- shunt/cmd/init.yue:0
local F, T -- shunt/cmd/init.yue:0
do -- shunt/cmd/init.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/init.yue:0
  F, T = _obj_0.F, _obj_0.T -- shunt/cmd/init.yue:0
end -- shunt/cmd/init.yue:0
local spec = require('shunt.spec').spec -- shunt/cmd/init.yue:0
local toml = require('shunt.toml') -- shunt/cmd/init.yue:10
display = require('shunt.nodes.display.main') -- shunt/cmd/init.yue:12
factory = require('shunt.nodes.factory.main') -- shunt/cmd/init.yue:13
ledger = require('shunt.nodes.ledger.main') -- shunt/cmd/init.yue:14
marshal = require('shunt.nodes.marshal.main') -- shunt/cmd/init.yue:15
do -- shunt/cmd/init.yue:17
  local _with_0 = Subcommand('init') -- shunt/cmd/init.yue:17
  _with_0:description('initialise this shunt instance') -- shunt/cmd/init.yue:18
  _with_0:add((function() -- shunt/cmd/init.yue:19
    local _with_1 = Flag('force') -- shunt/cmd/init.yue:19
    _with_1:description('overwrite existing config') -- shunt/cmd/init.yue:20
    return _with_1 -- shunt/cmd/init.yue:19
  end)()) -- shunt/cmd/init.yue:19
  _with_0:add((function() -- shunt/cmd/init.yue:21
    local _with_1 = Param('instance-type') -- shunt/cmd/init.yue:21
    _with_1:description('the type of instance to initialise') -- shunt/cmd/init.yue:22
    _with_1:options({ -- shunt/cmd/init.yue:24
      'display', -- shunt/cmd/init.yue:24
      'factory', -- shunt/cmd/init.yue:25
      'ledger', -- shunt/cmd/init.yue:26
      'marshal' -- shunt/cmd/init.yue:27
    }) -- shunt/cmd/init.yue:23
    return _with_1 -- shunt/cmd/init.yue:21
  end)()) -- shunt/cmd/init.yue:21
  subcommand = _with_0 -- shunt/cmd/init.yue:17
end -- shunt/cmd/init.yue:17
_module_0["subcommand"] = subcommand -- shunt/cmd/init.yue:27
default_config_by_type = T('{string->()-><?string, ?string>}', { -- shunt/cmd/init.yue:30
  display = display.default_config, -- shunt/cmd/init.yue:30
  factory = factory.default_config, -- shunt/cmd/init.yue:31
  ledger = ledger.default_config, -- shunt/cmd/init.yue:32
  marshal = marshal.default_config -- shunt/cmd/init.yue:33
}) -- shunt/cmd/init.yue:29
main = F('({}) -> <>', function(args) -- shunt/cmd/init.yue:35
  local default_config_fn = default_config_by_type[args.instance_type] -- shunt/cmd/init.yue:36
  if not (default_config_fn ~= nil) then -- shunt/cmd/init.yue:37
    error("internal error: unrecognised instance type '" .. tostring(args.instance_type) .. "'") -- shunt/cmd/init.yue:38
  end -- shunt/cmd/init.yue:37
  if not args.force then -- shunt/cmd/init.yue:40
    do -- shunt/cmd/init.yue:41
      local _with_0 = io.open(CONFIG_FILE, 'r') -- shunt/cmd/init.yue:41
      if _with_0 ~= nil then -- shunt/cmd/init.yue:41
        _with_0:close() -- shunt/cmd/init.yue:42
        print(tostring(CONFIG_FILE) .. " already exists") -- shunt/cmd/init.yue:43
        return -- shunt/cmd/init.yue:44
      end -- shunt/cmd/init.yue:41
    end -- shunt/cmd/init.yue:41
  end -- shunt/cmd/init.yue:40
  local editor = Editor() -- shunt/cmd/init.yue:46
  local checker = Configurator:config_checker(args.instance_type) -- shunt/cmd/init.yue:47
  local on_attempt -- shunt/cmd/init.yue:48
  do -- shunt/cmd/init.yue:48
    local _base_0 = Configurator -- shunt/cmd/init.yue:48
    local _fn_0 = _base_0.ask_permission_on_attempt -- shunt/cmd/init.yue:48
    on_attempt = _fn_0 and function(...) -- shunt/cmd/init.yue:48
      return _fn_0(_base_0, ...) -- shunt/cmd/init.yue:48
    end -- shunt/cmd/init.yue:48
  end -- shunt/cmd/init.yue:48
  local config, err = editor:edit_text(default_config_fn(), CONFIG_FILE, checker, on_attempt) -- shunt/cmd/init.yue:49
  if err ~= nil then -- shunt/cmd/init.yue:51
    print("cannot init: " .. tostring(err)) -- shunt/cmd/init.yue:52
    return -- shunt/cmd/init.yue:53
  end -- shunt/cmd/init.yue:51
  do -- shunt/cmd/init.yue:55
    local _with_0 = assert(io.open(CONFIG_FILE, 'w+')) -- shunt/cmd/init.yue:55
    assert(_with_0:write(config)) -- shunt/cmd/init.yue:56
    assert(_with_0:close()) -- shunt/cmd/init.yue:57
  end -- shunt/cmd/init.yue:55
  local message_lines = { -- shunt/cmd/init.yue:60
    tostring(args.instance_type) .. " configured. To enable, run:", -- shunt/cmd/init.yue:60
    '', -- shunt/cmd/init.yue:61
    '> shunt enable', -- shunt/cmd/init.yue:62
    '', -- shunt/cmd/init.yue:63
    'then, to start, run:', -- shunt/cmd/init.yue:64
    '', -- shunt/cmd/init.yue:65
    '> shunt start', -- shunt/cmd/init.yue:66
    '' -- shunt/cmd/init.yue:67
  } -- shunt/cmd/init.yue:59
  print(table.concat(message_lines, '\n')) -- shunt/cmd/init.yue:68
  return -- shunt/cmd/init.yue:69
end) -- shunt/cmd/init.yue:35
_module_0["main"] = main -- shunt/cmd/init.yue:69
spec(function() -- shunt/cmd/init.yue:71
  local describe, it, matchers -- shunt/cmd/init.yue:0
  do -- shunt/cmd/init.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/cmd/init.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/cmd/init.yue:0
  end -- shunt/cmd/init.yue:0
  local eq, has_fields, has_type, no_errors = matchers.eq, matchers.has_fields, matchers.has_type, matchers.no_errors -- shunt/cmd/init.yue:76
  local configs -- shunt/cmd/init.yue:78
  do -- shunt/cmd/init.yue:78
    local _accum_0 = { } -- shunt/cmd/init.yue:78
    local _len_0 = 1 -- shunt/cmd/init.yue:78
    for name, raw_fn in pairs(default_config_by_type) do -- shunt/cmd/init.yue:78
      _accum_0[_len_0] = { -- shunt/cmd/init.yue:78
        name = name, -- shunt/cmd/init.yue:78
        raw_fn = raw_fn -- shunt/cmd/init.yue:78
      } -- shunt/cmd/init.yue:78
      _len_0 = _len_0 + 1 -- shunt/cmd/init.yue:78
    end -- shunt/cmd/init.yue:78
    configs = _accum_0 -- shunt/cmd/init.yue:78
  end -- shunt/cmd/init.yue:78
  table.sort(configs, function(a, b) -- shunt/cmd/init.yue:79
    return a.name < b.name -- shunt/cmd/init.yue:79
  end) -- shunt/cmd/init.yue:79
  for _index_0 = 1, #configs do -- shunt/cmd/init.yue:81
    local config = configs[_index_0] -- shunt/cmd/init.yue:81
    describe("default " .. tostring(config.name) .. " config", function() -- shunt/cmd/init.yue:82
      return it('is valid toml', function() -- shunt/cmd/init.yue:83
        local parsed_default_config, err = toml.decode(config.raw_fn()); -- shunt/cmd/init.yue:84
        require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/cmd/init.yue") .. ":" .. tostring(86)); -- shunt/cmd/init.yue:86
        require('shunt.spec')._expect_that([=[parsed_default_config]=], parsed_default_config, (has_type('table')), tostring("shunt/cmd/init.yue") .. ":" .. tostring(87)); -- shunt/cmd/init.yue:87
        return require('shunt.spec')._expect_that([=[parsed_default_config]=], parsed_default_config, (has_fields({ -- shunt/cmd/init.yue:88
          [config.name] = has_type('table') -- shunt/cmd/init.yue:88
        })), tostring("shunt/cmd/init.yue") .. ":" .. tostring(88)) -- shunt/cmd/init.yue:89
      end) -- shunt/cmd/init.yue:89
    end) -- shunt/cmd/init.yue:82
  end -- shunt/cmd/init.yue:89
end) -- shunt/cmd/init.yue:71
return _module_0 -- shunt/cmd/init.yue:89
end
package.preload['shunt.config'] = function(...)
-- [yue]: shunt/config.yue
local _module_0 = { } -- shunt/config.yue:1
local CONFIG_FILE, cached_config, tried_to_get_config, config, exists -- shunt/config.yue:1
local declare_type, F -- shunt/config.yue:0
do -- shunt/config.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/config.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/config.yue:0
end -- shunt/config.yue:0
local toml = require('shunt.toml') -- shunt/config.yue:5
CONFIG_FILE = 'shunt.toml' -- shunt/config.yue:7
_module_0["CONFIG_FILE"] = CONFIG_FILE -- shunt/config.yue:7
declare_type('StoredConfig', [[{
  <>: {
    __raw: string,
  },
}]]) -- shunt/config.yue:9
cached_config = nil -- shunt/config.yue:15
tried_to_get_config = false -- shunt/config.yue:16
config = F('() -> <?StoredConfig, ?string>', function() -- shunt/config.yue:17
  if not tried_to_get_config then -- shunt/config.yue:18
    tried_to_get_config = true -- shunt/config.yue:19
    local raw = nil -- shunt/config.yue:21
    do -- shunt/config.yue:22
      local _with_0 = io.open(CONFIG_FILE, 'r') -- shunt/config.yue:22
      if _with_0 ~= nil then -- shunt/config.yue:22
        local config_absent = true -- shunt/config.yue:23
        raw = assert(_with_0:read('*a')) -- shunt/config.yue:24
        assert(_with_0:close()) -- shunt/config.yue:25
      end -- shunt/config.yue:22
    end -- shunt/config.yue:22
    if (raw ~= nil) then -- shunt/config.yue:26
      local err -- shunt/config.yue:27
      cached_config, err = toml.decode(raw) -- shunt/config.yue:27
      if (err ~= nil) then -- shunt/config.yue:28
        return nil, err -- shunt/config.yue:29
      end -- shunt/config.yue:28
      setmetatable(cached_config, { }) -- shunt/config.yue:30
      getmetatable(cached_config).__raw = raw -- shunt/config.yue:31
    end -- shunt/config.yue:26
  end -- shunt/config.yue:18
  return cached_config, nil -- shunt/config.yue:33
end) -- shunt/config.yue:17
_module_0["config"] = config -- shunt/config.yue:33
exists = F('(string) -> boolean', function(path) -- shunt/config.yue:35
  do -- shunt/config.yue:36
    local _with_0 = io.open(path, 'r') -- shunt/config.yue:36
    if _with_0 ~= nil then -- shunt/config.yue:36
      assert(_with_0:close()) -- shunt/config.yue:37
      return true -- shunt/config.yue:38
    end -- shunt/config.yue:36
  end -- shunt/config.yue:36
  return false -- shunt/config.yue:39
end) -- shunt/config.yue:35
return _module_0 -- shunt/config.yue:39
end
package.preload['shunt.nodes.display.main'] = function(...)
-- [yue]: shunt/nodes/display/main.yue
local _module_0 = { } -- shunt/nodes/display/main.yue:1
local subcommand, default_config, main -- shunt/nodes/display/main.yue:1
local Param, Subcommand -- shunt/nodes/display/main.yue:0
do -- shunt/nodes/display/main.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/nodes/display/main.yue:0
  Param, Subcommand = _obj_0.Param, _obj_0.Subcommand -- shunt/nodes/display/main.yue:0
end -- shunt/nodes/display/main.yue:0
local declare_type, F -- shunt/nodes/display/main.yue:0
do -- shunt/nodes/display/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/display/main.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/nodes/display/main.yue:0
end -- shunt/nodes/display/main.yue:0
do -- shunt/nodes/display/main.yue:6
  local _with_0 = Subcommand('display') -- shunt/nodes/display/main.yue:6
  _with_0:description('display system status') -- shunt/nodes/display/main.yue:7
  _with_0:add((function() -- shunt/nodes/display/main.yue:8
    local _with_1 = Param('what') -- shunt/nodes/display/main.yue:8
    _with_1:description('what to display') -- shunt/nodes/display/main.yue:9
    _with_1:options({ -- shunt/nodes/display/main.yue:11
      'trains', -- shunt/nodes/display/main.yue:11
      'factories', -- shunt/nodes/display/main.yue:12
      'throughput' -- shunt/nodes/display/main.yue:13
    }) -- shunt/nodes/display/main.yue:10
    return _with_1 -- shunt/nodes/display/main.yue:8
  end)()) -- shunt/nodes/display/main.yue:8
  subcommand = _with_0 -- shunt/nodes/display/main.yue:6
end -- shunt/nodes/display/main.yue:6
_module_0["subcommand"] = subcommand -- shunt/nodes/display/main.yue:13
default_config = function() -- shunt/nodes/display/main.yue:15
  return [=[[display.ledger]
kind = 'events'
]=] -- shunt/nodes/display/main.yue:18
end -- shunt/nodes/display/main.yue:15
_module_0["default_config"] = default_config -- shunt/nodes/display/main.yue:18
declare_type('DisplayConfig', [[{
  display: {
    ledger: {
      kind: "trains"|"factories"|"throughput"|"events",
    },
  },
}]]) -- shunt/nodes/display/main.yue:20
main = F('(DisplayConfig) -> <>', function(config) -- shunt/nodes/display/main.yue:27
  print("hello, display! Displaying: " .. tostring(args.what)) -- shunt/nodes/display/main.yue:28
  return -- shunt/nodes/display/main.yue:29
end) -- shunt/nodes/display/main.yue:27
_module_0["main"] = main -- shunt/nodes/display/main.yue:29
return _module_0 -- shunt/nodes/display/main.yue:29
end
package.preload['shunt.nodes.ledger.main'] = function(...)
-- [yue]: shunt/nodes/ledger/main.yue
local _module_0 = { } -- shunt/nodes/ledger/main.yue:1
local default_config, main, Ledger, sum, fmt_cell -- shunt/nodes/ledger/main.yue:1
local Flag, Subcommand -- shunt/nodes/ledger/main.yue:0
do -- shunt/nodes/ledger/main.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/nodes/ledger/main.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/nodes/ledger/main.yue:0
end -- shunt/nodes/ledger/main.yue:0
local Queue = require('shunt.data.queue').Queue -- shunt/nodes/ledger/main.yue:0
local declare_type, F, T -- shunt/nodes/ledger/main.yue:0
do -- shunt/nodes/ledger/main.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/nodes/ledger/main.yue:0
  declare_type, F, T = _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/nodes/ledger/main.yue:0
end -- shunt/nodes/ledger/main.yue:0
local spec = require('shunt.spec').spec -- shunt/nodes/ledger/main.yue:0
local toml = require('shunt.toml') -- shunt/nodes/ledger/main.yue:8
default_config = function() -- shunt/nodes/ledger/main.yue:10
  return [=[[ledger]
retained-events = 1000
]=] -- shunt/nodes/ledger/main.yue:13
end -- shunt/nodes/ledger/main.yue:10
_module_0["default_config"] = default_config -- shunt/nodes/ledger/main.yue:13
declare_type('LedgerConfig', [[{
  ledger: {
    retained-events: number,
  },
}]]) -- shunt/nodes/ledger/main.yue:15
main = F('(LedgerConfig) -> <>', function(config) -- shunt/nodes/ledger/main.yue:20
  print('hello, ledger!') -- shunt/nodes/ledger/main.yue:21
  return -- shunt/nodes/ledger/main.yue:22
end) -- shunt/nodes/ledger/main.yue:20
_module_0["main"] = main -- shunt/nodes/ledger/main.yue:33
declare_type('Ledger', [[{
  iter: () => thread,
}]]) -- shunt/nodes/ledger/main.yue:35
declare_type('Entry', [[{
  when: string,
  what: string,
  how: string,
}]]) -- shunt/nodes/ledger/main.yue:38
do -- shunt/nodes/ledger/main.yue:43
  local _class_0 -- shunt/nodes/ledger/main.yue:43
  local _base_0 = { -- shunt/nodes/ledger/main.yue:43
    iter = F('() => function', function(self) -- shunt/nodes/ledger/main.yue:48
      return self.entries:iter() -- shunt/nodes/ledger/main.yue:49
    end), -- shunt/nodes/ledger/main.yue:51
    load = F('(?string) => ?string', function(self) -- shunt/nodes/ledger/main.yue:51
      local content -- shunt/nodes/ledger/main.yue:52
      do -- shunt/nodes/ledger/main.yue:53
        local _with_0 = assert(io.open(self.save_path, 'r')) -- shunt/nodes/ledger/main.yue:53
        content = assert(_with_0:read('*a')) -- shunt/nodes/ledger/main.yue:54
        assert(_with_0:close()) -- shunt/nodes/ledger/main.yue:55
      end -- shunt/nodes/ledger/main.yue:53
      print("got content: [" .. tostring(content) .. "]") -- shunt/nodes/ledger/main.yue:56
      local data, err = toml.decode(content) -- shunt/nodes/ledger/main.yue:57
      if (err ~= nil) then -- shunt/nodes/ledger/main.yue:58
        return err -- shunt/nodes/ledger/main.yue:59
      end -- shunt/nodes/ledger/main.yue:58
      self.max_len = T('number', assert(data.max_len, 'saved ledger missing max_len field')) -- shunt/nodes/ledger/main.yue:61
      local entries = T('[Entry]', (function() -- shunt/nodes/ledger/main.yue:62
        local _exp_0 = data.entries -- shunt/nodes/ledger/main.yue:62
        if _exp_0 ~= nil then -- shunt/nodes/ledger/main.yue:62
          return _exp_0 -- shunt/nodes/ledger/main.yue:62
        else -- shunt/nodes/ledger/main.yue:62
          return { } -- shunt/nodes/ledger/main.yue:62
        end -- shunt/nodes/ledger/main.yue:62
      end)()) -- shunt/nodes/ledger/main.yue:62
      self.entries = Queue('Entry') -- shunt/nodes/ledger/main.yue:63
      for _index_0 = 1, #entries do -- shunt/nodes/ledger/main.yue:64
        local entry = entries[_index_0] -- shunt/nodes/ledger/main.yue:64
        self.entries:enqueue(entry) -- shunt/nodes/ledger/main.yue:65
        self.entry_save_fragments:enqueue(self:fmt_entry_as_toml(entry)) -- shunt/nodes/ledger/main.yue:66
      end -- shunt/nodes/ledger/main.yue:66
      return nil -- shunt/nodes/ledger/main.yue:68
    end), -- shunt/nodes/ledger/main.yue:70
    save = F('(?string) => <>', function(self) -- shunt/nodes/ledger/main.yue:70
      local lines -- shunt/nodes/ledger/main.yue:71
      do -- shunt/nodes/ledger/main.yue:71
        local _with_0 = { } -- shunt/nodes/ledger/main.yue:71
        _with_0[#_with_0 + 1] = "max_len = " .. tostring(self.max_len) -- shunt/nodes/ledger/main.yue:72
        for entry_save_fragment in self.entry_save_fragments:iter() do -- shunt/nodes/ledger/main.yue:73
          _with_0[#_with_0 + 1] = entry_save_fragment -- shunt/nodes/ledger/main.yue:74
        end -- shunt/nodes/ledger/main.yue:74
        lines = _with_0 -- shunt/nodes/ledger/main.yue:71
      end -- shunt/nodes/ledger/main.yue:71
      local to_write = table.concat(lines, '\n') -- shunt/nodes/ledger/main.yue:75
      print("writing content: [" .. tostring(to_write) .. "]") -- shunt/nodes/ledger/main.yue:76
      do -- shunt/nodes/ledger/main.yue:78
        local _with_0 = assert(io.open(self.save_path, 'w+')) -- shunt/nodes/ledger/main.yue:78
        assert(_with_0:write(to_write)) -- shunt/nodes/ledger/main.yue:79
        assert(_with_0:close()) -- shunt/nodes/ledger/main.yue:80
      end -- shunt/nodes/ledger/main.yue:78
      return -- shunt/nodes/ledger/main.yue:81
    end), -- shunt/nodes/ledger/main.yue:83
    fmt_entry_as_toml = F('(Entry) => string', function(self, entry) -- shunt/nodes/ledger/main.yue:83
      return table.concat((function() -- shunt/nodes/ledger/main.yue:84
        local _with_0 = { } -- shunt/nodes/ledger/main.yue:84
        _with_0[#_with_0 + 1] = '[[entries]]\n' -- shunt/nodes/ledger/main.yue:85
        _with_0[#_with_0 + 1] = "what = '" .. tostring(entry.what) .. "'\n" -- shunt/nodes/ledger/main.yue:86
        _with_0[#_with_0 + 1] = "when = '" .. tostring(entry.when) .. "'\n" -- shunt/nodes/ledger/main.yue:87
        _with_0[#_with_0 + 1] = "how = '" .. tostring(entry.how) .. "'\n" -- shunt/nodes/ledger/main.yue:88
        return _with_0 -- shunt/nodes/ledger/main.yue:84
      end)()) -- shunt/nodes/ledger/main.yue:88
    end), -- shunt/nodes/ledger/main.yue:90
    len = F('() => number', function(self) -- shunt/nodes/ledger/main.yue:90
      return self.entries:len() -- shunt/nodes/ledger/main.yue:91
    end), -- shunt/nodes/ledger/main.yue:93
    add = F('(Entry) => <>', function(self, entry) -- shunt/nodes/ledger/main.yue:93
      if self.entries:len() == self.max_len then -- shunt/nodes/ledger/main.yue:94
        self.entries:dequeue() -- shunt/nodes/ledger/main.yue:95
        self.entry_save_fragments:dequeue() -- shunt/nodes/ledger/main.yue:96
      end -- shunt/nodes/ledger/main.yue:94
      self.entries:enqueue(entry) -- shunt/nodes/ledger/main.yue:97
      self.entry_save_fragments:enqueue(self:fmt_entry_as_toml(entry)) -- shunt/nodes/ledger/main.yue:98
      return self:save() -- shunt/nodes/ledger/main.yue:99
    end), -- shunt/nodes/ledger/main.yue:101
    emit = F('(?LedgerFmtOpts) => <>', function(self, opts) -- shunt/nodes/ledger/main.yue:101
      if opts == nil then -- shunt/nodes/ledger/main.yue:101
        opts = { } -- shunt/nodes/ledger/main.yue:101
      end -- shunt/nodes/ledger/main.yue:101
      local to_print = self:fmt(opts) -- shunt/nodes/ledger/main.yue:102
      do -- shunt/nodes/ledger/main.yue:104
        local _obj_0 = term -- shunt/nodes/ledger/main.yue:104
        if _obj_0 ~= nil then -- shunt/nodes/ledger/main.yue:104
          _obj_0.clear() -- shunt/nodes/ledger/main.yue:104
        end -- shunt/nodes/ledger/main.yue:104
      end -- shunt/nodes/ledger/main.yue:104
      print(to_print) -- shunt/nodes/ledger/main.yue:105
      return -- shunt/nodes/ledger/main.yue:106
    end), -- shunt/nodes/ledger/main.yue:108
    fmt = F('(LedgerFmtOpts) => string', function(self, opts) -- shunt/nodes/ledger/main.yue:108
      local buf = { } -- shunt/nodes/ledger/main.yue:109
      self:fmt_header(buf, opts) -- shunt/nodes/ledger/main.yue:110
      self:fmt_body(buf, opts) -- shunt/nodes/ledger/main.yue:111
      return table.concat(buf, '\n') -- shunt/nodes/ledger/main.yue:112
    end), -- shunt/nodes/ledger/main.yue:114
    fmt_header = F('([string], LedgerFmtOpts) => <>', function(self, buf, opts) -- shunt/nodes/ledger/main.yue:114
      return self:fmt_entry(buf, { -- shunt/nodes/ledger/main.yue:115
        'when', -- shunt/nodes/ledger/main.yue:115
        'what', -- shunt/nodes/ledger/main.yue:115
        'how' -- shunt/nodes/ledger/main.yue:115
      }, opts) -- shunt/nodes/ledger/main.yue:115
    end), -- shunt/nodes/ledger/main.yue:117
    fmt_body = F('([string], LedgerFmtOpts) => <>', function(self, buf, opts) -- shunt/nodes/ledger/main.yue:117
      local max_rows = opts.max_rows -- shunt/nodes/ledger/main.yue:118
      local len = self:len() -- shunt/nodes/ledger/main.yue:120
      if len == 0 then -- shunt/nodes/ledger/main.yue:121
        buf[#buf + 1] = "--- ledger empty ---" -- shunt/nodes/ledger/main.yue:122
        return -- shunt/nodes/ledger/main.yue:123
      end -- shunt/nodes/ledger/main.yue:121
      if max_rows > len then -- shunt/nodes/ledger/main.yue:124
        max_rows = len -- shunt/nodes/ledger/main.yue:125
      end -- shunt/nodes/ledger/main.yue:124
      local entries -- shunt/nodes/ledger/main.yue:126
      do -- shunt/nodes/ledger/main.yue:126
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:126
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:126
        for entry in self.entries:iter() do -- shunt/nodes/ledger/main.yue:126
          _accum_0[_len_0] = entry -- shunt/nodes/ledger/main.yue:126
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:126
        end -- shunt/nodes/ledger/main.yue:126
        entries = _accum_0 -- shunt/nodes/ledger/main.yue:126
      end -- shunt/nodes/ledger/main.yue:126
      do -- shunt/nodes/ledger/main.yue:127
        local _max_0 = 1 -- shunt/nodes/ledger/main.yue:127
        for _index_0 = #entries, _max_0 < 0 and #entries + _max_0 or _max_0, -1 do -- shunt/nodes/ledger/main.yue:127
          local entry = entries[_index_0] -- shunt/nodes/ledger/main.yue:127
          self:fmt_entry(buf, entry, opts) -- shunt/nodes/ledger/main.yue:128
        end -- shunt/nodes/ledger/main.yue:128
      end -- shunt/nodes/ledger/main.yue:128
    end), -- shunt/nodes/ledger/main.yue:130
    fmt_entry = F('([string], Entry, ?LedgerFmtOpts) => <>', function(self, buf, entry, opts) -- shunt/nodes/ledger/main.yue:130
      if opts == nil then -- shunt/nodes/ledger/main.yue:130
        opts = { } -- shunt/nodes/ledger/main.yue:130
      end -- shunt/nodes/ledger/main.yue:130
      local width = opts.width -- shunt/nodes/ledger/main.yue:131
      local columns = { -- shunt/nodes/ledger/main.yue:133
        entry.when, -- shunt/nodes/ledger/main.yue:133
        entry.what, -- shunt/nodes/ledger/main.yue:133
        entry.how -- shunt/nodes/ledger/main.yue:133
      } -- shunt/nodes/ledger/main.yue:133
      local sep = '  ' -- shunt/nodes/ledger/main.yue:135
      local column_widths = { -- shunt/nodes/ledger/main.yue:137
        15, -- shunt/nodes/ledger/main.yue:137
        10 -- shunt/nodes/ledger/main.yue:138
      } -- shunt/nodes/ledger/main.yue:136
      local final_column_width = width - (sum(column_widths)) - #sep * #column_widths -- shunt/nodes/ledger/main.yue:139
      if final_column_width < 0 then -- shunt/nodes/ledger/main.yue:140
        error("internal error: cannot display entry in width of " .. tostring(width) .. " chars, need at least " .. tostring(sum(column_widths + #sep * (#column_widths - 1)))) -- shunt/nodes/ledger/main.yue:141
      end -- shunt/nodes/ledger/main.yue:140
      column_widths[#column_widths + 1] = final_column_width -- shunt/nodes/ledger/main.yue:142
      assert(#column_widths == #columns, 'internal error: different number columns and column widths') -- shunt/nodes/ledger/main.yue:143
      local cells -- shunt/nodes/ledger/main.yue:145
      do -- shunt/nodes/ledger/main.yue:145
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:145
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:145
        for i = 1, #columns do -- shunt/nodes/ledger/main.yue:145
          _accum_0[_len_0] = fmt_cell(columns[i], column_widths[i]) -- shunt/nodes/ledger/main.yue:145
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:145
        end -- shunt/nodes/ledger/main.yue:145
        cells = _accum_0 -- shunt/nodes/ledger/main.yue:145
      end -- shunt/nodes/ledger/main.yue:145
      buf[#buf + 1] = table.concat(cells, sep) -- shunt/nodes/ledger/main.yue:146
    end) -- shunt/nodes/ledger/main.yue:43
  } -- shunt/nodes/ledger/main.yue:43
  if _base_0.__index == nil then -- shunt/nodes/ledger/main.yue:43
    _base_0.__index = _base_0 -- shunt/nodes/ledger/main.yue:43
  end -- shunt/nodes/ledger/main.yue:146
  _class_0 = setmetatable({ -- shunt/nodes/ledger/main.yue:43
    __init = F('(?number, ?string) => <>', function(self, max_len, save_path) -- shunt/nodes/ledger/main.yue:44
      if max_len == nil then -- shunt/nodes/ledger/main.yue:44
        max_len = 100 -- shunt/nodes/ledger/main.yue:44
      end -- shunt/nodes/ledger/main.yue:44
      if save_path == nil then -- shunt/nodes/ledger/main.yue:44
        save_path = ".ledger-state.toml" -- shunt/nodes/ledger/main.yue:44
      end -- shunt/nodes/ledger/main.yue:44
      self.max_len = max_len -- shunt/nodes/ledger/main.yue:44
      self.save_path = save_path -- shunt/nodes/ledger/main.yue:44
      self.entries = Queue('Entry') -- shunt/nodes/ledger/main.yue:45
      self.entry_save_fragments = Queue('string') -- shunt/nodes/ledger/main.yue:46
    end), -- shunt/nodes/ledger/main.yue:43
    __base = _base_0, -- shunt/nodes/ledger/main.yue:43
    __name = "Ledger" -- shunt/nodes/ledger/main.yue:43
  }, { -- shunt/nodes/ledger/main.yue:43
    __index = _base_0, -- shunt/nodes/ledger/main.yue:43
    __call = function(cls, ...) -- shunt/nodes/ledger/main.yue:43
      local _self_0 = setmetatable({ }, _base_0) -- shunt/nodes/ledger/main.yue:43
      cls.__init(_self_0, ...) -- shunt/nodes/ledger/main.yue:43
      return _self_0 -- shunt/nodes/ledger/main.yue:43
    end -- shunt/nodes/ledger/main.yue:43
  }) -- shunt/nodes/ledger/main.yue:43
  _base_0.__class = _class_0 -- shunt/nodes/ledger/main.yue:43
  Ledger = _class_0 -- shunt/nodes/ledger/main.yue:43
end -- shunt/nodes/ledger/main.yue:146
declare_type('LedgerFmtOpts', [[{
  max_rows: number,
  width: number,
}]]) -- shunt/nodes/ledger/main.yue:148
sum = F('([number]) -> number', function(ns) -- shunt/nodes/ledger/main.yue:153
  local tot = 0 -- shunt/nodes/ledger/main.yue:154
  for _index_0 = 1, #ns do -- shunt/nodes/ledger/main.yue:155
    local n = ns[_index_0] -- shunt/nodes/ledger/main.yue:155
    tot = tot + n -- shunt/nodes/ledger/main.yue:156
  end -- shunt/nodes/ledger/main.yue:156
  return tot -- shunt/nodes/ledger/main.yue:157
end) -- shunt/nodes/ledger/main.yue:153
fmt_cell = F('(string, number) -> string', function(string, width) -- shunt/nodes/ledger/main.yue:159
  if #string == width then -- shunt/nodes/ledger/main.yue:160
    return string -- shunt/nodes/ledger/main.yue:161
  else -- shunt/nodes/ledger/main.yue:162
    if #string < width then -- shunt/nodes/ledger/main.yue:162
      return ("%-" .. tostring(width) .. "s"):format(string) -- shunt/nodes/ledger/main.yue:163
    else -- shunt/nodes/ledger/main.yue:165
      return tostring(string:sub(1, width - 3)) .. "..." -- shunt/nodes/ledger/main.yue:165
    end -- shunt/nodes/ledger/main.yue:162
  end -- shunt/nodes/ledger/main.yue:160
end) -- shunt/nodes/ledger/main.yue:159
spec(function() -- shunt/nodes/ledger/main.yue:167
  local describe, it, matchers -- shunt/nodes/ledger/main.yue:0
  do -- shunt/nodes/ledger/main.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/nodes/ledger/main.yue:0
    describe, it, matchers = _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/nodes/ledger/main.yue:0
  end -- shunt/nodes/ledger/main.yue:0
  local deep_eq, eq = matchers.deep_eq, matchers.eq -- shunt/nodes/ledger/main.yue:172
  describe('Ledger', function() -- shunt/nodes/ledger/main.yue:174
    it('rotates its content', function() -- shunt/nodes/ledger/main.yue:175
      local save_path = os.tmpname() -- shunt/nodes/ledger/main.yue:176
      local LEN = 3 -- shunt/nodes/ledger/main.yue:178
      local ledger = Ledger(LEN, save_path) -- shunt/nodes/ledger/main.yue:179
      for i = 1, LEN do -- shunt/nodes/ledger/main.yue:180
        ledger:add({ -- shunt/nodes/ledger/main.yue:181
          when = 'hello', -- shunt/nodes/ledger/main.yue:181
          what = 'world', -- shunt/nodes/ledger/main.yue:181
          how = tostring(i) -- shunt/nodes/ledger/main.yue:181
        }) -- shunt/nodes/ledger/main.yue:181
      end -- shunt/nodes/ledger/main.yue:181
      require('shunt.spec')._assert_that([=[ledger\len!]=], ledger:len(), (eq(LEN)), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(182)); -- shunt/nodes/ledger/main.yue:182
      require('shunt.spec')._expect_that([=[[ entry for entry in ledger.entries\iter! ]]=], (function() -- shunt/nodes/ledger/main.yue:184
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:184
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:184
        for entry in ledger.entries:iter() do -- shunt/nodes/ledger/main.yue:184
          _accum_0[_len_0] = entry -- shunt/nodes/ledger/main.yue:184
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:184
        end -- shunt/nodes/ledger/main.yue:184
        return _accum_0 -- shunt/nodes/ledger/main.yue:184
      end)(), (deep_eq({ -- shunt/nodes/ledger/main.yue:184
        { -- shunt/nodes/ledger/main.yue:184
          when = 'hello', -- shunt/nodes/ledger/main.yue:184
          what = 'world', -- shunt/nodes/ledger/main.yue:184
          how = '1' -- shunt/nodes/ledger/main.yue:184
        }, -- shunt/nodes/ledger/main.yue:184
        { -- shunt/nodes/ledger/main.yue:184
          when = 'hello', -- shunt/nodes/ledger/main.yue:184
          what = 'world', -- shunt/nodes/ledger/main.yue:184
          how = '2' -- shunt/nodes/ledger/main.yue:184
        }, -- shunt/nodes/ledger/main.yue:184
        { -- shunt/nodes/ledger/main.yue:184
          when = 'hello', -- shunt/nodes/ledger/main.yue:184
          what = 'world', -- shunt/nodes/ledger/main.yue:184
          how = '3' -- shunt/nodes/ledger/main.yue:184
        } -- shunt/nodes/ledger/main.yue:184
      })), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(184)) -- shunt/nodes/ledger/main.yue:184
      ledger:add({ -- shunt/nodes/ledger/main.yue:189
        when = 'hello', -- shunt/nodes/ledger/main.yue:189
        what = 'world', -- shunt/nodes/ledger/main.yue:189
        how = 'NEW' -- shunt/nodes/ledger/main.yue:189
      }); -- shunt/nodes/ledger/main.yue:189
      require('shunt.spec')._expect_that([=[[ entry for entry in ledger.entries\iter! ]]=], (function() -- shunt/nodes/ledger/main.yue:190
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:190
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:190
        for entry in ledger.entries:iter() do -- shunt/nodes/ledger/main.yue:190
          _accum_0[_len_0] = entry -- shunt/nodes/ledger/main.yue:190
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:190
        end -- shunt/nodes/ledger/main.yue:190
        return _accum_0 -- shunt/nodes/ledger/main.yue:190
      end)(), (deep_eq({ -- shunt/nodes/ledger/main.yue:190
        { -- shunt/nodes/ledger/main.yue:190
          when = 'hello', -- shunt/nodes/ledger/main.yue:190
          what = 'world', -- shunt/nodes/ledger/main.yue:190
          how = '2' -- shunt/nodes/ledger/main.yue:190
        }, -- shunt/nodes/ledger/main.yue:190
        { -- shunt/nodes/ledger/main.yue:190
          when = 'hello', -- shunt/nodes/ledger/main.yue:190
          what = 'world', -- shunt/nodes/ledger/main.yue:190
          how = '3' -- shunt/nodes/ledger/main.yue:190
        }, -- shunt/nodes/ledger/main.yue:190
        { -- shunt/nodes/ledger/main.yue:190
          when = 'hello', -- shunt/nodes/ledger/main.yue:190
          what = 'world', -- shunt/nodes/ledger/main.yue:190
          how = 'NEW' -- shunt/nodes/ledger/main.yue:190
        } -- shunt/nodes/ledger/main.yue:190
      })), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(190)) -- shunt/nodes/ledger/main.yue:190
      return assert(os.remove(save_path)) -- shunt/nodes/ledger/main.yue:195
    end) -- shunt/nodes/ledger/main.yue:175
    return it('is persisted', function() -- shunt/nodes/ledger/main.yue:197
      local save_path = os.tmpname() -- shunt/nodes/ledger/main.yue:198
      local ledger1 = Ledger(100, save_path) -- shunt/nodes/ledger/main.yue:200
      local ledger2 = Ledger(100, save_path) -- shunt/nodes/ledger/main.yue:201
      ledger1:add({ -- shunt/nodes/ledger/main.yue:203
        when = 'hello', -- shunt/nodes/ledger/main.yue:203
        what = 'world', -- shunt/nodes/ledger/main.yue:203
        how = '1' -- shunt/nodes/ledger/main.yue:203
      }) -- shunt/nodes/ledger/main.yue:203
      ledger1:add({ -- shunt/nodes/ledger/main.yue:204
        when = 'hello', -- shunt/nodes/ledger/main.yue:204
        what = 'world', -- shunt/nodes/ledger/main.yue:204
        how = '2' -- shunt/nodes/ledger/main.yue:204
      }) -- shunt/nodes/ledger/main.yue:204
      local entries1 -- shunt/nodes/ledger/main.yue:205
      do -- shunt/nodes/ledger/main.yue:205
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:205
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:205
        for entry in ledger1:iter() do -- shunt/nodes/ledger/main.yue:205
          _accum_0[_len_0] = entry -- shunt/nodes/ledger/main.yue:205
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:205
        end -- shunt/nodes/ledger/main.yue:205
        entries1 = _accum_0 -- shunt/nodes/ledger/main.yue:205
      end -- shunt/nodes/ledger/main.yue:205
      require('shunt.spec')._assert_that([=[entries1]=], entries1, (deep_eq({ -- shunt/nodes/ledger/main.yue:206
        { -- shunt/nodes/ledger/main.yue:206
          when = 'hello', -- shunt/nodes/ledger/main.yue:206
          what = 'world', -- shunt/nodes/ledger/main.yue:206
          how = '1' -- shunt/nodes/ledger/main.yue:206
        }, -- shunt/nodes/ledger/main.yue:206
        { -- shunt/nodes/ledger/main.yue:206
          when = 'hello', -- shunt/nodes/ledger/main.yue:206
          what = 'world', -- shunt/nodes/ledger/main.yue:206
          how = '2' -- shunt/nodes/ledger/main.yue:206
        } -- shunt/nodes/ledger/main.yue:206
      })), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(206)) -- shunt/nodes/ledger/main.yue:206
      local err = ledger2:load(path) -- shunt/nodes/ledger/main.yue:210
      local entries2 -- shunt/nodes/ledger/main.yue:211
      do -- shunt/nodes/ledger/main.yue:211
        local _accum_0 = { } -- shunt/nodes/ledger/main.yue:211
        local _len_0 = 1 -- shunt/nodes/ledger/main.yue:211
        for entry in ledger2:iter() do -- shunt/nodes/ledger/main.yue:211
          _accum_0[_len_0] = entry -- shunt/nodes/ledger/main.yue:211
          _len_0 = _len_0 + 1 -- shunt/nodes/ledger/main.yue:211
        end -- shunt/nodes/ledger/main.yue:211
        entries2 = _accum_0 -- shunt/nodes/ledger/main.yue:211
      end -- shunt/nodes/ledger/main.yue:211
      require('shunt.spec')._assert_that([=[entries2]=], entries2, (deep_eq({ -- shunt/nodes/ledger/main.yue:212
        { -- shunt/nodes/ledger/main.yue:212
          when = 'hello', -- shunt/nodes/ledger/main.yue:212
          what = 'world', -- shunt/nodes/ledger/main.yue:212
          how = '1' -- shunt/nodes/ledger/main.yue:212
        }, -- shunt/nodes/ledger/main.yue:212
        { -- shunt/nodes/ledger/main.yue:212
          when = 'hello', -- shunt/nodes/ledger/main.yue:212
          what = 'world', -- shunt/nodes/ledger/main.yue:212
          how = '2' -- shunt/nodes/ledger/main.yue:212
        } -- shunt/nodes/ledger/main.yue:212
      })), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(212)); -- shunt/nodes/ledger/main.yue:212
      require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(215)) -- shunt/nodes/ledger/main.yue:215
      return assert(os.remove(save_path)) -- shunt/nodes/ledger/main.yue:217
    end) -- shunt/nodes/ledger/main.yue:217
  end) -- shunt/nodes/ledger/main.yue:174
  describe('fmt_cell', function() -- shunt/nodes/ledger/main.yue:219
    it('preserves right-size input', function() -- shunt/nodes/ledger/main.yue:220
      return require('shunt.spec')._expect_that([=[(fmt_cell 'xxx', 3)]=], (fmt_cell('xxx', 3)), (eq("xxx")), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(221)) -- shunt/nodes/ledger/main.yue:221
    end) -- shunt/nodes/ledger/main.yue:220
    it('pads too-small input', function() -- shunt/nodes/ledger/main.yue:223
      return require('shunt.spec')._expect_that([=[(fmt_cell 'xxx', 6)]=], (fmt_cell('xxx', 6)), (eq("xxx   ")), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(224)) -- shunt/nodes/ledger/main.yue:224
    end) -- shunt/nodes/ledger/main.yue:223
    return it('truncates too-large input', function() -- shunt/nodes/ledger/main.yue:226
      return require('shunt.spec')._expect_that([=[(fmt_cell 'xxxxxx', 5)]=], (fmt_cell('xxxxxx', 5)), (eq("xx...")), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(227)) -- shunt/nodes/ledger/main.yue:227
    end) -- shunt/nodes/ledger/main.yue:227
  end) -- shunt/nodes/ledger/main.yue:219
  return describe('sum', function() -- shunt/nodes/ledger/main.yue:229
    it('adds given values', function() -- shunt/nodes/ledger/main.yue:230
      return require('shunt.spec')._expect_that([=[(sum {1, 2, 3, 4, 5})]=], (sum({ -- shunt/nodes/ledger/main.yue:231
        1, -- shunt/nodes/ledger/main.yue:231
        2, -- shunt/nodes/ledger/main.yue:231
        3, -- shunt/nodes/ledger/main.yue:231
        4, -- shunt/nodes/ledger/main.yue:231
        5 -- shunt/nodes/ledger/main.yue:231
      })), (eq(15)), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(231)) -- shunt/nodes/ledger/main.yue:231
    end) -- shunt/nodes/ledger/main.yue:230
    return it('handles no values', function() -- shunt/nodes/ledger/main.yue:233
      return require('shunt.spec')._expect_that([=[(sum {})]=], (sum({ })), (eq(0)), tostring("shunt/nodes/ledger/main.yue") .. ":" .. tostring(234)) -- shunt/nodes/ledger/main.yue:234
    end) -- shunt/nodes/ledger/main.yue:234
  end) -- shunt/nodes/ledger/main.yue:234
end) -- shunt/nodes/ledger/main.yue:167
return _module_0 -- shunt/nodes/ledger/main.yue:234
end
package.preload['shunt.cmd.start'] = function(...)
-- [yue]: shunt/cmd/start.yue
local _module_0 = { } -- shunt/cmd/start.yue:1
local display, factory, ledger, marshal, subcommand, main, spam -- shunt/cmd/start.yue:1
local Flag, Subcommand -- shunt/cmd/start.yue:0
do -- shunt/cmd/start.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/start.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/cmd/start.yue:0
end -- shunt/cmd/start.yue:0
local config = require('shunt.config').config -- shunt/cmd/start.yue:0
local log = require('shunt.logger').log -- shunt/cmd/start.yue:0
local Pc = require('shunt.pc').Pc -- shunt/cmd/start.yue:0
local Uplink = require('shunt.peripheral.uplink').Uplink -- shunt/cmd/start.yue:0
local F = require('shunt.quicktype').F -- shunt/cmd/start.yue:0
local UpgradeMonitor = require('shunt.upgrade.monitor').UpgradeMonitor -- shunt/cmd/start.yue:0
display = require('shunt.nodes.display.main') -- shunt/cmd/start.yue:11
factory = require('shunt.nodes.factory.main') -- shunt/cmd/start.yue:12
ledger = require('shunt.nodes.ledger.main') -- shunt/cmd/start.yue:13
marshal = require('shunt.nodes.marshal.main') -- shunt/cmd/start.yue:14
do -- shunt/cmd/start.yue:16
  local _with_0 = Subcommand('start') -- shunt/cmd/start.yue:16
  _with_0:description('start this shunt instance') -- shunt/cmd/start.yue:17
  _with_0:add((function() -- shunt/cmd/start.yue:18
    local _with_1 = Flag('fragile') -- shunt/cmd/start.yue:18
    _with_1:description('exit on failure, rather than reattempting') -- shunt/cmd/start.yue:19
    _with_1:short(nil) -- shunt/cmd/start.yue:20
    _with_1:dest('no_reattempt') -- shunt/cmd/start.yue:21
    return _with_1 -- shunt/cmd/start.yue:18
  end)()) -- shunt/cmd/start.yue:18
  _with_0:add((function() -- shunt/cmd/start.yue:22
    local _with_1 = Flag('allow-outdated') -- shunt/cmd/start.yue:22
    _with_1:description('skip upgrade check') -- shunt/cmd/start.yue:23
    _with_1:short(nil) -- shunt/cmd/start.yue:24
    return _with_1 -- shunt/cmd/start.yue:22
  end)()) -- shunt/cmd/start.yue:22
  subcommand = _with_0 -- shunt/cmd/start.yue:16
end -- shunt/cmd/start.yue:16
_module_0["subcommand"] = subcommand -- shunt/cmd/start.yue:24
main = F('({}) -> <>', function(args) -- shunt/cmd/start.yue:26
  local pc = Pc() -- shunt/cmd/start.yue:27
  log(function() -- shunt/cmd/start.yue:28
    return "starting shunt on pc #" .. tostring(pc:id()) -- shunt/cmd/start.yue:28
  end) -- shunt/cmd/start.yue:28
  local cfg, err = config() -- shunt/cmd/start.yue:30
  if (err ~= nil) then -- shunt/cmd/start.yue:31
    print("cannot start shunt: cannot load config: " .. tostring(err)) -- shunt/cmd/start.yue:32
    return -- shunt/cmd/start.yue:33
  end -- shunt/cmd/start.yue:31
  if not (cfg ~= nil) then -- shunt/cmd/start.yue:34
    print('cannot start shunt: config missing\ntry running `shunt init <instance-type>` first') -- shunt/cmd/start.yue:35
    return -- shunt/cmd/start.yue:36
  end -- shunt/cmd/start.yue:34
  if not args.allow_outdated then -- shunt/cmd/start.yue:38
    do -- shunt/cmd/start.yue:39
      local _with_0 = UpgradeMonitor({ -- shunt/cmd/start.yue:39
        config = cfg, -- shunt/cmd/start.yue:39
        pc = pc, -- shunt/cmd/start.yue:39
        uplink = Uplink() -- shunt/cmd/start.yue:39
      }) -- shunt/cmd/start.yue:39
      if _with_0:upgrade_available() then -- shunt/cmd/start.yue:40
        _with_0:upgrade_now() -- shunt/cmd/start.yue:41
      end -- shunt/cmd/start.yue:40
    end -- shunt/cmd/start.yue:39
  end -- shunt/cmd/start.yue:38
  local to_spam -- shunt/cmd/start.yue:43
  if (cfg.marshal ~= nil) then -- shunt/cmd/start.yue:43
    to_spam = function() -- shunt/cmd/start.yue:44
      return marshal.main(cfg) -- shunt/cmd/start.yue:44
    end -- shunt/cmd/start.yue:44
  else -- shunt/cmd/start.yue:45
    if (cfg.display ~= nil) then -- shunt/cmd/start.yue:45
      to_spam = function() -- shunt/cmd/start.yue:46
        return display.main(cfg) -- shunt/cmd/start.yue:46
      end -- shunt/cmd/start.yue:46
    else -- shunt/cmd/start.yue:47
      if (cfg.factory ~= nil) then -- shunt/cmd/start.yue:47
        to_spam = function() -- shunt/cmd/start.yue:48
          return factory.main(cfg) -- shunt/cmd/start.yue:48
        end -- shunt/cmd/start.yue:48
      else -- shunt/cmd/start.yue:49
        if (cfg.ledger ~= nil) then -- shunt/cmd/start.yue:49
          to_spam = function() -- shunt/cmd/start.yue:50
            return ledger.main(cfg) -- shunt/cmd/start.yue:50
          end -- shunt/cmd/start.yue:50
        else -- shunt/cmd/start.yue:52
          print('cannot detect instance type') -- shunt/cmd/start.yue:52
          return -- shunt/cmd/start.yue:53
        end -- shunt/cmd/start.yue:49
      end -- shunt/cmd/start.yue:47
    end -- shunt/cmd/start.yue:45
  end -- shunt/cmd/start.yue:43
  return spam(args.no_reattempt, to_spam) -- shunt/cmd/start.yue:54
end) -- shunt/cmd/start.yue:26
_module_0["main"] = main -- shunt/cmd/start.yue:54
spam = F('(boolean, () -> <>) -> <>', function(no_reattempt, fn) -- shunt/cmd/start.yue:56
  if no_reattempt then -- shunt/cmd/start.yue:57
    fn() -- shunt/cmd/start.yue:58
    return -- shunt/cmd/start.yue:59
  end -- shunt/cmd/start.yue:57
  local attempt = 1 -- shunt/cmd/start.yue:61
  local done = false -- shunt/cmd/start.yue:62
  while not done do -- shunt/cmd/start.yue:63
xpcall(function() -- shunt/cmd/start.yue:64
      fn() -- shunt/cmd/start.yue:65
      done = true -- shunt/cmd/start.yue:66
    end, function(err) -- shunt/cmd/start.yue:66
      local colour -- shunt/cmd/start.yue:68
      do -- shunt/cmd/start.yue:68
        local _obj_0 = term -- shunt/cmd/start.yue:68
        if _obj_0 ~= nil then -- shunt/cmd/start.yue:68
          colour = _obj_0.getTextColor() -- shunt/cmd/start.yue:68
        end -- shunt/cmd/start.yue:68
      end -- shunt/cmd/start.yue:68
      do -- shunt/cmd/start.yue:69
        local _obj_0 = term -- shunt/cmd/start.yue:69
        if _obj_0 ~= nil then -- shunt/cmd/start.yue:69
          _obj_0.setTextColor(colors.red) -- shunt/cmd/start.yue:69
        end -- shunt/cmd/start.yue:69
      end -- shunt/cmd/start.yue:69
      print(debug.traceback(err)) -- shunt/cmd/start.yue:70
      do -- shunt/cmd/start.yue:71
        local _obj_0 = term -- shunt/cmd/start.yue:71
        if _obj_0 ~= nil then -- shunt/cmd/start.yue:71
          _obj_0.setTextColor(colour) -- shunt/cmd/start.yue:71
        end -- shunt/cmd/start.yue:71
      end -- shunt/cmd/start.yue:71
      print("[failed]") -- shunt/cmd/start.yue:73
      os.sleep(10) -- shunt/cmd/start.yue:74
      do -- shunt/cmd/start.yue:75
        local _obj_0 = term -- shunt/cmd/start.yue:75
        if _obj_0 ~= nil then -- shunt/cmd/start.yue:75
          _obj_0.clear() -- shunt/cmd/start.yue:75
        end -- shunt/cmd/start.yue:75
      end -- shunt/cmd/start.yue:75
      attempt = attempt + 1 -- shunt/cmd/start.yue:77
      return print("[attempt " .. tostring(attempt) .. "]") -- shunt/cmd/start.yue:78
    end) -- shunt/cmd/start.yue:78
  end -- shunt/cmd/start.yue:78
end) -- shunt/cmd/start.yue:56
return _module_0 -- shunt/cmd/start.yue:78
end
package.preload['shunt.cmd.upgrade'] = function(...)
-- [yue]: shunt/cmd/upgrade.yue
local _module_0 = { } -- shunt/cmd/upgrade.yue:1
local subcommand, main, TMP_DIR, ReleaseDownloader -- shunt/cmd/upgrade.yue:1
local Flag, Subcommand -- shunt/cmd/upgrade.yue:0
do -- shunt/cmd/upgrade.yue:0
  local _obj_0 = require('shunt.clap') -- shunt/cmd/upgrade.yue:0
  Flag, Subcommand = _obj_0.Flag, _obj_0.Subcommand -- shunt/cmd/upgrade.yue:0
end -- shunt/cmd/upgrade.yue:0
local config = require('shunt.config').config -- shunt/cmd/upgrade.yue:0
local log = require('shunt.logger').log -- shunt/cmd/upgrade.yue:0
local declare_type, F -- shunt/cmd/upgrade.yue:0
do -- shunt/cmd/upgrade.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/cmd/upgrade.yue:0
  declare_type, F = _obj_0.declare_type, _obj_0.F -- shunt/cmd/upgrade.yue:0
end -- shunt/cmd/upgrade.yue:0
local Instigator = require('shunt.upgrade.instigator').Instigator -- shunt/cmd/upgrade.yue:0
local VERSION = require('shunt.version').VERSION -- shunt/cmd/upgrade.yue:0
do -- shunt/cmd/upgrade.yue:10
  local _with_0 = Subcommand('upgrade') -- shunt/cmd/upgrade.yue:10
  _with_0:description('upgrade all shunt versions across all networks') -- shunt/cmd/upgrade.yue:11
  _with_0:add((function() -- shunt/cmd/upgrade.yue:12
    local _with_1 = Flag('force') -- shunt/cmd/upgrade.yue:12
    _with_1:short(nil) -- shunt/cmd/upgrade.yue:13
    _with_1:description('skip version check') -- shunt/cmd/upgrade.yue:14
    return _with_1 -- shunt/cmd/upgrade.yue:12
  end)()) -- shunt/cmd/upgrade.yue:12
  _with_0:add((function() -- shunt/cmd/upgrade.yue:15
    local _with_1 = Flag('yes') -- shunt/cmd/upgrade.yue:15
    _with_1:description('skip confirmation') -- shunt/cmd/upgrade.yue:16
    return _with_1 -- shunt/cmd/upgrade.yue:15
  end)()) -- shunt/cmd/upgrade.yue:15
  subcommand = _with_0 -- shunt/cmd/upgrade.yue:10
end -- shunt/cmd/upgrade.yue:10
_module_0["subcommand"] = subcommand -- shunt/cmd/upgrade.yue:16
main = F('({}) -> <>', function(args) -- shunt/cmd/upgrade.yue:18
  local release -- shunt/cmd/upgrade.yue:19
  local RELEASE_REPO_URL = 'https://gitlab.legitcorp.com/kcza/shunt/-/raw/master' -- shunt/cmd/upgrade.yue:20
  do -- shunt/cmd/upgrade.yue:21
    local _with_0 = ReleaseDownloader(RELEASE_REPO_URL) -- shunt/cmd/upgrade.yue:21
    local err -- shunt/cmd/upgrade.yue:22
    release, err = _with_0:get_file('shunt') -- shunt/cmd/upgrade.yue:22
    if (err ~= nil) then -- shunt/cmd/upgrade.yue:23
      error(err) -- shunt/cmd/upgrade.yue:24
    end -- shunt/cmd/upgrade.yue:23
  end -- shunt/cmd/upgrade.yue:21
  if not args.force and release.version <= VERSION then -- shunt/cmd/upgrade.yue:25
    print('already up to date') -- shunt/cmd/upgrade.yue:26
    return -- shunt/cmd/upgrade.yue:27
  end -- shunt/cmd/upgrade.yue:25
  local cfg, err = config() -- shunt/cmd/upgrade.yue:29
  if (err ~= nil) then -- shunt/cmd/upgrade.yue:30
    print("cannot load config: " .. tostring(err)) -- shunt/cmd/upgrade.yue:31
    return -- shunt/cmd/upgrade.yue:32
  end -- shunt/cmd/upgrade.yue:30
  do -- shunt/cmd/upgrade.yue:34
    local _with_0 = Instigator(config(), release) -- shunt/cmd/upgrade.yue:34
    _with_0:upgrade(not args.yes) -- shunt/cmd/upgrade.yue:35
  end -- shunt/cmd/upgrade.yue:34
  return -- shunt/cmd/upgrade.yue:36
end) -- shunt/cmd/upgrade.yue:18
_module_0["main"] = main -- shunt/cmd/upgrade.yue:36
TMP_DIR = '.upgrade_tmp' -- shunt/cmd/upgrade.yue:38
_module_0["TMP_DIR"] = TMP_DIR -- shunt/cmd/upgrade.yue:38
declare_type('Release', [[{
  file: string,
  version: string,
  content: string,
}]]) -- shunt/cmd/upgrade.yue:40
do -- shunt/cmd/upgrade.yue:46
  local _class_0 -- shunt/cmd/upgrade.yue:46
  local _base_0 = { -- shunt/cmd/upgrade.yue:46
    get_file = F('(string) => Release', function(self, file) -- shunt/cmd/upgrade.yue:49
      log(function() -- shunt/cmd/upgrade.yue:50
        return "getting " .. tostring(file) .. "..." -- shunt/cmd/upgrade.yue:50
      end) -- shunt/cmd/upgrade.yue:50
      local content -- shunt/cmd/upgrade.yue:52
      do -- shunt/cmd/upgrade.yue:53
        local _with_0 = assert(http.get(tostring(self.release_repo_url) .. "/" .. tostring(file))) -- shunt/cmd/upgrade.yue:53
        content = _with_0:readAll() -- shunt/cmd/upgrade.yue:54
        _with_0:close() -- shunt/cmd/upgrade.yue:55
      end -- shunt/cmd/upgrade.yue:53
      local version = nil -- shunt/cmd/upgrade.yue:57
      for v in content:gmatch([=[VERSION = ['"]([0-9][^'"]*)['"]]=]) do -- shunt/cmd/upgrade.yue:58
        if (version ~= nil) then -- shunt/cmd/upgrade.yue:59
          error('internal error: multiple versions found in downloaded file') -- shunt/cmd/upgrade.yue:60
        end -- shunt/cmd/upgrade.yue:59
        version = v -- shunt/cmd/upgrade.yue:61
      end -- shunt/cmd/upgrade.yue:61
      if not (version ~= nil) then -- shunt/cmd/upgrade.yue:62
        error('internal error: no version found in downloaded file') -- shunt/cmd/upgrade.yue:63
      end -- shunt/cmd/upgrade.yue:62
      return { -- shunt/cmd/upgrade.yue:65
        file = file, -- shunt/cmd/upgrade.yue:65
        version = version, -- shunt/cmd/upgrade.yue:65
        content = content -- shunt/cmd/upgrade.yue:65
      } -- shunt/cmd/upgrade.yue:65
    end) -- shunt/cmd/upgrade.yue:46
  } -- shunt/cmd/upgrade.yue:46
  if _base_0.__index == nil then -- shunt/cmd/upgrade.yue:46
    _base_0.__index = _base_0 -- shunt/cmd/upgrade.yue:46
  end -- shunt/cmd/upgrade.yue:65
  _class_0 = setmetatable({ -- shunt/cmd/upgrade.yue:46
    __init = function(self, release_repo_url) -- shunt/cmd/upgrade.yue:47
      self.release_repo_url = release_repo_url -- shunt/cmd/upgrade.yue:47
    end, -- shunt/cmd/upgrade.yue:46
    __base = _base_0, -- shunt/cmd/upgrade.yue:46
    __name = "ReleaseDownloader" -- shunt/cmd/upgrade.yue:46
  }, { -- shunt/cmd/upgrade.yue:46
    __index = _base_0, -- shunt/cmd/upgrade.yue:46
    __call = function(cls, ...) -- shunt/cmd/upgrade.yue:46
      local _self_0 = setmetatable({ }, _base_0) -- shunt/cmd/upgrade.yue:46
      cls.__init(_self_0, ...) -- shunt/cmd/upgrade.yue:46
      return _self_0 -- shunt/cmd/upgrade.yue:46
    end -- shunt/cmd/upgrade.yue:46
  }) -- shunt/cmd/upgrade.yue:46
  _base_0.__class = _class_0 -- shunt/cmd/upgrade.yue:46
  ReleaseDownloader = _class_0 -- shunt/cmd/upgrade.yue:46
end -- shunt/cmd/upgrade.yue:65
return _module_0 -- shunt/cmd/upgrade.yue:65
end
package.preload['shunt.instrument'] = function(...)
-- [yue]: shunt/instrument.yue
local _module_0 = { } -- shunt/instrument.yue:1
local instrument, instrument_hook -- shunt/instrument.yue:1
local instrument_file -- shunt/instrument.yue:3
instrument = function(f) -- shunt/instrument.yue:4
  instrument_file = assert(io.open('.shunt-run.csv', 'w+')) -- shunt/instrument.yue:5
  debug.sethook(instrument_hook, 'cr') -- shunt/instrument.yue:6
  f() -- shunt/instrument.yue:7
  debug.sethook(nil) -- shunt/instrument.yue:8
  instrument_file:close() -- shunt/instrument.yue:9
  instrument_file = nil -- shunt/instrument.yue:10
end -- shunt/instrument.yue:4
_module_0["instrument"] = instrument -- shunt/instrument.yue:10
instrument_hook = function(event) -- shunt/instrument.yue:12
  do -- shunt/instrument.yue:13
    local _with_0 = debug.getinfo(2, 'Snl') -- shunt/instrument.yue:13
    if _with_0.what ~= 'Lua' then -- shunt/instrument.yue:14
      return -- shunt/instrument.yue:15
    end -- shunt/instrument.yue:14
    if not (_with_0.name ~= nil) then -- shunt/instrument.yue:16
      return -- shunt/instrument.yue:17
    end -- shunt/instrument.yue:16
    instrument_file:write(tostring(_with_0.name) .. "_" .. tostring(_with_0.currentline) .. "\n") -- shunt/instrument.yue:18
  end -- shunt/instrument.yue:13
  return -- shunt/instrument.yue:20
end -- shunt/instrument.yue:12
return _module_0 -- shunt/instrument.yue:20
end
package.preload['shunt.monitor'] = function(...)
-- [yue]: shunt/monitor.yue
local _module_0 = { } -- shunt/monitor.yue:1
local detect_and_use_monitor -- shunt/monitor.yue:1
detect_and_use_monitor = function() -- shunt/monitor.yue:3
  do -- shunt/monitor.yue:4
    local monitor -- shunt/monitor.yue:4
    do -- shunt/monitor.yue:4
      local _obj_0 = peripheral -- shunt/monitor.yue:4
      if _obj_0 ~= nil then -- shunt/monitor.yue:4
        monitor = _obj_0.find('monitor') -- shunt/monitor.yue:4
      end -- shunt/monitor.yue:4
    end -- shunt/monitor.yue:4
    if monitor then -- shunt/monitor.yue:4
      monitor.clear() -- shunt/monitor.yue:5
      monitor.setTextScale(0.6) -- shunt/monitor.yue:6
      monitor.setCursorPos(1, 1) -- shunt/monitor.yue:7
      print('see monitor') -- shunt/monitor.yue:9
      return term.redirect(monitor) -- shunt/monitor.yue:10
    end -- shunt/monitor.yue:4
  end -- shunt/monitor.yue:4
end -- shunt/monitor.yue:3
_module_0["detect_and_use_monitor"] = detect_and_use_monitor -- shunt/monitor.yue:10
return _module_0 -- shunt/monitor.yue:10
end
package.preload['shunt.component'] = function(...)
-- [yue]: shunt/component.yue
local declare_type = require('shunt.quicktype').declare_type -- shunt/component.yue:0
declare_type('Component', [[{
  events: Queue,
  step: () => <>,
}]]) -- shunt/component.yue:5
return declare_type('NetworkComponent', [[  Component + {
    firewall: Firewall,
  }
]]) -- shunt/component.yue:13
end
package.preload['shunt.writelite'] = function(...)
-- [yue]: shunt/writelite.yue
local _module_0 = { } -- shunt/writelite.yue:1
local FORMAT_VERSION, MIN_PAGE_SIZE, injected_failures, activated_failure_points, CORRUPTION_WARNING, MAIN_PRELUDE, JOURNAL_PRELUDE, OsFs, PageCache, Transaction, Journal, NIL_TAG, NIL_TAG_CHAR, TRUE_TAG, TRUE_TAG_CHAR, FALSE_TAG, FALSE_TAG_CHAR, INT_TYPE, FLOAT_TYPE, FLOAT_TYPE_CHAR, STRING_TAG, STRING_TAG_CHAR, TABLE_REF_TAG, TABLE_REF_TAG_CHAR, TABLE_PAYLOAD_TAG, BLANK_TAG, BLANK_TAG_CHAR, TAG_MASK, INT_LEN_SHIFT, INT_LEN_MASK, Serialiser, MAX_INT, MIN_INT, is_float, Deserialiser, Page, MAX_HASH, Hasher, print_serialised -- shunt/writelite.yue:1
local HOST = require('shunt.compat').HOST -- shunt/writelite.yue:0
local declare_singleton_type, declare_type, F, T -- shunt/writelite.yue:0
do -- shunt/writelite.yue:0
  local _obj_0 = require('shunt.quicktype') -- shunt/writelite.yue:0
  declare_singleton_type, declare_type, F, T = _obj_0.declare_singleton_type, _obj_0.declare_type, _obj_0.F, _obj_0.T -- shunt/writelite.yue:0
end -- shunt/writelite.yue:0
local spec = require('shunt.spec').spec -- shunt/writelite.yue:0
FORMAT_VERSION = 1 -- shunt/writelite.yue:7
MIN_PAGE_SIZE = 1024 -- shunt/writelite.yue:8
injected_failures = nil -- shunt/writelite.yue:10
activated_failure_points = nil -- shunt/writelite.yue:11
declare_type('writelite.Writelite', [[{
  mode: (writelite.Mode) => Self,
  page_size: (number) => Self,
  open: () => <boolean, ?string>,
  transaction: ((writelite.Transaction) -> <>) => <>,
  close: () => <boolean, ?string>,
}]]) -- shunt/writelite.yue:49
declare_type('writelite.Mode', '"blob"') -- shunt/writelite.yue:56
declare_type('writelite.MainHeader', [[{
  format_version: 1,
  page_size: number,
  mode: writelite.Mode,
}]]) -- shunt/writelite.yue:57
local Writelite -- shunt/writelite.yue:62
do -- shunt/writelite.yue:62
  local _class_0 -- shunt/writelite.yue:62
  local _base_0 = { -- shunt/writelite.yue:62
    mode = F('(writelite.Mode) => Self', function(self, mode) -- shunt/writelite.yue:76
      if (self._mode ~= nil) then -- shunt/writelite.yue:77
        error("cannot change mode once set") -- shunt/writelite.yue:78
      end -- shunt/writelite.yue:77
      self._mode = mode -- shunt/writelite.yue:79
      return self -- shunt/writelite.yue:80
    end), -- shunt/writelite.yue:82
    page_size = F('(number) => Self', function(self, page_size) -- shunt/writelite.yue:82
      if self._page_size_set then -- shunt/writelite.yue:83
        error("cannot change page size once set") -- shunt/writelite.yue:84
      end -- shunt/writelite.yue:83
      if page_size < MIN_PAGE_SIZE then -- shunt/writelite.yue:85
        error("cannot change page size to " .. tostring(page_size) .. ": minimum is " .. tostring(MIN_PAGE_SIZE)) -- shunt/writelite.yue:86
      end -- shunt/writelite.yue:85
      if page_size % 1 ~= 0 then -- shunt/writelite.yue:87
        error("cannot change page size to " .. tostring(page_size) .. ": not an integer") -- shunt/writelite.yue:88
      end -- shunt/writelite.yue:87
      local shifted = page_size -- shunt/writelite.yue:91
      while 0 == bit.band(shifted, 1) do -- shunt/writelite.yue:92
        shifted = bit.brshift(shifted, 1) -- shunt/writelite.yue:93
      end -- shunt/writelite.yue:93
      if shifted > 1 then -- shunt/writelite.yue:94
        error("cannot change page size to " .. tostring(page_size) .. ": not a power of 2") -- shunt/writelite.yue:95
      end -- shunt/writelite.yue:94
      self._page_size_set = true -- shunt/writelite.yue:97
      self._page_size = page_size -- shunt/writelite.yue:98
      return self -- shunt/writelite.yue:99
    end), -- shunt/writelite.yue:101
    max_cached_pages = F('(number) => Self', function(self, max_cached_pages) -- shunt/writelite.yue:101
      self._page_cache:set_max_cached_pages(max_cached_pages) -- shunt/writelite.yue:102
      return self -- shunt/writelite.yue:103
    end), -- shunt/writelite.yue:105
    open = F('() => <boolean, ?string>', function(self) -- shunt/writelite.yue:105
      if self._open then -- shunt/writelite.yue:106
        return false, 'cannot open writelite twice' -- shunt/writelite.yue:107
      end -- shunt/writelite.yue:106
      self._open = true -- shunt/writelite.yue:108
      if not (self._mode ~= nil) then -- shunt/writelite.yue:110
        return false, 'cannot open main file: mode unspecified' -- shunt/writelite.yue:111
      end -- shunt/writelite.yue:110
      if (injected_failures ~= nil) and injected_failures['pre-open'] then -- shunt/writelite.yue:113
        if activated_failure_points == nil then -- shunt/writelite.yue:113
          activated_failure_points = { } -- shunt/writelite.yue:113
        end -- shunt/writelite.yue:113
        activated_failure_points['pre-open'] = true -- shunt/writelite.yue:113
        error('FAILURE_MARKER-pre-open') -- shunt/writelite.yue:113
      end -- shunt/writelite.yue:113
      local main_file, _, _ = self._fs:open(self._path, 'rb+') -- shunt/writelite.yue:114
      if not (main_file ~= nil) then -- shunt/writelite.yue:115
        local err -- shunt/writelite.yue:120
        main_file, err, _ = self._fs:open(self._path, 'wb+') -- shunt/writelite.yue:120
        if (err ~= nil) then -- shunt/writelite.yue:121
          return false, "cannot open main file: " .. tostring(err) -- shunt/writelite.yue:122
        end -- shunt/writelite.yue:121
      end -- shunt/writelite.yue:115
      main_file:setvbuf('full') -- shunt/writelite.yue:123
      self._main_file = main_file; -- shunt/writelite.yue:124
      if (injected_failures ~= nil) and injected_failures['post-open'] then -- shunt/writelite.yue:125
        if activated_failure_points == nil then -- shunt/writelite.yue:125
          activated_failure_points = { } -- shunt/writelite.yue:125
        end -- shunt/writelite.yue:125
        activated_failure_points['post-open'] = true -- shunt/writelite.yue:125
        error('FAILURE_MARKER-post-open') -- shunt/writelite.yue:125
      end -- shunt/writelite.yue:125
      local main_end_index, err = self._main_file:seek('end', 0) -- shunt/writelite.yue:127
      if (err ~= nil) then -- shunt/writelite.yue:128
        return false, "cannot read main file: " .. tostring(err) -- shunt/writelite.yue:129
      end -- shunt/writelite.yue:128
      local journal_file -- shunt/writelite.yue:131
      journal_file, _ = self._fs:open(self._journal_path, 'rb') -- shunt/writelite.yue:131
      if (journal_file ~= nil) then -- shunt/writelite.yue:132
        local journal_content = journal_file:read('*a') -- shunt/writelite.yue:133
        journal_file:close(); -- shunt/writelite.yue:134
        if (injected_failures ~= nil) and injected_failures['post-journal-read'] then -- shunt/writelite.yue:135
          if activated_failure_points == nil then -- shunt/writelite.yue:135
            activated_failure_points = { } -- shunt/writelite.yue:135
          end -- shunt/writelite.yue:135
          activated_failure_points['post-journal-read'] = true -- shunt/writelite.yue:135
          error('FAILURE_MARKER-post-journal-read') -- shunt/writelite.yue:135
        end -- shunt/writelite.yue:135
        local journal -- shunt/writelite.yue:137
        journal, err = Journal:load(journal_content, self._page_size) -- shunt/writelite.yue:137
        if (err ~= nil) then -- shunt/writelite.yue:138
          error("cannot load journal: " .. tostring(err)) -- shunt/writelite.yue:139
        end -- shunt/writelite.yue:138
        if (injected_failures ~= nil) and injected_failures['post-journal-load'] then -- shunt/writelite.yue:140
          if activated_failure_points == nil then -- shunt/writelite.yue:140
            activated_failure_points = { } -- shunt/writelite.yue:140
          end -- shunt/writelite.yue:140
          activated_failure_points['post-journal-load'] = true -- shunt/writelite.yue:140
          error('FAILURE_MARKER-post-journal-load') -- shunt/writelite.yue:140
        end -- shunt/writelite.yue:140
        if (journal ~= nil) then -- shunt/writelite.yue:141
          local _list_0 = journal:pages() -- shunt/writelite.yue:142
          for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:142
            local page = _list_0[_index_0] -- shunt/writelite.yue:142
            local offset, content = page.offset, page.content -- shunt/writelite.yue:143
            _, err = self._main_file:seek('set', offset) -- shunt/writelite.yue:144
            if (err ~= nil) then -- shunt/writelite.yue:145
              error("cannot seek in main file") -- shunt/writelite.yue:146
            end -- shunt/writelite.yue:145
            _, err = self._main_file:write(content) -- shunt/writelite.yue:147
            if (err ~= nil) then -- shunt/writelite.yue:148
              error("cannot write to main file") -- shunt/writelite.yue:149
            end -- shunt/writelite.yue:148
            if (injected_failures ~= nil) and injected_failures['mid-journal-recovery'] then -- shunt/writelite.yue:150
              if activated_failure_points == nil then -- shunt/writelite.yue:150
                activated_failure_points = { } -- shunt/writelite.yue:150
              end -- shunt/writelite.yue:150
              activated_failure_points['mid-journal-recovery'] = true -- shunt/writelite.yue:150
              error('FAILURE_MARKER-mid-journal-recovery') -- shunt/writelite.yue:150
            end -- shunt/writelite.yue:150
          end -- shunt/writelite.yue:150
        end -- shunt/writelite.yue:141
        if (injected_failures ~= nil) and injected_failures['pre-journal-removal'] then -- shunt/writelite.yue:153
          if activated_failure_points == nil then -- shunt/writelite.yue:153
            activated_failure_points = { } -- shunt/writelite.yue:153
          end -- shunt/writelite.yue:153
          activated_failure_points['pre-journal-removal'] = true -- shunt/writelite.yue:153
          error('FAILURE_MARKER-pre-journal-removal') -- shunt/writelite.yue:153
        end -- shunt/writelite.yue:153
        self._fs:remove(self._journal_path); -- shunt/writelite.yue:154
        if (injected_failures ~= nil) and injected_failures['post-journal-removal'] then -- shunt/writelite.yue:155
          if activated_failure_points == nil then -- shunt/writelite.yue:155
            activated_failure_points = { } -- shunt/writelite.yue:155
          end -- shunt/writelite.yue:155
          activated_failure_points['post-journal-removal'] = true -- shunt/writelite.yue:155
          error('FAILURE_MARKER-post-journal-removal') -- shunt/writelite.yue:155
        end -- shunt/writelite.yue:155
      end -- shunt/writelite.yue:132
      local main_header -- shunt/writelite.yue:157
      if main_end_index == 0 then -- shunt/writelite.yue:158
        main_header = self:_make_main_header() -- shunt/writelite.yue:159
        err = self:_format_main(main_header) -- shunt/writelite.yue:160
        if (err ~= nil) then -- shunt/writelite.yue:161
          return false, err -- shunt/writelite.yue:162
        end -- shunt/writelite.yue:161
      else -- shunt/writelite.yue:164
        main_header, err = self:_read_main_header() -- shunt/writelite.yue:164
        if (err ~= nil) then -- shunt/writelite.yue:165
          return false, "cannot open writelite: " .. tostring(err) -- shunt/writelite.yue:166
        end -- shunt/writelite.yue:165
      end -- shunt/writelite.yue:158
      return true, nil -- shunt/writelite.yue:169
    end), -- shunt/writelite.yue:171
    _make_main_header = F('() => writelite.MainHeader', function(self) -- shunt/writelite.yue:171
      local header = T('writelite.MainHeader', { -- shunt/writelite.yue:173
        format_version = FORMAT_VERSION, -- shunt/writelite.yue:173
        page_size = self._page_size, -- shunt/writelite.yue:174
        mode = self._mode, -- shunt/writelite.yue:175
        checksum = 0 -- shunt/writelite.yue:176
      }) -- shunt/writelite.yue:172
      local checksum = Hasher:hash(header) -- shunt/writelite.yue:178
      header.checksum = checksum -- shunt/writelite.yue:180
      return header -- shunt/writelite.yue:181
    end), -- shunt/writelite.yue:183
    _read_main_header = F('() => <?writelite.MainHeader, ?string>', function(self) -- shunt/writelite.yue:183
      self._main_file:seek('set', 0) -- shunt/writelite.yue:184
      local raw_header, err = self._main_file:read(MIN_PAGE_SIZE) -- shunt/writelite.yue:185
      if (err ~= nil) then -- shunt/writelite.yue:186
        return nil, err -- shunt/writelite.yue:187
      end -- shunt/writelite.yue:186
      if not (raw_header ~= nil) then -- shunt/writelite.yue:188
        return nil, "main file empty" -- shunt/writelite.yue:189
      end -- shunt/writelite.yue:188
      local header = (Deserialiser(raw_header:sub(#MAIN_PRELUDE + 1))):parse() -- shunt/writelite.yue:190
      local checkers = { -- shunt/writelite.yue:194
        format_version = function(fv) -- shunt/writelite.yue:194
          if fv ~= FORMAT_VERSION then -- shunt/writelite.yue:194
            return "format version mismatch" -- shunt/writelite.yue:195
          end -- shunt/writelite.yue:194
        end, -- shunt/writelite.yue:194
        mode = function(m) -- shunt/writelite.yue:196
          if m ~= self._mode then -- shunt/writelite.yue:196
            return "mode mismatch" -- shunt/writelite.yue:197
          end -- shunt/writelite.yue:196
        end, -- shunt/writelite.yue:196
        page_size = function(ps) -- shunt/writelite.yue:198
          if ps ~= self._page_size then -- shunt/writelite.yue:198
            return "page size mismatch" -- shunt/writelite.yue:199
          end -- shunt/writelite.yue:198
        end, -- shunt/writelite.yue:198
        checksum = function() end -- shunt/writelite.yue:200
      } -- shunt/writelite.yue:193
      for key, value in pairs(header) do -- shunt/writelite.yue:201
        local checker = checkers[key] -- shunt/writelite.yue:202
        if not (checker ~= nil) then -- shunt/writelite.yue:203
          error("internal error: no such checker '" .. tostring(key) .. "'") -- shunt/writelite.yue:204
        end -- shunt/writelite.yue:203
        err = checker(value) -- shunt/writelite.yue:205
        if (err ~= nil) then -- shunt/writelite.yue:206
          return nil, "cannot open " .. tostring(self._path) .. ": " .. tostring(err) -- shunt/writelite.yue:207
        end -- shunt/writelite.yue:206
      end -- shunt/writelite.yue:207
      local stored_checksum = header.checksum -- shunt/writelite.yue:209
      header.checksum = 0 -- shunt/writelite.yue:210
      local computed_checksum = Hasher:hash(header) -- shunt/writelite.yue:211
      if stored_checksum ~= computed_checksum then -- shunt/writelite.yue:212
        return nil, "header corrupt (computed_checksum=" .. tostring(computed_checksum) .. ", stored_checksum=" .. tostring(stored_checksum) .. ")" -- shunt/writelite.yue:213
      end -- shunt/writelite.yue:212
      header.checksum = stored_checksum -- shunt/writelite.yue:214
      return header -- shunt/writelite.yue:216
    end), -- shunt/writelite.yue:218
    _format_main = F('(writelite.MainHeader) => ?string', function(self, header) -- shunt/writelite.yue:218
      local fragments = { -- shunt/writelite.yue:220
        MAIN_PRELUDE, -- shunt/writelite.yue:220
        Serialiser:serialise(header) -- shunt/writelite.yue:221
      } -- shunt/writelite.yue:219
      local current_size = 0 -- shunt/writelite.yue:223
      for _index_0 = 1, #fragments do -- shunt/writelite.yue:224
        local fragment = fragments[_index_0] -- shunt/writelite.yue:224
        current_size = current_size + (#fragment) -- shunt/writelite.yue:225
      end -- shunt/writelite.yue:225
      fragments[#fragments + 1] = ('\0'):rep(MIN_PAGE_SIZE - current_size) -- shunt/writelite.yue:226
      local to_write = table.concat(fragments) -- shunt/writelite.yue:228
      if #to_write > MIN_PAGE_SIZE then -- shunt/writelite.yue:229
        error("internal error: first page too large: " .. tostring(#to_write) .. " > " .. tostring(MIN_PAGE_SIZE)) -- shunt/writelite.yue:230
      end -- shunt/writelite.yue:229
      local _, err = self._main_file:seek('set', 0) -- shunt/writelite.yue:231
      if (err ~= nil) then -- shunt/writelite.yue:232
        return err -- shunt/writelite.yue:233
      end -- shunt/writelite.yue:232
      _, err = self._main_file:write(to_write) -- shunt/writelite.yue:234
      if (err ~= nil) then -- shunt/writelite.yue:235
        return err -- shunt/writelite.yue:236
      end -- shunt/writelite.yue:235
      _, err = self._main_file:flush() -- shunt/writelite.yue:237
      return err -- shunt/writelite.yue:238
    end), -- shunt/writelite.yue:240
    transaction = F('((writelite.Transaction) -> <>) => <>', function(self, f) -- shunt/writelite.yue:240
      self.__class._open_transactions[self._path] = true -- shunt/writelite.yue:241
      local txn = Transaction(self) -- shunt/writelite.yue:243
      local err = nil -- shunt/writelite.yue:244
xpcall(function() -- shunt/writelite.yue:245
        return f(txn) -- shunt/writelite.yue:246
      end, function(err2) -- shunt/writelite.yue:246
        err = err2 -- shunt/writelite.yue:248
        return txn:abort() -- shunt/writelite.yue:249
      end) -- shunt/writelite.yue:249
      self.__class._open_transactions[self._path] = nil -- shunt/writelite.yue:251
      if (injected_failures ~= nil) and injected_failures['mid-transaction'] then -- shunt/writelite.yue:253
        if activated_failure_points == nil then -- shunt/writelite.yue:253
          activated_failure_points = { } -- shunt/writelite.yue:253
        end -- shunt/writelite.yue:253
        activated_failure_points['mid-transaction'] = true -- shunt/writelite.yue:253
        error('FAILURE_MARKER-mid-transaction') -- shunt/writelite.yue:253
      end -- shunt/writelite.yue:253
      local err2 = txn:_close(); -- shunt/writelite.yue:254
      if (injected_failures ~= nil) and injected_failures['post-transaction'] then -- shunt/writelite.yue:255
        if activated_failure_points == nil then -- shunt/writelite.yue:255
          activated_failure_points = { } -- shunt/writelite.yue:255
        end -- shunt/writelite.yue:255
        activated_failure_points['post-transaction'] = true -- shunt/writelite.yue:255
        error('FAILURE_MARKER-post-transaction') -- shunt/writelite.yue:255
      end -- shunt/writelite.yue:255
      if (err ~= nil) then -- shunt/writelite.yue:257
        error(err) -- shunt/writelite.yue:258
      end -- shunt/writelite.yue:257
      if (err2 ~= nil) then -- shunt/writelite.yue:259
        error(err2) -- shunt/writelite.yue:260
      end -- shunt/writelite.yue:259
      return -- shunt/writelite.yue:261
    end), -- shunt/writelite.yue:263
    close = F('() => <boolean, ?string>', function(self) -- shunt/writelite.yue:263
      local _, file_closure_error = self._main_file:close() -- shunt/writelite.yue:264
      if self.__class._open_transactions[self._path] then -- shunt/writelite.yue:266
        return false, "cannot close writelite file " .. tostring(self._path) .. ": a transaction is open" -- shunt/writelite.yue:267
      end -- shunt/writelite.yue:266
      if not self._open then -- shunt/writelite.yue:269
        return false, "cannot close writelite file " .. tostring(self._path) .. ": not open" -- shunt/writelite.yue:270
      end -- shunt/writelite.yue:269
      self._open = false -- shunt/writelite.yue:271
      return not (file_closure_error ~= nil), file_closure_error -- shunt/writelite.yue:273
    end), -- shunt/writelite.yue:279
    _ut_max_cached_pages = F('() => number', function(self) -- shunt/writelite.yue:279
      return self._page_cache.max_cached_pages -- shunt/writelite.yue:280
    end) -- shunt/writelite.yue:62
  } -- shunt/writelite.yue:62
  if _base_0.__index == nil then -- shunt/writelite.yue:62
    _base_0.__index = _base_0 -- shunt/writelite.yue:62
  end -- shunt/writelite.yue:280
  _class_0 = setmetatable({ -- shunt/writelite.yue:62
    __init = F('(string, ?writelite.Fs) => <>', function(self, _path, _fs) -- shunt/writelite.yue:65
      if _fs == nil then -- shunt/writelite.yue:65
        _fs = OsFs() -- shunt/writelite.yue:65
      end -- shunt/writelite.yue:65
      self._path = _path -- shunt/writelite.yue:65
      self._fs = _fs -- shunt/writelite.yue:65
      self._journal_path = T('string', self._path .. '~') -- shunt/writelite.yue:66
      self._main_file = T('?writelite.File', nil) -- shunt/writelite.yue:67
      self._open = T('boolean', false) -- shunt/writelite.yue:68
      self._mode = T('?writelite.Mode', nil) -- shunt/writelite.yue:69
      self._page_size = 4096 -- shunt/writelite.yue:70
      self._page_size_set = T('boolean', false) -- shunt/writelite.yue:71
      self._injected_failures = T('?{string}', nil) -- shunt/writelite.yue:72
      self._page_cache = PageCache(self) -- shunt/writelite.yue:74
    end), -- shunt/writelite.yue:62
    __base = _base_0, -- shunt/writelite.yue:62
    __name = "Writelite" -- shunt/writelite.yue:62
  }, { -- shunt/writelite.yue:62
    __index = _base_0, -- shunt/writelite.yue:62
    __call = function(cls, ...) -- shunt/writelite.yue:62
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:62
      cls.__init(_self_0, ...) -- shunt/writelite.yue:62
      return _self_0 -- shunt/writelite.yue:62
    end -- shunt/writelite.yue:62
  }) -- shunt/writelite.yue:62
  _base_0.__class = _class_0 -- shunt/writelite.yue:62
  local self = _class_0; -- shunt/writelite.yue:62
  self._open_transactions = T('{string}', { }) -- shunt/writelite.yue:63
  self._zero_page = F('() => string', function(self) -- shunt/writelite.yue:275
    if self._cached_zero_page == nil then -- shunt/writelite.yue:276
      self._cached_zero_page = ('\0'):rep(self._page_size) -- shunt/writelite.yue:276
    end -- shunt/writelite.yue:276
    return self._cached_zero_page -- shunt/writelite.yue:277
  end) -- shunt/writelite.yue:275
  Writelite = _class_0 -- shunt/writelite.yue:62
end -- shunt/writelite.yue:280
_module_0["Writelite"] = Writelite -- shunt/writelite.yue:62
CORRUPTION_WARNING = T('string', '\n+----------------------------------------------+\n|                                              |\n|                !!! STOP !!!                  |\n|                                              |\n|                DO NOT EDIT!                  |\n|                                              |\n|   Editing this file will corrupt its data.   |\n|                                              |\n| Close this file and DO NOT SAVE any changes. |\n|                                              |\n|             EXIT the editor NOW.             |\n|                                              |\n+----------------------------------------------+\n') -- shunt/writelite.yue:282
MAIN_PRELUDE = "#!writelite\0\0\0\0\0" .. tostring(CORRUPTION_WARNING) -- shunt/writelite.yue:297
JOURNAL_PRELUDE = "#!writelitejrnl\0" .. tostring(CORRUPTION_WARNING) -- shunt/writelite.yue:298
declare_type('writelite.Fs', [[{
  open: (string, writelite.FileMode) => <?writelite.File, ?string, ?number>,
  remove: (string) => boolean,
}]]) -- shunt/writelite.yue:300
declare_type('writelite.FileMode', [[  "r"|"w"|"a"
  |"r+"|"w+"|"a+"
  |"rb"|"wb"|"ab"
  |"rb+"|"wb+"|"ab+"
]]) -- shunt/writelite.yue:304
declare_type('writelite.File', [[~{
  read: ("*a"|number) => <?string, ?string>,
  write: (string) => ?string,
  seek: (Whence, ?number) => <?number, ?string>,
  setvbuf: ("full") => <>,
  flush: () => <boolean, ?string>,
  close: () => <boolean, ?string>,
}]]) -- shunt/writelite.yue:310
do -- shunt/writelite.yue:318
  local _class_0 -- shunt/writelite.yue:318
  local _base_0 = { -- shunt/writelite.yue:318
    open = F('(string, writelite.FileMode) => <?writelite.File, ?string, ?number>', function(self, path, mode) -- shunt/writelite.yue:321
      return io.open(tostring(self.dir) .. "/" .. tostring(path), mode) -- shunt/writelite.yue:322
    end), -- shunt/writelite.yue:324
    remove = F('(string) => boolean', function(self, path) -- shunt/writelite.yue:324
      return os.remove(path) -- shunt/writelite.yue:325
    end) -- shunt/writelite.yue:318
  } -- shunt/writelite.yue:318
  if _base_0.__index == nil then -- shunt/writelite.yue:318
    _base_0.__index = _base_0 -- shunt/writelite.yue:318
  end -- shunt/writelite.yue:325
  _class_0 = setmetatable({ -- shunt/writelite.yue:318
    __init = F('(?string) => <>', function(self, dir) -- shunt/writelite.yue:319
      if dir == nil then -- shunt/writelite.yue:319
        dir = '.' -- shunt/writelite.yue:319
      end -- shunt/writelite.yue:319
      self.dir = dir -- shunt/writelite.yue:319
    end), -- shunt/writelite.yue:318
    __base = _base_0, -- shunt/writelite.yue:318
    __name = "OsFs" -- shunt/writelite.yue:318
  }, { -- shunt/writelite.yue:318
    __index = _base_0, -- shunt/writelite.yue:318
    __call = function(cls, ...) -- shunt/writelite.yue:318
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:318
      cls.__init(_self_0, ...) -- shunt/writelite.yue:318
      return _self_0 -- shunt/writelite.yue:318
    end -- shunt/writelite.yue:318
  }) -- shunt/writelite.yue:318
  _base_0.__class = _class_0 -- shunt/writelite.yue:318
  OsFs = _class_0 -- shunt/writelite.yue:318
end -- shunt/writelite.yue:325
declare_type('writelite.PageCache', [[{
  get: (number) => ?writelite.Page,
  set: (number, writelite.Page) => <>,
  set_max_cached_pages: (number) => <>,
}]]) -- shunt/writelite.yue:327
declare_type('writelite.PageCacheOpts', [[{
  _page_size: number,
  _main_file: ?writelite.File, -- Lazy
}]]) -- shunt/writelite.yue:332
do -- shunt/writelite.yue:336
  local _class_0 -- shunt/writelite.yue:336
  local _base_0 = { -- shunt/writelite.yue:336
    get = F('(number) => ?writelite.Page', function(self, offset) -- shunt/writelite.yue:346
      local page_size = self.opts._page_size -- shunt/writelite.yue:347
      if offset % page_size ~= 0 then -- shunt/writelite.yue:349
        error("internal error: page-cache offset must be a multiple of the page size") -- shunt/writelite.yue:350
      end -- shunt/writelite.yue:349
      self.lru_map[offset] = self.lru_counter -- shunt/writelite.yue:352
      self.lru_counter = self.lru_counter + 1 -- shunt/writelite.yue:353
      do -- shunt/writelite.yue:355
        local page = self.cached_pages[offset] -- shunt/writelite.yue:355
        if page then -- shunt/writelite.yue:355
          return page -- shunt/writelite.yue:356
        end -- shunt/writelite.yue:355
      end -- shunt/writelite.yue:355
      if self.num_cached_pages >= self.max_cached_pages then -- shunt/writelite.yue:358
        self:discard_old() -- shunt/writelite.yue:359
      end -- shunt/writelite.yue:358
      local page -- shunt/writelite.yue:361
      do -- shunt/writelite.yue:361
        local main_file = self.opts._main_file -- shunt/writelite.yue:362
        main_file:seek('set', offset) -- shunt/writelite.yue:363
        local content -- shunt/writelite.yue:365
        do -- shunt/writelite.yue:365
          local err -- shunt/writelite.yue:366
          content, err = main_file:read(page_size) -- shunt/writelite.yue:366
          if (err ~= nil) then -- shunt/writelite.yue:367
            error(err) -- shunt/writelite.yue:368
          end -- shunt/writelite.yue:367
          if content ~= nil then -- shunt/writelite.yue:369
            content = content -- shunt/writelite.yue:369
          else -- shunt/writelite.yue:369
            content = '' -- shunt/writelite.yue:369
          end -- shunt/writelite.yue:369
          if #content < page_size then -- shunt/writelite.yue:370
            content = content .. ('\0'):rep(page_size - #content) -- shunt/writelite.yue:371
          end -- shunt/writelite.yue:370
          content = content -- shunt/writelite.yue:372
        end -- shunt/writelite.yue:372
        if #content ~= page_size then -- shunt/writelite.yue:373
          error("internal error: incorrect page size (" .. tostring(#content) .. " != " .. tostring(page_size) .. ")") -- shunt/writelite.yue:374
        end -- shunt/writelite.yue:373
        page = Page({ -- shunt/writelite.yue:376
          offset = offset, -- shunt/writelite.yue:376
          content = content -- shunt/writelite.yue:377
        }) -- shunt/writelite.yue:375
      end -- shunt/writelite.yue:377
      self.num_cached_pages = self.num_cached_pages + 1 -- shunt/writelite.yue:379
      self.cached_pages[offset] = page -- shunt/writelite.yue:380
      return page -- shunt/writelite.yue:381
    end), -- shunt/writelite.yue:383
    set = F('(number, writelite.Page) => <>', function(self, offset, page) -- shunt/writelite.yue:383
      local page_size = self.opts._page_size -- shunt/writelite.yue:384
      if offset % page_size ~= 0 then -- shunt/writelite.yue:386
        error("internal error: page-cache offset must be a multiple of the page size") -- shunt/writelite.yue:387
      end -- shunt/writelite.yue:386
      if #page.content ~= page_size then -- shunt/writelite.yue:388
        error("internal error: page has the wrong size (" .. tostring(#page.content) .. " != " .. tostring(page_size) .. ")") -- shunt/writelite.yue:389
      end -- shunt/writelite.yue:388
      if offset ~= page.offset then -- shunt/writelite.yue:390
        error("internal error: required and declared offset mismatch (" .. tostring(offset) .. " != " .. tostring(page.offset) .. ")") -- shunt/writelite.yue:391
      end -- shunt/writelite.yue:390
      self.lru_map[offset] = self.lru_counter -- shunt/writelite.yue:393
      self.lru_counter = self.lru_counter + 1 -- shunt/writelite.yue:394
      if not (self.cached_pages[offset] ~= nil) then -- shunt/writelite.yue:396
        self.num_cached_pages = self.num_cached_pages + 1 -- shunt/writelite.yue:397
      end -- shunt/writelite.yue:396
      self.cached_pages[offset] = page -- shunt/writelite.yue:398
      if self.num_cached_pages > self.max_cached_pages then -- shunt/writelite.yue:400
        return self:discard_old() -- shunt/writelite.yue:401
      end -- shunt/writelite.yue:400
    end), -- shunt/writelite.yue:403
    discard_old = F('() => <>', function(self) -- shunt/writelite.yue:403
      local discard_horizon = self.lru_counter - self.max_cached_pages * 0.5 -- shunt/writelite.yue:404
      local indices_to_discard -- shunt/writelite.yue:405
      do -- shunt/writelite.yue:405
        local _with_0 = { } -- shunt/writelite.yue:405
        for index, last_used in pairs(self.lru_map) do -- shunt/writelite.yue:406
          if last_used < discard_horizon then -- shunt/writelite.yue:407
            _with_0[#_with_0 + 1] = index -- shunt/writelite.yue:408
          end -- shunt/writelite.yue:407
        end -- shunt/writelite.yue:408
        indices_to_discard = _with_0 -- shunt/writelite.yue:405
      end -- shunt/writelite.yue:405
      for _index_0 = 1, #indices_to_discard do -- shunt/writelite.yue:409
        local index = indices_to_discard[_index_0] -- shunt/writelite.yue:409
        self.lru_map[index] = nil -- shunt/writelite.yue:410
        self.cached_pages[index] = nil -- shunt/writelite.yue:411
      end -- shunt/writelite.yue:411
      self.num_cached_pages = self.num_cached_pages - (#indices_to_discard) -- shunt/writelite.yue:412
    end), -- shunt/writelite.yue:414
    set_max_cached_pages = F('(number) => <>', function(self, max_cached_pages) -- shunt/writelite.yue:414
      if max_cached_pages < 1 then -- shunt/writelite.yue:415
        error("cannot set max cached pages to " .. tostring(max_cached_pages) .. ": too small") -- shunt/writelite.yue:416
      end -- shunt/writelite.yue:415
      if is_float(max_cached_pages) then -- shunt/writelite.yue:417
        error("cannot set max cached pages to " .. tostring(max_cached_pages) .. ": not an integer") -- shunt/writelite.yue:418
      end -- shunt/writelite.yue:417
      self.max_cached_pages = max_cached_pages -- shunt/writelite.yue:419
    end) -- shunt/writelite.yue:336
  } -- shunt/writelite.yue:336
  if _base_0.__index == nil then -- shunt/writelite.yue:336
    _base_0.__index = _base_0 -- shunt/writelite.yue:336
  end -- shunt/writelite.yue:419
  _class_0 = setmetatable({ -- shunt/writelite.yue:336
    __init = F('(writelite.PageCacheOpts) => <>', function(self, opts) -- shunt/writelite.yue:337
      self.opts = opts -- shunt/writelite.yue:337
      self.cached_pages = T('{number->writelite.Page}', { }) -- shunt/writelite.yue:340
      self.num_cached_pages = T('number', 0) -- shunt/writelite.yue:341
      self.lru_map = T('{number->number}', { }) -- shunt/writelite.yue:342
      self.lru_counter = T('number', 0) -- shunt/writelite.yue:343
      self.max_cached_pages = T('number', 1000) -- shunt/writelite.yue:344
    end), -- shunt/writelite.yue:336
    __base = _base_0, -- shunt/writelite.yue:336
    __name = "PageCache" -- shunt/writelite.yue:336
  }, { -- shunt/writelite.yue:336
    __index = _base_0, -- shunt/writelite.yue:336
    __call = function(cls, ...) -- shunt/writelite.yue:336
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:336
      cls.__init(_self_0, ...) -- shunt/writelite.yue:336
      return _self_0 -- shunt/writelite.yue:336
    end -- shunt/writelite.yue:336
  }) -- shunt/writelite.yue:336
  _base_0.__class = _class_0 -- shunt/writelite.yue:336
  PageCache = _class_0 -- shunt/writelite.yue:336
end -- shunt/writelite.yue:419
declare_type('writelite.Transaction', [[{
  write: (string) => <>,
  seek: (Whence, ?number) => <?number, ?string>,
  abort: () => <>,
}]]) -- shunt/writelite.yue:421
declare_type('Whence', '"set"|"cur"|"end"') -- shunt/writelite.yue:426
declare_type('writelite.Delta', [[{
  offset: number,
  content: string,
}]]) -- shunt/writelite.yue:427
do -- shunt/writelite.yue:431
  local _class_0 -- shunt/writelite.yue:431
  local _base_0 = { -- shunt/writelite.yue:431
    write = F('(string) => <>', function(self, bytes) -- shunt/writelite.yue:439
      if self._mode ~= 'blob' then -- shunt/writelite.yue:440
        error("cannot use write method in " .. tostring(self._mode) .. " mode (must be in blob mode)") -- shunt/writelite.yue:441
      end -- shunt/writelite.yue:440
      if self._aborted then -- shunt/writelite.yue:442
        error('cannot write to aborted transaction') -- shunt/writelite.yue:443
      end -- shunt/writelite.yue:442
      local offset = self._cursor + self._page_size -- shunt/writelite.yue:445
      do -- shunt/writelite.yue:446
        local _obj_0 = self._deltas -- shunt/writelite.yue:446
        _obj_0[#_obj_0 + 1] = { -- shunt/writelite.yue:447
          offset = offset, -- shunt/writelite.yue:447
          content = bytes -- shunt/writelite.yue:448
        } -- shunt/writelite.yue:446
      end -- shunt/writelite.yue:448
      self._cursor = self._cursor + (#bytes) -- shunt/writelite.yue:449
    end), -- shunt/writelite.yue:451
    seek = F('(Whence, ?number) => <>', function(self, whence, offset) -- shunt/writelite.yue:451
      if self._aborted then -- shunt/writelite.yue:452
        error('cannot seek in aborted transaction') -- shunt/writelite.yue:453
      end -- shunt/writelite.yue:452
      local new_cursor -- shunt/writelite.yue:455
      if 'set' == whence then -- shunt/writelite.yue:457
        if offset ~= nil then -- shunt/writelite.yue:458
          new_cursor = offset -- shunt/writelite.yue:458
        else -- shunt/writelite.yue:458
          new_cursor = 0 -- shunt/writelite.yue:458
        end -- shunt/writelite.yue:458
        if new_cursor < 0 then -- shunt/writelite.yue:459
          error("cannot seek to negative position") -- shunt/writelite.yue:460
        end -- shunt/writelite.yue:459
      elseif 'cur' == whence then -- shunt/writelite.yue:461
        assert((offset ~= nil), 'internal error: "cur"-whence requires offset') -- shunt/writelite.yue:462
        new_cursor = new_cursor + offset -- shunt/writelite.yue:463
      elseif 'end' == whence then -- shunt/writelite.yue:464
        assert(not (offset ~= nil), 'internal error: "end"-whence cannot have no offset') -- shunt/writelite.yue:465
        new_cursor = self._len -- shunt/writelite.yue:466
      else -- shunt/writelite.yue:468
        error('internal error: unreachable') -- shunt/writelite.yue:468
      end -- shunt/writelite.yue:468
      self._cursor = new_cursor -- shunt/writelite.yue:469
    end), -- shunt/writelite.yue:471
    abort = F('() => <>', function(self) -- shunt/writelite.yue:471
      self._aborted = true -- shunt/writelite.yue:472
    end), -- shunt/writelite.yue:474
    _close = F('() => ?string', function(self) -- shunt/writelite.yue:474
      local journal_path = self._parent._journal_path -- shunt/writelite.yue:475
      if self._aborted then -- shunt/writelite.yue:477
        self._parent._fs:remove(journal_path) -- shunt/writelite.yue:479
        return nil -- shunt/writelite.yue:480
      end -- shunt/writelite.yue:477
      local pages_to_write = self:_pages_to_write() -- shunt/writelite.yue:483
      if #pages_to_write == 0 then -- shunt/writelite.yue:485
        return nil -- shunt/writelite.yue:487
      end -- shunt/writelite.yue:485
      do -- shunt/writelite.yue:489
        local journal = Journal(self._page_size) -- shunt/writelite.yue:490
        for _index_0 = 1, #pages_to_write do -- shunt/writelite.yue:491
          local page = pages_to_write[_index_0] -- shunt/writelite.yue:491
          journal:add(page) -- shunt/writelite.yue:492
        end -- shunt/writelite.yue:492
        local fs = self._parent._fs -- shunt/writelite.yue:494
        local journal_file, err = fs:open(journal_path, 'wb+') -- shunt/writelite.yue:495
        if (err ~= nil) then -- shunt/writelite.yue:496
          error("cannot open journal file '" .. tostring(journal_path) .. "': " .. tostring(err)) -- shunt/writelite.yue:497
        end -- shunt/writelite.yue:496
        do -- shunt/writelite.yue:498
          journal_file:setvbuf('full') -- shunt/writelite.yue:499
          local _ -- shunt/writelite.yue:500
          _, err = journal:write_to(journal_file) -- shunt/writelite.yue:500
          if (err ~= nil) then -- shunt/writelite.yue:501
            error("cannot write to journal file '" .. tostring(journal_path) .. "': " .. tostring(err)) -- shunt/writelite.yue:502
          end -- shunt/writelite.yue:501
          _, err = journal_file:close() -- shunt/writelite.yue:503
          if (err ~= nil) then -- shunt/writelite.yue:504
            error("cannot close journal file '" .. tostring(journal_path) .. ": " .. tostring(err)) -- shunt/writelite.yue:505
          end -- shunt/writelite.yue:504
        end -- shunt/writelite.yue:498
      end -- shunt/writelite.yue:505
      local main_file = self._parent._main_file -- shunt/writelite.yue:508
      for _index_0 = 1, #pages_to_write do -- shunt/writelite.yue:509
        local page = pages_to_write[_index_0] -- shunt/writelite.yue:509
        local _, err = main_file:seek('set', page.offset) -- shunt/writelite.yue:510
        if (err ~= nil) then -- shunt/writelite.yue:511
          return "cannot seek in main file: " .. tostring(err) -- shunt/writelite.yue:512
        end -- shunt/writelite.yue:511
        _, err = main_file:write(page.content) -- shunt/writelite.yue:513
        if (err ~= nil) then -- shunt/writelite.yue:514
          return "cannot write to main file: " .. tostring(err) -- shunt/writelite.yue:515
        end -- shunt/writelite.yue:514
      end -- shunt/writelite.yue:515
      local _, err = main_file:flush() -- shunt/writelite.yue:517
      if (err ~= nil) then -- shunt/writelite.yue:518
        return "cannot flush main file: " .. tostring(err) -- shunt/writelite.yue:519
      end -- shunt/writelite.yue:518
      self._parent._fs:remove(journal_path) -- shunt/writelite.yue:522
      return nil -- shunt/writelite.yue:523
    end), -- shunt/writelite.yue:525
    _pages_to_write = F('() => [writelite.Page]', function(self) -- shunt/writelite.yue:525
      local page_cache, page_size -- shunt/writelite.yue:526
      do -- shunt/writelite.yue:526
        local _obj_0 = self._parent -- shunt/writelite.yue:529
        page_cache, page_size = _obj_0._page_cache, _obj_0._page_size -- shunt/writelite.yue:526
      end -- shunt/writelite.yue:529
      local page_sized_deltas -- shunt/writelite.yue:531
      do -- shunt/writelite.yue:531
        local _with_0 = { } -- shunt/writelite.yue:531
        local _list_0 = self._deltas -- shunt/writelite.yue:532
        for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:532
          local delta = _list_0[_index_0] -- shunt/writelite.yue:532
          local _continue_0 = false -- shunt/writelite.yue:533
          repeat -- shunt/writelite.yue:533
            local offset, content = delta.offset, delta.content -- shunt/writelite.yue:533
            local start_page_offset = self:_to_page_offset(offset) -- shunt/writelite.yue:535
            local end_page_offset = self:_to_page_offset(offset + #content) -- shunt/writelite.yue:536
            if start_page_offset == end_page_offset then -- shunt/writelite.yue:537
              _with_0[#_with_0 + 1] = { -- shunt/writelite.yue:539
                page_offset = start_page_offset, -- shunt/writelite.yue:539
                offset = offset % page_size, -- shunt/writelite.yue:540
                content = content -- shunt/writelite.yue:541
              } -- shunt/writelite.yue:538
              _continue_0 = true -- shunt/writelite.yue:542
              break -- shunt/writelite.yue:542
            end -- shunt/writelite.yue:537
            local first_chunk_size = page_size - offset % page_size -- shunt/writelite.yue:544
            _with_0[#_with_0 + 1] = { -- shunt/writelite.yue:546
              page_offset = start_page_offset, -- shunt/writelite.yue:546
              offset = offset % page_size, -- shunt/writelite.yue:547
              content = content:sub(1, first_chunk_size) -- shunt/writelite.yue:548
            } -- shunt/writelite.yue:545
            local chunk_offset = offset -- shunt/writelite.yue:549
            for start_idx = 1 + first_chunk_size, #content, page_size do -- shunt/writelite.yue:550
              local end_idx = start_idx + page_size - 1 -- shunt/writelite.yue:551
              if end_idx > #content then -- shunt/writelite.yue:552
                end_idx = #content -- shunt/writelite.yue:553
              end -- shunt/writelite.yue:552
              _with_0[#_with_0 + 1] = { -- shunt/writelite.yue:555
                page_offset = self:_to_page_offset(start_idx + offset), -- shunt/writelite.yue:555
                offset = 0, -- shunt/writelite.yue:556
                content = content:sub(start_idx, end_idx) -- shunt/writelite.yue:557
              } -- shunt/writelite.yue:554
              chunk_offset = chunk_offset + page_size -- shunt/writelite.yue:558
            end -- shunt/writelite.yue:558
            _continue_0 = true -- shunt/writelite.yue:533
          until true -- shunt/writelite.yue:558
          if not _continue_0 then -- shunt/writelite.yue:558
            break -- shunt/writelite.yue:558
          end -- shunt/writelite.yue:558
        end -- shunt/writelite.yue:558
        page_sized_deltas = _with_0 -- shunt/writelite.yue:531
      end -- shunt/writelite.yue:531
      for _index_0 = 1, #page_sized_deltas do -- shunt/writelite.yue:560
        local delta = page_sized_deltas[_index_0] -- shunt/writelite.yue:560
        if #delta.content > page_size then -- shunt/writelite.yue:561
          error("internal error: chunk too large: " .. tostring(#delta.content) .. " > " .. tostring(page_size) .. " at (" .. tostring(delta.page_offset) .. ", " .. tostring(delta.offset) .. ")#") -- shunt/writelite.yue:562
        end -- shunt/writelite.yue:561
        if delta.offset > page_size then -- shunt/writelite.yue:563
          error("internal error: invalid delta offset: " .. tostring(delta.offset) .. " > " .. tostring(page_size)) -- shunt/writelite.yue:564
        end -- shunt/writelite.yue:563
      end -- shunt/writelite.yue:564
      local deltas_by_page -- shunt/writelite.yue:566
      do -- shunt/writelite.yue:566
        local _with_0 = { } -- shunt/writelite.yue:566
        for _index_0 = 1, #page_sized_deltas do -- shunt/writelite.yue:567
          local delta = page_sized_deltas[_index_0] -- shunt/writelite.yue:567
          local page_offset = delta.page_offset -- shunt/writelite.yue:568
          if _with_0[page_offset] == nil then -- shunt/writelite.yue:569
            _with_0[page_offset] = { } -- shunt/writelite.yue:569
          end -- shunt/writelite.yue:569
          do -- shunt/writelite.yue:570
            local _obj_0 = _with_0[page_offset] -- shunt/writelite.yue:570
            _obj_0[#_obj_0 + 1] = delta -- shunt/writelite.yue:570
          end -- shunt/writelite.yue:570
        end -- shunt/writelite.yue:570
        deltas_by_page = _with_0 -- shunt/writelite.yue:566
      end -- shunt/writelite.yue:566
      local ret -- shunt/writelite.yue:572
      do -- shunt/writelite.yue:572
        local _with_0 = { } -- shunt/writelite.yue:572
        for page_offset, page_deltas in pairs(deltas_by_page) do -- shunt/writelite.yue:573
          local content_bytes = { } -- shunt/writelite.yue:574
          for _index_0 = 1, #page_deltas do -- shunt/writelite.yue:575
            local delta = page_deltas[_index_0] -- shunt/writelite.yue:575
            local offset, content = delta.offset, delta.content -- shunt/writelite.yue:576
            for i = 1, #content do -- shunt/writelite.yue:581
              content_bytes[offset + i] = content:byte(i) -- shunt/writelite.yue:582
            end -- shunt/writelite.yue:582
          end -- shunt/writelite.yue:582
          local gaps_present = false -- shunt/writelite.yue:584
          for i = 1, page_size do -- shunt/writelite.yue:585
            if not (content_bytes[i] ~= nil) then -- shunt/writelite.yue:586
              gaps_present = true -- shunt/writelite.yue:587
              break -- shunt/writelite.yue:588
            end -- shunt/writelite.yue:586
          end -- shunt/writelite.yue:588
          if gaps_present then -- shunt/writelite.yue:589
            local prev_page = assert(page_cache:get(page_offset)) -- shunt/writelite.yue:590
            local prev_page_content = prev_page.content -- shunt/writelite.yue:591
            for i = 1, page_size do -- shunt/writelite.yue:592
              if not (content_bytes[i] ~= nil) then -- shunt/writelite.yue:593
                content_bytes[i] = prev_page_content:byte(i) -- shunt/writelite.yue:594
              end -- shunt/writelite.yue:593
            end -- shunt/writelite.yue:594
          end -- shunt/writelite.yue:589
          if #content_bytes ~= page_size then -- shunt/writelite.yue:595
            error("internal error: produced page does not match page size " .. tostring(#content_bytes) .. " != " .. tostring(page_size)) -- shunt/writelite.yue:596
          end -- shunt/writelite.yue:595
          _with_0[#_with_0 + 1] = Page({ -- shunt/writelite.yue:599
            offset = page_offset, -- shunt/writelite.yue:599
            content = table.concat((function() -- shunt/writelite.yue:600
              local _accum_0 = { } -- shunt/writelite.yue:600
              local _len_0 = 1 -- shunt/writelite.yue:600
              for _index_0 = 1, #content_bytes do -- shunt/writelite.yue:600
                local c = content_bytes[_index_0] -- shunt/writelite.yue:600
                _accum_0[_len_0] = string.char(c) -- shunt/writelite.yue:600
                _len_0 = _len_0 + 1 -- shunt/writelite.yue:600
              end -- shunt/writelite.yue:600
              return _accum_0 -- shunt/writelite.yue:600
            end)()) -- shunt/writelite.yue:600
          }) -- shunt/writelite.yue:598
        end -- shunt/writelite.yue:600
        ret = _with_0 -- shunt/writelite.yue:572
      end -- shunt/writelite.yue:572
      table.sort(ret, function(a, b) -- shunt/writelite.yue:601
        return a.offset < b.offset -- shunt/writelite.yue:601
      end) -- shunt/writelite.yue:601
      return ret -- shunt/writelite.yue:602
    end), -- shunt/writelite.yue:604
    _to_page_offset = F('(number) => number', function(self, offset) -- shunt/writelite.yue:604
      return offset - offset % self._parent._page_size -- shunt/writelite.yue:605
    end) -- shunt/writelite.yue:431
  } -- shunt/writelite.yue:431
  if _base_0.__index == nil then -- shunt/writelite.yue:431
    _base_0.__index = _base_0 -- shunt/writelite.yue:431
  end -- shunt/writelite.yue:605
  _class_0 = setmetatable({ -- shunt/writelite.yue:431
    __init = F('(writelite.Writelite) => <>', function(self, _parent) -- shunt/writelite.yue:432
      self._parent = _parent -- shunt/writelite.yue:432
      self._deltas = T('[writelite.Delta]', { }) -- shunt/writelite.yue:433
      self._cursor = T('number', 0) -- shunt/writelite.yue:434
      self._aborted = T('boolean', false) -- shunt/writelite.yue:435
      self._page_size = self._parent._page_size -- shunt/writelite.yue:436
      self._mode = T('writelite.Mode', self._parent._mode) -- shunt/writelite.yue:437
    end), -- shunt/writelite.yue:431
    __base = _base_0, -- shunt/writelite.yue:431
    __name = "Transaction" -- shunt/writelite.yue:431
  }, { -- shunt/writelite.yue:431
    __index = _base_0, -- shunt/writelite.yue:431
    __call = function(cls, ...) -- shunt/writelite.yue:431
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:431
      cls.__init(_self_0, ...) -- shunt/writelite.yue:431
      return _self_0 -- shunt/writelite.yue:431
    end -- shunt/writelite.yue:431
  }) -- shunt/writelite.yue:431
  _base_0.__class = _class_0 -- shunt/writelite.yue:431
  Transaction = _class_0 -- shunt/writelite.yue:431
end -- shunt/writelite.yue:605
declare_type('writelite.Journal', [[{
  pages: () => [writelite.Page],
  add: (writelite.Page) => <>,
  write_to: (writelite.File) => <boolean, ?string>,
}]]) -- shunt/writelite.yue:607
declare_type('writelite.JournalHeader', [[{
  format_version: 1,
  page_size: number,
  mode: writelite.JournalMode,
  payload_length: number,
}]]) -- shunt/writelite.yue:612
declare_type('writelite.JournalMode', '"delete"') -- shunt/writelite.yue:618
do -- shunt/writelite.yue:619
  local _class_0 -- shunt/writelite.yue:619
  local _base_0 = { -- shunt/writelite.yue:619
    _validate_raw = F('(writelite.JournalHeader, number, string) => ?string', function(self, header, header_end_index, content) -- shunt/writelite.yue:636
      local first_page = content:sub(1, self._page_size - 1) -- shunt/writelite.yue:637
      if not (first_page ~= nil) then -- shunt/writelite.yue:638
        return "header missing" -- shunt/writelite.yue:639
      end -- shunt/writelite.yue:638
      if (first_page:sub(1, #JOURNAL_PRELUDE)) ~= JOURNAL_PRELUDE then -- shunt/writelite.yue:640
        return "prelude was edited" -- shunt/writelite.yue:641
      end -- shunt/writelite.yue:640
      local format_version, page_size, mode, payload_length = header.format_version, header.page_size, header.mode, header.payload_length -- shunt/writelite.yue:643
      if format_version ~= FORMAT_VERSION then -- shunt/writelite.yue:649
        return "format version " .. tostring(format_version) .. " unsupported" -- shunt/writelite.yue:650
      end -- shunt/writelite.yue:649
      if mode ~= 'delete' then -- shunt/writelite.yue:651
        return "unrecognised journal mode '" .. tostring(mode) .. "'" -- shunt/writelite.yue:652
      end -- shunt/writelite.yue:651
      if payload_length < 0 then -- shunt/writelite.yue:653
        return "invalid payload length " .. tostring(payload_length) -- shunt/writelite.yue:654
      end -- shunt/writelite.yue:653
      local expected_content_len = payload_length + header_end_index -- shunt/writelite.yue:655
      if #content ~= expected_content_len then -- shunt/writelite.yue:656
        return "unexpected length: expected " .. tostring(expected_content_len) .. " but got " .. tostring(#content) -- shunt/writelite.yue:657
      end -- shunt/writelite.yue:656
      return nil -- shunt/writelite.yue:659
    end), -- shunt/writelite.yue:661
    pages = F('() => [writelite.Page]', function(self) -- shunt/writelite.yue:661
      return self._pages -- shunt/writelite.yue:662
    end), -- shunt/writelite.yue:664
    add = F('(writelite.Page) => <>', function(self, page) -- shunt/writelite.yue:664
      do -- shunt/writelite.yue:665
        local _obj_0 = self._pages -- shunt/writelite.yue:665
        _obj_0[#_obj_0 + 1] = page -- shunt/writelite.yue:665
      end -- shunt/writelite.yue:665
    end), -- shunt/writelite.yue:667
    write_to = F('(writelite.File) => <boolean, ?string>', function(self, file) -- shunt/writelite.yue:667
      local serialised_pages = Serialiser:serialise(self._pages) -- shunt/writelite.yue:668
      local header = T('writelite.JournalHeader', { -- shunt/writelite.yue:670
        format_version = FORMAT_VERSION, -- shunt/writelite.yue:670
        page_size = self._page_size, -- shunt/writelite.yue:671
        mode = 'delete', -- shunt/writelite.yue:672
        payload_length = #serialised_pages -- shunt/writelite.yue:673
      }) -- shunt/writelite.yue:669
      local _, err = file:write(table.concat({ -- shunt/writelite.yue:675
        JOURNAL_PRELUDE, -- shunt/writelite.yue:675
        Serialiser:serialise(header), -- shunt/writelite.yue:676
        serialised_pages -- shunt/writelite.yue:677
      })) -- shunt/writelite.yue:674
      if (err ~= nil) then -- shunt/writelite.yue:678
        return false, err -- shunt/writelite.yue:679
      end -- shunt/writelite.yue:678
      return true, nil -- shunt/writelite.yue:680
    end) -- shunt/writelite.yue:619
  } -- shunt/writelite.yue:619
  if _base_0.__index == nil then -- shunt/writelite.yue:619
    _base_0.__index = _base_0 -- shunt/writelite.yue:619
  end -- shunt/writelite.yue:680
  _class_0 = setmetatable({ -- shunt/writelite.yue:619
    __init = F('(number) => <>', function(self, _page_size) -- shunt/writelite.yue:620
      self._page_size = _page_size -- shunt/writelite.yue:620
      self._pages = T('[writelite.Page]', { }) -- shunt/writelite.yue:621
      self._header = T('?writelite.JournalHeader', nil) -- shunt/writelite.yue:622
    end), -- shunt/writelite.yue:619
    __base = _base_0, -- shunt/writelite.yue:619
    __name = "Journal" -- shunt/writelite.yue:619
  }, { -- shunt/writelite.yue:619
    __index = _base_0, -- shunt/writelite.yue:619
    __call = function(cls, ...) -- shunt/writelite.yue:619
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:619
      cls.__init(_self_0, ...) -- shunt/writelite.yue:619
      return _self_0 -- shunt/writelite.yue:619
    end -- shunt/writelite.yue:619
  }) -- shunt/writelite.yue:619
  _base_0.__class = _class_0 -- shunt/writelite.yue:619
  local self = _class_0; -- shunt/writelite.yue:619
  self.load = F('(string, number) => <?writelite.Journal, ?string>', function(self, content, page_size) -- shunt/writelite.yue:624
    local journal -- shunt/writelite.yue:625
    do -- shunt/writelite.yue:625
      local _with_0 = Journal(page_size) -- shunt/writelite.yue:625
      local de = Deserialiser(content, #JOURNAL_PRELUDE + 1) -- shunt/writelite.yue:626
      local header = T('writelite.JournalHeader', de:parse()) -- shunt/writelite.yue:627
      local err = _with_0:_validate_raw(header, de.index - 1, content) -- shunt/writelite.yue:628
      if (err ~= nil) then -- shunt/writelite.yue:629
        return nil, err -- shunt/writelite.yue:630
      end -- shunt/writelite.yue:629
      local _list_0 = T('[writelite.Page]', de:parse()) -- shunt/writelite.yue:632
      for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:632
        local page = _list_0[_index_0] -- shunt/writelite.yue:632
        _with_0:add(page) -- shunt/writelite.yue:633
      end -- shunt/writelite.yue:633
      journal = _with_0 -- shunt/writelite.yue:625
    end -- shunt/writelite.yue:625
    return journal, nil -- shunt/writelite.yue:634
  end) -- shunt/writelite.yue:624
  Journal = _class_0 -- shunt/writelite.yue:619
end -- shunt/writelite.yue:680
NIL_TAG = 0 -- shunt/writelite.yue:682
NIL_TAG_CHAR = string.char(NIL_TAG) -- shunt/writelite.yue:683
TRUE_TAG = 1 -- shunt/writelite.yue:684
TRUE_TAG_CHAR = string.char(TRUE_TAG) -- shunt/writelite.yue:685
FALSE_TAG = 2 -- shunt/writelite.yue:686
FALSE_TAG_CHAR = string.char(FALSE_TAG) -- shunt/writelite.yue:687
INT_TYPE = 3 -- shunt/writelite.yue:688
FLOAT_TYPE = 4 -- shunt/writelite.yue:689
FLOAT_TYPE_CHAR = string.char(FLOAT_TYPE) -- shunt/writelite.yue:690
STRING_TAG = 5 -- shunt/writelite.yue:691
STRING_TAG_CHAR = string.char(STRING_TAG) -- shunt/writelite.yue:692
TABLE_REF_TAG = 6 -- shunt/writelite.yue:693
TABLE_REF_TAG_CHAR = string.char(TABLE_REF_TAG) -- shunt/writelite.yue:694
TABLE_PAYLOAD_TAG = 7 -- shunt/writelite.yue:695
BLANK_TAG = 8 -- shunt/writelite.yue:696
BLANK_TAG_CHAR = string.char(BLANK_TAG) -- shunt/writelite.yue:697
TAG_MASK = 0xf -- shunt/writelite.yue:698
INT_LEN_SHIFT = 4 -- shunt/writelite.yue:700
INT_LEN_MASK = 0xf -- shunt/writelite.yue:701
do -- shunt/writelite.yue:703
  local _class_0 -- shunt/writelite.yue:703
  local _base_0 = { -- shunt/writelite.yue:703
    write = F('(any) => Self', function(self, to_write) -- shunt/writelite.yue:715
      self:write_impl(to_write, self.root_fragments) -- shunt/writelite.yue:716
      return self -- shunt/writelite.yue:717
    end), -- shunt/writelite.yue:719
    write_impl = F('(any, table) => <>', function(self, to_write, fragments) -- shunt/writelite.yue:719
      local _exp_0 = type(to_write) -- shunt/writelite.yue:720
      if 'nil' == _exp_0 then -- shunt/writelite.yue:721
        fragments[#fragments + 1] = NIL_TAG_CHAR -- shunt/writelite.yue:722
      elseif 'boolean' == _exp_0 then -- shunt/writelite.yue:723
        if to_write then -- shunt/writelite.yue:724
          fragments[#fragments + 1] = TRUE_TAG_CHAR -- shunt/writelite.yue:725
        else -- shunt/writelite.yue:727
          fragments[#fragments + 1] = FALSE_TAG_CHAR -- shunt/writelite.yue:727
        end -- shunt/writelite.yue:724
      elseif 'number' == _exp_0 then -- shunt/writelite.yue:728
        if is_float(to_write) then -- shunt/writelite.yue:729
          fragments[#fragments + 1] = FLOAT_TYPE_CHAR -- shunt/writelite.yue:730
          self:write_impl((tostring(to_write)), fragments) -- shunt/writelite.yue:732
          return -- shunt/writelite.yue:733
        end -- shunt/writelite.yue:729
        fragments[#fragments + 1] = 0 -- shunt/writelite.yue:735
        local tag_index = #fragments -- shunt/writelite.yue:736
        while to_write ~= 0 do -- shunt/writelite.yue:737
          fragments[#fragments + 1] = string.char(bit.band(to_write, 0xff)) -- shunt/writelite.yue:738
          to_write = bit.brshift(to_write, 8) -- shunt/writelite.yue:739
        end -- shunt/writelite.yue:739
        local len = #fragments - tag_index -- shunt/writelite.yue:741
        if len > INT_LEN_MASK then -- shunt/writelite.yue:742
          error("internal error: len too large " .. tostring(len) .. " > " .. tostring(INT_LEN_MASK)) -- shunt/writelite.yue:743
        end -- shunt/writelite.yue:742
        fragments[tag_index] = string.char(bit.bor(INT_TYPE, bit.blshift(len, INT_LEN_SHIFT))) -- shunt/writelite.yue:744
      elseif 'string' == _exp_0 then -- shunt/writelite.yue:746
        fragments[#fragments + 1] = STRING_TAG_CHAR -- shunt/writelite.yue:747
        self:write_impl(#to_write, fragments) -- shunt/writelite.yue:748
        fragments[#fragments + 1] = to_write -- shunt/writelite.yue:749
      elseif 'table' == _exp_0 then -- shunt/writelite.yue:750
        fragments[#fragments + 1] = TABLE_REF_TAG_CHAR -- shunt/writelite.yue:751
        do -- shunt/writelite.yue:754
          local ref = self.refs[to_write] -- shunt/writelite.yue:754
          if ref then -- shunt/writelite.yue:754
            self:write_impl(ref, fragments) -- shunt/writelite.yue:755
            return -- shunt/writelite.yue:756
          end -- shunt/writelite.yue:754
        end -- shunt/writelite.yue:754
        local ref = self.next_ref -- shunt/writelite.yue:758
        self:write_impl(ref, fragments) -- shunt/writelite.yue:759
        self.refs[to_write] = ref -- shunt/writelite.yue:760
        self.next_ref = self.next_ref + 1 -- shunt/writelite.yue:761
        local content_fragments = { } -- shunt/writelite.yue:763
        local num_pairs = 0 -- shunt/writelite.yue:764
        for k, v in pairs(to_write) do -- shunt/writelite.yue:765
          num_pairs = num_pairs + 1 -- shunt/writelite.yue:766
          self:write_impl(k, content_fragments) -- shunt/writelite.yue:767
          self:write_impl(v, content_fragments) -- shunt/writelite.yue:768
        end -- shunt/writelite.yue:768
        do -- shunt/writelite.yue:769
          local _obj_0 = self.tables -- shunt/writelite.yue:769
          _obj_0[#_obj_0 + 1] = { -- shunt/writelite.yue:770
            num_pairs = num_pairs, -- shunt/writelite.yue:770
            content_fragments = content_fragments -- shunt/writelite.yue:771
          } -- shunt/writelite.yue:769
        end -- shunt/writelite.yue:771
      else -- shunt/writelite.yue:773
        return error("cannot encode " .. tostring(type(to_write))) -- shunt/writelite.yue:773
      end -- shunt/writelite.yue:773
    end), -- shunt/writelite.yue:775
    finish = F('() => string', function(self) -- shunt/writelite.yue:775
      local fragments = { } -- shunt/writelite.yue:776
      fragments[#fragments + 1] = '\0' -- shunt/writelite.yue:779
      for i = 1, 4 do -- shunt/writelite.yue:780
        fragments[#fragments + 1] = BLANK_TAG_CHAR -- shunt/writelite.yue:781
      end -- shunt/writelite.yue:781
      self:write_impl(#self.tables, fragments) -- shunt/writelite.yue:783
      local _list_0 = self.tables -- shunt/writelite.yue:784
      for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:784
        local table = _list_0[_index_0] -- shunt/writelite.yue:784
        local num_pairs, content_fragments = table.num_pairs, table.content_fragments -- shunt/writelite.yue:785
        self:write_impl(num_pairs, fragments) -- shunt/writelite.yue:786
        for _index_1 = 1, #content_fragments do -- shunt/writelite.yue:787
          local fragment = content_fragments[_index_1] -- shunt/writelite.yue:787
          fragments[#fragments + 1] = fragment -- shunt/writelite.yue:788
        end -- shunt/writelite.yue:788
      end -- shunt/writelite.yue:788
      local _list_1 = self.root_fragments -- shunt/writelite.yue:790
      for _index_0 = 1, #_list_1 do -- shunt/writelite.yue:790
        local fragment = _list_1[_index_0] -- shunt/writelite.yue:790
        fragments[#fragments + 1] = fragment -- shunt/writelite.yue:791
      end -- shunt/writelite.yue:791
      local len = 0 -- shunt/writelite.yue:793
      for _index_0 = 1, #fragments do -- shunt/writelite.yue:794
        local fragment = fragments[_index_0] -- shunt/writelite.yue:794
        len = len + (#fragment) -- shunt/writelite.yue:795
      end -- shunt/writelite.yue:795
      local len_fragments = { } -- shunt/writelite.yue:796
      self:write_impl(len, len_fragments) -- shunt/writelite.yue:797
      if #len_fragments > 5 then -- shunt/writelite.yue:798
        error("internal error: len fragments too large " .. tostring(#len_fragments) .. " > 5") -- shunt/writelite.yue:799
      end -- shunt/writelite.yue:798
      for i = 1, #len_fragments do -- shunt/writelite.yue:800
        fragments[i] = len_fragments[i] -- shunt/writelite.yue:801
      end -- shunt/writelite.yue:801
      local ret = table.concat(T('[string]', fragments)) -- shunt/writelite.yue:803
      if len ~= #ret then -- shunt/writelite.yue:804
        error("written len != actual len (" .. tostring(len) .. " != " .. tostring(#ret) .. ")") -- shunt/writelite.yue:805
      end -- shunt/writelite.yue:804
      return ret -- shunt/writelite.yue:806
    end) -- shunt/writelite.yue:703
  } -- shunt/writelite.yue:703
  if _base_0.__index == nil then -- shunt/writelite.yue:703
    _base_0.__index = _base_0 -- shunt/writelite.yue:703
  end -- shunt/writelite.yue:806
  _class_0 = setmetatable({ -- shunt/writelite.yue:703
    __init = F('() => <>', function(self) -- shunt/writelite.yue:704
      self.root_fragments = T('[string]', { }) -- shunt/writelite.yue:705
      self.next_ref = T('number', 0) -- shunt/writelite.yue:706
      self.tables = T('[{num_pairs: number, content_fragments: [string]}]', { }) -- shunt/writelite.yue:707
      self.refs = T('{table->number}', { }) -- shunt/writelite.yue:708
    end), -- shunt/writelite.yue:703
    __base = _base_0, -- shunt/writelite.yue:703
    __name = "Serialiser" -- shunt/writelite.yue:703
  }, { -- shunt/writelite.yue:703
    __index = _base_0, -- shunt/writelite.yue:703
    __call = function(cls, ...) -- shunt/writelite.yue:703
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:703
      cls.__init(_self_0, ...) -- shunt/writelite.yue:703
      return _self_0 -- shunt/writelite.yue:703
    end -- shunt/writelite.yue:703
  }) -- shunt/writelite.yue:703
  _base_0.__class = _class_0 -- shunt/writelite.yue:703
  local self = _class_0; -- shunt/writelite.yue:703
  self.serialise = F('(any) => string', function(self, to_serialise) -- shunt/writelite.yue:710
    return Serialiser():write(to_serialise):finish() -- shunt/writelite.yue:713
  end) -- shunt/writelite.yue:710
  Serialiser = _class_0 -- shunt/writelite.yue:703
end -- shunt/writelite.yue:806
if 'native' == HOST then -- shunt/writelite.yue:809
  MAX_INT = 0x7fffffff -- shunt/writelite.yue:810
elseif 'minecraft' == HOST then -- shunt/writelite.yue:812
  MAX_INT = 0xffffffff -- shunt/writelite.yue:813
else -- shunt/writelite.yue:815
  MAX_INT = error("unknown host " .. tostring(HOST)) -- shunt/writelite.yue:815
end -- shunt/writelite.yue:815
MIN_INT = -MAX_INT - 1 -- shunt/writelite.yue:816
is_float = F('(number) -> boolean', function(num) -- shunt/writelite.yue:818
  if num > MAX_INT then -- shunt/writelite.yue:819
    return true -- shunt/writelite.yue:820
  end -- shunt/writelite.yue:819
  if num < MIN_INT then -- shunt/writelite.yue:821
    return true -- shunt/writelite.yue:822
  end -- shunt/writelite.yue:821
  local _, frac = math.modf(num) -- shunt/writelite.yue:824
  if frac ~= 0 then -- shunt/writelite.yue:825
    return true -- shunt/writelite.yue:826
  end -- shunt/writelite.yue:825
  return false -- shunt/writelite.yue:828
end) -- shunt/writelite.yue:818
declare_type('writelite.DeserialiserSource', 'string|writelite.File') -- shunt/writelite.yue:830
do -- shunt/writelite.yue:831
  local _class_0 -- shunt/writelite.yue:831
  local _base_0 = { -- shunt/writelite.yue:831
    parse = F('() => <any, boolean>', function(self) -- shunt/writelite.yue:845
      if self.raw == nil then -- shunt/writelite.yue:846
        self.raw = self:prepare_raw() -- shunt/writelite.yue:846
      end -- shunt/writelite.yue:846
      if self.index > #self.raw then -- shunt/writelite.yue:847
        return nil, true -- shunt/writelite.yue:848
      end -- shunt/writelite.yue:847
      local total_len = self:parse_value() -- shunt/writelite.yue:850
      if 'number' ~= type(total_len) then -- shunt/writelite.yue:851
        error('internal error: len field is not a number') -- shunt/writelite.yue:852
      end -- shunt/writelite.yue:851
      local num_tables = self:parse_value() -- shunt/writelite.yue:854
      if 'number' ~= type(num_tables) then -- shunt/writelite.yue:855
        error('internal error: num_tables field is not a number') -- shunt/writelite.yue:856
      end -- shunt/writelite.yue:855
      for ref = num_tables - 1, 0, -1 do -- shunt/writelite.yue:857
        self:parse_table_def(ref) -- shunt/writelite.yue:858
      end -- shunt/writelite.yue:858
      local ret = self:parse_value() -- shunt/writelite.yue:860
      local _list_0 = self.unresolved_table_refs -- shunt/writelite.yue:861
      for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:861
        local _des_0 = _list_0[_index_0] -- shunt/writelite.yue:861
        local table, key, ref = _des_0.table, _des_0.key, _des_0.ref -- shunt/writelite.yue:861
        local value = self.tables_by_ref[ref] -- shunt/writelite.yue:862
        if not (value ~= nil) then -- shunt/writelite.yue:863
          error("internal error: unresolved reference " .. tostring(ref)) -- shunt/writelite.yue:864
        end -- shunt/writelite.yue:863
        table[key] = value -- shunt/writelite.yue:865
      end -- shunt/writelite.yue:865
      return ret, self.index > #self.raw -- shunt/writelite.yue:866
    end), -- shunt/writelite.yue:868
    parse_table_def = F('(number) => {}', function(self, ref) -- shunt/writelite.yue:868
      local num_pairs = self:parse_value() -- shunt/writelite.yue:869
      if 'number' ~= type(num_pairs) then -- shunt/writelite.yue:870
        error('internal error: num_pairs field is not a number') -- shunt/writelite.yue:871
      end -- shunt/writelite.yue:870
      local table = { } -- shunt/writelite.yue:873
      self.tables_by_ref[ref] = table -- shunt/writelite.yue:874
      for _ = 1, num_pairs do -- shunt/writelite.yue:876
        local key = self:parse_value() -- shunt/writelite.yue:877
        if TABLE_REF_TAG == self.raw:byte(self.index) then -- shunt/writelite.yue:879
          self.index = self.index + 1 -- shunt/writelite.yue:880
          ref = self:parse_value() -- shunt/writelite.yue:881
          do -- shunt/writelite.yue:882
            local _obj_0 = self.unresolved_table_refs -- shunt/writelite.yue:882
            _obj_0[#_obj_0 + 1] = { -- shunt/writelite.yue:883
              table = table, -- shunt/writelite.yue:883
              key = key, -- shunt/writelite.yue:884
              ref = ref -- shunt/writelite.yue:885
            } -- shunt/writelite.yue:882
          end -- shunt/writelite.yue:885
        else -- shunt/writelite.yue:887
          table[key] = self:parse_value() -- shunt/writelite.yue:887
        end -- shunt/writelite.yue:879
      end -- shunt/writelite.yue:887
      return table -- shunt/writelite.yue:875
    end), -- shunt/writelite.yue:889
    parse_value = F('() => any', function(self) -- shunt/writelite.yue:889
      if self.raw == nil then -- shunt/writelite.yue:890
        self.raw = self:prepare_raw() -- shunt/writelite.yue:890
      end -- shunt/writelite.yue:890
      local head -- shunt/writelite.yue:892
      while true do -- shunt/writelite.yue:893
        head = self.raw:byte(self.index) -- shunt/writelite.yue:894
        if not (head ~= nil) then -- shunt/writelite.yue:895
          error("internal error: unexpected EOF at index " .. tostring(self.index)) -- shunt/writelite.yue:896
        end -- shunt/writelite.yue:895
        if head ~= BLANK_TAG then -- shunt/writelite.yue:897
          break -- shunt/writelite.yue:898
        end -- shunt/writelite.yue:897
        self.index = self.index + 1 -- shunt/writelite.yue:899
      end -- shunt/writelite.yue:899
      self.index = self.index + 1 -- shunt/writelite.yue:900
      do -- shunt/writelite.yue:901
        local _exp_0 = bit.band(head, TAG_MASK) -- shunt/writelite.yue:901
        if NIL_TAG == _exp_0 then -- shunt/writelite.yue:902
          return nil -- shunt/writelite.yue:903
        elseif TRUE_TAG == _exp_0 then -- shunt/writelite.yue:904
          return true -- shunt/writelite.yue:905
        elseif FALSE_TAG == _exp_0 then -- shunt/writelite.yue:906
          return false -- shunt/writelite.yue:907
        elseif INT_TYPE == _exp_0 then -- shunt/writelite.yue:908
          local len = bit.band(INT_LEN_MASK, bit.brshift(head, INT_LEN_SHIFT)) -- shunt/writelite.yue:909
          local ret = 0 -- shunt/writelite.yue:913
          for i = 0, len - 1 do -- shunt/writelite.yue:914
            ret = bit.bor(ret, bit.blshift((self.raw:byte(self.index)), i * 8)) -- shunt/writelite.yue:915
            self.index = self.index + 1 -- shunt/writelite.yue:918
          end -- shunt/writelite.yue:918
          return ret -- shunt/writelite.yue:919
        elseif FLOAT_TYPE == _exp_0 then -- shunt/writelite.yue:920
          local raw = self:parse_value() -- shunt/writelite.yue:921
          if 'string' ~= type(raw) then -- shunt/writelite.yue:922
            error("internal error: cannot parse a " .. tostring(type(raw)) .. " into float[]") -- shunt/writelite.yue:923
          end -- shunt/writelite.yue:922
          return tonumber(raw) -- shunt/writelite.yue:924
        elseif STRING_TAG == _exp_0 then -- shunt/writelite.yue:925
          local len = self:parse_value() -- shunt/writelite.yue:926
          if 'number' ~= type(len) then -- shunt/writelite.yue:927
            error("internal error: cannot use a " .. tostring(type(len)) .. " as a string length") -- shunt/writelite.yue:928
          end -- shunt/writelite.yue:927
          local ret = self.raw:sub(self.index, self.index + len - 1) -- shunt/writelite.yue:929
          self.index = self.index + len -- shunt/writelite.yue:930
          return ret -- shunt/writelite.yue:931
        elseif TABLE_REF_TAG == _exp_0 then -- shunt/writelite.yue:932
          local index = self.index -- shunt/writelite.yue:933
          local ref = self:parse_value() -- shunt/writelite.yue:934
          if 'number' ~= type(ref) then -- shunt/writelite.yue:935
            error('internal error: ref is not a number') -- shunt/writelite.yue:936
          end -- shunt/writelite.yue:935
          local table = self.tables_by_ref[ref] -- shunt/writelite.yue:937
          if not (table ~= nil) then -- shunt/writelite.yue:938
            error("internal error: ref " .. tostring(ref) .. " invalid at " .. tostring(index)) -- shunt/writelite.yue:939
          end -- shunt/writelite.yue:938
          return table -- shunt/writelite.yue:940
        else -- shunt/writelite.yue:942
          print_serialised(self.raw) -- shunt/writelite.yue:942
          error(("unrecognised tag %02x at index %d"):format((bit.band(head, TAG_MASK)), self.index - 1)) -- shunt/writelite.yue:943
        end -- shunt/writelite.yue:944
      end -- shunt/writelite.yue:944
      return error('unreachable') -- shunt/writelite.yue:945
    end), -- shunt/writelite.yue:947
    prepare_raw = F('() => string', function(self) -- shunt/writelite.yue:947
      local _exp_0 = type(self.source) -- shunt/writelite.yue:948
      if 'string' == _exp_0 then -- shunt/writelite.yue:949
        return self.source -- shunt/writelite.yue:950
      else -- shunt/writelite.yue:952
        local raw_len_bytes, err = self.source:read(5) -- shunt/writelite.yue:952
        if (err ~= nil) then -- shunt/writelite.yue:953
          error("cannot read length from parse source: " .. tostring(err)) -- shunt/writelite.yue:954
        end -- shunt/writelite.yue:953
        local len = Deserialiser:deserialise_raw(raw_len_bytes) -- shunt/writelite.yue:955
        if 'number' ~= type(len) then -- shunt/writelite.yue:956
          error("cannot use " .. tostring(type(len)) .. " as length") -- shunt/writelite.yue:957
        end -- shunt/writelite.yue:956
        local _ -- shunt/writelite.yue:958
        _, err = self.source:seek('set', 0) -- shunt/writelite.yue:958
        if (err ~= nil) then -- shunt/writelite.yue:959
          error("cannot seek parse source: " .. tostring(err)) -- shunt/writelite.yue:960
        end -- shunt/writelite.yue:959
        local raw -- shunt/writelite.yue:961
        raw, err = self.source:read(len) -- shunt/writelite.yue:961
        if (err ~= nil) then -- shunt/writelite.yue:962
          error("cannot read parse source: " .. tostring(err)) -- shunt/writelite.yue:963
        end -- shunt/writelite.yue:962
        return raw -- shunt/writelite.yue:964
      end -- shunt/writelite.yue:964
    end) -- shunt/writelite.yue:831
  } -- shunt/writelite.yue:831
  if _base_0.__index == nil then -- shunt/writelite.yue:831
    _base_0.__index = _base_0 -- shunt/writelite.yue:831
  end -- shunt/writelite.yue:964
  _class_0 = setmetatable({ -- shunt/writelite.yue:831
    __init = F('(writelite.DeserialiserSource, ?number) => <>', function(self, source, index) -- shunt/writelite.yue:832
      if index == nil then -- shunt/writelite.yue:832
        index = 1 -- shunt/writelite.yue:832
      end -- shunt/writelite.yue:832
      self.source = source -- shunt/writelite.yue:832
      self.index = index -- shunt/writelite.yue:832
      self.tables_by_ref = T('{number->table}', { }) -- shunt/writelite.yue:833
      self.unresolved_table_refs = T('[{table: table, key: some, ref: number}]', { }) -- shunt/writelite.yue:834
    end), -- shunt/writelite.yue:831
    __base = _base_0, -- shunt/writelite.yue:831
    __name = "Deserialiser" -- shunt/writelite.yue:831
  }, { -- shunt/writelite.yue:831
    __index = _base_0, -- shunt/writelite.yue:831
    __call = function(cls, ...) -- shunt/writelite.yue:831
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:831
      cls.__init(_self_0, ...) -- shunt/writelite.yue:831
      return _self_0 -- shunt/writelite.yue:831
    end -- shunt/writelite.yue:831
  }) -- shunt/writelite.yue:831
  _base_0.__class = _class_0 -- shunt/writelite.yue:831
  local self = _class_0; -- shunt/writelite.yue:831
  self.deserialise = F('(writelite.DeserialiserSource, ?number) => any', function(self, source, index) -- shunt/writelite.yue:836
    local v, _ = (Deserialiser(source, index)):parse() -- shunt/writelite.yue:837
    return v -- shunt/writelite.yue:839
  end) -- shunt/writelite.yue:836
  self.deserialise_raw = F('(string, ?number) => any', function(self, source, index) -- shunt/writelite.yue:841
    return (Deserialiser(source, index)):parse_value() -- shunt/writelite.yue:843
  end) -- shunt/writelite.yue:841
  Deserialiser = _class_0 -- shunt/writelite.yue:831
end -- shunt/writelite.yue:964
declare_type('writelite.PageOpts', [[{
  offset: number,
  content: string,
}]]) -- shunt/writelite.yue:966
declare_type('writelite.Page', [[{
  offset: number,
  content: string,
  checksum: number,
}]]) -- shunt/writelite.yue:970
do -- shunt/writelite.yue:975
  local _class_0 -- shunt/writelite.yue:975
  local _base_0 = { } -- shunt/writelite.yue:975
  if _base_0.__index == nil then -- shunt/writelite.yue:975
    _base_0.__index = _base_0 -- shunt/writelite.yue:975
  end -- shunt/writelite.yue:983
  _class_0 = setmetatable({ -- shunt/writelite.yue:975
    __init = F('(writelite.PageOpts) => <>', function(self, opts) -- shunt/writelite.yue:976
      local offset, content = opts.offset, opts.content -- shunt/writelite.yue:977
      self.offset = offset -- shunt/writelite.yue:981
      self.content = content -- shunt/writelite.yue:982
      self.checksum = Hasher:hash(content) -- shunt/writelite.yue:983
    end), -- shunt/writelite.yue:975
    __base = _base_0, -- shunt/writelite.yue:975
    __name = "Page" -- shunt/writelite.yue:975
  }, { -- shunt/writelite.yue:975
    __index = _base_0, -- shunt/writelite.yue:975
    __call = function(cls, ...) -- shunt/writelite.yue:975
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:975
      cls.__init(_self_0, ...) -- shunt/writelite.yue:975
      return _self_0 -- shunt/writelite.yue:975
    end -- shunt/writelite.yue:975
  }) -- shunt/writelite.yue:975
  _base_0.__class = _class_0 -- shunt/writelite.yue:975
  Page = _class_0 -- shunt/writelite.yue:975
end -- shunt/writelite.yue:983
MAX_HASH = 99999999 -- shunt/writelite.yue:985
assert(MAX_INT >= MAX_HASH) -- shunt/writelite.yue:986
declare_type('writelite.Hasher', [[{
  hash: (any) => number,
  write: (string) => <>,
  finish: () => number,
}]]) -- shunt/writelite.yue:988
do -- shunt/writelite.yue:993
  local _class_0 -- shunt/writelite.yue:993
  local _base_0 = { -- shunt/writelite.yue:993
    write = F('(any) => Self', function(self, to_write) -- shunt/writelite.yue:1002
      do -- shunt/writelite.yue:1003
        local _exp_0 = type(to_write) -- shunt/writelite.yue:1003
        if 'boolean' == _exp_0 then -- shunt/writelite.yue:1004
          if to_write then -- shunt/writelite.yue:1005
            self:_add(997 * 127) -- shunt/writelite.yue:1006
          else -- shunt/writelite.yue:1008
            self:_add(997 * 13) -- shunt/writelite.yue:1008
          end -- shunt/writelite.yue:1005
        elseif 'number' == _exp_0 then -- shunt/writelite.yue:1009
          self:_add(997 * (8302197 + to_write)) -- shunt/writelite.yue:1010
        elseif 'string' == _exp_0 then -- shunt/writelite.yue:1011
          self:write(1 + #to_write) -- shunt/writelite.yue:1012
          local CHUNK_SIZE = 100 -- shunt/writelite.yue:1014
          for i = 1, to_write:len(), CHUNK_SIZE do -- shunt/writelite.yue:1015
            local start_idx = 1 + (i - 1) * CHUNK_SIZE -- shunt/writelite.yue:1016
            local end_idx = i * CHUNK_SIZE -- shunt/writelite.yue:1017
            local _list_0 = { -- shunt/writelite.yue:1018
              to_write:byte(start_idx, end_idx) -- shunt/writelite.yue:1018
            } -- shunt/writelite.yue:1018
            for _index_0 = 1, #_list_0 do -- shunt/writelite.yue:1018
              local byte = _list_0[_index_0] -- shunt/writelite.yue:1018
              self:_add(997 * byte) -- shunt/writelite.yue:1019
            end -- shunt/writelite.yue:1019
          end -- shunt/writelite.yue:1019
        elseif 'table' == _exp_0 then -- shunt/writelite.yue:1020
          local entries -- shunt/writelite.yue:1021
          do -- shunt/writelite.yue:1021
            local _with_0 = { } -- shunt/writelite.yue:1021
            for key, value in pairs(to_write) do -- shunt/writelite.yue:1022
              _with_0[#_with_0 + 1] = { -- shunt/writelite.yue:1023
                key = key, -- shunt/writelite.yue:1023
                value = value -- shunt/writelite.yue:1023
              } -- shunt/writelite.yue:1023
            end -- shunt/writelite.yue:1023
            entries = _with_0 -- shunt/writelite.yue:1021
          end -- shunt/writelite.yue:1021
          self:_add(1 + #entries) -- shunt/writelite.yue:1024
          table.sort(entries, function(a, b) -- shunt/writelite.yue:1025
            return a.key < b.key -- shunt/writelite.yue:1025
          end) -- shunt/writelite.yue:1025
          for _index_0 = 1, #entries do -- shunt/writelite.yue:1026
            local _des_0 = entries[_index_0] -- shunt/writelite.yue:1026
            local key, value = _des_0.key, _des_0.value -- shunt/writelite.yue:1026
            self:write(key) -- shunt/writelite.yue:1027
            self:write(value) -- shunt/writelite.yue:1028
          end -- shunt/writelite.yue:1028
        else -- shunt/writelite.yue:1030
          error("cannot hash a " .. tostring(type(to_write))) -- shunt/writelite.yue:1030
        end -- shunt/writelite.yue:1030
      end -- shunt/writelite.yue:1030
      return self -- shunt/writelite.yue:1031
    end), -- shunt/writelite.yue:1033
    _add = F('(number) => <>', function(self, num) -- shunt/writelite.yue:1033
      self._current = self._current * num -- shunt/writelite.yue:1034
      self._current = self._current % MAX_HASH -- shunt/writelite.yue:1035
    end), -- shunt/writelite.yue:1037
    finish = F('() => number', function(self) -- shunt/writelite.yue:1037
      return self._current -- shunt/writelite.yue:1038
    end) -- shunt/writelite.yue:993
  } -- shunt/writelite.yue:993
  if _base_0.__index == nil then -- shunt/writelite.yue:993
    _base_0.__index = _base_0 -- shunt/writelite.yue:993
  end -- shunt/writelite.yue:1038
  _class_0 = setmetatable({ -- shunt/writelite.yue:993
    __init = F('() => <>', function(self) -- shunt/writelite.yue:994
      self._current = 7 -- shunt/writelite.yue:995
    end), -- shunt/writelite.yue:993
    __base = _base_0, -- shunt/writelite.yue:993
    __name = "Hasher" -- shunt/writelite.yue:993
  }, { -- shunt/writelite.yue:993
    __index = _base_0, -- shunt/writelite.yue:993
    __call = function(cls, ...) -- shunt/writelite.yue:993
      local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:993
      cls.__init(_self_0, ...) -- shunt/writelite.yue:993
      return _self_0 -- shunt/writelite.yue:993
    end -- shunt/writelite.yue:993
  }) -- shunt/writelite.yue:993
  _base_0.__class = _class_0 -- shunt/writelite.yue:993
  local self = _class_0; -- shunt/writelite.yue:993
  self.hash = F('(any) => number', function(self, to_hash) -- shunt/writelite.yue:997
    return Hasher():write(to_hash):finish() -- shunt/writelite.yue:1000
  end) -- shunt/writelite.yue:997
  Hasher = _class_0 -- shunt/writelite.yue:993
end -- shunt/writelite.yue:1038
print_serialised = F('(string) -> <>', function(serialised) -- shunt/writelite.yue:1040
  local indices -- shunt/writelite.yue:1041
  do -- shunt/writelite.yue:1041
    local _accum_0 = { } -- shunt/writelite.yue:1041
    local _len_0 = 1 -- shunt/writelite.yue:1041
    for i = 1, #serialised do -- shunt/writelite.yue:1041
      _accum_0[_len_0] = ('%02d'):format(i) -- shunt/writelite.yue:1041
      _len_0 = _len_0 + 1 -- shunt/writelite.yue:1041
    end -- shunt/writelite.yue:1041
    indices = _accum_0 -- shunt/writelite.yue:1041
  end -- shunt/writelite.yue:1041
  local bytes -- shunt/writelite.yue:1042
  do -- shunt/writelite.yue:1042
    local _with_0 = { } -- shunt/writelite.yue:1042
    for i = 1, #serialised do -- shunt/writelite.yue:1043
      _with_0[#_with_0 + 1] = ('%02x'):format(serialised:byte(i)) -- shunt/writelite.yue:1044
    end -- shunt/writelite.yue:1044
    bytes = _with_0 -- shunt/writelite.yue:1042
  end -- shunt/writelite.yue:1042
  local is_printable -- shunt/writelite.yue:1045
  is_printable = function(c) -- shunt/writelite.yue:1045
    return 'a' <= c and c <= 'z' or 'A' <= c and c <= 'Z' or '0' <= c and c <= '9' or c == '-' or c == '+' or c == '_' -- shunt/writelite.yue:1051
  end -- shunt/writelite.yue:1045
  local chars -- shunt/writelite.yue:1052
  do -- shunt/writelite.yue:1052
    local _with_0 = { } -- shunt/writelite.yue:1052
    for i = 1, #serialised do -- shunt/writelite.yue:1053
      local byte = serialised:byte(i) -- shunt/writelite.yue:1054
      if is_printable(string.char(byte)) then -- shunt/writelite.yue:1055
        _with_0[#_with_0 + 1] = ('% 2s'):format(serialised:sub(i, i)) -- shunt/writelite.yue:1056
      else -- shunt/writelite.yue:1058
        _with_0[#_with_0 + 1] = ('%02x'):format(byte) -- shunt/writelite.yue:1058
      end -- shunt/writelite.yue:1055
    end -- shunt/writelite.yue:1058
    chars = _with_0 -- shunt/writelite.yue:1052
  end -- shunt/writelite.yue:1052
  assert(#indices == #bytes) -- shunt/writelite.yue:1059
  assert(#indices == #chars) -- shunt/writelite.yue:1060
  local PER_LINE = 25 -- shunt/writelite.yue:1061
  local first = true -- shunt/writelite.yue:1062
  for i = 1, #indices, PER_LINE do -- shunt/writelite.yue:1063
    if first then -- shunt/writelite.yue:1064
      first = false -- shunt/writelite.yue:1065
    else -- shunt/writelite.yue:1067
      print() -- shunt/writelite.yue:1067
    end -- shunt/writelite.yue:1064
    print(table.concat((function() -- shunt/writelite.yue:1068
      local _accum_0 = { } -- shunt/writelite.yue:1068
      local _len_0 = 1 -- shunt/writelite.yue:1068
      local _max_0 = i + PER_LINE - 1 -- shunt/writelite.yue:1068
      for _index_0 = i, _max_0 < 0 and #indices + _max_0 or _max_0 do -- shunt/writelite.yue:1068
        local i = indices[_index_0] -- shunt/writelite.yue:1068
        _accum_0[_len_0] = i -- shunt/writelite.yue:1068
        _len_0 = _len_0 + 1 -- shunt/writelite.yue:1068
      end -- shunt/writelite.yue:1068
      return _accum_0 -- shunt/writelite.yue:1068
    end)(), ' ')) -- shunt/writelite.yue:1068
    print(('-'):rep(3 * (PER_LINE + 1) - 1)) -- shunt/writelite.yue:1069
    print(table.concat((function() -- shunt/writelite.yue:1070
      local _accum_0 = { } -- shunt/writelite.yue:1070
      local _len_0 = 1 -- shunt/writelite.yue:1070
      local _max_0 = i + PER_LINE - 1 -- shunt/writelite.yue:1070
      for _index_0 = i, _max_0 < 0 and #bytes + _max_0 or _max_0 do -- shunt/writelite.yue:1070
        local i = bytes[_index_0] -- shunt/writelite.yue:1070
        _accum_0[_len_0] = i -- shunt/writelite.yue:1070
        _len_0 = _len_0 + 1 -- shunt/writelite.yue:1070
      end -- shunt/writelite.yue:1070
      return _accum_0 -- shunt/writelite.yue:1070
    end)(), ' ')) -- shunt/writelite.yue:1070
    print(table.concat((function() -- shunt/writelite.yue:1071
      local _accum_0 = { } -- shunt/writelite.yue:1071
      local _len_0 = 1 -- shunt/writelite.yue:1071
      local _max_0 = i + PER_LINE - 1 -- shunt/writelite.yue:1071
      for _index_0 = i, _max_0 < 0 and #chars + _max_0 or _max_0 do -- shunt/writelite.yue:1071
        local i = chars[_index_0] -- shunt/writelite.yue:1071
        _accum_0[_len_0] = i -- shunt/writelite.yue:1071
        _len_0 = _len_0 + 1 -- shunt/writelite.yue:1071
      end -- shunt/writelite.yue:1071
      return _accum_0 -- shunt/writelite.yue:1071
    end)(), ' ')) -- shunt/writelite.yue:1071
  end -- shunt/writelite.yue:1071
end) -- shunt/writelite.yue:1040
spec(function() -- shunt/writelite.yue:1073
  local TestFs, TestFile -- shunt/writelite.yue:1074
  local clone, describe, it, matchers -- shunt/writelite.yue:0
  do -- shunt/writelite.yue:0
    local _obj_0 = require('shunt.spec') -- shunt/writelite.yue:0
    clone, describe, it, matchers = _obj_0.clone, _obj_0.describe, _obj_0.it, _obj_0.matchers -- shunt/writelite.yue:0
  end -- shunt/writelite.yue:0
  local deep_eq, each_value, eq, errors, has_fields, len, lt, matches, near, no_errors, not_ = matchers.deep_eq, matchers.each_value, matchers.eq, matchers.errors, matchers.has_fields, matchers.len, matchers.lt, matchers.matches, matchers.near, matchers.no_errors, matchers.not_ -- shunt/writelite.yue:1080
  declare_type('writelite.FileSpec', [[{
    content: string,
  }]]) -- shunt/writelite.yue:1082
  do -- shunt/writelite.yue:1085
    local _class_0 -- shunt/writelite.yue:1085
    local _base_0 = { -- shunt/writelite.yue:1085
      open = F('(string, writelite.FileMode) => <?writelite.File, ?string, ?number>', function(self, path, mode) -- shunt/writelite.yue:1090
        if mode:match('^w') then -- shunt/writelite.yue:1091
          local file = TestFile('') -- shunt/writelite.yue:1092
          file:open() -- shunt/writelite.yue:1093
          self.files[path] = file -- shunt/writelite.yue:1094
          return file, nil, nil -- shunt/writelite.yue:1095
        else -- shunt/writelite.yue:1096
          do -- shunt/writelite.yue:1096
            local file = self.files[path] -- shunt/writelite.yue:1096
            if file then -- shunt/writelite.yue:1096
              file:open() -- shunt/writelite.yue:1097
              return file, nil, nil -- shunt/writelite.yue:1098
            else -- shunt/writelite.yue:1100
              return nil, tostring(path) .. ": No such file or directory", 2 -- shunt/writelite.yue:1100
            end -- shunt/writelite.yue:1096
          end -- shunt/writelite.yue:1096
        end -- shunt/writelite.yue:1091
      end), -- shunt/writelite.yue:1102
      remove = F('(string) => boolean', function(self, path) -- shunt/writelite.yue:1102
        local file = self.files[path] -- shunt/writelite.yue:1103
        if not (file ~= nil) then -- shunt/writelite.yue:1104
          return false -- shunt/writelite.yue:1105
        end -- shunt/writelite.yue:1104
        if not file.closed then -- shunt/writelite.yue:1107
          error('cannot remove open file') -- shunt/writelite.yue:1108
        end -- shunt/writelite.yue:1107
        local _obj_0 = self.removed -- shunt/writelite.yue:1110
        if _obj_0[path] == nil then -- shunt/writelite.yue:1110
          _obj_0[path] = { } -- shunt/writelite.yue:1110
        end -- shunt/writelite.yue:1110
        do -- shunt/writelite.yue:1111
          local _obj_1 = self.removed[path] -- shunt/writelite.yue:1111
          _obj_1[#_obj_1 + 1] = file -- shunt/writelite.yue:1111
        end -- shunt/writelite.yue:1111
        self.files[path] = nil -- shunt/writelite.yue:1112
        return true -- shunt/writelite.yue:1113
      end), -- shunt/writelite.yue:1115
      reinstate = F('(string) => <>', function(self, path) -- shunt/writelite.yue:1115
        local versions = self.removed[path] -- shunt/writelite.yue:1116
        if not (versions ~= nil) then -- shunt/writelite.yue:1117
          error("cannot reinstate " .. tostring(path) .. ": never deleted") -- shunt/writelite.yue:1118
        end -- shunt/writelite.yue:1117
        self.files[path] = versions[#versions] -- shunt/writelite.yue:1119
      end) -- shunt/writelite.yue:1085
    } -- shunt/writelite.yue:1085
    if _base_0.__index == nil then -- shunt/writelite.yue:1085
      _base_0.__index = _base_0 -- shunt/writelite.yue:1085
    end -- shunt/writelite.yue:1119
    _class_0 = setmetatable({ -- shunt/writelite.yue:1085
      __init = F('(?{string->writelite.FileSpec}) => <>', function(self, files) -- shunt/writelite.yue:1086
        if files == nil then -- shunt/writelite.yue:1086
          files = { } -- shunt/writelite.yue:1086
        end -- shunt/writelite.yue:1086
        do -- shunt/writelite.yue:1087
          local _tbl_0 = { } -- shunt/writelite.yue:1087
          for file, _des_0 in pairs(files) do -- shunt/writelite.yue:1087
            local content = _des_0.content -- shunt/writelite.yue:1087
            _tbl_0[file] = TestFile(content) -- shunt/writelite.yue:1087
          end -- shunt/writelite.yue:1087
          self.files = _tbl_0 -- shunt/writelite.yue:1087
        end -- shunt/writelite.yue:1087
        self.removed = T('{string->[writelite.File]}', { }) -- shunt/writelite.yue:1088
      end), -- shunt/writelite.yue:1085
      __base = _base_0, -- shunt/writelite.yue:1085
      __name = "TestFs" -- shunt/writelite.yue:1085
    }, { -- shunt/writelite.yue:1085
      __index = _base_0, -- shunt/writelite.yue:1085
      __call = function(cls, ...) -- shunt/writelite.yue:1085
        local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:1085
        cls.__init(_self_0, ...) -- shunt/writelite.yue:1085
        return _self_0 -- shunt/writelite.yue:1085
      end -- shunt/writelite.yue:1085
    }) -- shunt/writelite.yue:1085
    _base_0.__class = _class_0 -- shunt/writelite.yue:1085
    TestFs = _class_0 -- shunt/writelite.yue:1085
  end -- shunt/writelite.yue:1119
  do -- shunt/writelite.yue:1121
    local _class_0 -- shunt/writelite.yue:1121
    local _base_0 = { -- shunt/writelite.yue:1121
      content = F('() => string', function(self) -- shunt/writelite.yue:1129
        return table.concat((function() -- shunt/writelite.yue:1130
          local _with_0 = { } -- shunt/writelite.yue:1130
          local i = 0 -- shunt/writelite.yue:1131
          while (self.content_bytes[i] ~= nil) do -- shunt/writelite.yue:1132
            _with_0[#_with_0 + 1] = string.char(self.content_bytes[i]) -- shunt/writelite.yue:1133
            i = i + 1 -- shunt/writelite.yue:1134
          end -- shunt/writelite.yue:1134
          return _with_0 -- shunt/writelite.yue:1130
        end)()) -- shunt/writelite.yue:1134
      end), -- shunt/writelite.yue:1136
      open = F('() => <>', function(self) -- shunt/writelite.yue:1136
        if self.closed then -- shunt/writelite.yue:1137
          self.cursor = 0 -- shunt/writelite.yue:1138
        end -- shunt/writelite.yue:1137
        self.closed = false -- shunt/writelite.yue:1139
      end), -- shunt/writelite.yue:1141
      read = F('("*a"|number) => <?string, ?string>', function(self, amount) -- shunt/writelite.yue:1141
        if self.closed then -- shunt/writelite.yue:1142
          return nil, 'closed' -- shunt/writelite.yue:1143
        end -- shunt/writelite.yue:1142
        local content = self:content() -- shunt/writelite.yue:1144
        local end_index -- shunt/writelite.yue:1145
        if '*a' == amount then -- shunt/writelite.yue:1146
          end_index = #content -- shunt/writelite.yue:1147
        else -- shunt/writelite.yue:1149
          end_index = self.cursor + amount -- shunt/writelite.yue:1149
        end -- shunt/writelite.yue:1149
        if end_index > #content then -- shunt/writelite.yue:1150
          end_index = #content -- shunt/writelite.yue:1151
        end -- shunt/writelite.yue:1150
        if self.cursor == #content then -- shunt/writelite.yue:1152
          return nil, nil -- shunt/writelite.yue:1153
        end -- shunt/writelite.yue:1152
        local cursor = self.cursor -- shunt/writelite.yue:1154
        self.cursor = end_index -- shunt/writelite.yue:1155
        return (self:content():sub(1 + cursor, end_index)), nil -- shunt/writelite.yue:1156
      end), -- shunt/writelite.yue:1158
      write = F('(string) => ?string', function(self, to_write) -- shunt/writelite.yue:1158
        if self.closed then -- shunt/writelite.yue:1159
          return 'closed' -- shunt/writelite.yue:1160
        end -- shunt/writelite.yue:1159
        for i = 1, #to_write do -- shunt/writelite.yue:1161
          self.content_bytes[self.cursor] = to_write:byte(i) -- shunt/writelite.yue:1162
          self.cursor = self.cursor + 1 -- shunt/writelite.yue:1163
        end -- shunt/writelite.yue:1163
        return nil -- shunt/writelite.yue:1164
      end), -- shunt/writelite.yue:1166
      seek = F('(Whence, ?number) => <?number, ?string>', function(self, whence, num) -- shunt/writelite.yue:1166
        if self.closed then -- shunt/writelite.yue:1167
          return nil, 'closed' -- shunt/writelite.yue:1168
        end -- shunt/writelite.yue:1167
        local _ -- shunt/writelite.yue:1169
        num, _ = math.modf(num, 1) -- shunt/writelite.yue:1169
        if 'set' == whence then -- shunt/writelite.yue:1171
          self.cursor = num -- shunt/writelite.yue:1172
        elseif 'cur' == whence then -- shunt/writelite.yue:1173
          self.cursor = self.cursor + num -- shunt/writelite.yue:1174
        elseif 'end' == whence then -- shunt/writelite.yue:1175
          self.cursor = #self.content_bytes + num -- shunt/writelite.yue:1176
        else -- shunt/writelite.yue:1178
          error("internal error: unexpected whence " .. tostring(whence)) -- shunt/writelite.yue:1178
        end -- shunt/writelite.yue:1178
        return self.cursor, nil -- shunt/writelite.yue:1179
      end), -- shunt/writelite.yue:1181
      setvbuf = F('("full") => <>', function(self, _mode) -- shunt/writelite.yue:1181
        if self.closed then -- shunt/writelite.yue:1182
          return error('closed') -- shunt/writelite.yue:1183
        end -- shunt/writelite.yue:1182
      end), -- shunt/writelite.yue:1185
      flush = F('() => <boolean, ?string>', function(self) -- shunt/writelite.yue:1185
        return true, nil -- shunt/writelite.yue:1186
      end), -- shunt/writelite.yue:1188
      close = F('() => <boolean, ?string>', function(self) -- shunt/writelite.yue:1188
        if self.closed then -- shunt/writelite.yue:1189
          return false, 'closed' -- shunt/writelite.yue:1190
        end -- shunt/writelite.yue:1189
        self.closed = true -- shunt/writelite.yue:1191
        return true, nil -- shunt/writelite.yue:1192
      end) -- shunt/writelite.yue:1121
    } -- shunt/writelite.yue:1121
    if _base_0.__index == nil then -- shunt/writelite.yue:1121
      _base_0.__index = _base_0 -- shunt/writelite.yue:1121
    end -- shunt/writelite.yue:1192
    _class_0 = setmetatable({ -- shunt/writelite.yue:1121
      __init = F('(string) => <>', function(self, content) -- shunt/writelite.yue:1122
        self.cursor = 0 -- shunt/writelite.yue:1123
        do -- shunt/writelite.yue:1124
          local _with_0 = { } -- shunt/writelite.yue:1124
          for i = 1, #content do -- shunt/writelite.yue:1125
            _with_0[i - 1] = content:byte(i) -- shunt/writelite.yue:1126
          end -- shunt/writelite.yue:1126
          self.content_bytes = _with_0 -- shunt/writelite.yue:1124
        end -- shunt/writelite.yue:1124
        self.closed = true -- shunt/writelite.yue:1127
      end), -- shunt/writelite.yue:1121
      __base = _base_0, -- shunt/writelite.yue:1121
      __name = "TestFile" -- shunt/writelite.yue:1121
    }, { -- shunt/writelite.yue:1121
      __index = _base_0, -- shunt/writelite.yue:1121
      __call = function(cls, ...) -- shunt/writelite.yue:1121
        local _self_0 = setmetatable({ }, _base_0) -- shunt/writelite.yue:1121
        cls.__init(_self_0, ...) -- shunt/writelite.yue:1121
        return _self_0 -- shunt/writelite.yue:1121
      end -- shunt/writelite.yue:1121
    }) -- shunt/writelite.yue:1121
    _base_0.__class = _class_0 -- shunt/writelite.yue:1121
    TestFile = _class_0 -- shunt/writelite.yue:1121
  end -- shunt/writelite.yue:1192
  describe('writelite.Writelite', function() -- shunt/writelite.yue:1194
    describe('\\mode', function() -- shunt/writelite.yue:1195
      local modes = T('[writelite.Mode]', { -- shunt/writelite.yue:1197
        'blob' -- shunt/writelite.yue:1197
      }) -- shunt/writelite.yue:1196
      return it('forbids explicit reassignment', function() -- shunt/writelite.yue:1199
        for _index_0 = 1, #modes do -- shunt/writelite.yue:1200
          local mode_a = modes[_index_0] -- shunt/writelite.yue:1200
          for _index_1 = 1, #modes do -- shunt/writelite.yue:1201
            local mode_b = modes[_index_1] -- shunt/writelite.yue:1201
            print("mode_a=" .. tostring(mode_a) .. ", mode_b=" .. tostring(mode_b)) -- shunt/writelite.yue:1202
            local writelite = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1203
            writelite:mode(mode_a); -- shunt/writelite.yue:1204
            require('shunt.spec')._assert_that([=[(-> writelite\mode mode_b)]=], (function() -- shunt/writelite.yue:1205
              return writelite:mode(mode_b) -- shunt/writelite.yue:1205
            end), (errors(matches('cannot change mode once set'))), tostring("shunt/writelite.yue") .. ":" .. tostring(1205)) -- shunt/writelite.yue:1205
          end -- shunt/writelite.yue:1205
        end -- shunt/writelite.yue:1205
      end) -- shunt/writelite.yue:1205
    end) -- shunt/writelite.yue:1195
    describe('\\page_size', function() -- shunt/writelite.yue:1213
      it('forbids explicit reassignment', function() -- shunt/writelite.yue:1214
        local writelite = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1215
        writelite:page_size(MIN_PAGE_SIZE); -- shunt/writelite.yue:1216
        return require('shunt.spec')._assert_that([=[(-> writelite\page_size MIN_PAGE_SIZE)]=], (function() -- shunt/writelite.yue:1217
          return writelite:page_size(MIN_PAGE_SIZE) -- shunt/writelite.yue:1217
        end), (errors(matches('cannot change page size once set'))), tostring("shunt/writelite.yue") .. ":" .. tostring(1217)) -- shunt/writelite.yue:1217
      end) -- shunt/writelite.yue:1214
      it('forbids too-small page sizes', function() -- shunt/writelite.yue:1219
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1220
        require('shunt.spec')._assert_that([=[(-> \page_size MIN_PAGE_SIZE - 1)]=], (function() -- shunt/writelite.yue:1221
          return _with_0:page_size(MIN_PAGE_SIZE - 1) -- shunt/writelite.yue:1221
        end), (errors(matches("cannot change page size to " .. tostring(MIN_PAGE_SIZE - 1) .. ": minimum is " .. tostring(MIN_PAGE_SIZE)))), tostring("shunt/writelite.yue") .. ":" .. tostring(1221)) -- shunt/writelite.yue:1221
        return _with_0 -- shunt/writelite.yue:1220
      end) -- shunt/writelite.yue:1219
      it('requires integers', function() -- shunt/writelite.yue:1223
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1224
        require('shunt.spec')._assert_that([=[(-> \page_size 1234.5)]=], (function() -- shunt/writelite.yue:1225
          return _with_0:page_size(1234.5) -- shunt/writelite.yue:1225
        end), (errors(matches('cannot change page size to 1234%.5: not an integer'))), tostring("shunt/writelite.yue") .. ":" .. tostring(1225)) -- shunt/writelite.yue:1225
        return _with_0 -- shunt/writelite.yue:1224
      end) -- shunt/writelite.yue:1223
      it('requires powers of two', function() -- shunt/writelite.yue:1227
        for i = 10, 30 do -- shunt/writelite.yue:1228
          print("testing " .. tostring(i) .. "...") -- shunt/writelite.yue:1229
          do -- shunt/writelite.yue:1230
            local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1230
            require('shunt.spec')._expect_that([=[(-> \page_size bit.blshift 1, i)]=], (function() -- shunt/writelite.yue:1231
              return _with_0:page_size(bit.blshift(1, i)) -- shunt/writelite.yue:1231
            end), (no_errors()), tostring("shunt/writelite.yue") .. ":" .. tostring(1231)) -- shunt/writelite.yue:1231
          end -- shunt/writelite.yue:1230
        end -- shunt/writelite.yue:1231
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1233
        require('shunt.spec')._expect_that([=[(-> \page_size 2000)]=], (function() -- shunt/writelite.yue:1234
          return _with_0:page_size(2000) -- shunt/writelite.yue:1234
        end), (errors(matches('cannot change page size to 2000: not a power of 2'))), tostring("shunt/writelite.yue") .. ":" .. tostring(1234)) -- shunt/writelite.yue:1234
        return _with_0 -- shunt/writelite.yue:1233
      end) -- shunt/writelite.yue:1227
      return it('forbids implicit reassignment', function() -- shunt/writelite.yue:1236
        local fs = TestFs() -- shunt/writelite.yue:1237
        do -- shunt/writelite.yue:1238
          local _with_0 = Writelite('database.db', fs) -- shunt/writelite.yue:1238
          _with_0:mode('blob') -- shunt/writelite.yue:1239
          _with_0:page_size(bit.blshift(1, 13)) -- shunt/writelite.yue:1240
          local _, err = _with_0:open(); -- shunt/writelite.yue:1241
          require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1242)) -- shunt/writelite.yue:1242
          _, err = _with_0:close(); -- shunt/writelite.yue:1243
          require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1244)) -- shunt/writelite.yue:1244
        end -- shunt/writelite.yue:1238
        local _with_0 = Writelite('database.db', fs) -- shunt/writelite.yue:1245
        _with_0:mode('blob') -- shunt/writelite.yue:1246
        _with_0:page_size(bit.blshift(1, 20)) -- shunt/writelite.yue:1247
        local ok, err = _with_0:open(); -- shunt/writelite.yue:1248
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/writelite.yue") .. ":" .. tostring(1249)); -- shunt/writelite.yue:1249
        require('shunt.spec')._expect_that([=[err]=], err, (matches('page size mismatch')), tostring("shunt/writelite.yue") .. ":" .. tostring(1250)) -- shunt/writelite.yue:1250
        return _with_0 -- shunt/writelite.yue:1245
      end) -- shunt/writelite.yue:1250
    end) -- shunt/writelite.yue:1213
    describe('\\max_cached_pages', function() -- shunt/writelite.yue:1252
      local tests = { -- shunt/writelite.yue:1254
        { -- shunt/writelite.yue:1254
          it = 'accepts valid numbers', -- shunt/writelite.yue:1254
          max_cached_pages = 256 -- shunt/writelite.yue:1255
        }, -- shunt/writelite.yue:1254
        { -- shunt/writelite.yue:1256
          it = 'rejects floats', -- shunt/writelite.yue:1256
          max_cached_pages = 255.5, -- shunt/writelite.yue:1257
          expect = 'cannot set max cached pages to 255.5: not an integer' -- shunt/writelite.yue:1258
        }, -- shunt/writelite.yue:1256
        { -- shunt/writelite.yue:1259
          it = 'rejects too small numbers', -- shunt/writelite.yue:1259
          max_cached_pages = 0, -- shunt/writelite.yue:1260
          expect = 'cannot set max cached pages to 0: too small' -- shunt/writelite.yue:1261
        }, -- shunt/writelite.yue:1259
        { -- shunt/writelite.yue:1262
          it = 'rejects negative numbers', -- shunt/writelite.yue:1262
          max_cached_pages = -1, -- shunt/writelite.yue:1263
          expect = 'cannot set max cached pages to %-1: too small' -- shunt/writelite.yue:1264
        } -- shunt/writelite.yue:1262
      } -- shunt/writelite.yue:1253
      for _index_0 = 1, #tests do -- shunt/writelite.yue:1265
        local test = tests[_index_0] -- shunt/writelite.yue:1265
        it(test.it, function() -- shunt/writelite.yue:1266
          local max_cached_pages, expect = test.max_cached_pages, test.expect -- shunt/writelite.yue:1267
          local writelite = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1268
          if (expect ~= nil) then -- shunt/writelite.yue:1269
            return require('shunt.spec')._expect_that([=[(-> writelite\max_cached_pages max_cached_pages)]=], (function() -- shunt/writelite.yue:1270
              return writelite:max_cached_pages(max_cached_pages) -- shunt/writelite.yue:1270
            end), (errors(matches(expect))), tostring("shunt/writelite.yue") .. ":" .. tostring(1270)) -- shunt/writelite.yue:1270
          else -- shunt/writelite.yue:1272
            require('shunt.spec')._expect_that([=[(writelite\max_cached_pages max_cached_pages)]=], (writelite:max_cached_pages(max_cached_pages)), (eq(writelite)), tostring("shunt/writelite.yue") .. ":" .. tostring(1272)); -- shunt/writelite.yue:1272
            return require('shunt.spec')._expect_that([=[writelite\_ut_max_cached_pages!]=], writelite:_ut_max_cached_pages(), (eq(max_cached_pages)), tostring("shunt/writelite.yue") .. ":" .. tostring(1273)) -- shunt/writelite.yue:1273
          end -- shunt/writelite.yue:1269
        end) -- shunt/writelite.yue:1266
      end -- shunt/writelite.yue:1273
    end) -- shunt/writelite.yue:1252
    describe('\\open', function() -- shunt/writelite.yue:1275
      it('requires mandatory metadata', function() -- shunt/writelite.yue:1276
        local metadata = { -- shunt/writelite.yue:1278
          { -- shunt/writelite.yue:1278
            name = 'mode', -- shunt/writelite.yue:1278
            action = function(wl) -- shunt/writelite.yue:1279
              return wl:mode('blob') -- shunt/writelite.yue:1279
            end, -- shunt/writelite.yue:1279
            expect = 'cannot open main file: mode unspecified' -- shunt/writelite.yue:1280
          }, -- shunt/writelite.yue:1278
          { -- shunt/writelite.yue:1281
            name = 'page size', -- shunt/writelite.yue:1281
            action = function(wl) -- shunt/writelite.yue:1282
              return wl:page_size(bit.blshift(1, 13)) -- shunt/writelite.yue:1282
            end -- shunt/writelite.yue:1282
          } -- shunt/writelite.yue:1281
        } -- shunt/writelite.yue:1277
        for index_to_omit = 1, #metadata do -- shunt/writelite.yue:1283
          local name, expect -- shunt/writelite.yue:1284
          do -- shunt/writelite.yue:1284
            local _obj_0 = metadata[index_to_omit] -- shunt/writelite.yue:1284
            name, expect = _obj_0.name, _obj_0.expect -- shunt/writelite.yue:1284
          end -- shunt/writelite.yue:1284
          print("testing omission of " .. tostring(name) .. "...") -- shunt/writelite.yue:1285
          local writelite = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1287
          for i = 1, #metadata do -- shunt/writelite.yue:1289
            local _continue_0 = false -- shunt/writelite.yue:1290
            repeat -- shunt/writelite.yue:1290
              if i == index_to_omit then -- shunt/writelite.yue:1290
                _continue_0 = true -- shunt/writelite.yue:1291
                break -- shunt/writelite.yue:1291
              end -- shunt/writelite.yue:1290
              metadata[i].action(writelite) -- shunt/writelite.yue:1292
              _continue_0 = true -- shunt/writelite.yue:1290
            until true -- shunt/writelite.yue:1292
            if not _continue_0 then -- shunt/writelite.yue:1292
              break -- shunt/writelite.yue:1292
            end -- shunt/writelite.yue:1292
          end -- shunt/writelite.yue:1292
          if (expect ~= nil) then -- shunt/writelite.yue:1294
            local ok, err = writelite:open(); -- shunt/writelite.yue:1295
            require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/writelite.yue") .. ":" .. tostring(1296)); -- shunt/writelite.yue:1296
            require('shunt.spec')._expect_that([=[err]=], err, (matches(expect)), tostring("shunt/writelite.yue") .. ":" .. tostring(1297)) -- shunt/writelite.yue:1297
          else -- shunt/writelite.yue:1299
            local ok, err = writelite:open(); -- shunt/writelite.yue:1299
            require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1300)); -- shunt/writelite.yue:1300
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1301)) -- shunt/writelite.yue:1301
            ok, err = writelite:close(); -- shunt/writelite.yue:1303
            require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1304)); -- shunt/writelite.yue:1304
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1305)) -- shunt/writelite.yue:1305
          end -- shunt/writelite.yue:1294
        end -- shunt/writelite.yue:1305
      end) -- shunt/writelite.yue:1276
      return it('cannot be called whilst open', function() -- shunt/writelite.yue:1307
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1308
        _with_0:mode('blob') -- shunt/writelite.yue:1309
        local ok, err = _with_0:open(); -- shunt/writelite.yue:1310
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1311)); -- shunt/writelite.yue:1311
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1312)) -- shunt/writelite.yue:1312
        ok, err = _with_0:open(); -- shunt/writelite.yue:1314
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/writelite.yue") .. ":" .. tostring(1315)); -- shunt/writelite.yue:1315
        require('shunt.spec')._assert_that([=[err]=], err, (matches('cannot open writelite twice')), tostring("shunt/writelite.yue") .. ":" .. tostring(1316)) -- shunt/writelite.yue:1316
        ok, err = _with_0:close(); -- shunt/writelite.yue:1318
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1319)); -- shunt/writelite.yue:1319
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1320)) -- shunt/writelite.yue:1320
        ok, err = _with_0:open(); -- shunt/writelite.yue:1322
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1323)); -- shunt/writelite.yue:1323
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1324)) -- shunt/writelite.yue:1324
        ok, err = _with_0:open(); -- shunt/writelite.yue:1326
        require('shunt.spec')._expect_that([=[ok]=], ok, (eq(false)), tostring("shunt/writelite.yue") .. ":" .. tostring(1327)); -- shunt/writelite.yue:1327
        require('shunt.spec')._assert_that([=[err]=], err, (matches('cannot open writelite twice')), tostring("shunt/writelite.yue") .. ":" .. tostring(1328)) -- shunt/writelite.yue:1328
        return _with_0 -- shunt/writelite.yue:1308
      end) -- shunt/writelite.yue:1328
    end) -- shunt/writelite.yue:1275
    describe('\\close', function() -- shunt/writelite.yue:1330
      return it('cannot be called twice', function() -- shunt/writelite.yue:1331
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1332
        _with_0:mode('blob') -- shunt/writelite.yue:1333
        local ok, err = _with_0:open(); -- shunt/writelite.yue:1334
        require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1335)); -- shunt/writelite.yue:1335
        require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1336)) -- shunt/writelite.yue:1336
        ok, err = _with_0:close(); -- shunt/writelite.yue:1338
        require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1339)); -- shunt/writelite.yue:1339
        require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1340)) -- shunt/writelite.yue:1340
        ok, err = _with_0:close(); -- shunt/writelite.yue:1342
        require('shunt.spec')._assert_that([=[ok]=], ok, (eq(false)), tostring("shunt/writelite.yue") .. ":" .. tostring(1343)); -- shunt/writelite.yue:1343
        require('shunt.spec')._assert_that([=[err]=], err, (eq('cannot close writelite file database.db: not open')), tostring("shunt/writelite.yue") .. ":" .. tostring(1344)) -- shunt/writelite.yue:1344
        return _with_0 -- shunt/writelite.yue:1332
      end) -- shunt/writelite.yue:1344
    end) -- shunt/writelite.yue:1330
    describe('\\transaction', function() -- shunt/writelite.yue:1345
      return it('allows errors to pass through', function() -- shunt/writelite.yue:1346
        local _with_0 = Writelite('database.db', TestFs()) -- shunt/writelite.yue:1347
        _with_0:mode('blob') -- shunt/writelite.yue:1348
        assert(_with_0:open()) -- shunt/writelite.yue:1349
        local err -- shunt/writelite.yue:1350
xpcall(function() -- shunt/writelite.yue:1351
          return _with_0:transaction(function(_) -- shunt/writelite.yue:1352
            return error('interloper') -- shunt/writelite.yue:1353
          end) -- shunt/writelite.yue:1353
        end, function(err2) -- shunt/writelite.yue:1353
          err = err2 -- shunt/writelite.yue:1355
        end); -- shunt/writelite.yue:1355
        require('shunt.spec')._expect_that([=[err]=], err, (matches('interloper')), tostring("shunt/writelite.yue") .. ":" .. tostring(1356)) -- shunt/writelite.yue:1356
        assert(_with_0:close()) -- shunt/writelite.yue:1357
        return _with_0 -- shunt/writelite.yue:1347
      end) -- shunt/writelite.yue:1357
    end) -- shunt/writelite.yue:1345
    return describe('consistency', function() -- shunt/writelite.yue:1359
      describe('on golden-path', function() -- shunt/writelite.yue:1360
        local PAGE_SIZE = 1024 -- shunt/writelite.yue:1361
        local tests = { -- shunt/writelite.yue:1363
          { -- shunt/writelite.yue:1363
            name = 'no deltas', -- shunt/writelite.yue:1363
            txn_fn = function(txn) end -- shunt/writelite.yue:1364
          }, -- shunt/writelite.yue:1363
          { -- shunt/writelite.yue:1365
            name = 'single page deltas', -- shunt/writelite.yue:1365
            txn_fn = function(txn) -- shunt/writelite.yue:1366
              txn:seek('set', 0) -- shunt/writelite.yue:1367
              txn:write('hello, world') -- shunt/writelite.yue:1368
              txn:seek('set', 128) -- shunt/writelite.yue:1369
              return txn:write('how are you?') -- shunt/writelite.yue:1370
            end, -- shunt/writelite.yue:1366
            assertion = function(content) -- shunt/writelite.yue:1371
              local first_chunk_start_index = content:find('hello, world'); -- shunt/writelite.yue:1372
              require('shunt.spec')._expect_that([=[first_chunk_start_index]=], first_chunk_start_index, (eq(PAGE_SIZE + 1)), tostring("shunt/writelite.yue") .. ":" .. tostring(1373)) -- shunt/writelite.yue:1373
              local second_chunk_start_index = content:find('how are you?'); -- shunt/writelite.yue:1375
              return require('shunt.spec')._expect_that([=[second_chunk_start_index]=], second_chunk_start_index, (eq(PAGE_SIZE + 1 + 128)), tostring("shunt/writelite.yue") .. ":" .. tostring(1376)) -- shunt/writelite.yue:1376
            end -- shunt/writelite.yue:1371
          }, -- shunt/writelite.yue:1365
          { -- shunt/writelite.yue:1377
            name = 'overlapping small deltas', -- shunt/writelite.yue:1377
            txn_fn = function(txn) -- shunt/writelite.yue:1378
              txn:seek('set', 128) -- shunt/writelite.yue:1379
              txn:write('aaaaa.....ccccc') -- shunt/writelite.yue:1380
              txn:seek('set', 128 + 5) -- shunt/writelite.yue:1381
              return txn:write('bbbbb') -- shunt/writelite.yue:1382
            end, -- shunt/writelite.yue:1378
            assertion = function(content) -- shunt/writelite.yue:1383
              local pattern_index = content:find('aaaaabbbbbccccc'); -- shunt/writelite.yue:1384
              return require('shunt.spec')._expect_that([=[pattern_index]=], pattern_index, (eq(PAGE_SIZE + 1 + 128)), tostring("shunt/writelite.yue") .. ":" .. tostring(1385)) -- shunt/writelite.yue:1385
            end -- shunt/writelite.yue:1383
          }, -- shunt/writelite.yue:1377
          { -- shunt/writelite.yue:1386
            name = 'multi-page delta', -- shunt/writelite.yue:1386
            txn_fn = function(txn) -- shunt/writelite.yue:1387
              txn:seek('set', PAGE_SIZE / 4) -- shunt/writelite.yue:1388
              return txn:write(('a'):rep(2 * PAGE_SIZE)) -- shunt/writelite.yue:1389
            end, -- shunt/writelite.yue:1387
            assertion = function(content) -- shunt/writelite.yue:1390
              local pattern_index = content:find(('a'):rep(2 * PAGE_SIZE)); -- shunt/writelite.yue:1391
              return require('shunt.spec')._expect_that([=[pattern_index]=], pattern_index, (eq(1 + PAGE_SIZE + PAGE_SIZE / 4)), tostring("shunt/writelite.yue") .. ":" .. tostring(1392)) -- shunt/writelite.yue:1392
            end -- shunt/writelite.yue:1390
          } -- shunt/writelite.yue:1386
        } -- shunt/writelite.yue:1362
        for _index_0 = 1, #tests do -- shunt/writelite.yue:1393
          local test = tests[_index_0] -- shunt/writelite.yue:1393
          local name, txn_fn, assertion = test.name, test.txn_fn, test.assertion -- shunt/writelite.yue:1394
          it("functions with " .. tostring(name), function() -- shunt/writelite.yue:1395
            local fs = TestFs() -- shunt/writelite.yue:1396
            local FILE = 'database.db' -- shunt/writelite.yue:1397
            local _with_0 = Writelite(FILE, fs) -- shunt/writelite.yue:1398
            _with_0:mode('blob') -- shunt/writelite.yue:1399
            _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1400
            local ok, err = _with_0:open(); -- shunt/writelite.yue:1401
            require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1402)); -- shunt/writelite.yue:1402
            require('shunt.spec')._expect_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1403)); -- shunt/writelite.yue:1403
            require('shunt.spec')._expect_that([=[fs.files[FILE]?]=], (fs.files[FILE] ~= nil), (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1405)) -- shunt/writelite.yue:1405
            _with_0:transaction(txn_fn) -- shunt/writelite.yue:1407
            local content = fs.files[FILE]:content(); -- shunt/writelite.yue:1409
            require('shunt.spec')._expect_that([=[content]=], content, (matches('^#!writelite\0')), tostring("shunt/writelite.yue") .. ":" .. tostring(1410)) -- shunt/writelite.yue:1410
            if (assertion ~= nil) then -- shunt/writelite.yue:1411
              assertion(content) -- shunt/writelite.yue:1412
            end -- shunt/writelite.yue:1411
            ok, err = _with_0:close(); -- shunt/writelite.yue:1414
            require('shunt.spec')._assert_that([=[ok]=], ok, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1415)); -- shunt/writelite.yue:1415
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1416)) -- shunt/writelite.yue:1416
            return _with_0 -- shunt/writelite.yue:1398
          end) -- shunt/writelite.yue:1395
        end -- shunt/writelite.yue:1416
      end) -- shunt/writelite.yue:1360
      return describe('with failures', function() -- shunt/writelite.yue:1418
        local PAGE_SIZE = 1024 -- shunt/writelite.yue:1419
        local clean_fs -- shunt/writelite.yue:1421
        do -- shunt/writelite.yue:1421
          clean_fs = TestFs() -- shunt/writelite.yue:1422
          do -- shunt/writelite.yue:1424
            local _with_0 = Writelite('database.db', clean_fs) -- shunt/writelite.yue:1424
            _with_0:mode('blob') -- shunt/writelite.yue:1425
            _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1426
            assert(_with_0:open()) -- shunt/writelite.yue:1427
            assert(_with_0:close()) -- shunt/writelite.yue:1428
          end -- shunt/writelite.yue:1424
          clean_fs = clean_fs -- shunt/writelite.yue:1429
        end -- shunt/writelite.yue:1429
        it('is tested with a clean file system', function() -- shunt/writelite.yue:1431
          return require('shunt.spec')._assert_that([=[clean_fs.files]=], clean_fs.files, (has_fields({ -- shunt/writelite.yue:1432
            ['database.db'] = not_(eq(nil)), -- shunt/writelite.yue:1432
            ['database.db~'] = eq(nil) -- shunt/writelite.yue:1432
          })), tostring("shunt/writelite.yue") .. ":" .. tostring(1432)) -- shunt/writelite.yue:1434
        end) -- shunt/writelite.yue:1431
        local clone_fs -- shunt/writelite.yue:1436
        clone_fs = function(fs) -- shunt/writelite.yue:1436
          local _with_0 = clone(fs) -- shunt/writelite.yue:1437
          setmetatable(_with_0, getmetatable(fs)) -- shunt/writelite.yue:1438
          local mt = getmetatable((TestFile(''))) -- shunt/writelite.yue:1439
          for _, file in pairs(_with_0.files) do -- shunt/writelite.yue:1440
            setmetatable(file, mt) -- shunt/writelite.yue:1441
          end -- shunt/writelite.yue:1441
          return _with_0 -- shunt/writelite.yue:1437
        end -- shunt/writelite.yue:1436
        local journal_present -- shunt/writelite.yue:1443
        journal_present = function(fs) -- shunt/writelite.yue:1443
          return require('shunt.spec')._expect_that([=[fs.files['database.db~']]=], fs.files['database.db~'], (not_(eq(nil))), tostring("shunt/writelite.yue") .. ":" .. tostring(1444)) -- shunt/writelite.yue:1444
        end -- shunt/writelite.yue:1443
        local journal_absent -- shunt/writelite.yue:1445
        journal_absent = function(fs) -- shunt/writelite.yue:1445
          return require('shunt.spec')._expect_that([=[fs.files['database.db~']]=], fs.files['database.db~'], (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1446)) -- shunt/writelite.yue:1446
        end -- shunt/writelite.yue:1445
        local main_unchanged -- shunt/writelite.yue:1447
        main_unchanged = function(fs) -- shunt/writelite.yue:1447
          return require('shunt.spec')._expect_that([=[fs.files['database.db']\content!]=], fs.files['database.db']:content(), (eq(clean_fs.files['database.db']:content())), tostring("shunt/writelite.yue") .. ":" .. tostring(1448)) -- shunt/writelite.yue:1448
        end -- shunt/writelite.yue:1447
        local main_advanced -- shunt/writelite.yue:1449
        main_advanced = function(fs) -- shunt/writelite.yue:1449
          return require('shunt.spec')._expect_that([=[fs.files['database.db']\content!]=], fs.files['database.db']:content(), (matches(('a'):rep(3 * PAGE_SIZE))), tostring("shunt/writelite.yue") .. ":" .. tostring(1450)) -- shunt/writelite.yue:1450
        end -- shunt/writelite.yue:1449
        local clean_tests = { -- shunt/writelite.yue:1453
          { -- shunt/writelite.yue:1453
            failure_points = { -- shunt/writelite.yue:1454
              'pre-open' -- shunt/writelite.yue:1454
            }, -- shunt/writelite.yue:1453
            expect_after_first_run = { -- shunt/writelite.yue:1456
              journal_absent -- shunt/writelite.yue:1456
            }, -- shunt/writelite.yue:1455
            expect_after_second_run = { -- shunt/writelite.yue:1458
              journal_absent, -- shunt/writelite.yue:1458
              main_unchanged -- shunt/writelite.yue:1459
            } -- shunt/writelite.yue:1457
          }, -- shunt/writelite.yue:1453
          { -- shunt/writelite.yue:1460
            failure_points = { -- shunt/writelite.yue:1461
              'post-open' -- shunt/writelite.yue:1461
            }, -- shunt/writelite.yue:1460
            expect_after_first_run = { -- shunt/writelite.yue:1463
              journal_absent -- shunt/writelite.yue:1463
            }, -- shunt/writelite.yue:1462
            expect_after_second_run = { -- shunt/writelite.yue:1465
              journal_absent, -- shunt/writelite.yue:1465
              main_unchanged -- shunt/writelite.yue:1466
            } -- shunt/writelite.yue:1464
          }, -- shunt/writelite.yue:1460
          { -- shunt/writelite.yue:1467
            failure_points = { -- shunt/writelite.yue:1468
              'mid-transaction' -- shunt/writelite.yue:1468
            }, -- shunt/writelite.yue:1467
            expect_after_first_run = { -- shunt/writelite.yue:1470
              journal_absent -- shunt/writelite.yue:1470
            }, -- shunt/writelite.yue:1469
            expect_after_second_run = { -- shunt/writelite.yue:1472
              journal_absent, -- shunt/writelite.yue:1472
              main_unchanged -- shunt/writelite.yue:1473
            } -- shunt/writelite.yue:1471
          }, -- shunt/writelite.yue:1467
          { -- shunt/writelite.yue:1474
            failure_points = { -- shunt/writelite.yue:1475
              'post-transaction' -- shunt/writelite.yue:1475
            }, -- shunt/writelite.yue:1474
            expect_after_first_run = { -- shunt/writelite.yue:1477
              journal_absent -- shunt/writelite.yue:1477
            }, -- shunt/writelite.yue:1476
            expect_after_second_run = { -- shunt/writelite.yue:1479
              journal_absent, -- shunt/writelite.yue:1479
              main_advanced -- shunt/writelite.yue:1480
            } -- shunt/writelite.yue:1478
          } -- shunt/writelite.yue:1474
        } -- shunt/writelite.yue:1452
        for _index_0 = 1, #clean_tests do -- shunt/writelite.yue:1481
          local test = clean_tests[_index_0] -- shunt/writelite.yue:1481
          local failure_points, expect_after_first_run, expect_after_second_run = test.failure_points, test.expect_after_first_run, test.expect_after_second_run -- shunt/writelite.yue:1482
          it("is maintained with a clean file system at " .. tostring(table.concat(failure_points, '+')) .. " failures", function() -- shunt/writelite.yue:1487
            print('first-run') -- shunt/writelite.yue:1488
            local fs = clone_fs(clean_fs); -- shunt/writelite.yue:1489
            do -- shunt/writelite.yue:1490
              local _tbl_0 = { } -- shunt/writelite.yue:1490
              for _index_1 = 1, #failure_points do -- shunt/writelite.yue:1490
                local name = failure_points[_index_1] -- shunt/writelite.yue:1490
                _tbl_0[name] = true -- shunt/writelite.yue:1490
              end -- shunt/writelite.yue:1490
              injected_failures = _tbl_0 -- shunt/writelite.yue:1490
            end -- shunt/writelite.yue:1490
            local err -- shunt/writelite.yue:1491
xpcall(function() -- shunt/writelite.yue:1492
              local _with_0 = Writelite('database.db', fs) -- shunt/writelite.yue:1493
              _with_0:mode('blob') -- shunt/writelite.yue:1494
              _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1495
              assert(_with_0:open()) -- shunt/writelite.yue:1496
              _with_0:transaction(function(txn) -- shunt/writelite.yue:1497
                txn:seek('set', 256) -- shunt/writelite.yue:1499
                txn:write(('a'):rep(3 * PAGE_SIZE)) -- shunt/writelite.yue:1500
                return txn -- shunt/writelite.yue:1498
              end) -- shunt/writelite.yue:1497
              assert(_with_0:close()) -- shunt/writelite.yue:1501
              return _with_0 -- shunt/writelite.yue:1493
            end, function(err2) -- shunt/writelite.yue:1501
              if not err2:match('FAILURE_MARKER') then -- shunt/writelite.yue:1503
                err = err2 -- shunt/writelite.yue:1504
              end -- shunt/writelite.yue:1503
            end); -- shunt/writelite.yue:1504
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1505)) -- shunt/writelite.yue:1505
            for _index_1 = 1, #expect_after_first_run do -- shunt/writelite.yue:1507
              local check = expect_after_first_run[_index_1] -- shunt/writelite.yue:1507
              check(fs) -- shunt/writelite.yue:1508
            end -- shunt/writelite.yue:1508
            print('second-run'); -- shunt/writelite.yue:1510
            injected_failures = nil -- shunt/writelite.yue:1511
            local err -- shunt/writelite.yue:1512
xpcall(function() -- shunt/writelite.yue:1513
              local _with_0 = Writelite('database.db', fs) -- shunt/writelite.yue:1514
              _with_0:mode('blob') -- shunt/writelite.yue:1515
              _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1516
              assert(_with_0:open()) -- shunt/writelite.yue:1517
              assert(_with_0:close()) -- shunt/writelite.yue:1518
              return _with_0 -- shunt/writelite.yue:1514
            end, function(err2) -- shunt/writelite.yue:1518
              err = err2 -- shunt/writelite.yue:1520
            end); -- shunt/writelite.yue:1520
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1521)) -- shunt/writelite.yue:1521
            for _index_1 = 1, #expect_after_second_run do -- shunt/writelite.yue:1523
              local check = expect_after_second_run[_index_1] -- shunt/writelite.yue:1523
              check(fs) -- shunt/writelite.yue:1524
            end -- shunt/writelite.yue:1524
          end) -- shunt/writelite.yue:1487
        end -- shunt/writelite.yue:1524
        local dirty_fs -- shunt/writelite.yue:1526
        do -- shunt/writelite.yue:1526
          dirty_fs = clone_fs(clean_fs) -- shunt/writelite.yue:1527
          do -- shunt/writelite.yue:1528
            local _with_0 = Writelite('database.db', dirty_fs) -- shunt/writelite.yue:1528
            _with_0:mode('blob') -- shunt/writelite.yue:1529
            _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1530
            assert(_with_0:open()) -- shunt/writelite.yue:1531
            local err -- shunt/writelite.yue:1532
xpcall(function() -- shunt/writelite.yue:1533
              return _with_0:transaction(function(txn) -- shunt/writelite.yue:1534
                return txn:write(('a'):rep(3 * PAGE_SIZE)) -- shunt/writelite.yue:1535
              end) -- shunt/writelite.yue:1535
            end, function(err2) -- shunt/writelite.yue:1535
              err = err2 -- shunt/writelite.yue:1537
            end) -- shunt/writelite.yue:1537
            if (err ~= nil) then -- shunt/writelite.yue:1538
              error("unexpected error: " .. tostring(err)) -- shunt/writelite.yue:1539
            end -- shunt/writelite.yue:1538
            assert(_with_0:close()) -- shunt/writelite.yue:1540
          end -- shunt/writelite.yue:1528
          dirty_fs.files['database.db'] = clean_fs.files['database.db'] -- shunt/writelite.yue:1543
          dirty_fs:reinstate('database.db~') -- shunt/writelite.yue:1544
          dirty_fs = dirty_fs -- shunt/writelite.yue:1546
        end -- shunt/writelite.yue:1546
        it('is tested with a dirty file system', function() -- shunt/writelite.yue:1548
          return require('shunt.spec')._assert_that([=[dirty_fs.files]=], dirty_fs.files, (has_fields({ -- shunt/writelite.yue:1549
            ['database.db'] = not_(eq(nil)), -- shunt/writelite.yue:1549
            ['database.db~'] = not_(eq(nil)) -- shunt/writelite.yue:1549
          })), tostring("shunt/writelite.yue") .. ":" .. tostring(1549)) -- shunt/writelite.yue:1551
        end) -- shunt/writelite.yue:1548
        local dirty_tests = { -- shunt/writelite.yue:1554
          { -- shunt/writelite.yue:1554
            failure_points = { -- shunt/writelite.yue:1555
              'pre-open' -- shunt/writelite.yue:1555
            }, -- shunt/writelite.yue:1554
            expect_after_run = { -- shunt/writelite.yue:1557
              journal_present, -- shunt/writelite.yue:1557
              main_unchanged -- shunt/writelite.yue:1558
            } -- shunt/writelite.yue:1556
          }, -- shunt/writelite.yue:1554
          { -- shunt/writelite.yue:1559
            failure_points = { -- shunt/writelite.yue:1560
              'post-open' -- shunt/writelite.yue:1560
            }, -- shunt/writelite.yue:1559
            expect_after_run = { -- shunt/writelite.yue:1562
              journal_present, -- shunt/writelite.yue:1562
              main_unchanged -- shunt/writelite.yue:1563
            } -- shunt/writelite.yue:1561
          }, -- shunt/writelite.yue:1559
          { -- shunt/writelite.yue:1564
            failure_points = { -- shunt/writelite.yue:1565
              'post-journal-read' -- shunt/writelite.yue:1565
            }, -- shunt/writelite.yue:1564
            expect_after_run = { -- shunt/writelite.yue:1567
              journal_present, -- shunt/writelite.yue:1567
              main_unchanged -- shunt/writelite.yue:1568
            } -- shunt/writelite.yue:1566
          }, -- shunt/writelite.yue:1564
          { -- shunt/writelite.yue:1569
            failure_points = { -- shunt/writelite.yue:1570
              'post-journal-load' -- shunt/writelite.yue:1570
            }, -- shunt/writelite.yue:1569
            expect_after_run = { -- shunt/writelite.yue:1572
              journal_present, -- shunt/writelite.yue:1572
              main_unchanged -- shunt/writelite.yue:1573
            } -- shunt/writelite.yue:1571
          }, -- shunt/writelite.yue:1569
          { -- shunt/writelite.yue:1574
            failure_points = { -- shunt/writelite.yue:1575
              'mid-journal-recovery' -- shunt/writelite.yue:1575
            }, -- shunt/writelite.yue:1574
            expect_after_run = { -- shunt/writelite.yue:1577
              journal_present -- shunt/writelite.yue:1577
            } -- shunt/writelite.yue:1576
          }, -- shunt/writelite.yue:1574
          { -- shunt/writelite.yue:1578
            failure_points = { -- shunt/writelite.yue:1579
              'pre-journal-removal' -- shunt/writelite.yue:1579
            }, -- shunt/writelite.yue:1578
            expect_after_run = { -- shunt/writelite.yue:1581
              journal_present, -- shunt/writelite.yue:1581
              main_advanced -- shunt/writelite.yue:1582
            } -- shunt/writelite.yue:1580
          }, -- shunt/writelite.yue:1578
          { -- shunt/writelite.yue:1583
            failure_points = { -- shunt/writelite.yue:1584
              'post-journal-removal' -- shunt/writelite.yue:1584
            }, -- shunt/writelite.yue:1583
            expect_after_run = { -- shunt/writelite.yue:1586
              journal_absent, -- shunt/writelite.yue:1586
              main_advanced -- shunt/writelite.yue:1587
            } -- shunt/writelite.yue:1585
          } -- shunt/writelite.yue:1583
        } -- shunt/writelite.yue:1553
        for _index_0 = 1, #dirty_tests do -- shunt/writelite.yue:1588
          local test = dirty_tests[_index_0] -- shunt/writelite.yue:1588
          local failure_points, expect_after_run = test.failure_points, test.expect_after_run -- shunt/writelite.yue:1589
          it("is maintained with a dirty file system at " .. tostring(table.concat(failure_points, '+')) .. " failures", function() -- shunt/writelite.yue:1593
            local fs = clone_fs(dirty_fs); -- shunt/writelite.yue:1594
            do -- shunt/writelite.yue:1595
              local _tbl_0 = { } -- shunt/writelite.yue:1595
              for _index_1 = 1, #failure_points do -- shunt/writelite.yue:1595
                local name = failure_points[_index_1] -- shunt/writelite.yue:1595
                _tbl_0[name] = true -- shunt/writelite.yue:1595
              end -- shunt/writelite.yue:1595
              injected_failures = _tbl_0 -- shunt/writelite.yue:1595
            end -- shunt/writelite.yue:1595
            local err -- shunt/writelite.yue:1596
xpcall(function() -- shunt/writelite.yue:1597
              local _with_0 = Writelite('database.db', fs) -- shunt/writelite.yue:1598
              _with_0:mode('blob') -- shunt/writelite.yue:1599
              _with_0:page_size(PAGE_SIZE) -- shunt/writelite.yue:1600
              assert(_with_0:open()) -- shunt/writelite.yue:1601
              assert(_with_0:close()) -- shunt/writelite.yue:1602
              return _with_0 -- shunt/writelite.yue:1598
            end, function(err2) -- shunt/writelite.yue:1602
              if not err2:match('FAILURE_MARKER') then -- shunt/writelite.yue:1604
                err = err2 -- shunt/writelite.yue:1605
              end -- shunt/writelite.yue:1604
            end); -- shunt/writelite.yue:1605
            require('shunt.spec')._assert_that([=[err]=], err, (eq(nil)), tostring("shunt/writelite.yue") .. ":" .. tostring(1606)) -- shunt/writelite.yue:1606
            for _index_1 = 1, #expect_after_run do -- shunt/writelite.yue:1608
              local check = expect_after_run[_index_1] -- shunt/writelite.yue:1608
              check(fs) -- shunt/writelite.yue:1609
            end -- shunt/writelite.yue:1609
          end) -- shunt/writelite.yue:1593
        end -- shunt/writelite.yue:1609
        return it('is tested comprehensively', function() -- shunt/writelite.yue:1611
          local attempted_failure_points -- shunt/writelite.yue:1612
          do -- shunt/writelite.yue:1612
            local _with_0 = { } -- shunt/writelite.yue:1612
            for _index_0 = 1, #clean_tests do -- shunt/writelite.yue:1613
              local test = clean_tests[_index_0] -- shunt/writelite.yue:1613
              local _list_0 = test.failure_points -- shunt/writelite.yue:1614
              for _index_1 = 1, #_list_0 do -- shunt/writelite.yue:1614
                local failure_point = _list_0[_index_1] -- shunt/writelite.yue:1614
                _with_0[failure_point] = true -- shunt/writelite.yue:1615
              end -- shunt/writelite.yue:1615
            end -- shunt/writelite.yue:1615
            for _index_0 = 1, #dirty_tests do -- shunt/writelite.yue:1616
              local test = dirty_tests[_index_0] -- shunt/writelite.yue:1616
              local _list_0 = test.failure_points -- shunt/writelite.yue:1617
              for _index_1 = 1, #_list_0 do -- shunt/writelite.yue:1617
                local failure_point = _list_0[_index_1] -- shunt/writelite.yue:1617
                _with_0[failure_point] = true -- shunt/writelite.yue:1618
              end -- shunt/writelite.yue:1618
            end -- shunt/writelite.yue:1618
            attempted_failure_points = _with_0 -- shunt/writelite.yue:1612
          end -- shunt/writelite.yue:1612
          require('shunt.spec')._expect_that([=[attempted_failure_points]=], attempted_failure_points, (deep_eq({ -- shunt/writelite.yue:1619
            ['mid-journal-recovery'] = true, -- shunt/writelite.yue:1619
            ['mid-transaction'] = true, -- shunt/writelite.yue:1619
            ['post-journal-load'] = true, -- shunt/writelite.yue:1619
            ['post-journal-read'] = true, -- shunt/writelite.yue:1619
            ['post-journal-removal'] = true, -- shunt/writelite.yue:1619
            ['post-open'] = true, -- shunt/writelite.yue:1619
            ['post-transaction'] = true, -- shunt/writelite.yue:1619
            ['pre-journal-removal'] = true, -- shunt/writelite.yue:1619
            ['pre-open'] = true -- shunt/writelite.yue:1619
          })), tostring("shunt/writelite.yue") .. ":" .. tostring(1619)); -- shunt/writelite.yue:1619
          return require('shunt.spec')._expect_that([=[attempted_failure_points]=], attempted_failure_points, (deep_eq(activated_failure_points)), tostring("shunt/writelite.yue") .. ":" .. tostring(1620)) -- shunt/writelite.yue:1620
        end) -- shunt/writelite.yue:1620
      end) -- shunt/writelite.yue:1620
    end) -- shunt/writelite.yue:1620
  end) -- shunt/writelite.yue:1194
  describe('writelite.PageCache', function() -- shunt/writelite.yue:1622
    describe('\\write', function() -- shunt/writelite.yue:1623
      it('accesses the filesystem', function() -- shunt/writelite.yue:1624
        local page_size = 10 -- shunt/writelite.yue:1625
        local main_file = TestFile(table.concat((function() -- shunt/writelite.yue:1627
          local _with_0 = { } -- shunt/writelite.yue:1627
          _with_0[#_with_0 + 1] = ('a'):rep(page_size) -- shunt/writelite.yue:1628
          _with_0[#_with_0 + 1] = ('b'):rep(page_size) -- shunt/writelite.yue:1629
          _with_0[#_with_0 + 1] = ('c'):rep(page_size / 2) -- shunt/writelite.yue:1630
          return _with_0 -- shunt/writelite.yue:1627
        end)())) -- shunt/writelite.yue:1627
        main_file:open() -- shunt/writelite.yue:1631
        local cache = PageCache({ -- shunt/writelite.yue:1634
          _main_file = main_file, -- shunt/writelite.yue:1634
          _page_size = page_size -- shunt/writelite.yue:1635
        }); -- shunt/writelite.yue:1633
        require('shunt.spec')._expect_that([=[(cache\get 0 * page_size)]=], (cache:get(0 * page_size)), (has_fields({ -- shunt/writelite.yue:1636
          offset = eq(0), -- shunt/writelite.yue:1636
          content = eq(('a'):rep(page_size)) -- shunt/writelite.yue:1636
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1636)); -- shunt/writelite.yue:1636
        require('shunt.spec')._expect_that([=[(cache\get 0 * page_size)]=], (cache:get(0 * page_size)), (has_fields({ -- shunt/writelite.yue:1639
          offset = eq(0), -- shunt/writelite.yue:1639
          content = eq(('a'):rep(page_size)) -- shunt/writelite.yue:1639
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1639)); -- shunt/writelite.yue:1639
        require('shunt.spec')._expect_that([=[(cache\get 1 * page_size)]=], (cache:get(1 * page_size)), (has_fields({ -- shunt/writelite.yue:1642
          offset = eq(page_size), -- shunt/writelite.yue:1642
          content = eq(('b'):rep(page_size)) -- shunt/writelite.yue:1642
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1642)); -- shunt/writelite.yue:1642
        require('shunt.spec')._expect_that([=[(cache\get 2 * page_size)]=], (cache:get(2 * page_size)), (has_fields({ -- shunt/writelite.yue:1645
          offset = eq(2 * page_size), -- shunt/writelite.yue:1645
          content = eq(table.concat({ -- shunt/writelite.yue:1645
            ('c'):rep(page_size / 2), -- shunt/writelite.yue:1645
            ('\0'):rep(page_size / 2) -- shunt/writelite.yue:1645
          })) -- shunt/writelite.yue:1645
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1645)); -- shunt/writelite.yue:1645
        return require('shunt.spec')._expect_that([=[(cache\get 1 * page_size)]=], (cache:get(1 * page_size)), (has_fields({ -- shunt/writelite.yue:1650
          offset = eq(page_size), -- shunt/writelite.yue:1650
          content = eq(('b'):rep(page_size)) -- shunt/writelite.yue:1650
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1650)) -- shunt/writelite.yue:1652
      end) -- shunt/writelite.yue:1624
      return it('caches appropriately', function() -- shunt/writelite.yue:1654
        local PAGE_SIZE = 10 -- shunt/writelite.yue:1655
        local main_file = TestFile(table.concat((function() -- shunt/writelite.yue:1657
          local _with_0 = { } -- shunt/writelite.yue:1657
          local a = ('a'):byte() -- shunt/writelite.yue:1658
          for i = 0, 20 do -- shunt/writelite.yue:1659
            _with_0[#_with_0 + 1] = (string.char(a + i)):rep(PAGE_SIZE) -- shunt/writelite.yue:1660
          end -- shunt/writelite.yue:1660
          return _with_0 -- shunt/writelite.yue:1657
        end)())) -- shunt/writelite.yue:1657
        main_file:open() -- shunt/writelite.yue:1661
        local MAX_CACHED_PAGES = 10 -- shunt/writelite.yue:1663
        local cache = PageCache({ -- shunt/writelite.yue:1665
          _main_file = main_file, -- shunt/writelite.yue:1665
          _page_size = PAGE_SIZE -- shunt/writelite.yue:1666
        }) -- shunt/writelite.yue:1664
        cache:set_max_cached_pages(MAX_CACHED_PAGES) -- shunt/writelite.yue:1667
        for i = 0, MAX_CACHED_PAGES - 1 do -- shunt/writelite.yue:1670
          cache:get(i * PAGE_SIZE) -- shunt/writelite.yue:1671
        end -- shunt/writelite.yue:1671
        main_file:seek('set', 0) -- shunt/writelite.yue:1674
        local err = main_file:write(('0'):rep(20 * PAGE_SIZE)) -- shunt/writelite.yue:1675
        assert(not (err ~= nil), err) -- shunt/writelite.yue:1676
        local a = ('a'):byte() -- shunt/writelite.yue:1679
        for i = 0, MAX_CACHED_PAGES - 1 do -- shunt/writelite.yue:1680
          require('shunt.spec')._expect_that([=[(cache\get i * PAGE_SIZE)]=], (cache:get(i * PAGE_SIZE)), (has_fields({ -- shunt/writelite.yue:1681
            offset = eq(i * PAGE_SIZE), -- shunt/writelite.yue:1681
            content = eq((string.char(a + i)):rep(PAGE_SIZE)) -- shunt/writelite.yue:1681
          })), tostring("shunt/writelite.yue") .. ":" .. tostring(1681)) -- shunt/writelite.yue:1681
        end -- shunt/writelite.yue:1683
        cache:get(MAX_CACHED_PAGES * PAGE_SIZE); -- shunt/writelite.yue:1686
        return require('shunt.spec')._expect_that([=[(cache\get 0)]=], (cache:get(0)), (has_fields({ -- shunt/writelite.yue:1688
          offset = eq(0), -- shunt/writelite.yue:1688
          content = eq(('0'):rep(PAGE_SIZE)) -- shunt/writelite.yue:1688
        })), tostring("shunt/writelite.yue") .. ":" .. tostring(1688)) -- shunt/writelite.yue:1690
      end) -- shunt/writelite.yue:1690
    end) -- shunt/writelite.yue:1623
    return describe('\\set', function() -- shunt/writelite.yue:1692
      it('shows changes immediately', function() -- shunt/writelite.yue:1693
        local PAGE_SIZE = 10 -- shunt/writelite.yue:1694
        local main_file = TestFile(table.concat((function() -- shunt/writelite.yue:1696
          local _with_0 = { } -- shunt/writelite.yue:1696
          local a = ('a'):byte() -- shunt/writelite.yue:1697
          for i = 0, 20 do -- shunt/writelite.yue:1698
            _with_0[#_with_0 + 1] = (string.char(a + i)):rep(PAGE_SIZE) -- shunt/writelite.yue:1699
          end -- shunt/writelite.yue:1699
          return _with_0 -- shunt/writelite.yue:1696
        end)())) -- shunt/writelite.yue:1696
        main_file:open() -- shunt/writelite.yue:1700
        local MAX_CACHED_PAGES = 10 -- shunt/writelite.yue:1702
        local cache = PageCache({ -- shunt/writelite.yue:1704
          _main_file = main_file, -- shunt/writelite.yue:1704
          _page_size = PAGE_SIZE -- shunt/writelite.yue:1705
        }) -- shunt/writelite.yue:1703
        return cache:set_max_cached_pages(MAX_CACHED_PAGES) -- shunt/writelite.yue:1706
      end) -- shunt/writelite.yue:1693
      it('rejects unaligned pages', function() -- shunt/writelite.yue:1708
        local PAGE_SIZE = 32 -- shunt/writelite.yue:1709
        local cache = PageCache({ -- shunt/writelite.yue:1711
          _main_file = (function() -- shunt/writelite.yue:1711
            local _with_0 = TestFile('') -- shunt/writelite.yue:1711
            _with_0:open() -- shunt/writelite.yue:1712
            return _with_0 -- shunt/writelite.yue:1711
          end)(), -- shunt/writelite.yue:1711
          _page_size = PAGE_SIZE -- shunt/writelite.yue:1713
        }) -- shunt/writelite.yue:1710
        local page = Page({ -- shunt/writelite.yue:1715
          offset = 0, -- shunt/writelite.yue:1715
          content = ('\0'):rep(PAGE_SIZE) -- shunt/writelite.yue:1716
        }); -- shunt/writelite.yue:1714
        return require('shunt.spec')._expect_that([=[(-> cache\set 12, page)]=], (function() -- shunt/writelite.yue:1717
          return cache:set(12, page) -- shunt/writelite.yue:1717
        end), (errors(matches('page%-cache offset must be a multiple of the page size'))), tostring("shunt/writelite.yue") .. ":" .. tostring(1717)) -- shunt/writelite.yue:1717
      end) -- shunt/writelite.yue:1708
      return it('rejects incorrect-size pages', function() -- shunt/writelite.yue:1719
        local PAGE_SIZE = 32 -- shunt/writelite.yue:1720
        local cache = PageCache({ -- shunt/writelite.yue:1722
          _main_file = (function() -- shunt/writelite.yue:1722
            local _with_0 = TestFile('') -- shunt/writelite.yue:1722
            _with_0:open() -- shunt/writelite.yue:1723
            return _with_0 -- shunt/writelite.yue:1722
          end)(), -- shunt/writelite.yue:1722
          _page_size = PAGE_SIZE -- shunt/writelite.yue:1724
        }) -- shunt/writelite.yue:1721
        local page = Page({ -- shunt/writelite.yue:1726
          offset = 123 * PAGE_SIZE, -- shunt/writelite.yue:1726
          content = '0123456789' -- shunt/writelite.yue:1727
        }); -- shunt/writelite.yue:1725
        return require('shunt.spec')._expect_that([=[(-> cache\set 123 * PAGE_SIZE, page)]=], (function() -- shunt/writelite.yue:1728
          return cache:set(123 * PAGE_SIZE, page) -- shunt/writelite.yue:1728
        end), (errors(matches("internal error: page has the wrong size %(10 != " .. tostring(PAGE_SIZE) .. "%)"))), tostring("shunt/writelite.yue") .. ":" .. tostring(1728)) -- shunt/writelite.yue:1728
      end) -- shunt/writelite.yue:1728
    end) -- shunt/writelite.yue:1728
  end) -- shunt/writelite.yue:1622
  describe('writelite.Hasher', function() -- shunt/writelite.yue:1730
    it('avoids collisions', function() -- shunt/writelite.yue:1731
      local collisions = { } -- shunt/writelite.yue:1732
      local NUM_STRINGS = 10000 -- shunt/writelite.yue:1733
      for i = 1, NUM_STRINGS do -- shunt/writelite.yue:1734
        local hash = Hasher():write("some_string_" .. tostring(i) .. "_which_is_similar"):finish() -- shunt/writelite.yue:1735
        if collisions[hash] == nil then -- shunt/writelite.yue:1738
          collisions[hash] = 0 -- shunt/writelite.yue:1738
        end -- shunt/writelite.yue:1738
        collisions[hash] = collisions[hash] + 1 -- shunt/writelite.yue:1739
      end -- shunt/writelite.yue:1739
      local max_collisions = -1 -- shunt/writelite.yue:1741
      for h, c in pairs(collisions) do -- shunt/writelite.yue:1742
        if max_collisions < c then -- shunt/writelite.yue:1743
          max_collisions = c -- shunt/writelite.yue:1744
        end -- shunt/writelite.yue:1743
      end -- shunt/writelite.yue:1744
      return require('shunt.spec')._expect_that([=[max_collisions]=], max_collisions, (lt(NUM_STRINGS * 0.01)), tostring("shunt/writelite.yue") .. ":" .. tostring(1745)) -- shunt/writelite.yue:1745
    end) -- shunt/writelite.yue:1731
    return it('is stable for tables', function() -- shunt/writelite.yue:1747
      local make_test_data -- shunt/writelite.yue:1748
      make_test_data = function() -- shunt/writelite.yue:1748
        local _with_0 = { } -- shunt/writelite.yue:1749
        _with_0.k1 = { -- shunt/writelite.yue:1751
          k11 = 'a', -- shunt/writelite.yue:1751
          k12 = 'b' -- shunt/writelite.yue:1752
        } -- shunt/writelite.yue:1750
        _with_0.k2 = { -- shunt/writelite.yue:1754
          k21 = 'c', -- shunt/writelite.yue:1754
          k22 = 'd' -- shunt/writelite.yue:1755
        } -- shunt/writelite.yue:1753
        return _with_0 -- shunt/writelite.yue:1749
      end -- shunt/writelite.yue:1748
      local hash = nil -- shunt/writelite.yue:1756
      for i = 1, 1000 do -- shunt/writelite.yue:1757
        local h = Hasher():write(make_test_data()):finish() -- shunt/writelite.yue:1758
        if (hash ~= nil) then -- shunt/writelite.yue:1761
          require('shunt.spec')._assert_that([=[h]=], h, (eq(hash)), tostring("shunt/writelite.yue") .. ":" .. tostring(1762)) -- shunt/writelite.yue:1762
        else -- shunt/writelite.yue:1764
          hash = h -- shunt/writelite.yue:1764
        end -- shunt/writelite.yue:1761
      end -- shunt/writelite.yue:1764
    end) -- shunt/writelite.yue:1764
  end) -- shunt/writelite.yue:1730
  return describe('writelite.Serialiser roundtrip', function() -- shunt/writelite.yue:1766
    local tests = { -- shunt/writelite.yue:1768
      { -- shunt/writelite.yue:1768
        name = 'nil', -- shunt/writelite.yue:1768
        value = nil -- shunt/writelite.yue:1769
      }, -- shunt/writelite.yue:1768
      { -- shunt/writelite.yue:1770
        name = 'true', -- shunt/writelite.yue:1770
        value = true -- shunt/writelite.yue:1771
      }, -- shunt/writelite.yue:1770
      { -- shunt/writelite.yue:1772
        name = 'false', -- shunt/writelite.yue:1772
        value = false -- shunt/writelite.yue:1773
      }, -- shunt/writelite.yue:1772
      { -- shunt/writelite.yue:1774
        name = 'int (zero)', -- shunt/writelite.yue:1774
        value = 0 -- shunt/writelite.yue:1775
      }, -- shunt/writelite.yue:1774
      { -- shunt/writelite.yue:1776
        name = 'int (small, positive)', -- shunt/writelite.yue:1776
        value = 10 -- shunt/writelite.yue:1777
      }, -- shunt/writelite.yue:1776
      { -- shunt/writelite.yue:1778
        name = 'int (small, negative)', -- shunt/writelite.yue:1778
        value = -10 -- shunt/writelite.yue:1779
      }, -- shunt/writelite.yue:1778
      { -- shunt/writelite.yue:1780
        name = 'int (max int)', -- shunt/writelite.yue:1780
        value = MAX_INT -- shunt/writelite.yue:1781
      }, -- shunt/writelite.yue:1780
      { -- shunt/writelite.yue:1782
        name = 'int (min int)', -- shunt/writelite.yue:1782
        value = MIN_INT -- shunt/writelite.yue:1783
      }, -- shunt/writelite.yue:1782
      { -- shunt/writelite.yue:1784
        name = 'float (small positive)', -- shunt/writelite.yue:1784
        value = 1.1, -- shunt/writelite.yue:1785
        check = function(actual, value) -- shunt/writelite.yue:1786
          return require('shunt.spec')._expect_that([=[actual]=], actual, (near(value)), tostring("shunt/writelite.yue") .. ":" .. tostring(1787)) -- shunt/writelite.yue:1787
        end -- shunt/writelite.yue:1786
      }, -- shunt/writelite.yue:1784
      { -- shunt/writelite.yue:1788
        name = 'float (small negative)', -- shunt/writelite.yue:1788
        value = -1.1, -- shunt/writelite.yue:1789
        check = function(actual, value) -- shunt/writelite.yue:1790
          return require('shunt.spec')._expect_that([=[actual]=], actual, (near(value)), tostring("shunt/writelite.yue") .. ":" .. tostring(1791)) -- shunt/writelite.yue:1791
        end -- shunt/writelite.yue:1790
      }, -- shunt/writelite.yue:1788
      { -- shunt/writelite.yue:1792
        name = 'float (large positive)', -- shunt/writelite.yue:1792
        value = 9999999999999 * 9999999 * 0.3, -- shunt/writelite.yue:1793
        check = function(actual, value) -- shunt/writelite.yue:1794
          return require('shunt.spec')._expect_that([=[actual]=], actual, (near(value)), tostring("shunt/writelite.yue") .. ":" .. tostring(1795)) -- shunt/writelite.yue:1795
        end -- shunt/writelite.yue:1794
      }, -- shunt/writelite.yue:1792
      { -- shunt/writelite.yue:1796
        name = 'float (large negative)', -- shunt/writelite.yue:1796
        value = -9999999999999 * 9999999 * 0.3, -- shunt/writelite.yue:1797
        check = function(actual, value) -- shunt/writelite.yue:1798
          return require('shunt.spec')._expect_that([=[actual]=], actual, (near(value)), tostring("shunt/writelite.yue") .. ":" .. tostring(1799)) -- shunt/writelite.yue:1799
        end -- shunt/writelite.yue:1798
      }, -- shunt/writelite.yue:1796
      { -- shunt/writelite.yue:1800
        name = 'empty string', -- shunt/writelite.yue:1800
        value = '' -- shunt/writelite.yue:1801
      }, -- shunt/writelite.yue:1800
      { -- shunt/writelite.yue:1802
        name = 'short string', -- shunt/writelite.yue:1802
        value = 'asdf' -- shunt/writelite.yue:1803
      }, -- shunt/writelite.yue:1802
      { -- shunt/writelite.yue:1804
        name = 'long string', -- shunt/writelite.yue:1804
        value = ('x'):rep(1000) -- shunt/writelite.yue:1805
      }, -- shunt/writelite.yue:1804
      { -- shunt/writelite.yue:1806
        name = 'simple leaf table', -- shunt/writelite.yue:1806
        value = { -- shunt/writelite.yue:1808
          [false] = true -- shunt/writelite.yue:1808
        } -- shunt/writelite.yue:1807
      }, -- shunt/writelite.yue:1806
      { -- shunt/writelite.yue:1809
        name = 'simple leaf table', -- shunt/writelite.yue:1809
        value = { -- shunt/writelite.yue:1811
          hello = true -- shunt/writelite.yue:1811
        } -- shunt/writelite.yue:1810
      }, -- shunt/writelite.yue:1809
      { -- shunt/writelite.yue:1812
        name = 'simple leaf table', -- shunt/writelite.yue:1812
        value = { -- shunt/writelite.yue:1814
          [false] = 'world' -- shunt/writelite.yue:1814
        } -- shunt/writelite.yue:1813
      }, -- shunt/writelite.yue:1812
      { -- shunt/writelite.yue:1815
        name = 'complex leaf table', -- shunt/writelite.yue:1815
        value = { -- shunt/writelite.yue:1817
          hello = 'world' -- shunt/writelite.yue:1817
        } -- shunt/writelite.yue:1816
      }, -- shunt/writelite.yue:1815
      { -- shunt/writelite.yue:1818
        name = 'tree table', -- shunt/writelite.yue:1818
        value = { -- shunt/writelite.yue:1820
          hello = { -- shunt/writelite.yue:1821
            world = { -- shunt/writelite.yue:1822
              how = { -- shunt/writelite.yue:1823
                are = 'you' -- shunt/writelite.yue:1823
              } -- shunt/writelite.yue:1822
            } -- shunt/writelite.yue:1821
          } -- shunt/writelite.yue:1820
        } -- shunt/writelite.yue:1819
      }, -- shunt/writelite.yue:1818
      { -- shunt/writelite.yue:1824
        name = 'cyclic table', -- shunt/writelite.yue:1824
        value = (function() -- shunt/writelite.yue:1825
          local ret = { } -- shunt/writelite.yue:1826
          ret.self = ret -- shunt/writelite.yue:1827
          return ret -- shunt/writelite.yue:1828
        end)() -- shunt/writelite.yue:1825
      }, -- shunt/writelite.yue:1824
      { -- shunt/writelite.yue:1829
        name = 'indirectly cyclic table', -- shunt/writelite.yue:1829
        value = (function() -- shunt/writelite.yue:1830
          local ret = { -- shunt/writelite.yue:1831
            child = { } -- shunt/writelite.yue:1831
          } -- shunt/writelite.yue:1831
          ret.child.parent = ret -- shunt/writelite.yue:1832
          return ret -- shunt/writelite.yue:1833
        end)() -- shunt/writelite.yue:1830
      }, -- shunt/writelite.yue:1829
      { -- shunt/writelite.yue:1834
        name = 'key-tree-table', -- shunt/writelite.yue:1834
        value = { -- shunt/writelite.yue:1836
          [{ -- shunt/writelite.yue:1836
            hello = 'there' -- shunt/writelite.yue:1836
          }] = 'world' -- shunt/writelite.yue:1836
        }, -- shunt/writelite.yue:1835
        check = function(actual, value) -- shunt/writelite.yue:1837
          local actual_structure -- shunt/writelite.yue:1838
          do -- shunt/writelite.yue:1838
            local _accum_0 = { } -- shunt/writelite.yue:1838
            local _len_0 = 1 -- shunt/writelite.yue:1838
            for key, value in pairs(actual) do -- shunt/writelite.yue:1838
              _accum_0[_len_0] = { -- shunt/writelite.yue:1838
                key = key, -- shunt/writelite.yue:1838
                value = value -- shunt/writelite.yue:1838
              } -- shunt/writelite.yue:1838
              _len_0 = _len_0 + 1 -- shunt/writelite.yue:1838
            end -- shunt/writelite.yue:1838
            actual_structure = _accum_0 -- shunt/writelite.yue:1838
          end -- shunt/writelite.yue:1838
          for _index_0 = 1, #actual_structure do -- shunt/writelite.yue:1839
            local kv = actual_structure[_index_0] -- shunt/writelite.yue:1839
            do -- shunt/writelite.yue:1840
              local _accum_0 = { } -- shunt/writelite.yue:1840
              local _len_0 = 1 -- shunt/writelite.yue:1840
              for key, value in pairs(kv.key) do -- shunt/writelite.yue:1840
                _accum_0[_len_0] = { -- shunt/writelite.yue:1840
                  key = key, -- shunt/writelite.yue:1840
                  value = value -- shunt/writelite.yue:1840
                } -- shunt/writelite.yue:1840
                _len_0 = _len_0 + 1 -- shunt/writelite.yue:1840
              end -- shunt/writelite.yue:1840
              kv.key = _accum_0 -- shunt/writelite.yue:1840
            end -- shunt/writelite.yue:1840
          end -- shunt/writelite.yue:1840
          return require('shunt.spec')._expect_that([=[actual_structure]=], actual_structure, (deep_eq({ -- shunt/writelite.yue:1841
            { -- shunt/writelite.yue:1841
              key = { -- shunt/writelite.yue:1841
                { -- shunt/writelite.yue:1841
                  key = 'hello', -- shunt/writelite.yue:1841
                  value = 'there' -- shunt/writelite.yue:1841
                } -- shunt/writelite.yue:1841
              }, -- shunt/writelite.yue:1841
              value = 'world' -- shunt/writelite.yue:1841
            } -- shunt/writelite.yue:1841
          })), tostring("shunt/writelite.yue") .. ":" .. tostring(1841)) -- shunt/writelite.yue:1846
        end -- shunt/writelite.yue:1837
      }, -- shunt/writelite.yue:1834
      { -- shunt/writelite.yue:1847
        name = 'key-cyclic table', -- shunt/writelite.yue:1847
        value = (function() -- shunt/writelite.yue:1848
          local ret = { } -- shunt/writelite.yue:1849
          ret[ret] = true -- shunt/writelite.yue:1850
          return ret -- shunt/writelite.yue:1851
        end)(), -- shunt/writelite.yue:1848
        check = function(actual, value) -- shunt/writelite.yue:1852
          local keys -- shunt/writelite.yue:1853
          do -- shunt/writelite.yue:1853
            local _accum_0 = { } -- shunt/writelite.yue:1853
            local _len_0 = 1 -- shunt/writelite.yue:1853
            for key, _ in pairs(actual) do -- shunt/writelite.yue:1853
              _accum_0[_len_0] = { -- shunt/writelite.yue:1853
                key = key -- shunt/writelite.yue:1853
              } -- shunt/writelite.yue:1853
              _len_0 = _len_0 + 1 -- shunt/writelite.yue:1853
            end -- shunt/writelite.yue:1853
            keys = _accum_0 -- shunt/writelite.yue:1853
          end -- shunt/writelite.yue:1853
          require('shunt.spec')._assert_that([=[keys]=], keys, (len(eq(1))), tostring("shunt/writelite.yue") .. ":" .. tostring(1854)) -- shunt/writelite.yue:1854
          local key = keys[1].key; -- shunt/writelite.yue:1856
          return require('shunt.spec')._expect_that([=[key[key]]=], key[key], (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1857)) -- shunt/writelite.yue:1857
        end -- shunt/writelite.yue:1852
      } -- shunt/writelite.yue:1847
    } -- shunt/writelite.yue:1767
    for _index_0 = 1, #tests do -- shunt/writelite.yue:1860
      local test = tests[_index_0] -- shunt/writelite.yue:1860
      local name, value, matcher, check = test.name, test.value, test.matcher, test.check -- shunt/writelite.yue:1861
      if matcher == nil then -- shunt/writelite.yue:1864
        matcher = deep_eq -- shunt/writelite.yue:1864
      end -- shunt/writelite.yue:1864
      if check == nil then -- shunt/writelite.yue:1865
        check = function(actual, value) -- shunt/writelite.yue:1865
          return require('shunt.spec')._expect_that([=[actual]=], actual, (deep_eq(value)), tostring("shunt/writelite.yue") .. ":" .. tostring(1866)) -- shunt/writelite.yue:1866
        end -- shunt/writelite.yue:1865
      end -- shunt/writelite.yue:1865
      it("works for " .. tostring(name), function() -- shunt/writelite.yue:1868
        local serialised = Serialiser():write(value):finish() -- shunt/writelite.yue:1869
        local serialised_directly = Serialiser:serialise(value); -- shunt/writelite.yue:1873
        require('shunt.spec')._expect_that([=[serialised_directly]=], serialised_directly, (eq(serialised)), tostring("shunt/writelite.yue") .. ":" .. tostring(1874)) -- shunt/writelite.yue:1874
        print_serialised(serialised) -- shunt/writelite.yue:1876
        local deserialised_from_string, eof = (Deserialiser(serialised)):parse() -- shunt/writelite.yue:1877
        check(deserialised_from_string, value); -- shunt/writelite.yue:1879
        require('shunt.spec')._expect_that([=[eof]=], eof, (eq(true)), tostring("shunt/writelite.yue") .. ":" .. tostring(1880)) -- shunt/writelite.yue:1880
        local direct_deserialised_from_string = Deserialiser:deserialise(serialised) -- shunt/writelite.yue:1882
        check(direct_deserialised_from_string, value) -- shunt/writelite.yue:1883
        local path = os.tmpname() -- shunt/writelite.yue:1885
        local file = assert(io.open(path, 'w+')) -- shunt/writelite.yue:1886
        assert(file:write(serialised)) -- shunt/writelite.yue:1888
        assert(file:flush()) -- shunt/writelite.yue:1889
        assert(file:seek('set', 0)) -- shunt/writelite.yue:1890
        local err -- shunt/writelite.yue:1892
xpcall(function() -- shunt/writelite.yue:1894
          local deserialised_from_file = (Deserialiser(file)):parse() -- shunt/writelite.yue:1895
          return check(deserialised_from_file, value) -- shunt/writelite.yue:1897
        end, function(err2) -- shunt/writelite.yue:1897
          err = err2 -- shunt/writelite.yue:1899
        end) -- shunt/writelite.yue:1899
        if (err ~= nil) then -- shunt/writelite.yue:1900
          error(err) -- shunt/writelite.yue:1901
        end -- shunt/writelite.yue:1900
        assert(file:seek('set', 0)) -- shunt/writelite.yue:1903
xpcall(function() -- shunt/writelite.yue:1904
          local direct_deserialised_from_file = Deserialiser:deserialise(file) -- shunt/writelite.yue:1905
          return check(direct_deserialised_from_file, value) -- shunt/writelite.yue:1906
        end, function(err2) -- shunt/writelite.yue:1906
          err = err2 -- shunt/writelite.yue:1908
        end) -- shunt/writelite.yue:1908
        if (err ~= nil) then -- shunt/writelite.yue:1909
          error(err) -- shunt/writelite.yue:1910
        end -- shunt/writelite.yue:1909
        assert(file:close()) -- shunt/writelite.yue:1912
        return os.remove(path) -- shunt/writelite.yue:1913
      end) -- shunt/writelite.yue:1868
    end -- shunt/writelite.yue:1913
  end) -- shunt/writelite.yue:1913
end) -- shunt/writelite.yue:1073
return _module_0 -- shunt/writelite.yue:1913
end
-- [yue]: shunt.yue
local debug_, force_error_on_bad_exit, main, run, args, ok -- shunt.yue:1
local apply_compat, HOST, test_compat -- shunt.yue:0
do -- shunt.yue:0
  local _obj_0 = require('shunt.compat') -- shunt.yue:0
  apply_compat, HOST, test_compat = _obj_0.apply_compat, _obj_0.HOST, _obj_0.test_compat -- shunt.yue:0
end -- shunt.yue:0
apply_compat() -- shunt.yue:4
local declare_type = require('shunt.quicktype').declare_type -- shunt.yue:0
local Args = require('shunt.args').Args -- shunt.yue:0
local instrument = require('shunt.instrument').instrument -- shunt.yue:0
local log = require('shunt.logger').log -- shunt.yue:0
local detect_and_use_monitor = require('shunt.monitor').detect_and_use_monitor -- shunt.yue:0
local F = require('shunt.quicktype').F -- shunt.yue:0
local run_tests = require('shunt.spec').run_tests -- shunt.yue:0
local clean = require('shunt.cmd.clean') -- shunt.yue:15
local declare = require('shunt.cmd.declare') -- shunt.yue:16
local disable = require('shunt.cmd.disable') -- shunt.yue:17
local edit = require('shunt.cmd.edit') -- shunt.yue:18
local enable = require('shunt.cmd.enable') -- shunt.yue:19
local flash = require('shunt.cmd.flash') -- shunt.yue:20
local init = require('shunt.cmd.init') -- shunt.yue:21
local start = require('shunt.cmd.start') -- shunt.yue:22
local upgrade = require('shunt.cmd.upgrade') -- shunt.yue:23
local logger = require('shunt.logger') -- shunt.yue:24
local spec = require('shunt.spec') -- shunt.yue:25
require('shunt.component') -- shunt.yue:28
require('shunt.writelite') -- shunt.yue:31
debug_ = require('shunt.cmd.debug') -- shunt.yue:33
skip_minecraft_tests = false -- shunt.yue:35
run_ugly_tests = false -- shunt.yue:38
force_error_on_bad_exit = false -- shunt.yue:40
main = function(raw_args) -- shunt.yue:42
  args, ok = Args:parse(raw_args) -- shunt.yue:43
  if not ok then -- shunt.yue:44
    return -- shunt.yue:45
  end -- shunt.yue:44
  logger.set_log_verbosity(not args.terse) -- shunt.yue:47
  if (args.test ~= nil) then -- shunt.yue:48
    logger.activate_test_mode() -- shunt.yue:49
    spec.set_log_verbosity(args.test.verbose) -- shunt.yue:50
  end -- shunt.yue:48
  force_error_on_bad_exit = args.force_error_on_bad_exit -- shunt.yue:52
  if args.instrument then -- shunt.yue:54
    return instrument(function() -- shunt.yue:55
      return run(args) -- shunt.yue:55
    end) -- shunt.yue:55
  else -- shunt.yue:57
    return run(args) -- shunt.yue:57
  end -- shunt.yue:54
end -- shunt.yue:42
run = function(args) -- shunt.yue:59
  if (args.test ~= nil) then -- shunt.yue:60
    run_ugly_tests = args.test.run_ugly_tests -- shunt.yue:61
    skip_minecraft_tests = args.test.no_minecraft -- shunt.yue:62
    ok = run_tests(args.test.filter) -- shunt.yue:63
    if not ok then -- shunt.yue:64
      return os.exit(1) -- shunt.yue:65
    end -- shunt.yue:64
  else -- shunt.yue:66
    if (args.start ~= nil) then -- shunt.yue:66
      if not args.ignore_monitor then -- shunt.yue:67
        detect_and_use_monitor() -- shunt.yue:68
      end -- shunt.yue:67
      return start.main(args.start) -- shunt.yue:69
    else -- shunt.yue:70
      if (args.init ~= nil) then -- shunt.yue:70
        return init.main(args.init) -- shunt.yue:71
      else -- shunt.yue:72
        if (args.clean ~= nil) then -- shunt.yue:72
          return clean.main(args.clean) -- shunt.yue:73
        else -- shunt.yue:74
          if (args.enable ~= nil) then -- shunt.yue:74
            return enable.main(args.enable) -- shunt.yue:75
          else -- shunt.yue:76
            if (args.disable ~= nil) then -- shunt.yue:76
              return disable.main(args.disable) -- shunt.yue:77
            else -- shunt.yue:78
              if (args.edit ~= nil) then -- shunt.yue:78
                return edit.main(args.edit) -- shunt.yue:79
              else -- shunt.yue:80
                if (args.flash ~= nil) then -- shunt.yue:80
                  return flash.main(args.flash) -- shunt.yue:81
                else -- shunt.yue:82
                  if (args.declare ~= nil) then -- shunt.yue:82
                    return declare.main(args.declare) -- shunt.yue:83
                  else -- shunt.yue:84
                    if (args.upgrade ~= nil) then -- shunt.yue:84
                      return upgrade.main(args.upgrade) -- shunt.yue:85
                    else -- shunt.yue:86
                      if (args.debug ~= nil) then -- shunt.yue:86
                        return debug_.main(args.debug) -- shunt.yue:87
                      else -- shunt.yue:89
                        return error('internal error: no command recognised') -- shunt.yue:89
                      end -- shunt.yue:86
                    end -- shunt.yue:84
                  end -- shunt.yue:82
                end -- shunt.yue:80
              end -- shunt.yue:78
            end -- shunt.yue:76
          end -- shunt.yue:74
        end -- shunt.yue:72
      end -- shunt.yue:70
    end -- shunt.yue:66
  end -- shunt.yue:60
end -- shunt.yue:59
spec.spec(function() -- shunt.yue:91
  local describe, it -- shunt.yue:0
  do -- shunt.yue:0
    local _obj_0 = require('shunt.spec') -- shunt.yue:0
    describe, it = _obj_0.describe, _obj_0.it -- shunt.yue:0
  end -- shunt.yue:0
  return describe('compat', function() -- shunt.yue:94
    return it('passes checks', function() -- shunt.yue:95
      return test_compat() -- shunt.yue:96
    end) -- shunt.yue:96
  end) -- shunt.yue:96
end) -- shunt.yue:91
args = { -- shunt.yue:98
  ... -- shunt.yue:98
} -- shunt.yue:98
ok = true -- shunt.yue:99
xpcall(function() -- shunt.yue:100
  return main(args) -- shunt.yue:101
end, function(err) -- shunt.yue:101
  if err ~= 'EXIT(0)' then -- shunt.yue:103
    if HOST == 'native' then -- shunt.yue:104
      io.stderr:write(debug.traceback(err)) -- shunt.yue:105
    else -- shunt.yue:107
      print(debug.traceback(err)) -- shunt.yue:107
    end -- shunt.yue:104
    ok = false -- shunt.yue:108
  end -- shunt.yue:103
end) -- shunt.yue:108
if 'native' == HOST then -- shunt.yue:110
  if not ok then -- shunt.yue:111
    return os.exit(1) -- shunt.yue:112
  end -- shunt.yue:111
elseif 'minecraft' == HOST then -- shunt.yue:113
  if not ok and force_error_on_bad_exit then -- shunt.yue:114
    return os.exit(1) -- shunt.yue:115
  end -- shunt.yue:114
else -- shunt.yue:117
  return error("internal error: unrecognised host " .. tostring(HOST)) -- shunt.yue:117
end -- shunt.yue:117
